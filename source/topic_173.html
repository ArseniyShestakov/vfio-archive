<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"> <html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en" dir="ltr"> <head> <meta http-equiv="Content-Type" content="text/html; charset=utf-8" /> <title>KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9 (Page 173) / Topics Going Nowhere / Arch Linux Forums</title> <link rel="stylesheet" type="text/css" href="style/ArchLinux.css" /> <link rel="canonical" href="viewtopic.php?id=162768&amp;p=173" title="Page 173" /> <link rel="prev" href="viewtopic.php?id=162768&amp;p=172" title="Page 172" /> <link rel="next" href="viewtopic.php?id=162768&amp;p=174" title="Page 174" /> <link rel="alternate" type="application/atom+xml" href="extern.php?action=feed&amp;tid=162768&amp;type=atom" title="Atom topic feed" /> <link rel="stylesheet" media="screen" href="style/ArchLinux/arch.css?v=3" /> <link rel="stylesheet" media="screen" href="style/ArchLinux/archnavbar.css?v=2" /> <link rel="shortcut icon" href="style/ArchLinux/favicon.ico" /> </head> <body> <div id="archnavbar" class="anb-forum"> <div id="archnavbarlogo"><h1><a href="http://www.archlinux.org/">Arch Linux</a></h1></div> <div id="archnavbarmenu"> <ul id="archnavbarlist"> <li id="anb-home"><a href="http://www.archlinux.org/">Home</a></li><li id="anb-packages"><a href="http://www.archlinux.org/packages/">Packages</a></li><li id="anb-forums" class="anb-selected"><a href="https://bbs.archlinux.org/">Forums</a></li><li id="anb-wiki"><a href="https://wiki.archlinux.org/">Wiki</a></li><li id="anb-bugs"><a href="https://bugs.archlinux.org/">Bugs</a></li><li id="anb-aur"><a href="https://aur.archlinux.org/">AUR</a></li><li id="anb-download"><a href="http://www.archlinux.org/download/">Download</a></li> </ul> </div> </div> <div id="punviewtopic" class="pun"> <div class="top-box"></div> <div class="punwrap"> <div id="brdheader" class="block"> <div class="box"> <div id="brdmenu" class="inbox"> <ul> <li id="navindex" class="isactive"><a href="index.php">Index</a></li> <li id="navuserlist"><a href="userlist.php">User list</a></li> <li id="navsearch"><a href="search.php">Search</a></li> <li id="navprofile"><a href="profile.php?id=80749">Profile</a></li> <li id="navlogout"><a href="login.php?action=out&amp;id=80749&amp;csrf_token=5c20501ec397bb45ef8ee8c84db232c8d8e421c6">Logout</a></li> </ul> </div> <div id="brdwelcome" class="inbox"> <ul class="conl"> <li><span>Logged in as <strong>SXX</strong></span></li> <li><span>Last visit: 2015-08-16 12:20:09</span></li> </ul> <ul class="conr"> <li><span>Topics: <a href="search.php?action=show_replies" title="Find topics you have posted to.">Posted</a> | <a href="search.php?action=show_new" title="Find topics with new posts since your last visit.">New</a> | <a href="search.php?action=show_recent" title="Find topics with recent posts.">Active</a> | <a href="search.php?action=show_unanswered" title="Find topics with no replies.">Unanswered</a></span></li> </ul> <div class="clearer"></div> </div> </div> </div> <div id="brdmain"> <div class="linkst"> <div class="inbox crumbsplus"> <ul class="crumbs"> <li><a href="index.php">Index</a></li> <li><span>»&#160;</span><a href="viewforum.php?id=48">Topics Going Nowhere</a></li> <li><span>»&#160;</span><strong><a href="viewtopic.php?id=162768">KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</a></strong></li> </ul> <div class="pagepost"> <p class="pagelink conl"><span class="pages-label">Pages: </span><a rel="prev" class="item1" href="viewtopic.php?id=162768&amp;p=172">Previous</a> <a href="viewtopic.php?id=162768">1</a> <span class="spacer">…</span> <a href="viewtopic.php?id=162768&amp;p=171">171</a> <a href="viewtopic.php?id=162768&amp;p=172">172</a> <strong>173</strong> <a href="viewtopic.php?id=162768&amp;p=174">174</a> <a href="viewtopic.php?id=162768&amp;p=175">175</a> <span class="spacer">…</span> <a href="viewtopic.php?id=162768&amp;p=234">234</a> <a rel="next" href="viewtopic.php?id=162768&amp;p=174">Next</a></p> <p class="postlink conr">Topic closed</p> </div> <div class="clearer"></div> </div> </div> <div id="p1505761" class="blockpost rowodd blockpost1"> <h2><span><span class="conr">#4301</span> <a href="viewtopic.php?pid=1505761#p1505761">2015-02-24 08:52:16</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=86321">thearcherblog</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2014-10-30</span></dd> <dd><span>Posts: 165</span></dd> <dd class="usercontacts"><span class="email"><a href="mailto:jjgarcianorway@gmail.com">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>mutiny wrote:</cite><blockquote><div><p>I am having a terrible time getting audio working in a Windows 8.1 VM with qemu... <br />PCI passthrough is working perfectly with Radeon GPU, motherboard&#039;s 2nd ethernet port, and motherboard&#039;s 2nd SATA controller being passed to the VM. The last piece I need is working audio! <img src="https://bbs.archlinux.org/img/smilies/smile.png" width="15" height="15" alt="smile" /></p><p>To try to enable sound (with pulseaudio used on host), I am doing qemu.sh:</p><div class="codebox"><pre><code>export QEMU_AUDIO_DRV=pa exec qemu-system-x86_64 \ -enable-kvm \ ...... \ -soundhw hda</code></pre></div><p>,</p><p>and the VM fails to launch, with dmesg showing:</p><div class="codebox"><pre class="vscroll"><code>[79307.989184] kvm [22292]: vcpu0 unhandled rdmsr: 0xce [79307.993410] kvm [22292]: vcpu0 unhandled rdmsr: 0x637 [79307.993418] kvm [22292]: vcpu0 unhandled rdmsr: 0xe8 [79307.993422] kvm [22292]: vcpu0 unhandled rdmsr: 0xe7 [79307.993426] kvm [22292]: vcpu0 unhandled rdmsr: 0x31 [79307.993430] kvm [22292]: vcpu0 unhandled rdmsr: 0x35 [79307.993434] kvm [22292]: vcpu0 unhandled rdmsr: 0x39 [79307.993448] kvm [22292]: vcpu0 unhandled rdmsr: 0xce [79307.993451] kvm [22292]: vcpu0 unhandled rdmsr: 0x194 [79307.993454] kvm [22292]: vcpu0 unhandled rdmsr: 0x19a [79313.196146] kvm_get_msr_common: 170 callbacks suppressed [79313.196149] kvm [22292]: vcpu0 unhandled rdmsr: 0x150 [79313.196156] kvm [22292]: vcpu0 unhandled rdmsr: 0x150 [79313.196158] kvm [22292]: vcpu0 unhandled rdmsr: 0x150 [79313.196161] kvm [22292]: vcpu0 unhandled rdmsr: 0x150 [79313.205095] kvm [22292]: vcpu3 unhandled rdmsr: 0x150 [79313.205102] kvm [22292]: vcpu3 unhandled rdmsr: 0x150 [79313.205105] kvm [22292]: vcpu3 unhandled rdmsr: 0x150 [79313.205107] kvm [22292]: vcpu3 unhandled rdmsr: 0x150 [79313.214116] kvm [22292]: vcpu1 unhandled rdmsr: 0x150 [79313.214123] kvm [22292]: vcpu1 unhandled rdmsr: 0x150 [79318.241747] kvm_get_msr_common: 70 callbacks suppressed ... ... ... [79950.317052] vfio-pci 0000:02:00.1: Refused to change power state, currently in D3 [79950.317119] vfio_pci_disable: Failed to reset device 0000:02:00.1 (-22) [79950.328050] vfio-pci 0000:02:00.1: Refused to change power state, currently in D3 [84325.855696] vfio-pci 0000:02:00.0: enabling device (0400 -&gt; 0403) [84325.876928] vfio_ecap_init: 0000:02:00.0 hiding ecap 0x19@0x270 [84325.876931] vfio_ecap_init: 0000:02:00.0 hiding ecap 0x1b@0x2d0 [84325.878188] vfio-pci 0000:02:00.1: enabling device (0400 -&gt; 0402) [84325.900537] vfio-pci 0000:04:00.0: enabling device (0400 -&gt; 0403) [84326.906061] vfio-pci 0000:07:00.0: enabling device (0400 -&gt; 0403) [84330.202221] kvm: zapping shadow pages for mmio generation wraparound [84338.019479] intel_iommu_map: iommu width (39) is not sufficient for the mapped address (c1f400001000)</code></pre></div><p>Any insight into what I am experience? Thanks!</p></div></blockquote></div><p>In my case I&#039;m using the audio from the graphic card instead of the emulated one. And the performance is really good not like the emulated that is quite choppy and delayed (at least in my case).</p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1505761">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1505768" class="blockpost roweven"> <h2><span><span class="conr">#4302</span> <a href="viewtopic.php?pid=1505768#p1505768">2015-02-24 09:45:56</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=88848">mutiny</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2015-02-15</span></dd> <dd><span>Posts: 13</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=88848">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <p>The monitor I am using doesn&#039;t have any speakers.</p><p>Also, the first set of messages (kvm [22292]: vcpu2 unhandled rdmsr: 0x150 etc) may not necessarily be related to the second set of messages (iommu width (39) is not sufficient for the mapped address) and non working audio/VM not working with -soundhw hda option, since I only got the 2nd set of messages after trying again.</p><p>EDIT:</p><p>Apparently it is an issue with passing through the HDMI audio of the video card that is causing the issue. It seems to work fine if I don&#039;t pass the HDMI audio on 02:00.1 and only pass the GPU itself to VM on 02:00.0. I guess it doesn&#039;t matter since I won&#039;t be using HDMI audio through the video card anyways.</p><p>I guess it makes sense from what dmesg says</p><div class="codebox"><pre><code>vfio_pci_disable: Failed to reset device 0000:02:00.1 (-22) vfio-pci 0000:02:00.1: Refused to change power state, currently in D3</code></pre></div><p>It seems to cause an issue in trying to start the guest a 2nd time after shutting down if I don&#039;t pass the HDMI along with the GPU, but maybe it&#039;s another problem going on...<br />How would one resolve this, just in case they did want to be able to have the option? Is it a matter of ONLY having the option of passed through audio device or emulated audio through qemu and never both?</p> <p class="postedit"><em>Last edited by mutiny (2015-02-24 10:07:55)</em></p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1505768">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1505773" class="blockpost rowodd"> <h2><span><span class="conr">#4303</span> <a href="viewtopic.php?pid=1505773#p1505773">2015-02-24 10:29:02</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=88564">hotfunction</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2015-02-05</span></dd> <dd><span>Posts: 10</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=88564">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>hotfunction wrote:</cite><blockquote><div><div class="quotebox"><blockquote><div><p>If 440fx and -nographic don&#039;t help and you&#039;re looking at the right output from the GPU, I&#039;d next be suspicious of the ROM file.&#160; It looks like one from techpowerup.&#160; Does it actually match your card?&#160; Can you dump the ROM from your card instead?&#160; Do you even need a dump of the ROM?</p></div></blockquote></div><p>hi sir aw.. i tried downloading various ROMs from other sites too, but none of them seems to get me working, they still gave me black screen output on the sscreen... and it seemed to be hard to find nvidia&#039;s ROM corresponding on that... so is it okay if i change into another GPU card? will it help me to work?</p><div class="quotebox"><blockquote><div><p>That black window is the sdl graphics head for the VM which appears because you haven&#039;t used the -nographic option.&#160; The GPU output should be on a monitor connected to the assigned GPU.&#160; I&#039;d also recommend, like I almost always do, using 440fx rather than q35 for the VM.&#160; It looks like you&#039;re using a Linux guest, but afaik, the nvidia driver does not have an issue with PCIe topology in Linux (until you get to lots of GPUs and that may already be fixed too).</p></div></blockquote></div><p>and also about this part... i actually still confused, after some reading and stuff, i redone the steps from nbhs&#039;s page one, after making the single script and others.. i still see the black qemu command line window when adding -vga none... and also without a rom setting, i also tried rombar=0 option and -nographic still didnt give me output.. can you give me further explanation on this.. ?? i am very confused about the black qemu command line, and how does people use -vga none without -nographics to go straight to the VMS without the black qemu command line?</p><p>Edit : i tried adding -curses instead of -nographics, and its still giving me blank output, which i can type &quot;quit&quot; and i can go back to the qemu, which is that i am guessing that is still the black qemu command line output again.. removing that -vga none boots -curses to the VM.. so is the black qemu command line from the -vga none output is showing because of my GPU rom incorrect? or am i missing something..?</p></div></blockquote></div><p>on this case, i tried to extract the ROM of my own GTX560Ti GPU, and i used it to launch my VMs, as the same that using -nographic and -vga none gives no output, any help on this anyone? <img src="https://bbs.archlinux.org/img/smilies/sad.png" width="15" height="15" alt="sad" /></p><p>also i tried to put the romfile= option in the q35 machine ( becuase 440fx didn&#039;t work for me ) and i put my extracted rom from my GPU to the path, it still give me a same result instead.. -vga none still give me qemu command line monitor, adding -vga none and -nographics shows no output, and also if i remove -vga none and qemu command in q35 script, i can boot inside the VM, but it looks like the GPU is not utilized properly.. it shows in lspci in the linux, but the GPU passthrough didn&#039;t work, as i test opening youtube and it lags, and also tried unigine heaven benchmark and it still wont work, glx errors.. and also when i boot into windows 8, and adding kvm=off after -cpu argument, it won&#039;t let me boot in, soon after i log in into my account, its having an error_exception which keep restarts...</p><p>also i rechecked every steps and tried every possible thing on the nhbs&#039;s tutorial and went over some user&#039;s configuration here on this thread..<br />after i do some dmesg checking i found this on my dmesg:</p><div class="codebox"><pre><code>[ 0.029557] dmar: DMAR:[DMA Read] Request device [03:00.0] fault addr 40001000 [ 0.029557] DMAR:[fault reason 06] PTE Read access is not set</code></pre></div><p>here&#039;s my lspci :</p><div class="codebox"><pre><code>00:00.0 Host bridge: Intel Corporation Xeon E3-1200 v2/3rd Gen Core processor DRAM Controller (rev 09) 00:01.0 PCI bridge: Intel Corporation Xeon E3-1200 v2/3rd Gen Core processor PCI Express Root Port (rev 09) 00:14.0 USB controller: Intel Corporation 7 Series/C210 Series Chipset Family USB xHCI Host Controller (rev 04) 00:16.0 Communication controller: Intel Corporation 7 Series/C210 Series Chipset Family MEI Controller #1 (rev 04) 00:1a.0 USB controller: Intel Corporation 7 Series/C210 Series Chipset Family USB Enhanced Host Controller #2 (rev 04) 00:1b.0 Audio device: Intel Corporation 7 Series/C210 Series Chipset Family High Definition Audio Controller (rev 04) 00:1c.0 PCI bridge: Intel Corporation 7 Series/C210 Series Chipset Family PCI Express Root Port 1 (rev c4) 00:1c.4 PCI bridge: Intel Corporation 7 Series/C210 Series Chipset Family PCI Express Root Port 5 (rev c4) 00:1c.5 PCI bridge: Intel Corporation 7 Series/C210 Series Chipset Family PCI Express Root Port 6 (rev c4) 00:1d.0 USB controller: Intel Corporation 7 Series/C210 Series Chipset Family USB Enhanced Host Controller #1 (rev 04) 00:1e.0 PCI bridge: Intel Corporation 82801 PCI Bridge (rev a4) 00:1f.0 ISA bridge: Intel Corporation B75 Express Chipset LPC Controller (rev 04) 00:1f.2 IDE interface: Intel Corporation 7 Series/C210 Series Chipset Family 4-port SATA Controller [IDE mode] (rev 04) 00:1f.3 SMBus: Intel Corporation 7 Series/C210 Series Chipset Family SMBus Controller (rev 04) 00:1f.5 IDE interface: Intel Corporation 7 Series/C210 Series Chipset Family 2-port SATA Controller [IDE mode] (rev 04) 01:00.0 PCI bridge: PLX Technology, Inc. PEX 8647 48-Lane, 3-Port PCI Express Gen 2 (5.0 GT/s) Switch (rev ab) 02:04.0 PCI bridge: PLX Technology, Inc. PEX 8647 48-Lane, 3-Port PCI Express Gen 2 (5.0 GT/s) Switch (rev ab) 02:08.0 PCI bridge: PLX Technology, Inc. PEX 8647 48-Lane, 3-Port PCI Express Gen 2 (5.0 GT/s) Switch (rev ab) 03:00.0 VGA compatible controller: Advanced Micro Devices, Inc. [AMD/ATI] R700 [Radeon HD 4870 X2] 03:00.1 Audio device: Advanced Micro Devices, Inc. [AMD/ATI] RV770 HDMI Audio [Radeon HD 4850/4870] 04:00.0 Display controller: Advanced Micro Devices, Inc. [AMD/ATI] R700 [Radeon HD 4870 X2] 05:00.0 VGA compatible controller: NVIDIA Corporation GF114 [GeForce GTX 560 Ti] (rev a1) 05:00.1 Audio device: NVIDIA Corporation GF114 HDMI Audio Controller (rev a1) 06:00.0 Ethernet controller: Realtek Semiconductor Co., Ltd. RTL8111/8168/8411 PCI Express Gigabit Ethernet Controller (rev 06) 07:00.0 Ethernet controller: Intel Corporation 82574L Gigabit Network Connection</code></pre></div><p>cat /proc/cmdline/</p><div class="codebox"><pre><code>BOOT_IMAGE=/vmlinuz-3.18.5 root=/dev/mapper/SSLVFIO--vg-root ro quiet i915.enable_hd_vgaarb=1 pcie_acs_override=downstream intel_iommu=on</code></pre></div><p>qemu 2.2.0<br />linux 3.18-5, i patched linux-mainline 3.18-5 package from this thread</p><p>lspci -vnn to graphics cards:</p><div class="codebox"><pre class="vscroll"><code>03:00.0 VGA compatible controller [0300]: Advanced Micro Devices, Inc. [AMD/ATI] R700 [Radeon HD 4870 X2] [1002:9441] (prog-if 00 [VGA controller]) Subsystem: ASUSTeK Computer Inc. Device [1043:0284] Flags: bus master, fast devsel, latency 0, IRQ 37 Memory at d0000000 (64-bit, prefetchable) [size=256M] Memory at f6220000 (64-bit, non-prefetchable) [size=64K] I/O ports at b000 [size=256] Expansion ROM at f6200000 [disabled] [size=128K] Capabilities: [50] Power Management version 3 Capabilities: [58] Express Legacy Endpoint, MSI 00 Capabilities: [a0] MSI: Enable+ Count=1/1 Maskable- 64bit+ Capabilities: [100] Vendor Specific Information: ID=0001 Rev=1 Len=010 &lt;?&gt; Kernel driver in use: radeon 03:00.1 Audio device [0403]: Advanced Micro Devices, Inc. [AMD/ATI] RV770 HDMI Audio [Radeon HD 4850/4870] [1002:aa30] Subsystem: ASUSTeK Computer Inc. Device [1043:aa30] Flags: bus master, fast devsel, latency 0, IRQ 36 Memory at f6230000 (64-bit, non-prefetchable) [size=16K] Capabilities: [50] Power Management version 3 Capabilities: [58] Express Legacy Endpoint, MSI 00 Capabilities: [a0] MSI: Enable+ Count=1/1 Maskable- 64bit+ Capabilities: [100] Vendor Specific Information: ID=0001 Rev=1 Len=010 &lt;?&gt; Kernel driver in use: snd_hda_intel 04:00.0 Display controller [0380]: Advanced Micro Devices, Inc. [AMD/ATI] R700 [Radeon HD 4870 X2] [1002:9441] Subsystem: ASUSTeK Computer Inc. Device [1043:0284] Flags: bus master, fast devsel, latency 0, IRQ 38 Memory at c0000000 (64-bit, prefetchable) [size=256M] Memory at f6120000 (64-bit, non-prefetchable) [size=64K] I/O ports at a000 [size=256] Expansion ROM at f6100000 [disabled] [size=128K] Capabilities: [50] Power Management version 3 Capabilities: [58] Express Legacy Endpoint, MSI 00 Capabilities: [a0] MSI: Enable+ Count=1/1 Maskable- 64bit+ Capabilities: [100] Vendor Specific Information: ID=0001 Rev=1 Len=010 &lt;?&gt; Kernel driver in use: radeon 05:00.0 VGA compatible controller [0300]: NVIDIA Corporation GF114 [GeForce GTX 560 Ti] [10de:1200] (rev a1) (prog-if 00 [VGA controller]) Subsystem: Micro-Star International Co., Ltd. [MSI] Device [1462:2601] Flags: fast devsel, IRQ 16 Memory at f4000000 (32-bit, non-prefetchable) [disabled] [size=32M] Memory at e0000000 (64-bit, prefetchable) [disabled] [size=128M] Memory at e8000000 (64-bit, prefetchable) [disabled] [size=64M] I/O ports at e000 [size=128] Expansion ROM at f6000000 [disabled] [size=512K] Capabilities: [60] Power Management version 3 Capabilities: [68] MSI: Enable- Count=1/1 Maskable- 64bit+ Capabilities: [78] Express Endpoint, MSI 00 Capabilities: [b4] Vendor Specific Information: Len=14 &lt;?&gt; Capabilities: [100] Virtual Channel Capabilities: [128] Power Budgeting &lt;?&gt; Capabilities: [600] Vendor Specific Information: ID=0001 Rev=1 Len=024 &lt;?&gt; Kernel driver in use: vfio-pci 05:00.1 Audio device [0403]: NVIDIA Corporation GF114 HDMI Audio Controller [10de:0e0c] (rev a1) Subsystem: Micro-Star International Co., Ltd. [MSI] Device [1462:2601] Flags: bus master, fast devsel, latency 0, IRQ 17 Memory at f6080000 (32-bit, non-prefetchable) [size=16K] Capabilities: [60] Power Management version 3 Capabilities: [68] MSI: Enable- Count=1/1 Maskable- 64bit+ Capabilities: [78] Express Endpoint, MSI 00 Kernel driver in use: vfio-pci</code></pre></div><p>- i think all steps were good.. suppose to be working.. but im always having black qemu command line on the result after adding -vga none..<br />- adding -vga none and -nographic together didn&#039;t show any result, no display at all..<br />- extracted ROM from my own NVIDIA card, and putting it romfile= into my scripts.. still not working at all<br />- tried using q35 and 440fx.. resulting q35 boots the VM, but 440fx only gave me black screen without any output.. ( both of them were not using -vga none and -nographic, of course, since those 2 options wont let me go in )<br />- booting on windows 8 without installing NVIDIA driver gives me error 43 , after installing, error 43 still shows up. ( q35, since 440fx gives no work for me )<br />- for windows 8 : added -cpu host,kvm=off, it wont let me boot, had an system_exceptional error and it bootloops. ( q35, since 440fx gives no work for me )</p><p>here are my scripts :<br />q35 </p><div class="codebox"><pre class="vscroll"><code>#!/bin/bash configfile=/etc/vfio-pci1.cfg vfiobind() { dev=&quot;$1&quot; vendor=$(cat /sys/bus/pci/devices/$dev/vendor) device=$(cat /sys/bus/pci/devices/$dev/device) if [ -e /sys/bus/pci/devices/$dev/driver ]; then echo $dev &gt; /sys/bus/pci/devices/$dev/driver/unbind fi echo $vendor $device &gt; /sys/bus/pci/drivers/vfio-pci/new_id } modprobe vfio-pci cat $configfile | while read line;do echo $line | grep ^# &gt;/dev/null 2&gt;&amp;1 &amp;&amp; continue vfiobind $line done sudo qemu-system-x86_64 -M q35 -vga std -hda /home/sslab719/VMimages/w8.img -enable-kvm -m 2048 -cpu host \ -smp 2,sockets=1,cores=2,threads=1 \ -device ioh3420,bus=pcie.0,addr=1c.0,multifunction=on,port=1,chassis=1,id=root.1 \ -drive file=/home/sslab719/VMimages/w8.img,id=disk,format=qcow2 \ -device vfio-pci,host=05:00.0,bus=root.1,addr=00.0,multifunction=on,x-vga=on,romfile=/home/sslab719/vbios1.rom \ -device vfio-pci,host=05:00.1,bus=root.1,addr=00.1 \ -net user,hostfwd=tcp::10022-:22 -net nic #-boot menu=on exit 0</code></pre></div><p>i440fx</p><div class="codebox"><pre class="vscroll"><code>#!/bin/bash configfile=/etc/vfio-pci1.cfg vfiobind() { dev=&quot;$1&quot; vendor=$(cat /sys/bus/pci/devices/$dev/vendor) device=$(cat /sys/bus/pci/devices/$dev/device) if [ -e /sys/bus/pci/devices/$dev/driver ]; then echo $dev &gt; /sys/bus/pci/devices/$dev/driver/unbind fi echo $vendor $device &gt; /sys/bus/pci/drivers/vfio-pci/new_id } modprobe vfio-pci cat $configfile | while read line;do echo $line | grep ^# &gt;/dev/null 2&gt;&amp;1 &amp;&amp; continue vfiobind $line done sudo qemu-system-x86_64 -hda /home/sslab719/VMimages/w8.img -enable-kvm -M pc -nographic -vga none -m 2048 -cpu host,kvm=off \ -smp 2,sockets=1,cores=2,threads=1 \ -device vfio-pci,host=05:00.0,x-vga=on,romfile=/home/sslab719/vbios1.rom \ -device vfio-pci,host=05:00.1 \ -drive file=/home/sslab719/VMimages/w8.img,format=qcow2,media=disk \ -boot menu=on exit 0</code></pre></div><p>also i blacklisted nvidia from the host ( since i wanted to passthrough nvidia to the VMs ) it still doesn&#039;t make any change, and i tried removing the blacklist to standard configuration, not blacklisting any fglrx, nvidia, noveau, or radeon, but none worked for me..</p><p>additional : i tried testing running on linux ( q35, still no -vga none, no -nographic ), ubuntu 12.04 desktop version, and i had no glxinfo available, also on lspci shown standard graphics card 1234:1111, but i see my lspci showing my graphics card GTX 560 Ti, but it seems that my lspci is nothing, which doesn&#039;t give any good result, on additional drivers tab on settings it can automatically searches and installs nvidia drivers, but after install and reboot, it shows &quot;this driver is installed but not activated&quot;</p><p>also, i tried installing steam, and trying to type glxinfo, both of them saying that my GLX has errors, which mean its not really passthrough&#039;in my GPU card...</p><p>i&#039;ve been stuck here for 2 months and i am hoping this to work <img src="https://bbs.archlinux.org/img/smilies/sad.png" width="15" height="15" alt="sad" /> ..</p><p>EDIT 2 : I tried installing gnome on my host ubuntu server, and run a benchmark, installed Unigine Heaven Benchmark, the benchmark works correctly but it is showing Unknown GPU ( 256 MB ) -&gt; ran on the host..</p><p>EDIT 3 : i finally tried using -vga none and -nographics menu, now the black qemu monitor shows up, then when i plug in my monitor to my secondary GPU ( the passthrough GPU ), finally i am able to see my VM using -vga none.. but this vm installs windows 8 with any installed NVIDIA drivers yet,&#160; and also, this only works on the first boot of the VM, lets say i kill the VM and i change the script, then i start my VM again, the output won&#039;t show up again in the passthrough&#039;d monitor, the only way to make it show up again is by rebooting the host.. and after it reboots i can only boot the VM again once... if i boot the VM twice, starting from that time it won&#039;t show the output again unless i reboot one more time..</p><p>any help on this please !! i think im almost there..</p> <p class="postedit"><em>Last edited by hotfunction (2015-02-25 07:13:51)</em></p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1505773">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1505774" class="blockpost roweven"> <h2><span><span class="conr">#4304</span> <a href="viewtopic.php?pid=1505774#p1505774">2015-02-24 10:55:22</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=74738">instantepiphany</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2013-09-04</span></dd> <dd><span>Posts: 32</span></dd> <dd class="usercontacts"><span class="email"><a href="mailto:jordancran@gmail.com">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>aw wrote:</cite><blockquote><div><div class="quotebox"><cite>instantepiphany wrote:</cite><blockquote><div><p>I am not using arch currently, but this is the best resource I could find with regards to vga passthrough on QEMU.<br />I have gotten everything working so far, except actual passthrough. When I run my vm, I hear the graphics card that I am passing through spin up like it does on boot, but when I switch to the input from that card, there is no display. What could be causing this?</p></div></blockquote></div><p><a href="http://vfio.blogspot.com/2014/08/vfiovga-faq.html" rel="nofollow">FAQ #3/4</a></p></div></blockquote></div><p>Aw, </p><p>I am using 3.18.5, and it seems the &quot;other&quot; vga patch was included in 3.17 - so I don&#039;t think that is causing my problem. What then do you think is causing my no output issue?</p><p>In case it is relevant - this is the only output I get in dmesg when running qemu (2:00.0 is a usb hub)</p><div class="codebox"><pre><code>[20165.012459] vfio-pci 0000:02:00.0: enabling device (0400 -&gt; 0402) [20165.116200] vfio-pci 0000:01:00.0: enabling device (0400 -&gt; 0403) [20165.144582] vfio-pci 0000:01:00.1: enabling device (0400 -&gt; 0402)</code></pre></div> <p class="postedit"><em>Last edited by instantepiphany (2015-02-24 10:58:33)</em></p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1505774">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1505775" class="blockpost rowodd"> <h2><span><span class="conr">#4305</span> <a href="viewtopic.php?pid=1505775#p1505775">2015-02-24 10:56:21</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=83627">JohnyPea</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2014-07-17</span></dd> <dd><span>Posts: 17</span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <p>Did anybody try kernel 4.0-rc1? There are some experimental features for kvm regarding timers, which I was going to test. The VMs start and go through Seabios or OVMF, but then halt with first core maxed out. It seems that it&#039;s probably trying to allocate memory and gets stuck. It doesnt fail, nor progress. I didnt find anything regarding this, yet.</p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1505775">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1505817" class="blockpost roweven"> <h2><span><span class="conr">#4306</span> <a href="viewtopic.php?pid=1505817#p1505817">2015-02-24 13:43:57</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=85314">Duelist</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2014-09-22</span></dd> <dd><span>Posts: 358</span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>JohnyPea wrote:</cite><blockquote><div><p>Did anybody try kernel 4.0-rc1? There are some experimental features for kvm regarding timers, which I was going to test. The VMs start and go through Seabios or OVMF, but then halt with first core maxed out. It seems that it&#039;s probably trying to allocate memory and gets stuck. It doesnt fail, nor progress. I didnt find anything regarding this, yet.</p></div></blockquote></div><div class="codebox"><pre><code>-debugcon file:debug.log -global isa-debugcon.iobase=0x402</code></pre></div><p>Try adding this to see more logs from OVMF or seabios.</p> </div> <div class="postsignature postmsg"><hr /><p><span class="bbs">The forum rules prohibit requesting support for distributions other than arch.</span><br /><a href="https://bbs.archlinux.org/viewtopic.php?pid=1551460#p1551460" rel="nofollow">I gave up.</a><a href="https://bbs.archlinux.org/viewtopic.php?id=162768" rel="nofollow"> It was too late.</a><br /><a href="http://pastebin.com/B3fL84bq" rel="nofollow">What I was trying to do</a>.<br /><a href="http://vfio.blogspot.com/" rel="nofollow">The reference about VFIO and KVM VGA passthrough.</a></p></div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1505817">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1505826" class="blockpost rowodd"> <h2><span><span class="conr">#4307</span> <a href="viewtopic.php?pid=1505826#p1505826">2015-02-24 14:07:26</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=83627">JohnyPea</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2014-07-17</span></dd> <dd><span>Posts: 17</span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>Duelist wrote:</cite><blockquote><div><div class="quotebox"><cite>JohnyPea wrote:</cite><blockquote><div><p>Did anybody try kernel 4.0-rc1? There are some experimental features for kvm regarding timers, which I was going to test. The VMs start and go through Seabios or OVMF, but then halt with first core maxed out. It seems that it&#039;s probably trying to allocate memory and gets stuck. It doesnt fail, nor progress. I didnt find anything regarding this, yet.</p></div></blockquote></div><div class="codebox"><pre><code>-debugcon file:debug.log -global isa-debugcon.iobase=0x402</code></pre></div><p>Try adding this to see more logs from OVMF or seabios.</p></div></blockquote></div><br /><p>Thank you, this trick is very usefull. Did a quick test remotely and the log is quite long, but I dont see anything. Last lines:</p><div class="codebox"><pre class="vscroll"><code>Support(): UNDI3.1 found on handle BF29E298 BlockSize : 512 LastBlock : 95FFF PartitionValidMbr: Bad MBR partition size EndingLBA(DEB56E8B) &gt; LastLBA(95FFF) BlockSize : 512 LastBlock : 3FFFF BlockSize : 512 LastBlock : C6F6FFF PartitionValidMbr: Bad MBR partition size EndingLBA(DEB56E8B) &gt; LastLBA(C6F6FFF) Select Item: 0x19 Select Item: 0x2B SetBootOrderFromQemu: setting BootOrder: success VideoFill: Past screen (Y) PixelBlueGreenRedReserved8BitPerColor PixelBlueGreenRedReserved8BitPerColor Memory Previous Current Next Type Pages Pages Pages ====== ======== ======== ======== 0A 00000004 00000023 0000002B 09 00000008 00000006 00000008 00 00000004 00000000 00000004 06 00000024 000000FB 00000139 05 00000030 000000C9 000000FB 03 00000180 00000538 00000686 04 00000F00 00001226 000016AF Booting Windows Boot Manager InstallProtocolInterface: 5B1B31A1-9562-11D2-8E3F-00A0C969723B BF309E40 Loading driver at 0x00010000000 EntryPoint=0x000100061C0 bootmgfw.efi InstallProtocolInterface: BC62157E-3E33-4FEC-9920-2D3B36D750DF BEF79918</code></pre></div><p>I have noticed on this machine, which uses hugepages, that it probably allocated all of the memory. Therefore my initial thought was incorrect. I see that the boot process starts, on linux guest hangs on &quot;loading initramfs&quot; and on windows only displays logo, before animation. Will do more tests later with the simplest qemu VMs without periperals.</p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1505826">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1505882" class="blockpost roweven"> <h2><span><span class="conr">#4308</span> <a href="viewtopic.php?pid=1505882#p1505882">2015-02-24 17:55:57</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=81112">Krobar</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2014-04-12</span></dd> <dd><span>Posts: 17</span></dd> <dd class="usercontacts"><span class="email"><a href="mailto:rob@ledeng.demon.co.uk">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <p>A quick note for those wondering about using the GT620 I also had trouble with this card:<br />1) Would only work on first boot of the VM (No Reboot and unable tp stop and start after initial start)<br />2) Kodi under Linux would occasionally stop and then fast-forward video (Strange as the sound over HDMI was fine).</p><p>Geforce 960 does not suffer either of these issues and works prefectly within the same VM and config (Although serious overkill for HTPC VM use)</p> <p class="postedit"><em>Last edited by Krobar (2015-02-24 17:57:08)</em></p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1505882">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1505885" class="blockpost rowodd"> <h2><span><span class="conr">#4309</span> <a href="viewtopic.php?pid=1505885#p1505885">2015-02-24 18:02:47</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=83627">JohnyPea</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2014-07-17</span></dd> <dd><span>Posts: 17</span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>JohnyPea wrote:</cite><blockquote><div><div class="quotebox"><cite>Duelist wrote:</cite><blockquote><div><div class="quotebox"><cite>JohnyPea wrote:</cite><blockquote><div><p>Did anybody try kernel 4.0-rc1? There are some experimental features for kvm regarding timers, which I was going to test. The VMs start and go through Seabios or OVMF, but then halt with first core maxed out. It seems that it&#039;s probably trying to allocate memory and gets stuck. It doesnt fail, nor progress. I didnt find anything regarding this, yet.</p></div></blockquote></div><div class="codebox"><pre><code>-debugcon file:debug.log -global isa-debugcon.iobase=0x402</code></pre></div><p>Try adding this to see more logs from OVMF or seabios.</p></div></blockquote></div><br /><p>Thank you, this trick is very usefull. Did a quick test remotely and the log is quite long, but I dont see anything. Last lines: <br />...</p></div></blockquote></div><p>So it may be some change in cgroups system which libvirt doesnt hadle well.</p><div class="codebox"><pre><code>2015-02-24 17:56:03.746+0000: 5342: error : cgm_get_tasks:255 : cgmanager: cgm_get_tasks for controller=cpu, cgroup_path=machine/Win81.libvirt-qemu failed: Invalid arguments received in reply 2015-02-24 17:56:03.746+0000: 5342: error : cgm_get_tasks:255 : cgmanager: cgm_get_tasks for controller=cpuacct, cgroup_path=machine/Win81.libvirt-qemu failed: Invalid arguments received in reply 2015-02-24 17:56:03.746+0000: 5342: error : cgm_get_tasks:255 : cgmanager: cgm_get_tasks for controller=cpuset, cgroup_path=machine/Win81.libvirt-qemu failed: Invalid arguments received in reply</code></pre></div><p>Qemu and kvm modules work. Tested with basic command line invocation and livecd.</p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1505885">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1505887" class="blockpost roweven"> <h2><span><span class="conr">#4310</span> <a href="viewtopic.php?pid=1505887#p1505887">2015-02-24 18:16:50</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=83627">JohnyPea</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2014-07-17</span></dd> <dd><span>Posts: 17</span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>JohnyPea wrote:</cite><blockquote><div><p>So it may be some change in cgroups system which libvirt doesnt hadle well.</p><div class="codebox"><pre><code>2015-02-24 17:56:03.746+0000: 5342: error : cgm_get_tasks:255 : cgmanager: cgm_get_tasks for controller=cpu, cgroup_path=machine/Win81.libvirt-qemu failed: Invalid arguments received in reply 2015-02-24 17:56:03.746+0000: 5342: error : cgm_get_tasks:255 : cgmanager: cgm_get_tasks for controller=cpuacct, cgroup_path=machine/Win81.libvirt-qemu failed: Invalid arguments received in reply 2015-02-24 17:56:03.746+0000: 5342: error : cgm_get_tasks:255 : cgmanager: cgm_get_tasks for controller=cpuset, cgroup_path=machine/Win81.libvirt-qemu failed: Invalid arguments received in reply</code></pre></div><p>Qemu and kvm modules work. Tested with basic command line invocation and livecd.</p></div></blockquote></div><p>Well, sorry for this noise. Thats not it either. Happens exactly the same in 3.19 where the machine works flawlessly. Just keep an eye out for &quot;lapic_timer_advance_ns&quot; and &quot;halt_poll_ns&quot; in the future. I will just shut up now. :-)</p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1505887">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1506069" class="blockpost rowodd"> <h2><span><span class="conr">#4311</span> <a href="viewtopic.php?pid=1506069#p1506069">2015-02-25 10:08:46</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=89099">Frans-Willem</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2015-02-25</span></dd> <dd><span>Posts: 2</span></dd> <dd class="usercontacts"><span class="email"><a href="mailto:fw@hardijzer.nl">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <p>I&#039;ve got everything booting up on my system with a q35 machine model and qemu, and would like to convert it to a libvirt domain for easier start/stop management. However, I can&#039;t seem to find a XML example for Q35 and a PCIe device attached. Has anyone got this working, and if so, could you please share your XML ?</p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1506069">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1506073" class="blockpost roweven"> <h2><span><span class="conr">#4312</span> <a href="viewtopic.php?pid=1506073#p1506073">2015-02-25 10:17:31</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=83627">JohnyPea</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2014-07-17</span></dd> <dd><span>Posts: 17</span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>Frans-Willem wrote:</cite><blockquote><div><p>I&#039;ve got everything booting up on my system with a q35 machine model and qemu, and would like to convert it to a libvirt domain for easier start/stop management. However, I can&#039;t seem to find a XML example for Q35 and a PCIe device attached. Has anyone got this working, and if so, could you please share your XML ?</p></div></blockquote></div><p>This is old and maybe not very good config:</p><div class="codebox"><pre class="vscroll"><code>&lt;domain type=&#039;kvm&#039; xmlns:qemu=&#039;http://libvirt.org/schemas/domain/qemu/1.0&#039;&gt; &lt;name&gt;GTX660Ti&lt;/name&gt; &lt;uuid&gt;00000000-0000-0000-0000-000000000001&lt;/uuid&gt; &lt;memory unit=&#039;KiB&#039;&gt;6291456&lt;/memory&gt; &lt;currentMemory unit=&#039;KiB&#039;&gt;6291456&lt;/currentMemory&gt; &lt;memoryBacking&gt; &lt;hugepages&gt; &lt;page size=&#039;1048576&#039; unit=&#039;KiB&#039;/&gt; &lt;/hugepages&gt; &lt;/memoryBacking&gt; &lt;vcpu placement=&#039;static&#039; cpuset=&#039;0-7&#039;&gt;8&lt;/vcpu&gt; &lt;cputune&gt; &lt;vcpupin vcpu=&#039;0&#039; cpuset=&#039;0&#039;/&gt; &lt;vcpupin vcpu=&#039;1&#039; cpuset=&#039;1&#039;/&gt; &lt;vcpupin vcpu=&#039;2&#039; cpuset=&#039;2&#039;/&gt; &lt;vcpupin vcpu=&#039;3&#039; cpuset=&#039;3&#039;/&gt; &lt;vcpupin vcpu=&#039;4&#039; cpuset=&#039;4&#039;/&gt; &lt;vcpupin vcpu=&#039;5&#039; cpuset=&#039;5&#039;/&gt; &lt;vcpupin vcpu=&#039;6&#039; cpuset=&#039;6&#039;/&gt; &lt;vcpupin vcpu=&#039;7&#039; cpuset=&#039;7&#039;/&gt; &lt;/cputune&gt; &lt;os&gt; &lt;type arch=&#039;x86_64&#039; machine=&#039;pc-q35-2.1&#039;&gt;hvm&lt;/type&gt; &lt;bootmenu enable=&#039;no&#039;/&gt; &lt;/os&gt; &lt;features&gt; &lt;acpi/&gt; &lt;apic/&gt; &lt;pae/&gt; &lt;hap/&gt; &lt;hyperv&gt; &lt;relaxed state=&#039;on&#039;/&gt; &lt;vapic state=&#039;on&#039;/&gt; &lt;spinlocks state=&#039;on&#039; retries=&#039;4096&#039;/&gt; &lt;/hyperv&gt; &lt;kvm&gt; &lt;hidden state=&#039;on&#039;/&gt; &lt;/kvm&gt; &lt;pvspinlock state=&#039;on&#039;/&gt; &lt;/features&gt; &lt;cpu mode=&#039;host-passthrough&#039;&gt; &lt;topology sockets=&#039;1&#039; cores=&#039;8&#039; threads=&#039;1&#039;/&gt; &lt;/cpu&gt; &lt;clock offset=&#039;utc&#039;&gt; &lt;timer name=&#039;hypervclock&#039; present=&#039;yes&#039;/&gt; &lt;timer name=&#039;rtc&#039; tickpolicy=&#039;catchup&#039;/&gt; &lt;timer name=&#039;pit&#039; tickpolicy=&#039;delay&#039;/&gt; &lt;timer name=&#039;hpet&#039; present=&#039;yes&#039;/&gt; &lt;/clock&gt; &lt;on_poweroff&gt;destroy&lt;/on_poweroff&gt; &lt;on_reboot&gt;restart&lt;/on_reboot&gt; &lt;on_crash&gt;destroy&lt;/on_crash&gt; &lt;devices&gt; &lt;emulator&gt;/usr/bin/qemu-system-x86_64&lt;/emulator&gt; &lt;disk type=&#039;file&#039; device=&#039;disk&#039;&gt; &lt;driver name=&#039;qemu&#039; type=&#039;qcow2&#039; cache=&#039;unsafe&#039; io=&#039;threads&#039; discard=&#039;unmap&#039;/&gt; &lt;source file=&#039;/mnt/home/dzon/VM/WinVfio.qcow2&#039;/&gt; &lt;target dev=&#039;vda&#039; bus=&#039;virtio&#039;/&gt; &lt;boot order=&#039;1&#039;/&gt; &lt;address type=&#039;pci&#039; domain=&#039;0x0000&#039; bus=&#039;0x02&#039; slot=&#039;0x04&#039; function=&#039;0x0&#039;/&gt; &lt;/disk&gt; &lt;disk type=&#039;file&#039; device=&#039;disk&#039; snapshot=&#039;no&#039;&gt; &lt;driver name=&#039;qemu&#039; type=&#039;raw&#039; cache=&#039;none&#039; io=&#039;native&#039;/&gt; &lt;source file=&#039;/dev/sda2&#039;/&gt; &lt;target dev=&#039;vdb&#039; bus=&#039;virtio&#039;/&gt; &lt;address type=&#039;pci&#039; domain=&#039;0x0000&#039; bus=&#039;0x02&#039; slot=&#039;0x03&#039; function=&#039;0x0&#039;/&gt; &lt;/disk&gt; &lt;controller type=&#039;pci&#039; index=&#039;0&#039; model=&#039;pcie-root&#039;/&gt; &lt;controller type=&#039;pci&#039; index=&#039;1&#039; model=&#039;dmi-to-pci-bridge&#039;&gt; &lt;address type=&#039;pci&#039; domain=&#039;0x0000&#039; bus=&#039;0x00&#039; slot=&#039;0x1e&#039; function=&#039;0x0&#039;/&gt; &lt;/controller&gt; &lt;controller type=&#039;pci&#039; index=&#039;2&#039; model=&#039;pci-bridge&#039;&gt; &lt;address type=&#039;pci&#039; domain=&#039;0x0000&#039; bus=&#039;0x01&#039; slot=&#039;0x01&#039; function=&#039;0x0&#039;/&gt; &lt;/controller&gt; &lt;controller type=&#039;pci&#039; index=&#039;3&#039; model=&#039;pci-bridge&#039;&gt; &lt;address type=&#039;pci&#039; domain=&#039;0x0000&#039; bus=&#039;0x01&#039; slot=&#039;0x02&#039; function=&#039;0x0&#039;/&gt; &lt;/controller&gt; &lt;controller type=&#039;usb&#039; index=&#039;0&#039; model=&#039;ich9-ehci1&#039;&gt; &lt;address type=&#039;pci&#039; domain=&#039;0x0000&#039; bus=&#039;0x02&#039; slot=&#039;0x01&#039; function=&#039;0x7&#039;/&gt; &lt;/controller&gt; &lt;controller type=&#039;usb&#039; index=&#039;0&#039; model=&#039;ich9-uhci1&#039;&gt; &lt;master startport=&#039;0&#039;/&gt; &lt;address type=&#039;pci&#039; domain=&#039;0x0000&#039; bus=&#039;0x02&#039; slot=&#039;0x01&#039; function=&#039;0x0&#039; multifunction=&#039;on&#039;/&gt; &lt;/controller&gt; &lt;controller type=&#039;usb&#039; index=&#039;0&#039; model=&#039;ich9-uhci2&#039;&gt; &lt;master startport=&#039;2&#039;/&gt; &lt;address type=&#039;pci&#039; domain=&#039;0x0000&#039; bus=&#039;0x02&#039; slot=&#039;0x01&#039; function=&#039;0x1&#039;/&gt; &lt;/controller&gt; &lt;controller type=&#039;usb&#039; index=&#039;0&#039; model=&#039;ich9-uhci3&#039;&gt; &lt;master startport=&#039;4&#039;/&gt; &lt;address type=&#039;pci&#039; domain=&#039;0x0000&#039; bus=&#039;0x02&#039; slot=&#039;0x01&#039; function=&#039;0x2&#039;/&gt; &lt;/controller&gt; &lt;controller type=&#039;sata&#039; index=&#039;0&#039;&gt; &lt;address type=&#039;pci&#039; domain=&#039;0x0000&#039; bus=&#039;0x00&#039; slot=&#039;0x1f&#039; function=&#039;0x2&#039;/&gt; &lt;/controller&gt; &lt;controller type=&#039;ide&#039; index=&#039;0&#039;/&gt; &lt;interface type=&#039;network&#039;&gt; &lt;mac address=&#039;52:54:00:12:34:01&#039;/&gt; &lt;source network=&#039;virt&#039;/&gt; &lt;model type=&#039;virtio&#039;/&gt; &lt;driver name=&#039;vhost&#039; txmode=&#039;iothread&#039; ioeventfd=&#039;on&#039; event_idx=&#039;on&#039; queues=&#039;4&#039;/&gt; &lt;rom bar=&#039;off&#039;/&gt; &lt;address type=&#039;pci&#039; domain=&#039;0x0000&#039; bus=&#039;0x02&#039; slot=&#039;0x02&#039; function=&#039;0x0&#039;/&gt; &lt;/interface&gt; &lt;hostdev mode=&#039;subsystem&#039; type=&#039;usb&#039; managed=&#039;yes&#039;&gt; &lt;source&gt; &lt;vendor id=&#039;0x046d&#039;/&gt; &lt;product id=&#039;0xc52b&#039;/&gt; &lt;/source&gt; &lt;/hostdev&gt; &lt;memballoon model=&#039;virtio&#039;&gt; &lt;address type=&#039;pci&#039; domain=&#039;0x0000&#039; bus=&#039;0x02&#039; slot=&#039;0x05&#039; function=&#039;0x0&#039;/&gt; &lt;/memballoon&gt; &lt;/devices&gt; &lt;qemu:commandline&gt; &lt;qemu:arg value=&#039;-device&#039;/&gt; &lt;qemu:arg value=&#039;ioh3420,bus=pcie.0,addr=1c.0,multifunction=on,port=1,chassis=1,id=root.1&#039;/&gt; &lt;qemu:arg value=&#039;-device&#039;/&gt; &lt;qemu:arg value=&#039;vfio-pci,host=06:00.0,bus=root.1,addr=00.0,multifunction=on,x-vga=on&#039;/&gt; &lt;qemu:arg value=&#039;-device&#039;/&gt; &lt;qemu:arg value=&#039;vfio-pci,host=06:00.1,bus=root.1,addr=00.1&#039;/&gt; &lt;qemu:arg value=&#039;-set&#039;/&gt; &lt;qemu:arg value=&#039;device.virtio-disk0.x-data-plane=off&#039;/&gt; &lt;qemu:arg value=&#039;-set&#039;/&gt; &lt;qemu:arg value=&#039;device.virtio-disk1.x-data-plane=on&#039;/&gt; &lt;qemu:arg value=&#039;-set&#039;/&gt; &lt;qemu:arg value=&#039;drive.drive-virtio-disk0.detect-zeroes=unmap&#039;/&gt; &lt;/qemu:commandline&gt; &lt;/domain&gt;</code></pre></div><p>I have switched to pc-i440fx machine. Libvirt handles it very well and I have generally less problems with it.</p><p>There is also a virsh command, try looking into this:</p><div class="codebox"><pre><code>virsh help domxml-from-native virsh domxml-from-native qemu-argv &lt;config_file&gt;</code></pre></div> <p class="postedit"><em>Last edited by JohnyPea (2015-02-25 10:33:02)</em></p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1506073">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1506075" class="blockpost rowodd"> <h2><span><span class="conr">#4313</span> <a href="viewtopic.php?pid=1506075#p1506075">2015-02-25 10:31:58</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=84760">Denso</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd class="postavatar"><img src="https://bbs.archlinux.org/img/avatars/84760.png?m=1412533733" width="71" height="80" alt="" /></dd> <dd><span>Registered: 2014-08-30</span></dd> <dd><span>Posts: 179</span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><blockquote><div><p>Did anybody try kernel 4.0-rc1?</p></div></blockquote></div><p>4.0-RC1 here . No issue . It was a completely transparent upgrade .</p> <p class="postedit"><em>Last edited by Denso (2015-02-25 10:32:16)</em></p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1506075">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1506078" class="blockpost roweven"> <h2><span><span class="conr">#4314</span> <a href="viewtopic.php?pid=1506078#p1506078">2015-02-25 10:36:34</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=83627">JohnyPea</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2014-07-17</span></dd> <dd><span>Posts: 17</span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>Denso wrote:</cite><blockquote><div><div class="quotebox"><blockquote><div><p>Did anybody try kernel 4.0-rc1?</p></div></blockquote></div><p>4.0-RC1 here . No issue . It was a completely transparent upgrade .</p></div></blockquote></div><p>There has to be some specific error in my kernel or libvirt configs. At least I know it should be working. Thanks.</p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1506078">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1506173" class="blockpost rowodd"> <h2><span><span class="conr">#4315</span> <a href="viewtopic.php?pid=1506173#p1506173">2015-02-25 19:16:51</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=80028">trimm</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2014-03-06</span></dd> <dd><span>Posts: 31</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=80028">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <p>People with nvidia cards passthrough. Are you using it with the 340.52 driver and hv-time or using it with the latest driver with no hv-time? <br />Im unsure if I get better performance with the former or the latter. Anyone with some experience on this?</p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1506173">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1506193" class="blockpost roweven"> <h2><span><span class="conr">#4316</span> <a href="viewtopic.php?pid=1506193#p1506193">2015-02-25 20:12:02</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=85314">Duelist</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2014-09-22</span></dd> <dd><span>Posts: 358</span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>trimm wrote:</cite><blockquote><div><p>People with nvidia cards passthrough. Are you using it with the 340.52 driver and hv-time or using it with the latest driver with no hv-time? <br />Im unsure if I get better performance with the former or the latter. Anyone with some experience on this?</p></div></blockquote></div><p>Depends on the card.<br />If it&#039;s an old card like 4XX series - chances are there will be performance drawback just from newer drivers alone. I&#039;ve witnessed that on a very old card, 250GTS(9800GTX+) - HDMI audio just broke, hardware GPU scaling got broken and there was a performance hit in GPU benchmarks.<br />If it&#039;s 9XX series card - it won&#039;t start with drivers-older-than-the-card because.. it&#039;s obvious why.</p><p>I&#039;d suggest you googling driver benchmarks of some sort. As measured deeply back in time(there was a post from AW with screenshots from borderlands, somewhere last year maybe), performance impact of disabled hyper-v enlightenment and stuff is very little. I&#039;d say, IOMMU and memory management(hugepages and such) issues chop off your performance more.</p><p>For example, my AMD system has some weird issues, getting 100%(compared to bare metal setup) GPU benchmarks(furmark, unigine heaven 4.0) BUT lagging in old games like NFS:Prostreet or rFactor. And i&#039;m not using hugepages or cpu pinning or any other cool stuff this thread is suggesting.</p><p>P.S. word-parasite of the day: stuff.</p> </div> <div class="postsignature postmsg"><hr /><p><span class="bbs">The forum rules prohibit requesting support for distributions other than arch.</span><br /><a href="https://bbs.archlinux.org/viewtopic.php?pid=1551460#p1551460" rel="nofollow">I gave up.</a><a href="https://bbs.archlinux.org/viewtopic.php?id=162768" rel="nofollow"> It was too late.</a><br /><a href="http://pastebin.com/B3fL84bq" rel="nofollow">What I was trying to do</a>.<br /><a href="http://vfio.blogspot.com/" rel="nofollow">The reference about VFIO and KVM VGA passthrough.</a></p></div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1506193">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1506276" class="blockpost rowodd"> <h2><span><span class="conr">#4317</span> <a href="viewtopic.php?pid=1506276#p1506276">2015-02-26 01:34:05</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=87813">Len</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd class="postavatar"><img src="https://bbs.archlinux.org/img/avatars/87813.png?m=1420509844" width="80" height="80" alt="" /></dd> <dd><span>Registered: 2015-01-06</span></dd> <dd><span>Posts: 23</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=87813">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>trimm wrote:</cite><blockquote><div><p>People with nvidia cards passthrough. Are you using it with the 340.52 driver and hv-time or using it with the latest driver with no hv-time? <br />Im unsure if I get better performance with the former or the latter. Anyone with some experience on this?</p></div></blockquote></div><p>I did some performance tests on my GTX970, latest drivers with kvm=off.<br />Check it here <a href="https://bbs.archlinux.org/viewtopic.php?pid=1505174#p1505174" rel="nofollow">https://bbs.archlinux.org/viewtopic.php … 4#p1505174</a></p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1506276">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1506283" class="blockpost roweven"> <h2><span><span class="conr">#4318</span> <a href="viewtopic.php?pid=1506283#p1506283">2015-02-26 02:24:21</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=85100">Tyrewt</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2014-09-13</span></dd> <dd><span>Posts: 14</span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <p>Trying to do some USB passthough in my config with:</p><div class="quotebox"><blockquote><div><p>usb -usbdevice host:056a:00b9 -usbdevice host:2672:000d -usbdevice host:046d:c21d</p></div></blockquote></div><p>The camera (host:2672:000d) is seen by both the Host (Linux) and Guest (Windows7) when plugged in. Also, Windows fails to load a &quot;MTP Device Driver&quot;. I believe it has something to do with USB passthough, usb-mtp.&#160; Can&#039;t find much information on a fix. Please advise?</p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1506283">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1506301" class="blockpost rowodd"> <h2><span><span class="conr">#4319</span> <a href="viewtopic.php?pid=1506301#p1506301">2015-02-26 05:53:28</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=74738">instantepiphany</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2013-09-04</span></dd> <dd><span>Posts: 32</span></dd> <dd class="usercontacts"><span class="email"><a href="mailto:jordancran@gmail.com">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <p>My problem with no graphics output was solved by passing my graphics card bios file to qemu. </p><p>Performance is almost what I get on my dualboot windows 8 setup - with the exception of guild wars 2. I get equal performance - except for when I turn the camera, which drops the FPS down horribly to about 2, until I stop turning the camera. My vcpus aren&#039;t maxed out when i turn the camera, and neither is my virt-ram. What could be causing this? I have tried enabling huge pages, it hasn&#039;t helped.</p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1506301">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1506336" class="blockpost roweven"> <h2><span><span class="conr">#4320</span> <a href="viewtopic.php?pid=1506336#p1506336">2015-02-26 09:20:52</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=79471">Bronek</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>From: London</span></dd> <dd><span>Registered: 2014-02-14</span></dd> <dd><span>Posts: 90</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=79471">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>Tyrewt wrote:</cite><blockquote><div><p>Trying to do some USB passthough in my config with:</p><div class="quotebox"><blockquote><div><p>usb -usbdevice host:056a:00b9 -usbdevice host:2672:000d -usbdevice host:046d:c21d</p></div></blockquote></div><p>The camera (host:2672:000d) is seen by both the Host (Linux) and Guest (Windows7) when plugged in. Also, Windows fails to load a &quot;MTP Device Driver&quot;. I believe it has something to do with USB passthough, usb-mtp.&#160; Can&#039;t find much information on a fix. Please advise?</p></div></blockquote></div><p>I found that the best way for USB passthrough is to pass whole USB controller. You can do it also for USB controllers integrated into the south-bridge since they are attached to PCIe root like normal extension cards. This is useful for all types of USB devices because it basically removes USB root complex from host OS and also removes latency of USB serialisation through qemu. Also perfect for attaching things like USB-DAC for great quality sound.</p> </div> <div class="postsignature postmsg"><hr /><p>Sorry about&#160; &quot;KVM VGA-Passthrough ...&quot; thread <img src="https://bbs.archlinux.org/img/smilies/sad.png" width="15" height="15" alt="sad" /> Anyone interested in continuing this discussion elsewhere, please contact me privately. I might be able to find it a new home.</p></div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1506336">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1506343" class="blockpost rowodd"> <h2><span><span class="conr">#4321</span> <a href="viewtopic.php?pid=1506343#p1506343">2015-02-26 09:46:52</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=86321">thearcherblog</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2014-10-30</span></dd> <dd><span>Posts: 165</span></dd> <dd class="usercontacts"><span class="email"><a href="mailto:jjgarcianorway@gmail.com">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>Bronek wrote:</cite><blockquote><div><div class="quotebox"><cite>Tyrewt wrote:</cite><blockquote><div><p>Trying to do some USB passthough in my config with:</p><div class="quotebox"><blockquote><div><p>usb -usbdevice host:056a:00b9 -usbdevice host:2672:000d -usbdevice host:046d:c21d</p></div></blockquote></div><p>The camera (host:2672:000d) is seen by both the Host (Linux) and Guest (Windows7) when plugged in. Also, Windows fails to load a &quot;MTP Device Driver&quot;. I believe it has something to do with USB passthough, usb-mtp.&#160; Can&#039;t find much information on a fix. Please advise?</p></div></blockquote></div><p>I found that the best way for USB passthrough is to pass whole USB controller. You can do it also for USB controllers integrated into the south-bridge since they are attached to PCIe root like normal extension cards. This is useful for all types of USB devices because it basically removes USB root complex from host OS and also removes latency of USB serialisation through qemu. Also perfect for attaching things like USB-DAC for great quality sound.</p></div></blockquote></div><br /><p>Mmmmm thanks a lot! I will follow your advice because sometimes when I passthrough my USB for keyboard and mouse... if I shutdown the virtual computer and turn it on again... it give me a segmentation fault. I hope can be solved with that.</p><p>Thanks a for that <img src="https://bbs.archlinux.org/img/smilies/smile.png" width="15" height="15" alt="smile" /></p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1506343">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1506355" class="blockpost roweven"> <h2><span><span class="conr">#4322</span> <a href="viewtopic.php?pid=1506355#p1506355">2015-02-26 10:28:17</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=85314">Duelist</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2014-09-22</span></dd> <dd><span>Posts: 358</span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>instantepiphany wrote:</cite><blockquote><div><p>My problem with no graphics output was solved by passing my graphics card bios file to qemu. </p><p>Performance is almost what I get on my dualboot windows 8 setup - with the exception of guild wars 2. I get equal performance - except for when I turn the camera, which drops the FPS down horribly to about 2, until I stop turning the camera. My vcpus aren&#039;t maxed out when i turn the camera, and neither is my virt-ram. What could be causing this? I have tried enabling huge pages, it hasn&#039;t helped.</p></div></blockquote></div><p>Check your disk subsystem, maybe GW2 tries to load tons of small files when you turn around..</p> </div> <div class="postsignature postmsg"><hr /><p><span class="bbs">The forum rules prohibit requesting support for distributions other than arch.</span><br /><a href="https://bbs.archlinux.org/viewtopic.php?pid=1551460#p1551460" rel="nofollow">I gave up.</a><a href="https://bbs.archlinux.org/viewtopic.php?id=162768" rel="nofollow"> It was too late.</a><br /><a href="http://pastebin.com/B3fL84bq" rel="nofollow">What I was trying to do</a>.<br /><a href="http://vfio.blogspot.com/" rel="nofollow">The reference about VFIO and KVM VGA passthrough.</a></p></div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1506355">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1506365" class="blockpost rowodd"> <h2><span><span class="conr">#4323</span> <a href="viewtopic.php?pid=1506365#p1506365">2015-02-26 11:11:37</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=74738">instantepiphany</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2013-09-04</span></dd> <dd><span>Posts: 32</span></dd> <dd class="usercontacts"><span class="email"><a href="mailto:jordancran@gmail.com">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>Duelist wrote:</cite><blockquote><div><div class="quotebox"><cite>instantepiphany wrote:</cite><blockquote><div><p>My problem with no graphics output was solved by passing my graphics card bios file to qemu. </p><p>Performance is almost what I get on my dualboot windows 8 setup - with the exception of guild wars 2. I get equal performance - except for when I turn the camera, which drops the FPS down horribly to about 2, until I stop turning the camera. My vcpus aren&#039;t maxed out when i turn the camera, and neither is my virt-ram. What could be causing this? I have tried enabling huge pages, it hasn&#039;t helped.</p></div></blockquote></div><p>Check your disk subsystem, maybe GW2 tries to load tons of small files when you turn around..</p></div></blockquote></div><p>What should I check? The loading small files possibility is what I thought may be the case, and ended up in figuring out I should be using virtio driver rather than IDE for the disks I am passing through. But the problem still persists. I launch qemu with:</p><div class="codebox"><pre><code>qemu-system-x86_64 -enable-kvm -m 4096 -smp 6,sockets=1,cores=6,threads=1 \ -cpu host \ -machine type=pc,accel=kvm \ -mem-path /libhugetlbfs \ -boot menu=on \ -device virtio-scsi-pci,id=scsi \ -drive file=/home/instantepiphany/qemu/windows7/windows7.img,if=virtio \ -device vfio-pci,host=02:00.0 \ -vga none \ -device vfio-pci,host=01:00.0,multifunction=on,x-vga=on,rombar=0,romfile=/home/instantepiphany/qemu/6950.rom \ -device vfio-pci,host=01:00.1 \ -debugcon file:debug.log -global isa-debugcon.iobase=0x402 \ -usb -usbdevice host:046d:c22a -usbdevice host:05e3:0607 \ -drive file=/dev/sdc,cache=none,if=virtio \ -drive file=/dev/sda,cache=none,if=virtio \</code></pre></div> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1506365">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1506372" class="blockpost roweven"> <h2><span><span class="conr">#4324</span> <a href="viewtopic.php?pid=1506372#p1506372">2015-02-26 11:55:51</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=89132">bubbacub</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2015-02-26</span></dd> <dd><span>Posts: 3</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=89132">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <p>Hi all,<br />Just hoping for a bit of advice.<br />I&#039;ve got passthrough of a r9 270x on a nehalem based quadcore xeon and 3420gp server board with the following startup script on ubuntu 14.04:</p><div class="codebox"><pre class="vscroll"><code>#!/bin/bash configfile=/etc/vfio-pci1.cfg vfiobind() { dev=&quot;$1&quot; vendor=$(cat /sys/bus/pci/devices/$dev/vendor) device=$(cat /sys/bus/pci/devices/$dev/device) if [ -e /sys/bus/pci/devices/$dev/driver ]; then echo $dev &gt; /sys/bus/pci/devices/$dev/driver/unbind fi echo $vendor $device &gt; /sys/bus/pci/drivers/vfio-pci/new_id } modprobe vfio-pci cat $configfile | while read line;do echo $line | grep ^# &gt;/dev/null 2&gt;&amp;1 &amp;&amp; continue vfiobind $line done sudo qemu-system-x86_64 -enable-kvm -M q35 -m 4096 -cpu host \ -smp 4,sockets=1,cores=4,threads=1 \ -bios /usr/share/qemu/bios.bin -vga none \ -device ioh3420,bus=pcie.0,addr=1c.0,multifunction=on,port=1,chassis=1,id=root.1 \ -device vfio-pci,host=01:00.0,bus=root.1,addr=00.0,multifunction=on,x-vga=on \ -device vfio-pci,host=01:00.1,bus=root.1,addr=00.1 \ -drive file=/dev/sdb,id=disk,format=raw -device ide-hd,bus=ide.0,drive=disk \ -drive file=~/virtio-win-0.1-94.iso,id=isocd -device ide-cd,bus=ide.1,drive=isocd \ -boot menu=on \ -usb -usbdevice host:045e:0745 \ -vnc :0 exit 0</code></pre></div><p>Works great as a script and I have a nice host server with a multi TB zfs arrays running two guests, one is a headless linux install running plex server, transmission and filebot for TV and movies and the second is windows 8 instance for virtualised gaming using steam in home streaming over my home network. </p><p>My issue that I&#039;ve been banging my head against a wall is getting the above script to run via libvirt so that I could use all the awesome VM management tools it comes with.</p><p>I&#039;ve tried using domxml-from-native to create an xml file that sucessfully defines through virsh but doesn&#039;t let me start a vm.</p><p>my xml file based on the above qemu arguments is:</p><div class="codebox"><pre class="vscroll"><code>&lt;domain type=&#039;kvm&#039; xmlns:qemu=&#039;http://libvirt.org/schemas/domain/qemu/1.0&#039;&gt; &lt;name&gt;win8qemu&lt;/name&gt; &lt;uuid&gt;1009128f-983a-45e5-9d88-9295fcf0a692&lt;/uuid&gt; &lt;memory unit=&#039;KiB&#039;&gt;4194304&lt;/memory&gt; &lt;currentMemory unit=&#039;KiB&#039;&gt;4194304&lt;/currentMemory&gt; &lt;vcpu placement=&#039;static&#039;&gt;1&lt;/vcpu&gt; &lt;os&gt; &lt;type arch=&#039;i686&#039; machine=&#039;q35&#039;&gt;hvm&lt;/type&gt; &lt;/os&gt; &lt;features&gt; &lt;acpi/&gt; &lt;/features&gt; &lt;cpu mode=&#039;custom&#039; match=&#039;exact&#039;&gt; &lt;model fallback=&#039;allow&#039;&gt;host&lt;/model&gt; &lt;/cpu&gt; &lt;clock offset=&#039;utc&#039;/&gt; &lt;on_poweroff&gt;destroy&lt;/on_poweroff&gt; &lt;on_reboot&gt;restart&lt;/on_reboot&gt; &lt;on_crash&gt;destroy&lt;/on_crash&gt; &lt;devices&gt; &lt;emulator&gt;/usr/bin/qemu-system-x86_64&lt;/emulator&gt; &lt;controller type=&#039;sata&#039; index=&#039;0&#039;/&gt; &lt;controller type=&#039;pci&#039; index=&#039;0&#039; model=&#039;pcie-root&#039;/&gt; &lt;controller type=&#039;pci&#039; index=&#039;1&#039; model=&#039;dmi-to-pci-bridge&#039;/&gt; &lt;controller type=&#039;pci&#039; index=&#039;2&#039; model=&#039;pci-bridge&#039;/&gt; &lt;input type=&#039;mouse&#039; bus=&#039;ps2&#039;/&gt; &lt;input type=&#039;keyboard&#039; bus=&#039;ps2&#039;/&gt; &lt;graphics type=&#039;sdl&#039;/&gt; &lt;video&gt; &lt;model type=&#039;cirrus&#039; vram=&#039;9216&#039; heads=&#039;1&#039;/&gt; &lt;/video&gt; &lt;hostdev mode=&#039;subsystem&#039; type=&#039;usb&#039; managed=&#039;no&#039;&gt; &lt;source&gt; &lt;vendor id=&#039;0x045e&#039;/&gt; &lt;product id=&#039;0x0745&#039;/&gt; &lt;/source&gt; &lt;/hostdev&gt; &lt;memballoon model=&#039;virtio&#039;/&gt; &lt;/devices&gt; &lt;qemu:commandline&gt; &lt;qemu:arg value=&#039;qemu-system-x86_64&#039;/&gt; &lt;qemu:arg value=&#039;\ -smp&#039;/&gt; &lt;qemu:arg value=&#039;4,sockets=1,cores=4,threads=1&#039;/&gt; &lt;qemu:arg value=&#039;\ -bios&#039;/&gt; &lt;qemu:arg value=&#039;/usr/share/qemu/bios.bin&#039;/&gt; &lt;qemu:arg value=&#039;\ -device&#039;/&gt; &lt;qemu:arg value=&#039;ioh3420,bus=pcie.0,addr=1c.0,multifunction=on,port=1,chassis=1,id=root.1&#039;/&gt; &lt;qemu:arg value=&#039;\ -device&#039;/&gt; &lt;qemu:arg value=&#039;vfio-pci,host=01:00.0,bus=root.1,addr=00.0,multifunction=on,x-vga=on&#039;/&gt; &lt;qemu:arg value=&#039;\ -device&#039;/&gt; &lt;qemu:arg value=&#039;vfio-pci,host=01:00.1,bus=root.1,addr=00.1&#039;/&gt; &lt;qemu:arg value=&#039;\ -drive&#039;/&gt; &lt;qemu:arg value=&#039;file=/dev/sdb,id=disk,format=raw&#039;/&gt; &lt;qemu:arg value=&#039;-device&#039;/&gt; &lt;qemu:arg value=&#039;ide-hd,bus=ide.0,drive=disk&#039;/&gt; &lt;qemu:arg value=&#039;\ -drive&#039;/&gt; &lt;qemu:arg value=&#039;file=~/virtio-win-0.1-94.iso,id=isocd&#039;/&gt; &lt;qemu:arg value=&#039;-device&#039;/&gt; &lt;qemu:arg value=&#039;ide-cd,bus=ide.1,drive=isocd&#039;/&gt; &lt;qemu:arg value=&#039;\ -boot&#039;/&gt; &lt;qemu:arg value=&#039;menu=on&#039;/&gt; &lt;qemu:arg value=&#039;\ -usb&#039;/&gt; &lt;qemu:arg value=&#039;\ -vnc&#039;/&gt; &lt;qemu:arg value=&#039;:0&#039;/&gt; &lt;/qemu:commandline&gt; &lt;/domain&gt;</code></pre></div><br /><p>I think this VM doesnt work because the bits of my vm script that sort out the pci passthrough:</p><div class="codebox"><pre><code>#!/bin/bash configfile=/etc/vfio-pci1.cfg vfiobind() { dev=&quot;$1&quot; vendor=$(cat /sys/bus/pci/devices/$dev/vendor) device=$(cat /sys/bus/pci/devices/$dev/device) if [ -e /sys/bus/pci/devices/$dev/driver ]; then echo $dev &gt; /sys/bus/pci/devices/$dev/driver/unbind fi echo $vendor $device &gt; /sys/bus/pci/drivers/vfio-pci/new_id } modprobe vfio-pci cat $configfile | while read line;do echo $line | grep ^# &gt;/dev/null 2&gt;&amp;1 &amp;&amp; continue vfiobind $line done</code></pre></div><p>arn&#039;t been executed by libvirt. Any ideas for how I might get the above snippet of code running as a service continuously?</p><br /><p>p.s. If I&#039;ve broken the local ethos of the forum in any way by posting here, please accept my apologies, correct me and (hopefully help me!)</p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1506372">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1506448" class="blockpost rowodd"> <h2><span><span class="conr">#4325</span> <a href="viewtopic.php?pid=1506448#p1506448">2015-02-26 16:37:11</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=83627">JohnyPea</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2014-07-17</span></dd> <dd><span>Posts: 17</span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>bubbacub wrote:</cite><blockquote><div><p>...<br />arn&#039;t been executed by libvirt. Any ideas for how I might get the above snippet of code running as a service continuously?</p><br /><p>p.s. If I&#039;ve broken the local ethos of the forum in any way by posting here, please accept my apologies, correct me and (hopefully help me!)</p></div></blockquote></div><p>That domxml-from-native went horrible. I tried it to see why, because my previous attempts were better. I had to edit the result a lot in the end, but I think this is a good approximation to your original machine (I don&#039;t exactly know the logic that qemu uses for address assignment so those can differ and cause problems for your guest). Seeing you are using fedoras virtio image, I set the disk type to virtio:</p><div class="codebox"><pre class="vscroll"><code>&lt;domain type=&#039;kvm&#039; xmlns:qemu=&#039;http://libvirt.org/schemas/domain/qemu/1.0&#039;&gt; &lt;name&gt;win8qemu&lt;/name&gt; &lt;uuid&gt;6e68b59c-0977-49d9-82b7-325662a8ee13&lt;/uuid&gt; &lt;memory unit=&#039;KiB&#039;&gt;4194304&lt;/memory&gt; &lt;currentMemory unit=&#039;KiB&#039;&gt;4194304&lt;/currentMemory&gt; &lt;vcpu placement=&#039;static&#039;&gt;4&lt;/vcpu&gt; &lt;os&gt; &lt;type arch=&#039;x86_64&#039; machine=&#039;pc-q35&#039;&gt;hvm&lt;/type&gt; &lt;loader type=&#039;rom&#039;&gt;/usr/share/qemu/bios.bin&lt;/loader&gt; &lt;boot dev=&#039;hd&#039;/&gt; &lt;bootmenu enable=&#039;yes&#039;/&gt; &lt;/os&gt; &lt;features&gt; &lt;acpi/&gt; &lt;/features&gt; &lt;cpu mode=&#039;host-passthrough&#039;&gt; &lt;topology sockets=&#039;1&#039; cores=&#039;4&#039; threads=&#039;1&#039;/&gt; &lt;/cpu&gt; &lt;clock offset=&#039;utc&#039;/&gt; &lt;on_poweroff&gt;destroy&lt;/on_poweroff&gt; &lt;on_reboot&gt;restart&lt;/on_reboot&gt; &lt;on_crash&gt;destroy&lt;/on_crash&gt; &lt;devices&gt; &lt;emulator&gt;/usr/bin/qemu-system-x86_64&lt;/emulator&gt; &lt;disk type=&#039;block&#039; device=&#039;disk&#039;&gt; &lt;driver name=&#039;qemu&#039; type=&#039;qcow2&#039; cache=&#039;none&#039;/&gt; &lt;source file=&#039;/dev/sdb&#039;/&gt; &lt;target dev=&#039;vda&#039; bus=&#039;virtio&#039;/&gt; &lt;address type=&#039;pci&#039; domain=&#039;0x0000&#039; bus=&#039;0x02&#039; slot=&#039;0x02&#039; function=&#039;0x0&#039;/&gt; &lt;/disk&gt; &lt;disk type=&#039;file&#039; device=&#039;cdrom&#039;&gt; &lt;driver name=&#039;qemu&#039; type=&#039;raw&#039;/&gt; &lt;source file=&#039;/home/dzon/Images/virtio-win-0.1-94.iso&#039;/&gt; &lt;target dev=&#039;hda&#039; bus=&#039;ide&#039;/&gt; &lt;readonly/&gt; &lt;address type=&#039;drive&#039; controller=&#039;0&#039; bus=&#039;0&#039; target=&#039;0&#039; unit=&#039;0&#039;/&gt; &lt;/disk&gt; &lt;controller type=&#039;usb&#039; index=&#039;0&#039;&gt; &lt;address type=&#039;pci&#039; domain=&#039;0x0000&#039; bus=&#039;0x02&#039; slot=&#039;0x01&#039; function=&#039;0x0&#039;/&gt; &lt;/controller&gt; &lt;controller type=&#039;sata&#039; index=&#039;0&#039;&gt; &lt;address type=&#039;pci&#039; domain=&#039;0x0000&#039; bus=&#039;0x00&#039; slot=&#039;0x1f&#039; function=&#039;0x2&#039;/&gt; &lt;/controller&gt; &lt;controller type=&#039;pci&#039; index=&#039;0&#039; model=&#039;pcie-root&#039;/&gt; &lt;controller type=&#039;pci&#039; index=&#039;1&#039; model=&#039;dmi-to-pci-bridge&#039;&gt; &lt;address type=&#039;pci&#039; domain=&#039;0x0000&#039; bus=&#039;0x00&#039; slot=&#039;0x1e&#039; function=&#039;0x0&#039;/&gt; &lt;/controller&gt; &lt;controller type=&#039;pci&#039; index=&#039;2&#039; model=&#039;pci-bridge&#039;&gt; &lt;address type=&#039;pci&#039; domain=&#039;0x0000&#039; bus=&#039;0x01&#039; slot=&#039;0x01&#039; function=&#039;0x0&#039;/&gt; &lt;/controller&gt; &lt;controller type=&#039;ide&#039; index=&#039;0&#039;/&gt; &lt;hostdev mode=&#039;subsystem&#039; type=&#039;usb&#039; managed=&#039;no&#039;&gt; &lt;source&gt; &lt;vendor id=&#039;0x045e&#039;/&gt; &lt;product id=&#039;0x0745&#039;/&gt; &lt;/source&gt; &lt;/hostdev&gt; &lt;memballoon model=&#039;none&#039;/&gt; &lt;/devices&gt; &lt;qemu:commandline&gt; &lt;qemu:arg value=&#039;-device&#039;/&gt; &lt;qemu:arg value=&#039;ioh3420,bus=pcie.0,addr=1c.0,multifunction=on,port=1,chassis=1,id=root.1&#039;/&gt; &lt;qemu:arg value=&#039;-device&#039;/&gt; &lt;qemu:arg value=&#039;vfio-pci,host=01:00.0,bus=root.1,addr=00.0,multifunction=on,x-vga=on&#039;/&gt; &lt;qemu:arg value=&#039;-device&#039;/&gt; &lt;qemu:arg value=&#039;vfio-pci,host=01:00.1,bus=root.1,addr=00.1&#039;/&gt; &lt;/qemu:commandline&gt; &lt;/domain&gt;</code></pre></div><p>Regarding the vfio binding, you have to do it only once (if you dont use the device for anything else than passthrough, which I suppouse you dont). So it can be run in startup script (the simplest way for ubuntu: /etc/rc.local), or if compiled in kernel, you can do the binding through kernel command line directly to vfio driver instead of pci-stub. Didnt test this last one, yet.</p><p>There is also the possibility to run it through /etc/libvirt/hooks/qemu, but there you need to make tests for what event is occuring (start/stop, which machine). I&#039;m using it for setting host tasks affinity to non-guest cores and reservation/release of hugepages.</p><p>Also I would suggest to use pc-i440fx machine type to avoid &quot;qemu:arg&quot; mayhem as much as possibe. Then libvirt does a pretty good job with management. But you would probably need to reinstall the guest.</p><p>I am thinking of getting 290x, out of curiosity and also because the effort needed to circumvent nVidias &quot;helpfullness&quot;. So please let us know how it works out.</p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1506448">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div class="postlinksb"> <div class="inbox crumbsplus"> <div class="pagepost"> <p class="pagelink conl"><span class="pages-label">Pages: </span><a rel="prev" class="item1" href="viewtopic.php?id=162768&amp;p=172">Previous</a> <a href="viewtopic.php?id=162768">1</a> <span class="spacer">…</span> <a href="viewtopic.php?id=162768&amp;p=171">171</a> <a href="viewtopic.php?id=162768&amp;p=172">172</a> <strong>173</strong> <a href="viewtopic.php?id=162768&amp;p=174">174</a> <a href="viewtopic.php?id=162768&amp;p=175">175</a> <span class="spacer">…</span> <a href="viewtopic.php?id=162768&amp;p=234">234</a> <a rel="next" href="viewtopic.php?id=162768&amp;p=174">Next</a></p> <p class="postlink conr">Topic closed</p> </div> <ul class="crumbs"> <li><a href="index.php">Index</a></li> <li><span>»&#160;</span><a href="viewforum.php?id=48">Topics Going Nowhere</a></li> <li><span>»&#160;</span><strong><a href="viewtopic.php?id=162768">KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</a></strong></li> </ul> <p class="subscribelink clearb"><a href="misc.php?action=subscribe&amp;tid=162768">Subscribe to this topic</a></p> <div class="clearer"></div> </div> </div> </div> <div id="brdfooter" class="block"> <h2><span>Board footer</span></h2> <div class="box"> <div id="brdfooternav" class="inbox"> <div class="conl"> <form id="qjump" method="get" action="viewforum.php"> <div><label><span>Jump to<br /></span> <select name="id" onchange="window.location=('viewforum.php?id='+this.options[this.selectedIndex].value)"> <optgroup label="Technical Issues and Assistance"> <option value="23">Newbie Corner</option> <option value="17">Installation</option> <option value="22">Kernel &amp; Hardware</option> <option value="18">Applications &amp; Desktop Environments</option> <option value="31">Laptop Issues</option> <option value="8">Networking, Server, and Protection</option> <option value="32">Multimedia and Games</option> <option value="50">System Administration</option> <option value="35">Other Architectures</option> </optgroup> <optgroup label="Arch-centric"> <option value="24">Announcements, Package &amp; Security Advisories</option> <option value="1">Arch Discussion</option> <option value="13">Forum &amp; Wiki discussion</option> </optgroup> <optgroup label="Pacman Upgrades, Packaging &amp; AUR"> <option value="44">Pacman &amp; Package Upgrade Issues</option> <option value="49">[testing] Repo Forum</option> <option value="4">Creating &amp; Modifying Packages</option> <option value="38">AUR Issues, Discussion &amp; PKGBUILD Requests</option> </optgroup> <optgroup label="Contributions &amp; Discussion"> <option value="20">GNU/Linux Discussion</option> <option value="27">Community Contributions</option> <option value="33">Programming &amp; Scripting</option> <option value="30">Other Languages</option> <option value="47">Artwork and Screenshots</option> <option value="42">Try This</option> </optgroup> <optgroup label="/dev/null"> <option value="29">Off-Topic</option> <option value="48" selected="selected">Topics Going Nowhere</option> <option value="36">Dustbin</option> </optgroup> </select></label> <input type="submit" value=" Go " accesskey="g" /> </div> </form> </div> <div class="conr"> <p id="feedlinks"><span class="atom"><a href="extern.php?action=feed&amp;tid=162768&amp;type=atom">Atom topic feed</a></span></p> <p id="poweredby">Powered by <a href="http://fluxbb.org/">FluxBB</a></p> </div> <div class="clearer"></div> </div> </div> </div> </div> <div class="end-box"></div> </div> </body> </html>
