<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"> <html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en" dir="ltr"> <head> <meta http-equiv="Content-Type" content="text/html; charset=utf-8" /> <title>KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9 (Page 39) / Topics Going Nowhere / Arch Linux Forums</title> <link rel="stylesheet" type="text/css" href="style/ArchLinux.css" /> <link rel="canonical" href="viewtopic.php?id=162768&amp;p=39" title="Page 39" /> <link rel="prev" href="viewtopic.php?id=162768&amp;p=38" title="Page 38" /> <link rel="next" href="viewtopic.php?id=162768&amp;p=40" title="Page 40" /> <link rel="alternate" type="application/atom+xml" href="extern.php?action=feed&amp;tid=162768&amp;type=atom" title="Atom topic feed" /> <link rel="stylesheet" media="screen" href="style/ArchLinux/arch.css?v=3" /> <link rel="stylesheet" media="screen" href="style/ArchLinux/archnavbar.css?v=2" /> <link rel="shortcut icon" href="style/ArchLinux/favicon.ico" /> </head> <body> <div id="archnavbar" class="anb-forum"> <div id="archnavbarlogo"><h1><a href="http://www.archlinux.org/">Arch Linux</a></h1></div> <div id="archnavbarmenu"> <ul id="archnavbarlist"> <li id="anb-home"><a href="http://www.archlinux.org/">Home</a></li><li id="anb-packages"><a href="http://www.archlinux.org/packages/">Packages</a></li><li id="anb-forums" class="anb-selected"><a href="https://bbs.archlinux.org/">Forums</a></li><li id="anb-wiki"><a href="https://wiki.archlinux.org/">Wiki</a></li><li id="anb-bugs"><a href="https://bugs.archlinux.org/">Bugs</a></li><li id="anb-aur"><a href="https://aur.archlinux.org/">AUR</a></li><li id="anb-download"><a href="http://www.archlinux.org/download/">Download</a></li> </ul> </div> </div> <div id="punviewtopic" class="pun"> <div class="top-box"></div> <div class="punwrap"> <div id="brdheader" class="block"> <div class="box"> <div id="brdmenu" class="inbox"> <ul> <li id="navindex" class="isactive"><a href="index.php">Index</a></li> <li id="navuserlist"><a href="userlist.php">User list</a></li> <li id="navsearch"><a href="search.php">Search</a></li> <li id="navprofile"><a href="profile.php?id=80749">Profile</a></li> <li id="navlogout"><a href="login.php?action=out&amp;id=80749&amp;csrf_token=5c20501ec397bb45ef8ee8c84db232c8d8e421c6">Logout</a></li> </ul> </div> <div id="brdwelcome" class="inbox"> <ul class="conl"> <li><span>Logged in as <strong>SXX</strong></span></li> <li><span>Last visit: 2015-08-16 12:20:09</span></li> </ul> <ul class="conr"> <li><span>Topics: <a href="search.php?action=show_replies" title="Find topics you have posted to.">Posted</a> | <a href="search.php?action=show_new" title="Find topics with new posts since your last visit.">New</a> | <a href="search.php?action=show_recent" title="Find topics with recent posts.">Active</a> | <a href="search.php?action=show_unanswered" title="Find topics with no replies.">Unanswered</a></span></li> </ul> <div class="clearer"></div> </div> </div> </div> <div id="brdmain"> <div class="linkst"> <div class="inbox crumbsplus"> <ul class="crumbs"> <li><a href="index.php">Index</a></li> <li><span>»&#160;</span><a href="viewforum.php?id=48">Topics Going Nowhere</a></li> <li><span>»&#160;</span><strong><a href="viewtopic.php?id=162768">KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</a></strong></li> </ul> <div class="pagepost"> <p class="pagelink conl"><span class="pages-label">Pages: </span><a rel="prev" class="item1" href="viewtopic.php?id=162768&amp;p=38">Previous</a> <a href="viewtopic.php?id=162768">1</a> <span class="spacer">…</span> <a href="viewtopic.php?id=162768&amp;p=37">37</a> <a href="viewtopic.php?id=162768&amp;p=38">38</a> <strong>39</strong> <a href="viewtopic.php?id=162768&amp;p=40">40</a> <a href="viewtopic.php?id=162768&amp;p=41">41</a> <span class="spacer">…</span> <a href="viewtopic.php?id=162768&amp;p=234">234</a> <a rel="next" href="viewtopic.php?id=162768&amp;p=40">Next</a></p> <p class="postlink conr">Topic closed</p> </div> <div class="clearer"></div> </div> </div> <div id="p1364681" class="blockpost rowodd blockpost1"> <h2><span><span class="conr">#951</span> <a href="viewtopic.php?pid=1364681#p1364681">2013-12-28 13:55:54</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=70922">nbhs</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd class="postavatar"><img src="https://bbs.archlinux.org/img/avatars/70922.jpg?m=1367773811" width="80" height="80" alt="" /></dd> <dd><span>From: Montevideo, Uruguay</span></dd> <dd><span>Registered: 2013-05-02</span></dd> <dd><span>Posts: 402</span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>BulliteShot wrote:</cite><blockquote><div><p>By the way, the linux-mainline package provided in this topic doesn&#039;t have the kernel modules statically loaded by default. I had to change the config files manually and skip makepkg integrity check. I know you can enable them in the kernel config dialog but I can never find anything there. I don&#039;t understand why they wouldn&#039;t be enabled by default in the package since it&#039;s possible to do so?</p></div></blockquote></div><p>They&#039;re built as modules, it shouldn&#039;t make any difference as far as i&#039;m aware off</p> <p class="postedit"><em>Last edited by nbhs (2013-12-28 13:58:44)</em></p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1364681">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1364694" class="blockpost roweven"> <h2><span><span class="conr">#952</span> <a href="viewtopic.php?pid=1364694#p1364694">2013-12-28 14:54:07</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=77819">tuoni</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2013-12-19</span></dd> <dd><span>Posts: 7</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=77819">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>techdude300 wrote:</cite><blockquote><div><div class="quotebox"><cite>xani wrote:</cite><blockquote><div><p>Here&#039;s my directory from which you can test that memory leak issues.<br /><a href="http://www.fileswap.com/dl/qlZAIl1IF/" rel="nofollow">linux-mainline.tar.gz</a></p><p>Provide me with feedback if you have the same problem with seabios after reverting those patches.</p></div></blockquote></div><p>Thanks so much! I can confirm that this does in fact seem to fix the issue. For some reason I was having trouble building it when i tried the first two times, but I got it to work on the 3rd try. All the memory the VM allocates is now returned back to the machine, so I no longer have to reboot the host. A very strange issue. Now all that&#039;s left on my end is to figure out sound.</p></div></blockquote></div><p>I have finally gotten round to testing this this morning and can confirm it also fixed the problem for me.&#160; Thank you!</p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1364694">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1365018" class="blockpost rowodd"> <h2><span><span class="conr">#953</span> <a href="viewtopic.php?pid=1365018#p1365018">2013-12-29 15:51:43</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=77842">Flyser</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2013-12-19</span></dd> <dd><span>Posts: 29</span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <p>Hey guys,<br />I have another success story for you <img src="https://bbs.archlinux.org/img/smilies/smile.png" width="15" height="15" alt="smile" /></p><p>I almost gave up on getting vga passthrough to work on my system (Intel DH87RL, i7-4771, Intel graphics + GTX 660) due to error 43, but I just found that a bios setting was the solution.<br />My mainboard has a &quot;fast boot&quot; option, which prevents the gpus from getting initialized by the bios and leaves that task to the operating system or bootloader. Previously both gpus would show the bios splash screen and the bootloader, now the only the internal graphics shows the bootloader and the linux console. I also had to use the romfile setting to get *any* output at all, which is not neccessary anymore. Now everything is running smooth and windows 8.1 works like a charm (well it&#039;s still a crappy os, but you know what I mean ;-)).<br />I think this setting would be worth mentioning on the first post, as it might solve the issue for others as well.</p><p>A few words about my setup (in the hope that it will be useful for others with similar hardware):<br />kernel cmdline: only </p><div class="codebox"><pre><code>intel_iommu=on</code></pre></div><p> is needed<br />qemu cmdline: </p><div class="codebox"><pre><code>qemu-system-x86_64 -name windows8.1 -enable-kvm -watchdog i6300esb -boot menu=on -localtime -machine type=q35,accel=kvm -cpu host -smp 8,cores=4,threads=2,sockets=1 -m 6144 -k de -monitor tcp:127.0.0.1:5702,server,nowait -balloon virtio -vga none -display none -bios /root/vt-d/qemu-git/pc-bios/bios.bin -device ioh3420,bus=pcie.0,addr=1c.0,multifunction=on,port=1,chassis=1,id=root.1 -device vfio-pci,host=01:00.0,bus=root.1,addr=00.0,multifunction=on,x-vga=on -device vfio-pci,host=01:00.1,bus=root.1,addr=00.1 -usb -device usb-host,vendorid=0x17ef,productid=0x6009 -netdev user,id=net.0 -device virtio-net-pci,netdev=net.0,mac=00:01:02:03:04:05 -drive id=disk1,file=/dev/sdd,if=none,index=0,media=disk -device virtio-blk-pci,drive=disk1,bootindex=1</code></pre></div><p>software versions: qemu-1.7.50-git_e8092f7 and bundled seabios, linux 3.13-rc6 with i915 and memleak patches (3.12.6+patches did not work)</p><p>Now I can fine-tune my setup. Have you found a good solution to save power while the VM is shut down or not in use? I am running this on my 24/7 home server and having the nvidia card running without any power management permanently consumes about 20 Watts, which amounts to over 50€ electricity cost per year in my country.</p><p>Best regards,<br />Flyser</p> <p class="postedit"><em>Last edited by Flyser (2014-01-03 23:44:57)</em></p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1365018">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1365022" class="blockpost roweven"> <h2><span><span class="conr">#954</span> <a href="viewtopic.php?pid=1365022#p1365022">2013-12-29 16:02:16</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=61335">Jesse2004</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2012-06-25</span></dd> <dd><span>Posts: 9</span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>tuoni wrote:</cite><blockquote><div><p>Hi guys, I just registered to thank you all for your work - because of this thread, I have finally got KVM/QEMU VGA passthrough working on my GT660Ti.</p><p>My setup is i7-4770 / ASRock Z87 Extreme 4 / Nvidia GT660Ti, host OS is Debian x64, guest OS is Windows 7 x64, keyboard/mouse sharing with Synergy.</p><p>I had bought the processor/mobo combo specifically to try and do VGA passthrough and had been really struggling first with Xen and latterly with KVM until I found this thread - the information in the OP and the patches it links to have been invaluable.</p><p>Thanks once again, all.</p></div></blockquote></div><p>Hi tuoni, could you please elaborate a little more on your software stack? Are you using Wheezy plus self-compiled kernel and qemu or Debian unstable or ... ? </p><p>Just thinking about buying a very similar set of gears as yours. <img src="https://bbs.archlinux.org/img/smilies/smile.png" width="15" height="15" alt="smile" /></p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1365022">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1365491" class="blockpost rowodd"> <h2><span><span class="conr">#955</span> <a href="viewtopic.php?pid=1365491#p1365491">2013-12-30 22:12:20</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=77819">tuoni</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2013-12-19</span></dd> <dd><span>Posts: 7</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=77819">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>Jesse2004 wrote:</cite><blockquote><div><div class="quotebox"><cite>tuoni wrote:</cite><blockquote><div><p>Hi guys, I just registered to thank you all for your work - because of this thread, I have finally got KVM/QEMU VGA passthrough working on my GT660Ti.</p><p>My setup is i7-4770 / ASRock Z87 Extreme 4 / Nvidia GT660Ti, host OS is Debian x64, guest OS is Windows 7 x64, keyboard/mouse sharing with Synergy.</p><p>I had bought the processor/mobo combo specifically to try and do VGA passthrough and had been really struggling first with Xen and latterly with KVM until I found this thread - the information in the OP and the patches it links to have been invaluable.</p><p>Thanks once again, all.</p></div></blockquote></div><p>Hi tuoni, could you please elaborate a little more on your software stack? Are you using Wheezy plus self-compiled kernel and qemu or Debian unstable or ... ? </p><p>Just thinking about buying a very similar set of gears as yours. <img src="https://bbs.archlinux.org/img/smilies/smile.png" width="15" height="15" alt="smile" /></p></div></blockquote></div><p>Sure - I&#039;m using Jessie, self-compiled kernel (3.13-rc5 with gcc, i915, mem-leak and acs patches) and qemu from git pull (with vfio patch).&#160; I&#039;m pretty sure it would work just fine on Wheezy, though, as you need to build your own kernel and qemu anyway.</p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1365491">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1365874" class="blockpost roweven"> <h2><span><span class="conr">#956</span> <a href="viewtopic.php?pid=1365874#p1365874">2014-01-01 11:36:35</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=73114">noctavian</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2013-07-11</span></dd> <dd><span>Posts: 9</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=73114">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <p>Hi, I made a summary of the working hardware and software configurations mentioned in the thread:<br /><a href="https://docs.google.com/spreadsheet/ccc?key=0Aryg5nO-kBebdFozaW9tUWdVd2VHM0lvck95TUlpMlE&amp;usp=drive_web#gid=0" rel="nofollow"> Configs </a></p><p>I hope I got all of them right, but there might be some mistakes, feel free to correct them. I&#039;m also going to try VGA passthrough with vfio in next days.</p> </div> <div class="postsignature postmsg"><hr /><p><a href="https://docs.google.com/spreadsheet/ccc?key=0Aryg5nO-kBebdFozaW9tUWdVd2VHM0lvck95TUlpMlE&amp;usp=drive_web#gid=0" rel="nofollow">VGA-Passthrough configs</a></p></div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1365874">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1365901" class="blockpost rowodd"> <h2><span><span class="conr">#957</span> <a href="viewtopic.php?pid=1365901#p1365901">2014-01-01 13:19:12</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=72338">empie</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>From: The Netherlands</span></dd> <dd><span>Registered: 2013-06-15</span></dd> <dd><span>Posts: 9</span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <p>Great job noctavian!</p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1365901">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1366102" class="blockpost roweven"> <h2><span><span class="conr">#958</span> <a href="viewtopic.php?pid=1366102#p1366102">2014-01-02 00:26:38</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=48315">TripleSpeeder</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2011-05-02</span></dd> <dd><span>Posts: 43</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=48315">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <p>xani, I can confirm that your kernel also fixes the memory problems for me. All mem is free&#039;d when qemu exits :-)</p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1366102">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1366127" class="blockpost rowodd"> <h2><span><span class="conr">#959</span> <a href="viewtopic.php?pid=1366127#p1366127">2014-01-02 01:59:40</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=77789">syllopsium</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2013-12-18</span></dd> <dd><span>Posts: 4</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=77789">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <p>Success! I haven&#039;t conducted a full cycle of tests yet, but it works with Windows 7 and 8 x64 once the NoSnoop patch is applied to aw&#039;s qemu-vfio.git. GPU BIOS file is required.I suspect normal qemu would be fine too. Some instability when fiddling around with configs. Please hold for a stable configuration..</p><p>The nosnoop patch is not required for a Linux guest to work correctly with passthrough. At the moment I&#039;m using the qemu64 processor instead of &#039;host&#039; inside qemu. Changing it to host creates bluescreens. This might change if installed from scratch - watch this space. I hadn&#039;t bothered applying the nosnoop patch before now as I thought it was only necessary for Nvidia cards.</p><p>Brief configuration : Debian Jessie (Arch worked for Linux passthrough too, but Arch is a little too fast moving a distro for my main system). Kernel 3.13.0-rc5 with ACS patch. qemu with nosnoop patch.<br />Hardware : Intel S3210SHLC server motherboard, passing through AMD HD6950 GPU. Host GPU : discrete Geforce 218.<br />Qemu config : qemu64 processor in use. It is absolutely necessary to supply the appropriate BIOS to the graphics card. Experimented with various ioh3420/PCIe root configurations, appears fine with both below the ioh.</p><p>The motherboard has a built in Matrox G200e, I&#039;m hoping to pass this through to a different VM as it&#039;s a horribly slow chip. It appears in the same iommu group as the southbridge x4 PCIe slot (the only slot where a graphics card won&#039;t be slowed down to x1 speed by the 3210 chipset on this motherboard). This is why I&#039;ve applied the ACS patch.</p><p>Now to experiment more and decide if I want to run a fairly full function Linux host with a Windows guest, or a barebones Linux host with passthrough for both Windows and Linux or BSD VMs..</p> <p class="postedit"><em>Last edited by syllopsium (2014-01-02 02:00:31)</em></p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1366127">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1366134" class="blockpost roweven"> <h2><span><span class="conr">#960</span> <a href="viewtopic.php?pid=1366134#p1366134">2014-01-02 02:50:48</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=78180">pascal257</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2014-01-02</span></dd> <dd><span>Posts: 3</span></dd> <dd class="usercontacts"><span class="email"><a href="mailto:p@pkne.de">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <p>Haha, I was about to post this, but I could fix the error by modprobe vfio_iommu_type1. So if someone has a similar problem, that might help.<br />But I would still like to know:<br />I&#039;ve compiled the kernel without changing the config. Should I enable the VFIO config settings or is that not necessary with the patches?</p><p>Edit: And another question: I&#039;d like to run a media center through the integrated graphics. Is that feasible? Can I pci-stub the integrated graphics from Arch and run it to a VM or are there any known problems?</p><div class="quotebox"><blockquote><div><p>First of all this thread has been a great read so far. I first started VGA-Passthrough with esxi and besides several other problems that didn&#039;t actually work.<br />Unfortunately I couldn&#039;t get it running with KVM either, but I&#039;m certain that it&#039;ll work.</p><p>That&#039;s my hardware:<br />ASRock Z87 Extreme6<br />Intel i7 4770 (Host running on integrated graphics)<br />AMD Radeon R9 290 (For Windows Host)<br />NVidia GT 630 (For OSX Host)</p><p>At the moment I am working on getting the R9 290 to run.</p><p>On the software side:<br />Linux home 3.13.0-2-mainline - Compiled from first post with pci-stub.ids=1002:67b1,1002:aac8 intel_iommu=on pcie_acs_override=downstream<br />QEMU emulator version 1.7.50 - Compiled from first post</p><p>pci-stub is grabbing the card correctly:<br />[&#160; &#160; 0.920077] pci-stub: add 1002:67B1 sub=FFFFFFFF:FFFFFFFF cls=00000000/00000000<br />[&#160; &#160; 0.920083] pci-stub 0000:01:00.0: claimed by stub<br />[&#160; &#160; 0.920086] pci-stub: add 1002:AAC8 sub=FFFFFFFF:FFFFFFFF cls=00000000/00000000<br />[&#160; &#160; 0.920090] pci-stub 0000:01:00.1: claimed by stub</p><p>But I&#039;m getting this error running qemu-system-x86_64 -enable-kvm -M q35 -m 1024 -cpu host -smp 6,sockets=1,cores=6,threads=1 -bios /usr/share/qemu/bios.bin -vga none -device ioh3420,bus=pcie.0,addr=1c.0,multifunction=on,port=1,chassis=1,id=root.1 -device vfio-pci,host=01:00.0,bus=root.1,addr=00.0,multifunction=on,x-vga=on -device vfio-pci,host=01:00.1,bus=root.1,addr=00.1<br />qemu-system-x86_64: -device vfio-pci,host=01:00.0,bus=root.1,addr=00.0,multifunction=on,x-vga=on: vfio: No available IOMMU models<br />qemu-system-x86_64: -device vfio-pci,host=01:00.0,bus=root.1,addr=00.0,multifunction=on,x-vga=on: vfio: failed to setup container for group 18<br />qemu-system-x86_64: -device vfio-pci,host=01:00.0,bus=root.1,addr=00.0,multifunction=on,x-vga=on: vfio: failed to get group 18<br />qemu-system-x86_64: -device vfio-pci,host=01:00.0,bus=root.1,addr=00.0,multifunction=on,x-vga=on: Device initialization failed.<br />qemu-system-x86_64: -device vfio-pci,host=01:00.0,bus=root.1,addr=00.0,multifunction=on,x-vga=on: Device &#039;vfio-pci&#039; could not be initialized</p><p>Group 18 beeing the R9 290:<br />### Group 18 ###<br />&#160; &#160; 01:00.0 VGA compatible controller: Advanced Micro Devices, Inc. [AMD/ATI] Hawaii PRO<br />&#160; &#160; 01:00.1 Audio device: Advanced Micro Devices, Inc. [AMD/ATI] Device aac8</p><p>I&#039;ve compiled the kernel without changing the config. Should I enable the VFIO config settings or is that not necessary with the patches?</p></div></blockquote></div> <p class="postedit"><em>Last edited by pascal257 (2014-01-02 02:57:09)</em></p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1366134">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1366206" class="blockpost rowodd"> <h2><span><span class="conr">#961</span> <a href="viewtopic.php?pid=1366206#p1366206">2014-01-02 09:54:39</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=48315">TripleSpeeder</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2011-05-02</span></dd> <dd><span>Posts: 43</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=48315">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>nbhs wrote:</cite><blockquote><div><p><strong> AUDIO EMULATION:</strong> </p><p>To hear the sound from the vm on your host speakers you&#039;ll need to add this lines:</p><div class="codebox"><pre><code>-device ich9-intel-hda,bus=pcie.0,addr=1b.0,id=sound0 \ -device hda-duplex,id=sound0-codec0,bus=sound0.0,cad=0 </code></pre></div><p>You might need to start qemu like this (using pulseaudio, to use a different driver change QEMU_AUDIO_DRV= variable):</p><div class="codebox"><pre><code>QEMU_PA_SAMPLES=128 QEMU_AUDIO_DRV=pa qemu-system-x86_64...</code></pre></div></div></blockquote></div><p>With QEMU_PA_SAMPLES=128 the sound is horribly distorted here. Without this parameter it works fine though. @Op: What is the background of this setting?</p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1366206">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1366241" class="blockpost roweven"> <h2><span><span class="conr">#962</span> <a href="viewtopic.php?pid=1366241#p1366241">2014-01-02 13:07:22</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=73593">BulliteShot</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2013-07-28</span></dd> <dd><span>Posts: 26</span></dd> <dd class="usercontacts"><span class="email"><a href="mailto:josh@servebyte.com">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <p>Edit: Nevermind. I can&#039;t re-produce the problem.</p><p>With that patched kernel to stop the memory leak I can confirm it works unless I use hugetlbfs. Using hugetlbfs causes the memory leak again.</p> <p class="postedit"><em>Last edited by BulliteShot (2014-01-05 01:42:10)</em></p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1366241">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1366285" class="blockpost rowodd"> <h2><span><span class="conr">#963</span> <a href="viewtopic.php?pid=1366285#p1366285">2014-01-02 16:09:47</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=70922">nbhs</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd class="postavatar"><img src="https://bbs.archlinux.org/img/avatars/70922.jpg?m=1367773811" width="80" height="80" alt="" /></dd> <dd><span>From: Montevideo, Uruguay</span></dd> <dd><span>Registered: 2013-05-02</span></dd> <dd><span>Posts: 402</span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>TripleSpeeder wrote:</cite><blockquote><div><div class="quotebox"><cite>nbhs wrote:</cite><blockquote><div><p><strong> AUDIO EMULATION:</strong> </p><p>To hear the sound from the vm on your host speakers you&#039;ll need to add this lines:</p><div class="codebox"><pre><code>-device ich9-intel-hda,bus=pcie.0,addr=1b.0,id=sound0 \ -device hda-duplex,id=sound0-codec0,bus=sound0.0,cad=0 </code></pre></div><p>You might need to start qemu like this (using pulseaudio, to use a different driver change QEMU_AUDIO_DRV= variable):</p><div class="codebox"><pre><code>QEMU_PA_SAMPLES=128 QEMU_AUDIO_DRV=pa qemu-system-x86_64...</code></pre></div></div></blockquote></div><p>With QEMU_PA_SAMPLES=128 the sound is horribly distorted here. Without this parameter it works fine though. @Op: What is the background of this setting?</p></div></blockquote></div><p>Trial and error, im using alsa now instead of pulse now though</p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1366285">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1366473" class="blockpost roweven"> <h2><span><span class="conr">#964</span> <a href="viewtopic.php?pid=1366473#p1366473">2014-01-03 04:13:52</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=78217">DanaGoyette</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2014-01-03</span></dd> <dd><span>Posts: 46</span></dd> <dd class="usercontacts"><span class="email"><a href="mailto:danagoyette@gmail.com">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <p>EDIT: Upgrading qemu to the git version may have fixed this odd behavior -- but I still wonder how it was possible...<br />EDIT again: Nope, still broken -- it was the power cycle that made it work once.</p><p>Original post:</p><p>I&#039;ve managed to get GPU passthrough to &quot;work&quot; on my system, but the behavior is quite odd.</p><p>Upon initial driver installation, the Radeon showed the desktop properly.<br />Unfortunately, at every guest boot thereafter (even after host reboot), the desktop starts with only the cursor visible.</p><p>If I start Narrator (win-R, &#039;narrator&#039;), I can navigate the desktop blindly, and it seems like the desktop is working &quot;perfectly&quot;.</p><p>Hardware: <br />* Xeon E3-1245v3<br />* SuperMicro X10SAT<br />* XFX HD 5750<br />* Asus Xonar DX (with EEPROM tweaked to call it a Xonar D1).<br />Video card was grabbed from e-waste pile at work; unknown condition, but works quite well in Windows native boot.</p><p>Software:<br />* Ubuntu 13.10<br />* Qemu 1.7.0 (Debian 1.7.0+dfsg-2ubuntu3)<br />* Kernel 3.13 + acs-override patch (set to IDs of Intel root ports).&#160; <br />* Guest is Windows 8.1, 64-bit.&#160; (Video drivers won&#039;t load with Windows 7.)</p><p>Extra notes:<br />* VM behaves approximately the same both in Q35 mode and in PIIX4 mode (two different VMs, same virtual disk).<br />* Host is booted in EFI boot mode, using Intel graphics.&#160; This hopefully helps avoid some Intel VGA register usage.<br />* Guest is given GPU via VFIO, but primary VGA is Cirrus.<br />* I&#039;d use EFI mode for the guest if I had a supporting video card, and if qemu didn&#039;t hang when attempting EFI mode...</p><p>The group I&#039;m passing through is Group 1.&#160; <br />I tweaked &#039;lsgroup.sh&#039; to use lspci -nn (names and numbers) instead of just lspci:</p><div class="codebox"><pre class="vscroll"><code>### Group 0 ### 00:00.0 Host bridge: Intel Corporation Xeon E3-1200 v3 Processor DRAM Controller (rev 06) ### Group 1 ### 00:01.0 PCI bridge: Intel Corporation Xeon E3-1200 v3/4th Gen Core Processor PCI Express x16 Controller (rev 06) 00:01.1 PCI bridge: Intel Corporation Xeon E3-1200 v3/4th Gen Core Processor PCI Express x8 Controller (rev 06) 01:00.0 VGA compatible controller: Advanced Micro Devices, Inc. [AMD/ATI] Juniper PRO [Radeon HD 5750] 01:00.1 Audio device: Advanced Micro Devices, Inc. [AMD/ATI] Juniper HDMI Audio [Radeon HD 5700 Series] 02:00.0 PCI bridge: PLX Technology, Inc. PEX8112 x1 Lane PCI Express-to-PCI Bridge (rev aa) 03:04.0 Multimedia audio controller: C-Media Electronics Inc CMI8788 [Oxygen HD Audio] ### Group 2 ### 00:02.0 VGA compatible controller: Intel Corporation Xeon E3-1200 v3 Processor Integrated Graphics Controller (rev 06) ### Group 3 ### 00:03.0 Audio device: Intel Corporation Xeon E3-1200 v3/4th Gen Core Processor HD Audio Controller (rev 06) ### Group 4 ### 00:14.0 USB controller: Intel Corporation 8 Series/C220 Series Chipset Family USB xHCI (rev 05) ### Group 5 ### 00:16.0 Communication controller: Intel Corporation 8 Series/C220 Series Chipset Family MEI Controller #1 (rev 04) 00:16.3 Serial controller: Intel Corporation 8 Series/C220 Series Chipset Family KT Controller (rev 04) ### Group 6 ### 00:19.0 Ethernet controller: Intel Corporation Ethernet Connection I217-LM (rev 05) ### Group 8 ### 00:1b.0 Audio device: Intel Corporation 8 Series/C220 Series Chipset High Definition Audio Controller (rev 05) ### Group 9 ### 00:1c.0 PCI bridge: Intel Corporation 8 Series/C220 Series Chipset Family PCI Express Root Port #1 (rev d5) ### Group 10 ### 00:1c.1 PCI bridge: Intel Corporation 8 Series/C220 Series Chipset Family PCI Express Root Port #2 (rev d5) 05:00.0 PCI bridge: PLX Technology, Inc. PEX 8606 6 Lane, 6 Port PCI Express Gen 2 (5.0 GT/s) Switch (rev ba) 06:01.0 PCI bridge: PLX Technology, Inc. PEX 8606 6 Lane, 6 Port PCI Express Gen 2 (5.0 GT/s) Switch (rev ba) 06:04.0 PCI bridge: PLX Technology, Inc. PEX 8606 6 Lane, 6 Port PCI Express Gen 2 (5.0 GT/s) Switch (rev ba) 06:05.0 PCI bridge: PLX Technology, Inc. PEX 8606 6 Lane, 6 Port PCI Express Gen 2 (5.0 GT/s) Switch (rev ba) 06:07.0 PCI bridge: PLX Technology, Inc. PEX 8606 6 Lane, 6 Port PCI Express Gen 2 (5.0 GT/s) Switch (rev ba) 06:09.0 PCI bridge: PLX Technology, Inc. PEX 8606 6 Lane, 6 Port PCI Express Gen 2 (5.0 GT/s) Switch (rev ba) 0a:00.0 USB controller: Renesas Technology Corp. uPD720201 USB 3.0 Host Controller (rev 03) 0b:00.0 PCI bridge: Texas Instruments XIO2213A/B/XIO2221 PCI Express to PCI Bridge [Cheetah Express] (rev 01) 0c:00.0 FireWire (IEEE 1394): Texas Instruments XIO2213A/B/XIO2221 IEEE-1394b OHCI Controller [Cheetah Express] (rev 01) ### Group 11 ### 00:1c.3 PCI bridge: Intel Corporation 8 Series/C220 Series Chipset Family PCI Express Root Port #4 (rev d5) ### Group 12 ### 00:1c.4 PCI bridge: Intel Corporation 8 Series/C220 Series Chipset Family PCI Express Root Port #5 (rev d5) ### Group 13 ### 00:1d.0 USB controller: Intel Corporation 8 Series/C220 Series Chipset Family USB EHCI #1 (rev 05) ### Group 14 ### 00:1f.0 ISA bridge: Intel Corporation C226 Series Chipset Family Server Advanced SKU LPC Controller (rev 05) 00:1f.2 SATA controller: Intel Corporation 8 Series/C220 Series Chipset Family 6-port SATA Controller 1 [AHCI mode] (rev 05) 00:1f.3 SMBus: Intel Corporation 8 Series/C220 Series Chipset Family SMBus Controller (rev 05) 00:1f.6 Signal processing controller: Intel Corporation 8 Series Chipset Family Thermal Management Controller (rev 05) ### Group 15 ### 04:00.0 SATA controller: ASMedia Technology Inc. ASM1062 Serial ATA Controller (rev 01) ### Group 16 ### 0d:00.0 Ethernet controller: Intel Corporation I210 Gigabit Network Connection (rev 03) root@server-linux:~# nano -w lsgroup.sh root@server-linux:~# ./lsgroup.sh ### Group 0 ### 00:00.0 Host bridge [0600]: Intel Corporation Xeon E3-1200 v3 Processor DRAM Controller [8086:0c08] (rev 06) ### Group 1 ### 00:01.0 PCI bridge [0604]: Intel Corporation Xeon E3-1200 v3/4th Gen Core Processor PCI Express x16 Controller [8086:0c01] (rev 06) 00:01.1 PCI bridge [0604]: Intel Corporation Xeon E3-1200 v3/4th Gen Core Processor PCI Express x8 Controller [8086:0c05] (rev 06) 01:00.0 VGA compatible controller [0300]: Advanced Micro Devices, Inc. [AMD/ATI] Juniper PRO [Radeon HD 5750] [1002:68be] 01:00.1 Audio device [0403]: Advanced Micro Devices, Inc. [AMD/ATI] Juniper HDMI Audio [Radeon HD 5700 Series] [1002:aa58] 02:00.0 PCI bridge [0604]: PLX Technology, Inc. PEX8112 x1 Lane PCI Express-to-PCI Bridge [10b5:8112] (rev aa) 03:04.0 Multimedia audio controller [0401]: C-Media Electronics Inc CMI8788 [Oxygen HD Audio] [13f6:8788] ### Group 2 ### 00:02.0 VGA compatible controller [0300]: Intel Corporation Xeon E3-1200 v3 Processor Integrated Graphics Controller [8086:041a] (rev 06) ### Group 3 ### 00:03.0 Audio device [0403]: Intel Corporation Xeon E3-1200 v3/4th Gen Core Processor HD Audio Controller [8086:0c0c] (rev 06) ### Group 4 ### 00:14.0 USB controller [0c03]: Intel Corporation 8 Series/C220 Series Chipset Family USB xHCI [8086:8c31] (rev 05) ### Group 5 ### 00:16.0 Communication controller [0780]: Intel Corporation 8 Series/C220 Series Chipset Family MEI Controller #1 [8086:8c3a] (rev 04) 00:16.3 Serial controller [0700]: Intel Corporation 8 Series/C220 Series Chipset Family KT Controller [8086:8c3d] (rev 04) ### Group 6 ### 00:19.0 Ethernet controller [0200]: Intel Corporation Ethernet Connection I217-LM [8086:153a] (rev 05) ### Group 8 ### 00:1b.0 Audio device [0403]: Intel Corporation 8 Series/C220 Series Chipset High Definition Audio Controller [8086:8c20] (rev 05) ### Group 9 ### 00:1c.0 PCI bridge [0604]: Intel Corporation 8 Series/C220 Series Chipset Family PCI Express Root Port #1 [8086:8c10] (rev d5) ### Group 10 ### 00:1c.1 PCI bridge [0604]: Intel Corporation 8 Series/C220 Series Chipset Family PCI Express Root Port #2 [8086:8c12] (rev d5) 05:00.0 PCI bridge [0604]: PLX Technology, Inc. PEX 8606 6 Lane, 6 Port PCI Express Gen 2 (5.0 GT/s) Switch [10b5:8606] (rev ba) 06:01.0 PCI bridge [0604]: PLX Technology, Inc. PEX 8606 6 Lane, 6 Port PCI Express Gen 2 (5.0 GT/s) Switch [10b5:8606] (rev ba) 06:04.0 PCI bridge [0604]: PLX Technology, Inc. PEX 8606 6 Lane, 6 Port PCI Express Gen 2 (5.0 GT/s) Switch [10b5:8606] (rev ba) 06:05.0 PCI bridge [0604]: PLX Technology, Inc. PEX 8606 6 Lane, 6 Port PCI Express Gen 2 (5.0 GT/s) Switch [10b5:8606] (rev ba) 06:07.0 PCI bridge [0604]: PLX Technology, Inc. PEX 8606 6 Lane, 6 Port PCI Express Gen 2 (5.0 GT/s) Switch [10b5:8606] (rev ba) 06:09.0 PCI bridge [0604]: PLX Technology, Inc. PEX 8606 6 Lane, 6 Port PCI Express Gen 2 (5.0 GT/s) Switch [10b5:8606] (rev ba) 0a:00.0 USB controller [0c03]: Renesas Technology Corp. uPD720201 USB 3.0 Host Controller [1912:0014] (rev 03) 0b:00.0 PCI bridge [0604]: Texas Instruments XIO2213A/B/XIO2221 PCI Express to PCI Bridge [Cheetah Express] [104c:823e] (rev 01) 0c:00.0 FireWire (IEEE 1394) [0c00]: Texas Instruments XIO2213A/B/XIO2221 IEEE-1394b OHCI Controller [Cheetah Express] [104c:823f] (rev 01) ### Group 11 ### 00:1c.3 PCI bridge [0604]: Intel Corporation 8 Series/C220 Series Chipset Family PCI Express Root Port #4 [8086:8c16] (rev d5) ### Group 12 ### 00:1c.4 PCI bridge [0604]: Intel Corporation 8 Series/C220 Series Chipset Family PCI Express Root Port #5 [8086:8c18] (rev d5) ### Group 13 ### 00:1d.0 USB controller [0c03]: Intel Corporation 8 Series/C220 Series Chipset Family USB EHCI #1 [8086:8c26] (rev 05) ### Group 14 ### 00:1f.0 ISA bridge [0601]: Intel Corporation C226 Series Chipset Family Server Advanced SKU LPC Controller [8086:8c56] (rev 05) 00:1f.2 SATA controller [0106]: Intel Corporation 8 Series/C220 Series Chipset Family 6-port SATA Controller 1 [AHCI mode] [8086:8c02] (rev 05) 00:1f.3 SMBus [0c05]: Intel Corporation 8 Series/C220 Series Chipset Family SMBus Controller [8086:8c22] (rev 05) 00:1f.6 Signal processing controller [1180]: Intel Corporation 8 Series Chipset Family Thermal Management Controller [8086:8c24] (rev 05) ### Group 15 ### 04:00.0 SATA controller [0106]: ASMedia Technology Inc. ASM1062 Serial ATA Controller [1b21:0612] (rev 01) ### Group 16 ### 0d:00.0 Ethernet controller [0200]: Intel Corporation I210 Gigabit Network Connection [8086:1533] (rev 03)</code></pre></div> <p class="postedit"><em>Last edited by DanaGoyette (2014-01-03 04:42:09)</em></p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1366473">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1366500" class="blockpost rowodd"> <h2><span><span class="conr">#965</span> <a href="viewtopic.php?pid=1366500#p1366500">2014-01-03 07:57:35</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=78222">ayc</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2014-01-03</span></dd> <dd><span>Posts: 2</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=78222">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <p>I have VGA pass-through of an ATI card working fine. For another VM I&#039;m trying to pass through an Intel C606 SAS/SATA controller which isn&#039;t going very well.</p><p>1) pci-stub grabs the controller on boot and vfio binds to it<br />2) pci-assign passthrough to an Ubuntu Linux works fine<br />3) vfio-pci to the same Ubuntu Linux fails with I/O errors from the driver<br />4) device in the guest is bound to a ioh3420 bridge in qemu<br />5) Neither pci-assign nor vfio-pci work under FreeBSD, which is the eventual goal for this VM</p><p>The device has FLR, so I think should work fine. From the host:</p><div class="codebox"><pre><code>[root@vs ~]# lspci -vvvs 03:00.0 03:00.0 Serial Attached SCSI controller: Intel Corporation C606 chipset Dual 4-Port SATA/SAS Storage Control Unit (rev 06) Subsystem: Super Micro Computer Inc Device 0630 Control: I/O+ Mem+ BusMaster+ SpecCycle- MemWINV- VGASnoop- ParErr- Stepping- SERR+ FastB2B- DisINTx+ Status: Cap+ 66MHz- UDF- FastB2B- ParErr- DEVSEL=fast &gt;TAbort- &lt;TAbort- &lt;MAbort- &gt;SERR- &lt;PERR- INTx- Latency: 0, Cache Line Size: 64 bytes Interrupt: pin A routed to IRQ 26 Region 0: Memory at d18f8000 (64-bit, prefetchable) [size=32K] Region 2: Memory at d1000000 (64-bit, prefetchable) [size=8M] Region 4: I/O ports at 8100 [size=256] Region 5: I/O ports at 8000 [size=256] Capabilities: [98] Power Management version 3 Flags: PMEClk- DSI- D1- D2- AuxCurrent=0mA PME(D0-,D1-,D2-,D3hot-,D3cold-) Status: D0 NoSoftRst+ PME-Enable- DSel=0 DScale=0 PME- Capabilities: [c4] Express (v2) Endpoint, MSI 00 DevCap: MaxPayload 1024 bytes, PhantFunc 0, Latency L0s unlimited, L1 unlimited ExtTag+ AttnBtn- AttnInd- PwrInd- RBE+ FLReset+ [snip]</code></pre></div><p>In looking at the differences between dmesg on pci-assign vs vfio-pci, there&#039;s this when<br />using vfio.</p><div class="codebox"><pre><code>pci 0000:01:00.0: no compatible bridge window for [mem 0xd1800000-0xe0ffffff 64bit pref</code></pre></div><p>and later on</p><div class="codebox"><pre><code>PCI: max bus depth: 1 pci_try_num: 2 pci 0000:01:00.0: reg 164: [mem 0xd1800000-0xd1ffffff 64bit pref pci 0000:00:1c.0: BAR 14: assigned [mem 0xc0000000-0xcf7fffff pci 0000:01:00.0: reg 164: [mem 0xd1800000-0xd1ffffff 64bit pref pci 0000:01:00.0: reg 164: [mem 0xd1800000-0xd1ffffff 64bit pref pci 0000:01:00.0: BAR 7: assigned [mem 0xc0000000-0xcf7fffff 64bit pref pci 0000:01:00.0: BAR 7: error updating (0xc000000c != 0xd180000c) pci 0000:00:1c.0: PCI bridge to [bus 01-01 pci 0000:00:1c.0: bridge window [io 0xc000-0xcfff pci 0000:00:1c.0: bridge window [mem 0xc0000000-0xcf7fffff pci 0000:00:1c.0: bridge window [mem 0xfc000000-0xfcffffff 64bit pref pci_bus 0000:00: resource 4 [io 0x0000-0x0cf7 pci_bus 0000:00: resource 5 [io 0x0d00-0xffff pci_bus 0000:00: resource 6 [mem 0x000a0000-0x000bffff pci_bus 0000:00: resource 7 [mem 0xc0000000-0xfebfffff pci_bus 0000:01: resource 0 [io 0xc000-0xcfff pci_bus 0000:01: resource 1 [mem 0xc0000000-0xcf7fffff pci_bus 0000:01: resource 2 [mem 0xfc000000-0xfcffffff 64bit pref</code></pre></div><p>vs doing a pci_assign:</p><div class="codebox"><pre><code>pci 0000:00:1c.0: bridge window [mem 0x00100000-0x000fffff pci 0000:00:1c.0: res[14 pci 0000:00:1c.0: BAR 14: assigned [mem 0xc0000000-0xc03fffff pci 0000:00:1c.0: PCI bridge to [bus 01-01 pci 0000:00:1c.0: bridge window [io 0xc000-0xcfff Freeing initrd memory: 15736k freed pci 0000:00:1c.0: bridge window [mem 0xc0000000-0xc03fffff pci 0000:00:1c.0: bridge window [mem 0xfc000000-0xfcffffff 64bit pref pci_bus 0000:00: resource 4 [io 0x0000-0x0cf7 pci_bus 0000:00: resource 5 [io 0x0d00-0xffff pci_bus 0000:00: resource 6 [mem 0x000a0000-0x000bffff pci_bus 0000:00: resource 7 [mem 0xc0000000-0xfebfffff pci_bus 0000:01: resource 0 [io 0xc000-0xcfff pci_bus 0000:01: resource 1 [mem 0xc0000000-0xc03fffff pci_bus 0000:01: resource 2 [mem 0xfc000000-0xfcffffff 64bit pref</code></pre></div><p>When I don&#039;t put this behind a bridge, the only difference is that when using vfio, I get this extra line:</p><div class="codebox"><pre><code> pci 0000:00:02.0: reg 164: [mem 0xd1800000-0xd1ffffff 64bit pref</code></pre></div><p>which is not in there when using pci-assign. </p><p>Any thoughts on further debugging this?</p><p>&#160; &#160;...alan</p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1366500">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1366750" class="blockpost roweven"> <h2><span><span class="conr">#966</span> <a href="viewtopic.php?pid=1366750#p1366750">2014-01-03 19:18:46</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=77789">syllopsium</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2013-12-18</span></dd> <dd><span>Posts: 4</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=77789">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <p>What&#039;s the parent device for the C606 SAS controller on the host? Looking at the chipset diagram it seems to be hanging directly off the IOH?</p><p>It may be obvious, but have you tried passing through the controller without specifying the point to hang it off? i.e. device=vfiio-pci,host=nn:nn.n,id=&lt;friendlyname&gt;</p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1366750">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1366788" class="blockpost rowodd"> <h2><span><span class="conr">#967</span> <a href="viewtopic.php?pid=1366788#p1366788">2014-01-03 20:43:37</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=78222">ayc</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2014-01-03</span></dd> <dd><span>Posts: 2</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=78222">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>syllopsium wrote:</cite><blockquote><div><p>What&#039;s the parent device for the C606 SAS controller on the host? Looking at the chipset diagram it seems to be hanging directly off the IOH?</p></div></blockquote></div><p>It&#039;s a bit weird. From Intel&#039;s data sheet:</p><div class="codebox"><pre><code>The Intel® C606, C608 Chipset SKUs contain a PCI Express* switch. The Intel® C606, C608 Chipset SKUs contains a x4 uplink and a “virtual” switch port that serves as the connection for the integrated MFD shown in Figure 5-2. Software will discover a virtual switch port with an attached multi-function end point device. The PCI Express* switch is compliant to the PCI Express Base specification 2.0.</code></pre></div><p>and earlier it gives a rationale as to why they&#039;re doing this:</p><div class="codebox"><pre><code>The purpose of the uplink port is to provide a direct path for the SAS controllers, SGPIO used by the SAS controllers, and SMBus ports to the processor/ memory without having to be multiplexed onto the DMI bus and sharing bandwidth with the rest of the component. The uplink port is not connected to the downstream root ports</code></pre></div><p>lspci gives:</p><div class="codebox"><pre><code> +-01.0-[01-03]----00.0-[02-03]----08.0-[03]----00.0 Intel Corporation C606 chipset Dual 4-Port SATA/SAS Storage Control Unit</code></pre></div><p>so, it&#039;s the 0000:03:00 device that i&#039;m passing through. this is not a straight-forward device passthrough, so i&#039;m not too surprised i&#039;m having troubles with it. </p><div class="quotebox"><blockquote><div><p>It may be obvious, but have you tried passing through the controller without specifying the point to hang it off? i.e. device=vfiio-pci,host=nn:nn.n,id=&lt;friendlyname&gt;</p></div></blockquote></div><p>yes, no go.</p><p>Forgot to say, just upgraded to the mainline from the first post, kernel 3.13-rc5.</p><p>&#160; &#160;...alan</p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1366788">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1367003" class="blockpost roweven"> <h2><span><span class="conr">#968</span> <a href="viewtopic.php?pid=1367003#p1367003">2014-01-04 08:05:13</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=48315">TripleSpeeder</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2011-05-02</span></dd> <dd><span>Posts: 43</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=48315">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <p>@xani: Do you know exactly the root cause of the memory leak and how you fixed it in your kernel? Or are you unsure on the exact reason? It would be awesome if we get this fixed also in the main kernel sources :-) Or are you already in contact with kernel devs about this topic?</p> <p class="postedit"><em>Last edited by TripleSpeeder (2014-01-04 08:05:28)</em></p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1367003">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1367004" class="blockpost rowodd"> <h2><span><span class="conr">#969</span> <a href="viewtopic.php?pid=1367004#p1367004">2014-01-04 08:09:30</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=77080">sbd</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2013-11-21</span></dd> <dd><span>Posts: 4</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=77080">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>DanaGoyette wrote:</cite><blockquote><div><p>Upon initial driver installation, the Radeon showed the desktop properly.<br />Unfortunately, at every guest boot thereafter (even after host reboot), the desktop starts with only the cursor visible.</p><p>If I start Narrator (win-R, &#039;narrator&#039;), I can navigate the desktop blindly, and it seems like the desktop is working &quot;perfectly&quot;.</p></div></blockquote></div><p>Probably because you have the Cirrus VGA card as the primary. That&#039;s being treated as the primary monitor, so all the desktop content is showing up there and not on the Radeon.</p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1367004">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1367044" class="blockpost roweven"> <h2><span><span class="conr">#970</span> <a href="viewtopic.php?pid=1367044#p1367044">2014-01-04 10:40:22</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=77556">peaquino</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2013-12-09</span></dd> <dd><span>Posts: 5</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=77556">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <p>I&#039;d like to report sucess with my Radeon passthrough! It works flawlessly, but only on a second guest launch. </p><p>On first launch after I get screen corruption on any 3D operation in guest (even showing a search box in Chrome) and the guest becomes unusable with constant driver resets to a point, when it grinds to a halt. At that moment I get about ~1K of log entries similar to</p><div class="codebox"><pre><code>sty 04 11:12:57 miner kernel: AMD-Vi: Event logged [IO_PAGE_FAULT device=01:00.0 domain=0x0002 address=0x000000007bc4c100 flags=0x0010] sty 04 11:12:57 miner kernel: AMD-Vi: Event logged [IO_PAGE_FAULT device=01:00.0 domain=0x0002 </code></pre></div><p>When I abort first launch of the quest with a monitor quit command during during guest BIOS initialisation, on a second launch I get the following errors in Qemu monitor:</p><div class="codebox"><pre><code>qemu-system-x86_64: vfio_dma_map(0x7f4b93fbbd40, 0x0, 0xb0000000, 0x2aaac0000000) = -16 (Device or resource busy) qemu-system-x86_64: vfio_dma_map(0x7f4b93fbbd40, 0xc0000, 0xaff40000, 0x2aaac00c0000) = -16 (Device or resource busy) qemu-system-x86_64: vfio_dma_map(0x7f4b93fbbd40, 0xc8000, 0xaff38000, 0x2aaac00c8000) = -16 (Device or resource busy) qemu-system-x86_64: vfio_dma_map(0x7f4b93fbbd40, 0xd0000, 0xaff30000, 0x2aaac00d0000) = -16 (Device or resource busy) </code></pre></div><p>and the following entries in the kernel log</p><div class="codebox"><pre><code>sty 01 22:04:53 miner kernel: vfio_ecap_init: 0000:01:00.0 hiding ecap 0x1b@0x2d0 sty 01 22:04:55 miner kernel: ------------[ cut here ]------------ sty 01 22:04:55 miner kernel: WARNING: CPU: 3 PID: 1012 at drivers/vfio/vfio_iommu_type1.c:685 vfio_dma_do_map+0x43c/0x838 [vfio_iommu_type1]() sty 01 22:04:55 miner kernel: Modules linked in: tun bridge stp llc bnep vfio_pci vfio_iommu_type1 vfio fuse ts2020 ds3000 dvb_usb_dw2102 kvm_amd kvm crc32_pclmul c...luetooth rc_ sty 01 22:04:55 miner kernel: CPU: 3 PID: 1012 Comm: qemu-system-x86 Not tainted 3.13.0-2-mainline #1 sty 01 22:04:55 miner kernel: Hardware name: To Be Filled By O.E.M. To Be Filled By O.E.M./FM2A85X Extreme6, BIOS P2.30 07/11/2013 sty 01 22:04:55 miner kernel: 0000000000000009 ffff8804311b9d20 ffffffff814ddc72 0000000000000000 sty 01 22:04:55 miner kernel: ffff8804311b9d58 ffffffff8105f2ed 00000000fffffff0 00000000b0000000 sty 01 22:04:55 miner kernel: 00000000000b0000 00000000b0000000 0000000000000000 ffff8804311b9d68 sty 01 22:04:55 miner kernel: Call Trace: sty 01 22:04:55 miner kernel: [&lt;ffffffff814ddc72&gt;] dump_stack+0x4d/0x6f sty 01 22:04:55 miner kernel: [&lt;ffffffff8105f2ed&gt;] warn_slowpath_common+0x7d/0xa0 sty 01 22:04:55 miner kernel: [&lt;ffffffff8105f3ca&gt;] warn_slowpath_null+0x1a/0x20 sty 01 22:04:55 miner kernel: [&lt;ffffffffa0ce9dec&gt;] vfio_dma_do_map+0x43c/0x838 [vfio_iommu_type1] sty 01 22:04:55 miner kernel: [&lt;ffffffffa0cea3f9&gt;] vfio_iommu_type1_ioctl+0x211/0x288 [vfio_iommu_type1] sty 01 22:04:55 miner kernel: [&lt;ffffffffa0ce0e28&gt;] vfio_fops_unl_ioctl+0x78/0x340 [vfio] sty 01 22:04:55 miner kernel: [&lt;ffffffff811adfb8&gt;] do_vfs_ioctl+0x2d8/0x4b0 sty 01 22:04:55 miner kernel: [&lt;ffffffff811ae211&gt;] SyS_ioctl+0x81/0xa0 sty 01 22:04:55 miner kernel: [&lt;ffffffff814ebd2d&gt;] system_call_fastpath+0x1a/0x1f sty 01 22:04:55 miner kernel: ---[ end trace 53ac540a2e8783dc ]--- sty 01 22:04:56 miner kernel: ------------[ cut here ]------------ </code></pre></div><p>but the guest works flawlessly (even with reboots) with Catalyst drivers (Steam games work as expected).</p><p>Currently I&#039;m using qemu-git package from AUR and linux-mainline from first page of this thread.</p><p>I hope this helps people struggling with Radeon passthrough.</p><p>Here is a link to a Qemu bug report: <a href="https://bugs.launchpad.net/qemu/+bug/1265998" rel="nofollow">https://bugs.launchpad.net/qemu/+bug/1265998</a></p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1367044">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1367170" class="blockpost rowodd"> <h2><span><span class="conr">#971</span> <a href="viewtopic.php?pid=1367170#p1367170">2014-01-04 18:22:33</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=78265">MCon</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2014-01-04</span></dd> <dd><span>Posts: 1</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=78265">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <p>I&#039;m actually trying to follo this nice guide on a Debian Wheezy install.<br />I rebuilt a custom kernel:</p><div class="codebox"><pre><code>$ uname -a Linux black 3.13.0-rc6-customkernel #2 SMP Sat Jan 4 16:21:06 CET 2014 x86_64 GNU/Linux</code></pre></div><p>VIRTIO is currently compiled into the kernel (no modules).</p><p>I also compiled qemu-git (NOT using Your scripts, obviously tied to ArchLinux, but a &quot;normal&quot; .configure -&gt; make -&gt; sudo make install cycle; here may be the problem!) and openqrm-community (again with plain make -&gt; sudo make install).</p><p>Launching qemu-system-x86_64 ... (it&#039;s in a script) I see:</p><div class="codebox"><pre><code>$ sudo ./start VNC server running on `::1:5900&#039;</code></pre></div><p>Nothing happens on the GTX770 monitor and connecting to VNC I see:</p><div class="codebox"><pre><code>compat_monitor0 console QEMU 1.7.50 monitor - type &#039;help&#039; for more information (qemu)</code></pre></div><p>Before I send my whole config is there something I should cross-check?<br />I&#039;m pretty sure I gooofed somewhere badly.</p><p>Here comes config:</p><div class="codebox"><pre class="vscroll"><code>$ lspci 00:00.0 Host bridge: Intel Corporation Haswell DRAM Controller (rev 06) 00:01.0 PCI bridge: Intel Corporation Haswell PCI Express x16 Controller (rev 06) 00:01.1 PCI bridge: Intel Corporation Haswell PCI Express x8 Controller (rev 06) 00:02.0 VGA compatible controller: Intel Corporation Haswell Integrated Graphics Controller (rev 06) 00:03.0 Audio device: Intel Corporation Haswell HD Audio Controller (rev 06) 00:14.0 USB controller: Intel Corporation Lynx Point USB xHCI Host Controller (rev 04) 00:16.0 Communication controller: Intel Corporation Lynx Point MEI Controller #1 (rev 04) 00:19.0 Ethernet controller: Intel Corporation Ethernet Connection I217-V (rev 04) 00:1a.0 USB controller: Intel Corporation Lynx Point USB Enhanced Host Controller #2 (rev 04) 00:1b.0 Audio device: Intel Corporation Lynx Point High Definition Audio Controller (rev 04) 00:1c.0 PCI bridge: Intel Corporation Lynx Point PCI Express Root Port #1 (rev d4) 00:1c.1 PCI bridge: Intel Corporation Lynx Point PCI Express Root Port #2 (rev d4) 00:1c.5 PCI bridge: Intel Corporation Lynx Point PCI Express Root Port #6 (rev d4) 00:1d.0 USB controller: Intel Corporation Lynx Point USB Enhanced Host Controller #1 (rev 04) 00:1f.0 ISA bridge: Intel Corporation Lynx Point LPC Controller (rev 04) 00:1f.2 SATA controller: Intel Corporation Lynx Point 6-port SATA Controller 1 [AHCI mode] (rev 04) 00:1f.3 SMBus: Intel Corporation Lynx Point SMBus Controller (rev 04) 02:00.0 VGA compatible controller: NVIDIA Corporation Device 1184 (rev a1) 02:00.1 Audio device: NVIDIA Corporation GK104 HDMI Audio Controller (rev a1) 04:00.0 Network controller: Atheros Communications Inc. AR9462 Wireless Network Adapter (rev 01) 05:00.0 SATA controller: ASMedia Technology Inc. ASM1062 Serial ATA Controller (rev 01) $ lspci -n | grep ^02 02:00.0 0300: 10de:1184 (rev a1) 02:00.1 0403: 10de:0e0a (rev a1) $ cat bind.sh sudo vfio-bind 0000:02:00.0 0000:02:00.1 $ cat start qemu-system-x86_64 -enable-kvm -M q35 -m 1024 -cpu host \ -smp 4,sockets=1,cores=2,threads=2 \ -bios /usr/local/share/qemu/bios.bin -vga none \ -device ioh3420,bus=pcie.0,addr=1c.0,multifunction=on,port=1,chassis=1,id=root.1 \ -device vfio-pci,host=02:00.0,bus=root.1,addr=00.0,multifunction=on,x-vga=on \ -device vfio-pci,host=02:00.1,bus=root.1,addr=00.1</code></pre></div><p>Thanks in advance<br />Mauro</p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1367170">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1367324" class="blockpost roweven"> <h2><span><span class="conr">#972</span> <a href="viewtopic.php?pid=1367324#p1367324">2014-01-05 01:40:21</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=73593">BulliteShot</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2013-07-28</span></dd> <dd><span>Posts: 26</span></dd> <dd class="usercontacts"><span class="email"><a href="mailto:josh@servebyte.com">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <p>Has anyone got any working packages for pci-stub only? q35 performance is pretty poor for memory demanding games.</p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1367324">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1367350" class="blockpost rowodd"> <h2><span><span class="conr">#973</span> <a href="viewtopic.php?pid=1367350#p1367350">2014-01-05 02:51:46</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=76834">Val532</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2013-11-13</span></dd> <dd><span>Posts: 35</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=76834">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <p>Hi all,</p><p>I have some new information and I do not know who to share.</p><p>The probleme i found for pci passthougr of sata AsMedia 1062 : </p><div class="codebox"><pre><code>[ 404.206866] dmar: DRHD: handling fault status reg 2 [ 404.206870] dmar: DMAR:[DMA Write] Request device [07:00.0] fault addr 2affdf000 [ 404.206870] DMAR:[fault reason 05] PTE Write access is not set [ 404.206877] dmar: DRHD: handling fault status reg 2 [ 404.206879] dmar: DMAR:[DMA Read] Request device [07:00.0] fault addr 2affda000 [ 404.206879] DMAR:[fault reason 06] PTE Read access is not set</code></pre></div><p>Is the same for Intel Z87 sata.</p><p>I can&#039;t use the Intel Sata with vfio because of ACS, ACS patch does not work for Intel Sata [00:1f.2] and when i use with pci_stub it&#039;s work only one time, when the VM reboot i have this error :</p><div class="codebox"><pre><code>[ 1801.280862] dmar: DRHD: handling fault status reg 2 [ 1801.280866] dmar: DMAR:[DMA Read] Request device [00:1f.2] fault addr 2affdd000 [ 1801.280866] DMAR:[fault reason 06] PTE Read access is not set</code></pre></div><p>Where i can report this error in the hope of any boby correct this ?</p><p>Thanks.</p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1367350">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1367378" class="blockpost roweven"> <h2><span><span class="conr">#974</span> <a href="viewtopic.php?pid=1367378#p1367378">2014-01-05 05:21:30</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=78217">DanaGoyette</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2014-01-03</span></dd> <dd><span>Posts: 46</span></dd> <dd class="usercontacts"><span class="email"><a href="mailto:danagoyette@gmail.com">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>Val532 wrote:</cite><blockquote><div><p>I can&#039;t use the Intel Sata with vfio because of ACS, ACS patch does not work for Intel Sata [00:1f.2]...</p></div></blockquote></div><p>If you haven&#039;t already done so, try passing through the other devices in that group, such as:<br />&#160; &#160; 00:1f.0 ISA bridge [0601]: Intel Corporation C226 Series Chipset Family Server Advanced SKU LPC Controller [8086:8c56] (rev 05)<br />&#160; &#160; 00:1f.2 SATA controller [0106]: Intel Corporation 8 Series/C220 Series Chipset Family 6-port SATA Controller 1 [AHCI mode] [8086:8c02] (rev 05)<br />&#160; &#160; 00:1f.3 SMBus [0c05]: Intel Corporation 8 Series/C220 Series Chipset Family SMBus Controller [8086:8c22] (rev 05)<br />&#160; &#160; 00:1f.6 Signal processing controller [1180]: Intel Corporation 8 Series Chipset Family Thermal Management Controller [8086:8c24] (rev 05)</p><p>Alternately, these devices should be overridable via &#039;multifunction&#039;, or better, via device ID (in my case, it&#039;s id:8086:8c02).</p><br /><div class="quotebox"><cite>sbd wrote:</cite><blockquote><div><p>Probably because you have the Cirrus VGA card as the primary. That&#039;s being treated as the primary monitor, so all the desktop content is showing up there and not on the Radeon.</p></div></blockquote></div><p>I actually used Narrator to get the virtual machine&#039;s desktop to appear only on the ATI card, and not at all on the Cirrus.&#160; The ATI desktop was alive and &quot;functional&quot;, but totally black.</p><p>I&#039;ve rebuilt Qemu from git, and now it seems to be defaulting to pci-assign instead of VFIO.&#160; This works fine, aside from needing the &quot;eject&quot; workaround (which kicks the GPU into high-speed-fan mode).<br />In fact, now I&#039;m thinking this may have something to do with that black desktop -- perhaps the black desktop is a result of NOT ejecting.<br />Time for more experimenting...</p><p>EDIT: <br />Okay, I tried switching back to vfio.&#160; No dice:<br />genirq: Flags mismatch irq 16. 00000000 (vfio-intx(0000:01:00.0)) vs. 00000080 (ehci_hcd:usb1)</p><p>Adding the EHCI controller (#2, oddly enough, not #1 as &#039;usb1&#039; would seem to imply), seems to perhaps fix this.</p><p>If I add my sound card to the mix:<br />genirq: Flags mismatch irq 17. 00000000 (vfio-intx(0000:07:04.0)) vs. 00000000 (vfio-intx(0000:01:00.1))</p><p>How the heck is &#039;00000000&#039; a mismatch with &#039;00000000&#039;?</p> <p class="postedit"><em>Last edited by DanaGoyette (2014-01-05 05:58:32)</em></p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1367378">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1367480" class="blockpost rowodd"> <h2><span><span class="conr">#975</span> <a href="viewtopic.php?pid=1367480#p1367480">2014-01-05 13:52:34</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=73864">cataphract</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2013-08-06</span></dd> <dd><span>Posts: 13</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=73864">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <p>I tried this with Linux 3.12.6-1-ARCH, qemu 1.7.0-1 and seabios 1.7.3.1-2 without success.</p><p>I have this motherboard:</p><div class="codebox"><pre><code>[ 0.000000] DMI: Gigabyte Technology Co., Ltd. Z87MX-D3H/Z87MX-D3H-CF, BIOS F5 08/02/2013</code></pre></div><p>a 4770 and Radeon 6950. Main display is connected to the IGP.</p><div class="codebox"><pre><code>$ dmesg | grep pci-stub [ 0.000000] Command line: root=UUID=9dac92cf-60d1-4a6d-b9a4-066bb876c9ce ro intel_iommu=on modprobe.blacklist=radeon pci-stub.ids=1002:6719,1002:aa80 initrd=\initramfs-linux.img [ 0.000000] Kernel command line: root=UUID=9dac92cf-60d1-4a6d-b9a4-066bb876c9ce ro intel_iommu=on modprobe.blacklist=radeon pci-stub.ids=1002:6719,1002:aa80 initrd=\initramfs-linux.img [ 1.289177] pci-stub: add 1002:6719 sub=FFFFFFFF:FFFFFFFF cls=00000000/00000000 [ 1.289193] pci-stub 0000:01:00.0: claimed by stub [ 1.289197] pci-stub: add 1002:AA80 sub=FFFFFFFF:FFFFFFFF cls=00000000/00000000 [ 1.289201] pci-stub 0000:01:00.1: claimed by stub</code></pre></div><p>The vfio-bind also works fine. I then tried this command line to run qemu:</p><div class="codebox"><pre><code>qemu-system-x86_64 \ -enable-kvm \ -m 4096 \ -drive file=win7.qcow2,if=ide \ -drive file=/mnt/evo/Arquivo/Windows7_Pro_SP1_English_x64.iso,if=ide,media=cdrom \ -bios /usr/share/qemu/bios.bin \ -M q35 \ -device ioh3420,bus=pcie.0,addr=1c.0,multifunction=on,port=1,chassis=1,id=root.1 \ -device vfio-pci,host=01:00.0,bus=root.1,addr=00.0,multifunction=on,x-vga=on,romfile=XFX.HD6950.1024.110116_1.rom \ -device vfio-pci,host=01:00.1,addr=0.1,bus=root.1 \ -boot menu=on \ -cpu host \ -smp 3 \ -nographic \ -vga none</code></pre></div><p>but I see nothing on the second display (connected via HDMI).</p><p>For some reason, I cannot boot linux-mainline or the modified linux-mainline posted on the front page. It can&#039;t find the root partition and I&#039;m dropped to a shell where even my usb keyboard doesn&#039;t work. It&#039;s strange because I never had any problem with official kernel. I&#039;m using refind.</p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1367480">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div class="postlinksb"> <div class="inbox crumbsplus"> <div class="pagepost"> <p class="pagelink conl"><span class="pages-label">Pages: </span><a rel="prev" class="item1" href="viewtopic.php?id=162768&amp;p=38">Previous</a> <a href="viewtopic.php?id=162768">1</a> <span class="spacer">…</span> <a href="viewtopic.php?id=162768&amp;p=37">37</a> <a href="viewtopic.php?id=162768&amp;p=38">38</a> <strong>39</strong> <a href="viewtopic.php?id=162768&amp;p=40">40</a> <a href="viewtopic.php?id=162768&amp;p=41">41</a> <span class="spacer">…</span> <a href="viewtopic.php?id=162768&amp;p=234">234</a> <a rel="next" href="viewtopic.php?id=162768&amp;p=40">Next</a></p> <p class="postlink conr">Topic closed</p> </div> <ul class="crumbs"> <li><a href="index.php">Index</a></li> <li><span>»&#160;</span><a href="viewforum.php?id=48">Topics Going Nowhere</a></li> <li><span>»&#160;</span><strong><a href="viewtopic.php?id=162768">KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</a></strong></li> </ul> <p class="subscribelink clearb"><a href="misc.php?action=subscribe&amp;tid=162768">Subscribe to this topic</a></p> <div class="clearer"></div> </div> </div> </div> <div id="brdfooter" class="block"> <h2><span>Board footer</span></h2> <div class="box"> <div id="brdfooternav" class="inbox"> <div class="conl"> <form id="qjump" method="get" action="viewforum.php"> <div><label><span>Jump to<br /></span> <select name="id" onchange="window.location=('viewforum.php?id='+this.options[this.selectedIndex].value)"> <optgroup label="Technical Issues and Assistance"> <option value="23">Newbie Corner</option> <option value="17">Installation</option> <option value="22">Kernel &amp; Hardware</option> <option value="18">Applications &amp; Desktop Environments</option> <option value="31">Laptop Issues</option> <option value="8">Networking, Server, and Protection</option> <option value="32">Multimedia and Games</option> <option value="50">System Administration</option> <option value="35">Other Architectures</option> </optgroup> <optgroup label="Arch-centric"> <option value="24">Announcements, Package &amp; Security Advisories</option> <option value="1">Arch Discussion</option> <option value="13">Forum &amp; Wiki discussion</option> </optgroup> <optgroup label="Pacman Upgrades, Packaging &amp; AUR"> <option value="44">Pacman &amp; Package Upgrade Issues</option> <option value="49">[testing] Repo Forum</option> <option value="4">Creating &amp; Modifying Packages</option> <option value="38">AUR Issues, Discussion &amp; PKGBUILD Requests</option> </optgroup> <optgroup label="Contributions &amp; Discussion"> <option value="20">GNU/Linux Discussion</option> <option value="27">Community Contributions</option> <option value="33">Programming &amp; Scripting</option> <option value="30">Other Languages</option> <option value="47">Artwork and Screenshots</option> <option value="42">Try This</option> </optgroup> <optgroup label="/dev/null"> <option value="29">Off-Topic</option> <option value="48" selected="selected">Topics Going Nowhere</option> <option value="36">Dustbin</option> </optgroup> </select></label> <input type="submit" value=" Go " accesskey="g" /> </div> </form> </div> <div class="conr"> <p id="feedlinks"><span class="atom"><a href="extern.php?action=feed&amp;tid=162768&amp;type=atom">Atom topic feed</a></span></p> <p id="poweredby">Powered by <a href="http://fluxbb.org/">FluxBB</a></p> </div> <div class="clearer"></div> </div> </div> </div> </div> <div class="end-box"></div> </div> </body> </html>
