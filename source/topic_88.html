<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"> <html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en" dir="ltr"> <head> <meta http-equiv="Content-Type" content="text/html; charset=utf-8" /> <title>KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9 (Page 88) / Topics Going Nowhere / Arch Linux Forums</title> <link rel="stylesheet" type="text/css" href="style/ArchLinux.css" /> <link rel="canonical" href="viewtopic.php?id=162768&amp;p=88" title="Page 88" /> <link rel="prev" href="viewtopic.php?id=162768&amp;p=87" title="Page 87" /> <link rel="next" href="viewtopic.php?id=162768&amp;p=89" title="Page 89" /> <link rel="alternate" type="application/atom+xml" href="extern.php?action=feed&amp;tid=162768&amp;type=atom" title="Atom topic feed" /> <link rel="stylesheet" media="screen" href="style/ArchLinux/arch.css?v=3" /> <link rel="stylesheet" media="screen" href="style/ArchLinux/archnavbar.css?v=2" /> <link rel="shortcut icon" href="style/ArchLinux/favicon.ico" /> </head> <body> <div id="archnavbar" class="anb-forum"> <div id="archnavbarlogo"><h1><a href="http://www.archlinux.org/">Arch Linux</a></h1></div> <div id="archnavbarmenu"> <ul id="archnavbarlist"> <li id="anb-home"><a href="http://www.archlinux.org/">Home</a></li><li id="anb-packages"><a href="http://www.archlinux.org/packages/">Packages</a></li><li id="anb-forums" class="anb-selected"><a href="https://bbs.archlinux.org/">Forums</a></li><li id="anb-wiki"><a href="https://wiki.archlinux.org/">Wiki</a></li><li id="anb-bugs"><a href="https://bugs.archlinux.org/">Bugs</a></li><li id="anb-aur"><a href="https://aur.archlinux.org/">AUR</a></li><li id="anb-download"><a href="http://www.archlinux.org/download/">Download</a></li> </ul> </div> </div> <div id="punviewtopic" class="pun"> <div class="top-box"></div> <div class="punwrap"> <div id="brdheader" class="block"> <div class="box"> <div id="brdmenu" class="inbox"> <ul> <li id="navindex" class="isactive"><a href="index.php">Index</a></li> <li id="navuserlist"><a href="userlist.php">User list</a></li> <li id="navsearch"><a href="search.php">Search</a></li> <li id="navprofile"><a href="profile.php?id=80749">Profile</a></li> <li id="navlogout"><a href="login.php?action=out&amp;id=80749&amp;csrf_token=5c20501ec397bb45ef8ee8c84db232c8d8e421c6">Logout</a></li> </ul> </div> <div id="brdwelcome" class="inbox"> <ul class="conl"> <li><span>Logged in as <strong>SXX</strong></span></li> <li><span>Last visit: 2015-08-16 12:20:09</span></li> </ul> <ul class="conr"> <li><span>Topics: <a href="search.php?action=show_replies" title="Find topics you have posted to.">Posted</a> | <a href="search.php?action=show_new" title="Find topics with new posts since your last visit.">New</a> | <a href="search.php?action=show_recent" title="Find topics with recent posts.">Active</a> | <a href="search.php?action=show_unanswered" title="Find topics with no replies.">Unanswered</a></span></li> </ul> <div class="clearer"></div> </div> </div> </div> <div id="brdmain"> <div class="linkst"> <div class="inbox crumbsplus"> <ul class="crumbs"> <li><a href="index.php">Index</a></li> <li><span>»&#160;</span><a href="viewforum.php?id=48">Topics Going Nowhere</a></li> <li><span>»&#160;</span><strong><a href="viewtopic.php?id=162768">KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</a></strong></li> </ul> <div class="pagepost"> <p class="pagelink conl"><span class="pages-label">Pages: </span><a rel="prev" class="item1" href="viewtopic.php?id=162768&amp;p=87">Previous</a> <a href="viewtopic.php?id=162768">1</a> <span class="spacer">…</span> <a href="viewtopic.php?id=162768&amp;p=86">86</a> <a href="viewtopic.php?id=162768&amp;p=87">87</a> <strong>88</strong> <a href="viewtopic.php?id=162768&amp;p=89">89</a> <a href="viewtopic.php?id=162768&amp;p=90">90</a> <span class="spacer">…</span> <a href="viewtopic.php?id=162768&amp;p=234">234</a> <a rel="next" href="viewtopic.php?id=162768&amp;p=89">Next</a></p> <p class="postlink conr">Topic closed</p> </div> <div class="clearer"></div> </div> </div> <div id="p1428465" class="blockpost rowodd blockpost1"> <h2><span><span class="conr">#2176</span> <a href="viewtopic.php?pid=1428465#p1428465">2014-06-21 15:45:23</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=82442">slis</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2014-06-02</span></dd> <dd><span>Posts: 125</span></dd> <dd class="usercontacts"><span class="email"><a href="mailto:xslisx@gmail.com">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <p>refering to problem on post <a href="https://bbs.archlinux.org/viewtopic.php?pid=1428122#p1428122" rel="nofollow">https://bbs.archlinux.org/viewtopic.php … 2#p1428122</a></p><br /><p>so i have sandy bridge i72600 = pcie2.0<br />560ti = pcie2.0<br />660ti = pcie3.0<br />770ti = pcie3.0<br />mbo= g1 sniper 3=pcie3.0</p><p>could this be reason for lagging hdmi sound and i think lower perfomance on kepler+ cards? 560ti works fine...</p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1428465">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1428487" class="blockpost roweven"> <h2><span><span class="conr">#2177</span> <a href="viewtopic.php?pid=1428487#p1428487">2014-06-21 17:22:34</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=82631">spicy</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2014-06-09</span></dd> <dd><span>Posts: 3</span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>aw wrote:</cite><blockquote><div><div class="quotebox"><cite>spicy wrote:</cite><blockquote><div><p>&#160; &#160; qemu-system-x86_64: -device vfio-pci,host=02:00.0,bus=root.1,addr=00.0,multifunction=on,x-vga=on: vfio: Device does not support requested feature x-vga</p></div></blockquote></div><p>This means that either a) your kernel does not support CONFIG_VFIO_PCI_VGA or b) the device is not a VGA device.&#160; To test a):</p><p>$ grep CONFIG_VFIO_PCI_VGA /boot/config-`uname -r`</p></div></blockquote></div><p>Yep, I had to re-compile with CONFIG_VFIO_PCI_VGA. At the time I think I was using a stock kernel which needed some adjustments. Thanks to your guidance the guides provided by the OP, I was able to get everything running with a GTX 770 – working great.</p><p>I&#039;m actually doing two builds with similar hardware (minus the video cards, anyway) and ran into a problem recently with my second box and a capture card. From what I&#039;ve read (and it&#039;s even been brought up on the last couple of pages) this is the whole ACS override issue – the capture card looks like it is behind a bridge so I&#039;m getting the error: </p><div class="codebox"><pre><code>qemu-system-x86_64: -device vfio-pci,host=02:00.0,bus=pcie.0: vfio: error, group 8 is not viable, please ensure all devices within the iommu_group are bound to their vfio bus driver.</code></pre></div><p>I haven&#039;t been able to test with the ACS patch and </p><div class="codebox"><pre><code>pcie_acs_override=downstream</code></pre></div><p> on because I can&#039;t apply the patch to the kernel for some reason – not sure how to troubleshoot why it won&#039;t apply properly. I&#039;m using 3.15 from <a href="https://www.kernel.org/pub/linux/kernel/v3.x/linux-3.15.tar.xz" rel="nofollow">here</a> and getting the following: </p><div class="codebox"><pre><code>$ patch -p1 &lt; acs.diff patching file Documentation/kernel-parameters.txt Hunk #1 succeeded at 2574 with fuzz 2 (offset 225 lines). patching file drivers/pci/quirks.c Hunk #1 FAILED at 3292. 1 out of 1 hunk FAILED -- saving rejects to file drivers/pci/quirks.c.rej patch unexpectedly ends in middle of line</code></pre></div><p>and then the output of the rejects file:</p><div class="codebox"><pre class="vscroll"><code># cat drivers/pci/quirks.c.rej --- drivers/pci/quirks.c +++ drivers/pci/quirks.c @@ -3292,11 +3292,113 @@ return pci_dev_get(dev); } +static bool acs_on_downstream; +static bool acs_on_multifunction; + +#define NUM_ACS_IDS 16 +struct acs_on_id { + unsigned short vendor; + unsigned short device; +}; +static struct acs_on_id acs_on_ids[NUM_ACS_IDS]; +static u8 max_acs_id; + +static __init int pcie_acs_override_setup(char *p) +{ + if (!p) + return -EINVAL; + + while (*p) { + if (!strncmp(p, &quot;downstream&quot;, 10)) + acs_on_downstream = true; + if (!strncmp(p, &quot;multifunction&quot;, 13)) + acs_on_multifunction = true; + if (!strncmp(p, &quot;id:&quot;, 3)) { + char opt[5]; + int ret; + long val; + + if (max_acs_id &gt;= NUM_ACS_IDS - 1) { + pr_warn(&quot;Out of PCIe ACS override slots (%d)\n&quot;, + NUM_ACS_IDS); + goto next; + } + + p += 3; + snprintf(opt, 5, &quot;%s&quot;, p); + ret = kstrtol(opt, 16, &amp;val); + if (ret) { + pr_warn(&quot;PCIe ACS ID parse error %d\n&quot;, ret); + goto next; + } + acs_on_ids[max_acs_id].vendor = val; + + p += strcspn(p, &quot;:&quot;); + if (*p != &#039;:&#039;) { + pr_warn(&quot;PCIe ACS invalid ID\n&quot;); + goto next; + } + + p++; + snprintf(opt, 5, &quot;%s&quot;, p); + ret = kstrtol(opt, 16, &amp;val); + if (ret) { + pr_warn(&quot;PCIe ACS ID parse error %d\n&quot;, ret); + goto next; + } + acs_on_ids[max_acs_id].device = val; + max_acs_id++; + } +next: + p += strcspn(p, &quot;,&quot;); + if (*p == &#039;,&#039;) + p++; + } + + if (acs_on_downstream || acs_on_multifunction || max_acs_id) + pr_warn(&quot;Warning: PCIe ACS overrides enabled; This may allow non-IOMMU protected peer-to-peer DMA\n&quot;); + + return 0; +} +early_param(&quot;pcie_acs_override&quot;, pcie_acs_override_setup); + +static int pcie_acs_overrides(struct pci_dev *dev, u16 acs_flags) +{ + int i; + + /1 /bin /boot /cdrom /dev /etc /home /initrd.img /initrd.img.old /lib /lib32 /lib64 /libx32 /lost+found /media /mnt /opt /proc /root /run /sbin /srv /sys /tmp /ubiquity-apt-clone /usr /var /vmlinuz /vmlinuz.old /win81-base.qcow2 /win81-base.qcow2.md5 /win81-writable-amd.qcow2 /win81-writable-nvidia.qcow2 /win81-writable-nvidia.qcow2.backup Never override ACS for legacy devices or devices with ACS caps */ + if (!pci_is_pcie(dev) || + pci_find_ext_capability(dev, PCI_EXT_CAP_ID_ACS)) + return -ENOTTY; + + for (i = 0; i &lt; max_acs_id; i++) + if (acs_on_ids[i].vendor == dev-&gt;vendor &amp;&amp; + acs_on_ids[i].device == dev-&gt;device) + return 1; + + switch (pci_pcie_type(dev)) { + case PCI_EXP_TYPE_DOWNSTREAM: + case PCI_EXP_TYPE_ROOT_PORT: + if (acs_on_downstream) + return 1; + break; + case PCI_EXP_TYPE_ENDPOINT: + case PCI_EXP_TYPE_UPSTREAM: + case PCI_EXP_TYPE_LEG_END: + case PCI_EXP_TYPE_RC_END: + if (acs_on_multifunction &amp;&amp; dev-&gt;multifunction) + return 1; + } + + return -ENOTTY; +} + static const struct pci_dev_acs_enabled { u16 vendor; u16 device; int (*acs_enabled)(struct pci_dev *dev, u16 acs_flags); } pci_dev_acs_enabled[] = { + { PCI_ANY_ID, PCI_ANY_ID, pcie_acs_overrides }, { 0 } };</code></pre></div><p>I&#039;m not super familiar with applying kernel patches, but was able to get the i915 VGA patch applied fine earlier on this same kernel version. Also not a C programmer so I&#039;m kind of useless troubleshooting what didn&#039;t apply. </p><p>Any tips would be appreciated, it is probably something simple that I am missing here (hope I&#039;m not being too frustrating). Also thanks again aw and everyone else who has contributed information, code and guides for this – awesome stuff! I&#039;m hoping to put together a guide of all the specific steps I had to take for my hardware as a sort of specific mini-guide once everything is working to contribute something back in a small way.</p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1428487">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1428514" class="blockpost rowodd"> <h2><span><span class="conr">#2178</span> <a href="viewtopic.php?pid=1428514#p1428514">2014-06-21 19:03:16</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=82238">sinny</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2014-05-24</span></dd> <dd><span>Posts: 75</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=82238">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>spicy wrote:</cite><blockquote><div><div class="quotebox"><cite>aw wrote:</cite><blockquote><div><div class="quotebox"><cite>spicy wrote:</cite><blockquote><div><p>&#160; &#160; qemu-system-x86_64: -device vfio-pci,host=02:00.0,bus=root.1,addr=00.0,multifunction=on,x-vga=on: vfio: Device does not support requested feature x-vga</p></div></blockquote></div><p>This means that either a) your kernel does not support CONFIG_VFIO_PCI_VGA or b) the device is not a VGA device.&#160; To test a):</p><p>$ grep CONFIG_VFIO_PCI_VGA /boot/config-`uname -r`</p></div></blockquote></div><p>Yep, I had to re-compile with CONFIG_VFIO_PCI_VGA. At the time I think I was using a stock kernel which needed some adjustments. Thanks to your guidance the guides provided by the OP, I was able to get everything running with a GTX 770 – working great.</p><p>I&#039;m actually doing two builds with similar hardware (minus the video cards, anyway) and ran into a problem recently with my second box and a capture card. From what I&#039;ve read (and it&#039;s even been brought up on the last couple of pages) this is the whole ACS override issue – the capture card looks like it is behind a bridge so I&#039;m getting the error: </p><div class="codebox"><pre><code>qemu-system-x86_64: -device vfio-pci,host=02:00.0,bus=pcie.0: vfio: error, group 8 is not viable, please ensure all devices within the iommu_group are bound to their vfio bus driver.</code></pre></div><p>I haven&#039;t been able to test with the ACS patch and </p><div class="codebox"><pre><code>pcie_acs_override=downstream</code></pre></div><p> on because I can&#039;t apply the patch to the kernel for some reason – not sure how to troubleshoot why it won&#039;t apply properly. I&#039;m using 3.15 from <a href="https://www.kernel.org/pub/linux/kernel/v3.x/linux-3.15.tar.xz" rel="nofollow">here</a> and getting the following: </p><div class="codebox"><pre><code>$ patch -p1 &lt; acs.diff patching file Documentation/kernel-parameters.txt Hunk #1 succeeded at 2574 with fuzz 2 (offset 225 lines). patching file drivers/pci/quirks.c Hunk #1 FAILED at 3292. 1 out of 1 hunk FAILED -- saving rejects to file drivers/pci/quirks.c.rej patch unexpectedly ends in middle of line</code></pre></div><p>and then the output of the rejects file:</p><div class="codebox"><pre class="vscroll"><code># cat drivers/pci/quirks.c.rej --- drivers/pci/quirks.c +++ drivers/pci/quirks.c @@ -3292,11 +3292,113 @@ return pci_dev_get(dev); } +static bool acs_on_downstream; +static bool acs_on_multifunction; + +#define NUM_ACS_IDS 16 +struct acs_on_id { + unsigned short vendor; + unsigned short device; +}; +static struct acs_on_id acs_on_ids[NUM_ACS_IDS]; +static u8 max_acs_id; + +static __init int pcie_acs_override_setup(char *p) +{ + if (!p) + return -EINVAL; + + while (*p) { + if (!strncmp(p, &quot;downstream&quot;, 10)) + acs_on_downstream = true; + if (!strncmp(p, &quot;multifunction&quot;, 13)) + acs_on_multifunction = true; + if (!strncmp(p, &quot;id:&quot;, 3)) { + char opt[5]; + int ret; + long val; + + if (max_acs_id &gt;= NUM_ACS_IDS - 1) { + pr_warn(&quot;Out of PCIe ACS override slots (%d)\n&quot;, + NUM_ACS_IDS); + goto next; + } + + p += 3; + snprintf(opt, 5, &quot;%s&quot;, p); + ret = kstrtol(opt, 16, &amp;val); + if (ret) { + pr_warn(&quot;PCIe ACS ID parse error %d\n&quot;, ret); + goto next; + } + acs_on_ids[max_acs_id].vendor = val; + + p += strcspn(p, &quot;:&quot;); + if (*p != &#039;:&#039;) { + pr_warn(&quot;PCIe ACS invalid ID\n&quot;); + goto next; + } + + p++; + snprintf(opt, 5, &quot;%s&quot;, p); + ret = kstrtol(opt, 16, &amp;val); + if (ret) { + pr_warn(&quot;PCIe ACS ID parse error %d\n&quot;, ret); + goto next; + } + acs_on_ids[max_acs_id].device = val; + max_acs_id++; + } +next: + p += strcspn(p, &quot;,&quot;); + if (*p == &#039;,&#039;) + p++; + } + + if (acs_on_downstream || acs_on_multifunction || max_acs_id) + pr_warn(&quot;Warning: PCIe ACS overrides enabled; This may allow non-IOMMU protected peer-to-peer DMA\n&quot;); + + return 0; +} +early_param(&quot;pcie_acs_override&quot;, pcie_acs_override_setup); + +static int pcie_acs_overrides(struct pci_dev *dev, u16 acs_flags) +{ + int i; + + /1 /bin /boot /cdrom /dev /etc /home /initrd.img /initrd.img.old /lib /lib32 /lib64 /libx32 /lost+found /media /mnt /opt /proc /root /run /sbin /srv /sys /tmp /ubiquity-apt-clone /usr /var /vmlinuz /vmlinuz.old /win81-base.qcow2 /win81-base.qcow2.md5 /win81-writable-amd.qcow2 /win81-writable-nvidia.qcow2 /win81-writable-nvidia.qcow2.backup Never override ACS for legacy devices or devices with ACS caps */ + if (!pci_is_pcie(dev) || + pci_find_ext_capability(dev, PCI_EXT_CAP_ID_ACS)) + return -ENOTTY; + + for (i = 0; i &lt; max_acs_id; i++) + if (acs_on_ids[i].vendor == dev-&gt;vendor &amp;&amp; + acs_on_ids[i].device == dev-&gt;device) + return 1; + + switch (pci_pcie_type(dev)) { + case PCI_EXP_TYPE_DOWNSTREAM: + case PCI_EXP_TYPE_ROOT_PORT: + if (acs_on_downstream) + return 1; + break; + case PCI_EXP_TYPE_ENDPOINT: + case PCI_EXP_TYPE_UPSTREAM: + case PCI_EXP_TYPE_LEG_END: + case PCI_EXP_TYPE_RC_END: + if (acs_on_multifunction &amp;&amp; dev-&gt;multifunction) + return 1; + } + + return -ENOTTY; +} + static const struct pci_dev_acs_enabled { u16 vendor; u16 device; int (*acs_enabled)(struct pci_dev *dev, u16 acs_flags); } pci_dev_acs_enabled[] = { + { PCI_ANY_ID, PCI_ANY_ID, pcie_acs_overrides }, { 0 } };</code></pre></div><p>I&#039;m not super familiar with applying kernel patches, but was able to get the i915 VGA patch applied fine earlier on this same kernel version. Also not a C programmer so I&#039;m kind of useless troubleshooting what didn&#039;t apply. </p><p>Any tips would be appreciated, it is probably something simple that I am missing here (hope I&#039;m not being too frustrating). Also thanks again aw and everyone else who has contributed information, code and guides for this – awesome stuff! I&#039;m hoping to put together a guide of all the specific steps I had to take for my hardware as a sort of specific mini-guide once everything is working to contribute something back in a small way.</p></div></blockquote></div><p>seems like you try to apply &quot;broken&quot; patch:</p><div class="codebox"><pre><code>Hunk #1 FAILED at 3292. 1 out of 1 hunk FAILED -- saving rejects to file drivers/pci/quirks.c.rej patch unexpectedly ends in middle of line</code></pre></div><p>(note last line)<br />you probably decided to ignore some &quot;unneded&quot; empty lines, which are in fact important for patch command to verify that applied patch is well-formed/valid</p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1428514">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1428531" class="blockpost roweven"> <h2><span><span class="conr">#2179</span> <a href="viewtopic.php?pid=1428531#p1428531">2014-06-21 19:35:28</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=82631">spicy</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2014-06-09</span></dd> <dd><span>Posts: 3</span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>sinny wrote:</cite><blockquote><div><p>seems like you try to apply &quot;broken&quot; patch:</p><div class="codebox"><pre><code>Hunk #1 FAILED at 3292. 1 out of 1 hunk FAILED -- saving rejects to file drivers/pci/quirks.c.rej patch unexpectedly ends in middle of line</code></pre></div><p>(note last line)<br />you probably decided to ignore some &quot;unneded&quot; empty lines, which are in fact important for patch command to verify that applied patch is well-formed/valid</p></div></blockquote></div><p>Hi sinny,</p><p>Thanks for your reply. As far as I can tell, the patch is the correct one – I&#039;ve downloaded it directly from Alex&#039;s <a href="https://lkml.org/lkml/2013/5/30/513" rel="nofollow">LKML posting</a> using wget to directly download the diff:</p><div class="codebox"><pre><code>wget -O acs.diff https://lkml.org/lkml/diff/2013/5/30/513/1</code></pre></div><p>I should note that the last line about &quot;unexpectedly ending in the middle of line&quot; also occurs in the i915 patch which I can apply successfully, as far as I can tell that is expected behaviour.</p><p>Any ideas?</p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1428531">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1428540" class="blockpost rowodd"> <h2><span><span class="conr">#2180</span> <a href="viewtopic.php?pid=1428540#p1428540">2014-06-21 19:59:46</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=80333">ahl</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2014-03-16</span></dd> <dd><span>Posts: 20</span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>spicy wrote:</cite><blockquote><div><div class="quotebox"><cite>sinny wrote:</cite><blockquote><div><p>seems like you try to apply &quot;broken&quot; patch:</p><div class="codebox"><pre><code>Hunk #1 FAILED at 3292. 1 out of 1 hunk FAILED -- saving rejects to file drivers/pci/quirks.c.rej patch unexpectedly ends in middle of line</code></pre></div><p>(note last line)<br />you probably decided to ignore some &quot;unneded&quot; empty lines, which are in fact important for patch command to verify that applied patch is well-formed/valid</p></div></blockquote></div><p>Hi sinny,</p><p>Thanks for your reply. As far as I can tell, the patch is the correct one – I&#039;ve downloaded it directly from Alex&#039;s <a href="https://lkml.org/lkml/2013/5/30/513" rel="nofollow">LKML posting</a> using wget to directly download the diff:</p><div class="codebox"><pre><code>wget -O acs.diff https://lkml.org/lkml/diff/2013/5/30/513/1</code></pre></div><p>I should note that the last line about &quot;unexpectedly ending in the middle of line&quot; also occurs in the i915 patch which I can apply successfully, as far as I can tell that is expected behaviour.</p><p>Any ideas?</p></div></blockquote></div><p>That patch is very old. Download the linux-mainline.tar.gz from first post.</p><div class="codebox"><pre><code>$ tar xf linux-3.15.tar.xz $ tar xf linux-mainline.tar.gz $ cd linux-3.15 $ cat ../linux-mainline/override_for_missing_acs_capabilities.patch | patch -p1</code></pre></div><p>Also since 3.15.1 is already out, you might want to upgrade to that too. Here is one example how to do that:</p><div class="codebox"><pre><code>$ wget https://www.kernel.org/pub/linux/kernel/v3.x/patch-3.15.1.xz $ cd linux-3.15 $ xzcat ../patch-3.15.1.xz | patch -p1 $ cd .. $ mv linux-3.15 linux-3.15.1</code></pre></div><p>...alternatively, you can just download linux-3.15.1.tar.xz</p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1428540">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1428555" class="blockpost roweven"> <h2><span><span class="conr">#2181</span> <a href="viewtopic.php?pid=1428555#p1428555">2014-06-21 20:42:07</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=80378">stefan_vgapass</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2014-03-17</span></dd> <dd><span>Posts: 2</span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <p>I have finally had some time to try, again, a Linux guest with kvm vga passthrough.<br />Last time I tried with an Kubuntu 13.10 x64 guest I got the BSOD after installing the ATI drivers.<br />To my surprise this time with Kubuntu 14.04 x64 it just worked.</p><p><strong>Host specs:</strong><br />check my previous post, the host system is the same.<br /><a href="https://bbs.archlinux.org/viewtopic.php?pid=1393614#p1393614" rel="nofollow">https://bbs.archlinux.org/viewtopic.php … 4#p1393614</a></p><p><strong>Guest specs:</strong></p><div class="quotebox"><blockquote><div><p>OS:&#160; &#160; &#160; Kubuntu 14.04 x64<br />CPU:&#160; &#160; &#160;2 cores x 2 threads Opteron emulated CPU<br />RAM:&#160; &#160; &#160;8 GB of ram ( I kept the ram the same size as for the windows guest )<br />GPU:&#160; &#160; &#160;XFX Radeon HD 7850 2GB RAM<br />Disk:&#160; &#160; virtio ( running 2 HDD: 60GB for / and 128GB for /home )<br />Network: virtio bridge<br />Driver:&#160; latest fglrx ATI driver, at the time of writing, Catalyst 14.4</p></div></blockquote></div><p><strong>Guest startup script:</strong></p><div class="codebox"><pre><code>/opt/qemu-git/bin/qemu-system-x86_64 -enable-kvm -M q35 \ -m 8196 -mem-prealloc -mem-path /mnt/hugepages \ -cpu Opteron_G5 \ -smp 4,sockets=1,cores=2,threads=2 \ -bios /root/kvm-vga-passthrough/vfio-post3.13/seabios/seabios/out/bios.bin -vga none \ -boot order=cd,menu=on \ -device ioh3420,bus=pcie.0,addr=1c.0,multifunction=on,port=1,chassis=1,id=root.1 \ -device vfio-pci,host=04:00.0,bus=root.1,addr=00.0,multifunction=on,x-vga=on \ -device vfio-pci,host=00:1d.0,bus=root.1,addr=00.1 \ -device vfio-pci,host=00:1b.0,bus=root.1,addr=00.2 \ -device ahci,bus=pcie.0,id=ahci \ -netdev bridge,br=br0,id=hostnet0 \ -device virtio-net-pci,netdev=hostnet0,id=net0 \ -drive file=/var/lib/libvirt/images/kubuntu_1404_x64-disk01.qcow2,id=disk,format=qcow2 -device ide-hd,bus=ahci.0,drive=disk \ -drive file=/var/lib/libvirt/images/kubuntu_1404_x64-disk02.qcow2,id=disk02,format=qcow2 -device ide-hd,bus=ahci.1,drive=disk02 \ -drive file=/var/lib/libvirt/images/kubuntu-14.04-desktop-amd64.iso,id=isocd -device ide-cd,bus=ahci.2,drive=isocd</code></pre></div><p><strong>Tested:</strong></p><p>I&#039;ve only been able to test using Team Fortress 2 and Dota 2.</p><p>In Dota 2 I&#039;ve measured the FPS running between max 60 fps and min 29 fps usually averaging 45 fps.<br />Compared with the windows VM were I get max 60 fps and min 30 averaging 58 fps.</p><p>In Team fortress 2 I&#039;ve measured the FPS running between max 120 and min 76 averaging 65 FPS.<br />Compared with the windows VM were I get max 110 and min 19 averaging 44 FPS.</p><p>Looks like TF2 works better in Linux and Dota 2 works better in Windows on a VGA passthrough VM with an ATI graphics card.<br />The difference is not enourmeous though !<br />I don&#039;t know how they compare versus a native windows install as I have no windows install to compare to.</p><br /><p><strong>Steam client on linux related bugs:</strong><br />For posterity I&#039;m putting here the 2 bugs I&#039;ve experienced whilst running Steam client on linux with an ATI graphics card.</p><p><strong>1.</strong> <span class="bbu">I had to reinstall the ATI driver</span><br />I had one very strange occurance that I could only fix by reinstalling the ATI Catalyst driver.<br />I&#039;ve played on Steam on this guest a few days ago, but when I tried it again today Steam couldn&#039;t detect that the Catalyst driver is running OpenGL 4.4.<br />It was complaining that it is running OpenGL 1.4 and it can&#039;t work with OpenGL &lt; 2.0.<br />The exact error was:</p><div class="codebox"><pre><code>PROBLEM: You appear to have OpenGL 1.4.0, but we need at least 2.0.0! Could not find required OpenGL entry point &#039;glGetError&#039;! Either your video card is unsupported, or your OpenGL driver needs to be updated.</code></pre></div><p><strong>2.</strong> <span class="bbu">Steam doesn&#039;t correctly detect that I&#039;m runing fglrx.</span></p><p>I had to forcibly tell the Steam client that I&#039;m using fglrx as the video driver.</p><div class="codebox"><pre><code>sudo ln -s /usr/lib/i386-linux-gnu/mesa/libGL.so.1.2.0 /usr/lib/i386-linux-gnu/mesa/libGL.so.1 sudo ln -s /usr/lib/fglrx/fglrx-libGL.so.1.2 /usr/lib/i386-linux-gnu/mesa/libGL.so.1.2.0</code></pre></div><p>The link that led me to this fix, it is the last post on this steam thread: <a href="http://steamcommunity.com/app/221410/discussions/1/882966056488160497/?l=german#p2" rel="nofollow">http://steamcommunity.com/app/221410/di … =german#p2</a></p><br /><br /><p>Next to try SteamOS with vga passthrough, although I expect it to be just as straightforward and easy to setup as this linux guest was !</p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1428555">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1428601" class="blockpost rowodd"> <h2><span><span class="conr">#2182</span> <a href="viewtopic.php?pid=1428601#p1428601">2014-06-22 01:08:49</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=81948">thehighhat</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2014-05-12</span></dd> <dd><span>Posts: 5</span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <p>Status update to my setup.&#160; After lots of trial and error and tweaking, the minimum amount of steps that works 100% with virsh is:</p><p>- motherboard VGA for host (Intel 5520 chipset)<br />- nvidia gpu for vga passthrough to guest<br />- ubuntu 14.04 x64_64<br />- qemu kvm </p><p>-- add &quot;intel_iommu=on&quot; to GRUB_CMDLINE_LINUX in /etc/grub/default&#160; <br />-- create file /etc/modprobe.d/vfio_iommu_type.conf with contents &quot;options vfio_iommu_type1 allow_unsafe_interrupts=1&quot;<br />-- add &quot;blacklist nouveau&quot; line to /etc/modprobe.d/blacklist-framebuffer.conf<br />-- set user and group to &quot;root&quot; in /etc/libvirt/qemu.conf<br />-- add the correct /dev/vfio/#### entry to cgroup_device_acl in /etc/libvirt/qemu.conf <br />-- use the OP vfio-bind script with the id found from &quot;lscpi -v | grep -i vga&quot;<br />-- create a VM (virt-manager is quick and dirty way to do this)<br />-- download or extract the romfile for your GPU<br />-- then virsh edit YOUR_VM<br />-- -- set the first line &lt;domain ...&gt; to &quot;&lt;domain type=&#039;kvm&#039; id=&#039;3&#039; xmlns:qemu=&#039;http://libvirt.org/schemas/domain/qemu/1.0&#039;&gt;&quot;<br />-- -- add a block similar to this to the xml<br />&quot;&#160; &#160;&lt;qemu:commandline&gt;<br />&#160; &#160; &lt;qemu:arg value=&#039;-device&#039;/&gt;<br />&#160; &#160; &lt;qemu:arg value=&#039;vfio-pci,host=02:00.0,bus=pci.0,multifunction=on,x-vga=on,romfile=/path/to/your/gpu.rom&#039;/&gt;<br />&#160; &#160; &lt;qemu:arg value=&#039;-device&#039;/&gt;<br />&#160; &#160; &lt;qemu:arg value=&#039;vfio-pci,host=02:00.1,bus=pci.0&#039;/&gt;<br />&#160; &#160; &lt;qemu:arg value=&#039;-bios&#039;/&gt;<br />&#160; &#160; &lt;qemu:arg value=&#039;/usr/share/qemu/bios.bin&#039;/&gt;<br />&#160; &lt;/qemu:commandline&gt;&quot;<br />-- virt-manager to delete the display and video entries<br />-- if using apparmor, turn off aa-enforce on the /etc/apparmor.d/libvirt/libvirt-#####-YOUR_VMs_ENTRY</p><p>and that&#039;s it.&#160; start the VM using virsh start or virt-manager</p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1428601">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1428613" class="blockpost roweven"> <h2><span><span class="conr">#2183</span> <a href="viewtopic.php?pid=1428613#p1428613">2014-06-22 01:57:01</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=79991">mv0lnicky</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2014-03-05</span></dd> <dd><span>Posts: 16</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=79991">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>slis wrote:</cite><blockquote><div><p>refering to problem on post <a href="https://bbs.archlinux.org/viewtopic.php?pid=1428122#p1428122" rel="nofollow">https://bbs.archlinux.org/viewtopic.php … 2#p1428122</a></p><br /><p>so i have sandy bridge i72600 = pcie2.0<br />560ti = pcie2.0<br />660ti = pcie3.0<br />770ti = pcie3.0<br />mbo= g1 sniper 3=pcie3.0</p><p>could this be reason for lagging hdmi sound and i think lower perfomance on kepler+ cards? 560ti works fine...</p></div></blockquote></div><p>Try changing the slot of the same GPU you&#039;re passing to the guest. If the problem stops, you know you&#039;re hitting a bottleneck with the PCIE-&gt;PCH-&gt;DMI bus.</p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1428613">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1428661" class="blockpost rowodd"> <h2><span><span class="conr">#2184</span> <a href="viewtopic.php?pid=1428661#p1428661">2014-06-22 07:53:39</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=82442">slis</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2014-06-02</span></dd> <dd><span>Posts: 125</span></dd> <dd class="usercontacts"><span class="email"><a href="mailto:xslisx@gmail.com">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><blockquote><div><p>Try changing the slot of the same GPU you&#039;re passing to the guest. If the problem stops, you know you&#039;re hitting a bottleneck with the PCIE-&gt;PCH-&gt;DMI bus.</p></div></blockquote></div><p>Can u pls explain what do u mean by changing slots?&#160; bottleneck? cause of pcie2.0? i checked lspci and it says&#160; for geforce 660 LnkSta: Speed 2.5GT/s, Width x16,</p><p>yeah i tested... pcie 3.0 gpus crashes with hdmi sound on gigbyte g1 sniper 3 in any port,, i belive pcie gen3 is problem... but there is no option in bios... i have option on my x77-ud3h so ill try later to lower pcie to 2.0.</p> <p class="postedit"><em>Last edited by slis (2014-06-22 12:11:13)</em></p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1428661">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1428666" class="blockpost roweven"> <h2><span><span class="conr">#2185</span> <a href="viewtopic.php?pid=1428666#p1428666">2014-06-22 08:12:45</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=82972">ebinmaymay</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2014-06-22</span></dd> <dd><span>Posts: 1</span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <p>I would like to post my own success story too. <a href="https://www.youtube.com/watch?v=37D2bRsthfI" rel="nofollow">A video from youtube</a> brought me here and motivated me to move away from vmware.</p><p>I have an 8-core AMD 8320 cpu with a ASUS M5A97 EVO R2.0 mobo. It has a AMD970 chipset and supports both VT-i and VT-d. I&#039;m using (k)ubuntu with the latest lowlatency kernel from kernel-ppa. (I should just switch to Arch.)</p><p>I&#039;m using a nVidia GTX 550 Ti as my primary card and my Radeon HD 7750 as my passed-through card. (The open source nvidia driver has gotten rather good to my surprise after uninstalling the proprietary driver. <img src="https://bbs.archlinux.org/img/smilies/smile.png" width="15" height="15" alt="smile" />)<br />I had some success going the other way as well, but ran into the usual nvidia driver detecting hypervisor problem. (I read somewhere that you can pass a qemu option to hide kvm&#039;s presence to the guest, but I don&#039;t feel like swapping them around yet again just to test it. <img src="https://bbs.archlinux.org/img/smilies/smile.png" width="15" height="15" alt="smile" />)</p><p>I&#039;m going to give a blow-by-blow description of what I did, so feel free to skip most of it.</p><br /><br /><p>===BEGIN BLOW BY BLOW===<br />First of all I did an lspci and inspection of /sys/devices/ and discovered that my second card appears at 07:00:00 and 07:00:01, with its bridge at 00:15:00.</p><div class="codebox"><pre><code>tux@oniichan:~$ lspci 00:15.0 PCI bridge: Advanced Micro Devices, Inc. [AMD/ATI] SB700/SB800/SB900 PCI to PCI bridge (PCIE port 0) 07:00.0 VGA compatible controller: Advanced Micro Devices, Inc. [AMD/ATI] Cape Verde PRO [Radeon HD 7750 / R7 250E] 07:00.1 Audio device: Advanced Micro Devices, Inc. [AMD/ATI] Cape Verde/Pitcairn HDMI Audio [Radeon HD 7700/7800 Series] tux@oniichan:~$ lspci -n 00:15.0 0604: 1002:43a0 07:00.0 0300: 1002:683f 07:00.1 0403: 1002:aab0 tux@oniichan:~$ find /sys/devices -iname &#039;0000:07:00.0&#039; /sys/devices/pci0000:00/0000:00:15.0/0000:07:00.</code></pre></div><br /><p>Then I added pci-stub to the modules inside the initramfs blob at /etc/initramfs-tools/modules.</p><div class="codebox"><pre><code>sudo nano /etc/initramfs-tools/modules sudo update-initramfs -u -k all</code></pre></div><br /><p>Then added &quot;pci-stub.ids=1002:683f,1002:aab0&quot; to the kernel command by adding it to GRUB_CMDLINE_LINUX in /etc/default/grub.</p><div class="codebox"><pre><code>sudo nano /etc/default/grub sudo update-grub</code></pre></div><p>It&#039;s worth noting that I ended up not blacklisting the kernel&#039;s baked-in radeon driver, nor did I turn on unsafe interrupts.</p><br /><p>At this stage I rebooted to check that it was catching the card. It was.</p><div class="codebox"><pre><code>[ 16.083836] pci-stub: add 1002:683F sub=FFFFFFFF:FFFFFFFF cls=00000000/00000000 [ 16.083866] pci-stub 0000:07:00.0: claimed by stub [ 16.083878] pci-stub: add 1002:AAB0 sub=FFFFFFFF:FFFFFFFF cls=00000000/00000000 [ 16.083893] pci-stub 0000:07:00.1: claimed by stub</code></pre></div><br /><p>I added the vfio-script as provided by the OP and made an upstart script at /etc/init/vfio-pci</p><div class="codebox"><pre><code># vfio-pci - bind certain pci devices to vfio-pci description &quot;pci to vfio autobinder&quot; start on runlevel [2345] task script vfio-bind 0000:00:15.0 0000:07:00.0 0000:07:00.1 end script</code></pre></div><p>Rebooted, and then ran qemu as per everyone else ITT.<br />===END BLOW BY BLOW==</p><br /><br /><p>HOWEVER, I was not able to pass through my graphics card with a copy-paste of the OP&#039;s instructions.<br />So I gave up, installed windows 7 using sdl, first with the old default computer model, then with the virtio drivers, and then with the q35 drivers.<br />For the benefit of the newbies, I passed an extra qcow2 image through a virtio adapter. win7 picked it up and asked for the virtio driver then.<br />Thankfully I have been running a ftp server using vsftpd for sharing anime in my household, so it wasn&#039;t troublesome to get driver/software isos into the os and mount them.<br />fyi, I used SlySoft&#039;s Virtual CloneDrive instead of Daemon Tools because it doesn&#039;t inject shellcode to do so, although feel free to use whatever you like. <img src="https://bbs.archlinux.org/img/smilies/smile.png" width="15" height="15" alt="smile" /></p><p>After getting everything else sorted, I finally tackled the pcie passthrough problem and only two days ago, after a week of fiddling, did I get it to work with my AMD card. Whenever I tried to pass it through, the card would turn on and do nothing.<br />I even extracted the romfile from my card via sysfs...</p><div class="codebox"><pre><code>sudo bash echo &#039;1&#039; &gt; /sys/devices/pci0000:00/0000:00:15.0/0000:07:00.0/romfile dd if=/sys/devices/pci0000:00/0000:00:15.0/0000:07:00.0/romfile of=radeon.rom</code></pre></div><p>...but it still didn&#039;t do anything.</p><p>After a week of fiddling, I got OP&#039;s test command to work by passing a dummy <strong>ISA(!!!)</strong> cirrus graphics adapter.<br />When this isa card was passed through, the cirrus graphics adapter ALWAYS displays blank. The boot screen and splash appears on my second monitor.<br />I suspect that it boots the cirrus and it spoofs a boot of the pci, because <a href="http://a.pomf.se/zostvh.jpg" rel="nofollow">my custom bootsplash of which I am immensely proud</a> has distorted colors. <img src="https://bbs.archlinux.org/img/smilies/sad.png" width="15" height="15" alt="sad" /></p><p>I also got the emulated audio device to work flawlessly by dropping the audio adapter on my gfx adapter, then passing it the ich9 version rather than the default ich6. Remember to reboot win7 at least once between hw changes. :-)<br />So my final working script as of this morning is the following:</p><div class="codebox"><pre class="vscroll"><code>#!/bin/bash export DISPLAY=:0 export QEMU_AUDIO_DRV=alsa xrandr --output DVI-I-1 --off sudo qemu-system-x86_64 \ -enable-kvm \ -cpu host,hv-time \ -smp 4,cores=4 \ -m 4G \ -M q35 \ -ctrl-grab \ -vga none \ -bios /usr/share/qemu/bios-256k.bin \ -net user,smb=/home/tux/share \ -net nic,model=virtio \ -usb \ -usbdevice host:8564:1000 \ -usbdevice host:045e:00d1 \ -device isa-cirrus-vga \ -device ioh3420,bus=pcie.0,addr=1c,multifunction=on,port=1,chassis=1,id=root.1 \ -device vfio-pci,host=07:00.0,bus=root.1,addr=00.0,multifunction=on,x-vga=on \ -device ich9-intel-hda \ -device hda-micro \ -drive if=virtio,file=/home/tux/vms/kvm/win7.img,media=disk \ -drive if=ide,file=/home/ani/Packages/iso/win7-sp0-x64.iso,media=cdrom \ -drive if=ide,file=/home/tux/vms/kvm/amdgfx.iso,media=cdrom \ -boot menu=on,splash=/home/tux/vms/kvm/boot480.jpg,splash-time=5000 \ -name win7 xrandr --output HDMI-1 --auto --primary --output DVI-I-1 --auto --left-of HDMI-1</code></pre></div><p>Those two usb devices are a usb thumbdrive and the mouse from my HTPC which I use whenever something goes wrong.</p><p><a href="http://a.pomf.se/ompmum.jpg" rel="nofollow">guest system specs</a></p> <p class="postedit"><em>Last edited by ebinmaymay (2014-06-22 09:23:40)</em></p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1428666">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1428917" class="blockpost rowodd"> <h2><span><span class="conr">#2186</span> <a href="viewtopic.php?pid=1428917#p1428917">2014-06-22 21:30:53</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=82966">mdm</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2014-06-22</span></dd> <dd><span>Posts: 3</span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <p>I have been working through getting this setup on my laptop.&#160; I am at the point now where I just get a black screen when booting up my virtual machine.&#160; Here are my laptop specs:</p><p>Sager np8250<br />CPU: i7-4800MQ w/ HD 4600<br />MB Chipset: HM87<br />GPU: GTX 780M using Optimus</p><p>Before I get into more troubleshooting, is it possible to even use the GTX 780M with the pass through since it is on a laptop with Optimus?</p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1428917">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1429026" class="blockpost roweven"> <h2><span><span class="conr">#2187</span> <a href="viewtopic.php?pid=1429026#p1429026">2014-06-23 05:12:29</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=79578">AKSN74</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd class="postavatar"><img src="https://bbs.archlinux.org/img/avatars/79578.jpg?m=1423108340" width="80" height="80" alt="" /></dd> <dd><span>From: Taichung, Taiwan</span></dd> <dd><span>Registered: 2014-02-18</span></dd> <dd><span>Posts: 52</span></dd> <dd class="usercontacts"><span class="email"><a href="mailto:missile0407@gmail.com">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>mdm wrote:</cite><blockquote><div><p>I have been working through getting this setup on my laptop.&#160; I am at the point now where I just get a black screen when booting up my virtual machine.&#160; Here are my laptop specs:</p><p>Sager np8250<br />CPU: i7-4800MQ w/ HD 4600<br />MB Chipset: HM87<br />GPU: GTX 780M using Optimus</p><p>Before I get into more troubleshooting, is it possible to even use the GTX 780M with the pass through since it is on a laptop with Optimus?</p></div></blockquote></div><p>I think it is impossible, because NVIDIA GPU /w Optimus doesn&#039;t have any independent layout.<br />All video layout from GTX780M connected to HD4600.</p><p>You can&#039;t get any output unless GTX780M got independent output.</p><p>Or maybe you can try the previous post that someone mount his Tesla GPU into VM.</p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1429026">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1429075" class="blockpost rowodd"> <h2><span><span class="conr">#2188</span> <a href="viewtopic.php?pid=1429075#p1429075">2014-06-23 10:06:22</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=82901">rakataka</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2014-06-19</span></dd> <dd><span>Posts: 4</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=82901">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <p>Hi, I have been running Windows 8 64bit with an Nvidia GTX 770 successfully for some time now. In the qemu command parameter for the VGA card (-device) I do *not* specify the romfile sub-parameter as suggested in the 1st post and it works seemingly fine. Does anyone know why the romfile parameter is suggested or what it accomplishes?</p><p>My qemu command is:</p><div class="codebox"><pre><code>qemu-system-x86_64 -name Windows-8.1-Pro -enable-kvm -machine q35,accel=kvm -m 8192 -cpu Haswell,hv_relaxed,hv_vapic,hv_spinlocks=0x1000,hv_time -smp 3,sockets=1,cores=3,threads=1 -bios /usr/share/qemu/bios.bin -balloon none -serial none -parallel none -device ioh3420,bus=pcie.0,addr=1c.0,multifunction=on,port=1,chassis=1,id=root.1 -device virtio-scsi-pci,id=scsi -drive file=/mnt/windows-8.1.img,id=disk,format=raw -device ide-hd,bus=ide.0,unit=0,drive=disk -boot menu=on -device vfio-pci,host=01:00.0,bus=root.1,addr=00.0,multifunction=on,x-vga=on -device vfio-pci,host=01:00.1,bus=root.1,addr=00.1 -vga none -net none --monitor stdio -device qxl</code></pre></div> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1429075">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1429185" class="blockpost roweven"> <h2><span><span class="conr">#2189</span> <a href="viewtopic.php?pid=1429185#p1429185">2014-06-23 15:47:19</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=75590">aw</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2013-10-04</span></dd> <dd><span>Posts: 921</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=75590">Email</a></span> <span class="website"><a href="http://vfio.blogspot.com/" rel="nofollow">Website</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>rakataka wrote:</cite><blockquote><div><p>Hi, I have been running Windows 8 64bit with an Nvidia GTX 770 successfully for some time now. In the qemu command parameter for the VGA card (-device) I do *not* specify the romfile sub-parameter as suggested in the 1st post and it works seemingly fine. Does anyone know why the romfile parameter is suggested or what it accomplishes?</p></div></blockquote></div><p>The romfile parameter is only necessary if you cannot reliably read the ROM from the device.&#160; This may also be necessary in cases where the VGABIOS is not provided via a PCI ROM on the host, such as might be the case on a laptop.&#160; The effect of using romfile is simply that we read the ROM from the file instead of the device.&#160; Since the original instructions were written we&#039;ve refactored a lot of the VFIO ROM code and added bus resets, so ROM access should be much more reliable than it once was.</p> </div> <div class="postsignature postmsg"><hr /><p><a href="http://vfio.blogspot.com" rel="nofollow">http://vfio.blogspot.com</a><br />Looking for a more open forum to discuss vfio related uses?&#160; Try <a href="https://www.redhat.com/mailman/listinfo/vfio-users" rel="nofollow">https://www.redhat.com/mailman/listinfo/vfio-users</a></p></div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1429185">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1429221" class="blockpost rowodd"> <h2><span><span class="conr">#2190</span> <a href="viewtopic.php?pid=1429221#p1429221">2014-06-23 17:14:33</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=81541">belliash</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2014-04-25</span></dd> <dd><span>Posts: 16</span></dd> <dd class="usercontacts"><span class="email"><a href="mailto:belliash@asiotec.eu.org">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>mdm wrote:</cite><blockquote><div><p>I have been working through getting this setup on my laptop.&#160; I am at the point now where I just get a black screen when booting up my virtual machine.&#160; Here are my laptop specs:</p><p>Sager np8250<br />CPU: i7-4800MQ w/ HD 4600<br />MB Chipset: HM87<br />GPU: GTX 780M using Optimus</p><p>Before I get into more troubleshooting, is it possible to even use the GTX 780M with the pass through since it is on a laptop with Optimus?</p></div></blockquote></div><p>Install Windows (8 preferrably) using additional emulated VGA like currus or vmware. Then install nvidia drivers and check if it will be working, or if you get error 43.<br />If you got error 43, check if disabling and re-enablig nvidia card helps.</p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1429221">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1429519" class="blockpost roweven"> <h2><span><span class="conr">#2191</span> <a href="viewtopic.php?pid=1429519#p1429519">2014-06-24 10:03:28</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=60514">ttouch</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>From: /dev/null</span></dd> <dd><span>Registered: 2012-05-27</span></dd> <dd><span>Posts: 129</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=60514">Email</a></span> <span class="website"><a href="http://dzervas.gr" rel="nofollow">Website</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <p>Hello,</p><p>After kernel update (linux-mainline provided), I recompiled nvidia-beta-al and started the VM and I get this: `device vfio-pci,host=02:00.0,bus=root.1,addr=00.0,multifunction=on,x-vga=on: VFIO 0000:02:00.0 BAR 0 mmap unsupported. Performance may be slow` and no output. Any help please?<br />BTW: I had to also attach 02:00.1 to avoid an iommu_group error.</p><p>Thank you.</p> </div> <div class="postsignature postmsg"><hr /><p><a href="http://github.com/ttouch" rel="nofollow">GitHub</a> | <a href="http://git.dzervas.gr" rel="nofollow">Git Server</a> | <a href="http://dzervas.gr" rel="nofollow">Blog</a></p></div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1429519">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1429541" class="blockpost rowodd"> <h2><span><span class="conr">#2192</span> <a href="viewtopic.php?pid=1429541#p1429541">2014-06-24 11:23:59</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=82784">penetal</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2014-06-15</span></dd> <dd><span>Posts: 10</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=82784">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <p>I&#039;m stuck on black screen from the passed through VGA card. So here&#039;s what I got, and where I&#039;m stuck:</p><p>Spec:</p><ul><li><p>ASRock z97 Extreme 6</p></li><li><p>Intel i7 4970 /w HD4600 (main gpu)</p></li><li><p>Gainwind Phantom Nvidia GTX680 (secondary gpu)</p></li></ul><p>I followed the 1st post and installed the mainline kernel from the package linked there:</p><div class="codebox"><pre><code>3.15.1-1-mainline</code></pre></div><p>Packages come from pacman&#039;s repos, so standard qemu, seabios and the likes.</p><p>My Nvidia card:</p><div class="codebox"><pre><code>% lspci |grep -i nvidia :( 01:00.0 VGA compatible controller: NVIDIA Corporation GK104 [GeForce GTX 680] (rev a1) 01:00.1 Audio device: NVIDIA Corporation GK104 HDMI Audio Controller (rev a1)</code></pre></div><div class="codebox"><pre><code>% lspci -n |grep 01:00 01:00.0 0300: 10de:1180 (rev a1) 01:00.1 0403: 10de:0e0a (rev a1)</code></pre></div><p>Current boot command:</p><div class="codebox"><pre><code>BOOT_IMAGE=/rootvol/boot/vmlinuz-linux-mainline root=UUID=341a7e57-91cb-480c-be5f-2eb405ffd658 rw rootflags=subvol=rootvol intel_iommu=on pci-stub.ids=10de:1180,10de:0e0a quiet</code></pre></div><p>Modprobes:</p><div class="codebox"><pre><code>% cat /etc/modprobe.d/blacklist.conf /etc/modprobe.d/kvm.conf /etc/modprobe.d/vfio_iommu_type.conf blacklist nouveau options kvm ignore_msrs=1 options vfio_iommu_type1 allow_unsafe_interrupts=1</code></pre></div><p>Configs for scripts from 1st post (I run vfio-bind.sh manually before I start VMs):</p><div class="codebox"><pre><code>% cat /etc/vfio-pci.cfg DEVICES=&quot;0000:01:00.0 000:01:00.1&quot;</code></pre></div><div class="codebox"><pre><code>% cat vfio-bind.sh #!/bin/sh vfio-bind 0000:01:00.0 0000:01:00.1</code></pre></div><p>Qemu VM:</p><div class="codebox"><pre><code>% cat StartWindowsVm1.sh #!/bin/sh qemu-system-x86_64 -enable-kvm -M q35 -m 10240 -cpu host \ -smp 4,sockets=1,cores=4,threads=1 \ -bios /usr/share/qemu/bios.bin \ -vga none \ -device ioh3420,bus=pcie.0,addr=1c.0,multifunction=on,port=1,chassis=1,id=root.1 \ -device vfio-pci,host=01:00.0,bus=root.1,addr=0.0,multifunction=on,x-vga=on \ -device vfio-pci,host=01:00.1,bus=root.1,addr=0.1 \ -boot menu=on</code></pre></div><p>Dmesg output when starting VM:</p><div class="codebox"><pre><code>[Jun24 12:54] vfio-pci 0000:01:00.0: enabling device (0000 -&gt; 0003) [ +0.000132] vfio_ecap_init: 0000:01:00.0 hiding ecap 0x19@0x900 [ +4.085762] [drm:intel_uncore_check_errors] *ERROR* Unclaimed register before interrupt [ +0.000040] [drm:intel_uncore_check_errors] *ERROR* Unclaimed register before interrupt [ +0.000008] [drm:intel_uncore_check_errors] *ERROR* Unclaimed register before interrupt [ +0.000010] [drm:intel_uncore_check_errors] *ERROR* Unclaimed register before interrupt [ +2.106266] [drm:intel_uncore_check_errors] *ERROR* Unclaimed register before interrupt</code></pre></div><p>In the Qemu window not much appear, some sort of qemu menu shows up if I activate the window and press a key.<br />On the external monitor nothing happens at all (connected through DVI -&gt; VGA, but also tried via HDMI with same &quot;non-result&quot;).<br />If I active KVM integrated gpu and boot windows the GTX680 card shows up in device manager with error 12, where it says the device needs more ressources.</p><p>I&#039;m not sure where to tweak to get the ball rolling, any ideas?</p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1429541">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1429557" class="blockpost roweven"> <h2><span><span class="conr">#2193</span> <a href="viewtopic.php?pid=1429557#p1429557">2014-06-24 12:28:52</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=70922">nbhs</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd class="postavatar"><img src="https://bbs.archlinux.org/img/avatars/70922.jpg?m=1367773811" width="80" height="80" alt="" /></dd> <dd><span>From: Montevideo, Uruguay</span></dd> <dd><span>Registered: 2013-05-02</span></dd> <dd><span>Posts: 402</span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>penetal wrote:</cite><blockquote><div><p>I&#039;m stuck on black screen from the passed through VGA card. So here&#039;s what I got, and where I&#039;m stuck:</p><p>Spec:</p><ul><li><p>ASRock z97 Extreme 6</p></li><li><p>Intel i7 4970 /w HD4600 (main gpu)</p></li><li><p>Gainwind Phantom Nvidia GTX680 (secondary gpu)</p></li></ul><p>I followed the 1st post and installed the mainline kernel from the package linked there:</p><div class="codebox"><pre><code>3.15.1-1-mainline</code></pre></div><p>Packages come from pacman&#039;s repos, so standard qemu, seabios and the likes.</p><p>My Nvidia card:</p><div class="codebox"><pre><code>% lspci |grep -i nvidia :( 01:00.0 VGA compatible controller: NVIDIA Corporation GK104 [GeForce GTX 680] (rev a1) 01:00.1 Audio device: NVIDIA Corporation GK104 HDMI Audio Controller (rev a1)</code></pre></div><div class="codebox"><pre><code>% lspci -n |grep 01:00 01:00.0 0300: 10de:1180 (rev a1) 01:00.1 0403: 10de:0e0a (rev a1)</code></pre></div><p>Current boot command:</p><div class="codebox"><pre><code>BOOT_IMAGE=/rootvol/boot/vmlinuz-linux-mainline root=UUID=341a7e57-91cb-480c-be5f-2eb405ffd658 rw rootflags=subvol=rootvol intel_iommu=on pci-stub.ids=10de:1180,10de:0e0a quiet</code></pre></div><p>Modprobes:</p><div class="codebox"><pre><code>% cat /etc/modprobe.d/blacklist.conf /etc/modprobe.d/kvm.conf /etc/modprobe.d/vfio_iommu_type.conf blacklist nouveau options kvm ignore_msrs=1 options vfio_iommu_type1 allow_unsafe_interrupts=1</code></pre></div><p>Configs for scripts from 1st post (I run vfio-bind.sh manually before I start VMs):</p><div class="codebox"><pre><code>% cat /etc/vfio-pci.cfg DEVICES=&quot;0000:01:00.0 000:01:00.1&quot;</code></pre></div><div class="codebox"><pre><code>% cat vfio-bind.sh #!/bin/sh vfio-bind 0000:01:00.0 0000:01:00.1</code></pre></div><p>Qemu VM:</p><div class="codebox"><pre><code>% cat StartWindowsVm1.sh #!/bin/sh qemu-system-x86_64 -enable-kvm -M q35 -m 10240 -cpu host \ -smp 4,sockets=1,cores=4,threads=1 \ -bios /usr/share/qemu/bios.bin \ -vga none \ -device ioh3420,bus=pcie.0,addr=1c.0,multifunction=on,port=1,chassis=1,id=root.1 \ -device vfio-pci,host=01:00.0,bus=root.1,addr=0.0,multifunction=on,x-vga=on \ -device vfio-pci,host=01:00.1,bus=root.1,addr=0.1 \ -boot menu=on</code></pre></div><p>Dmesg output when starting VM:</p><div class="codebox"><pre><code>[Jun24 12:54] vfio-pci 0000:01:00.0: enabling device (0000 -&gt; 0003) [ +0.000132] vfio_ecap_init: 0000:01:00.0 hiding ecap 0x19@0x900 [ +4.085762] [drm:intel_uncore_check_errors] *ERROR* Unclaimed register before interrupt [ +0.000040] [drm:intel_uncore_check_errors] *ERROR* Unclaimed register before interrupt [ +0.000008] [drm:intel_uncore_check_errors] *ERROR* Unclaimed register before interrupt [ +0.000010] [drm:intel_uncore_check_errors] *ERROR* Unclaimed register before interrupt [ +2.106266] [drm:intel_uncore_check_errors] *ERROR* Unclaimed register before interrupt</code></pre></div><p>In the Qemu window not much appear, some sort of qemu menu shows up if I activate the window and press a key.<br />On the external monitor nothing happens at all (connected through DVI -&gt; VGA, but also tried via HDMI with same &quot;non-result&quot;).<br />If I active KVM integrated gpu and boot windows the GTX680 card shows up in device manager with error 12, where it says the device needs more ressources.</p><p>I&#039;m not sure where to tweak to get the ball rolling, any ideas?</p></div></blockquote></div><p>You need to boot with i915.enable_hd_vgaarb=1 as a kernel parameter</p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1429557">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1429570" class="blockpost rowodd"> <h2><span><span class="conr">#2194</span> <a href="viewtopic.php?pid=1429570#p1429570">2014-06-24 14:01:28</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=82784">penetal</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2014-06-15</span></dd> <dd><span>Posts: 10</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=82784">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>nbhs wrote:</cite><blockquote><div><div class="quotebox"><cite>penetal wrote:</cite><blockquote><div><p>I&#039;m stuck on black screen from the passed through VGA card. So here&#039;s what I got, and where I&#039;m stuck:</p><p>Spec:</p><ul><li><p>ASRock z97 Extreme 6</p></li><li><p>Intel i7 4970 /w HD4600 (main gpu)</p></li></ul><br /><p><strong>...</strong></p><br /><p>Dmesg output when starting VM:</p><div class="codebox"><pre><code>[Jun24 12:54] vfio-pci 0000:01:00.0: enabling device (0000 -&gt; 0003) [ +0.000132] vfio_ecap_init: 0000:01:00.0 hiding ecap 0x19@0x900 [ +4.085762] [drm:intel_uncore_check_errors] *ERROR* Unclaimed register before interrupt [ +0.000040] [drm:intel_uncore_check_errors] *ERROR* Unclaimed register before interrupt [ +0.000008] [drm:intel_uncore_check_errors] *ERROR* Unclaimed register before interrupt [ +0.000010] [drm:intel_uncore_check_errors] *ERROR* Unclaimed register before interrupt [ +2.106266] [drm:intel_uncore_check_errors] *ERROR* Unclaimed register before interrupt</code></pre></div><p>In the Qemu window not much appear, some sort of qemu menu shows up if I activate the window and press a key.<br />On the external monitor nothing happens at all (connected through DVI -&gt; VGA, but also tried via HDMI with same &quot;non-result&quot;).<br />If I active KVM integrated gpu and boot windows the GTX680 card shows up in device manager with error 12, where it says the device needs more ressources.</p><p>I&#039;m not sure where to tweak to get the ball rolling, any ideas?</p></div></blockquote></div><p>You need to boot with i915.enable_hd_vgaarb=1 as a kernel parameter</p></div></blockquote></div><p>Thanks, that got me right up and running.<br />I assume you/someone has already said this some other place in the thread but honnestly it&#039;s getting a bit too big to find everything.<br />Might be usefull in the OP&#039;s 1st post if its necessary for every Intel install.</p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1429570">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1429584" class="blockpost roweven"> <h2><span><span class="conr">#2195</span> <a href="viewtopic.php?pid=1429584#p1429584">2014-06-24 14:59:37</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=82784">penetal</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2014-06-15</span></dd> <dd><span>Posts: 10</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=82784">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <p>Seems I&#039;m stuck again.<br />Now at least I do get output from the card to the screen, so its halfways working.<br />The problem is windows won&#039;t &quot;acitvely&quot; use the card,<br />it has the yellow triangle of fuckery in device manager and report error code 43.</p><p>Searching seems to give little insight, has anyone at all been able to solve this problem?</p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1429584">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1429601" class="blockpost rowodd"> <h2><span><span class="conr">#2196</span> <a href="viewtopic.php?pid=1429601#p1429601">2014-06-24 15:49:25</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=70922">nbhs</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd class="postavatar"><img src="https://bbs.archlinux.org/img/avatars/70922.jpg?m=1367773811" width="80" height="80" alt="" /></dd> <dd><span>From: Montevideo, Uruguay</span></dd> <dd><span>Registered: 2013-05-02</span></dd> <dd><span>Posts: 402</span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>penetal wrote:</cite><blockquote><div><p>Seems I&#039;m stuck again.<br />Now at least I do get output from the card to the screen, so its halfways working.<br />The problem is windows won&#039;t &quot;acitvely&quot; use the card,<br />it has the yellow triangle of fuckery in device manager and report error code 43.</p><p>Searching seems to give little insight, has anyone at all been able to solve this problem?</p></div></blockquote></div><p>I believe there are some problems with the lastest nvidia drivers, there&#039;s a discussion about this a few pages back</p> <p class="postedit"><em>Last edited by nbhs (2014-06-24 15:50:48)</em></p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1429601">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1429690" class="blockpost roweven"> <h2><span><span class="conr">#2197</span> <a href="viewtopic.php?pid=1429690#p1429690">2014-06-24 19:56:34</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=82900">MCMjolnir</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2014-06-19</span></dd> <dd><span>Posts: 9</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=82900">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>belliash wrote:</cite><blockquote><div><p>If you got error 43, check if disabling and re-enabling nvidia card helps.</p></div></blockquote></div><p>I tried that (I used <a href="http://blog.ktz.me/?p=219" rel="nofollow">this guide</a> to automate it), and while it does get rid of the error code and the drivers show up correctly in device manager, for all other intents and purposes the card is still unusable. It doesn&#039;t detect the monitor I have plugged into it and&#160; I have to reinstall the drivers on every VM boot through GeForce Experience before I can do anything within it (even though Device Manager says the drivers are installed already), and after that it produces some weird results, with some fields&#160; &#160; ⃠ ed out. </p><p><a href="https://i.imgur.com/xNFWgcZ.png" rel="nofollow">Screenshot of GeForce Experience + Device Manager</a></p><p>I&#039;m using Xeons (so no iGPU) with the host running headless with a GTX 770 assigned to a VM. I&#039;m not sure if that means I need to use any of the patches.</p> <p class="postedit"><em>Last edited by MCMjolnir (2014-06-24 19:58:57)</em></p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1429690">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1429694" class="blockpost rowodd"> <h2><span><span class="conr">#2198</span> <a href="viewtopic.php?pid=1429694#p1429694">2014-06-24 19:59:37</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=75590">aw</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2013-10-04</span></dd> <dd><span>Posts: 921</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=75590">Email</a></span> <span class="website"><a href="http://vfio.blogspot.com/" rel="nofollow">Website</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>MCMjolnir wrote:</cite><blockquote><div><div class="quotebox"><cite>belliash wrote:</cite><blockquote><div><p>If you got error 43, check if disabling and re-enabling nvidia card helps.</p></div></blockquote></div><p>I tried that (I used <a href="http://blog.ktz.me/?p=219" rel="nofollow">this guide</a> to automate it), and while it does get rid of the error code and the drivers show up correctly in device manager, for all other intents and purposes the card is still unusable. It doesn&#039;t detect the monitor I have plugged into it and&#160; I have to reinstall the drivers on every VM boot through GeForce Experience before I can do anything within it (even though Device Manager says the drivers are installed already), and after that it produces some weird results, with some fields&#160; &#160; ⃠ ed out. <br />I&#039;m using Xeons (so no iGPU) with the host running headless with a GTX 770 assigned to a VM. I&#039;m not sure if that means I need to use any of the patches.</p></div></blockquote></div><p>Use qemu.git and add kvm=off to your -cpu options or downgrade the guest driver to 335.23.</p> </div> <div class="postsignature postmsg"><hr /><p><a href="http://vfio.blogspot.com" rel="nofollow">http://vfio.blogspot.com</a><br />Looking for a more open forum to discuss vfio related uses?&#160; Try <a href="https://www.redhat.com/mailman/listinfo/vfio-users" rel="nofollow">https://www.redhat.com/mailman/listinfo/vfio-users</a></p></div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1429694">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1429699" class="blockpost roweven"> <h2><span><span class="conr">#2199</span> <a href="viewtopic.php?pid=1429699#p1429699">2014-06-24 20:06:04</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=82784">penetal</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2014-06-15</span></dd> <dd><span>Posts: 10</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=82784">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <p>Well as a small update. I got it working, but I have no idea why.</p><p>I was about to try to downgrade the nvidia driver, but before I started the VM I did two small changes that I can remember:</p><ul><li><p>I passed through my keyboard aswell so I had both keyboard and mouse in the VM while its running.</p></li><li><p>And I switched input on my screen form DisplayPort (main intel gpu) to HDMI (nvidia) instead of just using PBP (Picture Beside Picture: both inputs at the same time with alot of wasted screen space going to black bars all done by the monitor), this shouldnt make any difference but I cant beleive that adding keyboard makes any difference either.</p></li></ul><p>So I dont know why the error in Device Manager just disapeared, but I&#039;m not sad it did.</p><p>Anyway I downgraded to an older driver and installed the graphics driver and physix engine (no 3D or audio drivers from nvidia pack was installed), and after that I ran 3Dmark. Got a lower score than native windows, so next step is gonna be to make it all more user friendly + optimizing for performance.</p><p><strong>IT WORKS! WOHO!</strong></p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1429699">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1429720" class="blockpost rowodd"> <h2><span><span class="conr">#2200</span> <a href="viewtopic.php?pid=1429720#p1429720">2014-06-24 20:33:34</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=81541">belliash</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2014-04-25</span></dd> <dd><span>Posts: 16</span></dd> <dd class="usercontacts"><span class="email"><a href="mailto:belliash@asiotec.eu.org">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>MCMjolnir wrote:</cite><blockquote><div><div class="quotebox"><cite>belliash wrote:</cite><blockquote><div><p>If you got error 43, check if disabling and re-enabling nvidia card helps.</p></div></blockquote></div><p>I tried that (I used <a href="http://blog.ktz.me/?p=219" rel="nofollow">this guide</a> to automate it), and while it does get rid of the error code and the drivers show up correctly in device manager, for all other intents and purposes the card is still unusable. It doesn&#039;t detect the monitor I have plugged into it and&#160; I have to reinstall the drivers on every VM boot through GeForce Experience before I can do anything within it (even though Device Manager says the drivers are installed already), and after that it produces some weird results, with some fields&#160; &#160; ⃠ ed out. </p><p><a href="https://i.imgur.com/xNFWgcZ.png" rel="nofollow">Screenshot of GeForce Experience + Device Manager</a></p><p>I&#039;m using Xeons (so no iGPU) with the host running headless with a GTX 770 assigned to a VM. I&#039;m not sure if that means I need to use any of the patches.</p></div></blockquote></div><p>Thats very interesting, as you have exactly the same problem, except I encounter this on notebook, while you got &quot;normal PC&quot;.<br />Thats pretty interesting, why others managed to get GTX 770 working - at least from desktop family. If we find a solution here, it might be step forward in getting mobile cards fully working too.</p><br /><p>I&#039;m also looking forward to hearing that anyone tried to pass through mobile radeon, as AMD cards seems to be less problematic than manufactured by nvidia.<br />Another idea is to try XEN instead of KVM. Especially as XEN supports mediated GPU. This means that laptop owners could pass through both nvidia/amd card as well as intel igp (4th gen cpu only).<br />I&#039;m not sure how this behaves, but if Windows and forceware detects Intel HD Card, nvidia software should be able to copy video buffer to igp, therefore we would get optimus working in VM.<br />Shame it needs IGP and nvidia doesnt seem to let its technology work with other GPUs. Shame, as we could get optimus working with emulated cirrus/vmware cards.</p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1429720">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div class="postlinksb"> <div class="inbox crumbsplus"> <div class="pagepost"> <p class="pagelink conl"><span class="pages-label">Pages: </span><a rel="prev" class="item1" href="viewtopic.php?id=162768&amp;p=87">Previous</a> <a href="viewtopic.php?id=162768">1</a> <span class="spacer">…</span> <a href="viewtopic.php?id=162768&amp;p=86">86</a> <a href="viewtopic.php?id=162768&amp;p=87">87</a> <strong>88</strong> <a href="viewtopic.php?id=162768&amp;p=89">89</a> <a href="viewtopic.php?id=162768&amp;p=90">90</a> <span class="spacer">…</span> <a href="viewtopic.php?id=162768&amp;p=234">234</a> <a rel="next" href="viewtopic.php?id=162768&amp;p=89">Next</a></p> <p class="postlink conr">Topic closed</p> </div> <ul class="crumbs"> <li><a href="index.php">Index</a></li> <li><span>»&#160;</span><a href="viewforum.php?id=48">Topics Going Nowhere</a></li> <li><span>»&#160;</span><strong><a href="viewtopic.php?id=162768">KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</a></strong></li> </ul> <p class="subscribelink clearb"><a href="misc.php?action=subscribe&amp;tid=162768">Subscribe to this topic</a></p> <div class="clearer"></div> </div> </div> </div> <div id="brdfooter" class="block"> <h2><span>Board footer</span></h2> <div class="box"> <div id="brdfooternav" class="inbox"> <div class="conl"> <form id="qjump" method="get" action="viewforum.php"> <div><label><span>Jump to<br /></span> <select name="id" onchange="window.location=('viewforum.php?id='+this.options[this.selectedIndex].value)"> <optgroup label="Technical Issues and Assistance"> <option value="23">Newbie Corner</option> <option value="17">Installation</option> <option value="22">Kernel &amp; Hardware</option> <option value="18">Applications &amp; Desktop Environments</option> <option value="31">Laptop Issues</option> <option value="8">Networking, Server, and Protection</option> <option value="32">Multimedia and Games</option> <option value="50">System Administration</option> <option value="35">Other Architectures</option> </optgroup> <optgroup label="Arch-centric"> <option value="24">Announcements, Package &amp; Security Advisories</option> <option value="1">Arch Discussion</option> <option value="13">Forum &amp; Wiki discussion</option> </optgroup> <optgroup label="Pacman Upgrades, Packaging &amp; AUR"> <option value="44">Pacman &amp; Package Upgrade Issues</option> <option value="49">[testing] Repo Forum</option> <option value="4">Creating &amp; Modifying Packages</option> <option value="38">AUR Issues, Discussion &amp; PKGBUILD Requests</option> </optgroup> <optgroup label="Contributions &amp; Discussion"> <option value="20">GNU/Linux Discussion</option> <option value="27">Community Contributions</option> <option value="33">Programming &amp; Scripting</option> <option value="30">Other Languages</option> <option value="47">Artwork and Screenshots</option> <option value="42">Try This</option> </optgroup> <optgroup label="/dev/null"> <option value="29">Off-Topic</option> <option value="48" selected="selected">Topics Going Nowhere</option> <option value="36">Dustbin</option> </optgroup> </select></label> <input type="submit" value=" Go " accesskey="g" /> </div> </form> </div> <div class="conr"> <p id="feedlinks"><span class="atom"><a href="extern.php?action=feed&amp;tid=162768&amp;type=atom">Atom topic feed</a></span></p> <p id="poweredby">Powered by <a href="http://fluxbb.org/">FluxBB</a></p> </div> <div class="clearer"></div> </div> </div> </div> </div> <div class="end-box"></div> </div> </body> </html>
