<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"> <html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en" dir="ltr"> <head> <meta http-equiv="Content-Type" content="text/html; charset=utf-8" /> <title>KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9 (Page 112) / Topics Going Nowhere / Arch Linux Forums</title> <link rel="stylesheet" type="text/css" href="style/ArchLinux.css" /> <link rel="canonical" href="viewtopic.php?id=162768&amp;p=112" title="Page 112" /> <link rel="prev" href="viewtopic.php?id=162768&amp;p=111" title="Page 111" /> <link rel="next" href="viewtopic.php?id=162768&amp;p=113" title="Page 113" /> <link rel="alternate" type="application/atom+xml" href="extern.php?action=feed&amp;tid=162768&amp;type=atom" title="Atom topic feed" /> <link rel="stylesheet" media="screen" href="style/ArchLinux/arch.css?v=3" /> <link rel="stylesheet" media="screen" href="style/ArchLinux/archnavbar.css?v=2" /> <link rel="shortcut icon" href="style/ArchLinux/favicon.ico" /> </head> <body> <div id="archnavbar" class="anb-forum"> <div id="archnavbarlogo"><h1><a href="http://www.archlinux.org/">Arch Linux</a></h1></div> <div id="archnavbarmenu"> <ul id="archnavbarlist"> <li id="anb-home"><a href="http://www.archlinux.org/">Home</a></li><li id="anb-packages"><a href="http://www.archlinux.org/packages/">Packages</a></li><li id="anb-forums" class="anb-selected"><a href="https://bbs.archlinux.org/">Forums</a></li><li id="anb-wiki"><a href="https://wiki.archlinux.org/">Wiki</a></li><li id="anb-bugs"><a href="https://bugs.archlinux.org/">Bugs</a></li><li id="anb-aur"><a href="https://aur.archlinux.org/">AUR</a></li><li id="anb-download"><a href="http://www.archlinux.org/download/">Download</a></li> </ul> </div> </div> <div id="punviewtopic" class="pun"> <div class="top-box"></div> <div class="punwrap"> <div id="brdheader" class="block"> <div class="box"> <div id="brdmenu" class="inbox"> <ul> <li id="navindex" class="isactive"><a href="index.php">Index</a></li> <li id="navuserlist"><a href="userlist.php">User list</a></li> <li id="navsearch"><a href="search.php">Search</a></li> <li id="navprofile"><a href="profile.php?id=80749">Profile</a></li> <li id="navlogout"><a href="login.php?action=out&amp;id=80749&amp;csrf_token=5c20501ec397bb45ef8ee8c84db232c8d8e421c6">Logout</a></li> </ul> </div> <div id="brdwelcome" class="inbox"> <ul class="conl"> <li><span>Logged in as <strong>SXX</strong></span></li> <li><span>Last visit: 2015-08-16 12:20:09</span></li> </ul> <ul class="conr"> <li><span>Topics: <a href="search.php?action=show_replies" title="Find topics you have posted to.">Posted</a> | <a href="search.php?action=show_new" title="Find topics with new posts since your last visit.">New</a> | <a href="search.php?action=show_recent" title="Find topics with recent posts.">Active</a> | <a href="search.php?action=show_unanswered" title="Find topics with no replies.">Unanswered</a></span></li> </ul> <div class="clearer"></div> </div> </div> </div> <div id="brdmain"> <div class="linkst"> <div class="inbox crumbsplus"> <ul class="crumbs"> <li><a href="index.php">Index</a></li> <li><span>»&#160;</span><a href="viewforum.php?id=48">Topics Going Nowhere</a></li> <li><span>»&#160;</span><strong><a href="viewtopic.php?id=162768">KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</a></strong></li> </ul> <div class="pagepost"> <p class="pagelink conl"><span class="pages-label">Pages: </span><a rel="prev" class="item1" href="viewtopic.php?id=162768&amp;p=111">Previous</a> <a href="viewtopic.php?id=162768">1</a> <span class="spacer">…</span> <a href="viewtopic.php?id=162768&amp;p=110">110</a> <a href="viewtopic.php?id=162768&amp;p=111">111</a> <strong>112</strong> <a href="viewtopic.php?id=162768&amp;p=113">113</a> <a href="viewtopic.php?id=162768&amp;p=114">114</a> <span class="spacer">…</span> <a href="viewtopic.php?id=162768&amp;p=234">234</a> <a rel="next" href="viewtopic.php?id=162768&amp;p=113">Next</a></p> <p class="postlink conr">Topic closed</p> </div> <div class="clearer"></div> </div> </div> <div id="p1458666" class="blockpost rowodd blockpost1"> <h2><span><span class="conr">#2776</span> <a href="viewtopic.php?pid=1458666#p1458666">2014-09-20 13:29:55</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=75590">aw</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2013-10-04</span></dd> <dd><span>Posts: 921</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=75590">Email</a></span> <span class="website"><a href="http://vfio.blogspot.com/" rel="nofollow">Website</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>stokbaek wrote:</cite><blockquote><div><p>Hello,</p><p>I have been trying to get this VGA Passthrough to work now for some time but seems like I am stuck now <img src="https://bbs.archlinux.org/img/smilies/sad.png" width="15" height="15" alt="sad" /></p></div></blockquote></div><p>Your kernel version indicates that you&#039;re attempting to use stock Ubuntu 13.04 and we can only assume stock QEMU from that release too.&#160; VGA assignment did not work at the time that release.&#160; I&#039;d suggest at least kernel 3.16 and QEMU 2.1, but you may still need patches beyond that depending on your host graphics.</p> </div> <div class="postsignature postmsg"><hr /><p><a href="http://vfio.blogspot.com" rel="nofollow">http://vfio.blogspot.com</a><br />Looking for a more open forum to discuss vfio related uses?&#160; Try <a href="https://www.redhat.com/mailman/listinfo/vfio-users" rel="nofollow">https://www.redhat.com/mailman/listinfo/vfio-users</a></p></div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1458666">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1458690" class="blockpost roweven"> <h2><span><span class="conr">#2777</span> <a href="viewtopic.php?pid=1458690#p1458690">2014-09-20 14:59:55</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=85250">stokbaek</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2014-09-20</span></dd> <dd><span>Posts: 3</span></dd> <dd class="usercontacts"><span class="email"><a href="mailto:stokbaek@gmail.com">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>aw wrote:</cite><blockquote><div><div class="quotebox"><cite>stokbaek wrote:</cite><blockquote><div><p>Hello,</p><p>I have been trying to get this VGA Passthrough to work now for some time but seems like I am stuck now <img src="https://bbs.archlinux.org/img/smilies/sad.png" width="15" height="15" alt="sad" /></p></div></blockquote></div><p>Your kernel version indicates that you&#039;re attempting to use stock Ubuntu 13.04 and we can only assume stock QEMU from that release too.&#160; VGA assignment did not work at the time that release.&#160; I&#039;d suggest at least kernel 3.16 and QEMU 2.1, but you may still need patches beyond that depending on your host graphics.</p></div></blockquote></div><p>Sorry forgot to mention kernel and QEMU version</p><p>uname -r</p><div class="codebox"><pre><code>3.9.3-030903-generic</code></pre></div><p>kvm -version</p><div class="codebox"><pre><code>QEMU emulator version 2.0.0 (Debian 2.0.0+dfsg-2ubuntu1.3), Copyright (c) 2003-2008 Fabrice Bellard</code></pre></div> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1458690">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1458713" class="blockpost rowodd"> <h2><span><span class="conr">#2778</span> <a href="viewtopic.php?pid=1458713#p1458713">2014-09-20 16:32:07</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=85254">0011001011</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2014-09-20</span></dd> <dd><span>Posts: 3</span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <p>Hi everybody, and thank you for this amazing thread ! I was able to make my virtual gaming machine and definitively erase my dualboot. I am almost free from windows (and with steam on linux things will only get better). Information on internet is not clear so I want to confirm that GTX 570 works well with VGA passthrough on HD4000 with CGI working on arch host (don&#039;t know why btw)/</p><p>However.. my guest sometimes violently crashes : impossible to boot and I have to restore it from a copy of last working raw.img, it seems to be caused by updates but dont know which one (300+ to check) on w7 64bits ultimate. I checked to disable driver integrity check and stuff, run a chkdsk bootrec and bcdedit but nothing works. Does anybody has a solution or plan of solution ? Impossible to debug since windows repair tool thinks that a number of things are broken, not only the boot (and I think it broke it itself while trying to repair)</p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1458713">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1458714" class="blockpost roweven"> <h2><span><span class="conr">#2779</span> <a href="viewtopic.php?pid=1458714#p1458714">2014-09-20 16:35:39</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=75590">aw</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2013-10-04</span></dd> <dd><span>Posts: 921</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=75590">Email</a></span> <span class="website"><a href="http://vfio.blogspot.com/" rel="nofollow">Website</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>0011001011 wrote:</cite><blockquote><div><p>Hi everybody, and thank you for this amazing thread ! I was able to make my virtual gaming machine and definitively erase my dualboot. I am almost free from windows (and with steam on linux things will only get better). Information on internet is not clear so I want to confirm that GTX 570 works well with VGA passthrough on HD4000 with CGI working on arch host (don&#039;t know why btw)/</p><p>However.. my guest sometimes violently crashes : impossible to boot and I have to restore it from a copy of last working raw.img, it seems to be caused by updates but dont know which one (300+ to check) on w7 64bits ultimate. I checked to disable driver integrity check and stuff, run a chkdsk bootrec and bcdedit but nothing works. Does anybody has a solution or plan of solution ? Impossible to debug since windows repair tool thinks that a number of things are broken, not only the boot (and I think it broke it itself while trying to repair)</p></div></blockquote></div><p>Are you running virtio or AHCI for the guest disk?&#160; Q35 or 440FX?&#160; virtio + 440FX are likely to be the best performing and best supported combo.</p> </div> <div class="postsignature postmsg"><hr /><p><a href="http://vfio.blogspot.com" rel="nofollow">http://vfio.blogspot.com</a><br />Looking for a more open forum to discuss vfio related uses?&#160; Try <a href="https://www.redhat.com/mailman/listinfo/vfio-users" rel="nofollow">https://www.redhat.com/mailman/listinfo/vfio-users</a></p></div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1458714">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1458720" class="blockpost rowodd"> <h2><span><span class="conr">#2780</span> <a href="viewtopic.php?pid=1458720#p1458720">2014-09-20 16:45:47</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=85254">0011001011</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2014-09-20</span></dd> <dd><span>Posts: 3</span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <p>Owh i didn&#039;t know about that, I use Q35 and for the disk I typed the following :</p><p>drive file=/home/sofian/vm/windows.img,id=disk,format=raw -device ide-hd,bus=ide.0,drive=disk</p><p>So I used q35.. I really thought it was superior to 440fx.<br />It might be uninteresting to notice but I never installed virtio driver for windows because I wanted to update the system first (and thought it would crash the system because it may change the device windows detect)</p> <p class="postedit"><em>Last edited by 0011001011 (2014-09-20 17:04:54)</em></p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1458720">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1458728" class="blockpost roweven"> <h2><span><span class="conr">#2781</span> <a href="viewtopic.php?pid=1458728#p1458728">2014-09-20 17:16:20</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=75590">aw</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2013-10-04</span></dd> <dd><span>Posts: 921</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=75590">Email</a></span> <span class="website"><a href="http://vfio.blogspot.com/" rel="nofollow">Website</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>0011001011 wrote:</cite><blockquote><div><p>Owh i didn&#039;t know about that, I use Q35 and for the disk I typed the following :</p><p>drive file=/home/sofian/vm/windows.img,id=disk,format=raw -device ide-hd,bus=ide.0,drive=disk</p><p>So I used q35.. I really thought it was superior to 440fx.<br />It might be uninteresting to notice but I never installed virtio driver for windows because I wanted to update the system first (and thought it would crash the system because it may change the device windows detect)</p></div></blockquote></div><p>You can find an example of a 440FX+virtio config <a href="http://vfio.blogspot.com/2014/08/dual-vga-assignment-geforce-radeon.html" rel="nofollow">here</a></p><p>For installation to virtio you can configure the VM with 2 CD images, the second being the virtio ISO image you can find <a href="https://alt.fedoraproject.org/pub/alt/virtio-win/latest/images/bin/" rel="nofollow">here</a>.&#160; When discovering the disk the Windows installer will prompt to load external drivers.&#160; It&#039;s also recommended to use virtio for the NIC rather than an emulated device.</p><p>Q35 is largely overrated.&#160; There are some configurations of Linux that need it, but Windows is fine on 440FX.</p> <p class="postedit"><em>Last edited by aw (2014-09-20 17:16:44)</em></p> </div> <div class="postsignature postmsg"><hr /><p><a href="http://vfio.blogspot.com" rel="nofollow">http://vfio.blogspot.com</a><br />Looking for a more open forum to discuss vfio related uses?&#160; Try <a href="https://www.redhat.com/mailman/listinfo/vfio-users" rel="nofollow">https://www.redhat.com/mailman/listinfo/vfio-users</a></p></div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1458728">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1458735" class="blockpost rowodd"> <h2><span><span class="conr">#2782</span> <a href="viewtopic.php?pid=1458735#p1458735">2014-09-20 17:40:25</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=85254">0011001011</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2014-09-20</span></dd> <dd><span>Posts: 3</span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <p>Right I will test it right now and try my 5th win installation (love you SSDs)</p><p>I know that vrtio is better for NIC however i was not using it, I already have a dedicated wifi PCi card but it disturb iommu at boot.<br />So you think Q35 and drivers might be the explanation of these crashes ? In fact I absolutely don&#039;t know why win update fail at some point. Assuming that it is the root of the error.</p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1458735">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1458763" class="blockpost roweven"> <h2><span><span class="conr">#2783</span> <a href="viewtopic.php?pid=1458763#p1458763">2014-09-20 19:10:45</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=79899">winie</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2014-03-01</span></dd> <dd><span>Posts: 17</span></dd> <dd class="usercontacts"><span class="email"><a href="mailto:alireza4051@yahoo.com">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>aw wrote:</cite><blockquote><div><div class="quotebox"><cite>aw wrote:</cite><blockquote><div><p>So... just happened to get an update for Nvidia 344.11... Code 43 again <img src="https://bbs.archlinux.org/img/smilies/sad.png" width="15" height="15" alt="sad" /></p><p>I have no words...</p></div></blockquote></div><p>&quot;bluebird&quot; reported on oftc/#qemu that 344.11 is now checking hyper-v extensions, so if you remove all those hv-foo cpu parameters and leave kvm=off, 344.11 works.&#160; I&#039;ve confirmed this on my VM.&#160; Unfortunately some of those hypver-v extensions are fairly useful and have shown to help performance, so NVIDIA appears to be intentionally crippling GeForce, possibly to make Quadro appear to be a better choice for a VM (as if official support isn&#039;t enough).&#160; NVIDIA already seems to disable MSI on GeForce, so it&#039;s not the first time GeForce has been intentionally crippled to boost the professional cards.</p></div></blockquote></div><p>After 4 months I tried vga passthrough again and succeeded this time and now this happens&#160; :X</p><p>What were they thinking? disabling the product i own? <img src="https://bbs.archlinux.org/img/smilies/mad.png" width="15" height="15" alt="mad" /> <img src="https://bbs.archlinux.org/img/smilies/mad.png" width="15" height="15" alt="mad" /><br />I will make it my mission to find a way to get back at them!</p><p>Do you think it can be solved like the kvm flag check or we can no more use hyper-v enlightments?</p><p>by the way my setup: i5-4670, Asrock Z87 Extreme4, 2x MSI Geforce 770<br />i hope i can make an awesome permanent setup. using onboard vga for xbmc mediacenter, one 770 for my little brother, one vm with 770 for me streamed&#160; to my tablet, and automatic tiered storage in the virtual machines</p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1458763">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1458843" class="blockpost rowodd"> <h2><span><span class="conr">#2784</span> <a href="viewtopic.php?pid=1458843#p1458843">2014-09-21 01:20:25</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=69685">Chetyre</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2013-03-27</span></dd> <dd><span>Posts: 34</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=69685">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <p>I made the switch from legacy VGA to libvirt + OVMF and I report success with some small issues.</p><p>My card (Sapphire 7970 Vapor-X) didn&#039;t have UEFI, so I flashed it with the Sapphire x280 Vapor-X bios (basically the same card, but it has UEFI). I left it like that for a week to see if I&#039;d run into any problems and I didn&#039;t.</p><p>So today I set it up with OVMF (libvirt-git, ovmf-svn) and I got it to boot and work, but only as a secondary passthrough. Even if I remove the video devices I still don&#039;t get any output before windows loads the AMD drivers </p><p>Also, I need to use the audio device on the card because it is how I take sound to the TV, but it is crackling and lagging. It didn&#039;t do that before on legacy. And when I tried to play a game the card was stuttering in places where it didn&#039;t before.</p><p>Here is my xml:</p><div class="codebox"><pre class="vscroll"><code>&lt;domain type=&#039;kvm&#039;&gt; &lt;name&gt;windows&lt;/name&gt; &lt;uuid&gt;298e3f5f-1546-424c-b8f8-1225241eb5d0&lt;/uuid&gt; &lt;memory unit=&#039;KiB&#039;&gt;16777216&lt;/memory&gt; &lt;currentMemory unit=&#039;KiB&#039;&gt;16777216&lt;/currentMemory&gt; &lt;memoryBacking&gt; &lt;hugepages/&gt; &lt;/memoryBacking&gt; &lt;vcpu placement=&#039;static&#039;&gt;6&lt;/vcpu&gt; &lt;os&gt; &lt;type arch=&#039;x86_64&#039; machine=&#039;pc-i440fx-2.1&#039;&gt;hvm&lt;/type&gt; &lt;loader type=&#039;pflash&#039;&gt;/var/lib/libvirt/images/ovmf_x64.bin&lt;/loader&gt; &lt;/os&gt; &lt;features&gt; &lt;acpi/&gt; &lt;apic/&gt; &lt;pae/&gt; &lt;hyperv&gt; &lt;relaxed state=&#039;on&#039;/&gt; &lt;vapic state=&#039;on&#039;/&gt; &lt;spinlocks state=&#039;on&#039; retries=&#039;8191&#039;/&gt; &lt;/hyperv&gt; &lt;/features&gt; &lt;cpu mode=&#039;host-passthrough&#039;&gt; &lt;topology sockets=&#039;1&#039; cores=&#039;3&#039; threads=&#039;2&#039;/&gt; &lt;/cpu&gt; &lt;clock offset=&#039;localtime&#039;&gt; &lt;timer name=&#039;rtc&#039; tickpolicy=&#039;catchup&#039;/&gt; &lt;timer name=&#039;pit&#039; tickpolicy=&#039;delay&#039;/&gt; &lt;timer name=&#039;hpet&#039; present=&#039;no&#039;/&gt; &lt;timer name=&#039;hypervclock&#039; present=&#039;yes&#039;/&gt; &lt;/clock&gt; &lt;on_poweroff&gt;destroy&lt;/on_poweroff&gt; &lt;on_reboot&gt;restart&lt;/on_reboot&gt; &lt;on_crash&gt;restart&lt;/on_crash&gt; &lt;pm&gt; &lt;suspend-to-mem enabled=&#039;no&#039;/&gt; &lt;suspend-to-disk enabled=&#039;no&#039;/&gt; &lt;/pm&gt; &lt;devices&gt; &lt;emulator&gt;/usr/sbin/qemu-system-x86_64&lt;/emulator&gt; &lt;disk type=&#039;block&#039; device=&#039;disk&#039;&gt; &lt;driver name=&#039;qemu&#039; type=&#039;raw&#039; cache=&#039;none&#039; io=&#039;native&#039;/&gt; &lt;source dev=&#039;/dev/virtual-machines/windows&#039;/&gt; &lt;target dev=&#039;vda&#039; bus=&#039;virtio&#039;/&gt; &lt;boot order=&#039;2&#039;/&gt; &lt;address type=&#039;pci&#039; domain=&#039;0x0000&#039; bus=&#039;0x00&#039; slot=&#039;0x07&#039; function=&#039;0x0&#039;/&gt; &lt;/disk&gt; &lt;disk type=&#039;file&#039; device=&#039;disk&#039;&gt; &lt;driver name=&#039;qemu&#039; type=&#039;raw&#039;/&gt; &lt;source file=&#039;/home/lucas/media/windows.img&#039;/&gt; &lt;target dev=&#039;vdb&#039; bus=&#039;virtio&#039;/&gt; &lt;address type=&#039;pci&#039; domain=&#039;0x0000&#039; bus=&#039;0x00&#039; slot=&#039;0x0c&#039; function=&#039;0x0&#039;/&gt; &lt;/disk&gt; &lt;controller type=&#039;usb&#039; index=&#039;0&#039; model=&#039;ich9-ehci1&#039;&gt; &lt;address type=&#039;pci&#039; domain=&#039;0x0000&#039; bus=&#039;0x00&#039; slot=&#039;0x05&#039; function=&#039;0x7&#039;/&gt; &lt;/controller&gt; &lt;controller type=&#039;usb&#039; index=&#039;0&#039; model=&#039;ich9-uhci1&#039;&gt; &lt;master startport=&#039;0&#039;/&gt; &lt;address type=&#039;pci&#039; domain=&#039;0x0000&#039; bus=&#039;0x00&#039; slot=&#039;0x05&#039; function=&#039;0x0&#039; multifunction=&#039;on&#039;/&gt; &lt;/controller&gt; &lt;controller type=&#039;usb&#039; index=&#039;0&#039; model=&#039;ich9-uhci2&#039;&gt; &lt;master startport=&#039;2&#039;/&gt; &lt;address type=&#039;pci&#039; domain=&#039;0x0000&#039; bus=&#039;0x00&#039; slot=&#039;0x05&#039; function=&#039;0x1&#039;/&gt; &lt;/controller&gt; &lt;controller type=&#039;usb&#039; index=&#039;0&#039; model=&#039;ich9-uhci3&#039;&gt; &lt;master startport=&#039;4&#039;/&gt; &lt;address type=&#039;pci&#039; domain=&#039;0x0000&#039; bus=&#039;0x00&#039; slot=&#039;0x05&#039; function=&#039;0x2&#039;/&gt; &lt;/controller&gt; &lt;controller type=&#039;pci&#039; index=&#039;0&#039; model=&#039;pci-root&#039;/&gt; &lt;controller type=&#039;virtio-serial&#039; index=&#039;0&#039;&gt; &lt;address type=&#039;pci&#039; domain=&#039;0x0000&#039; bus=&#039;0x00&#039; slot=&#039;0x06&#039; function=&#039;0x0&#039;/&gt; &lt;/controller&gt; &lt;interface type=&#039;bridge&#039;&gt; &lt;mac address=&#039;52:54:00:5a:02:e8&#039;/&gt; &lt;source bridge=&#039;br0&#039;/&gt; &lt;model type=&#039;virtio&#039;/&gt; &lt;address type=&#039;pci&#039; domain=&#039;0x0000&#039; bus=&#039;0x00&#039; slot=&#039;0x03&#039; function=&#039;0x0&#039;/&gt; &lt;/interface&gt; &lt;serial type=&#039;pty&#039;&gt; &lt;target port=&#039;0&#039;/&gt; &lt;/serial&gt; &lt;console type=&#039;pty&#039;&gt; &lt;target type=&#039;serial&#039; port=&#039;0&#039;/&gt; &lt;/console&gt; &lt;input type=&#039;mouse&#039; bus=&#039;ps2&#039;/&gt; &lt;input type=&#039;keyboard&#039; bus=&#039;ps2&#039;/&gt; &lt;graphics type=&#039;spice&#039; autoport=&#039;yes&#039;/&gt; &lt;video&gt; &lt;model type=&#039;qxl&#039; ram=&#039;65536&#039; vram=&#039;65536&#039; heads=&#039;1&#039;/&gt; &lt;address type=&#039;pci&#039; domain=&#039;0x0000&#039; bus=&#039;0x00&#039; slot=&#039;0x0b&#039; function=&#039;0x0&#039;/&gt; &lt;/video&gt; &lt;hostdev mode=&#039;subsystem&#039; type=&#039;pci&#039; managed=&#039;yes&#039;&gt; &lt;source&gt; &lt;address domain=&#039;0x0000&#039; bus=&#039;0x04&#039; slot=&#039;0x00&#039; function=&#039;0x0&#039;/&gt; &lt;/source&gt; &lt;address type=&#039;pci&#039; domain=&#039;0x0000&#039; bus=&#039;0x00&#039; slot=&#039;0x0a&#039; function=&#039;0x0&#039;/&gt; &lt;/hostdev&gt; &lt;hostdev mode=&#039;subsystem&#039; type=&#039;pci&#039; managed=&#039;yes&#039;&gt; &lt;source&gt; &lt;address domain=&#039;0x0000&#039; bus=&#039;0x02&#039; slot=&#039;0x00&#039; function=&#039;0x0&#039;/&gt; &lt;/source&gt; &lt;address type=&#039;pci&#039; domain=&#039;0x0000&#039; bus=&#039;0x00&#039; slot=&#039;0x02&#039; function=&#039;0x0&#039;/&gt; &lt;/hostdev&gt; &lt;hostdev mode=&#039;subsystem&#039; type=&#039;pci&#039; managed=&#039;yes&#039;&gt; &lt;source&gt; &lt;address domain=&#039;0x0000&#039; bus=&#039;0x02&#039; slot=&#039;0x00&#039; function=&#039;0x1&#039;/&gt; &lt;/source&gt; &lt;address type=&#039;pci&#039; domain=&#039;0x0000&#039; bus=&#039;0x00&#039; slot=&#039;0x04&#039; function=&#039;0x0&#039;/&gt; &lt;/hostdev&gt; &lt;hostdev mode=&#039;subsystem&#039; type=&#039;pci&#039; managed=&#039;yes&#039;&gt; &lt;source&gt; &lt;address domain=&#039;0x0000&#039; bus=&#039;0x08&#039; slot=&#039;0x00&#039; function=&#039;0x0&#039;/&gt; &lt;/source&gt; &lt;address type=&#039;pci&#039; domain=&#039;0x0000&#039; bus=&#039;0x00&#039; slot=&#039;0x09&#039; function=&#039;0x0&#039;/&gt; &lt;/hostdev&gt; &lt;memballoon model=&#039;virtio&#039;&gt; &lt;address type=&#039;pci&#039; domain=&#039;0x0000&#039; bus=&#039;0x00&#039; slot=&#039;0x08&#039; function=&#039;0x0&#039;/&gt; &lt;/memballoon&gt; &lt;/devices&gt; &lt;/domain&gt;</code></pre></div> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1458843">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1458912" class="blockpost roweven"> <h2><span><span class="conr">#2785</span> <a href="viewtopic.php?pid=1458912#p1458912">2014-09-21 07:30:30</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=85266">kevinxucs</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2014-09-21</span></dd> <dd><span>Posts: 2</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=85266">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <p>For anyone who owns a Radeon HD 7850 (made by MSI), and having no output on Windows 8.1 after installing catalyst (or BSoD on Windows 7).</p><p>Try not passing through the HDMI audio controller inside the graphic card (address should be 01:00.1), it works for me.</p> <p class="postedit"><em>Last edited by kevinxucs (2014-09-21 07:53:59)</em></p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1458912">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1458940" class="blockpost rowodd"> <h2><span><span class="conr">#2786</span> <a href="viewtopic.php?pid=1458940#p1458940">2014-09-21 10:20:50</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=48315">TripleSpeeder</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2011-05-02</span></dd> <dd><span>Posts: 43</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=48315">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <p>Question on USB: <br />I have passed through one of my USB controllers, so all attached devices are directly recognized by the VM. This works fine for all kinds of devices, but one problem exists: It seems Seabios does not support USB keyboards, so I can not use the keyboard untill the VM has booted up. This is mostly not a problem, but I can&#039;t influence the boot process of Seabios (boot order etc.) and in case of unclean Windows guest shutdown I can&#039;t move the cursor in the &quot;start windows in safe mode or boot normally&quot;-screen...<br />I suspect this is a limitation of Seabios, but I did not find any confirmation on this. Any advice?</p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1458940">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1458948" class="blockpost roweven"> <h2><span><span class="conr">#2787</span> <a href="viewtopic.php?pid=1458948#p1458948">2014-09-21 10:58:53</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=78355">anickname</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2014-01-07</span></dd> <dd><span>Posts: 23</span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>TripleSpeeder wrote:</cite><blockquote><div><p>Question on USB: <br />I have passed through one of my USB controllers, so all attached devices are directly recognized by the VM. This works fine for all kinds of devices, but one problem exists: It seems Seabios does not support USB keyboards, so I can not use the keyboard untill the VM has booted up. This is mostly not a problem, but I can&#039;t influence the boot process of Seabios (boot order etc.) and in case of unclean Windows guest shutdown I can&#039;t move the cursor in the &quot;start windows in safe mode or boot normally&quot;-screen...<br />I suspect this is a limitation of Seabios, but I did not find any confirmation on this. Any advice?</p></div></blockquote></div><br /><p>Use : -bios bios-256k.bin</p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1458948">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1458955" class="blockpost rowodd"> <h2><span><span class="conr">#2788</span> <a href="viewtopic.php?pid=1458955#p1458955">2014-09-21 11:36:24</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=85070">Arakatak</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2014-09-12</span></dd> <dd><span>Posts: 4</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=85070">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <p>Seems like the problem in black screen after driver setup (VGA AMD R7 260x) is actually in lack of reset capability.<br />I got working passthrough with the following workarounds:<br />Passthrough only VGA, not its audio device<br />Cut power to VGA on every VM restart (possible with shutdown or suspend, not with reboot)</p><p>Thank you for all suggestions!</p><div class="quotebox"><cite>aw wrote:</cite><blockquote><div><p>Q35 is largely overrated.&#160; There are some configurations of Linux that need it, but Windows is fine on 440FX.</p></div></blockquote></div><p>Will you explain the advantages of Q35 over 440FX, please? I know that Q35 supports pci-e, and 440FX doesn&#039;t. Are there any performance penalties for passing through pci-e card to virtual pci bus?</p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1458955">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1458981" class="blockpost roweven"> <h2><span><span class="conr">#2789</span> <a href="viewtopic.php?pid=1458981#p1458981">2014-09-21 14:07:27</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=75590">aw</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2013-10-04</span></dd> <dd><span>Posts: 921</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=75590">Email</a></span> <span class="website"><a href="http://vfio.blogspot.com/" rel="nofollow">Website</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>Chetyre wrote:</cite><blockquote><div><p>I made the switch from legacy VGA to libvirt + OVMF and I report success with some small issues.</p><p>My card (Sapphire 7970 Vapor-X) didn&#039;t have UEFI, so I flashed it with the Sapphire x280 Vapor-X bios (basically the same card, but it has UEFI). I left it like that for a week to see if I&#039;d run into any problems and I didn&#039;t.</p><p>So today I set it up with OVMF (libvirt-git, ovmf-svn) and I got it to boot and work, but only as a secondary passthrough. Even if I remove the video devices I still don&#039;t get any output before windows loads the AMD drivers </p><p>Also, I need to use the audio device on the card because it is how I take sound to the TV, but it is crackling and lagging. It didn&#039;t do that before on legacy. And when I tried to play a game the card was stuttering in places where it didn&#039;t before.</p></div></blockquote></div><p>Hmm, the setup is a little suspect since we&#039;re using a ROM image from a different card, even though I agree they seem like they should be pretty much the same.&#160; Not getting any output until the driver loads sounds like the UEFI ROM isn&#039;t working.&#160; Maybe try <a href="https://dl.dropboxusercontent.com/u/19831938/OVMF-pure-efi.fd" rel="nofollow">this ovmf image</a>, which is just a copy of OVMF-pure-efi.fd from Gerd Hoffmann&#039;s Fedora build.&#160; Maybe your OVMF image includes the CSM and is trying to use the VGA BIOS, I don&#039;t know.</p> </div> <div class="postsignature postmsg"><hr /><p><a href="http://vfio.blogspot.com" rel="nofollow">http://vfio.blogspot.com</a><br />Looking for a more open forum to discuss vfio related uses?&#160; Try <a href="https://www.redhat.com/mailman/listinfo/vfio-users" rel="nofollow">https://www.redhat.com/mailman/listinfo/vfio-users</a></p></div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1458981">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1458988" class="blockpost rowodd"> <h2><span><span class="conr">#2790</span> <a href="viewtopic.php?pid=1458988#p1458988">2014-09-21 14:21:41</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=75590">aw</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2013-10-04</span></dd> <dd><span>Posts: 921</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=75590">Email</a></span> <span class="website"><a href="http://vfio.blogspot.com/" rel="nofollow">Website</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>Arakatak wrote:</cite><blockquote><div><div class="quotebox"><cite>aw wrote:</cite><blockquote><div><p>Q35 is largely overrated.&#160; There are some configurations of Linux that need it, but Windows is fine on 440FX.</p></div></blockquote></div><p>Will you explain the advantages of Q35 over 440FX, please? I know that Q35 supports pci-e, and 440FX doesn&#039;t. Are there any performance penalties for passing through pci-e card to virtual pci bus?</p></div></blockquote></div><p>Two things that Q35 does:</p><p>1) The guest PCI topology is closer to the host&#039;s.&#160; IOW, you can put your assigned graphics card functions behind an emulated root port.</p><p>2) It provides access to extended PCIe config space of the device.</p><p>AFAIK, 1) is the main reason it gets used, but the topology difference is largely FUD.&#160; There are some cases where Linux drivers find a PCIe device and assume they can poke the downstream port above it without testing whether it actually exists.&#160; If you&#039;re attempting to do SLI, it might also be useful since the docs seem to be rather particular about the topology of the hardware for that use case.</p><p>For everything else, I don&#039;t expect it makes much difference and I&#039;m not aware of any performance difference (if there is one, please share).&#160; Having a Q35 model does not enable any sort of link negotiation; the link registers on the root port is emulated and fixed.&#160; If anything I&#039;d be afraid that a negotiation would result in lowering the speed of the device to match the root port (but I assume that&#039;s not happening because then the device and physical root port would be out of sync and probably stop working altogether).&#160; The extended config space is potentially an area where there could be some added performance, manipulating the device IOTLB for instance, but I have doubts whether it&#039;s actually used and if it is, how well it works on Q35 anyway.</p> </div> <div class="postsignature postmsg"><hr /><p><a href="http://vfio.blogspot.com" rel="nofollow">http://vfio.blogspot.com</a><br />Looking for a more open forum to discuss vfio related uses?&#160; Try <a href="https://www.redhat.com/mailman/listinfo/vfio-users" rel="nofollow">https://www.redhat.com/mailman/listinfo/vfio-users</a></p></div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1458988">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1458998" class="blockpost roweven"> <h2><span><span class="conr">#2791</span> <a href="viewtopic.php?pid=1458998#p1458998">2014-09-21 15:16:53</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=48315">TripleSpeeder</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2011-05-02</span></dd> <dd><span>Posts: 43</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=48315">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>anickname wrote:</cite><blockquote><div><div class="quotebox"><cite>TripleSpeeder wrote:</cite><blockquote><div><p>Question on USB: <br />I have passed through one of my USB controllers, so all attached devices are directly recognized by the VM. This works fine for all kinds of devices, but one problem exists: It seems Seabios does not support USB keyboards, so I can not use the keyboard untill the VM has booted up. This is mostly not a problem, but I can&#039;t influence the boot process of Seabios (boot order etc.) and in case of unclean Windows guest shutdown I can&#039;t move the cursor in the &quot;start windows in safe mode or boot normally&quot;-screen...<br />I suspect this is a limitation of Seabios, but I did not find any confirmation on this. Any advice?</p></div></blockquote></div><br /><p>Use : -bios bios-256k.bin</p></div></blockquote></div><p>Cool, works <img src="https://bbs.archlinux.org/img/smilies/smile.png" width="15" height="15" alt="smile" /></p><p>If you are using libvirt to manage your VMs you need to </p><div class="codebox"><pre><code>virsh edit &lt;vmname&gt;</code></pre></div><p> and change the &quot;loader&quot; line to point to bios-256k.bin: </p><div class="codebox"><pre><code>... &lt;os&gt; &lt;type arch=&#039;x86_64&#039; machine=&#039;pc-q35-2.0&#039;&gt;hvm&lt;/type&gt; &lt;loader&gt;/usr/share/qemu/bios-256k.bin&lt;/loader&gt; &lt;bootmenu enable=&#039;yes&#039; timeout=&#039;3000&#039;/&gt; &lt;/os&gt; ...</code></pre></div><p>(At least I did not find a way to change this setting with the virt-manager GUI)</p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1458998">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1459007" class="blockpost rowodd"> <h2><span><span class="conr">#2792</span> <a href="viewtopic.php?pid=1459007#p1459007">2014-09-21 16:19:22</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=69685">Chetyre</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2013-03-27</span></dd> <dd><span>Posts: 34</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=69685">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>aw wrote:</cite><blockquote><div><div class="quotebox"><cite>Chetyre wrote:</cite><blockquote><div><p>I made the switch from legacy VGA to libvirt + OVMF and I report success with some small issues.</p><p>My card (Sapphire 7970 Vapor-X) didn&#039;t have UEFI, so I flashed it with the Sapphire x280 Vapor-X bios (basically the same card, but it has UEFI). I left it like that for a week to see if I&#039;d run into any problems and I didn&#039;t.</p><p>So today I set it up with OVMF (libvirt-git, ovmf-svn) and I got it to boot and work, but only as a secondary passthrough. Even if I remove the video devices I still don&#039;t get any output before windows loads the AMD drivers </p><p>Also, I need to use the audio device on the card because it is how I take sound to the TV, but it is crackling and lagging. It didn&#039;t do that before on legacy. And when I tried to play a game the card was stuttering in places where it didn&#039;t before.</p></div></blockquote></div><p>Hmm, the setup is a little suspect since we&#039;re using a ROM image from a different card, even though I agree they seem like they should be pretty much the same.&#160; Not getting any output until the driver loads sounds like the UEFI ROM isn&#039;t working.&#160; Maybe try <a href="https://dl.dropboxusercontent.com/u/19831938/OVMF-pure-efi.fd" rel="nofollow">this ovmf image</a>, which is just a copy of OVMF-pure-efi.fd from Gerd Hoffmann&#039;s Fedora build.&#160; Maybe your OVMF image includes the CSM and is trying to use the VGA BIOS, I don&#039;t know.</p></div></blockquote></div><br /><p>I have tried it just now, but it still didn&#039;t work. Still only showing an image when windows loads the driver.</p><p>But what really worries me is the performance issue, I tried it with Resident Evil 6 which shouldn&#039;t be a really demanding game for this card (and it wasn&#039;t when I was using qemu directly with legacy), but I couldn&#039;t even get it to the menu, it was rendering things at ~13 FPS.</p><p>Any idea on what may be wrong? I&#039;m thinking about just returning my setup to how it was (might keep the new bios though, it wasn&#039;t causing any problems).</p><p>EDIT: Ok... Afterburner says my GPU clock is at 300 MHz when the game starts. This might not be a passthrough problem afterall.</p> <p class="postedit"><em>Last edited by Chetyre (2014-09-21 16:27:09)</em></p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1459007">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1459247" class="blockpost roweven"> <h2><span><span class="conr">#2793</span> <a href="viewtopic.php?pid=1459247#p1459247">2014-09-22 12:19:50</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=85298">nose</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2014-09-22</span></dd> <dd><span>Posts: 3</span></dd> <dd class="usercontacts"><span class="email"><a href="mailto:felix-04@web.de">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <p>Hey i want to pass through my dual graphic card! (PowerColor HD6870X2, dualcore CrossFire)</p><p>i did everything as told in post #1,<br />but if i want to start a test VM with these settings:</p><div class="codebox"><pre><code># qemu-system-x86_64 -enable-kvm -M q35 -m 1024 -cpu host \ -smp 6,sockets=1,cores=6,threads=1 \ -bios /usr/share/qemu/bios.bin -vga none \ -device ioh3420,bus=pcie.0,addr=1c.0,multifunction=on,port=1,chassis=1,id=root.1 \ -device vfio-pci,host=03:00.0,bus=root.1,addr=00.0,multifunction=on,x-vga=on \ -device vfio-pci,host=04:00.0,bus=root.1,addr=00.0,multifunction=on,x-vga=on \ -device vfio-pci,host=04:00.1,bus=root.1,addr=00.1</code></pre></div><p>i get this error:</p><div class="codebox"><pre><code>qemu-system-x86_64: -device vfio-pci,host=03:00.0,bus=root.1,addr=00.0,multifunction=on: vfio: error opening /dev/vfio/1: No such file or directory qemu-system-x86_64: -device vfio-pci,host=03:00.0,bus=root.1,addr=00.0,multifunction=on: vfio: failed to get group 1 qemu-system-x86_64: -device vfio-pci,host=03:00.0,bus=root.1,addr=00.0,multifunction=on: Device initialization failed. qemu-system-x86_64: -device vfio-pci,host=03:00.0,bus=root.1,addr=00.0,multifunction=on: Device &#039;vfio-pci&#039; could not be initialized</code></pre></div><p><strong>Additional info:</strong> </p><div class="codebox"><pre><code>uname -r 3.16.0-1-mainline</code></pre></div><p> The patched one from post #1</p><p>pci groups:</p><div class="codebox"><pre class="vscroll"><code>sh ./lsgroup ### Group 0 ### 00:00.0 Host bridge: Intel Corporation Xeon E3-1200 v2/Ivy Bridge DRAM Controller (rev 09) ### Group 1 ### 00:01.0 PCI bridge: Intel Corporation Xeon E3-1200 v2/3rd Gen Core processor PCI Express Root Port (rev 09) 01:00.0 PCI bridge: Device 1fc8:0910 (rev 80) 02:08.0 PCI bridge: Device 1fc8:0810 02:09.0 PCI bridge: Device 1fc8:0890 03:00.0 Display controller: Advanced Micro Devices, Inc. [AMD/ATI] Barts XT [Radeon HD 6870] 04:00.0 VGA compatible controller: Advanced Micro Devices, Inc. [AMD/ATI] Barts XT [Radeon HD 6870] 04:00.1 Audio device: Advanced Micro Devices, Inc. [AMD/ATI] Barts HDMI Audio [Radeon HD 6800 Series] ### Group 2 ### 00:14.0 USB controller: Intel Corporation 7 Series/C210 Series Chipset Family USB xHCI Host Controller (rev 04) ### Group 3 ### 00:16.0 Communication controller: Intel Corporation 7 Series/C210 Series Chipset Family MEI Controller #1 (rev 04) ### Group 4 ### 00:1a.0 USB controller: Intel Corporation 7 Series/C210 Series Chipset Family USB Enhanced Host Controller #2 (rev 04) ### Group 5 ### 00:1b.0 Audio device: Intel Corporation 7 Series/C210 Series Chipset Family High Definition Audio Controller (rev 04) ### Group 6 ### 00:1c.0 PCI bridge: Intel Corporation 7 Series/C210 Series Chipset Family PCI Express Root Port 1 (rev c4) ### Group 7 ### 00:1c.1 PCI bridge: Intel Corporation 7 Series/C210 Series Chipset Family PCI Express Root Port 2 (rev c4) ### Group 8 ### 00:1c.2 PCI bridge: Intel Corporation 7 Series/C210 Series Chipset Family PCI Express Root Port 3 (rev c4) ### Group 9 ### 00:1c.4 PCI bridge: Intel Corporation 7 Series/C210 Series Chipset Family PCI Express Root Port 5 (rev c4) ### Group 10 ### 00:1d.0 USB controller: Intel Corporation 7 Series/C210 Series Chipset Family USB Enhanced Host Controller #1 (rev 04) ### Group 11 ### 00:1e.0 PCI bridge: Intel Corporation 82801 PCI Bridge (rev a4) ### Group 12 ### 00:1f.0 ISA bridge: Intel Corporation B75 Express Chipset LPC Controller (rev 04) 00:1f.2 SATA controller: Intel Corporation 7 Series/C210 Series Chipset Family 6-port SATA Controller [AHCI mode] (rev 04) 00:1f.3 SMBus: Intel Corporation 7 Series/C210 Series Chipset Family SMBus Controller (rev 04) ### Group 13 ### 05:00.0 Ethernet controller: Realtek Semiconductor Co., Ltd. RTL8111/8168/8411 PCI Express Gigabit Ethernet Controller (rev 01) ### Group 14 ### 06:00.0 SATA controller: ASMedia Technology Inc. ASM1062 Serial ATA Controller (rev 01) ### Group 15 ### 07:00.0 Ethernet controller: Realtek Semiconductor Co., Ltd. RTL8111/8168/8411 PCI Express Gigabit Ethernet Controller (rev 06) ### Group 16 ### 08:00.0 VGA compatible controller: NVIDIA Corporation G84 [GeForce 8600 GT] (rev a1)</code></pre></div><p>can anyone help me or tell me where to read?<br />regards!</p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1459247">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1459254" class="blockpost rowodd"> <h2><span><span class="conr">#2794</span> <a href="viewtopic.php?pid=1459254#p1459254">2014-09-22 12:44:25</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=84538">mauorrizze</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2014-08-22</span></dd> <dd><span>Posts: 17</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=84538">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <p>@nose, I can&#039;t tell how well the pass-through of a dual graphic card does work, but this error:</p><div class="quotebox"><cite>nose wrote:</cite><blockquote><div><div class="codebox"><pre><code>vfio: error opening /dev/vfio/1: No such file or directory</code></pre></div></div></blockquote></div><p>tells me that the vfio module might be missing. Look at the starting post, &quot;Binding a device to vfio-pci&quot;. Within the little script:</p><div class="codebox"><pre><code>modprobe vfio-pci</code></pre></div><p>But the rest of the script is important, too, to bind your graphics card(s) to the vfio driver.</p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1459254">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1459265" class="blockpost roweven"> <h2><span><span class="conr">#2795</span> <a href="viewtopic.php?pid=1459265#p1459265">2014-09-22 13:40:06</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=75590">aw</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2013-10-04</span></dd> <dd><span>Posts: 921</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=75590">Email</a></span> <span class="website"><a href="http://vfio.blogspot.com/" rel="nofollow">Website</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <p>Yes, what mauorrizze says, additionallly...</p><div class="quotebox"><cite>nose wrote:</cite><blockquote><div><p>Hey i want to pass through my dual graphic card! (PowerColor HD6870X2, dualcore CrossFire)</p><p>i did everything as told in post #1,<br />but if i want to start a test VM with these settings:</p><div class="codebox"><pre><code># qemu-system-x86_64 -enable-kvm -M q35 -m 1024 -cpu host \ -smp 6,sockets=1,cores=6,threads=1 \ -bios /usr/share/qemu/bios.bin -vga none \ -device ioh3420,bus=pcie.0,addr=1c.0,multifunction=on,port=1,chassis=1,id=root.1 \ -device vfio-pci,host=03:00.0,bus=root.1,addr=00.0,multifunction=on,x-vga=on \ -device vfio-pci,host=04:00.0,bus=root.1,addr=00.0,multifunction=on,x-vga=on \ -device vfio-pci,host=04:00.1,bus=root.1,addr=00.1</code></pre></div></div></blockquote></div><p>This is an invalid config, you&#039;re assigning both 3:00.0 and 4:00.0 to the same address on the guest.&#160; Also note that only one of the GPUs is identified as VGA (4:00.0), only that one should use x-vga.&#160; I would start with just the VGA GPU + audio (4:00.0 &amp; 4:00.1), bind 3:00.0 to vfio-pci, but don&#039;t expose it to the guest.&#160; See if you can get that working first.&#160; Then add the 2nd GPU.&#160; There are several ways you could expose it, the easiest might be to try to expose it as function 2 on the same device.&#160; You could also add a 2nd root port and expose it there.&#160; QEMU also has support for PCIe switches, so you could add an upstream switch port with 2 downstream ports, just like you have on real hardware and expose VGA+audio and GPU.</p><p>Now the bad news; there&#039;s a very real possibility that the switches on this card are designed to re-route DMA between the endpoints so that peer-to-peer DMA between the GPUs never leaves the card.&#160; That means the DMA might not be seen by the IOMMU and without ACS on the switches we don&#039;t have the ability to configure it for upstream forwarding.&#160; If that&#039;s the case, then the only way these devices could work in a VM is if all of their address ranges were identity mapped into the guest, which is not something we have any ability to do.&#160; Try it and see if it works, but know that it&#039;s a gamble.</p> </div> <div class="postsignature postmsg"><hr /><p><a href="http://vfio.blogspot.com" rel="nofollow">http://vfio.blogspot.com</a><br />Looking for a more open forum to discuss vfio related uses?&#160; Try <a href="https://www.redhat.com/mailman/listinfo/vfio-users" rel="nofollow">https://www.redhat.com/mailman/listinfo/vfio-users</a></p></div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1459265">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1459283" class="blockpost rowodd"> <h2><span><span class="conr">#2796</span> <a href="viewtopic.php?pid=1459283#p1459283">2014-09-22 14:27:46</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=85298">nose</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2014-09-22</span></dd> <dd><span>Posts: 3</span></dd> <dd class="usercontacts"><span class="email"><a href="mailto:felix-04@web.de">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <p>Thanks for your replay, mauorrizze, i fixed my scripts!</p><div class="quotebox"><cite>aw wrote:</cite><blockquote><div><p>Yes, what mauorrizze says, additionallly...</p><div class="quotebox"><cite>nose wrote:</cite><blockquote><div><p>Hey i want to pass through my dual graphic card! (PowerColor HD6870X2, dualcore CrossFire)</p><p>i did everything as told in post #1,<br />but if i want to start a test VM with these settings:</p><div class="codebox"><pre><code># qemu-system-x86_64 -enable-kvm -M q35 -m 1024 -cpu host \ -smp 6,sockets=1,cores=6,threads=1 \ -bios /usr/share/qemu/bios.bin -vga none \ -device ioh3420,bus=pcie.0,addr=1c.0,multifunction=on,port=1,chassis=1,id=root.1 \ -device vfio-pci,host=03:00.0,bus=root.1,addr=00.0,multifunction=on,x-vga=on \ -device vfio-pci,host=04:00.0,bus=root.1,addr=00.0,multifunction=on,x-vga=on \ -device vfio-pci,host=04:00.1,bus=root.1,addr=00.1</code></pre></div></div></blockquote></div><p>This is an invalid config, you&#039;re assigning both 3:00.0 and 4:00.0 to the same address on the guest.&#160; Also note that only one of the GPUs is identified as VGA (4:00.0), only that one should use x-vga.&#160; I would start with just the VGA GPU + audio (4:00.0 &amp; 4:00.1), bind 3:00.0 to vfio-pci, but don&#039;t expose it to the guest.&#160; See if you can get that working first.&#160; Then add the 2nd GPU.&#160; There are several ways you could expose it, the easiest might be to try to expose it as function 2 on the same device.&#160; You could also add a 2nd root port and expose it there.&#160; QEMU also has support for PCIe switches, so you could add an upstream switch port with 2 downstream ports, just like you have on real hardware and expose VGA+audio and GPU.</p><p>Now the bad news; there&#039;s a very real possibility that the switches on this card are designed to re-route DMA between the endpoints so that peer-to-peer DMA between the GPUs never leaves the card.&#160; That means the DMA might not be seen by the IOMMU and without ACS on the switches we don&#039;t have the ability to configure it for upstream forwarding.&#160; If that&#039;s the case, then the only way these devices could work in a VM is if all of their address ranges were identity mapped into the guest, which is not something we have any ability to do.&#160; Try it and see if it works, but know that it&#039;s a gamble.</p></div></blockquote></div><p>Tannks aw,<br />i tried what you said:</p><div class="codebox"><pre><code># qemu-system-x86_64 -enable-kvm -M q35 -m 1024 -cpu host \ &gt; -smp 6,sockets=1,cores=6,threads=1 \ &gt; -bios /usr/share/qemu/bios.bin -vga none \ &gt; -device ioh3420,bus=pcie.0,addr=1c.0,multifunction=on,port=1,chassis=1,id=root.1 \ &gt; -device vfio-pci,host=04:00.0,bus=root.1,multifunction=on,x-vga=on \ &gt; -device vfio-pci,host=04:00.1,bus=root.1</code></pre></div><p>gives me:</p><div class="codebox"><pre><code>qemu-system-x86_64: -device vfio-pci,host=04:00.0,bus=root.1,multifunction=on,x-vga=on: VFIO 0000:04:00.0 BAR 0 mmap unsupported. Performance may be slow</code></pre></div><p>and a QEMU console window! <img src="https://bbs.archlinux.org/img/smilies/smile.png" width="15" height="15" alt="smile" /> but sadly the screens attached to the passthoughed card just tun off and stay black.</p><p>but at least some vm starts.. <img src="https://bbs.archlinux.org/img/smilies/big_smile.png" width="15" height="15" alt="big_smile" /></p><p>aw, in Windows the card appears as two graphic cards, but only one appears to have connectors. And i have no idea if they redirect any DMA traffic.</p><br /><p><strong>UPDATE:</strong><br />still no luck to get the screen on the passtroughed card working...<br />i noticed that in the group of the graphiccard:</p><div class="codebox"><pre><code>.... .... ### Group 1 ### 00:01.0 PCI bridge: Intel Corporation Xeon E3-1200 v2/3rd Gen Core processor PCI Express Root Port (rev 09) 01:00.0 PCI bridge: Device 1fc8:0910 (rev 80) 02:08.0 PCI bridge: Device 1fc8:0810 02:09.0 PCI bridge: Device 1fc8:0890 03:00.0 Display controller: Advanced Micro Devices, Inc. [AMD/ATI] Barts XT [Radeon HD 6870] 04:00.0 VGA compatible controller: Advanced Micro Devices, Inc. [AMD/ATI] Barts XT [Radeon HD 6870] 04:00.1 Audio device: Advanced Micro Devices, Inc. [AMD/ATI] Barts HDMI Audio [Radeon HD 6800 Series] .... ....</code></pre></div><p>are alot of pci bridges which surely belong to the integrated second GPU and its Crossfire ability.<br />better view:</p><div class="codebox"><pre><code># lspci -t -[0000:00]-+-00.0 +-01.0-[01-04]----00.0-[02-04]--+-[0000:04]-+-00.0 | | \-00.1 | +-[0000:03]---00.0 | \-[0000:02]-+-08.0-[00]-- | \-09.0-[00]-- +-14.0 +-16.0 +-1a.0 +-1c.0-[05]----00.0 +-1c.1-[06]----00.0 +-1c.2-[07]----00.0 +-1c.4-[08]----00.0 +-1d.0 +-1e.0-[09]-- +-1f.0 +-1f.2 \-1f.3</code></pre></div><p>I tried to pass trough the whole group, but i get errors for example:</p><div class="codebox"><pre><code>-device vfio-pci,host=01:00.0,bus=root.1: vfio: Assignment of PCIe type 0x5 devices is not currently supported</code></pre></div><p>i dont want to buy a new graphiccard <img src="https://bbs.archlinux.org/img/smilies/sad.png" width="15" height="15" alt="sad" /></p><p>if anybody has suggestions, feel free!</p> <p class="postedit"><em>Last edited by nose (2014-09-22 15:34:47)</em></p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1459283">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1459401" class="blockpost roweven"> <h2><span><span class="conr">#2797</span> <a href="viewtopic.php?pid=1459401#p1459401">2014-09-22 21:34:32</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=85314">Duelist</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2014-09-22</span></dd> <dd><span>Posts: 358</span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>nose wrote:</cite><blockquote><div><p>Thanks for your replay, mauorrizze, i fixed my scripts!</p><div class="quotebox"><cite>aw wrote:</cite><blockquote><div><p>Yes, what mauorrizze says, additionallly...</p><div class="quotebox"><cite>nose wrote:</cite><blockquote><div><p>Hey i want to pass through my dual graphic card! (PowerColor HD6870X2, dualcore CrossFire)</p><p>i did everything as told in post #1,<br />but if i want to start a test VM with these settings:</p><div class="codebox"><pre><code># qemu-system-x86_64 -enable-kvm -M q35 -m 1024 -cpu host \ -smp 6,sockets=1,cores=6,threads=1 \ -bios /usr/share/qemu/bios.bin -vga none \ -device ioh3420,bus=pcie.0,addr=1c.0,multifunction=on,port=1,chassis=1,id=root.1 \ -device vfio-pci,host=03:00.0,bus=root.1,addr=00.0,multifunction=on,x-vga=on \ -device vfio-pci,host=04:00.0,bus=root.1,addr=00.0,multifunction=on,x-vga=on \ -device vfio-pci,host=04:00.1,bus=root.1,addr=00.1</code></pre></div></div></blockquote></div><p>This is an invalid config, you&#039;re assigning both 3:00.0 and 4:00.0 to the same address on the guest.&#160; Also note that only one of the GPUs is identified as VGA (4:00.0), only that one should use x-vga.&#160; I would start with just the VGA GPU + audio (4:00.0 &amp; 4:00.1), bind 3:00.0 to vfio-pci, but don&#039;t expose it to the guest.&#160; See if you can get that working first.&#160; Then add the 2nd GPU.&#160; There are several ways you could expose it, the easiest might be to try to expose it as function 2 on the same device.&#160; You could also add a 2nd root port and expose it there.&#160; QEMU also has support for PCIe switches, so you could add an upstream switch port with 2 downstream ports, just like you have on real hardware and expose VGA+audio and GPU.</p><p>Now the bad news; there&#039;s a very real possibility that the switches on this card are designed to re-route DMA between the endpoints so that peer-to-peer DMA between the GPUs never leaves the card.&#160; That means the DMA might not be seen by the IOMMU and without ACS on the switches we don&#039;t have the ability to configure it for upstream forwarding.&#160; If that&#039;s the case, then the only way these devices could work in a VM is if all of their address ranges were identity mapped into the guest, which is not something we have any ability to do.&#160; Try it and see if it works, but know that it&#039;s a gamble.</p></div></blockquote></div><p>Tannks aw,<br />i tried what you said:</p><div class="codebox"><pre><code># qemu-system-x86_64 -enable-kvm -M q35 -m 1024 -cpu host \ &gt; -smp 6,sockets=1,cores=6,threads=1 \ &gt; -bios /usr/share/qemu/bios.bin -vga none \ &gt; -device ioh3420,bus=pcie.0,addr=1c.0,multifunction=on,port=1,chassis=1,id=root.1 \ &gt; -device vfio-pci,host=04:00.0,bus=root.1,multifunction=on,x-vga=on \ &gt; -device vfio-pci,host=04:00.1,bus=root.1</code></pre></div><p>gives me:</p><div class="codebox"><pre><code>qemu-system-x86_64: -device vfio-pci,host=04:00.0,bus=root.1,multifunction=on,x-vga=on: VFIO 0000:04:00.0 BAR 0 mmap unsupported. Performance may be slow</code></pre></div><p>and a QEMU console window! <img src="https://bbs.archlinux.org/img/smilies/smile.png" width="15" height="15" alt="smile" /> but sadly the screens attached to the passthoughed card just tun off and stay black.</p><p>but at least some vm starts.. <img src="https://bbs.archlinux.org/img/smilies/big_smile.png" width="15" height="15" alt="big_smile" /></p><p>aw, in Windows the card appears as two graphic cards, but only one appears to have connectors. And i have no idea if they redirect any DMA traffic.</p><br /><p><strong>UPDATE:</strong><br />still no luck to get the screen on the passtroughed card working...<br />i noticed that in the group of the graphiccard:</p><div class="codebox"><pre><code>.... .... ### Group 1 ### 00:01.0 PCI bridge: Intel Corporation Xeon E3-1200 v2/3rd Gen Core processor PCI Express Root Port (rev 09) 01:00.0 PCI bridge: Device 1fc8:0910 (rev 80) 02:08.0 PCI bridge: Device 1fc8:0810 02:09.0 PCI bridge: Device 1fc8:0890 03:00.0 Display controller: Advanced Micro Devices, Inc. [AMD/ATI] Barts XT [Radeon HD 6870] 04:00.0 VGA compatible controller: Advanced Micro Devices, Inc. [AMD/ATI] Barts XT [Radeon HD 6870] 04:00.1 Audio device: Advanced Micro Devices, Inc. [AMD/ATI] Barts HDMI Audio [Radeon HD 6800 Series] .... ....</code></pre></div><p>are alot of pci bridges which surely belong to the integrated second GPU and its Crossfire ability.<br />better view:</p><div class="codebox"><pre><code># lspci -t -[0000:00]-+-00.0 +-01.0-[01-04]----00.0-[02-04]--+-[0000:04]-+-00.0 | | \-00.1 | +-[0000:03]---00.0 | \-[0000:02]-+-08.0-[00]-- | \-09.0-[00]-- +-14.0 +-16.0 +-1a.0 +-1c.0-[05]----00.0 +-1c.1-[06]----00.0 +-1c.2-[07]----00.0 +-1c.4-[08]----00.0 +-1d.0 +-1e.0-[09]-- +-1f.0 +-1f.2 \-1f.3</code></pre></div><p>I tried to pass trough the whole group, but i get errors for example:</p><div class="codebox"><pre><code>-device vfio-pci,host=01:00.0,bus=root.1: vfio: Assignment of PCIe type 0x5 devices is not currently supported</code></pre></div><p>i dont want to buy a new graphiccard <img src="https://bbs.archlinux.org/img/smilies/sad.png" width="15" height="15" alt="sad" /></p><p>if anybody has suggestions, feel free!</p></div></blockquote></div><br /><p>&quot;BAR 0 mmap unsupported. Performance may be slow&quot;</p><p>Get lspci -vvnn, find your gpu, find it&#039;s region 10 memory range<br />It&#039;ll look something like this:</p><div class="codebox"><pre><code>01:00.0 VGA compatible controller [0300]: Advanced Micro Devices, Inc. [AMD/ATI] Cape Verde PRO [Radeon HD 7750 / R7 250E] [1002:683f] (prog-if 00 [VGA controller]) Subsystem: ASUSTeK Computer Inc. Device [1043:0459] Control: I/O- Mem- BusMaster- SpecCycle- MemWINV- VGASnoop- ParErr- Stepping- SERR- FastB2B- DisINTx+ Status: Cap+ 66MHz- UDF- FastB2B- ParErr- DEVSEL=fast &gt;TAbort- &lt;TAbort- &lt;MAbort- &gt;SERR- &lt;PERR- INTx- Interrupt: pin A routed to IRQ 18 Region 0: Memory at c0000000 (64-bit, prefetchable) [disabled] [size=256M] Region 2: Memory at fe300000 (64-bit, non-prefetchable) [disabled] [size=256K] Region 4: I/O ports at e000 [disabled] [size=256] Expansion ROM at fe340000 [disabled] [size=128K] Capabilities: &lt;access denied&gt; Kernel driver in use: vfio-pci Kernel modules: radeon</code></pre></div><p>Then, after acknowledging region 10 memory range, you go cat /proc/iomem<br />and look for that range, it&#039;ll look like this:</p><div class="codebox"><pre><code> c0000000-cfffffff : PCI Bus 0000:01 c0000000-cfffffff : 0000:01:00.0 AND HERE HIDES THE VESAFB!</code></pre></div><p>(i&#039;ve disabled vesa already)</p><p>I guess the GPU you&#039;re trying to pass is the first one in the system, and various uefi/bios output data on screen using it. Vesa does the same. Some motherboards have the option to change the default vga, but i don&#039;t have on, so...</p><p>To turn it off, assuming you have GRUB2:<br />edit /etc/default/grub<br />change GRUB_GFXPAYLOAD_LINUX=&quot;keep&quot; to &quot;text&quot;<br />and append nofb to GRUB_CMDLINE_LINUX=&quot;...&quot;<br />And then run grub2-mkconfig -o /boot/grub2/grub.cfg</p><p>Then reboot and check iomem again, vesa should be gone.</p><p>Vesa is the framebuffer, check the archwiki for more info on why you would or would not need it.</p><p>P.S. now there is two of us, trying to get crossfire working inside the vm.</p> <p class="postedit"><em>Last edited by Duelist (2014-09-22 21:36:23)</em></p> </div> <div class="postsignature postmsg"><hr /><p><span class="bbs">The forum rules prohibit requesting support for distributions other than arch.</span><br /><a href="https://bbs.archlinux.org/viewtopic.php?pid=1551460#p1551460" rel="nofollow">I gave up.</a><a href="https://bbs.archlinux.org/viewtopic.php?id=162768" rel="nofollow"> It was too late.</a><br /><a href="http://pastebin.com/B3fL84bq" rel="nofollow">What I was trying to do</a>.<br /><a href="http://vfio.blogspot.com/" rel="nofollow">The reference about VFIO and KVM VGA passthrough.</a></p></div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1459401">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1459476" class="blockpost rowodd"> <h2><span><span class="conr">#2798</span> <a href="viewtopic.php?pid=1459476#p1459476">2014-09-23 06:19:26</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=82238">sinny</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2014-05-24</span></dd> <dd><span>Posts: 75</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=82238">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <p>seems like no more nvidia for me (both for ideology and practical aspects)</p><p>gigabyte r7 240 working using ovmf (or at least seem to - will stick with win7/vga for now)</p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1459476">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1459822" class="blockpost roweven"> <h2><span><span class="conr">#2799</span> <a href="viewtopic.php?pid=1459822#p1459822">2014-09-24 09:30:15</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=48315">TripleSpeeder</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2011-05-02</span></dd> <dd><span>Posts: 43</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=48315">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <p>Can someone give a few pointer what benefits OVMF would give? I understand that it is basically providing an UEFI Bios to the VM, enabling stuff like secureboot etc. But if I have a working setup with the old Seabios - will using OVMF give me any advantage?</p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1459822">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1459824" class="blockpost rowodd"> <h2><span><span class="conr">#2800</span> <a href="viewtopic.php?pid=1459824#p1459824">2014-09-24 09:40:15</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=82238">sinny</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2014-05-24</span></dd> <dd><span>Posts: 75</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=82238">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>TripleSpeeder wrote:</cite><blockquote><div><p>Can someone give a few pointer what benefits OVMF would give? I understand that it is basically providing an UEFI Bios to the VM, enabling stuff like secureboot etc. But if I have a working setup with the old Seabios - will using OVMF give me any advantage?</p></div></blockquote></div><p>i wonder if you have actually read/understood anything at all...</p><p>it&#039;s gpu passthrough we are talking about here - not virtualising uefi boot process in general.<br />the core advantage ovmf gives is no vga legacy mess (kernel patching, etc).</p><p>p.s. i may be wrong here, but i really doubt anyone cares about secureboot (or any other weird stuff) when running 3d-accelerated vm.</p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1459824">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div class="postlinksb"> <div class="inbox crumbsplus"> <div class="pagepost"> <p class="pagelink conl"><span class="pages-label">Pages: </span><a rel="prev" class="item1" href="viewtopic.php?id=162768&amp;p=111">Previous</a> <a href="viewtopic.php?id=162768">1</a> <span class="spacer">…</span> <a href="viewtopic.php?id=162768&amp;p=110">110</a> <a href="viewtopic.php?id=162768&amp;p=111">111</a> <strong>112</strong> <a href="viewtopic.php?id=162768&amp;p=113">113</a> <a href="viewtopic.php?id=162768&amp;p=114">114</a> <span class="spacer">…</span> <a href="viewtopic.php?id=162768&amp;p=234">234</a> <a rel="next" href="viewtopic.php?id=162768&amp;p=113">Next</a></p> <p class="postlink conr">Topic closed</p> </div> <ul class="crumbs"> <li><a href="index.php">Index</a></li> <li><span>»&#160;</span><a href="viewforum.php?id=48">Topics Going Nowhere</a></li> <li><span>»&#160;</span><strong><a href="viewtopic.php?id=162768">KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</a></strong></li> </ul> <p class="subscribelink clearb"><a href="misc.php?action=subscribe&amp;tid=162768">Subscribe to this topic</a></p> <div class="clearer"></div> </div> </div> </div> <div id="brdfooter" class="block"> <h2><span>Board footer</span></h2> <div class="box"> <div id="brdfooternav" class="inbox"> <div class="conl"> <form id="qjump" method="get" action="viewforum.php"> <div><label><span>Jump to<br /></span> <select name="id" onchange="window.location=('viewforum.php?id='+this.options[this.selectedIndex].value)"> <optgroup label="Technical Issues and Assistance"> <option value="23">Newbie Corner</option> <option value="17">Installation</option> <option value="22">Kernel &amp; Hardware</option> <option value="18">Applications &amp; Desktop Environments</option> <option value="31">Laptop Issues</option> <option value="8">Networking, Server, and Protection</option> <option value="32">Multimedia and Games</option> <option value="50">System Administration</option> <option value="35">Other Architectures</option> </optgroup> <optgroup label="Arch-centric"> <option value="24">Announcements, Package &amp; Security Advisories</option> <option value="1">Arch Discussion</option> <option value="13">Forum &amp; Wiki discussion</option> </optgroup> <optgroup label="Pacman Upgrades, Packaging &amp; AUR"> <option value="44">Pacman &amp; Package Upgrade Issues</option> <option value="49">[testing] Repo Forum</option> <option value="4">Creating &amp; Modifying Packages</option> <option value="38">AUR Issues, Discussion &amp; PKGBUILD Requests</option> </optgroup> <optgroup label="Contributions &amp; Discussion"> <option value="20">GNU/Linux Discussion</option> <option value="27">Community Contributions</option> <option value="33">Programming &amp; Scripting</option> <option value="30">Other Languages</option> <option value="47">Artwork and Screenshots</option> <option value="42">Try This</option> </optgroup> <optgroup label="/dev/null"> <option value="29">Off-Topic</option> <option value="48" selected="selected">Topics Going Nowhere</option> <option value="36">Dustbin</option> </optgroup> </select></label> <input type="submit" value=" Go " accesskey="g" /> </div> </form> </div> <div class="conr"> <p id="feedlinks"><span class="atom"><a href="extern.php?action=feed&amp;tid=162768&amp;type=atom">Atom topic feed</a></span></p> <p id="poweredby">Powered by <a href="http://fluxbb.org/">FluxBB</a></p> </div> <div class="clearer"></div> </div> </div> </div> </div> <div class="end-box"></div> </div> </body> </html>
