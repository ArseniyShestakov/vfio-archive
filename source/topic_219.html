<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"> <html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en" dir="ltr"> <head> <meta http-equiv="Content-Type" content="text/html; charset=utf-8" /> <title>KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9 (Page 219) / Topics Going Nowhere / Arch Linux Forums</title> <link rel="stylesheet" type="text/css" href="style/ArchLinux.css" /> <link rel="canonical" href="viewtopic.php?id=162768&amp;p=219" title="Page 219" /> <link rel="prev" href="viewtopic.php?id=162768&amp;p=218" title="Page 218" /> <link rel="next" href="viewtopic.php?id=162768&amp;p=220" title="Page 220" /> <link rel="alternate" type="application/atom+xml" href="extern.php?action=feed&amp;tid=162768&amp;type=atom" title="Atom topic feed" /> <link rel="stylesheet" media="screen" href="style/ArchLinux/arch.css?v=3" /> <link rel="stylesheet" media="screen" href="style/ArchLinux/archnavbar.css?v=2" /> <link rel="shortcut icon" href="style/ArchLinux/favicon.ico" /> </head> <body> <div id="archnavbar" class="anb-forum"> <div id="archnavbarlogo"><h1><a href="http://www.archlinux.org/">Arch Linux</a></h1></div> <div id="archnavbarmenu"> <ul id="archnavbarlist"> <li id="anb-home"><a href="http://www.archlinux.org/">Home</a></li><li id="anb-packages"><a href="http://www.archlinux.org/packages/">Packages</a></li><li id="anb-forums" class="anb-selected"><a href="https://bbs.archlinux.org/">Forums</a></li><li id="anb-wiki"><a href="https://wiki.archlinux.org/">Wiki</a></li><li id="anb-bugs"><a href="https://bugs.archlinux.org/">Bugs</a></li><li id="anb-aur"><a href="https://aur.archlinux.org/">AUR</a></li><li id="anb-download"><a href="http://www.archlinux.org/download/">Download</a></li> </ul> </div> </div> <div id="punviewtopic" class="pun"> <div class="top-box"></div> <div class="punwrap"> <div id="brdheader" class="block"> <div class="box"> <div id="brdmenu" class="inbox"> <ul> <li id="navindex" class="isactive"><a href="index.php">Index</a></li> <li id="navuserlist"><a href="userlist.php">User list</a></li> <li id="navsearch"><a href="search.php">Search</a></li> <li id="navprofile"><a href="profile.php?id=80749">Profile</a></li> <li id="navlogout"><a href="login.php?action=out&amp;id=80749&amp;csrf_token=5c20501ec397bb45ef8ee8c84db232c8d8e421c6">Logout</a></li> </ul> </div> <div id="brdwelcome" class="inbox"> <ul class="conl"> <li><span>Logged in as <strong>SXX</strong></span></li> <li><span>Last visit: 2015-08-16 12:20:09</span></li> </ul> <ul class="conr"> <li><span>Topics: <a href="search.php?action=show_replies" title="Find topics you have posted to.">Posted</a> | <a href="search.php?action=show_new" title="Find topics with new posts since your last visit.">New</a> | <a href="search.php?action=show_recent" title="Find topics with recent posts.">Active</a> | <a href="search.php?action=show_unanswered" title="Find topics with no replies.">Unanswered</a></span></li> </ul> <div class="clearer"></div> </div> </div> </div> <div id="brdmain"> <div class="linkst"> <div class="inbox crumbsplus"> <ul class="crumbs"> <li><a href="index.php">Index</a></li> <li><span>»&#160;</span><a href="viewforum.php?id=48">Topics Going Nowhere</a></li> <li><span>»&#160;</span><strong><a href="viewtopic.php?id=162768">KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</a></strong></li> </ul> <div class="pagepost"> <p class="pagelink conl"><span class="pages-label">Pages: </span><a rel="prev" class="item1" href="viewtopic.php?id=162768&amp;p=218">Previous</a> <a href="viewtopic.php?id=162768">1</a> <span class="spacer">…</span> <a href="viewtopic.php?id=162768&amp;p=217">217</a> <a href="viewtopic.php?id=162768&amp;p=218">218</a> <strong>219</strong> <a href="viewtopic.php?id=162768&amp;p=220">220</a> <a href="viewtopic.php?id=162768&amp;p=221">221</a> <span class="spacer">…</span> <a href="viewtopic.php?id=162768&amp;p=234">234</a> <a rel="next" href="viewtopic.php?id=162768&amp;p=220">Next</a></p> <p class="postlink conr">Topic closed</p> </div> <div class="clearer"></div> </div> </div> <div id="p1540259" class="blockpost rowodd blockpost1"> <h2><span><span class="conr">#5451</span> <a href="viewtopic.php?pid=1540259#p1540259">2015-06-27 22:54:43</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=84760">Denso</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd class="postavatar"><img src="https://bbs.archlinux.org/img/avatars/84760.png?m=1412533733" width="71" height="80" alt="" /></dd> <dd><span>Registered: 2014-08-30</span></dd> <dd><span>Posts: 179</span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <p>@aw :</p><p>Thanks for taking the time to provide such information . You rock ! <img src="https://bbs.archlinux.org/img/smilies/smile.png" width="15" height="15" alt="smile" /></p><p>And yes , only K4s are single-slot <img src="https://bbs.archlinux.org/img/smilies/sad.png" width="15" height="15" alt="sad" /></p><p>Maybe Pascal would allow them to cram more power into the single-slot spec.</p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1540259">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1540456" class="blockpost roweven"> <h2><span><span class="conr">#5452</span> <a href="viewtopic.php?pid=1540456#p1540456">2015-06-28 19:34:44</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=85314">Duelist</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2014-09-22</span></dd> <dd><span>Posts: 358</span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>Denso wrote:</cite><blockquote><div><p>@Duelist :</p><p>I wish there were high-end single-slot GPUs . I want to virtualize all of the house&#039;s PCs , but I have no PCI-E slots remaining , because both of my GPUs are dual-slot .</p><p>Oh and I wish there were PCI-E lanes splitters or something . That would allow you to split 16x into 2 8x . and 8x into 2 4x .</p><p>Is that a Fractal Design Core 1000 ? That case used to huse my gaming rig before I virtualize it . <img src="https://bbs.archlinux.org/img/smilies/smile.png" width="15" height="15" alt="smile" /></p></div></blockquote></div><p><a href="http://www.cirrascale.com/blog/wp-content/uploads/2014/03/Cirrascale_Gen3_PCIe_Riser.jpg" rel="nofollow">http://www.cirrascale.com/blog/wp-conte … _Riser.jpg</a><br />If i only had pci-e 3.0, i&#039;d stuff my pc with cards like a real mad man.</p><p>The case is.. wait for it... GMC High Five why-the-hell-i-bought-it-in-the-first-place edition.<br />I&#039;m dreaming of some horizontal-mount case, but all i see is some server 4U cases, some CM HAF XB and some other company that made horizontal or &quot;flipped&quot;(io ports facing down or up) mounts for the motherboard. Because, obviously, all my GPUs are passively cooled, they would really be cooler if air convection worked the right way.</p><p>Well.. Risers will help you with your pci-e slots problem.<br />Buy something that has an insane amount of pci-e 16x slots and a bunch of regular risers. And a bunch of that cirrascale pieces of awesome, and... push the CPU&#039;s limit on pci-e lanes. My CPU supports up to 24 lanes, but there&#039;s no such motherboard.<br />And remember about the power supply - i&#039;m pushing my not so fresh 550 FSP to it&#039;s limit(if i will overclock my cpu and try to burn something on the dvd writer(which i occasionally have) while mining/bruteforcing something on the radeons and play quake on linux host, it&#039;ll rack up a total of 600W). Gladly, i have a soldering iron, an oscilloscope and a bunch of stuff to repair most of the electrical damage that may happen. I hope.</p><p>BTW, the &quot;splitter&quot;, afaik, is called a &quot;bridge&quot;. And yea, it really does split. Examine that cirrascale thingie, it&#039;s interesting.</p><br /><p><a href="http://vr-zone.com/uploads/14361/P1020933.jpg?4285f0" rel="nofollow">http://vr-zone.com/uploads/14361/P1020933.jpg?4285f0</a><br />That(or something else with less hilarious design). With that cirrascale things. 7x4=28 GPUs total. That would be insanely awesome.<br />But what if we go deeper and put that &quot;riser&quot; into it&#039;s clone, making 7 ports out of one?<br />I guess ACS and bridges and stuff would go batshit insane, but heck it&#039;d be awesome. The PC would look like some nuclear power plant, especially if the GPUs would be something Fiji-based with that huge water coolers.<br />Oh well, sweet insane dreams and fantasies.</p><br /><p>...whoa, that PLX PEX 8780 is 80-Lane, 20-Port PCI Express Gen 3 (8 GT/s) Switch. 80-lane. 20 port. Just wire it out right. I guess aw will shatter my dreams by saying that this switch doesn&#039;t do ACS or something else.</p><br /><br /><p>-- mod edit: read the Forum Etiquette and only post thumbnails <a href="http://wiki.archlinux.org/index.php/Forum_Etiquette#Pasting_Pictures_and_Code" rel="nofollow">http://wiki.archlinux.org/index.php/For … s_and_Code</a> [jwr] --</p> <p class="postedit"><em>Last edited by Duelist (2015-06-28 19:46:55)</em></p> </div> <div class="postsignature postmsg"><hr /><p><span class="bbs">The forum rules prohibit requesting support for distributions other than arch.</span><br /><a href="https://bbs.archlinux.org/viewtopic.php?pid=1551460#p1551460" rel="nofollow">I gave up.</a><a href="https://bbs.archlinux.org/viewtopic.php?id=162768" rel="nofollow"> It was too late.</a><br /><a href="http://pastebin.com/B3fL84bq" rel="nofollow">What I was trying to do</a>.<br /><a href="http://vfio.blogspot.com/" rel="nofollow">The reference about VFIO and KVM VGA passthrough.</a></p></div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1540456">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1540469" class="blockpost rowodd"> <h2><span><span class="conr">#5453</span> <a href="viewtopic.php?pid=1540469#p1540469">2015-06-28 20:07:44</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=75590">aw</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2013-10-04</span></dd> <dd><span>Posts: 921</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=75590">Email</a></span> <span class="website"><a href="http://vfio.blogspot.com/" rel="nofollow">Website</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>Duelist wrote:</cite><blockquote><div><p>...whoa, that PLX PEX 8780 is 80-Lane, 20-Port PCI Express Gen 3 (8 GT/s) Switch. 80-lane. 20 port. Just wire it out right. I guess aw will shatter my dreams by saying that this switch doesn&#039;t do ACS or something else.</p></div></blockquote></div><p>From the product brief:</p><p> PEX8780 Key Features<br />o Standards Compliant<br />- PCI Express Base Specification, r3.0<br />(compatible w/ PCIe r1.0a/1.1 &amp; 2.0)<br />- PCI Power Management Spec, r1.2<br />- Microsoft Windows Logo Compliant<br />- <strong>Supports Access Control Services</strong><br />- Dynamic link-width control<br />- Dynamic SerDes speed control</p><p>Kudos to PLX</p><p>Edit: GRID K1 &amp; K2 use PLX PEX 8747 and have proper ACS isolation.</p> <p class="postedit"><em>Last edited by aw (2015-06-28 20:13:01)</em></p> </div> <div class="postsignature postmsg"><hr /><p><a href="http://vfio.blogspot.com" rel="nofollow">http://vfio.blogspot.com</a><br />Looking for a more open forum to discuss vfio related uses?&#160; Try <a href="https://www.redhat.com/mailman/listinfo/vfio-users" rel="nofollow">https://www.redhat.com/mailman/listinfo/vfio-users</a></p></div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1540469">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1540528" class="blockpost roweven"> <h2><span><span class="conr">#5454</span> <a href="viewtopic.php?pid=1540528#p1540528">2015-06-29 00:11:14</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=84760">Denso</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd class="postavatar"><img src="https://bbs.archlinux.org/img/avatars/84760.png?m=1412533733" width="71" height="80" alt="" /></dd> <dd><span>Registered: 2014-08-30</span></dd> <dd><span>Posts: 179</span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <p>@ Duelist :</p><p>That&#039;s one nice post man !! My ASUS X99-E WS has 2 PLX 8747 bridges (7 Slots) and I&#039;m filling them up already .</p><p>Why don&#039;t you get a case like mine ? <img src="https://bbs.archlinux.org/img/smilies/wink.png" width="15" height="15" alt="wink" /></p><p><a href="http://i.imgur.com/imkMJy9.jpg" rel="nofollow">http://i.imgur.com/imkMJy9.jpg</a></p><p>The SAS backplanes are good quality (for mine anyway) , but the overall plastic parts are cheap and prone to crack . You can see in the image , the power button&#039;s cover is gone and one of the HDD trays is cracked .</p><p>@aw : PLX bridges are good for VFIO and passthrough , but some motherboards makers screw it up somehow , like my Z77 from ASRock . Used to crash hard whenever I launch the VM . Now with my current ASUS X99-E WS everything behind the bridges works like a charm as if its tied directly to the CPU&#039;s Root .</p><p>Anyway , I&#039;ve finally purchased an SSD to store my RAW VM images (created using truncate) , what is the best Filesystem to use for that SSD ?</p><br /><br /><p>-- mod edit: read the Forum Etiquette and only post thumbnails <a href="http://wiki.archlinux.org/index.php/Forum_Etiquette#Pasting_Pictures_and_Code" rel="nofollow">http://wiki.archlinux.org/index.php/For … s_and_Code</a> [jwr] --</p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1540528">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1540545" class="blockpost rowodd"> <h2><span><span class="conr">#5455</span> <a href="viewtopic.php?pid=1540545#p1540545">2015-06-29 04:10:37</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=87826">The_Moves</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2015-01-06</span></dd> <dd><span>Posts: 58</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=87826">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <p>That was actually something that I was curious about. I have 2 Samsung 840 Pros in a mdadm RAID 0, but I swear it hasn&#039;t really improved performance any, if anything I notice lag in games. Such as loading textures, or jumping around to view different players on a map, it takes a split second for things to load. </p><p>Ive had a stable setup for some time now, but need to work on performance tuning.</p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1540545">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1540548" class="blockpost roweven"> <h2><span><span class="conr">#5456</span> <a href="viewtopic.php?pid=1540548#p1540548">2015-06-29 04:32:12</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=84760">Denso</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd class="postavatar"><img src="https://bbs.archlinux.org/img/avatars/84760.png?m=1412533733" width="71" height="80" alt="" /></dd> <dd><span>Registered: 2014-08-30</span></dd> <dd><span>Posts: 179</span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <p>@The_Moves :</p><p>I am certain that putting my VMs files on this new SSD (850 EVO with XFS on top of it) didn&#039;t improve performance over my old 5 7200rpm MD RAID 0 . If any , there is a little improvement on Windows boot times , but launching applications (ESPECIALLY FIREFOX !!!) remains without a noticable improvement .</p><p>Congrats on reaching the stable milestone !</p> <p class="postedit"><em>Last edited by Denso (2015-06-29 04:46:29)</em></p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1540548">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1540586" class="blockpost rowodd"> <h2><span><span class="conr">#5457</span> <a href="viewtopic.php?pid=1540586#p1540586">2015-06-29 10:44:20</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=85314">Duelist</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2014-09-22</span></dd> <dd><span>Posts: 358</span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>The_Moves wrote:</cite><blockquote><div><p>That was actually something that I was curious about. I have 2 Samsung 840 Pros in a mdadm RAID 0, but I swear it hasn&#039;t really improved performance any, if anything I notice lag in games. Such as loading textures, or jumping around to view different players on a map, it takes a split second for things to load. </p><p>Ive had a stable setup for some time now, but need to work on performance tuning.</p></div></blockquote></div><p>Damn! I notice that effects in most games, no matter if they&#039;re running from a raw image relying on a system(ext4) OCZ Agility 3 SSD, or a raw block device being the latest(FZEX) WD Black HDD.<br />ATTO disk benchmark shows no problems, 200MBps read-write on the SSD and specification-correct(180?.. i don&#039;t remember) speeds on the HDD, but the lag is still there.</p><p>I&#039;ve tried every combination of virtio disk systems: virtio-blk-pci, virtio-scsi, native and write-through and whatever else cache modes, multiqueue... Nothing helped much. Maybe CPU pinning helps to address that issues?</p><p>The memory shouldn&#039;t be a problem - aw says it&#039;s pinned in place and isn&#039;t swappable or moved in any way while the devices are passed through.</p> <p class="postedit"><em>Last edited by Duelist (2015-06-29 10:44:59)</em></p> </div> <div class="postsignature postmsg"><hr /><p><span class="bbs">The forum rules prohibit requesting support for distributions other than arch.</span><br /><a href="https://bbs.archlinux.org/viewtopic.php?pid=1551460#p1551460" rel="nofollow">I gave up.</a><a href="https://bbs.archlinux.org/viewtopic.php?id=162768" rel="nofollow"> It was too late.</a><br /><a href="http://pastebin.com/B3fL84bq" rel="nofollow">What I was trying to do</a>.<br /><a href="http://vfio.blogspot.com/" rel="nofollow">The reference about VFIO and KVM VGA passthrough.</a></p></div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1540586">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1540615" class="blockpost roweven"> <h2><span><span class="conr">#5458</span> <a href="viewtopic.php?pid=1540615#p1540615">2015-06-29 13:03:01</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=75590">aw</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2013-10-04</span></dd> <dd><span>Posts: 921</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=75590">Email</a></span> <span class="website"><a href="http://vfio.blogspot.com/" rel="nofollow">Website</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <p>iommu=pt might help improve the latency of host disk and therefore the guest disk image stored on that disk.</p> </div> <div class="postsignature postmsg"><hr /><p><a href="http://vfio.blogspot.com" rel="nofollow">http://vfio.blogspot.com</a><br />Looking for a more open forum to discuss vfio related uses?&#160; Try <a href="https://www.redhat.com/mailman/listinfo/vfio-users" rel="nofollow">https://www.redhat.com/mailman/listinfo/vfio-users</a></p></div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1540615">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1540644" class="blockpost rowodd"> <h2><span><span class="conr">#5459</span> <a href="viewtopic.php?pid=1540644#p1540644">2015-06-29 15:16:39</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=74484">noctlos</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2013-08-26</span></dd> <dd><span>Posts: 33</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=74484">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <p>@aw, I read on your blog that you would need a wrapper script to do q35 on libvirt with windows. how does that work out?</p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1540644">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1540653" class="blockpost roweven"> <h2><span><span class="conr">#5460</span> <a href="viewtopic.php?pid=1540653#p1540653">2015-06-29 15:24:06</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=75590">aw</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2013-10-04</span></dd> <dd><span>Posts: 921</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=75590">Email</a></span> <span class="website"><a href="http://vfio.blogspot.com/" rel="nofollow">Website</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <p>@noctlos</p><p>Something like this:</p><div class="codebox"><pre><code>#!/bin/sh exec qemu-kvm \ `echo &quot;\$@&quot; | \ sed &#039;s|i82801b11-bridge,id=pci.1,bus=pcie.0,addr=0x1e|i82801b11-bridge,id=pci.1,bus=pcie.0,addr=0x1e -device ioh3420,bus=pcie.0,addr=1c.0,multifunction=on,port=1,chassis=1,id=pcie.1|g&#039; | \ sed &#039;s|bus=pci.2,addr=0x4|bus=pcie.1,addr=0x0.0|g&#039;`</code></pre></div><p>It could use some work, this is just something I crudely hacked together.&#160; The idea is to key on the i82801b11-bridge that libvirt adds to also add a root port, then move the gpu, which happens to be pci.2/0x4 in my setup to pcie.1/0x0.0.&#160; Improved libvirt support for q35 is coming, soon.</p> </div> <div class="postsignature postmsg"><hr /><p><a href="http://vfio.blogspot.com" rel="nofollow">http://vfio.blogspot.com</a><br />Looking for a more open forum to discuss vfio related uses?&#160; Try <a href="https://www.redhat.com/mailman/listinfo/vfio-users" rel="nofollow">https://www.redhat.com/mailman/listinfo/vfio-users</a></p></div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1540653">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1540674" class="blockpost rowodd"> <h2><span><span class="conr">#5461</span> <a href="viewtopic.php?pid=1540674#p1540674">2015-06-29 16:21:36</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=87826">The_Moves</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2015-01-06</span></dd> <dd><span>Posts: 58</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=87826">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>Duelist wrote:</cite><blockquote><div><p>Nothing helped much. Maybe CPU pinning helps to address that issues?</p></div></blockquote></div><p>I have pinned CPUs now, two cores w/ two threads on my X5660 and still experience the issue. I was thinking of adding another core/thread, but from reading your response that may not help. Plus while watching NMON (with option L and c enables) it didn&#039;t appear that I was CPU bound anyways. I&#039;m sure there are better tests with this though. Also was considering updating the Kernel as well, from 3.18.7 to 4. Still running Fedora 21</p><p>I will try AWs suggestion.</p> <p class="postedit"><em>Last edited by The_Moves (2015-06-29 16:22:31)</em></p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1540674">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1540690" class="blockpost roweven"> <h2><span><span class="conr">#5462</span> <a href="viewtopic.php?pid=1540690#p1540690">2015-06-29 16:55:24</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=74484">noctlos</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2013-08-26</span></dd> <dd><span>Posts: 33</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=74484">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <p>@aw<br />I see. Since qemu-kvm is not part of my path, i would rectify that as `qemu-system-x86_64 -enable-kvm`, right? Also, how do I get libvirt to use that wrapper script?</p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1540690">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1540693" class="blockpost rowodd"> <h2><span><span class="conr">#5463</span> <a href="viewtopic.php?pid=1540693#p1540693">2015-06-29 16:58:44</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=75590">aw</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2013-10-04</span></dd> <dd><span>Posts: 921</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=75590">Email</a></span> <span class="website"><a href="http://vfio.blogspot.com/" rel="nofollow">Website</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>noctlos wrote:</cite><blockquote><div><p>@aw<br />I see. Since qemu-kvm is not part of my path, i would rectify that as `qemu-system-x86_64 -enable-kvm`, right? Also, how do I get libvirt to use that wrapper script?</p></div></blockquote></div><p>Change qemu-kvm to qemu-system-x86_64, but do not start adding random options.&#160; You&#039;re modifying how libvirt is calling QEMU, not creating a full command line.&#160; <em>virsh edit</em> the domain and update the <em>&lt;emulator&gt;</em> tag to point to the wrapper script.</p> </div> <div class="postsignature postmsg"><hr /><p><a href="http://vfio.blogspot.com" rel="nofollow">http://vfio.blogspot.com</a><br />Looking for a more open forum to discuss vfio related uses?&#160; Try <a href="https://www.redhat.com/mailman/listinfo/vfio-users" rel="nofollow">https://www.redhat.com/mailman/listinfo/vfio-users</a></p></div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1540693">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1540700" class="blockpost roweven"> <h2><span><span class="conr">#5464</span> <a href="viewtopic.php?pid=1540700#p1540700">2015-06-29 17:10:45</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=85314">Duelist</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2014-09-22</span></dd> <dd><span>Posts: 358</span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>The_Moves wrote:</cite><blockquote><div><div class="quotebox"><cite>Duelist wrote:</cite><blockquote><div><p>Nothing helped much. Maybe CPU pinning helps to address that issues?</p></div></blockquote></div><p>I have pinned CPUs now, two cores w/ two threads on my X5660 and still experience the issue. I was thinking of adding another core/thread, but from reading your response that may not help. Plus while watching NMON (with option L and c enables) it didn&#039;t appear that I was CPU bound anyways. I&#039;m sure there are better tests with this though. Also was considering updating the Kernel as well, from 3.18.7 to 4. Still running Fedora 21</p><p>I will try AWs suggestion.</p></div></blockquote></div><p>Seems like you have enough cores to spare: try doing isolcpus to fully isolate a CPU from everything except the VM. Maybe THAT will help.</p><p>Because, @aw, i have iommu=pt and it doesn&#039;t help much.</p><br /><p>Oh, and btw...</p><div class="codebox"><pre><code>01:00.0 VGA compatible controller: Advanced Micro Devices, Inc. [AMD/ATI] Cape Verde PRO [Radeon HD 7750/8740 / R7 250E] 01:00.1 Audio device: Advanced Micro Devices, Inc. [AMD/ATI] Cape Verde/Pitcairn HDMI Audio [Radeon HD 7700/7800 Series] 02:00.0 VGA compatible controller: Advanced Micro Devices, Inc. [AMD/ATI] Cape Verde PRO [Radeon HD 7750/8740 / R7 250E] 02:00.1 Audio device: Advanced Micro Devices, Inc. [AMD/ATI] Cape Verde/Pitcairn HDMI Audio [Radeon HD 7700/7800 Series] 03:05.0 Multimedia audio controller: Ensoniq 5880B [AudioPCI] (rev 02) 04:00.0 VGA compatible controller: NVIDIA Corporation GF119 [GeForce GT 610] (rev a1) 04:00.1 Audio device: NVIDIA Corporation GF119 HDMI Audio Controller (rev a1) 05:00.0 USB controller: ASMedia Technology Inc. ASM1042 SuperSpeed USB Host Controller 06:00.0 Ethernet controller: Realtek Semiconductor Co., Ltd. RTL8111/8168/8411 PCI Express Gigabit Ethernet Controller (rev 09) 07:00.0 VGA compatible controller: Advanced Micro Devices, Inc. [AMD/ATI] Cape Verde PRO [Radeon HD 7750/8740 / R7 250E] 07:00.1 Audio device: Advanced Micro Devices, Inc. [AMD/ATI] Cape Verde/Pitcairn HDMI Audio [Radeon HD 7700/7800 Series]</code></pre></div><p>You know what this means;)<br />...</p><div class="codebox"><pre><code>/sys/kernel/iommu_groups/8/devices: 0000:00:15.0 0000:00:15.2 0000:04:00.0 0000:05:00.0 0000:07:00.0 0000:00:15.1 0000:00:15.3 0000:04:00.1 0000:06:00.0 0000:07:00.1</code></pre></div><p>D-OH! How could i forget...<br />Alright, port change, port change!</p><p>Oh no, we&#039;re going down! 04:00.0 is in that group too! Noooooo!</p><div class="codebox"><pre><code>00:15.0 PCI bridge: Advanced Micro Devices, Inc. [AMD] Hudson PCI to PCI bridge (PCIE port 0) 00:15.1 PCI bridge: Advanced Micro Devices, Inc. [AMD] Hudson PCI to PCI bridge (PCIE port 1) 00:15.2 PCI bridge: Advanced Micro Devices, Inc. [AMD] Hudson PCI to PCI bridge (PCIE port 2) 00:15.3 PCI bridge: Advanced Micro Devices, Inc. [AMD] Hudson PCI to PCI bridge (PCIE port 3)</code></pre></div><div class="codebox"><pre><code>-[0000:00]-+-00.0 +-00.2 +-02.0-[01]--+-00.0 | \-00.1 +-04.0-[02]--+-00.0 | \-00.1 +-11.0 +-12.0 +-12.2 +-13.0 +-13.2 +-14.0 +-14.2 +-14.3 +-14.4-[03]----05.0 +-15.0-[04]--+-00.0 | \-00.1 +-15.1-[05]----00.0 +-15.2-[06]----00.0 +-15.3-[07]--+-00.0 | \-00.1 ...</code></pre></div><p>Yeaaaaah, those are not processor root ports.<br />Seems like i must make the host headless(detach the GT610) and networkless(use a pci or usb network card) to be able to passthrough the full group...<br />I guess there&#039;s no real way of shuffling the iommu groups without changing the motherboard, right?</p><p>Alright, multiply the weirdness:</p><div class="codebox"><pre><code> &lt;hostdev mode=&#039;subsystem&#039; type=&#039;pci&#039; managed=&#039;yes&#039;&gt; &lt;driver name=&#039;kvm&#039;/&gt; &lt;source&gt; &lt;address domain=&#039;0x0000&#039; bus=&#039;0x07&#039; slot=&#039;0x00&#039; function=&#039;0x0&#039;/&gt; &lt;/source&gt; &lt;rom bar=&#039;on&#039; file=&#039;/mnt/hdd/qemu/hybridmagic.rom&#039;/&gt; &lt;address type=&#039;pci&#039; domain=&#039;0x0000&#039; bus=&#039;0x00&#039; slot=&#039;0x0c&#039; function=&#039;0x0&#039;/&gt; &lt;/hostdev&gt; &lt;hostdev mode=&#039;subsystem&#039; type=&#039;pci&#039; managed=&#039;yes&#039;&gt; &lt;driver name=&#039;kvm&#039;/&gt; &lt;source&gt; &lt;address domain=&#039;0x0000&#039; bus=&#039;0x07&#039; slot=&#039;0x00&#039; function=&#039;0x1&#039;/&gt; &lt;/source&gt; &lt;address type=&#039;pci&#039; domain=&#039;0x0000&#039; bus=&#039;0x00&#039; slot=&#039;0x0d&#039; function=&#039;0x0&#039;/&gt; &lt;/hostdev&gt;</code></pre></div><p>Note the driver name: sorry, aw, but i&#039;ll use pci-assign for select devices.</p><p>The VM booted, but i observe some weird things happening, the main card restarts the driver. Seems like they&#039;re doing their handshake mating dance...</p><p>After a dozen of screen blinks, they&#039;ve settled down.<br /><a href="http://i.imgur.com/Mhr3izX.png" rel="nofollow">http://i.imgur.com/Mhr3izX.png</a><br />Sorry for the russian locale, but it&#039;s a habit..<br />(I don&#039;t know wtf is that mirage driver)<br />The offline device is QXL.<br />Well, now the fun part: <span class="bbs">GPU-Z</span>, some benchmarks and maybe a crossfire.</p><p><a href="http://i.imgur.com/i4JfRdt.png" rel="nofollow">http://i.imgur.com/i4JfRdt.png</a><br />CCC is overwhelmed(it was with only two cards) by awesomeness, and refuses to launch:D</p><p>CrossFireX is online. It is enabled and shown by GPU-Z 0.8.2 that it has 2 GPUs. Out of three.<br />It turned on much faster than usual though...</p><p>The thing is - i don&#039;t do <span class="bbs">dr</span>bridges. My cards are the first with GCN and XDMA crossfire, that&#039;s why it works with two cards in the first place.<br />I remember that AMD Support told me that i will need an even number of cards.<br />But there&#039;s a tri-way crossfire on some 7XXX cards, and there&#039;s configs even without the bridges. Something is amiss.<br />And i can&#039;t really determine which two cards are being used.</p><p>After i turned off crossfire, GPU-z crashed the driver, but it was reset by the system, so i was able to see three GPUs with some missing info. After a second launch of GPU-z, the driver hung and the system hung too. After a force power off, the VM no longer boots, eating 100% CPU. Time to reboot the host.</p><p>After a host reboot... The second card went offline, the third card works. Crossfire doesn&#039;t work, but i&#039;m able to use it&#039;s video outputs. So it works as a separate device, but crossfire is unavailable... Hmm, what could be a reason.. Maybe the bus width?</p><p>PCI-e 2.0 x1 = 5Gbps = 500 MBps. A crossfire bridge is capable of 900 MBps.<br />So that&#039;s why XDMA crossfire was introduced - pci express bandwidth was big enough to pump all the crossfire stuff through itself, and everything AMD needed was enabling some way of DMA communication between devices.<br />If i&#039;d have pci-e 3.0, even on 1x i&#039;d have ~984 MBps as stated <a href="https://en.wikipedia.org/wiki/List_of_device_bit_rates#Main_buses" rel="nofollow">here</a>.<br /><span class="bbu">Oh well. Is there a way of simulating higher bus throughput? I honestly don&#039;t believe that it really fills all that 900 MBps and it may be a simple software block.</span></p><p>So i guess the final result is semi-win: i can run three VMs simultaneously, if i have three spare screens. Or run a double-crossfire and single-card VMs, needing only two screens to spare.<br />Crossfire doesn&#039;t work with the third card if the second is offline. I wonder what will happen if i will remove the second card from the VM and try doing crossfire, but something hints me that fail will be the result.<br />Surprisingly though, that alone third card is self-contained - i can run a VM only from that card, BUT with some buts:<br />1. one VM launch per host boot. Legacy pci-assign doesn&#039;t do any resets right.<br />2. No VGA at all! Since i have it broken - i use OVMF, so it works.<br />3. It doesn&#039;t fit in the case.<br />All those problems may be fixed by pci-e 3.0 with more processor root ports and just more slots - i have no pci-e slots left free on my F2A55. Also, pci-e 3.0 alone would make crossfire through 1x possible, i think.</p><p>I&#039;ll photograph that madness tomorrow, for lulz, That was one hell of a day.</p><br /><br /><p>-- mod edit: read the Forum Etiquette and only post thumbnails <a href="http://wiki.archlinux.org/index.php/Forum_Etiquette#Pasting_Pictures_and_Code" rel="nofollow">http://wiki.archlinux.org/index.php/For … s_and_Code</a> [jwr] --</p> <p class="postedit"><em>Last edited by Duelist (2015-06-29 21:02:53)</em></p> </div> <div class="postsignature postmsg"><hr /><p><span class="bbs">The forum rules prohibit requesting support for distributions other than arch.</span><br /><a href="https://bbs.archlinux.org/viewtopic.php?pid=1551460#p1551460" rel="nofollow">I gave up.</a><a href="https://bbs.archlinux.org/viewtopic.php?id=162768" rel="nofollow"> It was too late.</a><br /><a href="http://pastebin.com/B3fL84bq" rel="nofollow">What I was trying to do</a>.<br /><a href="http://vfio.blogspot.com/" rel="nofollow">The reference about VFIO and KVM VGA passthrough.</a></p></div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1540700">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1540781" class="blockpost rowodd"> <h2><span><span class="conr">#5465</span> <a href="viewtopic.php?pid=1540781#p1540781">2015-06-29 21:05:21</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=92218">impulse_255</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2015-06-29</span></dd> <dd><span>Posts: 22</span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <p>Hi,</p><p>Debian user here, but I decided to drop by and tell about my experience with Qemu + KVM and passthrough since all the relevant information is here. Thanks to everyone involved in creating the tools and documentation for doing this, it has been immensely useful.</p><p>I&#039;ve set up my system with Debian as the host for work and general desktop usage and a Windows 7 guest as my toy OS for games. The system:</p><p>- Custom kernel 4.0.5 with all the necessary KVM and VFIO features enabled<br />- Qemu 2.1.2 (I later compiled a build of 2.3.0)</p><p>- Intel DP67BG. Needs the ACS patch and allow_unsafe_interrupts.<br />- i7 2600</p><p>I actually got those back in 2011 with the intention of using Xen but didn&#039;t, partly because of laziness and partly because I had Nvidia cards which meant trouble without Quadro hacks. Better late than never. <img src="https://bbs.archlinux.org/img/smilies/smile.png" width="15" height="15" alt="smile" /></p><p>- Titan X for Windows, a GT430 for Linux</p><p>I initially passed through the GT430 to make sure everything works. It did, though the VM would only start once per boot. Suspending and resuming between VM starts sufficed. The Titan X, however, does not have that problem. I can stop and start it as many times as I want without fail!</p><p>- Delock KVM switch for USB devices. It functions as a USB hub as well so I need just one connection for each OS. There are three separate USB controllers on the DP67BG so I pass through one of them to Windows.<br />- Audioengine D1, a USB DAC for audio. Emulated sound through Qemu was completely distorted and stuttery no matter what settings I tried so I needed to pass through audio. I connected the D1 to the KVM switch as well. That did NOT work well. In addition to short dropouts the audio would occasionally completely cut off for about two seconds before catching up again. Very annoying. I connected it directly to a passed through USB port and the total cutoffs have not occurred since (for the past day, knock on wood). I suppose putting a time-sensitive USB device behind a hub on a VM is asking for trouble. I&#039;ll have to figure out a hassle-free way to play audio from either OS to one set of headphones. Manually plugging/unplugging cables is the last resort.<br />- A raw format disk image on an ext4 formatted SSD partition used as a VirtIO drive. As I debugged my skipping audio, I noticed disk IO causes rather high amounts of DPC latency in the guest. Games produce noticeable hiccups whenever they are loading stuff. I&#039;m planning on passing through the second SATA controller (Marvell) on the motherboard so I can forget about optimizing IO. Its only connector is an eSata in the back panel so I&#039;ll have to route the cable back in the case. <img src="https://bbs.archlinux.org/img/smilies/smile.png" width="15" height="15" alt="smile" /></p><p>Speaking of DPC latency in the guest, I&#039;m getting oddly inconsistent readings. Sometimes the baseline is ~1000 µs, sometimes ~2000 µs. I can&#039;t figure out why. Setting the cpu governor to performance on the host halves this to either 500 or 1000 µs. Any ideas to what&#039;s causing this or if the values are higher than they should be?</p><p>Another question regarding vCpu = pCpu pinning which I don&#039;t quite understand: I have so far run into CPU bottlenecks in some games that didn&#039;t exist on a bare metal OS. Let&#039;s say I want to provide all the CPU performance to the guest should it need it. The i7 2600 is a hyper-threaded quad-core so I use -smp 8,sockets=1,cores=4,threads=2. Since I won&#039;t use both systems at the very same time, I don&#039;t care if either one of can hog all the resources. In fact it would be desirable. Do I benefit anything from, say, using taskset 0xFFFFFFFF which according to the man page means &quot;all processors&quot;? I have noticed that the CPU usage seems to lack affinity on the guest, with all 8 vCPUs often showing some usage. On a bare metal Windows, the CPU usage was much more concentrated, with one core or two cores typically maxed out and others partially loaded. I do not know if this is a symptom of anything or related to performance issues at all. I&#039;d appreciate any insight on this.</p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1540781">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1540794" class="blockpost roweven"> <h2><span><span class="conr">#5466</span> <a href="viewtopic.php?pid=1540794#p1540794">2015-06-29 22:31:54</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=92221">biocyberman</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2015-06-29</span></dd> <dd><span>Posts: 3</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=92221">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <p>Hello geeky KVM users!<br />I am stuck while trying to set up passthrough for my compute GPU NVIDIA cards (Tesla k20c). The cards do not have ports to plug monitor cables on. They are only meant for computation. My host is &quot;uname -a: Linux server 3.13.0-55-generic #94-Ubuntu SMP Thu Jun 18 00:27:10 UTC 2015 x86_64 x86_64 x86_64 GNU/Linux&quot; (I know Ubuntu is not Archlinux, but it seems if you know Archlinux you know everthing <img src="https://bbs.archlinux.org/img/smilies/big_smile.png" width="15" height="15" alt="big_smile" />). My guest is Windows 7, 64bit. Below is my startup script. Withouth the line that enables GPU passthrough (containing vfio-pci), I can boot and run the Windows guest successfully.&#160; But when I enable the passthrough, qemu crashes with error shown at the end of this post. Any help is much appreciated. </p><div class="codebox"><pre class="vscroll"><code>#!/bin/bash configfile=/etc/vfio-pci1.cfg vfiobind() { dev=&quot;$1&quot; vendor=$(cat /sys/bus/pci/devices/$dev/vendor) device=$(cat /sys/bus/pci/devices/$dev/device) if [ -e /sys/bus/pci/devices/$dev/driver ]; then echo $dev &gt; /sys/bus/pci/devices/$dev/driver/unbind fi echo &quot;Binding vendor: $vendor and device: $device&quot; echo $vendor $device &gt; /sys/bus/pci/drivers/vfio-pci/new_id } echo Loading vfio... sudo modprobe vfio-pci echo Start binding devices... cat $configfile | while read line;do echo $line | grep ^# &gt;/dev/null 2&gt;&amp;1 &amp;&amp; continue vfiobind $line done echo Done binding devices echo Starting virtual machine ... sudo qemu-system-x86_64 -enable-kvm -M q35 -m $((1024*32)) -cpu host \ -smp cpus=2,sockets=2,cores=4,threads=1 \ -bios /usr/share/qemu/bios.bin -vga std \ -device ioh3420,bus=pcie.0,addr=1c.0,multifunction=on,port=1,chassis=1,id=root.1 \ -device vfio-pci,multifunction=off,x-vga=off,host=02:00.0,bus=root.1,addr=00.0 \ -drive file=/data/win7kvm.img,id=disk,format=raw -device ide-hd,bus=ide.0,drive=disk \ -drive file=/data/Windows7.iso,id=isocd -device ide-cd,bus=ide.1,drive=isocd \ -boot menu=on \ -runas kvmuser echo Done! exit 0</code></pre></div><br /><p>qmeu crash message when enable vfio-pci passthough for GPU:</p><div class="codebox"><pre class="vscroll"><code>qemu-system-x86_64: vfio_dma_map(0x7ff529f9ecb0, 0xc0000, 0x8000, 0x7fed080c0000) = -12 (Cannot allocate memory) qemu: hardware error: vfio: DMA mapping failed, unable to continue CPU #0: EAX=80000033 EBX=80000090 ECX=00000033 EDX=00000cfd ESI=00000001 EDI=00000090 EBP=00000097 ESP=00006f94 EIP=ffff1e1c EFL=00000002 [-------] CPL=0 II=0 A20=1 SMM=0 HLT=0 ES =0010 00000000 ffffffff 00c09300 DPL=0 DS [-WA] CS =0008 00000000 ffffffff 00c09b00 DPL=0 CS32 [-RA] SS =0010 00000000 ffffffff 00c09300 DPL=0 DS [-WA] DS =0010 00000000 ffffffff 00c09300 DPL=0 DS [-WA] FS =0010 00000000 ffffffff 00c09300 DPL=0 DS [-WA] GS =0010 00000000 ffffffff 00c09300 DPL=0 DS [-WA] LDT=0000 00000000 0000ffff 00008200 DPL=0 LDT TR =0000 00000000 0000ffff 00008b00 DPL=0 TSS32-busy GDT= 000f6f98 00000037 IDT= 000f6fd6 00000000 CR0=60000011 CR2=00000000 CR3=00000000 CR4=00000000 DR0=0000000000000000 DR1=0000000000000000 DR2=0000000000000000 DR3=0000000000000000 DR6=00000000ffff0ff0 DR7=0000000000000400 EFER=0000000000000000 FCW=037f FSW=0000 [ST=0] FTW=00 MXCSR=00001f80 FPR0=0000000000000000 0000 FPR1=0000000000000000 0000 FPR2=0000000000000000 0000 FPR3=0000000000000000 0000 FPR4=0000000000000000 0000 FPR5=0000000000000000 0000 FPR6=0000000000000000 0000 FPR7=0000000000000000 0000 XMM00=00000000000000000000000000000000 XMM01=00000000000000000000000000000000 XMM02=00000000000000000000000000000000 XMM03=00000000000000000000000000000000 XMM04=00000000000000000000000000000000 XMM05=00000000000000000000000000000000 XMM06=00000000000000000000000000000000 XMM07=00000000000000000000000000000000 CPU #1: EAX=00000000 EBX=00000000 ECX=00000000 EDX=000206d7 ESI=00000000 EDI=00000000 EBP=00000000 ESP=00000000 EIP=0000fff0 EFL=00000002 [-------] CPL=0 II=0 A20=1 SMM=0 HLT=0 ES =0000 00000000 0000ffff 00009300 CS =f000 ffff0000 0000ffff 00009b00 SS =0000 00000000 0000ffff 00009300 DS =0000 00000000 0000ffff 00009300 FS =0000 00000000 0000ffff 00009300 GS =0000 00000000 0000ffff 00009300 LDT=0000 00000000 0000ffff 00008200 TR =0000 00000000 0000ffff 00008b00 GDT= 00000000 0000ffff IDT= 00000000 0000ffff CR0=60000010 CR2=00000000 CR3=00000000 CR4=00000000 DR0=0000000000000000 DR1=0000000000000000 DR2=0000000000000000 DR3=0000000000000000 DR6=00000000ffff0ff0 DR7=0000000000000400 EFER=0000000000000000 FCW=037f FSW=0000 [ST=0] FTW=00 MXCSR=00001f80 FPR0=0000000000000000 0000 FPR1=0000000000000000 0000 FPR2=0000000000000000 0000 FPR3=0000000000000000 0000 FPR4=0000000000000000 0000 FPR5=0000000000000000 0000 FPR6=0000000000000000 0000 FPR7=0000000000000000 0000 XMM00=00000000000000000000000000000000 XMM01=00000000000000000000000000000000 XMM02=00000000000000000000000000000000 XMM03=00000000000000000000000000000000 XMM04=00000000000000000000000000000000 XMM05=00000000000000000000000000000000 XMM06=00000000000000000000000000000000 XMM07=00000000000000000000000000000000</code></pre></div> <p class="postedit"><em>Last edited by biocyberman (2015-06-29 22:33:55)</em></p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1540794">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1540867" class="blockpost rowodd"> <h2><span><span class="conr">#5467</span> <a href="viewtopic.php?pid=1540867#p1540867">2015-06-30 06:47:27</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=84760">Denso</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd class="postavatar"><img src="https://bbs.archlinux.org/img/avatars/84760.png?m=1412533733" width="71" height="80" alt="" /></dd> <dd><span>Registered: 2014-08-30</span></dd> <dd><span>Posts: 179</span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <p>So I have a question to everybody in the house :</p><p>Using rsync to backup the VMs&#039; hdd images while the VMs are running causes the host to crash hard .</p><p>Any way to backup while the VMs are running ? It has to be from within the host not the guest + it has to be rsync for its inplace feature .</p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1540867">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1540878" class="blockpost roweven"> <h2><span><span class="conr">#5468</span> <a href="viewtopic.php?pid=1540878#p1540878">2015-06-30 07:45:34</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=79471">Bronek</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>From: London</span></dd> <dd><span>Registered: 2014-02-14</span></dd> <dd><span>Posts: 90</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=79471">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>Denso wrote:</cite><blockquote><div><p>So I have a question to everybody in the house :</p><p>Using rsync to backup the VMs&#039; hdd images while the VMs are running causes the host to crash hard .</p><p>Any way to backup while the VMs are running ? It has to be from within the host not the guest + it has to be rsync for its inplace feature .</p></div></blockquote></div><p>Surely there are many ways of doing this, but I wonder how could you possibly be using rsync for this. Does hits mean that you have mounted single block device both in guest and in host? If so, then no surprise that one of them is crashing. FWIW, I am using snapshot feature from ZFS and use zvols as block devices attached to virtual machines. Also I have installed inside guest qemu-ga from stable virtio-win and use it to freeze guest filesystem right before taking a snapshot.</p> <p class="postedit"><em>Last edited by Bronek (2015-06-30 09:44:05)</em></p> </div> <div class="postsignature postmsg"><hr /><p>Sorry about&#160; &quot;KVM VGA-Passthrough ...&quot; thread <img src="https://bbs.archlinux.org/img/smilies/sad.png" width="15" height="15" alt="sad" /> Anyone interested in continuing this discussion elsewhere, please contact me privately. I might be able to find it a new home.</p></div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1540878">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1540882" class="blockpost rowodd"> <h2><span><span class="conr">#5469</span> <a href="viewtopic.php?pid=1540882#p1540882">2015-06-30 08:01:44</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=25579">jasonwryan</a></strong></dt> <dd class="usertitle"><strong>Forum &amp; Wiki Admin</strong></dd> <dd class="postavatar"><img src="https://bbs.archlinux.org/img/avatars/25579.png?m=1386831523" width="80" height="69" alt="" /></dd> <dd><span>From: .nz</span></dd> <dd><span>Registered: 2009-05-09</span></dd> <dd><span>Posts: 15,669</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=25579">Email</a></span> <span class="website"><a href="http://jasonwryan.com/" rel="nofollow">Website</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <p>Denso, please don&#039;t hijack threads: <a href="https://wiki.archlinux.org/index.php/Forum_etiquette#Thread_hijacking" rel="nofollow">https://wiki.archlinux.org/index.php/Fo … _hijacking</a></p> </div> <div class="postsignature postmsg"><hr /><p><a href="http://www.flickr.com/photos/jasonwryan/9333810442/lightbox/" rel="nofollow">Arch + dwm</a>&#160; &#160;•&#160; &#160;<a href="http://bitbucket.jasonwryan.com/" rel="nofollow">Mercurial repos</a>&#160; •&#160; &#160;<a href="https://github.com/jasonwryan/" rel="nofollow">Github</a></p><p>Registered Linux User #482438</p></div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1540882">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1540909" class="blockpost roweven"> <h2><span><span class="conr">#5470</span> <a href="viewtopic.php?pid=1540909#p1540909">2015-06-30 10:44:49</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=82117">devianceluka</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2014-05-19</span></dd> <dd><span>Posts: 43</span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <p>Im using OVMF and passing through onboard P9X79 PRO &quot;ASMedia USB3.0 controller&quot;:</p><p>When keyboard is attached to the controller, the VM gets a hang for 2-3 minutes before booting Windows 8.1 (on POST) and the USB controller no longer works in the VM. When I physically disconnect the keyboard BEFORE starting the VM it works normally, I can attach it later when OS boots (but need to disconnect it again if I reboot OS).</p><p>In other words, it seems like OVMF doesnt like the controller+keyboard attached to it while booting?</p><p>Can I somehow disable USB or keyboard support before booting?</p><p>What could be the problem? Is there a known fix I cant seem to find out? Tried alot of combinations already... Please help!</p><p>EDIT: <br />Using UEFI minimal Fedora 22 with everything latest and greatest (virt-preview)</p> <p class="postedit"><em>Last edited by devianceluka (2015-06-30 10:46:14)</em></p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1540909">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1540997" class="blockpost rowodd"> <h2><span><span class="conr">#5471</span> <a href="viewtopic.php?pid=1540997#p1540997">2015-06-30 15:50:46</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=87826">The_Moves</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2015-01-06</span></dd> <dd><span>Posts: 58</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=87826">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>devianceluka wrote:</cite><blockquote><div><p>Im using OVMF and passing through onboard P9X79 PRO &quot;ASMedia USB3.0 controller&quot;:</p><p>When keyboard is attached to the controller, the VM gets a hang for 2-3 minutes before booting Windows 8.1 (on POST) and the USB controller no longer works in the VM. When I physically disconnect the keyboard BEFORE starting the VM it works normally, I can attach it later when OS boots (but need to disconnect it again if I reboot OS).</p></div></blockquote></div><p>I had the same issue with my ASMedia USB3 Controllers. I would be able to boot the VM with Keyboard and Mouse connected, but they would randomly just stop working. Only a reboot of the host would fix them. Instead, I have started passing through my onboard USB 2.0 Controllers and had no such stability issues. I would stay away from the ASMEDIA USB3 Controllers</p> <p class="postedit"><em>Last edited by The_Moves (2015-06-30 19:53:57)</em></p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1540997">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1541046" class="blockpost roweven"> <h2><span><span class="conr">#5472</span> <a href="viewtopic.php?pid=1541046#p1541046">2015-06-30 19:11:00</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=87349">sunmast</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2014-12-16</span></dd> <dd><span>Posts: 4</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=87349">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>andy123 wrote:</cite><blockquote><div><div class="quotebox"><cite>nbhs wrote:</cite><blockquote><div><p>Yes deveject is used to automate the ejecting, but you can eject the card from windows just like you would eject a pendrive.</p><p>EDIT: make sure ejecting is done on the vm first run.</p></div></blockquote></div><p>deveject works perfect, the vm switches from the cirrus card to the radeon on bootup and back und shutdown <img src="https://bbs.archlinux.org/img/smilies/big_smile.png" width="15" height="15" alt="big_smile" /><br />I&#039;m still a bit unclear on the virtio stuff though, I downloaded the drivers, but how do I install them (srsly, windows is confusing…)?</p></div></blockquote></div><p>I&#039;m using OVMF to pass through a EVGA GTX 960 card, and experiencing the reset issue too (VM cannot be restarted without host restart).<br />I searched deveject on Google, but there are multiple projects called deveject, and it seems they are all for USB devices.</p><p>Could you give the link to deveject you used?</p><p>Also is there any way to reset the card from host side? E.g. power off/on the card from some Linux command?</p><p>Thanks!</p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1541046">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1541063" class="blockpost rowodd"> <h2><span><span class="conr">#5473</span> <a href="viewtopic.php?pid=1541063#p1541063">2015-06-30 19:52:10</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=87826">The_Moves</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2015-01-06</span></dd> <dd><span>Posts: 58</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=87826">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>Duelist wrote:</cite><blockquote><div><div class="quotebox"><cite>The_Moves wrote:</cite><blockquote><div><div class="quotebox"><cite>Duelist wrote:</cite><blockquote><div><p>Nothing helped much. Maybe CPU pinning helps to address that issues?</p></div></blockquote></div><p>I have pinned CPUs now, two cores w/ two threads on my X5660 and still experience the issue. I was thinking of adding another core/thread, but from reading your response that may not help. Plus while watching NMON (with option L and c enables) it didn&#039;t appear that I was CPU bound anyways. I&#039;m sure there are better tests with this though. Also was considering updating the Kernel as well, from 3.18.7 to 4. Still running Fedora 21</p><p>I will try AWs suggestion.</p></div></blockquote></div><p>Seems like you have enough cores to spare: try doing isolcpus to fully isolate a CPU from everything except the VM. Maybe THAT will help.</p><p>Because, @aw, i have iommu=pt and it doesn&#039;t help much.</p></div></blockquote></div><p>I tried the CPU Pinning, it may have helped a little, however I do not think I am fully setup correcty. Here is a snipit from my VM Config as well as my /etc/default/grub:</p><div class="codebox"><pre><code># GamingMachine.xml: &lt;vcpu placement=&#039;static&#039;&gt;4&lt;/vcpu&gt; &lt;cputune&gt; &lt;vcpupin vcpu=&#039;0&#039; cpuset=&#039;2&#039;/&gt; &lt;vcpupin vcpu=&#039;1&#039; cpuset=&#039;8&#039;/&gt; &lt;vcpupin vcpu=&#039;2&#039; cpuset=&#039;3&#039;/&gt; &lt;vcpupin vcpu=&#039;3&#039; cpuset=&#039;9&#039;/&gt; &lt;/cputune&gt; # Using the above, I setup the below CPUs for isolation # Snipit from GRUB_CMDLINE line in /etc/default/grub: isolcpus=2,3,8,9</code></pre></div><p>I re-read the OP and it brought me here: <a href="http://www.linux-kvm.com/content/tip-running-your-vm-specific-cpus" rel="nofollow">http://www.linux-kvm.com/content/tip-ru … cific-cpus</a><br />Using the commands there, I noticed that my VM was not in fact running on the cores I specified:</p><div class="codebox"><pre><code># Original Setup [root@kvmhost1 ~]# taskset -p 1214 pid 1214&#039;s current affinity mask: fff [root@kvmhost1 ~]# taskset -c -p 1214 pid 1214&#039;s current affinity list: 0-11 # Correcting the afinity [root@kvmhost1 ~]# taskset -p -c 2,3,8,9 1214 pid 1214&#039;s current affinity list: 0-11 pid 1214&#039;s new affinity list: 2,3,8,9 # Final [root@kvmhost1 ~]# taskset -c -p 1214 pid 1214&#039;s current affinity list: 2,3,8,9 [root@kvmhost1 ~]# taskset -p 1214 pid 1214&#039;s current affinity mask: 30c</code></pre></div><p>I have yet to test to above tweak as I found this while on lunch break. Why isn&#039;t the &lt;cputune&gt; section in my VM config not setting the affinity for the PID which represents my VM?</p><p>As for iommu=pt, I started receiving strange jerkiness in games, so I have removed that flag. Maybe some other kernel flags are conflicting with it, or maybe i&#039;m missing something. It makes sense that iommu=pt should help performance as it eliminates overhead - which i read from here: <a href="https://bugzilla.redhat.com/show_bug.cgi?id=1201503" rel="nofollow">https://bugzilla.redhat.com/show_bug.cgi?id=1201503</a></p><p>Here is my full GRUB_CMDLINE line from /etc/default/grub:</p><div class="codebox"><pre><code>GRUB_CMDLINE_LINUX=&quot;rd.lvm.lv=fedora-server/root rd.lvm.lv=fedora-server/swap rd.driver.blacklist=nouveau kvm-intel.nested=1 intel_iommu=on isolcpus=2,3,8,9 pci-stub.ids=8086:3a34,8086:3a35,8086:3a36,8086:3a3a,1102:0012,1103:0611,1b4b:91a4,1b21:1042,1000:0072,10de:1187,10de:0e0a,8086:10d3,8086105e&quot;</code></pre></div> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1541063">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1541069" class="blockpost roweven"> <h2><span><span class="conr">#5474</span> <a href="viewtopic.php?pid=1541069#p1541069">2015-06-30 19:58:19</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=75590">aw</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2013-10-04</span></dd> <dd><span>Posts: 921</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=75590">Email</a></span> <span class="website"><a href="http://vfio.blogspot.com/" rel="nofollow">Website</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>The_Moves wrote:</cite><blockquote><div><p>I tried the CPU Pinning, it may have helped a little, however I do not think I am fully setup correcty. Here is a snipit from my VM Config as well as my /etc/default/grub:</p><div class="codebox"><pre><code># GamingMachine.xml: &lt;vcpu placement=&#039;static&#039;&gt;4&lt;/vcpu&gt; &lt;cputune&gt; &lt;vcpupin vcpu=&#039;0&#039; cpuset=&#039;2&#039;/&gt; &lt;vcpupin vcpu=&#039;1&#039; cpuset=&#039;8&#039;/&gt; &lt;vcpupin vcpu=&#039;2&#039; cpuset=&#039;3&#039;/&gt; &lt;vcpupin vcpu=&#039;3&#039; cpuset=&#039;9&#039;/&gt; &lt;/cputune&gt; # Using the above, I setup the below CPUs for isolation # Snipit from GRUB_CMDLINE line in /etc/default/grub: isolcpus=2,3,8,9</code></pre></div></div></blockquote></div><p>Without knowing the host cpu or guest cpu topology, this is pretty meaningless.</p><div class="quotebox"><blockquote><div><p>I re-read the OP and it brought me here: <a href="http://www.linux-kvm.com/content/tip-running-your-vm-specific-cpus" rel="nofollow">http://www.linux-kvm.com/content/tip-ru … cific-cpus</a><br />Using the commands there, I noticed that my VM was not in fact running on the cores I specified:</p><div class="codebox"><pre><code># Original Setup [root@kvmhost1 ~]# taskset -p 1214 pid 1214&#039;s current affinity mask: fff [root@kvmhost1 ~]# taskset -c -p 1214 pid 1214&#039;s current affinity list: 0-11 # Correcting the afinity [root@kvmhost1 ~]# taskset -p -c 2,3,8,9 1214 pid 1214&#039;s current affinity list: 0-11 pid 1214&#039;s new affinity list: 2,3,8,9 # Final [root@kvmhost1 ~]# taskset -c -p 1214 pid 1214&#039;s current affinity list: 2,3,8,9 [root@kvmhost1 ~]# taskset -p 1214 pid 1214&#039;s current affinity mask: 30c</code></pre></div><p>I have yet to test to above tweak as I found this while on lunch break. Why isn&#039;t the &lt;cputune&gt; section in my VM config not setting the affinity for the PID which represents my VM?</p></div></blockquote></div><p>You&#039;re messing with the cpu affinity of the qemu process, not the vCPUs.&#160; There&#039;s an &lt;emulatorpin&gt; control for this <a href="https://libvirt.org/formatdomain.html#elementsCPUTuning" rel="nofollow">https://libvirt.org/formatdomain.html#elementsCPUTuning</a></p> </div> <div class="postsignature postmsg"><hr /><p><a href="http://vfio.blogspot.com" rel="nofollow">http://vfio.blogspot.com</a><br />Looking for a more open forum to discuss vfio related uses?&#160; Try <a href="https://www.redhat.com/mailman/listinfo/vfio-users" rel="nofollow">https://www.redhat.com/mailman/listinfo/vfio-users</a></p></div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1541069">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1541074" class="blockpost rowodd"> <h2><span><span class="conr">#5475</span> <a href="viewtopic.php?pid=1541074#p1541074">2015-06-30 20:08:25</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=85314">Duelist</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2014-09-22</span></dd> <dd><span>Posts: 358</span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <p>I think isolcpus should really help in a way of isolating host CPUs fully and dedicating them to the guest, so no IRQs are able to steal the guest&#039;s CPU time.<br />Maybe i misunderstand it.</p> <p class="postedit"><em>Last edited by Duelist (2015-06-30 20:09:06)</em></p> </div> <div class="postsignature postmsg"><hr /><p><span class="bbs">The forum rules prohibit requesting support for distributions other than arch.</span><br /><a href="https://bbs.archlinux.org/viewtopic.php?pid=1551460#p1551460" rel="nofollow">I gave up.</a><a href="https://bbs.archlinux.org/viewtopic.php?id=162768" rel="nofollow"> It was too late.</a><br /><a href="http://pastebin.com/B3fL84bq" rel="nofollow">What I was trying to do</a>.<br /><a href="http://vfio.blogspot.com/" rel="nofollow">The reference about VFIO and KVM VGA passthrough.</a></p></div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1541074">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div class="postlinksb"> <div class="inbox crumbsplus"> <div class="pagepost"> <p class="pagelink conl"><span class="pages-label">Pages: </span><a rel="prev" class="item1" href="viewtopic.php?id=162768&amp;p=218">Previous</a> <a href="viewtopic.php?id=162768">1</a> <span class="spacer">…</span> <a href="viewtopic.php?id=162768&amp;p=217">217</a> <a href="viewtopic.php?id=162768&amp;p=218">218</a> <strong>219</strong> <a href="viewtopic.php?id=162768&amp;p=220">220</a> <a href="viewtopic.php?id=162768&amp;p=221">221</a> <span class="spacer">…</span> <a href="viewtopic.php?id=162768&amp;p=234">234</a> <a rel="next" href="viewtopic.php?id=162768&amp;p=220">Next</a></p> <p class="postlink conr">Topic closed</p> </div> <ul class="crumbs"> <li><a href="index.php">Index</a></li> <li><span>»&#160;</span><a href="viewforum.php?id=48">Topics Going Nowhere</a></li> <li><span>»&#160;</span><strong><a href="viewtopic.php?id=162768">KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</a></strong></li> </ul> <p class="subscribelink clearb"><a href="misc.php?action=subscribe&amp;tid=162768">Subscribe to this topic</a></p> <div class="clearer"></div> </div> </div> </div> <div id="brdfooter" class="block"> <h2><span>Board footer</span></h2> <div class="box"> <div id="brdfooternav" class="inbox"> <div class="conl"> <form id="qjump" method="get" action="viewforum.php"> <div><label><span>Jump to<br /></span> <select name="id" onchange="window.location=('viewforum.php?id='+this.options[this.selectedIndex].value)"> <optgroup label="Technical Issues and Assistance"> <option value="23">Newbie Corner</option> <option value="17">Installation</option> <option value="22">Kernel &amp; Hardware</option> <option value="18">Applications &amp; Desktop Environments</option> <option value="31">Laptop Issues</option> <option value="8">Networking, Server, and Protection</option> <option value="32">Multimedia and Games</option> <option value="50">System Administration</option> <option value="35">Other Architectures</option> </optgroup> <optgroup label="Arch-centric"> <option value="24">Announcements, Package &amp; Security Advisories</option> <option value="1">Arch Discussion</option> <option value="13">Forum &amp; Wiki discussion</option> </optgroup> <optgroup label="Pacman Upgrades, Packaging &amp; AUR"> <option value="44">Pacman &amp; Package Upgrade Issues</option> <option value="49">[testing] Repo Forum</option> <option value="4">Creating &amp; Modifying Packages</option> <option value="38">AUR Issues, Discussion &amp; PKGBUILD Requests</option> </optgroup> <optgroup label="Contributions &amp; Discussion"> <option value="20">GNU/Linux Discussion</option> <option value="27">Community Contributions</option> <option value="33">Programming &amp; Scripting</option> <option value="30">Other Languages</option> <option value="47">Artwork and Screenshots</option> <option value="42">Try This</option> </optgroup> <optgroup label="/dev/null"> <option value="29">Off-Topic</option> <option value="48" selected="selected">Topics Going Nowhere</option> <option value="36">Dustbin</option> </optgroup> </select></label> <input type="submit" value=" Go " accesskey="g" /> </div> </form> </div> <div class="conr"> <p id="feedlinks"><span class="atom"><a href="extern.php?action=feed&amp;tid=162768&amp;type=atom">Atom topic feed</a></span></p> <p id="poweredby">Powered by <a href="http://fluxbb.org/">FluxBB</a></p> </div> <div class="clearer"></div> </div> </div> </div> </div> <div class="end-box"></div> </div> </body> </html>
