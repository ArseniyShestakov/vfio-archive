<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"> <html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en" dir="ltr"> <head> <meta http-equiv="Content-Type" content="text/html; charset=utf-8" /> <title>KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9 (Page 167) / Topics Going Nowhere / Arch Linux Forums</title> <link rel="stylesheet" type="text/css" href="style/ArchLinux.css" /> <link rel="canonical" href="viewtopic.php?id=162768&amp;p=167" title="Page 167" /> <link rel="prev" href="viewtopic.php?id=162768&amp;p=166" title="Page 166" /> <link rel="next" href="viewtopic.php?id=162768&amp;p=168" title="Page 168" /> <link rel="alternate" type="application/atom+xml" href="extern.php?action=feed&amp;tid=162768&amp;type=atom" title="Atom topic feed" /> <link rel="stylesheet" media="screen" href="style/ArchLinux/arch.css?v=3" /> <link rel="stylesheet" media="screen" href="style/ArchLinux/archnavbar.css?v=2" /> <link rel="shortcut icon" href="style/ArchLinux/favicon.ico" /> </head> <body> <div id="archnavbar" class="anb-forum"> <div id="archnavbarlogo"><h1><a href="http://www.archlinux.org/">Arch Linux</a></h1></div> <div id="archnavbarmenu"> <ul id="archnavbarlist"> <li id="anb-home"><a href="http://www.archlinux.org/">Home</a></li><li id="anb-packages"><a href="http://www.archlinux.org/packages/">Packages</a></li><li id="anb-forums" class="anb-selected"><a href="https://bbs.archlinux.org/">Forums</a></li><li id="anb-wiki"><a href="https://wiki.archlinux.org/">Wiki</a></li><li id="anb-bugs"><a href="https://bugs.archlinux.org/">Bugs</a></li><li id="anb-aur"><a href="https://aur.archlinux.org/">AUR</a></li><li id="anb-download"><a href="http://www.archlinux.org/download/">Download</a></li> </ul> </div> </div> <div id="punviewtopic" class="pun"> <div class="top-box"></div> <div class="punwrap"> <div id="brdheader" class="block"> <div class="box"> <div id="brdmenu" class="inbox"> <ul> <li id="navindex" class="isactive"><a href="index.php">Index</a></li> <li id="navuserlist"><a href="userlist.php">User list</a></li> <li id="navsearch"><a href="search.php">Search</a></li> <li id="navprofile"><a href="profile.php?id=80749">Profile</a></li> <li id="navlogout"><a href="login.php?action=out&amp;id=80749&amp;csrf_token=5c20501ec397bb45ef8ee8c84db232c8d8e421c6">Logout</a></li> </ul> </div> <div id="brdwelcome" class="inbox"> <ul class="conl"> <li><span>Logged in as <strong>SXX</strong></span></li> <li><span>Last visit: 2015-08-16 12:20:09</span></li> </ul> <ul class="conr"> <li><span>Topics: <a href="search.php?action=show_replies" title="Find topics you have posted to.">Posted</a> | <a href="search.php?action=show_new" title="Find topics with new posts since your last visit.">New</a> | <a href="search.php?action=show_recent" title="Find topics with recent posts.">Active</a> | <a href="search.php?action=show_unanswered" title="Find topics with no replies.">Unanswered</a></span></li> </ul> <div class="clearer"></div> </div> </div> </div> <div id="brdmain"> <div class="linkst"> <div class="inbox crumbsplus"> <ul class="crumbs"> <li><a href="index.php">Index</a></li> <li><span>»&#160;</span><a href="viewforum.php?id=48">Topics Going Nowhere</a></li> <li><span>»&#160;</span><strong><a href="viewtopic.php?id=162768">KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</a></strong></li> </ul> <div class="pagepost"> <p class="pagelink conl"><span class="pages-label">Pages: </span><a rel="prev" class="item1" href="viewtopic.php?id=162768&amp;p=166">Previous</a> <a href="viewtopic.php?id=162768">1</a> <span class="spacer">…</span> <a href="viewtopic.php?id=162768&amp;p=165">165</a> <a href="viewtopic.php?id=162768&amp;p=166">166</a> <strong>167</strong> <a href="viewtopic.php?id=162768&amp;p=168">168</a> <a href="viewtopic.php?id=162768&amp;p=169">169</a> <span class="spacer">…</span> <a href="viewtopic.php?id=162768&amp;p=234">234</a> <a rel="next" href="viewtopic.php?id=162768&amp;p=168">Next</a></p> <p class="postlink conr">Topic closed</p> </div> <div class="clearer"></div> </div> </div> <div id="p1501531" class="blockpost rowodd blockpost1"> <h2><span><span class="conr">#4151</span> <a href="viewtopic.php?pid=1501531#p1501531">2015-02-10 11:21:11</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=84538">mauorrizze</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2014-08-22</span></dd> <dd><span>Posts: 17</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=84538">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>valnare wrote:</cite><blockquote><div><p>Unfortunately the audio there stutters while playing sound.</p></div></blockquote></div><p>In my case all sound problems were latency related. If the problem gets worse when you pass more CPU cores and better when you pass less, then it&#039;s propably the same. Other phenomenons: tools like LatencyMon let the windows guest freeze really soon.<br />What helps: cpu pinning (for each guest and the host!), in case of HDMI: enable MSI in registry<br />Unconfirmed: hugepages</p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1501531">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1501555" class="blockpost roweven"> <h2><span><span class="conr">#4152</span> <a href="viewtopic.php?pid=1501555#p1501555">2015-02-10 12:54:26</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=86321">thearcherblog</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2014-10-30</span></dd> <dd><span>Posts: 165</span></dd> <dd class="usercontacts"><span class="email"><a href="mailto:jjgarcianorway@gmail.com">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <p>Hello <img src="https://bbs.archlinux.org/img/smilies/smile.png" width="15" height="15" alt="smile" /></p><p>I&#039;ve never tried the CPU pinning so I will make a newbie question... is something that I can only make with libvirt? My windows 8.1 guest is working perfectly and I&#039;m running it from the command line directly... is therre any way to improve (even more) the performance? Or I need libvirt and be able to convert form my script to the XML format?</p><p>Thanks a in advance <img src="https://bbs.archlinux.org/img/smilies/smile.png" width="15" height="15" alt="smile" /></p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1501555">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1501586" class="blockpost rowodd"> <h2><span><span class="conr">#4153</span> <a href="viewtopic.php?pid=1501586#p1501586">2015-02-10 15:13:40</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=75590">aw</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2013-10-04</span></dd> <dd><span>Posts: 921</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=75590">Email</a></span> <span class="website"><a href="http://vfio.blogspot.com/" rel="nofollow">Website</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>erganzi wrote:</cite><blockquote><div><div class="quotebox"><cite>aw wrote:</cite><blockquote><div><div class="quotebox"><cite>erganzi wrote:</cite><blockquote><div><p>thanks a lot.</p><br /><br /><p>when I configure the device as secondary graphics for the VM and do not use the x-vga option, the driver report code 12.</p></div></blockquote></div><p>Use 440fx, not q35</p><p>EDIT: You might just be able to move the GPU to the root complex, but behind a root port is known to cause the problem right now.</p></div></blockquote></div><br /><p>when I changed to i440fx, the driver report code 43. </p><p>my qemu commandline:</p><p>qemu-system-x86_64 -cpu SandyBridge,kvm=off -smp 1,sockets=1,cores=1,threads=1 \<br />-m 8192 -enable-kvm \<br />-rtc base=localtime,clock=host \<br />-acpitable file=/var/lib/libvirt/images/LENOVO-TC-90-MSFT-2.1.BIN \<br />-device virtio-scsi-pci,id=scsi \<br />-drive file=/var/lib/libvirt/images/win7_nvidia_k2_clean.img,cache=writeback,\<br />if=none,format=qcow2,aio=native,id=virtio-scsi-disk0 \<br />-device scsi-hd,drive=virtio-scsi-disk0 \<br />-net nic,model=virtio,macaddr=52:54:00:1a:2b:3c \<br />-net tap,ifname=tap0,script=/etc/qemu-ifup,downscript=/etc/qemu-ifdown \<br />-vga std -vnc :3 \<br />-device vfio-pci,host=04:00.0,addr=05.0,multifunction=on \<br />-usb -device usb-tablet \<br />-monitor stdio</p></div></blockquote></div><p>kvm=off is also not necessary with supported nvidia cards, but I don&#039;t see anything else off.&#160; What kernel/qemu are you using?</p> </div> <div class="postsignature postmsg"><hr /><p><a href="http://vfio.blogspot.com" rel="nofollow">http://vfio.blogspot.com</a><br />Looking for a more open forum to discuss vfio related uses?&#160; Try <a href="https://www.redhat.com/mailman/listinfo/vfio-users" rel="nofollow">https://www.redhat.com/mailman/listinfo/vfio-users</a></p></div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1501586">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1501614" class="blockpost roweven"> <h2><span><span class="conr">#4154</span> <a href="viewtopic.php?pid=1501614#p1501614">2015-02-10 16:34:58</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=88721">gnoma_86</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2015-02-10</span></dd> <dd><span>Posts: 1</span></dd> <dd class="usercontacts"><span class="email"><a href="mailto:k_georgiev@deltanews.bg">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <p>Hello,</p><p>I&#039;m new in KVM and I&#039;m trying to do a VGA pass through. </p><p>I&#039;ve done the vfio grouping and I attached my HD5770 to the virtual machine. Installation goes well. After install I see my video card in the device manager and when I install the driver they are both - VGA and HDMI visible with exact model. However it says that I have to reboot in order to get the device online. Tested and no picture coming from the physical VGA before reboot. After I install the driver and reboot I got BSOD on the spice during boot. I can hear during boot that the FAN of the HD5770 rotates faster, but when I connect a monitor it instantly goes in power saving. Tried with AMD driver, tried also with the driver from ASUS, I got the same result. </p><p>I removed the virtual video card and spice. What I noticed is that even before OS startup I cannot see the boot at all, the display goes to power saving instantly. During power on the VM it doesn&#039;t even blink or go online for a second, it stays constantly off. </p><p>From what I saw in youtube, I should be able to see my VM booting on the VGA passed through to the VM. </p><p>Did anybody face the same issue? <br />Please help. </p><p>Thank you.</p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1501614">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1501618" class="blockpost rowodd"> <h2><span><span class="conr">#4155</span> <a href="viewtopic.php?pid=1501618#p1501618">2015-02-10 16:39:47</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=88701">valnare</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2015-02-09</span></dd> <dd><span>Posts: 3</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=88701">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>mauorrizze wrote:</cite><blockquote><div><p>In my case all sound problems were latency related. If the problem gets worse when you pass more CPU cores and better when you pass less, then it&#039;s propably the same. Other phenomenons: tools like LatencyMon let the windows guest freeze really soon.<br />What helps: cpu pinning (for each guest and the host!), in case of HDMI: enable MSI in registry<br />Unconfirmed: hugepages</p></div></blockquote></div><p>I tried playing audio with only a single core pinned on the host and the guest. Still the same result. The stuttering also does not change with more load on the CPU.<br />Latencymon worked while only using one cpu core, when I tried running it with more than one it frooze after 2 seconds. MSI was enabled, didn&#039;t change anything for the stuttering. I&#039;ll experiment a bit more with cpu pinning though.<br />Enabling or disabling hugepages didn&#039;t do anything for me.</p><p>Thank you for your suggestions <img src="https://bbs.archlinux.org/img/smilies/smile.png" width="15" height="15" alt="smile" /></p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1501618">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1501733" class="blockpost roweven"> <h2><span><span class="conr">#4156</span> <a href="viewtopic.php?pid=1501733#p1501733">2015-02-10 22:32:44</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=88702">gessert</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2015-02-09</span></dd> <dd><span>Posts: 5</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=88702">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <p>Goog evening,</p><p>I&#039;ve been getting strange results and need guidance.</p><p>Graphicscards:<br />AMD Radeon r5 230 <br />GeForce GTX 970<br />GeForce GTX 970</p><p>I&#039;m trying to get two different configurations to work:<br />Host: AMD Radeon r5 230 <br />Guest1: Nvidia GeForce GTX 970<br />Guest2: Nvidia GeForce GTX 970</p><p>Host: AMD Radeon r5 230 <br />Guest1: Nvidia GeForce GTX 970<br />Guest1: Nvidia GeForce GTX 970</p><p>Basically I want to use the Nvidia cards either for two different guests or as an SLI configuration in a single guest.</p><p><strong>I have successfully passed the second geforce card to a guest, but the first one will not work.</strong> The first card happens to be the card used by the host&#039;s uefi, grub and terminal booting messages. I assume the problem stems from here. I can not change the cards&#039; order, nor set a primary grapicsadapter in the host&#039;s uefi. The first geforce card&#039;s monitor stays active after host boot and shows a single underscore. When I run the guest with the first card configured, the monitor goes blank and I get a warning in the qemu-window:</p><div class="codebox"><pre><code>-device vfio-pci,host=04:00.0,multifunction=on,x-vga=on: VFIO 0000:04:00.0 BAR 3 mmap unsupported. Performance may be slow</code></pre></div><p>Info:<br />Distribution: Debian Wheezy (running on wheezy-backports)<br />qemu/kvm 2.1<br />Seabios<br />3.16.0-0.bpo.4-amd64</p><p>lspci | grep NVIDIA</p><div class="codebox"><pre><code>03:00.0 VGA compatible controller [0300]: NVIDIA Corporation Device [10de:13c2] (rev a1) 03:00.1 Audio device [0403]: NVIDIA Corporation Device [10de:0fbb] (rev a1) 04:00.0 VGA compatible controller [0300]: NVIDIA Corporation Device [10de:13c2] (rev a1) 04:00.1 Audio device [0403]: NVIDIA Corporation Device [10de:0fbb] (rev a1)</code></pre></div><p>GRUB_CMDLINE_LINUX_DEFAULT <br />in /etc/default/grub.cfg</p><div class="codebox"><pre><code>GRUB_CMDLINE_LINUX_DEFAULT=&quot;quiet intel_iommu=on vfio_iommu_type1.allow_unsafe_interrupts=1&quot;</code></pre></div><p>run via &quot;update-grub&quot;</p><p>/etc/modules</p><div class="codebox"><pre><code>pci_stub vfio vfio_iommu_type1 vfio_pci kvm kvm_intel</code></pre></div><p>/etc/initramfs-tools/modules</p><div class="codebox"><pre><code>pci_stub ids=10de:13c2,10de:0fbb</code></pre></div><p>run via &quot;update-initramfs -u&quot;</p><p>dmesg | pci-stub</p><div class="codebox"><pre><code>[ 1.449636] pci-stub: add 10DE:13C2 sub=FFFFFFFF:FFFFFFFF cls=00000000/00000000 [ 1.449654] pci-stub 0000:03:00.0: claimed by stub [ 1.449662] pci-stub 0000:04:00.0: claimed by stub [ 1.449664] pci-stub: add 10DE:0FBB sub=FFFFFFFF:FFFFFFFF cls=00000000/00000000 [ 1.449675] pci-stub 0000:03:00.1: claimed by stub [ 1.449682] pci-stub 0000:04:00.1: claimed by stub</code></pre></div><p><strong>Working:</strong></p><p>/etc/vfio-pci1.cfg</p><div class="codebox"><pre><code>0000:03:00.0 0000:03:00.1</code></pre></div><p>/home/me/vm1</p><div class="codebox"><pre class="vscroll"><code>#!/bin/bash configfile=/etc/vfio-pci1.cfg vfiobind() { dev=&quot;$1&quot; vendor=$(cat /sys/bus/pci/devices/$dev/vendor) device=$(cat /sys/bus/pci/devices/$dev/device) if [ -e /sys/bus/pci/devices/$dev/driver ]; then echo $dev &gt; /sys/bus/pci/devices/$dev/driver/unbind fi echo $vendor $device &gt; /sys/bus/pci/drivers/vfio-pci/new_id } modprobe vfio-pci cat $configfile | while read line;do echo $line | grep ^# &gt;/dev/null 2&gt;&amp;1 &amp;&amp; continue vfiobind $line done export QEMU_AUDIO_DRV=alsa QEMU_AUDIO_TIMER_PERIOD=0 sudo qemu-system-x86_64 -enable-kvm -M pc -m 8192 -cpu host,kvm=off \ -smp 4,sockets=1,cores=4,threads=1 \ -bios /usr/share/seabios/bios.bin -vga none \ -device vfio-pci,host=03:00.0,multifunction=on,x-vga=on \ -device vfio-pci,host=03:00.1 \ -usb -usbdevice host:04d9:a086 -usbdevice host:046a:0023 \ -drive file=/home/me/windows10.img,format=raw,media=disk \ -drive file=/home/me/win10.iso,media=cdrom \ -soundhw ac97 \ -boot menu=on exit 0</code></pre></div><p><strong>not working:</strong></p><p>/etc/vfio-pci2.cfg</p><div class="codebox"><pre><code>0000:04:00.0 0000:04:00.1</code></pre></div><p>/home/me/vm2</p><div class="codebox"><pre class="vscroll"><code>#!/bin/bash configfile=/etc/vfio-pci2.cfg vfiobind() { dev=&quot;$1&quot; vendor=$(cat /sys/bus/pci/devices/$dev/vendor) device=$(cat /sys/bus/pci/devices/$dev/device) if [ -e /sys/bus/pci/devices/$dev/driver ]; then echo $dev &gt; /sys/bus/pci/devices/$dev/driver/unbind fi echo $vendor $device &gt; /sys/bus/pci/drivers/vfio-pci/new_id } modprobe vfio-pci cat $configfile | while read line;do echo $line | grep ^# &gt;/dev/null 2&gt;&amp;1 &amp;&amp; continue vfiobind $line done export QEMU_AUDIO_DRV=alsa QEMU_AUDIO_TIMER_PERIOD=0 sudo qemu-system-x86_64 -enable-kvm -M pc -m 8192 -cpu host,kvm=off \ -smp 4,sockets=1,cores=4,threads=1 \ -bios /usr/share/seabios/bios.bin -vga none \ -device vfio-pci,host=04:00.0,multifunction=on,x-vga=on \ -device vfio-pci,host=04:00.1 \ -usb -usbdevice host:04d9:a086 -usbdevice host:046a:0023 \ -drive file=/home/me/windows10.img,format=raw,media=disk \ -drive file=/home/me/win10.iso,media=cdrom \ -soundhw ac97 \ -boot menu=on exit 0</code></pre></div><p>The &quot;broken&quot; guest&#039;s boot attempt creates additional messages:</p><p>dmesg | grep 0000:04</p><div class="codebox"><pre><code>vfio-pci 0000:04:00.0: Invalid ROM contents</code></pre></div><p>I dumped the graphicscard&#039;s rom and added a romfile parameter to the config, but I guess it&#039;s just a follow up problem.</p><div class="codebox"><pre><code>-device vfio-pci,host=04:00.0,multifunction=on,x-vga=on,romfile=/home/me/vbios.rom \</code></pre></div><p>This does get rid of the Invalid ROM contents error, but still no output on the screen.</p><br /><p>I have already dumped around 70 hours into this project and I&#039;m afraid my linux-knowledge is rather limited. I&#039;m part of the raspberry-pi generation of linux users. So help is vastly appreciated.</p><p>I would offer beer, if you were in throwing range.</p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1501733">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1501736" class="blockpost rowodd"> <h2><span><span class="conr">#4157</span> <a href="viewtopic.php?pid=1501736#p1501736">2015-02-10 22:59:09</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=75590">aw</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2013-10-04</span></dd> <dd><span>Posts: 921</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=75590">Email</a></span> <span class="website"><a href="http://vfio.blogspot.com/" rel="nofollow">Website</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>gessert wrote:</cite><blockquote><div><div class="codebox"><pre><code>-device vfio-pci,host=04:00.0,multifunction=on,x-vga=on: VFIO 0000:04:00.0 BAR 3 mmap unsupported. Performance may be slow</code></pre></div></div></blockquote></div><p>As Duelist figured out, this means a host driver is attached to the device.&#160; A common problem when using the boot graphics device.&#160; Look in /proc/iomem, figure out what it is, and disable it.</p> </div> <div class="postsignature postmsg"><hr /><p><a href="http://vfio.blogspot.com" rel="nofollow">http://vfio.blogspot.com</a><br />Looking for a more open forum to discuss vfio related uses?&#160; Try <a href="https://www.redhat.com/mailman/listinfo/vfio-users" rel="nofollow">https://www.redhat.com/mailman/listinfo/vfio-users</a></p></div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1501736">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1501771" class="blockpost roweven"> <h2><span><span class="conr">#4158</span> <a href="viewtopic.php?pid=1501771#p1501771">2015-02-11 01:18:46</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=83411">erganzi</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2014-07-09</span></dd> <dd><span>Posts: 19</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=83411">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>aw wrote:</cite><blockquote><div><div class="quotebox"><cite>erganzi wrote:</cite><blockquote><div><div class="quotebox"><cite>aw wrote:</cite><blockquote><div><p>Use 440fx, not q35</p><p>EDIT: You might just be able to move the GPU to the root complex, but behind a root port is known to cause the problem right now.</p></div></blockquote></div><br /><p>when I changed to i440fx, the driver report code 43. </p><p>my qemu commandline:</p><p>qemu-system-x86_64 -cpu SandyBridge,kvm=off -smp 1,sockets=1,cores=1,threads=1 \<br />-m 8192 -enable-kvm \<br />-rtc base=localtime,clock=host \<br />-acpitable file=/var/lib/libvirt/images/LENOVO-TC-90-MSFT-2.1.BIN \<br />-device virtio-scsi-pci,id=scsi \<br />-drive file=/var/lib/libvirt/images/win7_nvidia_k2_clean.img,cache=writeback,\<br />if=none,format=qcow2,aio=native,id=virtio-scsi-disk0 \<br />-device scsi-hd,drive=virtio-scsi-disk0 \<br />-net nic,model=virtio,macaddr=52:54:00:1a:2b:3c \<br />-net tap,ifname=tap0,script=/etc/qemu-ifup,downscript=/etc/qemu-ifdown \<br />-vga std -vnc :3 \<br />-device vfio-pci,host=04:00.0,addr=05.0,multifunction=on \<br />-usb -device usb-tablet \<br />-monitor stdio</p></div></blockquote></div><p>kvm=off is also not necessary with supported nvidia cards, but I don&#039;t see anything else off.&#160; What kernel/qemu are you using?</p></div></blockquote></div><p>Hi, aw:</p><p>my kernel/qemu version info as following:</p><p>linux-3.12.5 from kernel.org with following patchs.<br />pci/iommu: Quirk non-compliant PCIe-to-PCI bridges<br />i915_fixes[1]<br />i915_fixes[2]<br />Enable overrides for missing ACS capabilities</p><p>qemu-2.0.0 with patch<br />vfio-pci: Disallow device from using NoSnoop transactions</p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1501771">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1501773" class="blockpost rowodd"> <h2><span><span class="conr">#4159</span> <a href="viewtopic.php?pid=1501773#p1501773">2015-02-11 01:26:49</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=75590">aw</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2013-10-04</span></dd> <dd><span>Posts: 921</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=75590">Email</a></span> <span class="website"><a href="http://vfio.blogspot.com/" rel="nofollow">Website</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>erganzi wrote:</cite><blockquote><div><p>Hi, aw:</p><p>my kernel/qemu version info as following:</p><p>linux-3.12.5 from kernel.org with following patchs.<br />pci/iommu: Quirk non-compliant PCIe-to-PCI bridges<br />i915_fixes[1]<br />i915_fixes[2]<br />Enable overrides for missing ACS capabilities</p><p>qemu-2.0.0 with patch<br />vfio-pci: Disallow device from using NoSnoop transactions</p></div></blockquote></div><p>Oh jeez, ping me again when you&#039;re using something reasonable.&#160; I&#039;d suggest at least 3.16 and QEMU 2.2.&#160; You don&#039;t need any patches unless you have ACS issues with IOMMU groups.</p> </div> <div class="postsignature postmsg"><hr /><p><a href="http://vfio.blogspot.com" rel="nofollow">http://vfio.blogspot.com</a><br />Looking for a more open forum to discuss vfio related uses?&#160; Try <a href="https://www.redhat.com/mailman/listinfo/vfio-users" rel="nofollow">https://www.redhat.com/mailman/listinfo/vfio-users</a></p></div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1501773">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1501779" class="blockpost roweven"> <h2><span><span class="conr">#4160</span> <a href="viewtopic.php?pid=1501779#p1501779">2015-02-11 02:17:26</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=83411">erganzi</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2014-07-09</span></dd> <dd><span>Posts: 19</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=83411">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>aw wrote:</cite><blockquote><div><div class="quotebox"><cite>erganzi wrote:</cite><blockquote><div><p>Hi, aw:</p><p>my kernel/qemu version info as following:</p><p>linux-3.12.5 from kernel.org with following patchs.<br />pci/iommu: Quirk non-compliant PCIe-to-PCI bridges<br />i915_fixes[1]<br />i915_fixes[2]<br />Enable overrides for missing ACS capabilities</p><p>qemu-2.0.0 with patch<br />vfio-pci: Disallow device from using NoSnoop transactions</p></div></blockquote></div><p>Oh jeez, ping me again when you&#039;re using something reasonable.&#160; I&#039;d suggest at least 3.16 and QEMU 2.2.&#160; You don&#039;t need any patches unless you have ACS issues with IOMMU groups.</p></div></blockquote></div><br /><p>OK, I will try. <br />but yesterday I tried RHEL 7.0, it worked well with GRID K2. and the kernel version is 3.10.0-121.el7.x86_64 , qemu version is 1.5.3-60.el7.<br />had they work with the patched ?</p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1501779">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1501780" class="blockpost rowodd"> <h2><span><span class="conr">#4161</span> <a href="viewtopic.php?pid=1501780#p1501780">2015-02-11 02:26:19</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=75590">aw</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2013-10-04</span></dd> <dd><span>Posts: 921</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=75590">Email</a></span> <span class="website"><a href="http://vfio.blogspot.com/" rel="nofollow">Website</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>erganzi wrote:</cite><blockquote><div><div class="quotebox"><cite>aw wrote:</cite><blockquote><div><div class="quotebox"><cite>erganzi wrote:</cite><blockquote><div><p>Hi, aw:</p><p>my kernel/qemu version info as following:</p><p>linux-3.12.5 from kernel.org with following patchs.<br />pci/iommu: Quirk non-compliant PCIe-to-PCI bridges<br />i915_fixes[1]<br />i915_fixes[2]<br />Enable overrides for missing ACS capabilities</p><p>qemu-2.0.0 with patch<br />vfio-pci: Disallow device from using NoSnoop transactions</p></div></blockquote></div><p>Oh jeez, ping me again when you&#039;re using something reasonable.&#160; I&#039;d suggest at least 3.16 and QEMU 2.2.&#160; You don&#039;t need any patches unless you have ACS issues with IOMMU groups.</p></div></blockquote></div><br /><p>OK, I will try. <br />but yesterday I tried RHEL 7.0, it worked well with GRID K2. and the kernel version is 3.10.0-121.el7.x86_64 , qemu version is 1.5.3-60.el7.<br />had they work with the patched ?</p></div></blockquote></div><p>If only you knew how much effort we put in to backporting fixes and features while maintaining ABI compatibility for those older base versions...</p> </div> <div class="postsignature postmsg"><hr /><p><a href="http://vfio.blogspot.com" rel="nofollow">http://vfio.blogspot.com</a><br />Looking for a more open forum to discuss vfio related uses?&#160; Try <a href="https://www.redhat.com/mailman/listinfo/vfio-users" rel="nofollow">https://www.redhat.com/mailman/listinfo/vfio-users</a></p></div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1501780">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1501781" class="blockpost roweven"> <h2><span><span class="conr">#4162</span> <a href="viewtopic.php?pid=1501781#p1501781">2015-02-11 02:31:59</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=83411">erganzi</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2014-07-09</span></dd> <dd><span>Posts: 19</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=83411">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>aw wrote:</cite><blockquote><div><div class="quotebox"><cite>erganzi wrote:</cite><blockquote><div><div class="quotebox"><cite>aw wrote:</cite><blockquote><div><p>Oh jeez, ping me again when you&#039;re using something reasonable.&#160; I&#039;d suggest at least 3.16 and QEMU 2.2.&#160; You don&#039;t need any patches unless you have ACS issues with IOMMU groups.</p></div></blockquote></div><br /><p>OK, I will try. <br />but yesterday I tried RHEL 7.0, it worked well with GRID K2. and the kernel version is 3.10.0-121.el7.x86_64 , qemu version is 1.5.3-60.el7.<br />had they work with the patched ?</p></div></blockquote></div><p>If only you knew how much effort we put in to backporting fixes and features while maintaining ABI compatibility for those older base versions...</p></div></blockquote></div><p>Thanks for those work.&#160; I will try what you suggest and give a feedback.</p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1501781">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1501787" class="blockpost rowodd"> <h2><span><span class="conr">#4163</span> <a href="viewtopic.php?pid=1501787#p1501787">2015-02-11 02:51:36</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=88564">hotfunction</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2015-02-05</span></dd> <dd><span>Posts: 10</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=88564">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <p>Hi..</p><div class="quotebox"><blockquote><div><p>That black window is the sdl graphics head for the VM which appears because you haven&#039;t used the -nographic option.&#160; The GPU output should be on a monitor connected to the assigned GPU.&#160; I&#039;d also recommend, like I almost always do, using 440fx rather than q35 for the VM.&#160; It looks like you&#039;re using a Linux guest, but afaik, the nvidia driver does not have an issue with PCIe topology in Linux (until you get to lots of GPUs and that may already be fixed too).</p></div></blockquote></div><p>I added -nographics option and -vga none, mixed together with the script changed into 440fx, but none came up out of the window, the session is there and running, but the qemu operation is not cancelable with ctrl + c and i dont see any window output. i went into another session and checked it with &quot;top&quot; command, and the qemu is still there...</p><p>also, i tried to remove my nographics and vga none, and just normally run that VM without those options, but all i get is just a black monitor of qemu, not even booting into seabios and it stucks there forever...</p><p>here is my script for 440fx:</p><div class="codebox"><pre class="vscroll"><code>#!/bin/bash configfile=/etc/vfio-pci1.cfg vfiobind() { dev=&quot;$1&quot; vendor=$(cat /sys/bus/pci/devices/$dev/vendor) device=$(cat /sys/bus/pci/devices/$dev/device) if [ -e /sys/bus/pci/devices/$dev/driver ]; then echo $dev &gt; /sys/bus/pci/devices/$dev/driver/unbind fi echo $vendor $device &gt; /sys/bus/pci/drivers/vfio-pci/new_id } modprobe vfio-pci cat $configfile | while read line;do echo $line | grep ^# &gt;/dev/null 2&gt;&amp;1 &amp;&amp; continue vfiobind $line done sudo qemu-system-x86_64 -enable-kvm -M pc -m 2048 -cpu host \ -smp 2,sockets=1,cores=2,threads=1 \ -bios /usr/share/seabios/bios.bin \ -device vfio-pci,host=05:00.0,multifunction=on,x-vga=on,romfile=/home/sslab719/MSI.GTX560Ti.1024.110825.rom \ -device vfio-pci,host=05:00.1 \ -drive file=/home/sslab719/VMimages/VM.img,format=qcow2,media=disk \ #-drive file=/home/me/win10.iso,media=cdrom \ -boot menu=on exit 0</code></pre></div><p> any ideas..?</p> <p class="postedit"><em>Last edited by hotfunction (2015-02-11 03:45:21)</em></p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1501787">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1501800" class="blockpost roweven"> <h2><span><span class="conr">#4164</span> <a href="viewtopic.php?pid=1501800#p1501800">2015-02-11 04:18:57</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=75590">aw</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2013-10-04</span></dd> <dd><span>Posts: 921</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=75590">Email</a></span> <span class="website"><a href="http://vfio.blogspot.com/" rel="nofollow">Website</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>hotfunction wrote:</cite><blockquote><div><p> any ideas..?</p></div></blockquote></div><p>I already suggested that the ROM might be the problem and you don&#039;t seem to have much confidence that it&#039;s the correct one.&#160; Why haven&#039;t you tried anything further on that path?</p> </div> <div class="postsignature postmsg"><hr /><p><a href="http://vfio.blogspot.com" rel="nofollow">http://vfio.blogspot.com</a><br />Looking for a more open forum to discuss vfio related uses?&#160; Try <a href="https://www.redhat.com/mailman/listinfo/vfio-users" rel="nofollow">https://www.redhat.com/mailman/listinfo/vfio-users</a></p></div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1501800">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1501810" class="blockpost rowodd"> <h2><span><span class="conr">#4165</span> <a href="viewtopic.php?pid=1501810#p1501810">2015-02-11 05:47:11</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=83411">erganzi</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2014-07-09</span></dd> <dd><span>Posts: 19</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=83411">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>erganzi wrote:</cite><blockquote><div><div class="quotebox"><cite>aw wrote:</cite><blockquote><div><div class="quotebox"><cite>erganzi wrote:</cite><blockquote><div><br /><p>OK, I will try. <br />but yesterday I tried RHEL 7.0, it worked well with GRID K2. and the kernel version is 3.10.0-121.el7.x86_64 , qemu version is 1.5.3-60.el7.<br />had they work with the patched ?</p></div></blockquote></div><p>If only you knew how much effort we put in to backporting fixes and features while maintaining ABI compatibility for those older base versions...</p></div></blockquote></div><p>Thanks for those work.&#160; I will try what you suggest and give a feedback.</p></div></blockquote></div><p>Hi, aw:</p><p>I just change the kernel version to 3.18.6 from kernel.org. It now work for me.&#160; qemu version is still 2.0.</p><p>I compare the result of the command &quot;lspci -vvv -k -s 04:00.0&quot; between linux-3.12.5 and linux-3.18.6, there are just a little different.<br />If it can give you some idea.</p><div class="quotebox"><blockquote><div><p>kernel: 3.12.5</p><p>04:00.0 VGA compatible controller: nVidia Corporation Device 11bf (rev a1) (prog-if 00 [VGA controller])<br />&#160; &#160; Subsystem: nVidia Corporation Device 100d<br />&#160; &#160; Control: I/O- Mem- BusMaster- SpecCycle- MemWINV- VGASnoop- ParErr- Stepping- SERR- FastB2B- DisINTx-<br />&#160; &#160; Status: Cap+ 66MHz- UDF- FastB2B- ParErr- DEVSEL=fast &gt;TAbort- &lt;TAbort- &lt;MAbort- &gt;SERR- &lt;PERR- INTx-<br />&#160; &#160; Interrupt: pin A routed to IRQ 11<br />&#160; &#160; Region 0: Memory at c9000000 (32-bit, non-prefetchable) [disabled] [size=16M]<br />&#160; &#160; Region 1: Memory at b8000000 (64-bit, prefetchable) [disabled] [size=128M]<br />&#160; &#160; Region 3: Memory at c0000000 (64-bit, prefetchable) [disabled] [size=32M]<br />&#160; &#160; Region 5: I/O ports at 9000 [disabled] [size=128]<br />&#160; &#160; Expansion ROM at ca000000 [disabled] [size=512K]<br />&#160; &#160; Capabilities: [60] Power Management version 3<br />&#160; &#160; &#160; &#160; Flags: PMEClk- DSI- D1- D2- AuxCurrent=0mA PME(D0-,D1-,D2-,D3hot-,D3cold-)<br />&#160; &#160; &#160; &#160; Status: D0 NoSoftRst+ PME-Enable- DSel=0 DScale=0 PME-<br />&#160; &#160; Capabilities: [68] MSI: Enable- Count=1/1 Maskable- 64bit+<br />&#160; &#160; &#160; &#160; Address: 0000000000000000&#160; Data: 0000<br />&#160; &#160; Capabilities: [78] Express (v2) Endpoint, MSI 00<br />&#160; &#160; &#160; &#160; DevCap:&#160; &#160; MaxPayload 256 bytes, PhantFunc 0, Latency L0s unlimited, L1 &lt;64us<br />&#160; &#160; &#160; &#160; &#160; &#160; ExtTag+ AttnBtn- AttnInd- PwrInd- RBE+ FLReset-<br />&#160; &#160; &#160; &#160; DevCtl:&#160; &#160; Report errors: Correctable- Non-Fatal- Fatal- Unsupported-<br />&#160; &#160; &#160; &#160; &#160; &#160; RlxdOrd- ExtTag- PhantFunc- AuxPwr- NoSnoop+<br />&#160; &#160; &#160; &#160; &#160; &#160; MaxPayload 256 bytes, MaxReadReq 512 bytes<br />&#160; &#160; &#160; &#160; DevSta:&#160; &#160; CorrErr- UncorrErr- FatalErr- UnsuppReq- AuxPwr- TransPend-<br />&#160; &#160; &#160; &#160; LnkCap:&#160; &#160; Port #8, Speed unknown, Width x16, ASPM L0s L1, Latency L0 &lt;512ns, L1 &lt;4us<br />&#160; &#160; &#160; &#160; &#160; &#160; ClockPM+ Surprise- LLActRep- BwNot-<br />&#160; &#160; &#160; &#160; LnkCtl:&#160; &#160; ASPM Disabled; RCB 64 bytes Disabled- Retrain- CommClk-<br />&#160; &#160; &#160; &#160; &#160; &#160; ExtSynch- ClockPM- AutWidDis- BWInt- AutBWInt-<br />&#160; &#160; &#160; &#160; LnkSta:&#160; &#160; Speed 2.5GT/s, Width x16, TrErr- Train- SlotClk+ DLActive- BWMgmt- ABWMgmt-<br />&#160; &#160; &#160; &#160; DevCap2: Completion Timeout: Range AB, TimeoutDis+<br />&#160; &#160; &#160; &#160; DevCtl2: Completion Timeout: 50us to 50ms, TimeoutDis-<br />&#160; &#160; &#160; &#160; LnkCtl2: Target Link Speed: Unknown, EnterCompliance- SpeedDis-, Selectable De-emphasis: -6dB<br />&#160; &#160; &#160; &#160; &#160; &#160;&#160; Transmit Margin: Normal Operating Range, EnterModifiedCompliance- ComplianceSOS-<br />&#160; &#160; &#160; &#160; &#160; &#160;&#160; Compliance De-emphasis: -6dB<br />&#160; &#160; &#160; &#160; LnkSta2: Current De-emphasis Level: -6dB<br />&#160; &#160; Capabilities: [b4] Vendor Specific Information &lt;?&gt;<br />&#160; &#160; Capabilities: [100] Virtual Channel &lt;?&gt;<br />&#160; &#160; Capabilities: [128] Power Budgeting &lt;?&gt;<br />&#160; &#160; Capabilities: [420] Advanced Error Reporting<br />&#160; &#160; &#160; &#160; UESta:&#160; &#160; DLP- SDES- TLP- FCP- CmpltTO- CmpltAbrt- UnxCmplt- RxOF- MalfTLP- ECRC- UnsupReq- ACSViol-<br />&#160; &#160; &#160; &#160; UEMsk:&#160; &#160; DLP- SDES- TLP- FCP- CmpltTO- CmpltAbrt- UnxCmplt- RxOF- MalfTLP- ECRC- UnsupReq+ ACSViol-<br />&#160; &#160; &#160; &#160; UESvrt:&#160; &#160; DLP+ SDES+ TLP- FCP+ CmpltTO- CmpltAbrt- UnxCmplt- RxOF+ MalfTLP+ ECRC- UnsupReq- ACSViol-<br />&#160; &#160; &#160; &#160; CESta:&#160; &#160; RxErr- BadTLP- BadDLLP- Rollover- Timeout- NonFatalErr-<br />&#160; &#160; &#160; &#160; CEMsk:&#160; &#160; RxErr- BadTLP- BadDLLP- Rollover- Timeout- NonFatalErr+<br />&#160; &#160; &#160; &#160; AERCap:&#160; &#160; First Error Pointer: 00, GenCap- CGenEn- ChkCap- ChkEn-<br />&#160; &#160; Capabilities: [600] Vendor Specific Information &lt;?&gt;<br />&#160; &#160; Capabilities: [900] #19<br />&#160; &#160; Kernel driver in use: vfio-pci<br />&#160; &#160; Kernel modules: nouveau, nvidiafb</p></div></blockquote></div><div class="quotebox"><blockquote><div><p>kernel: 3.18.6</p><p>04:00.0 VGA compatible controller: nVidia Corporation Device 11bf (rev a1) (prog-if 00 [VGA controller])<br />&#160; &#160; Subsystem: nVidia Corporation Device 100d<br />&#160; &#160; Control: I/O- Mem- BusMaster- SpecCycle- MemWINV- VGASnoop- ParErr- Stepping- SERR- FastB2B- DisINTx+<br />&#160; &#160; Status: Cap+ 66MHz- UDF- FastB2B- ParErr- DEVSEL=fast &gt;TAbort- &lt;TAbort- &lt;MAbort- &gt;SERR- &lt;PERR- INTx-<br />&#160; &#160; Interrupt: pin A routed to IRQ 27<br />&#160; &#160; Region 0: Memory at c9000000 (32-bit, non-prefetchable) [disabled] [size=16M]<br />&#160; &#160; Region 1: Memory at b8000000 (64-bit, prefetchable) [disabled] [size=128M]<br />&#160; &#160; Region 3: Memory at c0000000 (64-bit, prefetchable) [disabled] [size=32M]<br />&#160; &#160; Region 5: I/O ports at 9000 [disabled] [size=128]<br />&#160; &#160; Expansion ROM at ca000000 [disabled] [size=512K]<br />&#160; &#160; Capabilities: [60] Power Management version 3<br />&#160; &#160; &#160; &#160; Flags: PMEClk- DSI- D1- D2- AuxCurrent=0mA PME(D0-,D1-,D2-,D3hot-,D3cold-)<br />&#160; &#160; &#160; &#160; Status: D0 NoSoftRst+ PME-Enable- DSel=0 DScale=0 PME-<br />&#160; &#160; Capabilities: [68] MSI: Enable- Count=1/1 Maskable- 64bit+<br />&#160; &#160; &#160; &#160; Address: 0000000000000000&#160; Data: 0000<br />&#160; &#160; Capabilities: [78] Express (v2) Endpoint, MSI 00<br />&#160; &#160; &#160; &#160; DevCap:&#160; &#160; MaxPayload 256 bytes, PhantFunc 0, Latency L0s unlimited, L1 &lt;64us<br />&#160; &#160; &#160; &#160; &#160; &#160; ExtTag+ AttnBtn- AttnInd- PwrInd- RBE+ FLReset-<br />&#160; &#160; &#160; &#160; DevCtl:&#160; &#160; Report errors: Correctable- Non-Fatal- Fatal- Unsupported-<br />&#160; &#160; &#160; &#160; &#160; &#160; RlxdOrd+ ExtTag+ PhantFunc- AuxPwr- NoSnoop-<br />&#160; &#160; &#160; &#160; &#160; &#160; MaxPayload 256 bytes, MaxReadReq 512 bytes<br />&#160; &#160; &#160; &#160; DevSta:&#160; &#160; CorrErr- UncorrErr- FatalErr- UnsuppReq- AuxPwr- TransPend-<br />&#160; &#160; &#160; &#160; LnkCap:&#160; &#160; Port #8, Speed unknown, Width x16, ASPM L0s L1, Latency L0 &lt;512ns, L1 &lt;4us<br />&#160; &#160; &#160; &#160; &#160; &#160; ClockPM+ Surprise- LLActRep- BwNot-<br />&#160; &#160; &#160; &#160; LnkCtl:&#160; &#160; ASPM Disabled; RCB 64 bytes Disabled- Retrain- CommClk-<br />&#160; &#160; &#160; &#160; &#160; &#160; ExtSynch- ClockPM- AutWidDis- BWInt- AutBWInt-<br />&#160; &#160; &#160; &#160; LnkSta:&#160; &#160; Speed 2.5GT/s, Width x16, TrErr- Train- SlotClk+ DLActive- BWMgmt- ABWMgmt-<br />&#160; &#160; &#160; &#160; DevCap2: Completion Timeout: Range AB, TimeoutDis+<br />&#160; &#160; &#160; &#160; DevCtl2: Completion Timeout: 50us to 50ms, TimeoutDis-<br />&#160; &#160; &#160; &#160; LnkCtl2: Target Link Speed: Unknown, EnterCompliance- SpeedDis-, Selectable De-emphasis: -6dB<br />&#160; &#160; &#160; &#160; &#160; &#160;&#160; Transmit Margin: Normal Operating Range, EnterModifiedCompliance- ComplianceSOS-<br />&#160; &#160; &#160; &#160; &#160; &#160;&#160; Compliance De-emphasis: -6dB<br />&#160; &#160; &#160; &#160; LnkSta2: Current De-emphasis Level: -6dB<br />&#160; &#160; Capabilities: [b4] Vendor Specific Information &lt;?&gt;<br />&#160; &#160; Capabilities: [100] Virtual Channel &lt;?&gt;<br />&#160; &#160; Capabilities: [128] Power Budgeting &lt;?&gt;<br />&#160; &#160; Capabilities: [420] Advanced Error Reporting<br />&#160; &#160; &#160; &#160; UESta:&#160; &#160; DLP- SDES- TLP- FCP- CmpltTO- CmpltAbrt- UnxCmplt- RxOF- MalfTLP- ECRC- UnsupReq- ACSViol-<br />&#160; &#160; &#160; &#160; UEMsk:&#160; &#160; DLP- SDES- TLP- FCP- CmpltTO- CmpltAbrt- UnxCmplt- RxOF- MalfTLP- ECRC- UnsupReq- ACSViol-<br />&#160; &#160; &#160; &#160; UESvrt:&#160; &#160; DLP+ SDES+ TLP- FCP+ CmpltTO- CmpltAbrt- UnxCmplt- RxOF+ MalfTLP+ ECRC- UnsupReq- ACSViol-<br />&#160; &#160; &#160; &#160; CESta:&#160; &#160; RxErr- BadTLP- BadDLLP- Rollover- Timeout- NonFatalErr-<br />&#160; &#160; &#160; &#160; CEMsk:&#160; &#160; RxErr- BadTLP- BadDLLP- Rollover- Timeout- NonFatalErr+<br />&#160; &#160; &#160; &#160; AERCap:&#160; &#160; First Error Pointer: 00, GenCap- CGenEn- ChkCap- ChkEn-<br />&#160; &#160; Capabilities: [600] Vendor Specific Information &lt;?&gt;<br />&#160; &#160; Capabilities: [900] #19<br />&#160; &#160; Kernel driver in use: vfio-pci</p></div></blockquote></div> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1501810">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1501812" class="blockpost roweven"> <h2><span><span class="conr">#4166</span> <a href="viewtopic.php?pid=1501812#p1501812">2015-02-11 06:07:30</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=75590">aw</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2013-10-04</span></dd> <dd><span>Posts: 921</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=75590">Email</a></span> <span class="website"><a href="http://vfio.blogspot.com/" rel="nofollow">Website</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>erganzi wrote:</cite><blockquote><div><div class="quotebox"><cite>erganzi wrote:</cite><blockquote><div><div class="quotebox"><cite>aw wrote:</cite><blockquote><div><p>If only you knew how much effort we put in to backporting fixes and features while maintaining ABI compatibility for those older base versions...</p></div></blockquote></div><p>Thanks for those work.&#160; I will try what you suggest and give a feedback.</p></div></blockquote></div><p>Hi, aw:</p><p>I just change the kernel version to 3.18.6 from kernel.org. It now work for me.&#160; qemu version is still 2.0.</p><p>I compare the result of the command &quot;lspci -vvv -k -s 04:00.0&quot; between linux-3.12.5 and linux-3.18.6, there are just a little different.<br />If it can give you some idea.</p></div></blockquote></div><p>There&#039;s really not much question about what the problem is/was, the kvm-vfio device didn&#039;t go in until 3.13.&#160; That&#039;s the code that toggles whether kvm emulates or ignores operations that invalidate the cache when devices are allowed to perform operations that can bypass it, for example NoSnoop.&#160; That was an early cause of Code 43 errors.&#160; The NoSnoop patch you were using was an early, and fairly broken, attempt to fix that.&#160; The new code is far more reliable, as you can see.</p> </div> <div class="postsignature postmsg"><hr /><p><a href="http://vfio.blogspot.com" rel="nofollow">http://vfio.blogspot.com</a><br />Looking for a more open forum to discuss vfio related uses?&#160; Try <a href="https://www.redhat.com/mailman/listinfo/vfio-users" rel="nofollow">https://www.redhat.com/mailman/listinfo/vfio-users</a></p></div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1501812">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1501815" class="blockpost rowodd"> <h2><span><span class="conr">#4167</span> <a href="viewtopic.php?pid=1501815#p1501815">2015-02-11 06:48:22</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=83411">erganzi</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2014-07-09</span></dd> <dd><span>Posts: 19</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=83411">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>aw wrote:</cite><blockquote><div><div class="quotebox"><cite>erganzi wrote:</cite><blockquote><div><div class="quotebox"><cite>erganzi wrote:</cite><blockquote><div><p>Thanks for those work.&#160; I will try what you suggest and give a feedback.</p></div></blockquote></div><p>Hi, aw:</p><p>I just change the kernel version to 3.18.6 from kernel.org. It now work for me.&#160; qemu version is still 2.0.</p><p>I compare the result of the command &quot;lspci -vvv -k -s 04:00.0&quot; between linux-3.12.5 and linux-3.18.6, there are just a little different.<br />If it can give you some idea.</p></div></blockquote></div><p>There&#039;s really not much question about what the problem is/was, the kvm-vfio device didn&#039;t go in until 3.13.&#160; That&#039;s the code that toggles whether kvm emulates or ignores operations that invalidate the cache when devices are allowed to perform operations that can bypass it, for example NoSnoop.&#160; That was an early cause of Code 43 errors.&#160; The NoSnoop patch you were using was an early, and fairly broken, attempt to fix that.&#160; The new code is far more reliable, as you can see.</p></div></blockquote></div><br /><p>OK, thanks for reply. I will use the version 3.18.6.</p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1501815">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1501820" class="blockpost roweven"> <h2><span><span class="conr">#4168</span> <a href="viewtopic.php?pid=1501820#p1501820">2015-02-11 08:03:34</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=87484">kainet</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2014-12-22</span></dd> <dd><span>Posts: 9</span></dd> <dd class="usercontacts"><span class="email"><a href="mailto:bart47@gmail.com">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>valnare wrote:</cite><blockquote><div><div class="quotebox"><cite>mauorrizze wrote:</cite><blockquote><div><p>In my case all sound problems were latency related. If the problem gets worse when you pass more CPU cores and better when you pass less, then it&#039;s propably the same. Other phenomenons: tools like LatencyMon let the windows guest freeze really soon.<br />What helps: cpu pinning (for each guest and the host!), in case of HDMI: enable MSI in registry<br />Unconfirmed: hugepages</p></div></blockquote></div><p>I tried playing audio with only a single core pinned on the host and the guest. Still the same result. The stuttering also does not change with more load on the CPU.<br />Latencymon worked while only using one cpu core, when I tried running it with more than one it frooze after 2 seconds. MSI was enabled, didn&#039;t change anything for the stuttering. I&#039;ll experiment a bit more with cpu pinning though.<br />Enabling or disabling hugepages didn&#039;t do anything for me.</p><p>Thank you for your suggestions <img src="https://bbs.archlinux.org/img/smilies/smile.png" width="15" height="15" alt="smile" /></p></div></blockquote></div><p>Have same problems with ASUS GTX 670.&#160; With GA GTX770 sound seems ok but that card spins FAN at maximum speed when VM was turned off, so she does not fit me. With 670 i turning off when turning on vm, till i not achieve stable sound, but as long as i do so it seems that getting stable sound requires even more reboots. I am very interested in a way you solve this problem.</p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1501820">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1501879" class="blockpost rowodd"> <h2><span><span class="conr">#4169</span> <a href="viewtopic.php?pid=1501879#p1501879">2015-02-11 12:47:27</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=86501">mmm</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2014-11-06</span></dd> <dd><span>Posts: 4</span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <p>Hi, <br />I&#039;m having trouble passing through the third and fourth graphics card to VMs while passing through the first and second one works without any issues. <br />The VMs just dont give a signal on the GPU&#039;s outputs and they dont seem to boot up since no network services are starting from inside the VM. <br />Also neither qemu itself nor dmesg seem to report any errors which leaves me wondering how I can even get information about what the problem is.<br />All cards are GTX 780Ti, the motherboard is a dual-socket board with both sockets equipped and all cards are apparently not in an iommu group with any other devices. </p><p>Does anyone have suggestions how to approach this?</p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1501879">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1501981" class="blockpost roweven"> <h2><span><span class="conr">#4170</span> <a href="viewtopic.php?pid=1501981#p1501981">2015-02-11 17:52:03</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=88702">gessert</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2015-02-09</span></dd> <dd><span>Posts: 5</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=88702">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>aw wrote:</cite><blockquote><div><div class="quotebox"><cite>gessert wrote:</cite><blockquote><div><div class="codebox"><pre><code>-device vfio-pci,host=04:00.0,multifunction=on,x-vga=on: VFIO 0000:04:00.0 BAR 3 mmap unsupported. Performance may be slow</code></pre></div></div></blockquote></div><p>As Duelist figured out, this means a host driver is attached to the device.&#160; A common problem when using the boot graphics device.&#160; Look in /proc/iomem, figure out what it is, and disable it.</p></div></blockquote></div><p>excerpt from cat /proc/iomem</p><div class="codebox"><pre><code>90000000-fbffbfff : PCI Bus 0000:00 a0000000-b1ffffff : PCI Bus 0000:04 a0000000-afffffff : 0000:04:00.0 b0000000-b1ffffff : 0000:04:00.0 b1000000-b12fffff : BOOTFB</code></pre></div><p>From what I could gather with a google search: BOOTFB is the framebuffer that sends terminal messages during boot. Could I just &quot;disable&quot; it? How do I proceed? Please advise.</p><p>complete cat /proc/iomem</p><div class="codebox"><pre class="vscroll"><code>00000000-00000fff : reserved 00001000-0009ffff : System RAM 000a0000-000bffff : PCI Bus 0000:00 000c0000-000cebff : Video ROM 000f0000-000fffff : System ROM 00100000-790c7fff : System RAM 01000000-0154d5b2 : Kernel code 0154d5b3-018ea13f : Kernel data 01a1e000-01aeffff : Kernel bss 790c8000-79c36fff : reserved 79c37000-79ef3fff : System RAM 79ef4000-7aa7cfff : ACPI Non-volatile Storage 7aa7d000-7afbefff : reserved 7afbf000-7afe5fff : System RAM 7afe6000-7afe6fff : reserved 7afe7000-7afe9fff : System RAM 7afea000-7afeafff : reserved 7afeb000-7afebfff : System RAM 7afec000-7b071fff : reserved 7b072000-7b289fff : System RAM 7b28a000-7bff8fff : reserved 7bff9000-7bffffff : System RAM 80000000-8fffffff : PCI MMCONFIG 0000 [bus 00-ff] 80000000-8fffffff : reserved 90000000-fbffbfff : PCI Bus 0000:00 a0000000-b1ffffff : PCI Bus 0000:04 a0000000-afffffff : 0000:04:00.0 b0000000-b1ffffff : 0000:04:00.0 b1000000-b12fffff : BOOTFB c0000000-d1ffffff : PCI Bus 0000:03 c0000000-cfffffff : 0000:03:00.0 d0000000-d1ffffff : 0000:03:00.0 e0000000-efffffff : PCI Bus 0000:02 e0000000-efffffff : 0000:02:00.0 f8000000-f90fffff : PCI Bus 0000:04 f8000000-f8ffffff : 0000:04:00.0 f9000000-f907ffff : 0000:04:00.0 f9080000-f9083fff : 0000:04:00.1 f9100000-f911ffff : 0000:00:19.0 f9100000-f911ffff : e1000e f9120000-f912ffff : 0000:00:14.0 f9120000-f912ffff : xhci_hcd f9130000-f9133fff : 0000:00:1b.0 f9130000-f9133fff : ICH HD audio f9135000-f91350ff : 0000:00:1f.3 f9136000-f91367ff : 0000:00:1f.2 f9136000-f91367ff : ahci f9137000-f91373ff : 0000:00:1d.0 f9137000-f91373ff : ehci_hcd f9138000-f91383ff : 0000:00:1a.0 f9138000-f91383ff : ehci_hcd f9139000-f9139fff : 0000:00:19.0 f9139000-f9139fff : e1000e f913c000-f913c00f : 0000:00:16.0 f913c000-f913c00f : mei_me f913d000-f913d7ff : 0000:00:11.4 f913d000-f913d7ff : ahci f913e000-f913efff : 0000:00:05.4 fa000000-fb0fffff : PCI Bus 0000:03 fa000000-faffffff : 0000:03:00.0 fb000000-fb07ffff : 0000:03:00.0 fb080000-fb083fff : 0000:03:00.1 fb200000-fb2fffff : PCI Bus 0000:02 fb200000-fb21ffff : 0000:02:00.0 fb220000-fb23ffff : 0000:02:00.0 fb240000-fb243fff : 0000:02:00.1 fb240000-fb243fff : ICH HD audio fbffc000-fbffcfff : dmar1 fbffd000-fbffdfff : dmar0 fec00000-fecfffff : PNP0003:00 fec00000-fec003ff : IOAPIC 0 fec01000-fec013ff : IOAPIC 1 fed00000-fed003ff : HPET 0 fed00000-fed003ff : PNP0103:00 fed12000-fed1200f : pnp 00:01 fed12010-fed1201f : pnp 00:01 fed1b000-fed1bfff : pnp 00:01 fed1c000-fed1ffff : reserved fed1f410-fed1f414 : iTCO_wdt fed45000-fed8bfff : pnp 00:01 fee00000-feefffff : pnp 00:01 fee00000-fee00fff : Local APIC ff000000-ffffffff : reserved ff000000-ffffffff : pnp 00:01 100000000-47fffffff : System RAM</code></pre></div> <p class="postedit"><em>Last edited by gessert (2015-02-11 17:53:00)</em></p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1501981">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1502023" class="blockpost rowodd"> <h2><span><span class="conr">#4171</span> <a href="viewtopic.php?pid=1502023#p1502023">2015-02-11 20:09:56</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=85175">evilsephiroth</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2014-09-16</span></dd> <dd><span>Posts: 14</span></dd> <dd class="usercontacts"><span class="email"><a href="mailto:evilsephiroth@gmail.com">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>aw wrote:</cite><blockquote><div><div class="quotebox"><cite>evilsephiroth wrote:</cite><blockquote><div><p>According to this thread, no solution yet for drivers &gt; 340.52. I&#039;m stuck at that version too.(gtx 560Ti on Windows 7 machine)</p></div></blockquote></div><p>What are you talking about?!&#160; I&#039;m running 347.25 here with GTX750.&#160; KVM and Hyper-V extensions need to be hidden/disabled to avoid Code 43 on GeForce cards.</p></div></blockquote></div><p>Exactly...<br />It s a steam in home streaming vm so performance would decrease also...</p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1502023">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1502029" class="blockpost roweven"> <h2><span><span class="conr">#4172</span> <a href="viewtopic.php?pid=1502029#p1502029">2015-02-11 20:21:23</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=88702">gessert</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2015-02-09</span></dd> <dd><span>Posts: 5</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=88702">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <p>I have changed the grub command line and added:</p><div class="codebox"><pre><code>GRUB_CMDLINE_LINUX_DEFAULT=&quot;quiet intel_iommu=on vfio_iommu_type1.allow_unsafe_interrupts=1 nofb&quot; GRUB_GFXPAYLOAD_LINUX=text</code></pre></div><p>run via update-grub</p><p>cat /proc/iomem now looks clean.</p><p>During reboot I noticed the terminal booting messages will now stop earlier. While loading the ramdisk. It keeps displaying it&#039;s last screen.</p><p>The guest does not generate the &quot;-device vfio-pci,host=04:00.0,multifunction=on,x-vga=on: VFIO 0000:04:00.0 BAR 3 mmap unsupported. Performance may be slow&quot; error anymore. </p><p>&quot;dmesg | grep 0000:04&quot; still shows &quot;vfio-pci 0000:04:00.0: Invalid ROM contents&quot;. So I added the romfile again. This gets rid of this problem.</p><p>When I run the vm now, the screen turns off. I still do not have graphics output. Please advise.</p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1502029">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1502131" class="blockpost rowodd"> <h2><span><span class="conr">#4173</span> <a href="viewtopic.php?pid=1502131#p1502131">2015-02-12 02:00:36</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=87813">Len</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd class="postavatar"><img src="https://bbs.archlinux.org/img/avatars/87813.png?m=1420509844" width="80" height="80" alt="" /></dd> <dd><span>Registered: 2015-01-06</span></dd> <dd><span>Posts: 23</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=87813">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <p>When starting </p><div class="codebox"><pre><code>qemu-system-x86_64 -enable-kvm -M q35 -m 2048 -cpu host \ -smp 4,sockets=1,cores=4,threads=1 \ -bios /usr/share/qemu/bios.bin -vga none \ -device ioh3420,bus=pcie.0,addr=1c.0,multifunction=on,port=1,chassis=1,id=root.1 \ -device vfio-pci,host=01:00.0,bus=root.1,addr=00.0,multifunction=on,x-vga=on \ -device vfio-pci,host=01:00.1,bus=root.1,addr=00.1 \ -device ahci,id=ahci0 \ -drive file=/dev/sda,format=raw,if=none,id=sata0-0-0,media=disk \ -drive file=/home/len/win.iso,if=none,id=sata0-0-1,media=cdrom -device ide-drive,bus=ahci0.0,unit=0,drive=drive-sata0-0-0,id=drive-sata0-0-0 \ -device ide-cd,bus=ahci0.1,unit=0,drive=drive-sata0-0-1,id=drive-sata0-0-1 \</code></pre></div><p>getting this error </p><div class="codebox"><pre><code>[ 40.960654] vfio-pci 0000:01:00.0: enabling device (0000 -&gt; 0003) [ 40.960757] vfio_ecap_init: 0000:01:00.0 hiding ecap 0x1e@0x258 [ 40.960763] vfio_ecap_init: 0000:01:00.0 hiding ecap 0x19@0x900 [ 43.955151] [drm:intel_uncore_check_errors] *ERROR* Unclaimed register before interrupt [ 43.955202] [drm:intel_uncore_check_errors] *ERROR* Unclaimed register before interrupt</code></pre></div><p>I&#039;m using kernel provided in this thread (uname checked),</p><div class="codebox"><pre><code>[root@holo ~]# cat /etc/modules-load.d/kvm_virt.conf pci_stub vfio vfio_iommu_type1 vfio_pci kvm kvm_intel</code></pre></div><div class="codebox"><pre><code>[root@holo ~]# l /sys/bus/pci/drivers/vfio-pci/ total 0 drwxr-xr-x 2 root root 0 Feb 12 03:47 . drwxr-xr-x 21 root root 0 Feb 12 03:40 .. lrwxrwxrwx 1 root root 0 Feb 12 03:46 0000:01:00.0 -&gt; ../../../../devices/pci0000:00/0000:00:01.0/0000:01:00.0 lrwxrwxrwx 1 root root 0 Feb 12 03:46 0000:01:00.1 -&gt; ../../../../devices/pci0000:00/0000:00:01.0/0000:01:00.1 --w------- 1 root root 4096 Feb 12 03:46 bind lrwxrwxrwx 1 root root 0 Feb 12 03:46 module -&gt; ../../../../module/vfio_pci --w------- 1 root root 4096 Feb 12 03:40 new_id --w------- 1 root root 4096 Feb 12 03:46 remove_id --w------- 1 root root 4096 Feb 12 03:40 uevent --w------- 1 root root 4096 Feb 12 03:46 unbind</code></pre></div><div class="codebox"><pre><code>GRUB_CMDLINE_LINUX_DEFAULT=&quot;quiet intel_iommu=on pci-stub.ids=10de:13c2,10de:0fbb i915.enable_hd_vgaarb=1&quot;</code></pre></div><p>Any clues guys?</p> <p class="postedit"><em>Last edited by Len (2015-02-12 02:48:33)</em></p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1502131">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1502142" class="blockpost roweven"> <h2><span><span class="conr">#4174</span> <a href="viewtopic.php?pid=1502142#p1502142">2015-02-12 02:53:09</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=88564">hotfunction</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2015-02-05</span></dd> <dd><span>Posts: 10</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=88564">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><blockquote><div><p>If 440fx and -nographic don&#039;t help and you&#039;re looking at the right output from the GPU, I&#039;d next be suspicious of the ROM file.&#160; It looks like one from techpowerup.&#160; Does it actually match your card?&#160; Can you dump the ROM from your card instead?&#160; Do you even need a dump of the ROM?</p></div></blockquote></div><p>hi sir aw.. i tried downloading various ROMs from other sites too, but none of them seems to get me working, they still gave me black screen output on the sscreen... and it seemed to be hard to find nvidia&#039;s ROM corresponding on that... so is it okay if i change into another GPU card? will it help me to work?</p><div class="quotebox"><blockquote><div><p>That black window is the sdl graphics head for the VM which appears because you haven&#039;t used the -nographic option.&#160; The GPU output should be on a monitor connected to the assigned GPU.&#160; I&#039;d also recommend, like I almost always do, using 440fx rather than q35 for the VM.&#160; It looks like you&#039;re using a Linux guest, but afaik, the nvidia driver does not have an issue with PCIe topology in Linux (until you get to lots of GPUs and that may already be fixed too).</p></div></blockquote></div><p>and also about this part... i actually still confused, after some reading and stuff, i redone the steps from nbhs&#039;s page one, after making the single script and others.. i still see the black qemu command line window when adding -vga none... and also without a rom setting, i also tried rombar=0 option and -nographic still didnt give me output.. can you give me further explanation on this.. ?? i am very confused about the black qemu command line, and how does people use -vga none without -nographics to go straight to the VMS without the black qemu command line?</p><p>Edit : i tried adding -curses instead of -nographics, and its still giving me blank output, which i can type &quot;quit&quot; and i can go back to the qemu, which is that i am guessing that is still the black qemu command line output again.. removing that -vga none boots -curses to the VM.. so is the black qemu command line from the -vga none output is showing because of my GPU rom incorrect? or am i missing something..?</p> <p class="postedit"><em>Last edited by hotfunction (2015-02-12 05:33:08)</em></p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1502142">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1502188" class="blockpost rowodd"> <h2><span><span class="conr">#4175</span> <a href="viewtopic.php?pid=1502188#p1502188">2015-02-12 08:22:59</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=88701">valnare</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2015-02-09</span></dd> <dd><span>Posts: 3</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=88701">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>kainet wrote:</cite><blockquote><div><p>Have same problems with ASUS GTX 670.&#160; With GA GTX770 sound seems ok but that card spins FAN at maximum speed when VM was turned off, so she does not fit me. With 670 i turning off when turning on vm, till i not achieve stable sound, but as long as i do so it seems that getting stable sound requires even more reboots. I am very interested in a way you solve this problem.</p></div></blockquote></div><p>I still had an USB sound card lying around that I passed through, where I do not get any suttering. This is only a workaround for me and it would be nice to use the HDMI ouput, but I have no idea how to solve the stuttering.</p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1502188">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div class="postlinksb"> <div class="inbox crumbsplus"> <div class="pagepost"> <p class="pagelink conl"><span class="pages-label">Pages: </span><a rel="prev" class="item1" href="viewtopic.php?id=162768&amp;p=166">Previous</a> <a href="viewtopic.php?id=162768">1</a> <span class="spacer">…</span> <a href="viewtopic.php?id=162768&amp;p=165">165</a> <a href="viewtopic.php?id=162768&amp;p=166">166</a> <strong>167</strong> <a href="viewtopic.php?id=162768&amp;p=168">168</a> <a href="viewtopic.php?id=162768&amp;p=169">169</a> <span class="spacer">…</span> <a href="viewtopic.php?id=162768&amp;p=234">234</a> <a rel="next" href="viewtopic.php?id=162768&amp;p=168">Next</a></p> <p class="postlink conr">Topic closed</p> </div> <ul class="crumbs"> <li><a href="index.php">Index</a></li> <li><span>»&#160;</span><a href="viewforum.php?id=48">Topics Going Nowhere</a></li> <li><span>»&#160;</span><strong><a href="viewtopic.php?id=162768">KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</a></strong></li> </ul> <p class="subscribelink clearb"><a href="misc.php?action=subscribe&amp;tid=162768">Subscribe to this topic</a></p> <div class="clearer"></div> </div> </div> </div> <div id="brdfooter" class="block"> <h2><span>Board footer</span></h2> <div class="box"> <div id="brdfooternav" class="inbox"> <div class="conl"> <form id="qjump" method="get" action="viewforum.php"> <div><label><span>Jump to<br /></span> <select name="id" onchange="window.location=('viewforum.php?id='+this.options[this.selectedIndex].value)"> <optgroup label="Technical Issues and Assistance"> <option value="23">Newbie Corner</option> <option value="17">Installation</option> <option value="22">Kernel &amp; Hardware</option> <option value="18">Applications &amp; Desktop Environments</option> <option value="31">Laptop Issues</option> <option value="8">Networking, Server, and Protection</option> <option value="32">Multimedia and Games</option> <option value="50">System Administration</option> <option value="35">Other Architectures</option> </optgroup> <optgroup label="Arch-centric"> <option value="24">Announcements, Package &amp; Security Advisories</option> <option value="1">Arch Discussion</option> <option value="13">Forum &amp; Wiki discussion</option> </optgroup> <optgroup label="Pacman Upgrades, Packaging &amp; AUR"> <option value="44">Pacman &amp; Package Upgrade Issues</option> <option value="49">[testing] Repo Forum</option> <option value="4">Creating &amp; Modifying Packages</option> <option value="38">AUR Issues, Discussion &amp; PKGBUILD Requests</option> </optgroup> <optgroup label="Contributions &amp; Discussion"> <option value="20">GNU/Linux Discussion</option> <option value="27">Community Contributions</option> <option value="33">Programming &amp; Scripting</option> <option value="30">Other Languages</option> <option value="47">Artwork and Screenshots</option> <option value="42">Try This</option> </optgroup> <optgroup label="/dev/null"> <option value="29">Off-Topic</option> <option value="48" selected="selected">Topics Going Nowhere</option> <option value="36">Dustbin</option> </optgroup> </select></label> <input type="submit" value=" Go " accesskey="g" /> </div> </form> </div> <div class="conr"> <p id="feedlinks"><span class="atom"><a href="extern.php?action=feed&amp;tid=162768&amp;type=atom">Atom topic feed</a></span></p> <p id="poweredby">Powered by <a href="http://fluxbb.org/">FluxBB</a></p> </div> <div class="clearer"></div> </div> </div> </div> </div> <div class="end-box"></div> </div> </body> </html>
