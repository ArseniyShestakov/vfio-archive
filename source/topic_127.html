<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"> <html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en" dir="ltr"> <head> <meta http-equiv="Content-Type" content="text/html; charset=utf-8" /> <title>KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9 (Page 127) / Topics Going Nowhere / Arch Linux Forums</title> <link rel="stylesheet" type="text/css" href="style/ArchLinux.css" /> <link rel="canonical" href="viewtopic.php?id=162768&amp;p=127" title="Page 127" /> <link rel="prev" href="viewtopic.php?id=162768&amp;p=126" title="Page 126" /> <link rel="next" href="viewtopic.php?id=162768&amp;p=128" title="Page 128" /> <link rel="alternate" type="application/atom+xml" href="extern.php?action=feed&amp;tid=162768&amp;type=atom" title="Atom topic feed" /> <link rel="stylesheet" media="screen" href="style/ArchLinux/arch.css?v=3" /> <link rel="stylesheet" media="screen" href="style/ArchLinux/archnavbar.css?v=2" /> <link rel="shortcut icon" href="style/ArchLinux/favicon.ico" /> </head> <body> <div id="archnavbar" class="anb-forum"> <div id="archnavbarlogo"><h1><a href="http://www.archlinux.org/">Arch Linux</a></h1></div> <div id="archnavbarmenu"> <ul id="archnavbarlist"> <li id="anb-home"><a href="http://www.archlinux.org/">Home</a></li><li id="anb-packages"><a href="http://www.archlinux.org/packages/">Packages</a></li><li id="anb-forums" class="anb-selected"><a href="https://bbs.archlinux.org/">Forums</a></li><li id="anb-wiki"><a href="https://wiki.archlinux.org/">Wiki</a></li><li id="anb-bugs"><a href="https://bugs.archlinux.org/">Bugs</a></li><li id="anb-aur"><a href="https://aur.archlinux.org/">AUR</a></li><li id="anb-download"><a href="http://www.archlinux.org/download/">Download</a></li> </ul> </div> </div> <div id="punviewtopic" class="pun"> <div class="top-box"></div> <div class="punwrap"> <div id="brdheader" class="block"> <div class="box"> <div id="brdmenu" class="inbox"> <ul> <li id="navindex" class="isactive"><a href="index.php">Index</a></li> <li id="navuserlist"><a href="userlist.php">User list</a></li> <li id="navsearch"><a href="search.php">Search</a></li> <li id="navprofile"><a href="profile.php?id=80749">Profile</a></li> <li id="navlogout"><a href="login.php?action=out&amp;id=80749&amp;csrf_token=5c20501ec397bb45ef8ee8c84db232c8d8e421c6">Logout</a></li> </ul> </div> <div id="brdwelcome" class="inbox"> <ul class="conl"> <li><span>Logged in as <strong>SXX</strong></span></li> <li><span>Last visit: 2015-08-16 12:20:09</span></li> </ul> <ul class="conr"> <li><span>Topics: <a href="search.php?action=show_replies" title="Find topics you have posted to.">Posted</a> | <a href="search.php?action=show_new" title="Find topics with new posts since your last visit.">New</a> | <a href="search.php?action=show_recent" title="Find topics with recent posts.">Active</a> | <a href="search.php?action=show_unanswered" title="Find topics with no replies.">Unanswered</a></span></li> </ul> <div class="clearer"></div> </div> </div> </div> <div id="brdmain"> <div class="linkst"> <div class="inbox crumbsplus"> <ul class="crumbs"> <li><a href="index.php">Index</a></li> <li><span>»&#160;</span><a href="viewforum.php?id=48">Topics Going Nowhere</a></li> <li><span>»&#160;</span><strong><a href="viewtopic.php?id=162768">KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</a></strong></li> </ul> <div class="pagepost"> <p class="pagelink conl"><span class="pages-label">Pages: </span><a rel="prev" class="item1" href="viewtopic.php?id=162768&amp;p=126">Previous</a> <a href="viewtopic.php?id=162768">1</a> <span class="spacer">…</span> <a href="viewtopic.php?id=162768&amp;p=125">125</a> <a href="viewtopic.php?id=162768&amp;p=126">126</a> <strong>127</strong> <a href="viewtopic.php?id=162768&amp;p=128">128</a> <a href="viewtopic.php?id=162768&amp;p=129">129</a> <span class="spacer">…</span> <a href="viewtopic.php?id=162768&amp;p=234">234</a> <a rel="next" href="viewtopic.php?id=162768&amp;p=128">Next</a></p> <p class="postlink conr">Topic closed</p> </div> <div class="clearer"></div> </div> </div> <div id="p1472529" class="blockpost rowodd blockpost1"> <h2><span><span class="conr">#3151</span> <a href="viewtopic.php?pid=1472529#p1472529">2014-11-04 18:39:20</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=75590">aw</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2013-10-04</span></dd> <dd><span>Posts: 921</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=75590">Email</a></span> <span class="website"><a href="http://vfio.blogspot.com/" rel="nofollow">Website</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>Uramekus wrote:</cite><blockquote><div><p>when i set intel_iommu=on i got a disgraceful bug (less than 5s start the screen got stalled code-like)<br />and i don&#039;t have idea what i can do to get this working</p></div></blockquote></div><p>If you can&#039;t enable the IOMMU, you can&#039;t do PCI device assignment, end of story.&#160; If you provide us a snapshot of some of the errors you&#039;re seeing when you enable it, maybe we can help.&#160; You might also try a newer kernel to see if it can be enabled there, you haven&#039;t specified your host environment.</p><p>EDIT: if that screenshot is what happens when you try to boot with intel_iommu=on, try intel_iommu=on,igfx_off</p> <p class="postedit"><em>Last edited by aw (2014-11-04 18:53:30)</em></p> </div> <div class="postsignature postmsg"><hr /><p><a href="http://vfio.blogspot.com" rel="nofollow">http://vfio.blogspot.com</a><br />Looking for a more open forum to discuss vfio related uses?&#160; Try <a href="https://www.redhat.com/mailman/listinfo/vfio-users" rel="nofollow">https://www.redhat.com/mailman/listinfo/vfio-users</a></p></div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1472529">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1472531" class="blockpost roweven"> <h2><span><span class="conr">#3152</span> <a href="viewtopic.php?pid=1472531#p1472531">2014-11-04 18:45:44</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=82442">slis</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2014-06-02</span></dd> <dd><span>Posts: 125</span></dd> <dd class="usercontacts"><span class="email"><a href="mailto:xslisx@gmail.com">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <p>edit: too late <img src="https://bbs.archlinux.org/img/smilies/big_smile.png" width="15" height="15" alt="big_smile" /></p> <p class="postedit"><em>Last edited by slis (2014-11-04 18:46:08)</em></p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1472531">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1472532" class="blockpost rowodd"> <h2><span><span class="conr">#3153</span> <a href="viewtopic.php?pid=1472532#p1472532">2014-11-04 18:45:54</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=75590">aw</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2013-10-04</span></dd> <dd><span>Posts: 921</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=75590">Email</a></span> <span class="website"><a href="http://vfio.blogspot.com/" rel="nofollow">Website</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>mouton_sanglant wrote:</cite><blockquote><div><p>Hello again !</p><p>I achieved to do VGA-Passthrough on another machine.<br />It is a desktop and more modern configuration but the GPU is quite old.</p><p>CPU: i5-4670T (Haswell family)<br />GPU: Nvidia 9500 GS</p><p>It&#039;s working fine, now going to do some tuning but there I have some questions first.</p><p><span style="color: red"><strong>Question 1:</strong></span> While I could do VGA-PT with my laptop without applying any patches, I can&#039;t with this new config (black screen). Especially the vga-arbiter patch. From what I understood from this article from Alex Williamson (<a href="http://vfio.blogspot.fr/2014/08/whats-deal-with-vga-arbitration.html" rel="nofollow">What&#039;s the deal with VGA arbitration ?</a>), this is because my brand new CPU&#039;s IGP is too recent ?</p><div class="quotebox"><cite>Alex Williamson wrote:</cite><blockquote><div><p>The native IGD driver would really like to continue running when VGA routing is directed elsewhere, so the PCI method of disabling access is sub-optimal.&#160; At some point Intel knew this and included mechanisms in the device that allowed VGA MMIO and I/O port space to be disabled separately from PCI MMIO and I/O port space.&#160; These mechanisms are what the i915 driver uses today when it opts-out of VGA arbitration.</p><p>The problem is that modern IGD devices don&#039;t implement the same mechanisms for disabling legacy VGA.&#160; The i915 driver continues to twiddle the old bits and opt-out of arbitration, but the IGD VGA is still claiming VGA transactions.&#160; This is why many users who claim they don&#039;t need the i915 patch finish their proclamation of success with a note about the VGA color palate being corrupted or noting some strange drm interrupt messages on the host dmesg. [...]</p><p>So why can&#039;t we simply fix the i915 driver to correctly disable legacy VGA support?&#160; Well, in their infinite wisdom, hardware designers have removed (or broken) that feature of IGD.</p></div></blockquote></div><p>My laptop&#039;s CPU is intel 2nd-gen, I have some color problems whenever I shutdown the VM, but this doesn&#039;t bother me much. So, I guess the feature is still there and not broken, but is on my intel 4th-gen CPU, right ?</p></div></blockquote></div><p>The only IGDs that work with VGA arbitration are the ones were the GPU is on the chipset, not the CPU.&#160; If you saw screen corruption on your laptop, even if it didn&#039;t bother you, it&#039;s the same problem.&#160; It&#039;s probably more a difference of the GPU being assigned and whether the guest drivers are able to initialize it despite not having VGA access to it.</p><div class="quotebox"><blockquote><div><p><span style="color: red"><strong>Question 2:</strong></span> My laptop&#039;s configuration <strong>needs</strong> a vbios rom in order to work, but this is not the case of my desktop&#039;s GPU. In fact, whenever I specify an extracted vbios it won&#039;t work: black screen (I extracted it myself from a live-cd, I strictly followed the same procedure than for my laptop vbios). My first thought was the GPU is a bit too old but I think it&#039;s a stupid idea. I used rom-parser to check the vbios and it says it&#039;s fine, reporting correct vendors ids. Where could it comes from ? Any suggestions ? It tickles me a lot !</p></div></blockquote></div><p>Was the GPU the primary graphics device when you extracted the BIOS?&#160; PCs will load primary graphics BIOS into a different region and it may be modified runtime.&#160; If that&#039;s the one you get when extracted, it may not work correctly.&#160; If QEMU/VFIO is able to get the correct ROM from the card, why do you care?</p><div class="quotebox"><blockquote><div><p><span style="color: red"><strong>Question 3:</strong></span> Now that I begin to understand PCI-PT in qemu, should I try to write a tutorial for french people ? Isn&#039;t it a bit risky since I don&#039;t have a wide knowledge of the internal mechanics and couldn&#039;t properly troubleshoot specific case issues ?</p></div></blockquote></div><p>Those of us who don&#039;t speak french won&#039;t be able to identify any mistakes, but more helpful documentation is always a good thing.</p> <p class="postedit"><em>Last edited by aw (2014-11-04 18:47:38)</em></p> </div> <div class="postsignature postmsg"><hr /><p><a href="http://vfio.blogspot.com" rel="nofollow">http://vfio.blogspot.com</a><br />Looking for a more open forum to discuss vfio related uses?&#160; Try <a href="https://www.redhat.com/mailman/listinfo/vfio-users" rel="nofollow">https://www.redhat.com/mailman/listinfo/vfio-users</a></p></div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1472532">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1472533" class="blockpost roweven"> <h2><span><span class="conr">#3154</span> <a href="viewtopic.php?pid=1472533#p1472533">2014-11-04 18:46:30</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=75590">aw</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2013-10-04</span></dd> <dd><span>Posts: 921</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=75590">Email</a></span> <span class="website"><a href="http://vfio.blogspot.com/" rel="nofollow">Website</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <p>[sorry, meant to edit, not re-post]</p> <p class="postedit"><em>Last edited by aw (2014-11-04 18:47:10)</em></p> </div> <div class="postsignature postmsg"><hr /><p><a href="http://vfio.blogspot.com" rel="nofollow">http://vfio.blogspot.com</a><br />Looking for a more open forum to discuss vfio related uses?&#160; Try <a href="https://www.redhat.com/mailman/listinfo/vfio-users" rel="nofollow">https://www.redhat.com/mailman/listinfo/vfio-users</a></p></div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1472533">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1472543" class="blockpost rowodd"> <h2><span><span class="conr">#3155</span> <a href="viewtopic.php?pid=1472543#p1472543">2014-11-04 19:09:21</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=82604">Uramekus</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2014-06-08</span></dd> <dd><span>Posts: 7</span></dd> <dd class="usercontacts"><span class="email"><a href="mailto:decuke@hotmail.com">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>slis wrote:</cite><blockquote><div><p>You are missing intel_iommu=on<br />edit: forgot intel_</p></div></blockquote></div><p>when i enable intel_iommu=on i got the image result.</p><br /><p>*edit*<br />tried with intel_iommu=on,igfx_off<br />accly the same.</p><p>*edit2*<br />i&#039;m recompiling git kernel disabling some optimizations to see how it does.<br />gonna post here if got problems.</p><p>*final edit*<br />got all working with less optimzed code, it was gcc fault</p> <p class="postedit"><em>Last edited by Uramekus (2014-11-04 19:51:28)</em></p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1472543">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1472787" class="blockpost roweven"> <h2><span><span class="conr">#3156</span> <a href="viewtopic.php?pid=1472787#p1472787">2014-11-05 15:15:16</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=86040">mouton_sanglant</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2014-10-20</span></dd> <dd><span>Posts: 7</span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>aw wrote:</cite><blockquote><div><div class="quotebox"><cite>mouton_sanglant wrote:</cite><blockquote><div><p>Hello again !</p><p>I achieved to do VGA-Passthrough on another machine.<br />It is a desktop and more modern configuration but the GPU is quite old.</p><p>CPU: i5-4670T (Haswell family)<br />GPU: Nvidia 9500 GS</p><p>It&#039;s working fine, now going to do some tuning but there I have some questions first.</p><p><span style="color: red"><strong>Question 1:</strong></span> While I could do VGA-PT with my laptop without applying any patches, I can&#039;t with this new config (black screen). Especially the vga-arbiter patch. From what I understood from this article from Alex Williamson (<a href="http://vfio.blogspot.fr/2014/08/whats-deal-with-vga-arbitration.html" rel="nofollow">What&#039;s the deal with VGA arbitration ?</a>), this is because my brand new CPU&#039;s IGP is too recent ?</p><div class="quotebox"><cite>Alex Williamson wrote:</cite><blockquote><div><p>The native IGD driver would really like to continue running when VGA routing is directed elsewhere, so the PCI method of disabling access is sub-optimal.&#160; At some point Intel knew this and included mechanisms in the device that allowed VGA MMIO and I/O port space to be disabled separately from PCI MMIO and I/O port space.&#160; These mechanisms are what the i915 driver uses today when it opts-out of VGA arbitration.</p><p>The problem is that modern IGD devices don&#039;t implement the same mechanisms for disabling legacy VGA.&#160; The i915 driver continues to twiddle the old bits and opt-out of arbitration, but the IGD VGA is still claiming VGA transactions.&#160; This is why many users who claim they don&#039;t need the i915 patch finish their proclamation of success with a note about the VGA color palate being corrupted or noting some strange drm interrupt messages on the host dmesg. [...]</p><p>So why can&#039;t we simply fix the i915 driver to correctly disable legacy VGA support?&#160; Well, in their infinite wisdom, hardware designers have removed (or broken) that feature of IGD.</p></div></blockquote></div><p>My laptop&#039;s CPU is intel 2nd-gen, I have some color problems whenever I shutdown the VM, but this doesn&#039;t bother me much. So, I guess the feature is still there and not broken, but is on my intel 4th-gen CPU, right ?</p></div></blockquote></div><p>The only IGDs that work with VGA arbitration are the ones were the GPU is on the chipset, not the CPU.&#160; If you saw screen corruption on your laptop, even if it didn&#039;t bother you, it&#039;s the same problem.&#160; It&#039;s probably more a difference of the GPU being assigned and whether the guest drivers are able to initialize it despite not having VGA access to it.</p></div></blockquote></div><p>Not sure to understand what that implies. Should I care about it even if it works perfectly fine (even while gaming) ?</p><br /><div class="quotebox"><cite>aw wrote:</cite><blockquote><div><div class="quotebox"><blockquote><div><p><span style="color: red"><strong>Question 2:</strong></span> My laptop&#039;s configuration <strong>needs</strong> a vbios rom in order to work, but this is not the case of my desktop&#039;s GPU. In fact, whenever I specify an extracted vbios it won&#039;t work: black screen (I extracted it myself from a live-cd, I strictly followed the same procedure than for my laptop vbios). My first thought was the GPU is a bit too old but I think it&#039;s a stupid idea. I used rom-parser to check the vbios and it says it&#039;s fine, reporting correct vendors ids. Where could it comes from ? Any suggestions ? It tickles me a lot !</p></div></blockquote></div><p>Was the GPU the primary graphics device when you extracted the BIOS?&#160; PCs will load primary graphics BIOS into a different region and it may be modified runtime.&#160; If that&#039;s the one you get when extracted, it may not work correctly.&#160; If QEMU/VFIO is able to get the correct ROM from the card, why do you care?</p></div></blockquote></div><p>I think it was, the (motherboard) BIOS got an option to choose the main Graphic Device.<br />Anyway, I don&#039;t need i. It was just curious.</p><div class="quotebox"><cite>aw wrote:</cite><blockquote><div><div class="quotebox"><blockquote><div><p><span style="color: red"><strong>Question 3:</strong></span> Now that I begin to understand PCI-PT in qemu, should I try to write a tutorial for french people ? Isn&#039;t it a bit risky since I don&#039;t have a wide knowledge of the internal mechanics and couldn&#039;t properly troubleshoot specific case issues ?</p></div></blockquote></div><p>Those of us who don&#039;t speak french won&#039;t be able to identify any mistakes, but more helpful documentation is always a good thing.</p></div></blockquote></div><p>I&#039;ll do it.</p><p>One extra question: I saw many people videos achieving to pass the resulting output inside a window inside the host screen. How can I do that ?<br />I tried with xfreerdp but couldn&#039;t success. RemoteFX doesn&#039;t seem to be what I&#039;m looking for. I noticed VNC has been mentionned many times in the previous posts but a friend told me to never use BNC because it&#039;s a total crap (slow and not free). I never used it but, is it the right way to pass the GPU output to my host ? is it time for me to make my own opinion of VNC ?</p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1472787">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1472794" class="blockpost rowodd"> <h2><span><span class="conr">#3157</span> <a href="viewtopic.php?pid=1472794#p1472794">2014-11-05 15:25:55</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=75590">aw</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2013-10-04</span></dd> <dd><span>Posts: 921</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=75590">Email</a></span> <span class="website"><a href="http://vfio.blogspot.com/" rel="nofollow">Website</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>mouton_sanglant wrote:</cite><blockquote><div><div class="quotebox"><cite>aw wrote:</cite><blockquote><div><div class="quotebox"><cite>mouton_sanglant wrote:</cite><blockquote><div><p>Hello again !</p><p>I achieved to do VGA-Passthrough on another machine.<br />It is a desktop and more modern configuration but the GPU is quite old.</p><p>CPU: i5-4670T (Haswell family)<br />GPU: Nvidia 9500 GS</p><p>It&#039;s working fine, now going to do some tuning but there I have some questions first.</p><p><span style="color: red"><strong>Question 1:</strong></span> While I could do VGA-PT with my laptop without applying any patches, I can&#039;t with this new config (black screen). Especially the vga-arbiter patch. From what I understood from this article from Alex Williamson (<a href="http://vfio.blogspot.fr/2014/08/whats-deal-with-vga-arbitration.html" rel="nofollow">What&#039;s the deal with VGA arbitration ?</a>), this is because my brand new CPU&#039;s IGP is too recent ?</p><p>My laptop&#039;s CPU is intel 2nd-gen, I have some color problems whenever I shutdown the VM, but this doesn&#039;t bother me much. So, I guess the feature is still there and not broken, but is on my intel 4th-gen CPU, right ?</p></div></blockquote></div><p>The only IGDs that work with VGA arbitration are the ones were the GPU is on the chipset, not the CPU.&#160; If you saw screen corruption on your laptop, even if it didn&#039;t bother you, it&#039;s the same problem.&#160; It&#039;s probably more a difference of the GPU being assigned and whether the guest drivers are able to initialize it despite not having VGA access to it.</p></div></blockquote></div><p>Not sure to understand what that implies. Should I care about it even if it works perfectly fine (even while gaming) ?</p></div></blockquote></div><p>Do you care that your VM is doing reads and writes to the host GPU in ways that can corrupt its state?&#160; I do.&#160; I&#039;d expect you should care too.&#160; Besides, without VGA going to the correct device, why even bother with x-vga=on, you might as well assign the GPU as a secondary device, or at least disable VGA access to it.</p><div class="quotebox"><blockquote><div><p>One extra question: I saw many people videos achieving to pass the resulting output inside a window inside the host screen. How can I do that ?<br />I tried with xfreerdp but couldn&#039;t success. RemoteFX doesn&#039;t seem to be what I&#039;m looking for. I noticed VNC has been mentionned many times in the previous posts but a friend told me to never use BNC because it&#039;s a total crap (slow and not free). I never used it but, is it the right way to pass the GPU output to my host ? is it time for me to make my own opinion of VNC ?</p></div></blockquote></div><p>It&#039;s usually done through VNC but I think the videos make it look far more functional than it really is.&#160; Conceptually it&#039;s the same as trying to play a game from a remote system over VNC, the only difference for the VM is that you can get a high performance local network connection between the host and guest.&#160; VNC also consumes quite a bit of CPU to do the encoding and decoding, so you need extra cores for that.&#160; I think that most people here are using a 2nd monitor for the assigned GPU output or switching inputs on their monitor.</p> </div> <div class="postsignature postmsg"><hr /><p><a href="http://vfio.blogspot.com" rel="nofollow">http://vfio.blogspot.com</a><br />Looking for a more open forum to discuss vfio related uses?&#160; Try <a href="https://www.redhat.com/mailman/listinfo/vfio-users" rel="nofollow">https://www.redhat.com/mailman/listinfo/vfio-users</a></p></div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1472794">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1472799" class="blockpost roweven"> <h2><span><span class="conr">#3158</span> <a href="viewtopic.php?pid=1472799#p1472799">2014-11-05 16:00:24</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=86040">mouton_sanglant</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2014-10-20</span></dd> <dd><span>Posts: 7</span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <p>Ok, so I will apply the vga-arb patch when I got this remote control working out.</p><p>I don&#039;t really care about the extra cpu cycles because I won&#039;t use it often (once or twice a month). I just added &quot;-vnc 0.0.0.0:1,mypasswd&quot; to my qemu command but when connecting with client, the qemu console shows up. So I guess I can&#039;t go that way and I must install a vnc server inside the guest. Right ?</p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1472799">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1472804" class="blockpost rowodd"> <h2><span><span class="conr">#3159</span> <a href="viewtopic.php?pid=1472804#p1472804">2014-11-05 16:13:18</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=75590">aw</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2013-10-04</span></dd> <dd><span>Posts: 921</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=75590">Email</a></span> <span class="website"><a href="http://vfio.blogspot.com/" rel="nofollow">Website</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>mouton_sanglant wrote:</cite><blockquote><div><p>Ok, so I will apply the vga-arb patch when I got this remote control working out.</p><p>I don&#039;t really care about the extra cpu cycles because I won&#039;t use it often (once or twice a month). I just added &quot;-vnc 0.0.0.0:1,mypasswd&quot; to my qemu command but when connecting with client, the qemu console shows up. So I guess I can&#039;t go that way and I must install a vnc server inside the guest. Right ?</p></div></blockquote></div><p>yes, -vnc only works with emulated graphics devices</p> </div> <div class="postsignature postmsg"><hr /><p><a href="http://vfio.blogspot.com" rel="nofollow">http://vfio.blogspot.com</a><br />Looking for a more open forum to discuss vfio related uses?&#160; Try <a href="https://www.redhat.com/mailman/listinfo/vfio-users" rel="nofollow">https://www.redhat.com/mailman/listinfo/vfio-users</a></p></div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1472804">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1472807" class="blockpost roweven"> <h2><span><span class="conr">#3160</span> <a href="viewtopic.php?pid=1472807#p1472807">2014-11-05 16:34:20</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=86478">snarfies</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2014-11-05</span></dd> <dd><span>Posts: 2</span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <p>Our of curiosity, why is the linux-mainline-3.17.2.tar.gz (3.17.2 + acs override patch + i915 vga arbiter fixes) on the first post not in the AUR?</p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1472807">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1472833" class="blockpost rowodd"> <h2><span><span class="conr">#3161</span> <a href="viewtopic.php?pid=1472833#p1472833">2014-11-05 19:24:12</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=70922">nbhs</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd class="postavatar"><img src="https://bbs.archlinux.org/img/avatars/70922.jpg?m=1367773811" width="80" height="80" alt="" /></dd> <dd><span>From: Montevideo, Uruguay</span></dd> <dd><span>Registered: 2013-05-02</span></dd> <dd><span>Posts: 402</span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>snarfies wrote:</cite><blockquote><div><p>Our of curiosity, why is the linux-mainline-3.17.2.tar.gz (3.17.2 + acs override patch + i915 vga arbiter fixes) on the first post not in the AUR?</p></div></blockquote></div><p>You wanna maintain it? Go ahead.</p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1472833">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1473113" class="blockpost roweven"> <h2><span><span class="conr">#3162</span> <a href="viewtopic.php?pid=1473113#p1473113">2014-11-06 15:28:57</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=86501">mmm</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2014-11-06</span></dd> <dd><span>Posts: 4</span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <p>I&#039;m passing through two GTX 780 Ti to one Win7 guest simultaneously and they work perfectly in the guest system now (and latest drivers), without SLI though. <br />Now to try and get SLI working I tried a few different configurations with and without ioh3420 in between but in any case the NVidia control panel does not offer SLI settings. <br />As the cards are running in the VM perfectly fine as two single cards side by side I guess it&#039;s not the driver disabling it on purpose due to VM detection but rather a missing requirement on the emulated hardware. </p><p>As real hardware requires to have a SLI-enabled mainboard and possibly having SLI enabled in BIOS or through jumper settings, does anyone know what&#039;s happening there on real hardware and if any of that is implemented in qemu/seabios?</p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1473113">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1473122" class="blockpost rowodd"> <h2><span><span class="conr">#3163</span> <a href="viewtopic.php?pid=1473122#p1473122">2014-11-06 15:47:31</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=75590">aw</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2013-10-04</span></dd> <dd><span>Posts: 921</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=75590">Email</a></span> <span class="website"><a href="http://vfio.blogspot.com/" rel="nofollow">Website</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>mmm wrote:</cite><blockquote><div><p>I&#039;m passing through two GTX 780 Ti to one Win7 guest simultaneously and they work perfectly in the guest system now (and latest drivers), without SLI though. <br />Now to try and get SLI working I tried a few different configurations with and without ioh3420 in between but in any case the NVidia control panel does not offer SLI settings. <br />As the cards are running in the VM perfectly fine as two single cards side by side I guess it&#039;s not the driver disabling it on purpose due to VM detection but rather a missing requirement on the emulated hardware. </p><p>As real hardware requires to have a SLI-enabled mainboard and possibly having SLI enabled in BIOS or through jumper settings, does anyone know what&#039;s happening there on real hardware and if any of that is implemented in qemu/seabios?</p></div></blockquote></div><p>From the wikipedia page:</p><div class="quotebox"><blockquote><div><p>Not all motherboards with multiple PCI-Express x16 slots support SLI. Recent motherboards as of August 2014 that support it are Intel&#039;s Z and X series chipsets (Z68, Z78, Z87, Z97, and X79) and AMD&#039;s 990FX chipset. Aside from a few exceptions, older motherboards needed the nForce series of chipsets to allow for SLI.</p></div></blockquote></div><p>Sounds like it&#039;s pretty tied to specific hardware, which QEMU does not implement.</p> </div> <div class="postsignature postmsg"><hr /><p><a href="http://vfio.blogspot.com" rel="nofollow">http://vfio.blogspot.com</a><br />Looking for a more open forum to discuss vfio related uses?&#160; Try <a href="https://www.redhat.com/mailman/listinfo/vfio-users" rel="nofollow">https://www.redhat.com/mailman/listinfo/vfio-users</a></p></div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1473122">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1473139" class="blockpost roweven"> <h2><span><span class="conr">#3164</span> <a href="viewtopic.php?pid=1473139#p1473139">2014-11-06 16:30:45</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=86501">mmm</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2014-11-06</span></dd> <dd><span>Posts: 4</span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>aw wrote:</cite><blockquote><div><p>From the wikipedia page:</p><div class="quotebox"><blockquote><div><p>Not all motherboards with multiple PCI-Express x16 slots support SLI. Recent motherboards as of August 2014 that support it are Intel&#039;s Z and X series chipsets (Z68, Z78, Z87, Z97, and X79) and AMD&#039;s 990FX chipset. Aside from a few exceptions, older motherboards needed the nForce series of chipsets to allow for SLI.</p></div></blockquote></div><p>Sounds like it&#039;s pretty tied to specific hardware, which QEMU does not implement.</p></div></blockquote></div><p>Hmm, interesting. I wonder if the chipset actually has to do any additional work since there was a hypervisor which faked it: <a href="http://www.techpowerup.com/forums/threads/hypersli-enabling-sli-on-non-sli-motherboards.153046/" rel="nofollow">http://www.techpowerup.com/forums/threa … ds.153046/</a> </p><p>Also since Duelist got Crossfire working I&#039;m rather optimistic that not a whole new emulated chipset implementation is required for SLI.</p> <p class="postedit"><em>Last edited by mmm (2014-11-06 16:34:04)</em></p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1473139">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1473187" class="blockpost rowodd"> <h2><span><span class="conr">#3165</span> <a href="viewtopic.php?pid=1473187#p1473187">2014-11-06 18:37:09</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=85314">Duelist</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2014-09-22</span></dd> <dd><span>Posts: 358</span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>mmm wrote:</cite><blockquote><div><div class="quotebox"><cite>aw wrote:</cite><blockquote><div><p>From the wikipedia page:</p><div class="quotebox"><blockquote><div><p>Not all motherboards with multiple PCI-Express x16 slots support SLI. Recent motherboards as of August 2014 that support it are Intel&#039;s Z and X series chipsets (Z68, Z78, Z87, Z97, and X79) and AMD&#039;s 990FX chipset. Aside from a few exceptions, older motherboards needed the nForce series of chipsets to allow for SLI.</p></div></blockquote></div><p>Sounds like it&#039;s pretty tied to specific hardware, which QEMU does not implement.</p></div></blockquote></div><p>Hmm, interesting. I wonder if the chipset actually has to do any additional work since there was a hypervisor which faked it: <a href="http://www.techpowerup.com/forums/threads/hypersli-enabling-sli-on-non-sli-motherboards.153046/" rel="nofollow">http://www.techpowerup.com/forums/threa … ds.153046/</a> </p><p>Also since Duelist got Crossfire working I&#039;m rather optimistic that not a whole new emulated chipset implementation is required for SLI.</p></div></blockquote></div><br /><p>Ahem!<br />First, i&#039;m dumb. Do not forget that.<br />Second, there is a clarification note that i am writing now.<br />Third, my crossfire system DOES NOT HAVE any external bridges, it works solely through PCI-E. It is XDMA, it is very different from NVidia&#039;s SLI.I even have to enable IOMMU in bios to get that crossfire working under linux.<br />Fourth, NVidia intents to break everything at will. Too much software blocks. You&#039;ve seen that linus torvalds reaction on nvidia? I agree with him.</p> <p class="postedit"><em>Last edited by Duelist (2014-11-06 18:38:15)</em></p> </div> <div class="postsignature postmsg"><hr /><p><span class="bbs">The forum rules prohibit requesting support for distributions other than arch.</span><br /><a href="https://bbs.archlinux.org/viewtopic.php?pid=1551460#p1551460" rel="nofollow">I gave up.</a><a href="https://bbs.archlinux.org/viewtopic.php?id=162768" rel="nofollow"> It was too late.</a><br /><a href="http://pastebin.com/B3fL84bq" rel="nofollow">What I was trying to do</a>.<br /><a href="http://vfio.blogspot.com/" rel="nofollow">The reference about VFIO and KVM VGA passthrough.</a></p></div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1473187">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1473204" class="blockpost roweven"> <h2><span><span class="conr">#3166</span> <a href="viewtopic.php?pid=1473204#p1473204">2014-11-06 19:20:42</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=85314">Duelist</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2014-09-22</span></dd> <dd><span>Posts: 358</span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <p>Awesome! Now i understand what is happening with my VM and why does it crash. But still not getting why it doesn&#039;t.</p><p>Preface: I do not know anything about linux memory management and x86 memory management and i DO NOT know how IOMMU works, so there MAY be huge misunderstandings and errors. Do not rely on my brain and train of thoughts.</p><p>A short story about how fat firefox saved the day multiple times and yet managed to show me webpages with the power of google.</p><p>I have IOMMU enabled, but working in it&#039;s default, noforce mode, without iommu=pt.<br />I thought it was enough just to get IOMMU working, and it&#039;ll handle the stuff itself.</p><p>So, i have rather sparse system RAM ranges in /proc/iomem, like 256k here, 256m there, 1g over here etc. and a huge chunk(~4-6g) in the end, 0x100001000-0x24EFFFFFF.</p><p>Without using -realtime mlock=on, VM gets a memory range that can be paged and moved around by kernel. PCI device drivers in guest, however, do not expect this happening, they do DMA to some address, that DMA get translated by IOMMU, it gets out of VM&#039;s memory range and BAM - IO_PAGE_FAULT, VM crash, sometimes host gets shutdown due to memory corruption caused or something.(previously i thought that there was an interrupt storm happening, but MSI gets enabled normally, and watch -n1 &quot;cat /proc/interrupts&quot; until host shutdown showed me no unusual stuff)</p><p>So, we have problems due to memory paging and moving and iommu not translating everything right. I pass -realtime mlock=on, qemu mlocks itself SOME, maybe even MULTIPLE chunks of memory somewhere. When i run the QEMU after the system startup, there is very little memory consumed and QEMU being one of the first processes launched, so it has memory near zero, where it is very sparse. Guest PCI device driver does DMA to some address, IOMMU remaps this again and we have a page fault again.</p><p>BUT EVENTUALLY, it starts working when ~800mb of memory is consumed or some time has passed. The following criteria was met at my first QEMU startup, it mlocked itself memory in the range where it can have large and continous chunks of memory, and guest doing DMA is fine. It can be damaged if the kernel gives QEMU sparse enough memory to mlock - we will get page faults again.</p><br /><p>So, as i think, the problem hides in the IOMMU - it does redirect some DMA. Then i&#039;ve tried reading <a href="https://www.kernel.org/doc/Documentation/kernel-parameters.txt" rel="nofollow">linux kernel parameters</a>, and there is no documentation given at all:</p><div class="codebox"><pre><code> iommu= [x86] off force noforce biomerge panic nopanic merge nomerge forcesac soft pt [x86, IA-64]</code></pre></div><p>Yeah. What any of these mean?<br />So i went to google, and found <a href="http://lwn.net/Articles/252826/" rel="nofollow">this LKML message</a> archived. Dated 2007. Better than nothing, but not approved, and there is no clarification on iommu=pt option, since there was no such option back in that time.<br />Awesome.<br />Maybe <a href="https://www.kernel.org/doc/Documentation/x86/x86_64/boot-options.txt" rel="nofollow">boot-options</a> will help?<br />Yay, some clarification, but no iommu=pt option again. Yeah, i could&#039;ve used nice, old iommu=soft, but something hints me that would be slow.</p><p>Then i went to google again, and found <a href="http://lxr.free-electrons.com/source/arch/x86/kernel/pci-dma.c" rel="nofollow">a part of kernel source code here</a> with a nice comment:</p><div class="codebox"><pre><code> 39 /1 /bin /boot /cdrom /dev /etc /home /initrd.img /initrd.img.old /lib /lib32 /lib64 /libx32 /lost+found /media /mnt /opt /proc /root /run /sbin /srv /sys /tmp /ubiquity-apt-clone /usr /var /vmlinuz /vmlinuz.old /win81-base.qcow2 /win81-base.qcow2.md5 /win81-writable-amd.qcow2 /win81-writable-nvidia.qcow2 /win81-writable-nvidia.qcow2.backup 40 1.sh topic_100.html topic_101.html topic_102.html topic_103.html topic_104.html topic_105.html topic_106.html topic_107.html topic_108.html topic_109.html topic_10.html topic_110.html topic_111.html topic_112.html topic_113.html topic_114.html topic_115.html topic_116.html topic_117.html topic_118.html topic_119.html topic_11.html topic_120.html topic_121.html topic_122.html topic_123.html topic_124.html topic_125.html topic_126.html topic_12.html topic_13.html topic_14.html topic_15.html topic_16.html topic_17.html topic_18.html topic_19.html topic_1.html topic_20.html topic_21.html topic_22.html topic_23.html topic_24.html topic_25.html topic_26.html topic_27.html topic_28.html topic_29.html topic_2.html topic_30.html topic_31.html topic_32.html topic_33.html topic_34.html topic_35.html topic_36.html topic_37.html topic_38.html topic_39.html topic_3.html topic_40.html topic_41.html topic_42.html topic_43.html topic_44.html topic_45.html topic_46.html topic_47.html topic_48.html topic_49.html topic_4.html topic_50.html topic_51.html topic_52.html topic_53.html topic_54.html topic_55.html topic_56.html topic_57.html topic_58.html topic_59.html topic_5.html topic_60.html topic_61.html topic_62.html topic_63.html topic_64.html topic_65.html topic_66.html topic_67.html topic_68.html topic_69.html topic_6.html topic_70.html topic_71.html topic_72.html topic_73.html topic_74.html topic_75.html topic_76.html topic_77.html topic_78.html topic_79.html topic_7.html topic_80.html topic_81.html topic_82.html topic_83.html topic_84.html topic_85.html topic_86.html topic_87.html topic_88.html topic_89.html topic_8.html topic_90.html topic_91.html topic_92.html topic_93.html topic_94.html topic_95.html topic_96.html topic_97.html topic_98.html topic_99.html topic_9.html This variable becomes 1 if iommu=pt is passed on the kernel command line. 41 1.sh topic_100.html topic_101.html topic_102.html topic_103.html topic_104.html topic_105.html topic_106.html topic_107.html topic_108.html topic_109.html topic_10.html topic_110.html topic_111.html topic_112.html topic_113.html topic_114.html topic_115.html topic_116.html topic_117.html topic_118.html topic_119.html topic_11.html topic_120.html topic_121.html topic_122.html topic_123.html topic_124.html topic_125.html topic_126.html topic_12.html topic_13.html topic_14.html topic_15.html topic_16.html topic_17.html topic_18.html topic_19.html topic_1.html topic_20.html topic_21.html topic_22.html topic_23.html topic_24.html topic_25.html topic_26.html topic_27.html topic_28.html topic_29.html topic_2.html topic_30.html topic_31.html topic_32.html topic_33.html topic_34.html topic_35.html topic_36.html topic_37.html topic_38.html topic_39.html topic_3.html topic_40.html topic_41.html topic_42.html topic_43.html topic_44.html topic_45.html topic_46.html topic_47.html topic_48.html topic_49.html topic_4.html topic_50.html topic_51.html topic_52.html topic_53.html topic_54.html topic_55.html topic_56.html topic_57.html topic_58.html topic_59.html topic_5.html topic_60.html topic_61.html topic_62.html topic_63.html topic_64.html topic_65.html topic_66.html topic_67.html topic_68.html topic_69.html topic_6.html topic_70.html topic_71.html topic_72.html topic_73.html topic_74.html topic_75.html topic_76.html topic_77.html topic_78.html topic_79.html topic_7.html topic_80.html topic_81.html topic_82.html topic_83.html topic_84.html topic_85.html topic_86.html topic_87.html topic_88.html topic_89.html topic_8.html topic_90.html topic_91.html topic_92.html topic_93.html topic_94.html topic_95.html topic_96.html topic_97.html topic_98.html topic_99.html topic_9.html If this variable is 1, IOMMU implementations do no DMA translation for 42 1.sh topic_100.html topic_101.html topic_102.html topic_103.html topic_104.html topic_105.html topic_106.html topic_107.html topic_108.html topic_109.html topic_10.html topic_110.html topic_111.html topic_112.html topic_113.html topic_114.html topic_115.html topic_116.html topic_117.html topic_118.html topic_119.html topic_11.html topic_120.html topic_121.html topic_122.html topic_123.html topic_124.html topic_125.html topic_126.html topic_12.html topic_13.html topic_14.html topic_15.html topic_16.html topic_17.html topic_18.html topic_19.html topic_1.html topic_20.html topic_21.html topic_22.html topic_23.html topic_24.html topic_25.html topic_26.html topic_27.html topic_28.html topic_29.html topic_2.html topic_30.html topic_31.html topic_32.html topic_33.html topic_34.html topic_35.html topic_36.html topic_37.html topic_38.html topic_39.html topic_3.html topic_40.html topic_41.html topic_42.html topic_43.html topic_44.html topic_45.html topic_46.html topic_47.html topic_48.html topic_49.html topic_4.html topic_50.html topic_51.html topic_52.html topic_53.html topic_54.html topic_55.html topic_56.html topic_57.html topic_58.html topic_59.html topic_5.html topic_60.html topic_61.html topic_62.html topic_63.html topic_64.html topic_65.html topic_66.html topic_67.html topic_68.html topic_69.html topic_6.html topic_70.html topic_71.html topic_72.html topic_73.html topic_74.html topic_75.html topic_76.html topic_77.html topic_78.html topic_79.html topic_7.html topic_80.html topic_81.html topic_82.html topic_83.html topic_84.html topic_85.html topic_86.html topic_87.html topic_88.html topic_89.html topic_8.html topic_90.html topic_91.html topic_92.html topic_93.html topic_94.html topic_95.html topic_96.html topic_97.html topic_98.html topic_99.html topic_9.html devices and allow every device to access to whole physical memory. This is 43 1.sh topic_100.html topic_101.html topic_102.html topic_103.html topic_104.html topic_105.html topic_106.html topic_107.html topic_108.html topic_109.html topic_10.html topic_110.html topic_111.html topic_112.html topic_113.html topic_114.html topic_115.html topic_116.html topic_117.html topic_118.html topic_119.html topic_11.html topic_120.html topic_121.html topic_122.html topic_123.html topic_124.html topic_125.html topic_126.html topic_12.html topic_13.html topic_14.html topic_15.html topic_16.html topic_17.html topic_18.html topic_19.html topic_1.html topic_20.html topic_21.html topic_22.html topic_23.html topic_24.html topic_25.html topic_26.html topic_27.html topic_28.html topic_29.html topic_2.html topic_30.html topic_31.html topic_32.html topic_33.html topic_34.html topic_35.html topic_36.html topic_37.html topic_38.html topic_39.html topic_3.html topic_40.html topic_41.html topic_42.html topic_43.html topic_44.html topic_45.html topic_46.html topic_47.html topic_48.html topic_49.html topic_4.html topic_50.html topic_51.html topic_52.html topic_53.html topic_54.html topic_55.html topic_56.html topic_57.html topic_58.html topic_59.html topic_5.html topic_60.html topic_61.html topic_62.html topic_63.html topic_64.html topic_65.html topic_66.html topic_67.html topic_68.html topic_69.html topic_6.html topic_70.html topic_71.html topic_72.html topic_73.html topic_74.html topic_75.html topic_76.html topic_77.html topic_78.html topic_79.html topic_7.html topic_80.html topic_81.html topic_82.html topic_83.html topic_84.html topic_85.html topic_86.html topic_87.html topic_88.html topic_89.html topic_8.html topic_90.html topic_91.html topic_92.html topic_93.html topic_94.html topic_95.html topic_96.html topic_97.html topic_98.html topic_99.html topic_9.html useful if a user wants to use an IOMMU only for KVM device assignment to 44 1.sh topic_100.html topic_101.html topic_102.html topic_103.html topic_104.html topic_105.html topic_106.html topic_107.html topic_108.html topic_109.html topic_10.html topic_110.html topic_111.html topic_112.html topic_113.html topic_114.html topic_115.html topic_116.html topic_117.html topic_118.html topic_119.html topic_11.html topic_120.html topic_121.html topic_122.html topic_123.html topic_124.html topic_125.html topic_126.html topic_12.html topic_13.html topic_14.html topic_15.html topic_16.html topic_17.html topic_18.html topic_19.html topic_1.html topic_20.html topic_21.html topic_22.html topic_23.html topic_24.html topic_25.html topic_26.html topic_27.html topic_28.html topic_29.html topic_2.html topic_30.html topic_31.html topic_32.html topic_33.html topic_34.html topic_35.html topic_36.html topic_37.html topic_38.html topic_39.html topic_3.html topic_40.html topic_41.html topic_42.html topic_43.html topic_44.html topic_45.html topic_46.html topic_47.html topic_48.html topic_49.html topic_4.html topic_50.html topic_51.html topic_52.html topic_53.html topic_54.html topic_55.html topic_56.html topic_57.html topic_58.html topic_59.html topic_5.html topic_60.html topic_61.html topic_62.html topic_63.html topic_64.html topic_65.html topic_66.html topic_67.html topic_68.html topic_69.html topic_6.html topic_70.html topic_71.html topic_72.html topic_73.html topic_74.html topic_75.html topic_76.html topic_77.html topic_78.html topic_79.html topic_7.html topic_80.html topic_81.html topic_82.html topic_83.html topic_84.html topic_85.html topic_86.html topic_87.html topic_88.html topic_89.html topic_8.html topic_90.html topic_91.html topic_92.html topic_93.html topic_94.html topic_95.html topic_96.html topic_97.html topic_98.html topic_99.html topic_9.html guests and not for driver dma translation. 45 */</code></pre></div><p>Hmm... That seems to FIT EXACTLY FOR MY USE!</p><p>But that&#039;s not the end. Things are getting interesting.<br />Let&#039;s see what it looks like when VM is working right.</p><p>After a brief read of <a href="https://www.kernel.org/doc/Documentation/vm/pagemap.txt" rel="nofollow">this</a>...</p><p>We start a qemu, stop it to give us some time until windows boots and starts GPU drivers.<br />Then we do ps -ef | grep qemu to determine it&#039;s PID.<br />As root: cat /proc/QEMU-PID/maps | grep vfio<br />We have six ranges of memory mapped, looking like this:</p><div class="codebox"><pre><code>7fc908000000-7fc918000000 rw-s b0000000 00:09 8529 anon_inode:[vfio-device] 7fc918000000-7fc928000000 rw-s c0000000 00:09 8529 anon_inode:[vfio-device] 7fca63b08000-7fca63b48000 rw-s fe200000 00:09 8529 anon_inode:[vfio-device] 7fca63b48000-7fca63b88000 rw-s fe300000 00:09 8529 anon_inode:[vfio-device] 7fca63c30000-7fca63c34000 rw-s fe260000 00:09 8529 anon_inode:[vfio-device] 7fca63c38000-7fca63c3c000 rw-s fe360000 00:09 8529 anon_inode:[vfio-device]</code></pre></div><p>Well, as lspci -v hints us, these are really PCI device memory ranges!<br />But these addresses are virtual, it&#039;s how it looks like from the process&#039; side. That isn&#039;t very interesting to us, but still interesting.</p><p>How do we translate virtual address to physical?<br />The power of google showed me <a href="http://fivelinesofcode.blogspot.ru/2014/03/how-to-translate-virtual-to-physical.html" rel="nofollow">this neat program</a> that does that.</p><p>Copy-paste-save-gcc...</p><div class="codebox"><pre><code>Big endian? 0 Vaddr: 0x7fc908000000, Page_size: 4096, Entry_size: 8 Reading /proc/3469/pagemap at 0x3fe4840000 [0]0xc3 [1]0x32 [2]0x1d [3]0x0 [4]0x0 [5]0x0 [6]0x0 [7]0x86 Result: 0x86000000001d32c3 PFN: 0x1d32c3</code></pre></div><p>Yay, a physical address! And it fits. And VM works nice. And it doesn&#039;t crash.</p><p>Apparently, i didn&#039;t managed to crash the VM again on purpose, but when it does, it looks like...</p><div class="codebox"><pre><code>AMD-Vi: Event logged [IO_PAGE_FAULT device=01:00.0 domain=0x0021 address=0x00000001198c0000 flags=0x0010]</code></pre></div><p>Yet the address is different(the example used here is very old) and it touches some other process&#039; memory or even excedes the system ram range.</p><p>What i am not understanding fully - why does the DMA get remapped normally when it isn&#039;t out of qemu&#039;s memory bounds.<br />Maybe that whole story is a huge lie, heh, read the preface.</p><p>Morale:<br /><strong>IOMMU=PT IN KERNEL PARAMETERS OR DEATH!</strong><br />Neat line in dmesg:<br />AMD-Vi: Initialized for Passthrough Mode</p><p>P.S.<br />Sorry for the double post, heh.</p> <p class="postedit"><em>Last edited by Duelist (2014-11-06 19:30:00)</em></p> </div> <div class="postsignature postmsg"><hr /><p><span class="bbs">The forum rules prohibit requesting support for distributions other than arch.</span><br /><a href="https://bbs.archlinux.org/viewtopic.php?pid=1551460#p1551460" rel="nofollow">I gave up.</a><a href="https://bbs.archlinux.org/viewtopic.php?id=162768" rel="nofollow"> It was too late.</a><br /><a href="http://pastebin.com/B3fL84bq" rel="nofollow">What I was trying to do</a>.<br /><a href="http://vfio.blogspot.com/" rel="nofollow">The reference about VFIO and KVM VGA passthrough.</a></p></div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1473204">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1473215" class="blockpost rowodd"> <h2><span><span class="conr">#3167</span> <a href="viewtopic.php?pid=1473215#p1473215">2014-11-06 20:04:15</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=86501">mmm</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2014-11-06</span></dd> <dd><span>Posts: 4</span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <p>Did you try &quot;-mem-prealloc&quot;? If dynamic memory allocation is your problem, I feel like that should help.</p><p>Edit: nvm - saw it in your previous post now. Still wondering though how dynamic allocation could be a problem then.</p> <p class="postedit"><em>Last edited by mmm (2014-11-06 20:28:50)</em></p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1473215">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1473265" class="blockpost roweven"> <h2><span><span class="conr">#3168</span> <a href="viewtopic.php?pid=1473265#p1473265">2014-11-06 21:29:27</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=75590">aw</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2013-10-04</span></dd> <dd><span>Posts: 921</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=75590">Email</a></span> <span class="website"><a href="http://vfio.blogspot.com/" rel="nofollow">Website</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <p>Oh dear, where to begin...</p><div class="quotebox"><cite>Duelist wrote:</cite><blockquote><div><p>So, i have rather sparse system RAM ranges in /proc/iomem, like 256k here, 256m there, 1g over here etc. and a huge chunk(~4-6g) in the end, 0x100001000-0x24EFFFFFF.</p></div></blockquote></div><p>/proc/iomem is not RAM, it&#039;s device MMIO addresses</p><div class="quotebox"><blockquote><div><p>Without using -realtime mlock=on, VM gets a memory range that can be paged and moved around by kernel.</p></div></blockquote></div><p>Only when an assigned device is NOT present.</p><div class="quotebox"><blockquote><div><p>PCI device drivers in guest, however, do not expect this happening, they do DMA to some address, that DMA get translated by IOMMU, it gets out of VM&#039;s memory range and BAM - IO_PAGE_FAULT, VM crash,</p></div></blockquote></div><p>This is why when there&#039;s an assigned device guest memory is pinned, making the mlock redundant.</p><div class="quotebox"><blockquote><div><p>sometimes host gets shutdown due to memory corruption caused or something.(previously i thought that there was an interrupt storm happening, but MSI gets enabled normally, and watch -n1 &quot;cat /proc/interrupts&quot; until host shutdown showed me no unusual stuff)</p><p>So, we have problems due to memory paging and moving and iommu not translating everything right. I pass -realtime mlock=on, qemu mlocks itself SOME, maybe even MULTIPLE chunks of memory somewhere. When i run the QEMU after the system startup, there is very little memory consumed and QEMU being one of the first processes launched, so it has memory near zero, where it is very sparse. Guest PCI device driver does DMA to some address, IOMMU remaps this again and we have a page fault again.</p><p>BUT EVENTUALLY, it starts working when ~800mb of memory is consumed or some time has passed. The following criteria was met at my first QEMU startup, it mlocked itself memory in the range where it can have large and continous chunks of memory, and guest doing DMA is fine. It can be damaged if the kernel gives QEMU sparse enough memory to mlock - we will get page faults again.</p><br /><p>So, as i think, the problem hides in the IOMMU - it does redirect some DMA. Then i&#039;ve tried reading <a href="https://www.kernel.org/doc/Documentation/kernel-parameters.txt" rel="nofollow">linux kernel parameters</a>, and there is no documentation given at all:</p><div class="codebox"><pre><code> iommu= [x86] off force noforce biomerge panic nopanic merge nomerge forcesac soft pt [x86, IA-64]</code></pre></div><p>Yeah. What any of these mean?<br />So i went to google, and found <a href="http://lwn.net/Articles/252826/" rel="nofollow">this LKML message</a> archived. Dated 2007. Better than nothing, but not approved, and there is no clarification on iommu=pt option, since there was no such option back in that time.<br />Awesome.<br />Maybe <a href="https://www.kernel.org/doc/Documentation/x86/x86_64/boot-options.txt" rel="nofollow">boot-options</a> will help?<br />Yay, some clarification, but no iommu=pt option again. Yeah, i could&#039;ve used nice, old iommu=soft, but something hints me that would be slow.</p><p>Then i went to google again, and found <a href="http://lxr.free-electrons.com/source/arch/x86/kernel/pci-dma.c" rel="nofollow">a part of kernel source code here</a> with a nice comment:</p><div class="codebox"><pre><code> 39 /1 /bin /boot /cdrom /dev /etc /home /initrd.img /initrd.img.old /lib /lib32 /lib64 /libx32 /lost+found /media /mnt /opt /proc /root /run /sbin /srv /sys /tmp /ubiquity-apt-clone /usr /var /vmlinuz /vmlinuz.old /win81-base.qcow2 /win81-base.qcow2.md5 /win81-writable-amd.qcow2 /win81-writable-nvidia.qcow2 /win81-writable-nvidia.qcow2.backup 40 1.sh topic_100.html topic_101.html topic_102.html topic_103.html topic_104.html topic_105.html topic_106.html topic_107.html topic_108.html topic_109.html topic_10.html topic_110.html topic_111.html topic_112.html topic_113.html topic_114.html topic_115.html topic_116.html topic_117.html topic_118.html topic_119.html topic_11.html topic_120.html topic_121.html topic_122.html topic_123.html topic_124.html topic_125.html topic_126.html topic_12.html topic_13.html topic_14.html topic_15.html topic_16.html topic_17.html topic_18.html topic_19.html topic_1.html topic_20.html topic_21.html topic_22.html topic_23.html topic_24.html topic_25.html topic_26.html topic_27.html topic_28.html topic_29.html topic_2.html topic_30.html topic_31.html topic_32.html topic_33.html topic_34.html topic_35.html topic_36.html topic_37.html topic_38.html topic_39.html topic_3.html topic_40.html topic_41.html topic_42.html topic_43.html topic_44.html topic_45.html topic_46.html topic_47.html topic_48.html topic_49.html topic_4.html topic_50.html topic_51.html topic_52.html topic_53.html topic_54.html topic_55.html topic_56.html topic_57.html topic_58.html topic_59.html topic_5.html topic_60.html topic_61.html topic_62.html topic_63.html topic_64.html topic_65.html topic_66.html topic_67.html topic_68.html topic_69.html topic_6.html topic_70.html topic_71.html topic_72.html topic_73.html topic_74.html topic_75.html topic_76.html topic_77.html topic_78.html topic_79.html topic_7.html topic_80.html topic_81.html topic_82.html topic_83.html topic_84.html topic_85.html topic_86.html topic_87.html topic_88.html topic_89.html topic_8.html topic_90.html topic_91.html topic_92.html topic_93.html topic_94.html topic_95.html topic_96.html topic_97.html topic_98.html topic_99.html topic_9.html This variable becomes 1 if iommu=pt is passed on the kernel command line. 41 1.sh topic_100.html topic_101.html topic_102.html topic_103.html topic_104.html topic_105.html topic_106.html topic_107.html topic_108.html topic_109.html topic_10.html topic_110.html topic_111.html topic_112.html topic_113.html topic_114.html topic_115.html topic_116.html topic_117.html topic_118.html topic_119.html topic_11.html topic_120.html topic_121.html topic_122.html topic_123.html topic_124.html topic_125.html topic_126.html topic_12.html topic_13.html topic_14.html topic_15.html topic_16.html topic_17.html topic_18.html topic_19.html topic_1.html topic_20.html topic_21.html topic_22.html topic_23.html topic_24.html topic_25.html topic_26.html topic_27.html topic_28.html topic_29.html topic_2.html topic_30.html topic_31.html topic_32.html topic_33.html topic_34.html topic_35.html topic_36.html topic_37.html topic_38.html topic_39.html topic_3.html topic_40.html topic_41.html topic_42.html topic_43.html topic_44.html topic_45.html topic_46.html topic_47.html topic_48.html topic_49.html topic_4.html topic_50.html topic_51.html topic_52.html topic_53.html topic_54.html topic_55.html topic_56.html topic_57.html topic_58.html topic_59.html topic_5.html topic_60.html topic_61.html topic_62.html topic_63.html topic_64.html topic_65.html topic_66.html topic_67.html topic_68.html topic_69.html topic_6.html topic_70.html topic_71.html topic_72.html topic_73.html topic_74.html topic_75.html topic_76.html topic_77.html topic_78.html topic_79.html topic_7.html topic_80.html topic_81.html topic_82.html topic_83.html topic_84.html topic_85.html topic_86.html topic_87.html topic_88.html topic_89.html topic_8.html topic_90.html topic_91.html topic_92.html topic_93.html topic_94.html topic_95.html topic_96.html topic_97.html topic_98.html topic_99.html topic_9.html If this variable is 1, IOMMU implementations do no DMA translation for 42 1.sh topic_100.html topic_101.html topic_102.html topic_103.html topic_104.html topic_105.html topic_106.html topic_107.html topic_108.html topic_109.html topic_10.html topic_110.html topic_111.html topic_112.html topic_113.html topic_114.html topic_115.html topic_116.html topic_117.html topic_118.html topic_119.html topic_11.html topic_120.html topic_121.html topic_122.html topic_123.html topic_124.html topic_125.html topic_126.html topic_12.html topic_13.html topic_14.html topic_15.html topic_16.html topic_17.html topic_18.html topic_19.html topic_1.html topic_20.html topic_21.html topic_22.html topic_23.html topic_24.html topic_25.html topic_26.html topic_27.html topic_28.html topic_29.html topic_2.html topic_30.html topic_31.html topic_32.html topic_33.html topic_34.html topic_35.html topic_36.html topic_37.html topic_38.html topic_39.html topic_3.html topic_40.html topic_41.html topic_42.html topic_43.html topic_44.html topic_45.html topic_46.html topic_47.html topic_48.html topic_49.html topic_4.html topic_50.html topic_51.html topic_52.html topic_53.html topic_54.html topic_55.html topic_56.html topic_57.html topic_58.html topic_59.html topic_5.html topic_60.html topic_61.html topic_62.html topic_63.html topic_64.html topic_65.html topic_66.html topic_67.html topic_68.html topic_69.html topic_6.html topic_70.html topic_71.html topic_72.html topic_73.html topic_74.html topic_75.html topic_76.html topic_77.html topic_78.html topic_79.html topic_7.html topic_80.html topic_81.html topic_82.html topic_83.html topic_84.html topic_85.html topic_86.html topic_87.html topic_88.html topic_89.html topic_8.html topic_90.html topic_91.html topic_92.html topic_93.html topic_94.html topic_95.html topic_96.html topic_97.html topic_98.html topic_99.html topic_9.html devices and allow every device to access to whole physical memory. This is 43 1.sh topic_100.html topic_101.html topic_102.html topic_103.html topic_104.html topic_105.html topic_106.html topic_107.html topic_108.html topic_109.html topic_10.html topic_110.html topic_111.html topic_112.html topic_113.html topic_114.html topic_115.html topic_116.html topic_117.html topic_118.html topic_119.html topic_11.html topic_120.html topic_121.html topic_122.html topic_123.html topic_124.html topic_125.html topic_126.html topic_12.html topic_13.html topic_14.html topic_15.html topic_16.html topic_17.html topic_18.html topic_19.html topic_1.html topic_20.html topic_21.html topic_22.html topic_23.html topic_24.html topic_25.html topic_26.html topic_27.html topic_28.html topic_29.html topic_2.html topic_30.html topic_31.html topic_32.html topic_33.html topic_34.html topic_35.html topic_36.html topic_37.html topic_38.html topic_39.html topic_3.html topic_40.html topic_41.html topic_42.html topic_43.html topic_44.html topic_45.html topic_46.html topic_47.html topic_48.html topic_49.html topic_4.html topic_50.html topic_51.html topic_52.html topic_53.html topic_54.html topic_55.html topic_56.html topic_57.html topic_58.html topic_59.html topic_5.html topic_60.html topic_61.html topic_62.html topic_63.html topic_64.html topic_65.html topic_66.html topic_67.html topic_68.html topic_69.html topic_6.html topic_70.html topic_71.html topic_72.html topic_73.html topic_74.html topic_75.html topic_76.html topic_77.html topic_78.html topic_79.html topic_7.html topic_80.html topic_81.html topic_82.html topic_83.html topic_84.html topic_85.html topic_86.html topic_87.html topic_88.html topic_89.html topic_8.html topic_90.html topic_91.html topic_92.html topic_93.html topic_94.html topic_95.html topic_96.html topic_97.html topic_98.html topic_99.html topic_9.html useful if a user wants to use an IOMMU only for KVM device assignment to 44 1.sh topic_100.html topic_101.html topic_102.html topic_103.html topic_104.html topic_105.html topic_106.html topic_107.html topic_108.html topic_109.html topic_10.html topic_110.html topic_111.html topic_112.html topic_113.html topic_114.html topic_115.html topic_116.html topic_117.html topic_118.html topic_119.html topic_11.html topic_120.html topic_121.html topic_122.html topic_123.html topic_124.html topic_125.html topic_126.html topic_12.html topic_13.html topic_14.html topic_15.html topic_16.html topic_17.html topic_18.html topic_19.html topic_1.html topic_20.html topic_21.html topic_22.html topic_23.html topic_24.html topic_25.html topic_26.html topic_27.html topic_28.html topic_29.html topic_2.html topic_30.html topic_31.html topic_32.html topic_33.html topic_34.html topic_35.html topic_36.html topic_37.html topic_38.html topic_39.html topic_3.html topic_40.html topic_41.html topic_42.html topic_43.html topic_44.html topic_45.html topic_46.html topic_47.html topic_48.html topic_49.html topic_4.html topic_50.html topic_51.html topic_52.html topic_53.html topic_54.html topic_55.html topic_56.html topic_57.html topic_58.html topic_59.html topic_5.html topic_60.html topic_61.html topic_62.html topic_63.html topic_64.html topic_65.html topic_66.html topic_67.html topic_68.html topic_69.html topic_6.html topic_70.html topic_71.html topic_72.html topic_73.html topic_74.html topic_75.html topic_76.html topic_77.html topic_78.html topic_79.html topic_7.html topic_80.html topic_81.html topic_82.html topic_83.html topic_84.html topic_85.html topic_86.html topic_87.html topic_88.html topic_89.html topic_8.html topic_90.html topic_91.html topic_92.html topic_93.html topic_94.html topic_95.html topic_96.html topic_97.html topic_98.html topic_99.html topic_9.html guests and not for driver dma translation. 45 */</code></pre></div><p>Hmm... That seems to FIT EXACTLY FOR MY USE!</p><p>But that&#039;s not the end. Things are getting interesting.<br />Let&#039;s see what it looks like when VM is working right.</p><p>After a brief read of <a href="https://www.kernel.org/doc/Documentation/vm/pagemap.txt" rel="nofollow">this</a>...</p><p>We start a qemu, stop it to give us some time until windows boots and starts GPU drivers.<br />Then we do ps -ef | grep qemu to determine it&#039;s PID.<br />As root: cat /proc/QEMU-PID/maps | grep vfio<br />We have six ranges of memory mapped, looking like this:</p><div class="codebox"><pre><code>7fc908000000-7fc918000000 rw-s b0000000 00:09 8529 anon_inode:[vfio-device] 7fc918000000-7fc928000000 rw-s c0000000 00:09 8529 anon_inode:[vfio-device] 7fca63b08000-7fca63b48000 rw-s fe200000 00:09 8529 anon_inode:[vfio-device] 7fca63b48000-7fca63b88000 rw-s fe300000 00:09 8529 anon_inode:[vfio-device] 7fca63c30000-7fca63c34000 rw-s fe260000 00:09 8529 anon_inode:[vfio-device] 7fca63c38000-7fca63c3c000 rw-s fe360000 00:09 8529 anon_inode:[vfio-device]</code></pre></div><p>Well, as lspci -v hints us, these are really PCI device memory ranges!<br />But these addresses are virtual, it&#039;s how it looks like from the process&#039; side. That isn&#039;t very interesting to us, but still interesting.</p><p>How do we translate virtual address to physical?<br />The power of google showed me <a href="http://fivelinesofcode.blogspot.ru/2014/03/how-to-translate-virtual-to-physical.html" rel="nofollow">this neat program</a> that does that.</p><p>Copy-paste-save-gcc...</p><div class="codebox"><pre><code>Big endian? 0 Vaddr: 0x7fc908000000, Page_size: 4096, Entry_size: 8 Reading /proc/3469/pagemap at 0x3fe4840000 [0]0xc3 [1]0x32 [2]0x1d [3]0x0 [4]0x0 [5]0x0 [6]0x0 [7]0x86 Result: 0x86000000001d32c3 PFN: 0x1d32c3</code></pre></div><p>Yay, a physical address! And it fits. And VM works nice. And it doesn&#039;t crash.</p></div></blockquote></div><p>Um, ok.&#160; What&#039;s PFN 0x1d32c3 tell you?&#160; That&#039;s a Page Frame Number, so you need to multiply by the page size (4k) to get a physical address, so 0x1d32c3000 is the physical address, what does that tell us?</p><p>You can also note in this example:</p><p>01:10.1 Ethernet controller: Intel Corporation 82576 Virtual Function (rev 01)<br />&#160; &#160; Region 0: [virtual] Memory at f21a0000 (64-bit, non-prefetchable) [size=16K]<br />&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; ^^^^^^^^^^^<br />&#160; &#160; Region 3: [virtual] Memory at f21c0000 (64-bit, non-prefetchable) [size=16K]<br />&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; ^^^^^^^^^^^</p><p>7f96f35a2000-7f96f35a5000 rw-s f21c1000 00:09 7271&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;anon_inode:[vfio-device]<br />&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;^^^^^^^^^^<br />7f96f35a5000-7f96f35a9000 rw-s f21a0000 00:09 7271&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;anon_inode:[vfio-device]<br />&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;^^^^^^^^^^<br />But I&#039;m still not sure what you&#039;re reading into that.</p><div class="quotebox"><blockquote><div><p>Apparently, i didn&#039;t managed to crash the VM again on purpose, but when it does, it looks like...</p><div class="codebox"><pre><code>AMD-Vi: Event logged [IO_PAGE_FAULT device=01:00.0 domain=0x0021 address=0x00000001198c0000 flags=0x0010]</code></pre></div><p>Yet the address is different(the example used here is very old) and it touches some other process&#039; memory or even excedes the system ram range.</p></div></blockquote></div><p>adjusting the guest memory size is how I typically test whether these are stray DMAs or something is broken.&#160; That address is just over 4.5G, so if you boot your guest with 2G of ram, do you still get these types of faults?</p><div class="quotebox"><blockquote><div><p>What i am not understanding fully - why does the DMA get remapped normally when it isn&#039;t out of qemu&#039;s memory bounds.<br />Maybe that whole story is a huge lie, heh, read the preface.</p></div></blockquote></div><p>&lt;ahhem&gt; I think you&#039;re jumping to some inaccurate conclusions here.</p><div class="quotebox"><blockquote><div><p>Morale:<br /><strong>IOMMU=PT IN KERNEL PARAMETERS OR DEATH!</strong></p></div></blockquote></div><p>Not true at all.</p><p>What happens if you use the vfio_iommu_type1 module option disable_hugepages=1?&#160; By default vfio will attempt to map the largest contiguous memory chunk it can find through the IOMMU.&#160; AMD-Vi supports nearly any power of two size, but with AMD going out of favor with server vendors, I don&#039;t expect it gets much testing.&#160; The disable_hugepages forces the vfio code to map each page individually, avoiding superpage bugs in the IOMMU driver.</p> </div> <div class="postsignature postmsg"><hr /><p><a href="http://vfio.blogspot.com" rel="nofollow">http://vfio.blogspot.com</a><br />Looking for a more open forum to discuss vfio related uses?&#160; Try <a href="https://www.redhat.com/mailman/listinfo/vfio-users" rel="nofollow">https://www.redhat.com/mailman/listinfo/vfio-users</a></p></div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1473265">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1473319" class="blockpost rowodd"> <h2><span><span class="conr">#3169</span> <a href="viewtopic.php?pid=1473319#p1473319">2014-11-07 01:36:30</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=84760">Denso</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd class="postavatar"><img src="https://bbs.archlinux.org/img/avatars/84760.png?m=1412533733" width="71" height="80" alt="" /></dd> <dd><span>Registered: 2014-08-30</span></dd> <dd><span>Posts: 179</span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <p>Hello everyone !</p><p>I noticed a hiccup that occurs to every VM along with the host every half a minute .</p><p>To my surprise , rebuilding qemu-git solved the issue for me , but wait ! I did a little change :</p><p>I removed Haswell &quot;optimizations&quot; from makepkg.conf :</p><p>-march=core-avx2 -mtune=haswell (if I remember these values correctly) , and returned everything to default : -march=x86-64 -mtune=generic .</p><p>Rebuilt qemu-git + ovmf-svn , reboot and all hiccups are gone !</p><p>So generic gcc profile (for me at least) was &quot;optimized&quot; alot better than specific CPU optimizations .</p><p>Hope this helps anyone having similar issues !</p> <p class="postedit"><em>Last edited by Denso (2014-11-07 01:36:47)</em></p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1473319">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1473323" class="blockpost roweven"> <h2><span><span class="conr">#3170</span> <a href="viewtopic.php?pid=1473323#p1473323">2014-11-07 01:47:10</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=85314">Duelist</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2014-09-22</span></dd> <dd><span>Posts: 358</span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>aw wrote:</cite><blockquote><div><p>This is why when there&#039;s an assigned device guest memory is pinned, making the mlock redundant.</p></div></blockquote></div><p>Then why does it helps?</p><div class="quotebox"><cite>aw wrote:</cite><blockquote><div><p>Um, ok.&#160; What&#039;s PFN 0x1d32c3 tell you?&#160; That&#039;s a Page Frame Number, so you need to multiply by the page size (4k) to get a physical address, so 0x1d32c3000 is the physical address, what does that tell us?</p></div></blockquote></div><p>Yes, i&#039;ve forgot to mention that this needs to multiplied by page size. I did that. That part of my bunch-of-letters is kinda useless because i haven&#039;t managed to get my VMs faulty memory chunks. Once i got a host shutdown. But the idea was simple - i determine the physical address, add 256M to it, and if compared to MMIO table it looks way to bad - that could mean that the page faults are inevitable.</p><div class="quotebox"><cite>aw wrote:</cite><blockquote><div><p>adjusting the guest memory size is how I typically test whether these are stray DMAs or something is broken.&#160; That address is just over 4.5G, so if you boot your guest with 2G of ram, do you still get these types of faults?</p></div></blockquote></div><p>Heh, why i didn&#039;t come up with such an idea.. But digging in the error logs - i&#039;ve had different addresses, even pointing to near-zero(~&lt;600M) system RAM ranges.</p><div class="quotebox"><cite>aw wrote:</cite><blockquote><div><p>&lt;ahhem&gt; I think you&#039;re jumping to some inaccurate conclusions here.</p></div></blockquote></div><p>Preface.</p><div class="quotebox"><cite>aw wrote:</cite><blockquote><div><div class="quotebox"><blockquote><div><p>Morale:<br />IOMMU=PT IN KERNEL PARAMETERS OR DEATH!</p></div></blockquote></div><p>Not true at all.</p></div></blockquote></div><p>Well, it appears to be fixing page faults on my system. After some reboots mixed with complete power cycles i couldn&#039;t reproduce page faults again. Or maybe i&#039;m just very lucky.</p><div class="quotebox"><cite>aw wrote:</cite><blockquote><div><p>What happens if you use the vfio_iommu_type1 module option disable_hugepages=1?&#160; By default vfio will attempt to map the largest contiguous memory chunk it can find through the IOMMU.&#160; AMD-Vi supports nearly any power of two size, but with AMD going out of favor with server vendors, I don&#039;t expect it gets much testing.&#160; The disable_hugepages forces the vfio code to map each page individually, avoiding superpage bugs in the IOMMU driver.</p></div></blockquote></div><p>It sounds very different from &quot;just not using hugepages&quot;. I&#039;ll test that.</p> </div> <div class="postsignature postmsg"><hr /><p><span class="bbs">The forum rules prohibit requesting support for distributions other than arch.</span><br /><a href="https://bbs.archlinux.org/viewtopic.php?pid=1551460#p1551460" rel="nofollow">I gave up.</a><a href="https://bbs.archlinux.org/viewtopic.php?id=162768" rel="nofollow"> It was too late.</a><br /><a href="http://pastebin.com/B3fL84bq" rel="nofollow">What I was trying to do</a>.<br /><a href="http://vfio.blogspot.com/" rel="nofollow">The reference about VFIO and KVM VGA passthrough.</a></p></div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1473323">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1473326" class="blockpost rowodd"> <h2><span><span class="conr">#3171</span> <a href="viewtopic.php?pid=1473326#p1473326">2014-11-07 01:53:36</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=85314">Duelist</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2014-09-22</span></dd> <dd><span>Posts: 358</span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>Denso wrote:</cite><blockquote><div><p>Hello everyone !</p><p>I noticed a hiccup that occurs to every VM along with the host every half a minute .</p><p>To my surprise , rebuilding qemu-git solved the issue for me , but wait ! I did a little change :</p><p>I removed Haswell &quot;optimizations&quot; from makepkg.conf :</p><p>-march=core-avx2 -mtune=haswell (if I remember these values correctly) , and returned everything to default : -march=x86-64 -mtune=generic .</p><p>Rebuilt qemu-git + ovmf-svn , reboot and all hiccups are gone !</p><p>So generic gcc profile (for me at least) was &quot;optimized&quot; alot better than specific CPU optimizations .</p><p>Hope this helps anyone having similar issues !</p></div></blockquote></div><p>Please note, since GCC 4.9 generic optimization is now based on Intel Core and AMD Bulldozer microarchitectures&#039; optimizations. What GCC version you were using when hiccups appeared?</p><p><a href="https://gcc.gnu.org/gcc-4.9/changes.html" rel="nofollow">GCC 4.9 Changes</a></p> </div> <div class="postsignature postmsg"><hr /><p><span class="bbs">The forum rules prohibit requesting support for distributions other than arch.</span><br /><a href="https://bbs.archlinux.org/viewtopic.php?pid=1551460#p1551460" rel="nofollow">I gave up.</a><a href="https://bbs.archlinux.org/viewtopic.php?id=162768" rel="nofollow"> It was too late.</a><br /><a href="http://pastebin.com/B3fL84bq" rel="nofollow">What I was trying to do</a>.<br /><a href="http://vfio.blogspot.com/" rel="nofollow">The reference about VFIO and KVM VGA passthrough.</a></p></div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1473326">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1473338" class="blockpost roweven"> <h2><span><span class="conr">#3172</span> <a href="viewtopic.php?pid=1473338#p1473338">2014-11-07 03:00:08</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=84760">Denso</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd class="postavatar"><img src="https://bbs.archlinux.org/img/avatars/84760.png?m=1412533733" width="71" height="80" alt="" /></dd> <dd><span>Registered: 2014-08-30</span></dd> <dd><span>Posts: 179</span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>Duelist wrote:</cite><blockquote><div><div class="quotebox"><cite>Denso wrote:</cite><blockquote><div><p>Hello everyone !</p><p>I noticed a hiccup that occurs to every VM along with the host every half a minute .</p><p>To my surprise , rebuilding qemu-git solved the issue for me , but wait ! I did a little change :</p><p>I removed Haswell &quot;optimizations&quot; from makepkg.conf :</p><p>-march=core-avx2 -mtune=haswell (if I remember these values correctly) , and returned everything to default : -march=x86-64 -mtune=generic .</p><p>Rebuilt qemu-git + ovmf-svn , reboot and all hiccups are gone !</p><p>So generic gcc profile (for me at least) was &quot;optimized&quot; alot better than specific CPU optimizations .</p><p>Hope this helps anyone having similar issues !</p></div></blockquote></div><p>Please note, since GCC 4.9 generic optimization is now based on Intel Core and AMD Bulldozer microarchitectures&#039; optimizations. What GCC version you were using when hiccups appeared?</p><p><a href="https://gcc.gnu.org/gcc-4.9/changes.html" rel="nofollow">GCC 4.9 Changes</a></p></div></blockquote></div><p>4.9.2</p><p>Maybe GCC knows whats best for my CPU better than me <img src="https://bbs.archlinux.org/img/smilies/smile.png" width="15" height="15" alt="smile" /></p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1473338">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1473466" class="blockpost rowodd"> <h2><span><span class="conr">#3173</span> <a href="viewtopic.php?pid=1473466#p1473466">2014-11-07 15:30:25</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=85314">Duelist</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2014-09-22</span></dd> <dd><span>Posts: 358</span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <p><span class="postimg"><img src="http://i.imgur.com/JXj6nDw.png" alt="Shaders? TMUs?" /></span><br />Shader and TM units count doubled on the slave crossfire card. Maybe that is related to video memory magic.<br />The cards are identical. Only differences are different heat pipe ends and a serial number. I don&#039;t know if it&#039;s a GPU-Z bug or VM errors(or maybe it actually works so), but it works and looks funny.</p><p>Well, appears like i was extremely lucky yesterday having no io page faults.</p><p>Today first VM launch resulted in a page fault, and i&#039;ve recorded that. The address in question was located somewhere near 2.6Gb of MMIO address space.</p><p>Now i&#039;ve disabled hugepages and the current VM instance seem to be stable.</p><p>Also, aw, modinfo kvm tells me that there is</p><div class="codebox"><pre><code>parm: allow_unsafe_assigned_interrupts:Enable device assignment on platforms without interrupt remapping support. (bool)</code></pre></div><p>which seem to be very alike to...</p><div class="codebox"><pre><code>parm: allow_unsafe_interrupts:Enable VFIO IOMMU support for on platforms without interrupt remapping support. (bool)</code></pre></div><p>in your vfio_iommu_type1 module. Am i right that it does the same thing, but for pci-assign? Or it enables interrupt remapping system-wide, regardless of method used?<br />Oh, and also,append a fix of that copy-paste &quot;for on platforms&quot; typo to your TODO list;)</p> </div> <div class="postsignature postmsg"><hr /><p><span class="bbs">The forum rules prohibit requesting support for distributions other than arch.</span><br /><a href="https://bbs.archlinux.org/viewtopic.php?pid=1551460#p1551460" rel="nofollow">I gave up.</a><a href="https://bbs.archlinux.org/viewtopic.php?id=162768" rel="nofollow"> It was too late.</a><br /><a href="http://pastebin.com/B3fL84bq" rel="nofollow">What I was trying to do</a>.<br /><a href="http://vfio.blogspot.com/" rel="nofollow">The reference about VFIO and KVM VGA passthrough.</a></p></div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1473466">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1473470" class="blockpost roweven"> <h2><span><span class="conr">#3174</span> <a href="viewtopic.php?pid=1473470#p1473470">2014-11-07 15:45:06</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=75590">aw</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2013-10-04</span></dd> <dd><span>Posts: 921</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=75590">Email</a></span> <span class="website"><a href="http://vfio.blogspot.com/" rel="nofollow">Website</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>Duelist wrote:</cite><blockquote><div><p>Also, aw, modinfo kvm tells me that there is</p><div class="codebox"><pre><code>parm: allow_unsafe_assigned_interrupts:Enable device assignment on platforms without interrupt remapping support. (bool)</code></pre></div><p>which seem to be very alike to...</p><div class="codebox"><pre><code>parm: allow_unsafe_interrupts:Enable VFIO IOMMU support for on platforms without interrupt remapping support. (bool)</code></pre></div><p>in your vfio_iommu_type1 module. Am i right that it does the same thing, but for pci-assign? Or it enables interrupt remapping system-wide, regardless of method used?<br />Oh, and also,append a fix of that copy-paste &quot;for on platforms&quot; typo to your TODO list;)</p></div></blockquote></div><p>Right, those are equivalent options, one for pci-assign and one for vfio-pci.&#160; Neither do anything to enable interrupt remapping, they just allow use of the driver without interrupt remapping enabled.</p> </div> <div class="postsignature postmsg"><hr /><p><a href="http://vfio.blogspot.com" rel="nofollow">http://vfio.blogspot.com</a><br />Looking for a more open forum to discuss vfio related uses?&#160; Try <a href="https://www.redhat.com/mailman/listinfo/vfio-users" rel="nofollow">https://www.redhat.com/mailman/listinfo/vfio-users</a></p></div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1473470">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1473506" class="blockpost rowodd"> <h2><span><span class="conr">#3175</span> <a href="viewtopic.php?pid=1473506#p1473506">2014-11-07 18:20:42</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=85314">Duelist</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2014-09-22</span></dd> <dd><span>Posts: 358</span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>aw wrote:</cite><blockquote><div><p>Right, those are equivalent options, one for pci-assign and one for vfio-pci.&#160; Neither do anything to enable interrupt remapping, they just allow use of the driver without interrupt remapping enabled.</p></div></blockquote></div><p>But how does it works without interrupt remapping then? Using the emulated, kvm vcpu&#039;s PIC? Or something?</p> </div> <div class="postsignature postmsg"><hr /><p><span class="bbs">The forum rules prohibit requesting support for distributions other than arch.</span><br /><a href="https://bbs.archlinux.org/viewtopic.php?pid=1551460#p1551460" rel="nofollow">I gave up.</a><a href="https://bbs.archlinux.org/viewtopic.php?id=162768" rel="nofollow"> It was too late.</a><br /><a href="http://pastebin.com/B3fL84bq" rel="nofollow">What I was trying to do</a>.<br /><a href="http://vfio.blogspot.com/" rel="nofollow">The reference about VFIO and KVM VGA passthrough.</a></p></div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1473506">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div class="postlinksb"> <div class="inbox crumbsplus"> <div class="pagepost"> <p class="pagelink conl"><span class="pages-label">Pages: </span><a rel="prev" class="item1" href="viewtopic.php?id=162768&amp;p=126">Previous</a> <a href="viewtopic.php?id=162768">1</a> <span class="spacer">…</span> <a href="viewtopic.php?id=162768&amp;p=125">125</a> <a href="viewtopic.php?id=162768&amp;p=126">126</a> <strong>127</strong> <a href="viewtopic.php?id=162768&amp;p=128">128</a> <a href="viewtopic.php?id=162768&amp;p=129">129</a> <span class="spacer">…</span> <a href="viewtopic.php?id=162768&amp;p=234">234</a> <a rel="next" href="viewtopic.php?id=162768&amp;p=128">Next</a></p> <p class="postlink conr">Topic closed</p> </div> <ul class="crumbs"> <li><a href="index.php">Index</a></li> <li><span>»&#160;</span><a href="viewforum.php?id=48">Topics Going Nowhere</a></li> <li><span>»&#160;</span><strong><a href="viewtopic.php?id=162768">KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</a></strong></li> </ul> <p class="subscribelink clearb"><a href="misc.php?action=subscribe&amp;tid=162768">Subscribe to this topic</a></p> <div class="clearer"></div> </div> </div> </div> <div id="brdfooter" class="block"> <h2><span>Board footer</span></h2> <div class="box"> <div id="brdfooternav" class="inbox"> <div class="conl"> <form id="qjump" method="get" action="viewforum.php"> <div><label><span>Jump to<br /></span> <select name="id" onchange="window.location=('viewforum.php?id='+this.options[this.selectedIndex].value)"> <optgroup label="Technical Issues and Assistance"> <option value="23">Newbie Corner</option> <option value="17">Installation</option> <option value="22">Kernel &amp; Hardware</option> <option value="18">Applications &amp; Desktop Environments</option> <option value="31">Laptop Issues</option> <option value="8">Networking, Server, and Protection</option> <option value="32">Multimedia and Games</option> <option value="50">System Administration</option> <option value="35">Other Architectures</option> </optgroup> <optgroup label="Arch-centric"> <option value="24">Announcements, Package &amp; Security Advisories</option> <option value="1">Arch Discussion</option> <option value="13">Forum &amp; Wiki discussion</option> </optgroup> <optgroup label="Pacman Upgrades, Packaging &amp; AUR"> <option value="44">Pacman &amp; Package Upgrade Issues</option> <option value="49">[testing] Repo Forum</option> <option value="4">Creating &amp; Modifying Packages</option> <option value="38">AUR Issues, Discussion &amp; PKGBUILD Requests</option> </optgroup> <optgroup label="Contributions &amp; Discussion"> <option value="20">GNU/Linux Discussion</option> <option value="27">Community Contributions</option> <option value="33">Programming &amp; Scripting</option> <option value="30">Other Languages</option> <option value="47">Artwork and Screenshots</option> <option value="42">Try This</option> </optgroup> <optgroup label="/dev/null"> <option value="29">Off-Topic</option> <option value="48" selected="selected">Topics Going Nowhere</option> <option value="36">Dustbin</option> </optgroup> </select></label> <input type="submit" value=" Go " accesskey="g" /> </div> </form> </div> <div class="conr"> <p id="feedlinks"><span class="atom"><a href="extern.php?action=feed&amp;tid=162768&amp;type=atom">Atom topic feed</a></span></p> <p id="poweredby">Powered by <a href="http://fluxbb.org/">FluxBB</a></p> </div> <div class="clearer"></div> </div> </div> </div> </div> <div class="end-box"></div> </div> </body> </html>
