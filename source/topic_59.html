<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"> <html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en" dir="ltr"> <head> <meta http-equiv="Content-Type" content="text/html; charset=utf-8" /> <title>KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9 (Page 59) / Topics Going Nowhere / Arch Linux Forums</title> <link rel="stylesheet" type="text/css" href="style/ArchLinux.css" /> <link rel="canonical" href="viewtopic.php?id=162768&amp;p=59" title="Page 59" /> <link rel="prev" href="viewtopic.php?id=162768&amp;p=58" title="Page 58" /> <link rel="next" href="viewtopic.php?id=162768&amp;p=60" title="Page 60" /> <link rel="alternate" type="application/atom+xml" href="extern.php?action=feed&amp;tid=162768&amp;type=atom" title="Atom topic feed" /> <link rel="stylesheet" media="screen" href="style/ArchLinux/arch.css?v=3" /> <link rel="stylesheet" media="screen" href="style/ArchLinux/archnavbar.css?v=2" /> <link rel="shortcut icon" href="style/ArchLinux/favicon.ico" /> </head> <body> <div id="archnavbar" class="anb-forum"> <div id="archnavbarlogo"><h1><a href="http://www.archlinux.org/">Arch Linux</a></h1></div> <div id="archnavbarmenu"> <ul id="archnavbarlist"> <li id="anb-home"><a href="http://www.archlinux.org/">Home</a></li><li id="anb-packages"><a href="http://www.archlinux.org/packages/">Packages</a></li><li id="anb-forums" class="anb-selected"><a href="https://bbs.archlinux.org/">Forums</a></li><li id="anb-wiki"><a href="https://wiki.archlinux.org/">Wiki</a></li><li id="anb-bugs"><a href="https://bugs.archlinux.org/">Bugs</a></li><li id="anb-aur"><a href="https://aur.archlinux.org/">AUR</a></li><li id="anb-download"><a href="http://www.archlinux.org/download/">Download</a></li> </ul> </div> </div> <div id="punviewtopic" class="pun"> <div class="top-box"></div> <div class="punwrap"> <div id="brdheader" class="block"> <div class="box"> <div id="brdmenu" class="inbox"> <ul> <li id="navindex" class="isactive"><a href="index.php">Index</a></li> <li id="navuserlist"><a href="userlist.php">User list</a></li> <li id="navsearch"><a href="search.php">Search</a></li> <li id="navprofile"><a href="profile.php?id=80749">Profile</a></li> <li id="navlogout"><a href="login.php?action=out&amp;id=80749&amp;csrf_token=5c20501ec397bb45ef8ee8c84db232c8d8e421c6">Logout</a></li> </ul> </div> <div id="brdwelcome" class="inbox"> <ul class="conl"> <li><span>Logged in as <strong>SXX</strong></span></li> <li><span>Last visit: 2015-08-16 12:20:09</span></li> </ul> <ul class="conr"> <li><span>Topics: <a href="search.php?action=show_replies" title="Find topics you have posted to.">Posted</a> | <a href="search.php?action=show_new" title="Find topics with new posts since your last visit.">New</a> | <a href="search.php?action=show_recent" title="Find topics with recent posts.">Active</a> | <a href="search.php?action=show_unanswered" title="Find topics with no replies.">Unanswered</a></span></li> </ul> <div class="clearer"></div> </div> </div> </div> <div id="brdmain"> <div class="linkst"> <div class="inbox crumbsplus"> <ul class="crumbs"> <li><a href="index.php">Index</a></li> <li><span>»&#160;</span><a href="viewforum.php?id=48">Topics Going Nowhere</a></li> <li><span>»&#160;</span><strong><a href="viewtopic.php?id=162768">KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</a></strong></li> </ul> <div class="pagepost"> <p class="pagelink conl"><span class="pages-label">Pages: </span><a rel="prev" class="item1" href="viewtopic.php?id=162768&amp;p=58">Previous</a> <a href="viewtopic.php?id=162768">1</a> <span class="spacer">…</span> <a href="viewtopic.php?id=162768&amp;p=57">57</a> <a href="viewtopic.php?id=162768&amp;p=58">58</a> <strong>59</strong> <a href="viewtopic.php?id=162768&amp;p=60">60</a> <a href="viewtopic.php?id=162768&amp;p=61">61</a> <span class="spacer">…</span> <a href="viewtopic.php?id=162768&amp;p=234">234</a> <a rel="next" href="viewtopic.php?id=162768&amp;p=60">Next</a></p> <p class="postlink conr">Topic closed</p> </div> <div class="clearer"></div> </div> </div> <div id="p1397891" class="blockpost rowodd blockpost1"> <h2><span><span class="conr">#1451</span> <a href="viewtopic.php?pid=1397891#p1397891">2014-03-28 17:18:36</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=48315">TripleSpeeder</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2011-05-02</span></dd> <dd><span>Posts: 43</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=48315">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>TripleSpeeder wrote:</cite><blockquote><div><p>Okay, I am out of ideas now. I got everything running perfectly when starting qemu manual. Now i want to move to a libvirt xml file, so i can start/stop/manage my VMs with virtmanager. But no matter what I do, i don&#039;t get the card passed through.<br />Here is a minimal xml config to reproduce:</p><p>When starting this instance e.g. through &quot;virsh start win7&quot; i get the following error:</p><div class="quotebox"><blockquote><div><p># virsh start win7<br />error: Failed to start domain win7<br />error: internal error: early end of file from monitor: possible problem:<br />qemu-system-x86_64: -device vfio-pci,host=01:00.0,bus=root.1,addr=00.0,multifunction=on,x-vga=on: vfio: error opening /dev/vfio/13: Operation not permitted<br />qemu-system-x86_64: -device vfio-pci,host=01:00.0,bus=root.1,addr=00.0,multifunction=on,x-vga=on: vfio: failed to get group 13<br />qemu-system-x86_64: -device vfio-pci,host=01:00.0,bus=root.1,addr=00.0,multifunction=on,x-vga=on: Device initialization failed.<br />qemu-system-x86_64: -device vfio-pci,host=01:00.0,bus=root.1,addr=00.0,multifunction=on,x-vga=on: Device &#039;vfio-pci&#039; could not be initialized</p></div></blockquote></div><p>What I did:</p><ul><li><p>Make sure that AMD-card is assigned to vfio</p></li><li><p>Edit /etc/libvirt/qemu.conf and set user/group qemu runs as to &quot;root&quot;</p></li><li><p>Getting desperate: chmod a+rw /dev/vfio/13</p></li></ul><p>But no luck. Everytime the same error :-(</p><p>Does anyone have a clue what I am missing? As I said, when I launch qemu manually (as root) everything works fine...</p></div></blockquote></div><p>Problem solved!</p><p>I missed one part of the virt-manager configuration to fix the permissions issue: You need to edit /etc/libvirt/qemu.conf and explicitly allow access to the /dev/vfio/&lt;group&gt;:</p><div class="codebox"><pre><code>... cgroup_device_acl = [ &quot;/dev/null&quot;, &quot;/dev/full&quot;, &quot;/dev/zero&quot;, &quot;/dev/random&quot;, &quot;/dev/urandom&quot;, &quot;/dev/ptmx&quot;, &quot;/dev/kvm&quot;, &quot;/dev/kqemu&quot;, &quot;/dev/rtc&quot;,&quot;/dev/hpet&quot;, &quot;/dev/vfio/vfio&quot;, &quot;dev/vfio/3&quot;, &quot;dev/vfio/13&quot;, &quot;dev/vfio/16&quot;, ] ...</code></pre></div><p>As you can see I added three groups that i am passing through.</p><p>With this change I everything was fine and I can now happily start/stop/restart etc. my VM through virt-manager. By the way, there is a tool included with libvirt that supports you with converting a qemu-command-line to xml config: <a href="http://libvirt.org/drvqemu.html#xmlimport" rel="nofollow">virsh domxml-from-native</a>. It even takes care of adding the extra namespace to the config file to support the quemu-commandline directive. I had to remove one or two items from my commandline to get it running, but still it was a great help.</p><p>Another big hurdle was getting sound via pulseaudio to work. As a vm started by virt-manager is not aware of the current login session it has no access to your normal pulseaudio instance. In order to get this working you need to have pulseaudio running in system mode. Note that this is in general considered a security risk and not recomended, however it is the only way (to my knowledege) to get the pulseaudio integration to work.<br />You need to do the following steps:</p><ul><li><p>Create a user &quot;pulse&quot; with homedir &quot;/var/run/pulse&quot;</p></li><li><p>Create a group &quot;pulse&quot;, add user pulse to this group</p></li><li><p>Add user pulse to group &quot;audio&quot; so it is allowed to access the audio hardware</p></li></ul><p>Now you can already try to start pulseaudio in system mode (make sure to stop any running pulseaudio instance from your login session). As root, type:</p><div class="codebox"><pre><code># pulseaudio --system -v</code></pre></div><p>If you see some error about problems connecting to DBus: Check <a href="https://bbs.archlinux.org/viewtopic.php?pid=563481#p563481" rel="nofollow">https://bbs.archlinux.org/viewtopic.php … 81#p563481</a></p><p>Now you should already be able to startup your vm and the sound should work. If everything is working you can create a systemd service to start pulseaudio on boot in system mode:</p><div class="codebox"><pre><code># systemd service spec for pulseaudio running in system mode -- not recommended though! # on arch, put it under /etc/systemd/system/pulseaudio.service # start with: systemctl start pulseaudio.service # enable on boot: systemctl enable pulseaudio.service [Unit] Description=Pulseaudio sound server After=avahi-daemon.service network.target [Service] ExecStart=/usr/bin/pulseaudio --system --disallow-exit --disallow-module-loading ExecReload=/bin/kill -HUP $MAINPID [Install] WantedBy=multi-user.target</code></pre></div><p>(Source: <a href="https://gist.github.com/awidegreen/6003640)" rel="nofollow">https://gist.github.com/awidegreen/6003640)</a></p><p>And finally you need to prevent autostarting a pulseaudio instance at login. I achieved this by removing /etc/xdg/autostart/pulseaudio-kde.desktop.</p><p>My current config:</p><div class="codebox"><pre class="vscroll"><code># virsh dumpxml windows &lt;domain type=&#039;kvm&#039; xmlns:qemu=&#039;http://libvirt.org/schemas/domain/qemu/1.0&#039;&gt; &lt;name&gt;windows&lt;/name&gt; &lt;uuid&gt;f702c5eb-83d4-4b50-b909-8da878e08d36&lt;/uuid&gt; &lt;memory unit=&#039;KiB&#039;&gt;8290304&lt;/memory&gt; &lt;currentMemory unit=&#039;KiB&#039;&gt;4145152&lt;/currentMemory&gt; &lt;vcpu placement=&#039;static&#039;&gt;6&lt;/vcpu&gt; &lt;os&gt; &lt;type arch=&#039;x86_64&#039; machine=&#039;pc-q35-2.0&#039;&gt;hvm&lt;/type&gt; &lt;loader&gt;/usr/share/qemu/bios.bin&lt;/loader&gt; &lt;boot dev=&#039;hd&#039;/&gt; &lt;bootmenu enable=&#039;no&#039;/&gt; &lt;/os&gt; &lt;features&gt; &lt;acpi/&gt; &lt;/features&gt; &lt;cpu mode=&#039;custom&#039; match=&#039;exact&#039;&gt; &lt;model fallback=&#039;allow&#039;&gt;SandyBridge&lt;/model&gt; &lt;vendor&gt;Intel&lt;/vendor&gt; &lt;feature policy=&#039;require&#039; name=&#039;vme&#039;/&gt; &lt;feature policy=&#039;require&#039; name=&#039;dtes64&#039;/&gt; &lt;feature policy=&#039;require&#039; name=&#039;vmx&#039;/&gt; &lt;feature policy=&#039;require&#039; name=&#039;erms&#039;/&gt; &lt;feature policy=&#039;require&#039; name=&#039;xtpr&#039;/&gt; &lt;feature policy=&#039;require&#039; name=&#039;smep&#039;/&gt; &lt;feature policy=&#039;require&#039; name=&#039;pcid&#039;/&gt; &lt;feature policy=&#039;require&#039; name=&#039;est&#039;/&gt; &lt;feature policy=&#039;require&#039; name=&#039;monitor&#039;/&gt; &lt;feature policy=&#039;require&#039; name=&#039;smx&#039;/&gt; &lt;feature policy=&#039;require&#039; name=&#039;tm&#039;/&gt; &lt;feature policy=&#039;require&#039; name=&#039;acpi&#039;/&gt; &lt;feature policy=&#039;require&#039; name=&#039;osxsave&#039;/&gt; &lt;feature policy=&#039;require&#039; name=&#039;ht&#039;/&gt; &lt;feature policy=&#039;require&#039; name=&#039;pdcm&#039;/&gt; &lt;feature policy=&#039;require&#039; name=&#039;fsgsbase&#039;/&gt; &lt;feature policy=&#039;require&#039; name=&#039;f16c&#039;/&gt; &lt;feature policy=&#039;require&#039; name=&#039;ds&#039;/&gt; &lt;feature policy=&#039;require&#039; name=&#039;tm2&#039;/&gt; &lt;feature policy=&#039;require&#039; name=&#039;ss&#039;/&gt; &lt;feature policy=&#039;require&#039; name=&#039;pbe&#039;/&gt; &lt;feature policy=&#039;require&#039; name=&#039;ds_cpl&#039;/&gt; &lt;feature policy=&#039;require&#039; name=&#039;rdrand&#039;/&gt; &lt;/cpu&gt; &lt;clock offset=&#039;localtime&#039;/&gt; &lt;on_poweroff&gt;destroy&lt;/on_poweroff&gt; &lt;on_reboot&gt;restart&lt;/on_reboot&gt; &lt;on_crash&gt;destroy&lt;/on_crash&gt; &lt;devices&gt; &lt;emulator&gt;/usr/bin/qemu-system-x86_64&lt;/emulator&gt; &lt;disk type=&#039;block&#039; device=&#039;disk&#039;&gt; &lt;driver name=&#039;qemu&#039; type=&#039;raw&#039;/&gt; &lt;source dev=&#039;/dev/sdc&#039;/&gt; &lt;target dev=&#039;vda&#039; bus=&#039;virtio&#039;/&gt; &lt;address type=&#039;pci&#039; domain=&#039;0x0000&#039; bus=&#039;0x02&#039; slot=&#039;0x01&#039; function=&#039;0x0&#039;/&gt; &lt;/disk&gt; &lt;disk type=&#039;file&#039; device=&#039;cdrom&#039;&gt; &lt;driver name=&#039;qemu&#039; type=&#039;raw&#039;/&gt; &lt;source file=&#039;/home/michael/hdd/isos/virtio-win-0.1-74.iso&#039;/&gt; &lt;target dev=&#039;hda&#039; bus=&#039;ide&#039;/&gt; &lt;readonly/&gt; &lt;address type=&#039;drive&#039; controller=&#039;0&#039; bus=&#039;0&#039; target=&#039;0&#039; unit=&#039;0&#039;/&gt; &lt;/disk&gt; &lt;controller type=&#039;sata&#039; index=&#039;0&#039;&gt; &lt;address type=&#039;pci&#039; domain=&#039;0x0000&#039; bus=&#039;0x00&#039; slot=&#039;0x1f&#039; function=&#039;0x2&#039;/&gt; &lt;/controller&gt; &lt;controller type=&#039;pci&#039; index=&#039;0&#039; model=&#039;pcie-root&#039;/&gt; &lt;controller type=&#039;pci&#039; index=&#039;1&#039; model=&#039;dmi-to-pci-bridge&#039;&gt; &lt;address type=&#039;pci&#039; domain=&#039;0x0000&#039; bus=&#039;0x00&#039; slot=&#039;0x1e&#039; function=&#039;0x0&#039;/&gt; &lt;/controller&gt; &lt;controller type=&#039;pci&#039; index=&#039;2&#039; model=&#039;pci-bridge&#039;&gt; &lt;address type=&#039;pci&#039; domain=&#039;0x0000&#039; bus=&#039;0x01&#039; slot=&#039;0x01&#039; function=&#039;0x0&#039;/&gt; &lt;/controller&gt; &lt;controller type=&#039;ide&#039; index=&#039;0&#039;/&gt; &lt;interface type=&#039;bridge&#039;&gt; &lt;mac address=&#039;52:54:00:29:ae:89&#039;/&gt; &lt;source bridge=&#039;xenbr0&#039;/&gt; &lt;model type=&#039;virtio&#039;/&gt; &lt;address type=&#039;pci&#039; domain=&#039;0x0000&#039; bus=&#039;0x02&#039; slot=&#039;0x03&#039; function=&#039;0x0&#039;/&gt; &lt;/interface&gt; &lt;memballoon model=&#039;virtio&#039;&gt; &lt;address type=&#039;pci&#039; domain=&#039;0x0000&#039; bus=&#039;0x02&#039; slot=&#039;0x02&#039; function=&#039;0x0&#039;/&gt; &lt;/memballoon&gt; &lt;/devices&gt; &lt;qemu:commandline&gt; &lt;qemu:arg value=&#039;-device&#039;/&gt; &lt;qemu:arg value=&#039;ioh3420,bus=pcie.0,addr=1c.0,multifunction=on,port=1,chassis=1,id=root.1&#039;/&gt; &lt;qemu:arg value=&#039;-device&#039;/&gt; &lt;qemu:arg value=&#039;ich9-intel-hda,bus=pcie.0,addr=1b.0,id=sound0&#039;/&gt; &lt;qemu:arg value=&#039;-device&#039;/&gt; &lt;qemu:arg value=&#039;hda-duplex,id=sound0-codec0,bus=sound0.0,cad=0&#039;/&gt; &lt;qemu:arg value=&#039;-device&#039;/&gt; &lt;qemu:arg value=&#039;vfio-pci,host=00:1a.0,bus=pcie.0&#039;/&gt; &lt;qemu:arg value=&#039;-device&#039;/&gt; &lt;qemu:arg value=&#039;vfio-pci,host=04:00.0,bus=pcie.0&#039;/&gt; &lt;qemu:arg value=&#039;-device&#039;/&gt; &lt;qemu:arg value=&#039;vfio-pci,host=01:00.0,bus=root.1,addr=00.0,multifunction=on,x-vga=on&#039;/&gt; &lt;qemu:env name=&#039;QEMU_AUDIO_DRV&#039; value=&#039;pa&#039;/&gt; &lt;/qemu:commandline&gt; &lt;/domain&gt;</code></pre></div><p>Everything is working perfectly, I can restart the VM as often as I like, played several hours iRacing with framerates in the range of 180-220 FPS (full HD with max quality) and shortly tried several other games which all seem to run fine with top performance. Also for the sound there is no noticeable delay using pulseaudio.</p><p>I finally deleted my windows partition and removed all dualboot settings from grub :-)</p><p>Only thing to keep in mind is you need to manually set up the vfio groups before trying to start the VM. But somewhere in this thread there was already information how to set this up to happen automatically at boot time, so this should also be solvable <img src="https://bbs.archlinux.org/img/smilies/smile.png" width="15" height="15" alt="smile" /></p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1397891">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1398329" class="blockpost roweven"> <h2><span><span class="conr">#1452</span> <a href="viewtopic.php?pid=1398329#p1398329">2014-03-29 23:26:19</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=80701">apex8</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2014-03-29</span></dd> <dd><span>Posts: 47</span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <p>Hi together,<br />I`m trying to setup a Windows 7 guest and was following this thread. I successfully created a q35 guest with kvm enabled using </p><div class="codebox"><pre><code>-vga std \ -mem-path /dev/hugepages \ -m 4096 -device ioh3420,bus=pcie.0,addr=1c.0,multifunction=on,port=1,chassis=1,id=root.1 \ -device vfio-pci,host=01:00.0,bus=root.1,addr=00.0,multifunction=on,x-vga=on \ -device vfio-pci,host=01:00.1,bus=root.1,addr=00.1 \</code></pre></div><p>When I finished the initial guest setup, which included installing nvidia drivers for my GTX 760, I tried to switch to </p><div class="codebox"><pre><code>-vga none</code></pre></div><p>Doing so I can see the initial bios screen and the OS is starting to boot up. However during that, my mouse cursor gets laggy and after a couple of seconds the whole host crashes. I read that the nouveau module could cause such things, so that module is already blacklisted, which does not solve the problem. I`m using an Intel IGP as primary graphics device and the compiled the kernel, qemu and seabios from the packages provided here.</p><p>At the moment I`m out of ideas.<br />My current start script is:</p><div class="codebox"><pre><code>qemu-system-x86_64 \ -nodefaults \ -name win7 \ -enable-kvm \ -cpu host \ -smp 6,sockets=1,cores=6,threads=1 \ -machine type=q35,accel=kvm \ -m 4096 \ -mem-path /dev/hugepages \ -mem-prealloc \ -k de \ -bios /usr/share/qemu/bios.bin \ -vga none \ -drive if=none,file=drive/win_drive.img,id=vdisk1,cache=none,format=raw,aio=native \ -device virtio-blk,scsi=off,config-wce=off,drive=vdisk1,id=disk1 \ -boot order=c \ -rtc base=utc \ -device ioh3420,bus=pcie.0,addr=1c.0,multifunction=on,port=1,chassis=1,id=root.1 \ -device vfio-pci,host=01:00.0,bus=root.1,addr=00.0,multifunction=on,x-vga=on \ -device vfio-pci,host=01:00.1,bus=root.1,addr=00.1 \ -usb \ -device ich9-usb-uhci3,id=uhci \ -device usb-ehci,id=ihci \ -usbdevice tablet \</code></pre></div><p>Is there any way, how I could track down, what I may have forgotten to configure, or whats going wrong? Reading through the whole thread didn&#039;t help me so far. Its rather confusing, because there is so much information here.<br />Any hints would be helpful.<br />Thanks in advance<br />apex</p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1398329">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1398341" class="blockpost rowodd"> <h2><span><span class="conr">#1453</span> <a href="viewtopic.php?pid=1398341#p1398341">2014-03-29 23:55:31</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=80387">dwe11er</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2014-03-18</span></dd> <dd><span>Posts: 73</span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <p>What motherboard and CPU do you have? I&#039;ve got i7-4771, ASRock Z87E-ITX with Intel as host&#039;s graphics and GTX 760 for Windows 8.1 and it&#039;s working flawlessly.</p> <p class="postedit"><em>Last edited by dwe11er (2014-03-31 17:32:10)</em></p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1398341">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1398352" class="blockpost roweven"> <h2><span><span class="conr">#1454</span> <a href="viewtopic.php?pid=1398352#p1398352">2014-03-30 00:45:19</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=34045">etcet</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2010-02-15</span></dd> <dd><span>Posts: 3</span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <p>Thanks to nbhs and everyone else involved in this thread, I&#039;ve got VGA passthrough working using this guide with the following setup:</p><p>Intel 4770<br />Asus Z87-Plus<br />Gigabyte &quot;Windforce&quot; GTX 770 GV-N770OC-2GD</p><p>I&#039;m starting X with the onboard Intel GPU and getting near native Windows performance on a passthroughed 770.</p><p>For others and my future self, here are the steps involved. I think this is everything:</p><p>Install qemu-git<br />Install seabios-git</p><p>The i915 kernel patch is required. I couldn&#039;t get the provided mainline kernel to work. I built the latest kernel and added the i915 patch with the following:</p><div class="codebox"><pre><code>pacman -S abs base-devel ABSROOT=. abs core/linux cd core/linux/ wget https://gist.githubusercontent.com/anonymous/732acf9551136a78e91b/raw/5b97d50e7fb7faced258ad8948b7a82127d25f31/i915_313rc4.patch wget https://gist.githubusercontent.com/etcet/9864922/raw/e49d204ddaf2d6130c91d94d0ce6a9123c6197cb/i915-pkgbuild.patch patch -p3 &lt; i915-pkgbuild.patch makepkg pacman -U linux-i915-headers-3.13.7-1-x86_64.pkg.tar.xz pacman -U linux-i915-3.13.7-1-x86_64.pkg.tar.xz</code></pre></div><p>More: <a href="https://wiki.archlinux.org/index.php/Kernels/Compilation/Arch_Build_System" rel="nofollow">https://wiki.archlinux.org/index.php/Ke … ild_System</a></p><p>Get PCI stub ids for passthrough devices:</p><div class="codebox"><pre><code>[chris@archserver linux]$ lspci | grep VGA 00:02.0 VGA compatible controller: Intel Corporation Xeon E3-1200 v3/4th Gen Core Processor Integrated Graphics Controller (rev 06) 01:00.0 VGA compatible controller: NVIDIA Corporation GK104 [GeForce GTX 770] (rev a1) [chris@archserver src]$ lspci -n | grep &quot;01:00.0&quot; 01:00.0 0300: 10de:1184 (rev a1)</code></pre></div><p>Add new kernel to grub, /etc/grub.d/40_custom:</p><div class="codebox"><pre><code>menuentry &quot;Arch Linux i915 kernel w/ iommu&quot; { set gfxpayload=keep insmod ext2 echo &#039;Loading Arch Linux i915 kernel w/ iommu ...&#039; linux /boot/vmlinuz-linux-i915 root=UUID=f4af663b-5407-498c-b46d-d3e2b9b6bc64 rw intel_iommu=on pci-stub.ids=10de:1184 echo &#039;Loading Arch Linux i915 kernel w/ iommu initramfs ...&#039; initrd /boot/initramfs-linux-i915.img }</code></pre></div><p>Build grub conf:</p><div class="codebox"><pre><code>sudo grub-mkconfig -o /boot/grub/grub.cfg</code></pre></div><p>Miscellaneous:</p><div class="codebox"><pre><code>[chris@archserver src]$ cat /etc/modprobe.d/blacklist.conf blacklist nouveau [chris@archserver src]$ cat /etc/modprobe.d/vfio_iommu_type1.conf options vfio_iommu_type1 allow_unsafe_interrupts=1</code></pre></div><p>Simple xorg.conf for running host with onboard Intel GPU: <a href="https://gist.github.com/etcet/9865391" rel="nofollow">https://gist.github.com/etcet/9865391</a></p><p>Reboot into new kernel and take the oppurtunity to check/change BIOS settings:</p><div class="codebox"><pre><code>Advanced -- System Agent Configuration ---- Vt-d: Enabled ---- Graphics Configuration ------ Primary Display: iGPU</code></pre></div><p>Test it:</p><div class="codebox"><pre><code>sudo /usr/bin/vfio-bind 0000:01:00.0 sudo qemu-system-x86_64 -enable-kvm -M q35 -m 1024 -cpu host \ -smp 6,sockets=1,cores=6,threads=1 \ -bios /usr/share/qemu/bios.bin -vga none \ -device ioh3420,bus=pcie.0,addr=1c.0,multifunction=on,port=1,chassis=1,id=root.1 \ -device vfio-pci,host=01:00.0,bus=root.1,addr=00.0,multifunction=on,x-vga=on</code></pre></div> <p class="postedit"><em>Last edited by etcet (2014-03-30 00:46:12)</em></p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1398352">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1398415" class="blockpost rowodd"> <h2><span><span class="conr">#1455</span> <a href="viewtopic.php?pid=1398415#p1398415">2014-03-30 07:28:04</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=79893">jonascj</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2014-02-28</span></dd> <dd><span>Posts: 13</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=79893">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><blockquote><div><p><strong>Preparing the GPU so we can bind it to vfio</strong></p><p>For the next step we need to:</p><ol class="decimal"><li><p>Blacklist radeon or nouveau or nvidia or fglrx on /etc/modprobe.d/blacklist.conf </p><p>Example, blacklisting the opensource radeon module:</p><div class="codebox"><pre><code>echo &quot;blacklist radeon&quot; &gt;&gt; /etc/modprobe.d/blacklist.conf </code></pre></div></li><li><p>Use pci-stub</p><p>In my case since i have 2 radeon cards blacklisting the radeon module is not an option, so i use pci-stub.</p><p>NOTE: If pci-stub was built as a module, you&#039;ll need to modify /etc/mkinitcpio.conf and add pci-stub in the MODULES section, after that you need to update your initramfs like this.</p><div class="codebox"><pre><code>mkinitcpio -p linux-mainline</code></pre></div><p>lspci </p><div class="codebox"><pre><code>07:00.0 VGA compatible controller: Advanced Micro Devices, Inc. [AMD/ATI] Cayman PRO [Radeon HD 6950] &lt;-- radeon 6950 07:00.1 Audio device: Advanced Micro Devices, Inc. [AMD/ATI] Cayman/Antilles HDMI Audio [Radeon HD 6900 Series] &lt;-- radeon 6950 audio</code></pre></div><p>lspci -n</p><div class="codebox"><pre><code>07:00.0 0300: 1002:6719 &lt;-- radeon 6950 07:00.1 0403: 1002:aa80 &lt;-- radeon 6950 audio</code></pre></div><p>Now add this to your grub cfg file:</p><div class="codebox"><pre><code>pci-stub.ids=1002:6719,1002:aa80</code></pre></div><p>dmesg | grep pci-stub</p><div class="codebox"><pre><code>[ 2.096151] pci-stub: add 1002:6719 sub=FFFFFFFF:FFFFFFFF cls=00000000/00000000 [ 2.096160] pci-stub 0000:07:00.0: claimed by stub [ 2.096165] pci-stub: add 1002:AA80 sub=FFFFFFFF:FFFFFFFF cls=00000000/00000000 [ 2.096174] pci-stub 0000:07:00.1: claimed by stub [ 2.096178] pci-stub: add 1B21:1042 sub=FFFFFFFF:FFFFFFFF cls=00000000/00000000</code></pre></div></li></ol></div></blockquote></div><p>Hi all.</p><p>I am confused about whether I should do both 1 and 2, or only 1 if I am okay with blacklisting the Radeon module. </p><p>The wording &quot;For the next step we need to: 1)&#160; &#160; 2)&quot; and &quot;In my case since i have 2 radeon cards blacklisting the radeon module is not an option, so i use pci-stub.&quot; suggests it is an choice between the two, but I am not so sure. Everywhere I see people looking at the pci-stub grep&#039;s. So it seems everybody is doing pci-stub...</p><p>My hoped setup is with a single R9 280x (kernel calls it Radeon 79something) for the Windows guest and Intel built-in for Linux host. So as far as I can figure out I would be fine with black listing the radeon module.</p> <p class="postedit"><em>Last edited by jonascj (2014-03-30 07:36:00)</em></p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1398415">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1398429" class="blockpost roweven"> <h2><span><span class="conr">#1456</span> <a href="viewtopic.php?pid=1398429#p1398429">2014-03-30 07:59:38</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=80701">apex8</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2014-03-29</span></dd> <dd><span>Posts: 47</span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>dwe11er wrote:</cite><blockquote><div><p>What motherboard and CPU do you have? I&#039;ve got i7-4771, ASRock Z86E-ITX with Intel as host&#039;s graphics and GTX 760 for Windows 8.1 and it&#039;s working flawlessly.</p></div></blockquote></div><p>I`ve got an Core i7-3770 and an Asrock Z68 Pro3 Gen3<br />I`m booting with</p><div class="codebox"><pre><code>BOOT_IMAGE=/vmlinuz-linux-mainline root=UUID=0bf391df-8b9d-4a36-9961-9cc54bcd24cd rw intel_iommu=on hugepagesz=2MB hugepages=2100 pci-stub.ids=10de:1187,10de:0e0a,1102:0012,8086:1c2d</code></pre></div><p>binding the graphics adapter works without reporting any errors</p><p>EDIT</p><div class="codebox"><pre><code>dmesg | grep IOMMU ⏎ [ 0.000000] Intel-IOMMU: enabled [ 0.089982] dmar: IOMMU 0: reg_base_addr fed90000 ver 1:0 cap c0000020e60262 ecap f0101a [ 0.089986] dmar: IOMMU 1: reg_base_addr fed91000 ver 1:0 cap c9008020660262 ecap f0105a [ 0.090057] IOAPIC id 2 under DRHD base 0xfed91000 IOMMU 1 [ 0.470765] IOMMU 0 0xfed90000: using Queued invalidation [ 0.470766] IOMMU 1 0xfed91000: using Queued invalidation [ 0.470767] IOMMU: Setting RMRR: [ 0.470776] IOMMU: Setting identity map for device 0000:00:02.0 [0xbf800000 - 0xcf9fffff] [ 0.471865] IOMMU: Setting identity map for device 0000:00:1d.0 [0xbddcd000 - 0xbddf7fff] [ 0.471880] IOMMU: Setting identity map for device 0000:00:1a.0 [0xbddcd000 - 0xbddf7fff] [ 0.471889] IOMMU: Prepare 0-16MiB unity mapping for LPC [ 0.471894] IOMMU: Setting identity map for device 0000:00:1f.0 [0x0 - 0xffffff]</code></pre></div> <p class="postedit"><em>Last edited by apex8 (2014-03-30 08:07:56)</em></p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1398429">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1398502" class="blockpost rowodd"> <h2><span><span class="conr">#1457</span> <a href="viewtopic.php?pid=1398502#p1398502">2014-03-30 13:21:20</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=78143">Blind Tree Frog</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2013-12-31</span></dd> <dd><span>Posts: 27</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=78143">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>jonascj wrote:</cite><blockquote><div><p>Hi all.</p><p>I am confused about whether I should do both 1 and 2, or only 1 if I am okay with blacklisting the Radeon module. </p><p>The wording &quot;For the next step we need to: 1)&#160; &#160; 2)&quot; and &quot;In my case since i have 2 radeon cards blacklisting the radeon module is not an option, so i use pci-stub.&quot; suggests it is an choice between the two, but I am not so sure. Everywhere I see people looking at the pci-stub grep&#039;s. So it seems everybody is doing pci-stub...</p><p>My hoped setup is with a single R9 280x (kernel calls it Radeon 79something) for the Windows guest and Intel built-in for Linux host. So as far as I can figure out I would be fine with black listing the radeon module.</p></div></blockquote></div><p>If blacklisting works for you, then you only need to use step 1 and can skip step 2.</p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1398502">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1398620" class="blockpost roweven"> <h2><span><span class="conr">#1458</span> <a href="viewtopic.php?pid=1398620#p1398620">2014-03-30 19:01:43</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=80701">apex8</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2014-03-29</span></dd> <dd><span>Posts: 47</span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <p>I went through my qemu configuration and gave it a try with a whole new guest installation. I used the following script </p><div class="codebox"><pre><code>sudo qemu-system-x86_64 \ -nodefaults \ -name win7 \ -enable-kvm \ -machine type=q35,accel=kvm \ -m 4096 \ -mem-path /dev/hugepages \ -mem-prealloc \ -k de \ -cpu host \ -smp 6,sockets=1,cores=6,threads=1 \ -bios /usr/share/qemu/bios.bin \ -vga none \ -device ioh3420,bus=pcie.0,addr=1c.0,multifunction=on,port=1,chassis=1,id=root.1 \ -device vfio-pci,host=01:00.0,bus=root.1,addr=00.0,multifunction=on,x-vga=on \ -device vfio-pci,host=01:00.1,bus=root.1,addr=00.1 \ -drive if=none,file=drive/testdrive.img,id=vdisk1,cache=none,format=raw,aio=native \ -device virtio-blk,scsi=off,config-wce=off,drive=vdisk1,id=disk1 \ -boot order=c \ -drive file=drive/win_7_sp1.iso,id=winimg \ -device ide-cd,bus=ide.0,drive=winimg \ -drive file=drive/virtio_drv.iso,id=isocd \ -device ide-cd,bus=ide.1,drive=isocd \ -boot menu=on \ -usb -usbdevice tablet \ -spice port=5930,disable-ticketing \ -net nic -net bridge,br=kvmbr0 \</code></pre></div><p>So, from the very first moment I used my gtx760. The setup was totally fine, but once I installed the recent nvidia drivers I end up in host a crash during guest boot.<br />Any ideas what could be the problem? I read I shouldn&#039;t run qemu using sudo, but without it I get errors when starting qemu. Anyway, until the nvidia installation the guest runs fine.<br />So would compiling a newer qemu version a possible solution?</p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1398620">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1399291" class="blockpost rowodd"> <h2><span><span class="conr">#1459</span> <a href="viewtopic.php?pid=1399291#p1399291">2014-04-01 14:03:43</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=80749">SXX</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2014-03-31</span></dd> <dd><span>Posts: 15</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=80749">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <p>Hi everyone. Is there anybody who successfully configured VGA Passthough on ASRock Z87 Extreme6? Is it possible to leave integrated graphics for host and passthough discrete one into VM?</p><p>I&#039;m looking for motherboard where both discrete and integrated graphics would work so it&#039;s would be helpful if somebody give advice on mobo I should buy. There is person who using this mobo (<a href="https://bbs.archlinux.org/profile.php?id=73469" rel="nofollow">Evonat</a>), but he have no contact in profile so I decide to ask it on forums.</p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><strong>Online</strong></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1399291">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1399296" class="blockpost roweven"> <h2><span><span class="conr">#1460</span> <a href="viewtopic.php?pid=1399296#p1399296">2014-04-01 14:17:09</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=53953">andy123</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2011-11-04</span></dd> <dd><span>Posts: 169</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=53953">Email</a></span> <span class="website"><a href="http://ajs124.de" rel="nofollow">Website</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>SXX wrote:</cite><blockquote><div><p>Hi everyone. Is there anybody who successfully configured VGA Passthough on ASRock Z87 Extreme6? Is it possible to leave integrated graphics for host and passthough discrete one into VM?</p><p>I&#039;m looking for motherboard where both discrete and integrated graphics would work so it&#039;s would be helpful if somebody give advice on mobo I should buy. There is person who using this mobo (<a href="https://bbs.archlinux.org/profile.php?id=73469" rel="nofollow">Evonat</a>), but he have no contact in profile so I decide to ask it on forums.</p></div></blockquote></div><p>Here&#039;s a <a href="https://docs.google.com/spreadsheet/ccc?key=0Aryg5nO-kBebdFozaW9tUWdVd2VHM0lvck95TUlpMlE&amp;usp=drive_web#gid=0" rel="nofollow">list</a>. Seems like there are some people with that board on there.</p> </div> <div class="postsignature postmsg"><hr /><p>i&#039;m sorry for my poor english wirting skills…</p></div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1399296">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1399350" class="blockpost rowodd"> <h2><span><span class="conr">#1461</span> <a href="viewtopic.php?pid=1399350#p1399350">2014-04-01 16:42:26</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=80749">SXX</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2014-03-31</span></dd> <dd><span>Posts: 15</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=80749">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>andy123 wrote:</cite><blockquote><div><p>Here&#039;s a <a href="https://docs.google.com/spreadsheet/ccc?key=0Aryg5nO-kBebdFozaW9tUWdVd2VHM0lvck95TUlpMlE&amp;usp=drive_web#gid=0" rel="nofollow">list</a>. Seems like there are some people with that board on there.</p></div></blockquote></div><p>Thanks a lot for link, this one is really useful.</p><p>One more question. As I understand from reading forums at moment it&#039;s impossible to use PCIe device on host again it&#039;s assigned to guest even after guest shutdown. E.g you have to restart host to use GPU on host again. Is it hardware or software limitation? Is there any information about that?</p><p>Just want to understand what hardware I should get to avoid as many problems as possible.</p> <p class="postedit"><em>Last edited by SXX (2014-04-01 16:44:28)</em></p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><strong>Online</strong></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1399350">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1399359" class="blockpost roweven"> <h2><span><span class="conr">#1462</span> <a href="viewtopic.php?pid=1399359#p1399359">2014-04-01 17:02:50</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=53953">andy123</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2011-11-04</span></dd> <dd><span>Posts: 169</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=53953">Email</a></span> <span class="website"><a href="http://ajs124.de" rel="nofollow">Website</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>SXX wrote:</cite><blockquote><div><div class="quotebox"><cite>andy123 wrote:</cite><blockquote><div><p>Here&#039;s a <a href="https://docs.google.com/spreadsheet/ccc?key=0Aryg5nO-kBebdFozaW9tUWdVd2VHM0lvck95TUlpMlE&amp;usp=drive_web#gid=0" rel="nofollow">list</a>. Seems like there are some people with that board on there.</p></div></blockquote></div><p>Thanks a lot for link, this one is really useful.</p><p>One more question. As I understand from reading forums at moment it&#039;s impossible to use PCIe device on host again it&#039;s assigned to guest even after guest shutdown. E.g you have to restart host to use GPU on host again. Is it hardware or software limitation? Is there any information about that?</p><p>Just want to understand what hardware I should get to avoid as many problems as possible.</p></div></blockquote></div><p>Yeah, that list should probably linked to in the first post, if it isn&#039;t already.</p><p>Using devices without a host reboot, after shutdown of the guest works with PCI devices for me. I simply unbind the device from vfio-pci and &quot;assign&quot; it to another driver. (tested with my Marvell (SATA/IDE) and AMD USB controllers)</p><p>And by &quot;assign the device to another driver&quot; I mean something like this:</p><div class="codebox"><pre><code>cd /sys/bus/pci/drivers/vfio-pci echo 0000:02:00.0 &gt; unbind cd ../ahci echo 1b4b 91a0 &gt; new_id</code></pre></div><p>As for doing this with GPUs: I have no idea. Maybe some other people in this thread?</p><p>PS: I have no idea if any of this should be done the way I do it or if it&#039;s a good idea in any way, but it WORKSFORME™</p> </div> <div class="postsignature postmsg"><hr /><p>i&#039;m sorry for my poor english wirting skills…</p></div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1399359">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1399373" class="blockpost rowodd"> <h2><span><span class="conr">#1463</span> <a href="viewtopic.php?pid=1399373#p1399373">2014-04-01 17:27:17</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=80749">SXX</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2014-03-31</span></dd> <dd><span>Posts: 15</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=80749">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <p>Thanks for more information.</p><div class="quotebox"><cite>andy123 wrote:</cite><blockquote><div><p>As for doing this with GPUs: I have no idea. Maybe some other people in this thread?</p></div></blockquote></div><p>GPU was my main concern because I want to use discrete GPU on host (Radeon + DRI_PRIME) when guest is off.</p><p>After many hours of search in internet I suppose it&#039;s not possible at moment, but I wonder if this software or hardware limitation.</p> <p class="postedit"><em>Last edited by SXX (2014-04-01 17:28:03)</em></p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><strong>Online</strong></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1399373">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1399392" class="blockpost roweven"> <h2><span><span class="conr">#1464</span> <a href="viewtopic.php?pid=1399392#p1399392">2014-04-01 18:02:48</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=77842">Flyser</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2013-12-19</span></dd> <dd><span>Posts: 29</span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>SXX wrote:</cite><blockquote><div><p>GPU was my main concern because I want to use discrete GPU on host (Radeon + DRI_PRIME) when guest is off.</p><p>After many hours of search in internet I suppose it&#039;s not possible at moment, but I wonder if this software or hardware limitation.</p></div></blockquote></div><p>Actually it is possible. I do that on my system (dh87rl, haswell i7, nvidia gtx660). No idea if it works with amd gpus though.</p> <p class="postedit"><em>Last edited by Flyser (2014-04-01 18:02:59)</em></p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1399392">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1399393" class="blockpost rowodd"> <h2><span><span class="conr">#1465</span> <a href="viewtopic.php?pid=1399393#p1399393">2014-04-01 18:08:40</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=80749">SXX</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2014-03-31</span></dd> <dd><span>Posts: 15</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=80749">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>Flyser wrote:</cite><blockquote><div><p>Actually it is possible. I do that on my system (dh87rl, haswell i7, nvidia gtx660). No idea if it works with amd gpus though.</p></div></blockquote></div><p>Interesting... What driver you using on host for Nvidia? It&#039;s loading kernel module after GPU used in guest?</p> <p class="postedit"><em>Last edited by SXX (2014-04-01 18:12:18)</em></p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><strong>Online</strong></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1399393">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1399412" class="blockpost roweven"> <h2><span><span class="conr">#1466</span> <a href="viewtopic.php?pid=1399412#p1399412">2014-04-01 19:11:42</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=65027">blacky</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2012-10-26</span></dd> <dd><span>Posts: 10</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=65027">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>andy123 wrote:</cite><blockquote><div><div class="quotebox"><cite>SXX wrote:</cite><blockquote><div><p>Hi everyone. Is there anybody who successfully configured VGA Passthough on ASRock Z87 Extreme6? Is it possible to leave integrated graphics for host and passthough discrete one into VM?</p><p>I&#039;m looking for motherboard where both discrete and integrated graphics would work so it&#039;s would be helpful if somebody give advice on mobo I should buy. There is person who using this mobo (<a href="https://bbs.archlinux.org/profile.php?id=73469" rel="nofollow">Evonat</a>), but he have no contact in profile so I decide to ask it on forums.</p></div></blockquote></div><p>Here&#039;s a <a href="https://docs.google.com/spreadsheet/ccc?key=0Aryg5nO-kBebdFozaW9tUWdVd2VHM0lvck95TUlpMlE&amp;usp=drive_web#gid=0" rel="nofollow">list</a>. Seems like there are some people with that board on there.</p></div></blockquote></div><p>Heya, this list (and my entry on it) reminded me I wanted to tell you a funny story about my R290X. </p><p>The most important thing first: It’s working. Kinda.</p><p>First of all I see to have some bus reset issue because it’s only working after a reboot or stand-by. But what’s *really* astonishing is that it *only* works as long as the old HD4850 is present in the Arch host system and assigned to vfio-pci (IOMMU group), too. I tried it multiple times: Removing the HD4850 (including kernel boot parameters and vfio-pci.cfg) results in a BSoD of atikmpag.sys (I think). A similar problem occurs if I actually assign the HD4850 as *secondary* device to the VM; putting it as the *primary* device gives me a Error 43 for the 290X. The only way to make my 290X work properly is to have the HD4850 present on the host system and assigned to vfio-pci but not actually hand it to the VM.</p><p>Oh and I load the vbios image.</p><p>PS:</p><p>@SXX: Yes. </p><p>But you may hit some bumps on the road. E.g. I reverted to a specific git revision of qemu-git and libcacard multiple times already because newer versions cause weird graphic bugs on the host on launch (and on launch of the VM only).</p> <p class="postedit"><em>Last edited by blacky (2014-04-01 19:14:15)</em></p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1399412">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1399425" class="blockpost rowodd"> <h2><span><span class="conr">#1467</span> <a href="viewtopic.php?pid=1399425#p1399425">2014-04-01 19:37:14</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=77842">Flyser</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2013-12-19</span></dd> <dd><span>Posts: 29</span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>SXX wrote:</cite><blockquote><div><p>Interesting... What driver you using on host for Nvidia? It&#039;s loading kernel module after GPU used in guest?</p></div></blockquote></div><p>I am using the nvidia binary driver and haven&#039;t tried nouveau so far. As long as the device is no longer bound to vfio *and* I execute the following script after the actual qemu command, it loads fine:</p><div class="codebox"><pre><code>qemu-system-x86_64 -name bus-reset-only -enable-kvm -boot order=c,menu=off,reboot-timeout=0 -machine type=q35,accel=kvm -cpu host -smp 1 -m 32 -k de -vga none -display none -device ioh3420,bus=pcie.0,addr=1c.0,multifunction=on,port=1,chassis=1,id=root.1 -device vfio-pci,host=01:00.0,bus=root.1,addr=00.0,multifunction=on,x-vga=on -device vfio-pci,host=01:00.1,bus=root.1,addr=00.1 -net none -no-reboot</code></pre></div><p>This simply issues a bus reset (afaik).</p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1399425">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1399477" class="blockpost roweven"> <h2><span><span class="conr">#1468</span> <a href="viewtopic.php?pid=1399477#p1399477">2014-04-01 21:14:32</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=80749">SXX</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2014-03-31</span></dd> <dd><span>Posts: 15</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=80749">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>blacky wrote:</cite><blockquote><div><p>@SXX: Yes. </p><p>But you may hit some bumps on the road. E.g. I reverted to a specific git revision of qemu-git and libcacard multiple times already because newer versions cause weird graphic bugs on the host on launch (and on launch of the VM only).</p></div></blockquote></div><p>I think it&#039;s fine. Didn&#039;t you tried to return GPU to host and use it with fglrx?</p><div class="quotebox"><cite>Flyser wrote:</cite><blockquote><div><p>I am using the nvidia binary driver and haven&#039;t tried nouveau so far. As long as the device is no longer bound to vfio *and* I execute the following script after the actual qemu command, it loads fine</p></div></blockquote></div><p>Thanks for your answers. About two years ago I already tried to setup VGA passthough using XEN and in result I wasted money and time with no success so now I want to choose hardware carefully.</p><p>I&#039;ll have some hardware in few weeks and post here about results.</p> <p class="postedit"><em>Last edited by SXX (2014-04-01 21:15:54)</em></p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><strong>Online</strong></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1399477">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1399488" class="blockpost rowodd"> <h2><span><span class="conr">#1469</span> <a href="viewtopic.php?pid=1399488#p1399488">2014-04-01 21:38:04</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=65027">blacky</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2012-10-26</span></dd> <dd><span>Posts: 10</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=65027">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>SXX wrote:</cite><blockquote><div><div class="quotebox"><cite>blacky wrote:</cite><blockquote><div><p>@SXX: Yes. </p><p>But you may hit some bumps on the road. E.g. I reverted to a specific git revision of qemu-git and libcacard multiple times already because newer versions cause weird graphic bugs on the host on launch (and on launch of the VM only).</p></div></blockquote></div><p>I think it&#039;s fine. Didn&#039;t you tried to return GPU to host and use it with fglrx?</p></div></blockquote></div><p>I meant the Intel on-board graphic I use for the host system. I don’t use the dedicated GPU for the host system, also because I hope I can basically completely shut it down (and save power) unless the related VM is running. </p><div class="quotebox"><cite>Flyser wrote:</cite><blockquote><div><p>This simply issues a bus reset (afaik).</p></div></blockquote></div><p>Ahh … thanks, I was too lazy so far to look for this command in the thread. Maybe now I can start my VM without reboot / standby.</p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1399488">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1399560" class="blockpost roweven"> <h2><span><span class="conr">#1470</span> <a href="viewtopic.php?pid=1399560#p1399560">2014-04-02 00:57:37</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=80387">dwe11er</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2014-03-18</span></dd> <dd><span>Posts: 73</span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>andy123 wrote:</cite><blockquote><div><div class="quotebox"><cite>SXX wrote:</cite><blockquote><div><p>Hi everyone. Is there anybody who successfully configured VGA Passthough on ASRock Z87 Extreme6? Is it possible to leave integrated graphics for host and passthough discrete one into VM?</p><p>I&#039;m looking for motherboard where both discrete and integrated graphics would work so it&#039;s would be helpful if somebody give advice on mobo I should buy. There is person who using this mobo (<a href="https://bbs.archlinux.org/profile.php?id=73469" rel="nofollow">Evonat</a>), but he have no contact in profile so I decide to ask it on forums.</p></div></blockquote></div><p>Here&#039;s a <a href="https://docs.google.com/spreadsheet/ccc?key=0Aryg5nO-kBebdFozaW9tUWdVd2VHM0lvck95TUlpMlE&amp;usp=drive_web#gid=0" rel="nofollow">list</a>. Seems like there are some people with that board on there.</p></div></blockquote></div><p>AFAIK every ASRock mobo based on Z87 (H87 should have too) has VT-d support.</p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1399560">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1399590" class="blockpost rowodd"> <h2><span><span class="conr">#1471</span> <a href="viewtopic.php?pid=1399590#p1399590">2014-04-02 03:14:04</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=80806">lildigiman</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2014-04-02</span></dd> <dd><span>Posts: 3</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=80806">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <p>Hi everyone! Just today I finally got my Asrock Z77 Extreme4 to replace my P8Z77-V LK because I wanted IOMMU support.</p><p>I&#039;m reading back on an earlier <a href="https://bbs.archlinux.org/viewtopic.php?pid=1313007#p1313007" rel="nofollow">post</a> made by GizmoChicken who has successfully utilized VGA passthrough on a stock Ubuntu Kernel and stock qemu 1.5.</p><p>My setup:<br />Intel 3570 (non-k)<br />Asrock Z77 Extreme4<br />GTX 660 ti for Guest and iGPU for Host</p><p>Software (which should/could work according to the post linked above):<br />Ubuntu 13.10 (stock kernel + latest updates)<br />Qemu 1.5 from repositories</p><p>My problem occurs when I try to start the VM and get:</p><div class="quotebox"><blockquote><div><p>qemu-system-x86_64: -device vfio-pci,host=01:00.0,bus=root.1,addr=00.0,multifunction=on,x-vga=on: vfio: error no iommu_group for device<br />qemu-system-x86_64: -device vfio-pci,host=01:00.0,bus=root.1,addr=00.0,multifunction=on,x-vga=on: Device initialization failed.<br />qemu-system-x86_64: -device vfio-pci,host=01:00.0,bus=root.1,addr=00.0,multifunction=on,x-vga=on: Device &#039;vfio-pci&#039; could not be initialized</p></div></blockquote></div><p>Google searches for &quot;vfio: error no iommu_group for device&quot; hasn&#039;t brought me anywhere except one user&#039;s post that had never properly answered what this error suggests.</p><p>My dmesg | grep -e DMAR -e IOMMU seems to suggest that VT-d is properly enabled (I think):</p><div class="quotebox"><blockquote><div><p>[&#160; &#160; 0.000000] ACPI: DMAR 00000000bd969280 000B8 (v01 INTEL&#160; &#160; &#160; SNB&#160; 00000001 INTL 00000001)<br />[&#160; &#160; 0.086615] dmar: IOMMU 0: reg_base_addr fed90000 ver 1:0 cap c0000020e60262 ecap f0101a<br />[&#160; &#160; 0.086619] dmar: IOMMU 1: reg_base_addr fed91000 ver 1:0 cap c9008020660262 ecap f0105a<br />[&#160; &#160; 0.086690] IOAPIC id 2 under DRHD base&#160; 0xfed91000 IOMMU 1<br />[&#160; &#160;21.194509] vboxpci: IOMMU not found (not registered)</p></div></blockquote></div><p>I also added the following to /etc/modules</p><div class="quotebox"><blockquote><div><p>pci_stub<br />vfio<br />vfio_iommu_type1<br />vfio_pci<br />kvm<br />kvm_amd</p></div></blockquote></div><p>So basically my question is what can I do from here with that error? I&#039;m happy to provide more information if necessary.</p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1399590">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1399887" class="blockpost roweven"> <h2><span><span class="conr">#1472</span> <a href="viewtopic.php?pid=1399887#p1399887">2014-04-02 19:50:03</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=80830">gneville</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2014-04-02</span></dd> <dd><span>Posts: 27</span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <p>Hi All,</p><p>I&#039;m hoping someone will be able to help me out please. I&#039;ve been trying to get vga passthrough working with qemu and vfio for a few months on and off but having no luck. I&#039;m getting similar problems to users redger &amp; DanaGoyette.</p><p>My hardware: CPU: i7 4770s, MB: Jetway NF9J-Q87 GFX: AMD R9 290</p><p>I used to use Xen 4.3 and had vga passthrough working just passing through the intel hd4600 controller to hosts, but since I got the AMD R9 290 card Xen doesn&#039;t seem to passthrough the card whatsoever, so thought I would try qemu and vfio.</p><p>I&#039;ve tried using different linux versions and qemu versions but not having much luck. I am able to successfully vfio-bind my gfx card and I can start QEMU and get video via the GFX Card HDMI cable, I&#039;m also able to successfully install Windows 8.1. However after installation I&#039;m getting problems with either windows installing the amd drivers or using the catalyst driver installer, the host just reboots.</p><p>My latest setup:</p><p>linux 3.13.7-1 + i915 patch<br />Seabios git 1.7.4-66 (31Mar14)<br />Qemu 2.0.0 RC0 + patched pcibus_reset &amp; assertion (<a href="https://lists.nongnu.org/archive/html/qemu-devel/2014-03/msg05901.html" rel="nofollow">https://lists.nongnu.org/archive/html/q … 05901.html</a> &amp; <a href="https://lists.gnu.org/archive/html/qemu-devel/2014-02/msg00767.html" rel="nofollow">https://lists.gnu.org/archive/html/qemu … 00767.html</a>)</p><p>Before the pcibus_reset patch I kept getting the following messages when the host rebooted while trying to install the drivers:</p><div class="quotebox"><blockquote><div><p>&quot;qemu-system-x86_64 shows: hw/pci/pci.c:250: pcibus_reset: Assertion `bus-&gt;irq_count[\i] == 0&#039; failed.&quot;</p></div></blockquote></div><div class="quotebox"><blockquote><div><p>dmesg shows:&#160; 2805.839608 vfio-pci 0000:01:00.0: irq 46 for MSI/MSI-X</p></div></blockquote></div><br /><p>After applying the pcibust_reset patch the host no longer reboots after installing the drivers however the screen just goes blank so I have to manually kill the host. I do see the following messages:</p><div class="quotebox"><blockquote><div><p>qemu-system-x86_64 shows: ehci warning: guest updated active QH</p></div></blockquote></div><div class="quotebox"><blockquote><div><p>dmesg shows:&#160; 4681.189513 vfio-pci 0000:01:00.0: irq 46 for MSI/MSI-X</p></div></blockquote></div><p>This is my QEMU config:</p><div class="quotebox"><blockquote><div><p>/usr/local/qemu-2-0-0-rc0-patched-pci/bin/qemu-system-x86_64 -name win8 -enable-kvm -M q35 -m 6144&#160; \<br />-cpu Haswell,hv-time,hv_relaxed,hv_vapic,hv_spinlocks=0x1000 \<br />-boot order=dc \<br />-smp 2,sockets=1,cores=2,threads=1 \<br />-bios /root/vfio/bios.bin -vga none \<br />-usb -usbdevice tablet \<br />-spice port=5902,disable-ticketing \<br />-vnc 0.0.0.0:0 \<br />-device ioh3420,bus=pcie.0,addr=1c.0,multifunction=on,port=1,chassis=1,id=root.1 \<br />-device ahci,bus=pcie.0,id=ahci \<br />-net nic \<br />-net tap,ifname=tap0,script=no,downscript=no \<br />-device vfio-pci,host=01:00.0,bus=root.1,addr=00.0,multifunction=on,x-vga=on \<br />-device vfio-pci,host=01:00.1,bus=root.1,addr=00.1 \<br />-device vfio-pci,host=00:14.0,bus=pcie.0 \<br />-drive file=/dev/mapper/vg1-winv1,media=disk,index=1,id=disk,cache=none,if=virtio \<br />-drive file=/dev/mapper/vg1-winv1data,media=disk,index=2,id=diskb,cache=none,if=virtio \<br />-drive file=/home/xen/iso/windows/en-gb_windows_8_1_enterprise_x64_dvd_2971910.iso,boot=on,media=cdrom,index=3,id=isocd&#160; \<br />-device ide-cd,bus=ahci.1,drive=isocd \<br />-drive file=/root/virtio-win-0.1-74.iso,media=cdrom,index=4,id=virtio&#160; \<br />-device ide-cd,bus=ahci.2,drive=virtio</p></div></blockquote></div><p>If I enable &quot;-vga cirrus&quot; and VNC to the host I can install the AMD drivers successfully and after a reboot it shows in device manager the AMD card but with a yellow exclamation and code 43. If I then go back to &quot;-vga none&quot; windows no longer wants to boot and I need up in a boot loop (seabios&gt;windows booting&gt;seabios&gt;windows booting).</p><p>Any ideas please?</p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1399887">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1399893" class="blockpost rowodd"> <h2><span><span class="conr">#1473</span> <a href="viewtopic.php?pid=1399893#p1399893">2014-04-02 19:57:52</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=79991">mv0lnicky</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2014-03-05</span></dd> <dd><span>Posts: 16</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=79991">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>lildigiman wrote:</cite><blockquote><div><div class="quotebox"><blockquote><div><p>qemu-system-x86_64: -device vfio-pci,host=01:00.0,bus=root.1,addr=00.0,multifunction=on,x-vga=on: vfio: error no iommu_group for device<br />qemu-system-x86_64: -device vfio-pci,host=01:00.0,bus=root.1,addr=00.0,multifunction=on,x-vga=on: Device initialization failed.<br />qemu-system-x86_64: -device vfio-pci,host=01:00.0,bus=root.1,addr=00.0,multifunction=on,x-vga=on: Device &#039;vfio-pci&#039; could not be initialized</p></div></blockquote></div><p>Google searches for &quot;vfio: error no iommu_group for device&quot; hasn&#039;t brought me anywhere except one user&#039;s post that had never properly answered what this error suggests.</p><p>So basically my question is what can I do from here with that error? I&#039;m happy to provide more information if necessary.</p></div></blockquote></div><p>Check if your device is bound to vfio-pci.</p><div class="codebox"><pre><code>ls /sys/bus/pci/drivers/vfio-pci | grep 0000</code></pre></div> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1399893">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1399905" class="blockpost roweven"> <h2><span><span class="conr">#1474</span> <a href="viewtopic.php?pid=1399905#p1399905">2014-04-02 20:22:59</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=80806">lildigiman</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2014-04-02</span></dd> <dd><span>Posts: 3</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=80806">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>mv0lnicky wrote:</cite><blockquote><div><p>Check if your device is bound to vfio-pci.</p><div class="codebox"><pre><code>ls /sys/bus/pci/drivers/vfio-pci | grep 0000</code></pre></div></div></blockquote></div><p>Thanks for the response, mv0lnicky. The output is as follows:<br />0000:00:1d.0<br />0000:01:00.0<br />0000:01:00.1</p><p>Device 1d.0 is a USB 2.0 Controller where I have a keyboard and mouse connected.</p><p>I might also add that it appears that my Kernel was slightly older than I had thought, so I updated to 3.12.6-031206-generic.</p><p>When I now try to start the VM my error is no longer vfio: error no iommu_group for device, but this:</p><div class="quotebox"><blockquote><div><p>qemu-system-x86_64: -device vfio-pci,host=01:00.0,bus=root.1,addr=00.0,multifunction=on,x-vga=on: Warning, device 0000:01:00.0 does not support reset<br />qemu-system-x86_64: -device vfio-pci,host=01:00.1,bus=root.1,addr=00.1: Warning, device 0000:01:00.1 does not support reset</p></div></blockquote></div><p>A QEMU window then opens, but the VM stops instantly only outputting what is written above. The guest display (a third monitor) never displays anything anything at all.</p><p>On a side note (and maybe irrelevant?):<br />I also have display issues on the HOST when I try to start the VM (possibly compiz) causing my Host&#039;s secondary screen to display artifacts and inverted colors... not sure why or how this is happening. Note that this does not happen every time I try to start the VM, only maybe a third of the time.</p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1399905">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1399929" class="blockpost rowodd"> <h2><span><span class="conr">#1475</span> <a href="viewtopic.php?pid=1399929#p1399929">2014-04-02 21:33:55</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=80830">gneville</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2014-04-02</span></dd> <dd><span>Posts: 27</span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <p>On top of this I have just installed the OP linux-mainline (3.13.6-1-mainline),seabios (1.7.4.r1788.g8abc6a8-1) &amp; qemu (2.0.r31714.g03d5142-1) versions (Just added reset patch and manually compiled (<a href="https://lists.gnu.org/archive/html/qemu-devel/2014-02/msg00767.html)" rel="nofollow">https://lists.gnu.org/archive/html/qemu … 0767.html)</a>)</p><p>and still no change <img src="https://bbs.archlinux.org/img/smilies/sad.png" width="15" height="15" alt="sad" /></p><br /><br /><div class="quotebox"><cite>gneville wrote:</cite><blockquote><div><p>Hi All,</p><p>I&#039;m hoping someone will be able to help me out please. I&#039;ve been trying to get vga passthrough working with qemu and vfio for a few months on and off but having no luck. I&#039;m getting similar problems to users redger &amp; DanaGoyette.</p><p>My hardware: CPU: i7 4770s, MB: Jetway NF9J-Q87 GFX: AMD R9 290</p><p>I used to use Xen 4.3 and had vga passthrough working just passing through the intel hd4600 controller to hosts, but since I got the AMD R9 290 card Xen doesn&#039;t seem to passthrough the card whatsoever, so thought I would try qemu and vfio.</p><p>I&#039;ve tried using different linux versions and qemu versions but not having much luck. I am able to successfully vfio-bind my gfx card and I can start QEMU and get video via the GFX Card HDMI cable, I&#039;m also able to successfully install Windows 8.1. However after installation I&#039;m getting problems with either windows installing the amd drivers or using the catalyst driver installer, the host just reboots.</p><p>My latest setup:</p><p>linux 3.13.7-1 + i915 patch<br />Seabios git 1.7.4-66 (31Mar14)<br />Qemu 2.0.0 RC0 + patched pcibus_reset &amp; assertion (<a href="https://lists.nongnu.org/archive/html/qemu-devel/2014-03/msg05901.html" rel="nofollow">https://lists.nongnu.org/archive/html/q … 05901.html</a> &amp; <a href="https://lists.gnu.org/archive/html/qemu-devel/2014-02/msg00767.html" rel="nofollow">https://lists.gnu.org/archive/html/qemu … 00767.html</a>)</p><p>Before the pcibus_reset patch I kept getting the following messages when the host rebooted while trying to install the drivers:</p><div class="quotebox"><blockquote><div><p>&quot;qemu-system-x86_64 shows: hw/pci/pci.c:250: pcibus_reset: Assertion `bus-&gt;irq_count[\i] == 0&#039; failed.&quot;</p></div></blockquote></div><div class="quotebox"><blockquote><div><p>dmesg shows:&#160; 2805.839608 vfio-pci 0000:01:00.0: irq 46 for MSI/MSI-X</p></div></blockquote></div><br /><p>After applying the pcibust_reset patch the host no longer reboots after installing the drivers however the screen just goes blank so I have to manually kill the host. I do see the following messages:</p><div class="quotebox"><blockquote><div><p>qemu-system-x86_64 shows: ehci warning: guest updated active QH</p></div></blockquote></div><div class="quotebox"><blockquote><div><p>dmesg shows:&#160; 4681.189513 vfio-pci 0000:01:00.0: irq 46 for MSI/MSI-X</p></div></blockquote></div><p>This is my QEMU config:</p><div class="quotebox"><blockquote><div><p>/usr/local/qemu-2-0-0-rc0-patched-pci/bin/qemu-system-x86_64 -name win8 -enable-kvm -M q35 -m 6144&#160; \<br />-cpu Haswell,hv-time,hv_relaxed,hv_vapic,hv_spinlocks=0x1000 \<br />-boot order=dc \<br />-smp 2,sockets=1,cores=2,threads=1 \<br />-bios /root/vfio/bios.bin -vga none \<br />-usb -usbdevice tablet \<br />-spice port=5902,disable-ticketing \<br />-vnc 0.0.0.0:0 \<br />-device ioh3420,bus=pcie.0,addr=1c.0,multifunction=on,port=1,chassis=1,id=root.1 \<br />-device ahci,bus=pcie.0,id=ahci \<br />-net nic \<br />-net tap,ifname=tap0,script=no,downscript=no \<br />-device vfio-pci,host=01:00.0,bus=root.1,addr=00.0,multifunction=on,x-vga=on \<br />-device vfio-pci,host=01:00.1,bus=root.1,addr=00.1 \<br />-device vfio-pci,host=00:14.0,bus=pcie.0 \<br />-drive file=/dev/mapper/vg1-winv1,media=disk,index=1,id=disk,cache=none,if=virtio \<br />-drive file=/dev/mapper/vg1-winv1data,media=disk,index=2,id=diskb,cache=none,if=virtio \<br />-drive file=/home/xen/iso/windows/en-gb_windows_8_1_enterprise_x64_dvd_2971910.iso,boot=on,media=cdrom,index=3,id=isocd&#160; \<br />-device ide-cd,bus=ahci.1,drive=isocd \<br />-drive file=/root/virtio-win-0.1-74.iso,media=cdrom,index=4,id=virtio&#160; \<br />-device ide-cd,bus=ahci.2,drive=virtio</p></div></blockquote></div><p>If I enable &quot;-vga cirrus&quot; and VNC to the host I can install the AMD drivers successfully and after a reboot it shows in device manager the AMD card but with a yellow exclamation and code 43. If I then go back to &quot;-vga none&quot; windows no longer wants to boot and I need up in a boot loop (seabios&gt;windows booting&gt;seabios&gt;windows booting).</p><p>Any ideas please?</p></div></blockquote></div> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1399929">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div class="postlinksb"> <div class="inbox crumbsplus"> <div class="pagepost"> <p class="pagelink conl"><span class="pages-label">Pages: </span><a rel="prev" class="item1" href="viewtopic.php?id=162768&amp;p=58">Previous</a> <a href="viewtopic.php?id=162768">1</a> <span class="spacer">…</span> <a href="viewtopic.php?id=162768&amp;p=57">57</a> <a href="viewtopic.php?id=162768&amp;p=58">58</a> <strong>59</strong> <a href="viewtopic.php?id=162768&amp;p=60">60</a> <a href="viewtopic.php?id=162768&amp;p=61">61</a> <span class="spacer">…</span> <a href="viewtopic.php?id=162768&amp;p=234">234</a> <a rel="next" href="viewtopic.php?id=162768&amp;p=60">Next</a></p> <p class="postlink conr">Topic closed</p> </div> <ul class="crumbs"> <li><a href="index.php">Index</a></li> <li><span>»&#160;</span><a href="viewforum.php?id=48">Topics Going Nowhere</a></li> <li><span>»&#160;</span><strong><a href="viewtopic.php?id=162768">KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</a></strong></li> </ul> <p class="subscribelink clearb"><a href="misc.php?action=subscribe&amp;tid=162768">Subscribe to this topic</a></p> <div class="clearer"></div> </div> </div> </div> <div id="brdfooter" class="block"> <h2><span>Board footer</span></h2> <div class="box"> <div id="brdfooternav" class="inbox"> <div class="conl"> <form id="qjump" method="get" action="viewforum.php"> <div><label><span>Jump to<br /></span> <select name="id" onchange="window.location=('viewforum.php?id='+this.options[this.selectedIndex].value)"> <optgroup label="Technical Issues and Assistance"> <option value="23">Newbie Corner</option> <option value="17">Installation</option> <option value="22">Kernel &amp; Hardware</option> <option value="18">Applications &amp; Desktop Environments</option> <option value="31">Laptop Issues</option> <option value="8">Networking, Server, and Protection</option> <option value="32">Multimedia and Games</option> <option value="50">System Administration</option> <option value="35">Other Architectures</option> </optgroup> <optgroup label="Arch-centric"> <option value="24">Announcements, Package &amp; Security Advisories</option> <option value="1">Arch Discussion</option> <option value="13">Forum &amp; Wiki discussion</option> </optgroup> <optgroup label="Pacman Upgrades, Packaging &amp; AUR"> <option value="44">Pacman &amp; Package Upgrade Issues</option> <option value="49">[testing] Repo Forum</option> <option value="4">Creating &amp; Modifying Packages</option> <option value="38">AUR Issues, Discussion &amp; PKGBUILD Requests</option> </optgroup> <optgroup label="Contributions &amp; Discussion"> <option value="20">GNU/Linux Discussion</option> <option value="27">Community Contributions</option> <option value="33">Programming &amp; Scripting</option> <option value="30">Other Languages</option> <option value="47">Artwork and Screenshots</option> <option value="42">Try This</option> </optgroup> <optgroup label="/dev/null"> <option value="29">Off-Topic</option> <option value="48" selected="selected">Topics Going Nowhere</option> <option value="36">Dustbin</option> </optgroup> </select></label> <input type="submit" value=" Go " accesskey="g" /> </div> </form> </div> <div class="conr"> <p id="feedlinks"><span class="atom"><a href="extern.php?action=feed&amp;tid=162768&amp;type=atom">Atom topic feed</a></span></p> <p id="poweredby">Powered by <a href="http://fluxbb.org/">FluxBB</a></p> </div> <div class="clearer"></div> </div> </div> </div> </div> <div class="end-box"></div> </div> </body> </html>
