<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"> <html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en" dir="ltr"> <head> <meta http-equiv="Content-Type" content="text/html; charset=utf-8" /> <title>KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9 (Page 215) / Topics Going Nowhere / Arch Linux Forums</title> <link rel="stylesheet" type="text/css" href="style/ArchLinux.css" /> <link rel="canonical" href="viewtopic.php?id=162768&amp;p=215" title="Page 215" /> <link rel="prev" href="viewtopic.php?id=162768&amp;p=214" title="Page 214" /> <link rel="next" href="viewtopic.php?id=162768&amp;p=216" title="Page 216" /> <link rel="alternate" type="application/atom+xml" href="extern.php?action=feed&amp;tid=162768&amp;type=atom" title="Atom topic feed" /> <link rel="stylesheet" media="screen" href="style/ArchLinux/arch.css?v=3" /> <link rel="stylesheet" media="screen" href="style/ArchLinux/archnavbar.css?v=2" /> <link rel="shortcut icon" href="style/ArchLinux/favicon.ico" /> </head> <body> <div id="archnavbar" class="anb-forum"> <div id="archnavbarlogo"><h1><a href="http://www.archlinux.org/">Arch Linux</a></h1></div> <div id="archnavbarmenu"> <ul id="archnavbarlist"> <li id="anb-home"><a href="http://www.archlinux.org/">Home</a></li><li id="anb-packages"><a href="http://www.archlinux.org/packages/">Packages</a></li><li id="anb-forums" class="anb-selected"><a href="https://bbs.archlinux.org/">Forums</a></li><li id="anb-wiki"><a href="https://wiki.archlinux.org/">Wiki</a></li><li id="anb-bugs"><a href="https://bugs.archlinux.org/">Bugs</a></li><li id="anb-aur"><a href="https://aur.archlinux.org/">AUR</a></li><li id="anb-download"><a href="http://www.archlinux.org/download/">Download</a></li> </ul> </div> </div> <div id="punviewtopic" class="pun"> <div class="top-box"></div> <div class="punwrap"> <div id="brdheader" class="block"> <div class="box"> <div id="brdmenu" class="inbox"> <ul> <li id="navindex" class="isactive"><a href="index.php">Index</a></li> <li id="navuserlist"><a href="userlist.php">User list</a></li> <li id="navsearch"><a href="search.php">Search</a></li> <li id="navprofile"><a href="profile.php?id=80749">Profile</a></li> <li id="navlogout"><a href="login.php?action=out&amp;id=80749&amp;csrf_token=5c20501ec397bb45ef8ee8c84db232c8d8e421c6">Logout</a></li> </ul> </div> <div id="brdwelcome" class="inbox"> <ul class="conl"> <li><span>Logged in as <strong>SXX</strong></span></li> <li><span>Last visit: 2015-08-16 12:20:09</span></li> </ul> <ul class="conr"> <li><span>Topics: <a href="search.php?action=show_replies" title="Find topics you have posted to.">Posted</a> | <a href="search.php?action=show_new" title="Find topics with new posts since your last visit.">New</a> | <a href="search.php?action=show_recent" title="Find topics with recent posts.">Active</a> | <a href="search.php?action=show_unanswered" title="Find topics with no replies.">Unanswered</a></span></li> </ul> <div class="clearer"></div> </div> </div> </div> <div id="brdmain"> <div class="linkst"> <div class="inbox crumbsplus"> <ul class="crumbs"> <li><a href="index.php">Index</a></li> <li><span>»&#160;</span><a href="viewforum.php?id=48">Topics Going Nowhere</a></li> <li><span>»&#160;</span><strong><a href="viewtopic.php?id=162768">KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</a></strong></li> </ul> <div class="pagepost"> <p class="pagelink conl"><span class="pages-label">Pages: </span><a rel="prev" class="item1" href="viewtopic.php?id=162768&amp;p=214">Previous</a> <a href="viewtopic.php?id=162768">1</a> <span class="spacer">…</span> <a href="viewtopic.php?id=162768&amp;p=213">213</a> <a href="viewtopic.php?id=162768&amp;p=214">214</a> <strong>215</strong> <a href="viewtopic.php?id=162768&amp;p=216">216</a> <a href="viewtopic.php?id=162768&amp;p=217">217</a> <span class="spacer">…</span> <a href="viewtopic.php?id=162768&amp;p=234">234</a> <a rel="next" href="viewtopic.php?id=162768&amp;p=216">Next</a></p> <p class="postlink conr">Topic closed</p> </div> <div class="clearer"></div> </div> </div> <div id="p1537249" class="blockpost rowodd blockpost1"> <h2><span><span class="conr">#5351</span> <a href="viewtopic.php?pid=1537249#p1537249">2015-06-15 19:59:33</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=75590">aw</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2013-10-04</span></dd> <dd><span>Posts: 921</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=75590">Email</a></span> <span class="website"><a href="http://vfio.blogspot.com/" rel="nofollow">Website</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <p>@Denso</p><p>What happens when you use /sys/bus/pci/drivers_probe when in that state where lspci -k shows no driver?&#160; ex:&#160; echo 0000:01:00.0 &gt; /sys/bus/pci/drivers_probe</p><p>I assume you&#039;re actually using a v4.1-rc kernel since the ids= option was only introduced post v4.0, right?&#160; What does dmesg show?&#160; dmesg | grep -i vfio</p> </div> <div class="postsignature postmsg"><hr /><p><a href="http://vfio.blogspot.com" rel="nofollow">http://vfio.blogspot.com</a><br />Looking for a more open forum to discuss vfio related uses?&#160; Try <a href="https://www.redhat.com/mailman/listinfo/vfio-users" rel="nofollow">https://www.redhat.com/mailman/listinfo/vfio-users</a></p></div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1537249">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1537256" class="blockpost roweven"> <h2><span><span class="conr">#5352</span> <a href="viewtopic.php?pid=1537256#p1537256">2015-06-15 20:40:48</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=84760">Denso</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd class="postavatar"><img src="https://bbs.archlinux.org/img/avatars/84760.png?m=1412533733" width="71" height="80" alt="" /></dd> <dd><span>Registered: 2014-08-30</span></dd> <dd><span>Posts: 179</span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <p>When using :</p><div class="codebox"><pre><code>echo 0000:09:00.0 &gt; /sys/bus/pci/drivers_probe</code></pre></div><p>Nothing happens , no errors are thrown , no dmesg messages , and there is still no drivers attached to the GPU .</p><p>I am using 4.1-rc7 compiled last night .</p><p>Thanks <img src="https://bbs.archlinux.org/img/smilies/smile.png" width="15" height="15" alt="smile" /></p> <p class="postedit"><em>Last edited by Denso (2015-06-15 20:41:01)</em></p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1537256">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1537257" class="blockpost rowodd"> <h2><span><span class="conr">#5353</span> <a href="viewtopic.php?pid=1537257#p1537257">2015-06-15 20:44:27</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=75590">aw</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2013-10-04</span></dd> <dd><span>Posts: 921</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=75590">Email</a></span> <span class="website"><a href="http://vfio.blogspot.com/" rel="nofollow">Website</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>Denso wrote:</cite><blockquote><div><p>When using :</p><div class="codebox"><pre><code>echo 0000:09:00.0 &gt; /sys/bus/pci/drivers_probe</code></pre></div><p>Nothing happens , no errors are thrown , no dmesg messages , and there is still no drivers attached to the GPU .</p><p>I am using 4.1-rc7 compiled last night .</p><p>Thanks <img src="https://bbs.archlinux.org/img/smilies/smile.png" width="15" height="15" alt="smile" /></p></div></blockquote></div><p>I was really looking to see if vfio-pci was accepting your ids options via dmesg, not just errors from the above command</p> </div> <div class="postsignature postmsg"><hr /><p><a href="http://vfio.blogspot.com" rel="nofollow">http://vfio.blogspot.com</a><br />Looking for a more open forum to discuss vfio related uses?&#160; Try <a href="https://www.redhat.com/mailman/listinfo/vfio-users" rel="nofollow">https://www.redhat.com/mailman/listinfo/vfio-users</a></p></div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1537257">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1537259" class="blockpost roweven"> <h2><span><span class="conr">#5354</span> <a href="viewtopic.php?pid=1537259#p1537259">2015-06-15 20:48:19</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=84760">Denso</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd class="postavatar"><img src="https://bbs.archlinux.org/img/avatars/84760.png?m=1412533733" width="71" height="80" alt="" /></dd> <dd><span>Registered: 2014-08-30</span></dd> <dd><span>Posts: 179</span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <p>dmesg | grep -i vfio :</p><div class="codebox"><pre><code>[Mon Jun 15 23:36:14 2015] VFIO - User Level meta-driver version: 0.3 [Mon Jun 15 23:36:14 2015] vfio_pci: add [8086:8d20[ffff:ffff]] class 0x000000/00000000 [Mon Jun 15 23:36:14 2015] vfio_pci: add [8086:15a0[ffff:ffff]] class 0x000000/00000000 [Mon Jun 15 23:36:14 2015] vfio_pci: add [1912:0015[ffff:ffff]] class 0x000000/00000000</code></pre></div><p>these are all the devices I&#039;m passing through minus the GPU/HDMI Audio (NVIDIA) devices . What is confusing is that they get bound to vfio-pci just fine using the vfio-bind script from OP .</p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1537259">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1537271" class="blockpost rowodd"> <h2><span><span class="conr">#5355</span> <a href="viewtopic.php?pid=1537271#p1537271">2015-06-15 21:21:51</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=75590">aw</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2013-10-04</span></dd> <dd><span>Posts: 921</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=75590">Email</a></span> <span class="website"><a href="http://vfio.blogspot.com/" rel="nofollow">Website</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>Denso wrote:</cite><blockquote><div><p>dmesg | grep -i vfio :</p><div class="codebox"><pre><code>[Mon Jun 15 23:36:14 2015] VFIO - User Level meta-driver version: 0.3 [Mon Jun 15 23:36:14 2015] vfio_pci: add [8086:8d20[ffff:ffff]] class 0x000000/00000000 [Mon Jun 15 23:36:14 2015] vfio_pci: add [8086:15a0[ffff:ffff]] class 0x000000/00000000 [Mon Jun 15 23:36:14 2015] vfio_pci: add [1912:0015[ffff:ffff]] class 0x000000/00000000</code></pre></div><p>these are all the devices I&#039;m passing through minus the GPU/HDMI Audio (NVIDIA) devices . What is confusing is that they get bound to vfio-pci just fine using the vfio-bind script from OP .</p></div></blockquote></div><p>We&#039;re only getting an Intel audio device, Intel NIC, and Renesas USB3 controller via vfio-pci.ids... why would it claim the nvidia devices?</p> </div> <div class="postsignature postmsg"><hr /><p><a href="http://vfio.blogspot.com" rel="nofollow">http://vfio.blogspot.com</a><br />Looking for a more open forum to discuss vfio related uses?&#160; Try <a href="https://www.redhat.com/mailman/listinfo/vfio-users" rel="nofollow">https://www.redhat.com/mailman/listinfo/vfio-users</a></p></div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1537271">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1537277" class="blockpost roweven"> <h2><span><span class="conr">#5356</span> <a href="viewtopic.php?pid=1537277#p1537277">2015-06-15 21:42:31</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=84760">Denso</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd class="postavatar"><img src="https://bbs.archlinux.org/img/avatars/84760.png?m=1412533733" width="71" height="80" alt="" /></dd> <dd><span>Registered: 2014-08-30</span></dd> <dd><span>Posts: 179</span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>aw wrote:</cite><blockquote><div><p>... why would it claim the nvidia devices?</p></div></blockquote></div><p>Errr ... Because I told it to do so ? <img src="https://bbs.archlinux.org/img/smilies/wink.png" width="15" height="15" alt="wink" /></p><p>Here is what modprobe.d looks like for me :</p><div class="codebox"><pre><code>options vfio-pci ids=10de:ffffffff:ffffffff:ffffffff:00030000:ffff00ff,10de:ffffffff:ffffffff:ffffffff:00040300:ffffffff,1002:ffffffff:ffffffff:ffffffff:00030000:ffff00ff,1002:ffffffff:ffffffff:ffffffff:00040300:ffffffff,8086:8d20,8086:15a0,1912:0015</code></pre></div><p>You see , it claims all the devices except both of my NVIDIA GPUs .</p> <p class="postedit"><em>Last edited by Denso (2015-06-15 21:43:01)</em></p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1537277">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1537281" class="blockpost rowodd"> <h2><span><span class="conr">#5357</span> <a href="viewtopic.php?pid=1537281#p1537281">2015-06-15 21:50:58</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=75590">aw</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2013-10-04</span></dd> <dd><span>Posts: 921</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=75590">Email</a></span> <span class="website"><a href="http://vfio.blogspot.com/" rel="nofollow">Website</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>Denso wrote:</cite><blockquote><div><div class="quotebox"><cite>aw wrote:</cite><blockquote><div><p>... why would it claim the nvidia devices?</p></div></blockquote></div><p>Errr ... Because I told it to do so ? <img src="https://bbs.archlinux.org/img/smilies/wink.png" width="15" height="15" alt="wink" /></p><p>Here is what modprobe.d looks like for me :</p><div class="codebox"><pre><code>options vfio-pci ids=10de:ffffffff:ffffffff:ffffffff:00030000:ffff00ff,10de:ffffffff:ffffffff:ffffffff:00040300:ffffffff,1002:ffffffff:ffffffff:ffffffff:00030000:ffff00ff,1002:ffffffff:ffffffff:ffffffff:00040300:ffffffff,8086:8d20,8086:15a0,1912:0015</code></pre></div><p>You see , it claims all the devices except both of my NVIDIA GPUs .</p></div></blockquote></div><p>Your dmesg says those first 4 entries aren&#039;t taking effect.&#160; Do they work by themselves?&#160; What if you add your entries at the beginning?&#160; Others have found that you can use multiple lines.</p> </div> <div class="postsignature postmsg"><hr /><p><a href="http://vfio.blogspot.com" rel="nofollow">http://vfio.blogspot.com</a><br />Looking for a more open forum to discuss vfio related uses?&#160; Try <a href="https://www.redhat.com/mailman/listinfo/vfio-users" rel="nofollow">https://www.redhat.com/mailman/listinfo/vfio-users</a></p></div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1537281">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1537286" class="blockpost roweven"> <h2><span><span class="conr">#5358</span> <a href="viewtopic.php?pid=1537286#p1537286">2015-06-15 22:07:40</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=84760">Denso</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd class="postavatar"><img src="https://bbs.archlinux.org/img/avatars/84760.png?m=1412533733" width="71" height="80" alt="" /></dd> <dd><span>Registered: 2014-08-30</span></dd> <dd><span>Posts: 179</span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>aw wrote:</cite><blockquote><div><p>Your dmesg says those first 4 entries aren&#039;t taking effect.&#160; Do they work by themselves?&#160; What if you add your entries at the beginning?&#160; Others have found that you can use multiple lines.</p></div></blockquote></div><p>GPUs don&#039;t get bound unless I use the vfio-bind script on them . Specifying them in modprobe.d has no effect what so ever . I also tried breaking them to multiple lines , but the result is the same :</p><div class="codebox"><pre><code>options vfio-pci ids=10de:ffffffff:ffffffff:ffffffff:00030000:ffff00ff,10de:ffffffff:ffffffff:ffffffff:00040300:ffffffff options vfio-pci ids=1002:ffffffff:ffffffff:ffffffff:00030000:ffff00ff,1002:ffffffff:ffffffff:ffffffff:00040300:ffffffff options vfio-pci ids=8086:8d20,8086:15a0,1912:0015</code></pre></div><p>vfio-pci ids= claims all the specified devices successfully except for the NVIDIA devices .</p> <p class="postedit"><em>Last edited by Denso (2015-06-15 22:08:22)</em></p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1537286">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1537289" class="blockpost rowodd"> <h2><span><span class="conr">#5359</span> <a href="viewtopic.php?pid=1537289#p1537289">2015-06-15 22:19:58</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=75590">aw</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2013-10-04</span></dd> <dd><span>Posts: 921</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=75590">Email</a></span> <span class="website"><a href="http://vfio.blogspot.com/" rel="nofollow">Website</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <p>@Denso</p><p>Are you rebuilding your initramfs between each of these changes?&#160; What shows up in dmesg if you run &#039;modprobe -r vfio-pci; modprobe vfio-pci&#039; with modprobe.d as in the previous post?</p> </div> <div class="postsignature postmsg"><hr /><p><a href="http://vfio.blogspot.com" rel="nofollow">http://vfio.blogspot.com</a><br />Looking for a more open forum to discuss vfio related uses?&#160; Try <a href="https://www.redhat.com/mailman/listinfo/vfio-users" rel="nofollow">https://www.redhat.com/mailman/listinfo/vfio-users</a></p></div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1537289">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1537311" class="blockpost roweven"> <h2><span><span class="conr">#5360</span> <a href="viewtopic.php?pid=1537311#p1537311">2015-06-16 03:05:26</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=34610">Myranti</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2010-03-04</span></dd> <dd><span>Posts: 19</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=34610">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <p>Up front, I&#039;ll admit I haven&#039;t kept up to date on this thread since about page 184, but I was curious about something regarding AMD FX CPU series (at least relevant to the octocore models) and how it pertains to IOMMU grouping.</p><p>My assumption from what I vaguely remember reading is that those with the FX cpu&#039;s don&#039;t need to use the ACS override patch and can use an unpatched kernel without having to worry about IOMMU grouping issues. Do I understand this correctly or is my recollection incorrect? Or is there more to it that I need to read up on?</p> <p class="postedit"><em>Last edited by Myranti (2015-06-16 03:06:06)</em></p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1537311">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1537316" class="blockpost rowodd"> <h2><span><span class="conr">#5361</span> <a href="viewtopic.php?pid=1537316#p1537316">2015-06-16 03:56:06</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=75590">aw</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2013-10-04</span></dd> <dd><span>Posts: 921</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=75590">Email</a></span> <span class="website"><a href="http://vfio.blogspot.com/" rel="nofollow">Website</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <p>There are all sorts of ways to use an unpatched kernel, read my blog for examples.&#160; There&#039;s no magic bullet in AMD FX CPUs, other than perhaps the chipsets for them are so old that we&#039;ve already got quirks for them.</p> </div> <div class="postsignature postmsg"><hr /><p><a href="http://vfio.blogspot.com" rel="nofollow">http://vfio.blogspot.com</a><br />Looking for a more open forum to discuss vfio related uses?&#160; Try <a href="https://www.redhat.com/mailman/listinfo/vfio-users" rel="nofollow">https://www.redhat.com/mailman/listinfo/vfio-users</a></p></div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1537316">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1537318" class="blockpost roweven"> <h2><span><span class="conr">#5362</span> <a href="viewtopic.php?pid=1537318#p1537318">2015-06-16 04:11:49</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=75590">aw</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2013-10-04</span></dd> <dd><span>Posts: 921</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=75590">Email</a></span> <span class="website"><a href="http://vfio.blogspot.com/" rel="nofollow">Website</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>WildyLion wrote:</cite><blockquote><div><p>Hi guys,</p><p>Could anybody advise me on how to solve subtle timing issues with a 8.1 guest?<br />When I&#039;m playing music in foobar, the EQ would stop for a second and the sound will stutter, and when I&#039;m playing games, I still get sudden FPS dropouts.</p><p>My hardware<br />* FX-8350 CPU<br />* M5A99FX PRO 2.0 M/B<br />* Sapphire Vapor-X Radeon R9 290 as passthrough GPU (VFIO mode)<br />* USB controller with k/b, mouse and Xonar U7 passed to the VM via PCI passthrough<br />* I switch k/b and mouse between the motherboard USB ports with an ATEN CS22U KVM</p><p>What I&#039;ve already done:</p><p>* Using i440FX vChipset at the moment (with OVMF)<br />* kvm-amd nested pages disabled<br />* Hyper-V extensions enabled for the VM at install time<br />* Host CPU (FX-8350) cpufreq set to performance<br />* Hugepages memory backing enabled, with hugetlbfs<br />* 6 VCPUs pinned to 6 real cores (0-5 respectively)</p></div></blockquote></div><p>Do you mean that you&#039;re pinning all 6 vCPUs to the cpuset 0-5 or are you pinning each individual vCPU to a pCPU within the set 0-5, ie. vCPU0-&gt;pCPU0, vCPU1-&gt;pCPU1, etc?&#160; The latter is recommended for optimal locality.&#160; You don&#039;t mention if you&#039;re using virtio for disk and network within the VM, both are highly recommended and will help to improve overall VM performance.&#160; Either as a test or for very VM specific tuning, you can try using isolcpus= on the host to isolate the pCPU running vCPU from the general scheduler.&#160; I believe running the host with nohz=off has also been suggested.&#160; Using iommu=pt can also avoid IOMMU overhead for host devices and may help marginally.</p> </div> <div class="postsignature postmsg"><hr /><p><a href="http://vfio.blogspot.com" rel="nofollow">http://vfio.blogspot.com</a><br />Looking for a more open forum to discuss vfio related uses?&#160; Try <a href="https://www.redhat.com/mailman/listinfo/vfio-users" rel="nofollow">https://www.redhat.com/mailman/listinfo/vfio-users</a></p></div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1537318">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1537445" class="blockpost rowodd"> <h2><span><span class="conr">#5363</span> <a href="viewtopic.php?pid=1537445#p1537445">2015-06-16 17:27:09</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=91715">WildyLion</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2015-06-07</span></dd> <dd><span>Posts: 4</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=91715">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>aw wrote:</cite><blockquote><div><p>Do you mean that you&#039;re pinning all 6 vCPUs to the cpuset 0-5 or are you pinning each individual vCPU to a pCPU within the set 0-5, ie. vCPU0-&gt;pCPU0, vCPU1-&gt;pCPU1, etc?&#160; The latter is recommended for optimal locality.&#160; You don&#039;t mention if you&#039;re using virtio for disk and network within the VM, both are highly recommended and will help to improve overall VM performance.&#160; Either as a test or for very VM specific tuning, you can try using isolcpus= on the host to isolate the pCPU running vCPU from the general scheduler.&#160; I believe running the host with nohz=off has also been suggested.&#160; Using iommu=pt can also avoid IOMMU overhead for host devices and may help marginally.</p></div></blockquote></div><p>Hi there.</p><p>Turns out these were not timing issues, it&#039;s my audio card (Xonar U7) that was stuttering all along.<br />I was able to achieve perfect sound with using my monitor&#039;s audio output (via HDMI). Though I still get minor FPS dropouts in Witcher 3 this way, it&#039;s completely playable now.</p><p>I&#039;d really appreciate any advice on how to a) either make my U7 work under the hypervisor or b) get PulseAudio sound working with libvirt (my PA is in user mode right now).</p><p>As for your questions, yes, I&#039;ve configured vCPUs pinned to pCPUs and I&#039;m using virtio for everything (though currently my disk image is in qcow2 format, that&#039;s slowing things down considerably with NTFS on top of it).</p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1537445">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1537537" class="blockpost roweven"> <h2><span><span class="conr">#5364</span> <a href="viewtopic.php?pid=1537537#p1537537">2015-06-17 01:36:56</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=91638">PrinzipDesSees</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2015-06-04</span></dd> <dd><span>Posts: 5</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=91638">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <p>@aw</p><p>I tried the method with your wrapper script for passing x-vga but the only thing happening is that libvirt will hang until force restarted.<br />Yes I changed the paths to the right ones.<br />In between it does not seem anything to happen, not even the xml gets parsed.</p> <p class="postedit"><em>Last edited by PrinzipDesSees (2015-06-17 01:39:07)</em></p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1537537">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1537539" class="blockpost rowodd"> <h2><span><span class="conr">#5365</span> <a href="viewtopic.php?pid=1537539#p1537539">2015-06-17 01:47:14</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=75590">aw</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2013-10-04</span></dd> <dd><span>Posts: 921</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=75590">Email</a></span> <span class="website"><a href="http://vfio.blogspot.com/" rel="nofollow">Website</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <p>OK folks, trying to guess what might be wrong with your set is really not fun.&#160; If you want some help, document exactly what you&#039;re doing.&#160; Prolific use of pastebin is encouraged.</p> </div> <div class="postsignature postmsg"><hr /><p><a href="http://vfio.blogspot.com" rel="nofollow">http://vfio.blogspot.com</a><br />Looking for a more open forum to discuss vfio related uses?&#160; Try <a href="https://www.redhat.com/mailman/listinfo/vfio-users" rel="nofollow">https://www.redhat.com/mailman/listinfo/vfio-users</a></p></div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1537539">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1537540" class="blockpost roweven"> <h2><span><span class="conr">#5366</span> <a href="viewtopic.php?pid=1537540#p1537540">2015-06-17 01:54:54</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=78143">Blind Tree Frog</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2013-12-31</span></dd> <dd><span>Posts: 27</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=78143">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>aw wrote:</cite><blockquote><div><p>OK folks, trying to guess what might be wrong with your set is really not fun.&#160; If you want some help, document exactly what you&#039;re doing.&#160; Prolific use of pastebin is encouraged.</p></div></blockquote></div><p>Since I may need to post asking assistance soon if I can&#039;t get past my current hurdle, do you have a format/template in mind we should follow?&#160; Not that one size fits all, but I&#039;d not want to be leaving out information and i figure for certain problems there is at least a base level. (I&#039;ve been trying to catch up, but I&#039;ve been busy for the last 150 pages and might have missed changes along the way)</p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1537540">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1537541" class="blockpost rowodd"> <h2><span><span class="conr">#5367</span> <a href="viewtopic.php?pid=1537541#p1537541">2015-06-17 02:03:48</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=75590">aw</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2013-10-04</span></dd> <dd><span>Posts: 921</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=75590">Email</a></span> <span class="website"><a href="http://vfio.blogspot.com/" rel="nofollow">Website</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>Blind Tree Frog wrote:</cite><blockquote><div><div class="quotebox"><cite>aw wrote:</cite><blockquote><div><p>OK folks, trying to guess what might be wrong with your set is really not fun.&#160; If you want some help, document exactly what you&#039;re doing.&#160; Prolific use of pastebin is encouraged.</p></div></blockquote></div><p>Since I may need to post asking assistance soon if I can&#039;t get past my current hurdle, do you have a format/template in mind we should follow?&#160; Not that one size fits all, but I&#039;d not want to be leaving out information and i figure for certain problems there is at least a base level. (I&#039;ve been trying to catch up, but I&#039;ve been busy for the last 150 pages and might have missed changes along the way)</p></div></blockquote></div><p>Just use common sense, this isn&#039;t a bug reporting system, but use the same techniques to report enough information that someone can spot an error or reproduce the problem.&#160; If you&#039;re trying to use a libvirt wrapper script, show the wrapper script and the xml.&#160; [Sorry PrinzipDesSees, I&#039;m not picking on you, we&#039;re getting a lot of this]&#160; If you&#039;ve changed libvirt.conf, qemu.conf or anything else related to the VM, report it.&#160; Look for errors in dmesg or libvirt log files.&#160; The more interest you take in solving your own problems, the more interest I&#039;m going to have in helping you.</p> </div> <div class="postsignature postmsg"><hr /><p><a href="http://vfio.blogspot.com" rel="nofollow">http://vfio.blogspot.com</a><br />Looking for a more open forum to discuss vfio related uses?&#160; Try <a href="https://www.redhat.com/mailman/listinfo/vfio-users" rel="nofollow">https://www.redhat.com/mailman/listinfo/vfio-users</a></p></div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1537541">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1537549" class="blockpost roweven"> <h2><span><span class="conr">#5368</span> <a href="viewtopic.php?pid=1537549#p1537549">2015-06-17 04:09:50</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=78143">Blind Tree Frog</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2013-12-31</span></dd> <dd><span>Posts: 27</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=78143">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>aw wrote:</cite><blockquote><div><p>Just use common sense, this isn&#039;t a bug reporting system, but use the same techniques to report enough information that someone can spot an error or reproduce the problem.</p></div></blockquote></div><p>Reasonable enough.&#160; Just wanted to check in case I was going to forget anything.&#160; Plus, posting this will give me a reference if i get some slow time at work to search the interwebs for errors I&#039;m getting...</p><p>Based off of the original post, starting with a stock install, pci-stub in the boot string was used to isolate the cards and the suggested vfio-bind script used to put them on the vfio-pci driver (if I don&#039;t use the script, they are on pci-stub and qemu complains.. mentioning that because I thought I saw that this wasn&#039;t supposed to be required anymore).</p><p>I am attempting for a headless host and the guest taking over the sole video card (so commands are run over ssh on the host)</p><p>system info:<br />Mobo: Asus Sabertooth 990FX/Gen3 R2.0 AM3+ AMD 990FX<br />Video: Asus HD7770-DC-1GD5-V2 Radeon HD 7770 GHz Edition 1GB</p><div class="codebox"><pre><code># uname -a Linux pandora 4.0.5-1-ARCH #1 SMP PREEMPT Sat Jun 6 18:37:49 CEST 2015 x86_64 GNU/Linux</code></pre></div><div class="codebox"><pre><code># cat /proc/cmdline initrd=\initramfs-linux.img root=/dev/sda2 rw quiet splash video=efifb:off pci-stub.ids=1002:683d,1002:aab0</code></pre></div><div class="codebox"><pre><code># lspci -nnk ... 03:00.0 VGA compatible controller [0300]: Advanced Micro Devices, Inc. [AMD/ATI] Cape Verde XT [Radeon HD 7770/8760 / R7 250X] [1002:683d] Subsystem: ASUSTeK Computer Inc. Device [1043:0429] Kernel driver in use: vfio-pci Kernel modules: radeon 03:00.1 Audio device [0403]: Advanced Micro Devices, Inc. [AMD/ATI] Cape Verde/Pitcairn HDMI Audio [Radeon HD 7700/7800 Series] [1002:aab0] Subsystem: ASUSTeK Computer Inc. Device [1043:aab0] Kernel driver in use: vfio-pci Kernel modules: snd_hda_intel ...</code></pre></div><p>Testing is done with one of two commands</p><div class="codebox"><pre><code>qemu-system-x86_64 -enable-kvm -m 1024 -cpu host,kvm=off\ -machine type=pc,accel=kvm \ -smp 2,sockets=1,cores=2,threads=1 \ -device vfio-pci,host=03:00.0,x-vga=on -device vfio-pci,host=03:00.1 \ -vga none -nographic \ -usb -usbdevice host:045e:0768 -usbdevice host:3842:2410 \ -cdrom /root/archbang-150516-i686.iso</code></pre></div><p>or</p><div class="codebox"><pre><code>qemu-system-x86_64 -enable-kvm -m 1024 -cpu host \ -smp 1,sockets=1,cores=1,threads=1 \ -device vfio-pci,host=03:00.0,x-vga=on -device vfio-pci,host=03:00.1 \ -vga none -nographic -display stdio\ -device virtio-scsi-pci,id=scsi \ -drive file=/root/arch_guest.img,id=disk,format=raw,if=none -device scsi-hd,drive=disk \ -usb -usbdevice host:045e:0768 -usbdevice host:3842:2410</code></pre></div><p>(the two usbdevices should be my mouse and keyboard.&#160; removing them doesn&#039;t improve anything but definitely disables any keyboard support i had.)</p><p>Both guests boot and seem to get to the login prompt and then hang.&#160; &#160;arch_guest.img hangs at the login prompt and won&#039;t take any input at all.&#160; &#160;archbang.iso gets to the message saying that it&#039;s reached target Graphical Interface (occasionally not quite that far) and hangs, but i can switch to consoles 2-6 and log in (though i can&#039;t launch X from there because it&#039;s busy doing it&#039;s thing).</p><p>from an archbang run...<br />I assume that this in my guest&#039;s dmesg log is a good sign that the passthrough worked:</p><div class="codebox"><pre><code>[ 0.290104] vgaarb: setting as boot device: PCI:0000:00:03.0 [ 0.290104] vgaarb: device added: PCI:0000:00:03.0,decodes=io+mem,owns=io+mem,locks=none [ 0.290104] vgaarb: loaded [ 0.290104] vgaarb: bridge control possible 0000:00:03.0 [ 0.290152] PCI: Using ACPI for IRQ routing [ 0.290152] PCI: pci_cache_line_size set to 64 bytes ... [ 6.487464] radeon 0000:00:03.0: VRAM: 1024M 0x0000000000000000 - 0x000000003FFFFFFF (1024M used) [ 6.487467] radeon 0000:00:03.0: GTT: 1024M 0x0000000040000000 - 0x000000007FFFFFFF</code></pre></div><p>For a minute I was thinking it was simply that I needed to figure out the correct combination of&#160; &quot;-nographics -display xxxx&quot; or whatever, but I am getting this trace soon before archbang hangs and that makes me think there is a problem with my set up that i&#039;m missing.</p><div class="codebox"><pre class="vscroll"><code>[ 6.633752] CPU: 1 PID: 437 Comm: systemd-udevd Not tainted 4.0.2-1-ARCH #1 [ 6.633752] Hardware name: QEMU Standard PC (i440FX + PIIX, 1996), BIOS 1.8.1-20150422_083828-anatol 04/01/2014 [ 6.633752] task: f7353fc0 ti: f738a000 task.ti: f738a000 [ 6.633752] EIP: 0060:[&lt;f8670cf1&gt;] EFLAGS: 00010286 CPU: 1 [ 6.633752] EIP is at drm_pcie_get_speed_cap_mask+0x31/0xe0 [drm] [ 6.633752] EAX: f5dd6800 EBX: f738bb18 ECX: 00000000 EDX: f738bb18 [ 6.633752] ESI: 00000000 EDI: ee60c000 EBP: f738bab4 ESP: f738ba8c [ 6.633752] DS: 007b ES: 007b FS: 00d8 GS: 00e0 SS: 0068 [ 6.633752] CR0: 80050033 CR2: 00000020 CR3: 351bd000 CR4: 000007d0 [ 6.633752] Stack: [ 6.633752] c133b044 f738ba98 c13402f2 000080d0 00004a7c f8b62618 ee4f0000 8e6555bd [ 6.633752] 00000000 ee4f0000 f738bb60 f8b62639 c133c5ed f7332a0c ee439700 ee4f0000 [ 6.633752] f738bae0 f846d000 00000000 ee60c000 f8bc1e19 f738baf0 c1349d7d 00000000 [ 6.633752] Call Trace: [ 6.633752] [&lt;c133b044&gt;] ? get_device+0x14/0x30 [ 6.633752] [&lt;c13402f2&gt;] ? klist_class_dev_get+0x12/0x20 [ 6.633752] [&lt;f8b62618&gt;] ? si_dpm_init+0x38/0x11a0 [radeon] [ 6.633752] [&lt;f8b62639&gt;] si_dpm_init+0x59/0x11a0 [radeon] [ 6.633752] [&lt;c133c5ed&gt;] ? device_add+0x16d/0x5f0 [ 6.633752] [&lt;c1349d7d&gt;] ? pm_runtime_init+0xcd/0xe0 [ 6.633752] [&lt;c133ca87&gt;] ? device_register+0x17/0x20 [ 6.633752] [&lt;f846b135&gt;] ? hwmon_device_register_with_groups.part.0+0xa5/0x100 [hwmon] [ 6.633752] [&lt;f846b1e1&gt;] ? hwmon_device_register_with_groups+0x51/0x60 [hwmon] [ 6.633752] [&lt;f8af6317&gt;] ? radeon_hwmon_init+0x57/0x90 [radeon] [ 6.633752] [&lt;f8af69aa&gt;] radeon_pm_init+0x49a/0x860 [radeon] [ 6.633752] [&lt;c1351426&gt;] ? request_firmware+0x36/0x40 [ 6.633752] [&lt;f8b279b3&gt;] si_init+0x263/0xb30 [radeon] [ 6.633752] [&lt;c1338c69&gt;] ? vga_switcheroo_register_client+0x39/0x50 [ 6.633752] [&lt;f8a8f267&gt;] radeon_device_init+0x957/0xaf0 [radeon] [ 6.633752] [&lt;f8a8d4e0&gt;] ? cail_reg_read+0x70/0x70 [radeon] [ 6.633752] [&lt;f8a9173a&gt;] radeon_driver_load_kms+0x8a/0x200 [radeon] [ 6.633752] [&lt;f866ec7e&gt;] drm_dev_register+0x8e/0xd0 [drm] [ 6.633752] [&lt;f86712e9&gt;] drm_get_pci_dev+0xa9/0x1b0 [drm] [ 6.633752] [&lt;c1170564&gt;] ? kmem_cache_alloc_trace+0x1c4/0x200 [ 6.633752] [&lt;f8a8d34e&gt;] ? radeon_pci_probe+0x6e/0xa0 [radeon] [ 6.633752] [&lt;f8a8d35c&gt;] radeon_pci_probe+0x7c/0xa0 [radeon] [ 6.633752] [&lt;c128f34f&gt;] pci_device_probe+0x6f/0xd0 [ 6.633752] [&lt;c11ed945&gt;] ? sysfs_create_link+0x25/0x50 [ 6.633752] [&lt;c133f403&gt;] driver_probe_device+0x93/0x3c0 [ 6.633752] [&lt;c133f7e9&gt;] __driver_attach+0x79/0x80 [ 6.633752] [&lt;c133f770&gt;] ? __device_attach+0x40/0x40 [ 6.633752] [&lt;c133d7e7&gt;] bus_for_each_dev+0x57/0xa0 [ 6.633752] [&lt;c133eeee&gt;] driver_attach+0x1e/0x20 [ 6.633752] [&lt;c133f770&gt;] ? __device_attach+0x40/0x40 [ 6.633752] [&lt;c133eb37&gt;] bus_add_driver+0x157/0x240 [ 6.633752] [&lt;f86d4000&gt;] ? 0xf86d4000 [ 6.633752] [&lt;f86d4000&gt;] ? 0xf86d4000 [ 6.633752] [&lt;c133ffbd&gt;] driver_register+0x5d/0xf0 [ 6.633752] [&lt;c128eba3&gt;] __pci_register_driver+0x33/0x40 [ 6.633752] [&lt;f86714cd&gt;] drm_pci_init+0xdd/0x100 [drm] [ 6.633752] [&lt;f86d4000&gt;] ? 0xf86d4000 [ 6.633752] [&lt;f86d4092&gt;] radeon_init+0x92/0xa7 [radeon] [ 6.633752] [&lt;c100047a&gt;] do_one_initcall+0xaa/0x200 [ 6.633752] [&lt;f86d4000&gt;] ? 0xf86d4000 [ 6.633752] [&lt;c112cd9d&gt;] ? free_pages_prepare+0x19d/0x2e0 [ 6.633752] [&lt;c1170f65&gt;] ? kfree+0x135/0x140 [ 6.633752] [&lt;c115d238&gt;] ? __vunmap+0xb8/0xf0 [ 6.633752] [&lt;c117041e&gt;] ? kmem_cache_alloc_trace+0x7e/0x200 [ 6.633752] [&lt;c1498f95&gt;] ? do_init_module+0x21/0x198 [ 6.633752] [&lt;c1498f95&gt;] ? do_init_module+0x21/0x198 [ 6.633752] [&lt;c1498fc4&gt;] do_init_module+0x50/0x198 [ 6.633752] [&lt;c10d2883&gt;] load_module+0x1df3/0x23b0 [ 6.633752] [&lt;c10749ee&gt;] ? finish_task_switch+0x4e/0xe0 [ 6.633752] [&lt;c10d2f4f&gt;] SyS_init_module+0x10f/0x170 [ 6.633752] [&lt;c149e357&gt;] sysenter_do_call+0x12/0x12 [ 6.633752] Code: ec 20 3e 8d 74 26 00 c7 02 00 00 00 00 8b 80 04 01 00 00 89 d3 65 8b 0d 14 00 00 00 89 4d f4 31 c9 85 c0 74 16 8b 40 08 8b 70 1c &lt;0f&gt; b7 46 20 66 3d 06 11 74 06 66 3d 66 11 75 18 b8 ea ff ff ff [ 6.633752] EIP: [&lt;f8670cf1&gt;] drm_pcie_get_speed_cap_mask+0x31/0xe0 [drm] SS:ESP 0068:f738ba8c [ 6.633752] CR2: 0000000000000020 [ 6.686348] ---[ end trace 7a3848033a378f35 ]---</code></pre></div><p>Full dmesg: <a href="http://pastebin.com/RiNrY9sW" rel="nofollow">http://pastebin.com/RiNrY9sW</a></p><p>I&#039;m looking back over the thread from the beginning to see if I can find anything that might help... i seem to recall some stuff regarding about reseting the card before/after launch qemu (not the eject device talk), but maybe I made that up or maybe it won&#039;t help.</p> <p class="postedit"><em>Last edited by Blind Tree Frog (2015-06-17 04:11:54)</em></p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1537549">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1537645" class="blockpost rowodd"> <h2><span><span class="conr">#5369</span> <a href="viewtopic.php?pid=1537645#p1537645">2015-06-17 15:47:19</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=75590">aw</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2013-10-04</span></dd> <dd><span>Posts: 921</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=75590">Email</a></span> <span class="website"><a href="http://vfio.blogspot.com/" rel="nofollow">Website</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>Blind Tree Frog wrote:</cite><blockquote><div><p>Based off of the original post, starting with a stock install, pci-stub in the boot string was used to isolate the cards and the suggested vfio-bind script used to put them on the vfio-pci driver (if I don&#039;t use the script, they are on pci-stub and qemu complains.. mentioning that because I thought I saw that this wasn&#039;t supposed to be required anymore).</p></div></blockquote></div><p>I don&#039;t advocate the vfio-bind script, especially the version that blindly binds any device in a group to vfio-pci regardless of the type.&#160; vfio-pci doesn&#039;t know how to handle bridges and can actually disable them, preventing access to the downstream devices that you&#039;re actually trying to use.&#160; Newer kernels will not allow binding vfio-pci to bridges.</p><p>That said, if you&#039;re not using libvirt, you do need to bind the endpoints you intend to assign to vfio-pci.&#160; Perhaps your confusion on this point is that libvirt will do it for you, so for a libvirt-based setup, it&#039;s sufficient to get the GPU bound to pci-stub and leave the rest to libvirt.</p><p>If I were creating a qemu commandline setup, I&#039;d still use <em>virsh nodedev-deatch</em> for binding to vfio-pci rather than the vfio-bind script.</p><div class="quotebox"><blockquote><div><p>I am attempting for a headless host and the guest taking over the sole video card (so commands are run over ssh on the host)</p></div></blockquote></div><p>FWIW, the kernel handles the boot VGA ROM differently than secondary ROMs.&#160; You actually get the shadow copy that might be modified during the execution of the ROM code.&#160; So, somehow getting a copy of the real, untouched ROM and passing it as a file would be encouraged for this scenario.</p><div class="quotebox"><blockquote><div><p>system info:<br />Mobo: Asus Sabertooth 990FX/Gen3 R2.0 AM3+ AMD 990FX<br />Video: Asus HD7770-DC-1GD5-V2 Radeon HD 7770 GHz Edition 1GB</p><div class="codebox"><pre><code># uname -a Linux pandora 4.0.5-1-ARCH #1 SMP PREEMPT Sat Jun 6 18:37:49 CEST 2015 x86_64 GNU/Linux</code></pre></div><div class="codebox"><pre><code># cat /proc/cmdline initrd=\initramfs-linux.img root=/dev/sda2 rw quiet splash video=efifb:off pci-stub.ids=1002:683d,1002:aab0</code></pre></div><div class="codebox"><pre><code># lspci -nnk ... 03:00.0 VGA compatible controller [0300]: Advanced Micro Devices, Inc. [AMD/ATI] Cape Verde XT [Radeon HD 7770/8760 / R7 250X] [1002:683d] Subsystem: ASUSTeK Computer Inc. Device [1043:0429] Kernel driver in use: vfio-pci Kernel modules: radeon 03:00.1 Audio device [0403]: Advanced Micro Devices, Inc. [AMD/ATI] Cape Verde/Pitcairn HDMI Audio [Radeon HD 7700/7800 Series] [1002:aab0] Subsystem: ASUSTeK Computer Inc. Device [1043:aab0] Kernel driver in use: vfio-pci Kernel modules: snd_hda_intel ...</code></pre></div><p>Testing is done with one of two commands</p><div class="codebox"><pre><code>qemu-system-x86_64 -enable-kvm -m 1024 -cpu host,kvm=off\ -machine type=pc,accel=kvm \ -smp 2,sockets=1,cores=2,threads=1 \ -device vfio-pci,host=03:00.0,x-vga=on -device vfio-pci,host=03:00.1 \ -vga none -nographic \ -usb -usbdevice host:045e:0768 -usbdevice host:3842:2410 \ -cdrom /root/archbang-150516-i686.iso</code></pre></div><p>or</p><div class="codebox"><pre><code>qemu-system-x86_64 -enable-kvm -m 1024 -cpu host \ -smp 1,sockets=1,cores=1,threads=1 \ -device vfio-pci,host=03:00.0,x-vga=on -device vfio-pci,host=03:00.1 \ -vga none -nographic -display stdio\ -device virtio-scsi-pci,id=scsi \ -drive file=/root/arch_guest.img,id=disk,format=raw,if=none -device scsi-hd,drive=disk \ -usb -usbdevice host:045e:0768 -usbdevice host:3842:2410</code></pre></div><p>(the two usbdevices should be my mouse and keyboard.&#160; removing them doesn&#039;t improve anything but definitely disables any keyboard support i had.)</p><p>Both guests boot and seem to get to the login prompt and then hang.&#160; &#160;arch_guest.img hangs at the login prompt and won&#039;t take any input at all.&#160; &#160;archbang.iso gets to the message saying that it&#039;s reached target Graphical Interface (occasionally not quite that far) and hangs, but i can switch to consoles 2-6 and log in (though i can&#039;t launch X from there because it&#039;s busy doing it&#039;s thing).</p><p>from an archbang run...<br />I assume that this in my guest&#039;s dmesg log is a good sign that the passthrough worked:</p><div class="codebox"><pre><code>[ 0.290104] vgaarb: setting as boot device: PCI:0000:00:03.0 [ 0.290104] vgaarb: device added: PCI:0000:00:03.0,decodes=io+mem,owns=io+mem,locks=none [ 0.290104] vgaarb: loaded [ 0.290104] vgaarb: bridge control possible 0000:00:03.0 [ 0.290152] PCI: Using ACPI for IRQ routing [ 0.290152] PCI: pci_cache_line_size set to 64 bytes ... [ 6.487464] radeon 0000:00:03.0: VRAM: 1024M 0x0000000000000000 - 0x000000003FFFFFFF (1024M used) [ 6.487467] radeon 0000:00:03.0: GTT: 1024M 0x0000000040000000 - 0x000000007FFFFFFF</code></pre></div><p>For a minute I was thinking it was simply that I needed to figure out the correct combination of&#160; &quot;-nographics -display xxxx&quot; or whatever, but I am getting this trace soon before archbang hangs and that makes me think there is a problem with my set up that i&#039;m missing.</p><div class="codebox"><pre class="vscroll"><code>[ 6.633752] CPU: 1 PID: 437 Comm: systemd-udevd Not tainted 4.0.2-1-ARCH #1 [ 6.633752] Hardware name: QEMU Standard PC (i440FX + PIIX, 1996), BIOS 1.8.1-20150422_083828-anatol 04/01/2014 [ 6.633752] task: f7353fc0 ti: f738a000 task.ti: f738a000 [ 6.633752] EIP: 0060:[&lt;f8670cf1&gt;] EFLAGS: 00010286 CPU: 1 [ 6.633752] EIP is at drm_pcie_get_speed_cap_mask+0x31/0xe0 [drm] [ 6.633752] EAX: f5dd6800 EBX: f738bb18 ECX: 00000000 EDX: f738bb18 [ 6.633752] ESI: 00000000 EDI: ee60c000 EBP: f738bab4 ESP: f738ba8c [ 6.633752] DS: 007b ES: 007b FS: 00d8 GS: 00e0 SS: 0068 [ 6.633752] CR0: 80050033 CR2: 00000020 CR3: 351bd000 CR4: 000007d0 [ 6.633752] Stack: [ 6.633752] c133b044 f738ba98 c13402f2 000080d0 00004a7c f8b62618 ee4f0000 8e6555bd [ 6.633752] 00000000 ee4f0000 f738bb60 f8b62639 c133c5ed f7332a0c ee439700 ee4f0000 [ 6.633752] f738bae0 f846d000 00000000 ee60c000 f8bc1e19 f738baf0 c1349d7d 00000000 [ 6.633752] Call Trace: [ 6.633752] [&lt;c133b044&gt;] ? get_device+0x14/0x30 [ 6.633752] [&lt;c13402f2&gt;] ? klist_class_dev_get+0x12/0x20 [ 6.633752] [&lt;f8b62618&gt;] ? si_dpm_init+0x38/0x11a0 [radeon] [ 6.633752] [&lt;f8b62639&gt;] si_dpm_init+0x59/0x11a0 [radeon] [ 6.633752] [&lt;c133c5ed&gt;] ? device_add+0x16d/0x5f0 [ 6.633752] [&lt;c1349d7d&gt;] ? pm_runtime_init+0xcd/0xe0 [ 6.633752] [&lt;c133ca87&gt;] ? device_register+0x17/0x20 [ 6.633752] [&lt;f846b135&gt;] ? hwmon_device_register_with_groups.part.0+0xa5/0x100 [hwmon] [ 6.633752] [&lt;f846b1e1&gt;] ? hwmon_device_register_with_groups+0x51/0x60 [hwmon] [ 6.633752] [&lt;f8af6317&gt;] ? radeon_hwmon_init+0x57/0x90 [radeon] [ 6.633752] [&lt;f8af69aa&gt;] radeon_pm_init+0x49a/0x860 [radeon] [ 6.633752] [&lt;c1351426&gt;] ? request_firmware+0x36/0x40 [ 6.633752] [&lt;f8b279b3&gt;] si_init+0x263/0xb30 [radeon] [ 6.633752] [&lt;c1338c69&gt;] ? vga_switcheroo_register_client+0x39/0x50 [ 6.633752] [&lt;f8a8f267&gt;] radeon_device_init+0x957/0xaf0 [radeon] [ 6.633752] [&lt;f8a8d4e0&gt;] ? cail_reg_read+0x70/0x70 [radeon] [ 6.633752] [&lt;f8a9173a&gt;] radeon_driver_load_kms+0x8a/0x200 [radeon] [ 6.633752] [&lt;f866ec7e&gt;] drm_dev_register+0x8e/0xd0 [drm] [ 6.633752] [&lt;f86712e9&gt;] drm_get_pci_dev+0xa9/0x1b0 [drm] [ 6.633752] [&lt;c1170564&gt;] ? kmem_cache_alloc_trace+0x1c4/0x200 [ 6.633752] [&lt;f8a8d34e&gt;] ? radeon_pci_probe+0x6e/0xa0 [radeon] [ 6.633752] [&lt;f8a8d35c&gt;] radeon_pci_probe+0x7c/0xa0 [radeon] [ 6.633752] [&lt;c128f34f&gt;] pci_device_probe+0x6f/0xd0 [ 6.633752] [&lt;c11ed945&gt;] ? sysfs_create_link+0x25/0x50 [ 6.633752] [&lt;c133f403&gt;] driver_probe_device+0x93/0x3c0 [ 6.633752] [&lt;c133f7e9&gt;] __driver_attach+0x79/0x80 [ 6.633752] [&lt;c133f770&gt;] ? __device_attach+0x40/0x40 [ 6.633752] [&lt;c133d7e7&gt;] bus_for_each_dev+0x57/0xa0 [ 6.633752] [&lt;c133eeee&gt;] driver_attach+0x1e/0x20 [ 6.633752] [&lt;c133f770&gt;] ? __device_attach+0x40/0x40 [ 6.633752] [&lt;c133eb37&gt;] bus_add_driver+0x157/0x240 [ 6.633752] [&lt;f86d4000&gt;] ? 0xf86d4000 [ 6.633752] [&lt;f86d4000&gt;] ? 0xf86d4000 [ 6.633752] [&lt;c133ffbd&gt;] driver_register+0x5d/0xf0 [ 6.633752] [&lt;c128eba3&gt;] __pci_register_driver+0x33/0x40 [ 6.633752] [&lt;f86714cd&gt;] drm_pci_init+0xdd/0x100 [drm] [ 6.633752] [&lt;f86d4000&gt;] ? 0xf86d4000 [ 6.633752] [&lt;f86d4092&gt;] radeon_init+0x92/0xa7 [radeon] [ 6.633752] [&lt;c100047a&gt;] do_one_initcall+0xaa/0x200 [ 6.633752] [&lt;f86d4000&gt;] ? 0xf86d4000 [ 6.633752] [&lt;c112cd9d&gt;] ? free_pages_prepare+0x19d/0x2e0 [ 6.633752] [&lt;c1170f65&gt;] ? kfree+0x135/0x140 [ 6.633752] [&lt;c115d238&gt;] ? __vunmap+0xb8/0xf0 [ 6.633752] [&lt;c117041e&gt;] ? kmem_cache_alloc_trace+0x7e/0x200 [ 6.633752] [&lt;c1498f95&gt;] ? do_init_module+0x21/0x198 [ 6.633752] [&lt;c1498f95&gt;] ? do_init_module+0x21/0x198 [ 6.633752] [&lt;c1498fc4&gt;] do_init_module+0x50/0x198 [ 6.633752] [&lt;c10d2883&gt;] load_module+0x1df3/0x23b0 [ 6.633752] [&lt;c10749ee&gt;] ? finish_task_switch+0x4e/0xe0 [ 6.633752] [&lt;c10d2f4f&gt;] SyS_init_module+0x10f/0x170 [ 6.633752] [&lt;c149e357&gt;] sysenter_do_call+0x12/0x12 [ 6.633752] Code: ec 20 3e 8d 74 26 00 c7 02 00 00 00 00 8b 80 04 01 00 00 89 d3 65 8b 0d 14 00 00 00 89 4d f4 31 c9 85 c0 74 16 8b 40 08 8b 70 1c &lt;0f&gt; b7 46 20 66 3d 06 11 74 06 66 3d 66 11 75 18 b8 ea ff ff ff [ 6.633752] EIP: [&lt;f8670cf1&gt;] drm_pcie_get_speed_cap_mask+0x31/0xe0 [drm] SS:ESP 0068:f738ba8c [ 6.633752] CR2: 0000000000000020 [ 6.686348] ---[ end trace 7a3848033a378f35 ]---</code></pre></div><p>Full dmesg: <a href="http://pastebin.com/RiNrY9sW" rel="nofollow">http://pastebin.com/RiNrY9sW</a></p><p>I&#039;m looking back over the thread from the beginning to see if I can find anything that might help... i seem to recall some stuff regarding about reseting the card before/after launch qemu (not the eject device talk), but maybe I made that up or maybe it won&#039;t help.</p></div></blockquote></div><p>You&#039;re assigning an AMD card to a 440FX VM running Linux.&#160; That&#039;s pretty much the one case where I recommend Q35.&#160; I&#039;ve posted patches for this, but I lost track of whether they&#039;ve all been accepted.&#160; The problem is that the radeon driver blindly assumes that a downstream port exists above the device because that&#039;s the way it appears on real hardware.&#160; It then goes trying to read link speed info on a device that doesn&#039;t exist and you get the above oops.&#160; You need to switch to Q35, add a root port and put the GPU below the root port.</p> </div> <div class="postsignature postmsg"><hr /><p><a href="http://vfio.blogspot.com" rel="nofollow">http://vfio.blogspot.com</a><br />Looking for a more open forum to discuss vfio related uses?&#160; Try <a href="https://www.redhat.com/mailman/listinfo/vfio-users" rel="nofollow">https://www.redhat.com/mailman/listinfo/vfio-users</a></p></div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1537645">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1537646" class="blockpost roweven"> <h2><span><span class="conr">#5370</span> <a href="viewtopic.php?pid=1537646#p1537646">2015-06-17 16:03:53</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=78143">Blind Tree Frog</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2013-12-31</span></dd> <dd><span>Posts: 27</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=78143">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>aw wrote:</cite><blockquote><div><div class="quotebox"><cite>Blind Tree Frog wrote:</cite><blockquote><div><p>Based off of the original post, starting with a stock install, pci-stub in the boot string was used to isolate the cards and the suggested vfio-bind script used to put them on the vfio-pci driver (if I don&#039;t use the script, they are on pci-stub and qemu complains.. mentioning that because I thought I saw that this wasn&#039;t supposed to be required anymore).</p></div></blockquote></div><p>I don&#039;t advocate the vfio-bind script, especially the version that blindly binds any device in a group to vfio-pci regardless of the type.&#160; vfio-pci doesn&#039;t know how to handle bridges and can actually disable them, preventing access to the downstream devices that you&#039;re actually trying to use.&#160; Newer kernels will not allow binding vfio-pci to bridges.</p><p>That said, if you&#039;re not using libvirt, you do need to bind the endpoints you intend to assign to vfio-pci.&#160; Perhaps your confusion on this point is that libvirt will do it for you, so for a libvirt-based setup, it&#039;s sufficient to get the GPU bound to pci-stub and leave the rest to libvirt.</p><p>If I were creating a qemu commandline setup, I&#039;d still use <em>virsh nodedev-deatch</em> for binding to vfio-pci rather than the vfio-bind script.</p></div></blockquote></div><p>Switching to virsh was on the list once I got things running.&#160; &#160;Now that you mention it, I do remember reading your stuff that it was libvirt that handled the vfio-pci stuff automatically.</p><div class="quotebox"><cite>aw wrote:</cite><blockquote><div><div class="quotebox"><cite>btf wrote:</cite><blockquote><div><p>I am attempting for a headless host and the guest taking over the sole video card (so commands are run over ssh on the host)</p></div></blockquote></div><p>FWIW, the kernel handles the boot VGA ROM differently than secondary ROMs.&#160; You actually get the shadow copy that might be modified during the execution of the ROM code.&#160; So, somehow getting a copy of the real, untouched ROM and passing it as a file would be encouraged for this scenario.</p></div></blockquote></div><p>I was hoping to avoid that, but I feared I might have to look into that at some point.</p><div class="quotebox"><cite>aw wrote:</cite><blockquote><div><p>You&#039;re assigning an AMD card to a 440FX VM running Linux.&#160; That&#039;s pretty much the one case where I recommend Q35.&#160; I&#039;ve posted patches for this, but I lost track of whether they&#039;ve all been accepted.&#160; The problem is that the radeon driver blindly assumes that a downstream port exists above the device because that&#039;s the way it appears on real hardware.&#160; It then goes trying to read link speed info on a device that doesn&#039;t exist and you get the above oops.&#160; You need to switch to Q35, add a root port and put the GPU below the root port.</p></div></blockquote></div><p>Ah, that&#039;s what the trace is complaining about.&#160; A cursory search was leading me to similar errors about a root device not being available, but I wasn&#039;t sure if that applied here or not since my PCI root was in a different group.</p><p>Thanks.</p><p>edit:<br />assuming that I am looking at the correct commits in qemu, I believe I see similar commits, but they are old enough that I&#039;d expect that (Apr 13) so I&#039;m guessing that either this specific issue didn&#039;t get hit, or not all patches were accepted.</p> <p class="postedit"><em>Last edited by Blind Tree Frog (2015-06-17 18:12:13)</em></p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1537646">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1537653" class="blockpost rowodd"> <h2><span><span class="conr">#5371</span> <a href="viewtopic.php?pid=1537653#p1537653">2015-06-17 17:05:37</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=80279">novist</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2014-03-14</span></dd> <dd><span>Posts: 34</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=80279">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <p>Has anyone actually tried to get gpu passthrough working on laptop with nvidia optimus? I wonder if its even possible. If it were would be good incentive to get such laptop.</p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1537653">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1537683" class="blockpost roweven"> <h2><span><span class="conr">#5372</span> <a href="viewtopic.php?pid=1537683#p1537683">2015-06-17 20:03:01</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=85314">Duelist</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2014-09-22</span></dd> <dd><span>Posts: 358</span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>novist wrote:</cite><blockquote><div><p>Has anyone actually tried to get gpu passthrough working on laptop with nvidia optimus? I wonder if its even possible. If it were would be good incentive to get such laptop.</p></div></blockquote></div><p>I&#039;ve observed very weird 3-state GPU on some lenovo laptop:<br />The Nvidia GPU was full on when it&#039;s used.<br />The Nvidia GPU is in power-save mode, just like unused ones on a &quot;real&quot; PC when it was used.<br />The Nvidia GPU is in some uninitialized state, where lspci fails to read the info, complaining about some &quot;bad headers&quot;, when the GPU wasn&#039;t used since system boot.</p><p>And the screen switching problem, as some notebooks have their auxiliary video output routed only to intel, only to nvidia or to both via some weird switch.</p><br /><p>Has anyone tried? I can&#039;t recall. If it&#039;s even possible? There was a guy <span class="bbu">without</span> optimus, who tried to pass a signle and only GPU to the VM leaving the host headless, and he failed. So i highly doubt that it&#039;s possible in theory. It all depends on the vendor of the laptop, and what their firmware engineers were smoking.</p> </div> <div class="postsignature postmsg"><hr /><p><span class="bbs">The forum rules prohibit requesting support for distributions other than arch.</span><br /><a href="https://bbs.archlinux.org/viewtopic.php?pid=1551460#p1551460" rel="nofollow">I gave up.</a><a href="https://bbs.archlinux.org/viewtopic.php?id=162768" rel="nofollow"> It was too late.</a><br /><a href="http://pastebin.com/B3fL84bq" rel="nofollow">What I was trying to do</a>.<br /><a href="http://vfio.blogspot.com/" rel="nofollow">The reference about VFIO and KVM VGA passthrough.</a></p></div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1537683">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1537688" class="blockpost rowodd"> <h2><span><span class="conr">#5373</span> <a href="viewtopic.php?pid=1537688#p1537688">2015-06-17 20:19:40</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=75590">aw</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2013-10-04</span></dd> <dd><span>Posts: 921</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=75590">Email</a></span> <span class="website"><a href="http://vfio.blogspot.com/" rel="nofollow">Website</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <p>You also have to wonder how well the thermal controls work for an integrated environment like a laptop.&#160; On a discrete desktop card, you know the GPU fan speed is controlled through the GPU device driver, the rest of the PC knows nothing about it.&#160; On a laptop there&#039;s often a more holistic approach to thermal management.&#160; If I was trying one, I&#039;d be very careful until I gained some confidence that the response to thermal load was working.</p><p>The only experience I have is a pre-optimus laptop that I could never get past Code 43, probably because it&#039;s tied to a model specific, custom nvidia driver (ie. it doesn&#039;t work with downloads direct from nvidia even on bare metal).</p> </div> <div class="postsignature postmsg"><hr /><p><a href="http://vfio.blogspot.com" rel="nofollow">http://vfio.blogspot.com</a><br />Looking for a more open forum to discuss vfio related uses?&#160; Try <a href="https://www.redhat.com/mailman/listinfo/vfio-users" rel="nofollow">https://www.redhat.com/mailman/listinfo/vfio-users</a></p></div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1537688">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1537693" class="blockpost roweven"> <h2><span><span class="conr">#5374</span> <a href="viewtopic.php?pid=1537693#p1537693">2015-06-17 20:52:05</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=85314">Duelist</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2014-09-22</span></dd> <dd><span>Posts: 358</span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>aw wrote:</cite><blockquote><div><p>You also have to wonder how well the thermal controls work for an integrated environment like a laptop.&#160; On a discrete desktop card, you know the GPU fan speed is controlled through the GPU device driver, the rest of the PC knows nothing about it.&#160; On a laptop there&#039;s often a more holistic approach to thermal management.&#160; If I was trying one, I&#039;d be very careful until I gained some confidence that the response to thermal load was working.</p></div></blockquote></div><p>Usually laptops have one fan to cool them all. So i guess if you can rule the fan manually, set it to full power and stress-test the hardware.</p><p>In the worst case(if the vendor is a total dick) - you can always resolder the fan to sata power connector or some other known good voltage. And use a cooling station.</p><p>BUT. That fan might not be enough, as i&#039;ve observed some cheap and 2-3 years old dells overheating from running a windows calculator calculating &quot;1000000!&quot;. The VM will use the hardware more intensely than running stuff bare-metal.</p> <p class="postedit"><em>Last edited by Duelist (2015-06-17 20:52:13)</em></p> </div> <div class="postsignature postmsg"><hr /><p><span class="bbs">The forum rules prohibit requesting support for distributions other than arch.</span><br /><a href="https://bbs.archlinux.org/viewtopic.php?pid=1551460#p1551460" rel="nofollow">I gave up.</a><a href="https://bbs.archlinux.org/viewtopic.php?id=162768" rel="nofollow"> It was too late.</a><br /><a href="http://pastebin.com/B3fL84bq" rel="nofollow">What I was trying to do</a>.<br /><a href="http://vfio.blogspot.com/" rel="nofollow">The reference about VFIO and KVM VGA passthrough.</a></p></div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1537693">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1537711" class="blockpost rowodd"> <h2><span><span class="conr">#5375</span> <a href="viewtopic.php?pid=1537711#p1537711">2015-06-17 21:43:09</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=86845">garnerlogan65</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2014-11-22</span></dd> <dd><span>Posts: 26</span></dd> <dd class="usercontacts"><span class="email"><a href="mailto:garnerlogan65@gmail.com">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <p>Alex, not sure if you got my email or not. VFIO is still not working properly, still missing some files. i know that VFIO is built as a module, as evidenced by running &quot;modinfo vfio&quot;. Not sure how to proceed.</p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1537711">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div class="postlinksb"> <div class="inbox crumbsplus"> <div class="pagepost"> <p class="pagelink conl"><span class="pages-label">Pages: </span><a rel="prev" class="item1" href="viewtopic.php?id=162768&amp;p=214">Previous</a> <a href="viewtopic.php?id=162768">1</a> <span class="spacer">…</span> <a href="viewtopic.php?id=162768&amp;p=213">213</a> <a href="viewtopic.php?id=162768&amp;p=214">214</a> <strong>215</strong> <a href="viewtopic.php?id=162768&amp;p=216">216</a> <a href="viewtopic.php?id=162768&amp;p=217">217</a> <span class="spacer">…</span> <a href="viewtopic.php?id=162768&amp;p=234">234</a> <a rel="next" href="viewtopic.php?id=162768&amp;p=216">Next</a></p> <p class="postlink conr">Topic closed</p> </div> <ul class="crumbs"> <li><a href="index.php">Index</a></li> <li><span>»&#160;</span><a href="viewforum.php?id=48">Topics Going Nowhere</a></li> <li><span>»&#160;</span><strong><a href="viewtopic.php?id=162768">KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</a></strong></li> </ul> <p class="subscribelink clearb"><a href="misc.php?action=subscribe&amp;tid=162768">Subscribe to this topic</a></p> <div class="clearer"></div> </div> </div> </div> <div id="brdfooter" class="block"> <h2><span>Board footer</span></h2> <div class="box"> <div id="brdfooternav" class="inbox"> <div class="conl"> <form id="qjump" method="get" action="viewforum.php"> <div><label><span>Jump to<br /></span> <select name="id" onchange="window.location=('viewforum.php?id='+this.options[this.selectedIndex].value)"> <optgroup label="Technical Issues and Assistance"> <option value="23">Newbie Corner</option> <option value="17">Installation</option> <option value="22">Kernel &amp; Hardware</option> <option value="18">Applications &amp; Desktop Environments</option> <option value="31">Laptop Issues</option> <option value="8">Networking, Server, and Protection</option> <option value="32">Multimedia and Games</option> <option value="50">System Administration</option> <option value="35">Other Architectures</option> </optgroup> <optgroup label="Arch-centric"> <option value="24">Announcements, Package &amp; Security Advisories</option> <option value="1">Arch Discussion</option> <option value="13">Forum &amp; Wiki discussion</option> </optgroup> <optgroup label="Pacman Upgrades, Packaging &amp; AUR"> <option value="44">Pacman &amp; Package Upgrade Issues</option> <option value="49">[testing] Repo Forum</option> <option value="4">Creating &amp; Modifying Packages</option> <option value="38">AUR Issues, Discussion &amp; PKGBUILD Requests</option> </optgroup> <optgroup label="Contributions &amp; Discussion"> <option value="20">GNU/Linux Discussion</option> <option value="27">Community Contributions</option> <option value="33">Programming &amp; Scripting</option> <option value="30">Other Languages</option> <option value="47">Artwork and Screenshots</option> <option value="42">Try This</option> </optgroup> <optgroup label="/dev/null"> <option value="29">Off-Topic</option> <option value="48" selected="selected">Topics Going Nowhere</option> <option value="36">Dustbin</option> </optgroup> </select></label> <input type="submit" value=" Go " accesskey="g" /> </div> </form> </div> <div class="conr"> <p id="feedlinks"><span class="atom"><a href="extern.php?action=feed&amp;tid=162768&amp;type=atom">Atom topic feed</a></span></p> <p id="poweredby">Powered by <a href="http://fluxbb.org/">FluxBB</a></p> </div> <div class="clearer"></div> </div> </div> </div> </div> <div class="end-box"></div> </div> </body> </html>
