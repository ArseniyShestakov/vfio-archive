<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"> <html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en" dir="ltr"> <head> <meta http-equiv="Content-Type" content="text/html; charset=utf-8" /> <title>KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9 (Page 213) / Topics Going Nowhere / Arch Linux Forums</title> <link rel="stylesheet" type="text/css" href="style/ArchLinux.css" /> <link rel="canonical" href="viewtopic.php?id=162768&amp;p=213" title="Page 213" /> <link rel="prev" href="viewtopic.php?id=162768&amp;p=212" title="Page 212" /> <link rel="next" href="viewtopic.php?id=162768&amp;p=214" title="Page 214" /> <link rel="alternate" type="application/atom+xml" href="extern.php?action=feed&amp;tid=162768&amp;type=atom" title="Atom topic feed" /> <link rel="stylesheet" media="screen" href="style/ArchLinux/arch.css?v=3" /> <link rel="stylesheet" media="screen" href="style/ArchLinux/archnavbar.css?v=2" /> <link rel="shortcut icon" href="style/ArchLinux/favicon.ico" /> </head> <body> <div id="archnavbar" class="anb-forum"> <div id="archnavbarlogo"><h1><a href="http://www.archlinux.org/">Arch Linux</a></h1></div> <div id="archnavbarmenu"> <ul id="archnavbarlist"> <li id="anb-home"><a href="http://www.archlinux.org/">Home</a></li><li id="anb-packages"><a href="http://www.archlinux.org/packages/">Packages</a></li><li id="anb-forums" class="anb-selected"><a href="https://bbs.archlinux.org/">Forums</a></li><li id="anb-wiki"><a href="https://wiki.archlinux.org/">Wiki</a></li><li id="anb-bugs"><a href="https://bugs.archlinux.org/">Bugs</a></li><li id="anb-aur"><a href="https://aur.archlinux.org/">AUR</a></li><li id="anb-download"><a href="http://www.archlinux.org/download/">Download</a></li> </ul> </div> </div> <div id="punviewtopic" class="pun"> <div class="top-box"></div> <div class="punwrap"> <div id="brdheader" class="block"> <div class="box"> <div id="brdmenu" class="inbox"> <ul> <li id="navindex" class="isactive"><a href="index.php">Index</a></li> <li id="navuserlist"><a href="userlist.php">User list</a></li> <li id="navsearch"><a href="search.php">Search</a></li> <li id="navprofile"><a href="profile.php?id=80749">Profile</a></li> <li id="navlogout"><a href="login.php?action=out&amp;id=80749&amp;csrf_token=5c20501ec397bb45ef8ee8c84db232c8d8e421c6">Logout</a></li> </ul> </div> <div id="brdwelcome" class="inbox"> <ul class="conl"> <li><span>Logged in as <strong>SXX</strong></span></li> <li><span>Last visit: 2015-08-16 12:20:09</span></li> </ul> <ul class="conr"> <li><span>Topics: <a href="search.php?action=show_replies" title="Find topics you have posted to.">Posted</a> | <a href="search.php?action=show_new" title="Find topics with new posts since your last visit.">New</a> | <a href="search.php?action=show_recent" title="Find topics with recent posts.">Active</a> | <a href="search.php?action=show_unanswered" title="Find topics with no replies.">Unanswered</a></span></li> </ul> <div class="clearer"></div> </div> </div> </div> <div id="brdmain"> <div class="linkst"> <div class="inbox crumbsplus"> <ul class="crumbs"> <li><a href="index.php">Index</a></li> <li><span>»&#160;</span><a href="viewforum.php?id=48">Topics Going Nowhere</a></li> <li><span>»&#160;</span><strong><a href="viewtopic.php?id=162768">KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</a></strong></li> </ul> <div class="pagepost"> <p class="pagelink conl"><span class="pages-label">Pages: </span><a rel="prev" class="item1" href="viewtopic.php?id=162768&amp;p=212">Previous</a> <a href="viewtopic.php?id=162768">1</a> <span class="spacer">…</span> <a href="viewtopic.php?id=162768&amp;p=211">211</a> <a href="viewtopic.php?id=162768&amp;p=212">212</a> <strong>213</strong> <a href="viewtopic.php?id=162768&amp;p=214">214</a> <a href="viewtopic.php?id=162768&amp;p=215">215</a> <span class="spacer">…</span> <a href="viewtopic.php?id=162768&amp;p=234">234</a> <a rel="next" href="viewtopic.php?id=162768&amp;p=214">Next</a></p> <p class="postlink conr">Topic closed</p> </div> <div class="clearer"></div> </div> </div> <div id="p1535351" class="blockpost rowodd blockpost1"> <h2><span><span class="conr">#5301</span> <a href="viewtopic.php?pid=1535351#p1535351">2015-06-08 07:21:23</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=91723">supertrampx</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2015-06-07</span></dd> <dd><span>Posts: 11</span></dd> <dd class="usercontacts"><span class="email"><a href="mailto:joe.cayouette@gmail.com">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <p>Thanks for tips Nesousx I will give it a shot when I am off work this evening. This forum post is amazing <img src="https://bbs.archlinux.org/img/smilies/smile.png" width="15" height="15" alt="smile" /> Respect for everyone who put in the time here.</p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1535351">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1535373" class="blockpost roweven"> <h2><span><span class="conr">#5302</span> <a href="viewtopic.php?pid=1535373#p1535373">2015-06-08 10:03:46</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=89552">lersek</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2015-03-15</span></dd> <dd><span>Posts: 34</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=89552">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>Duelist wrote:</cite><blockquote><div><div class="quotebox"><cite>lersek wrote:</cite><blockquote><div><p>The second quote makes no sense because GOPs are exposed by, and are the standard interface of, device-specific UEFI video drivers. A UEFI GOP does not exist without a device-specific UEFI driver; at worst you can say that the actual driver is low quality or generic, because, while it recognizes the video card, it cannot utilize its full capabilities.</p></div></blockquote></div><p>Who writes those UEFI drivers? Firmware-engineers(ASUS, Gigabyte, guys who produce the motherboards, etc.), vendors of the devices(EVGA, Sapphire, guys that don&#039;t produce motherboards etc.) or AMD/Intel themselves? Where they are stored? Are they hidden somewhere in the firmware(UEFI), or in the device ROM? If it&#039;s an intel iGPU, where that ROM with the device driver is located, as i can&#039;t recall intel GPUs being listed as a regular PCI device?</p></div></blockquote></div><p>From a UEFI perspective, it doesn&#039;t matter where the UEFI driver binary comes from. It can be part of the system flash chip (soldered to the motherboard), it can be part of the PCI oprom (in case of a discrete graphics card), but you can also load it from a FAT32 filesystem (eg. USB pendrive or EFI system partition), from the UEFI shell, or with a Driver#### variable.</p><p>In practice, for discrete graphics card, &quot;PCI oprom&quot; is the only sensible answer -- ie. you get the driver when you buy the card. For integrated graphics cards, I think it&#039;s usually part of the system firmware.</p><div class="quotebox"><blockquote><div><p>And..<br />Why does emulated QXL can&#039;t go beyond 1024x768... even with an extended amount of VRAM given?</p></div></blockquote></div><p>The UEFI GOP installed for QXL can very well go beyond 1024x768. You can see the supported resolutions here:</p><p><a href="https://github.com/tianocore/edk2/blob/master/OvmfPkg/QemuVideoDxe/Initialize.c#L211" rel="nofollow">https://github.com/tianocore/edk2/blob/ … ize.c#L211</a></p><p>I use QXL resolutions higher than 1024x768 in my guests all the time.</p><p>I think you are conflating two things here. The 1024x768 resolution limit is in place for *Windows 7* only, and that&#039;s because Windows 7 is *not* a UEFI operating system when it comes to its builtin video driver. Windows 7 will boot on a UEFI platform, yes, even without a CSM, but its builtin video driver is broken in the sense that it will *only* look for the legacy video bios services (the VBE, VESA BIOS Extansion). It won&#039;t even look for a preconfigured framebuffer, it *insists* on the legacy BIOS video services (Int10h). A fully conformant UEFI operating system is not permitted to do this, and this is also why you can run Windows 7 on physical UEFI platforms only if you enter the UEFI setup utility during boot, and enable the CSM or &quot;VBIOS&quot; support or whatever the vendor in question calls it.</p><p>We disliked Windows 7&#039;s dependency on a full-blown CSM, and worked around it in OVMF. Namely, OVMF&#039;s video driver provides, fully independently of the multi-resolution UEFI GOP, a very limited VESA BIOS Extension too, even without incorporating the CSM. We call this the &quot;Int10h shim&quot;. It is a shim because it provides a minimal set of VBE services, which are expected to be interpreted *only* by the Windows 7 real mode emulator. It is written in assembly, and it is placed in memory, and provides only the services, so that Windows 7 can be installed.</p><p><a href="https://github.com/tianocore/edk2/blob/master/OvmfPkg/QemuVideoDxe/VbeShim.asm" rel="nofollow">https://github.com/tianocore/edk2/blob/ … beShim.asm</a><br /><a href="https://github.com/tianocore/edk2/blob/master/OvmfPkg/QemuVideoDxe/VbeShim.sh" rel="nofollow">https://github.com/tianocore/edk2/blob/ … VbeShim.sh</a><br /><a href="https://github.com/tianocore/edk2/blob/master/OvmfPkg/QemuVideoDxe/VbeShim.c" rel="nofollow">https://github.com/tianocore/edk2/blob/ … /VbeShim.c</a><br /><a href="https://github.com/tianocore/edk2/blob/master/OvmfPkg/QemuVideoDxe/VbeShim.h" rel="nofollow">https://github.com/tianocore/edk2/blob/ … /VbeShim.h</a></p><p>Summary: the UEFI GOP that OVMF provides for QXL has a nice list of resolutions, dependent on QXL vram size, and it is available to *actually* UEFI compliant OSes, like many Linux versions and Windows 8 and later. Windows 7 is not such an operating system, it cannot use the GOP, it insists on legacy video BIOS services, hence OVMF fakes the absolute minimum of legacy video BIOS services just for Windows 7&#039;s sake, even if you build OVMF without a CSM. This &quot;fake&quot; is called the Int10h shim, and the resolution limitation pertains only to the Int10h shim, not the UEFI GOP.</p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1535373">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1535417" class="blockpost rowodd"> <h2><span><span class="conr">#5303</span> <a href="viewtopic.php?pid=1535417#p1535417">2015-06-08 14:24:18</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=85314">Duelist</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2014-09-22</span></dd> <dd><span>Posts: 358</span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <p>@lersek: Well, that clears up a lot...<br />And how do i change the display resolution initiated by OVMF? Some EFI shell command, i guess?<br />I just remember the time i&#039;ve tried to install windows8 - it inherited that 1024x768 mode from OVMF, and there was a huge fail, because it couldn&#039;t raise the resolution and refused to launch internet exploder due to low resolution, and there was no way of downloading the proper drivers without using some external storage.</p><p>And what about... the installation disc? Windows7 seems to work fine while you&#039;re installing it(so i guess it inherits the videomode from OVMF, and works with GOP), but when the installation is done and it&#039;s time to show that colourful 4-piece logo animation - it hangs. Maybe there are multiple videodrivers, and we can swap them?</p><p>...hmm, it&#039;s possible to load the EFI driver from a fat32 partition.. I guess the file should be .efi, and i must load it manually from the UEFI-shell.. Since i have a modified ROM for my asus cards which has an almost 3rd party EFI-driver embedded in it, maybe i wouldn&#039;t need it.. Still haven&#039;t flashed it physically, heh.</p> <p class="postedit"><em>Last edited by Duelist (2015-06-08 14:34:07)</em></p> </div> <div class="postsignature postmsg"><hr /><p><span class="bbs">The forum rules prohibit requesting support for distributions other than arch.</span><br /><a href="https://bbs.archlinux.org/viewtopic.php?pid=1551460#p1551460" rel="nofollow">I gave up.</a><a href="https://bbs.archlinux.org/viewtopic.php?id=162768" rel="nofollow"> It was too late.</a><br /><a href="http://pastebin.com/B3fL84bq" rel="nofollow">What I was trying to do</a>.<br /><a href="http://vfio.blogspot.com/" rel="nofollow">The reference about VFIO and KVM VGA passthrough.</a></p></div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1535417">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1535489" class="blockpost roweven"> <h2><span><span class="conr">#5304</span> <a href="viewtopic.php?pid=1535489#p1535489">2015-06-08 18:10:03</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=91723">supertrampx</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2015-06-07</span></dd> <dd><span>Posts: 11</span></dd> <dd class="usercontacts"><span class="email"><a href="mailto:joe.cayouette@gmail.com">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <p>Many thanks to Nesousx first for his awesome fix.<br />I was able to successfully boot windows today, with networking, usb keyboard and mouse. I installed the Nvidia 970gtx drivers and have some white lines running across the screen. Anything I can do to fix this?</p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1535489">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1535536" class="blockpost rowodd"> <h2><span><span class="conr">#5305</span> <a href="viewtopic.php?pid=1535536#p1535536">2015-06-08 20:32:14</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=89552">lersek</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2015-03-15</span></dd> <dd><span>Posts: 34</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=89552">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>Duelist wrote:</cite><blockquote><div><p>@lersek: Well, that clears up a lot...<br />And how do i change the display resolution initiated by OVMF? Some EFI shell command, i guess?</p></div></blockquote></div><p>IIRC this has been discussed before. It&#039;s certainly described in the OVMF whitepaper, subsection &quot;Platform Driver&quot;. Press ESC at the TianoCore splash screen, Navigate to Device Manager | OVMF Platform Configuration, select the preferred resolution from the drop-down list, commit changes, then reboot. (You can reboot by: (a) forcing it from the qemu monitor or virt-manager, (b), going to the EFI shell and issuing &quot;reset -c&quot;, (c) going to Boot Maintenance Manager and selecting Reset System.)</p><div class="quotebox"><blockquote><div><p>I just remember the time i&#039;ve tried to install windows8 - it inherited that 1024x768 mode from OVMF, and there was a huge fail, because it couldn&#039;t raise the resolution and refused to launch internet exploder due to low resolution, and there was no way of downloading the proper drivers without using some external storage.</p></div></blockquote></div><p>Correct. That&#039;s exactly the case when you change the resolution in the firmware as I described at the top.</p><div class="quotebox"><blockquote><div><p>And what about... the installation disc? Windows7 seems to work fine while you&#039;re installing it (so i guess it inherits the videomode from OVMF, and works with GOP)</p></div></blockquote></div><p>As long as the UEFI boot loader of Windows 7 (which is a UEFI application) is running, it uses the GOP natively. It could even switch resolutions if it wanted to.</p><div class="quotebox"><blockquote><div><p>but when the installation is done and it&#039;s time to show that colourful 4-piece logo animation - it hangs.</p></div></blockquote></div><p>That&#039;s when the handover to the runtime OS happens, and the builtin kernel mode video driver takes control. It does not hang (it should not, anyway).</p><p>Instead, on a BIOS machine (or a UEFI+CSM machine), you&#039;d see a 640x480, 16 color, planar VGA mode. (The most basic VGA mode.) With some messages.</p><p>This planar VGA mode was way too complex to implement in the Int10h shim, so we return &quot;success&quot; for the request, but do nothing. (Search the ASM file linked earlier for &quot;SetModeLegacy&quot;.)</p><p>Two of us tried to implement this mode, but it&#039;s not really possible, because Windows 7 massages the legacy VGA CRTC registers manually, and seemed to interfere with whatever we tried to do. So, you get a blank screen, but it does not last long, and these screens are not interactive. At some point the builtin kernel mode video driver decides to look for VBE modes (better resolution, true color), and then it finds the &quot;fake&quot; 1024x768x32 mode, and asks the shim to switch to it. Which we do, and then you get the first green (or blue) screen (dependent on Windows Server 2008 R2 vs. Windows 7), with the mouse etc.</p><p>It might take a few tens of seconds for this screen to show up, especially if you have the guest on a spindle disk.</p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1535536">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1535584" class="blockpost roweven"> <h2><span><span class="conr">#5306</span> <a href="viewtopic.php?pid=1535584#p1535584">2015-06-09 00:48:38</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=85314">Duelist</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2014-09-22</span></dd> <dd><span>Posts: 358</span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>lersek wrote:</cite><blockquote><div><p>As long as the UEFI boot loader of Windows 7 (which is a UEFI application) is running, it uses the GOP natively. It could even switch resolutions if it wanted to.</p></div></blockquote></div><div class="quotebox"><cite>lersek wrote:</cite><blockquote><div><div class="quotebox"><blockquote><div><p>but when the installation is done and it&#039;s time to show that colourful 4-piece logo animation - it hangs.</p></div></blockquote></div><p>That&#039;s when the handover to the runtime OS happens, and the builtin kernel mode video driver takes control. It does not hang (it should not, anyway).</p></div></blockquote></div><p>So there&#039;s two possible ways of &quot;patching&quot; windows 7:<br />1. Changing the bootloader to something else. As i feel it(yep, i have a strange feeling not based on any research) the windows setup and the windows core don&#039;t differ much, and it may be possible to swap them. Also, maybe there&#039;s some weird third-party-influenced way of loading the windows, but that&#039;s way beyond our scope... and win10 is coming, so win7 is becoming obsolete in some years.<br />2. Changing the &quot;builtin kernel mode video driver&quot;, as you&#039;ve called it. That should be somewhat more simple, as i remember some OEM reinstall images for certain notebooks which had a system image with GPU drivers incorporated into them.</p><p>Any suggestions? Maybe i&#039;ll take a look on that, but i&#039;m just somewhat busy with the life, books and installing gentoo into a prefix to install gentoo on rasp.pi...</p> </div> <div class="postsignature postmsg"><hr /><p><span class="bbs">The forum rules prohibit requesting support for distributions other than arch.</span><br /><a href="https://bbs.archlinux.org/viewtopic.php?pid=1551460#p1551460" rel="nofollow">I gave up.</a><a href="https://bbs.archlinux.org/viewtopic.php?id=162768" rel="nofollow"> It was too late.</a><br /><a href="http://pastebin.com/B3fL84bq" rel="nofollow">What I was trying to do</a>.<br /><a href="http://vfio.blogspot.com/" rel="nofollow">The reference about VFIO and KVM VGA passthrough.</a></p></div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1535584">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1536017" class="blockpost rowodd"> <h2><span><span class="conr">#5307</span> <a href="viewtopic.php?pid=1536017#p1536017">2015-06-10 17:13:33</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=71471">dRaiser</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>From: Poland</span></dd> <dd><span>Registered: 2013-05-20</span></dd> <dd><span>Posts: 49</span></dd> <dd class="usercontacts"><span class="email"><a href="mailto:pw@draiser.net">Email</a></span> <span class="website"><a href="http://draiser.net/en" rel="nofollow">Website</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <p>Hi. I&#039;ve finally changed my guest GPU - temporarily to GTX 960, from Radeon 4850. Coming from Radeon I knew that it wouldn&#039;t work without problems - but I can&#039;t overcome them at this moment. I got dreaded &#039;Code 43&#039; on Nvidia GPU. I&#039;ve disabled hyperv extensions and set kvm hidden state to off. I&#039;m now checking if kernel update to linux-vfio could help with anything, but it would be great if you could give me some tips.</p><p>I use Nvidia 9800 GTX+ with nvidia blob for host, have i3-550 CPU and AsRock Z77 Extreme4. All kvm-related things enabled (as I was running it properly with Radeon working on machine). I have 8 GiB total and 3 passed for machine. </p><p>960 GPU plus it&#039;s audio adapter are in pci-stubs and added to machine config.</p><div class="codebox"><pre class="vscroll"><code>&lt;domain type=&#039;kvm&#039;&gt; &lt;name&gt;wintendo&lt;/name&gt; &lt;uuid&gt;bf6bda0e-2664-4bab-998a-aac4dc255c83&lt;/uuid&gt; &lt;memory unit=&#039;KiB&#039;&gt;3145728&lt;/memory&gt; &lt;currentMemory unit=&#039;KiB&#039;&gt;3145728&lt;/currentMemory&gt; &lt;vcpu placement=&#039;static&#039;&gt;3&lt;/vcpu&gt; &lt;os&gt; &lt;type arch=&#039;x86_64&#039; machine=&#039;pc-i440fx-2.1&#039;&gt;hvm&lt;/type&gt; &lt;boot dev=&#039;hd&#039;/&gt; &lt;/os&gt; &lt;features&gt; &lt;acpi/&gt; &lt;apic/&gt; &lt;pae/&gt; &lt;kvm&gt; &lt;hidden state=&#039;on&#039;/&gt; &lt;/kvm&gt; &lt;/features&gt; &lt;cpu mode=&#039;custom&#039; match=&#039;exact&#039;&gt; &lt;model fallback=&#039;allow&#039;&gt;SandyBridge&lt;/model&gt; &lt;vendor&gt;Intel&lt;/vendor&gt; &lt;topology sockets=&#039;1&#039; cores=&#039;3&#039; threads=&#039;1&#039;/&gt; &lt;feature policy=&#039;require&#039; name=&#039;vme&#039;/&gt; &lt;feature policy=&#039;require&#039; name=&#039;dtes64&#039;/&gt; &lt;feature policy=&#039;require&#039; name=&#039;vmx&#039;/&gt; &lt;feature policy=&#039;require&#039; name=&#039;erms&#039;/&gt; &lt;feature policy=&#039;require&#039; name=&#039;xtpr&#039;/&gt; &lt;feature policy=&#039;require&#039; name=&#039;smep&#039;/&gt; &lt;feature policy=&#039;require&#039; name=&#039;pcid&#039;/&gt; &lt;feature policy=&#039;require&#039; name=&#039;est&#039;/&gt; &lt;feature policy=&#039;require&#039; name=&#039;monitor&#039;/&gt; &lt;feature policy=&#039;require&#039; name=&#039;smx&#039;/&gt; &lt;feature policy=&#039;require&#039; name=&#039;tm&#039;/&gt; &lt;feature policy=&#039;require&#039; name=&#039;acpi&#039;/&gt; &lt;feature policy=&#039;require&#039; name=&#039;osxsave&#039;/&gt; &lt;feature policy=&#039;require&#039; name=&#039;ht&#039;/&gt; &lt;feature policy=&#039;require&#039; name=&#039;pdcm&#039;/&gt; &lt;feature policy=&#039;require&#039; name=&#039;fsgsbase&#039;/&gt; &lt;feature policy=&#039;require&#039; name=&#039;f16c&#039;/&gt; &lt;feature policy=&#039;require&#039; name=&#039;ds&#039;/&gt; &lt;feature policy=&#039;require&#039; name=&#039;invtsc&#039;/&gt; &lt;feature policy=&#039;require&#039; name=&#039;tm2&#039;/&gt; &lt;feature policy=&#039;require&#039; name=&#039;ss&#039;/&gt; &lt;feature policy=&#039;require&#039; name=&#039;pbe&#039;/&gt; &lt;feature policy=&#039;require&#039; name=&#039;ds_cpl&#039;/&gt; &lt;feature policy=&#039;require&#039; name=&#039;rdrand&#039;/&gt; &lt;/cpu&gt; &lt;clock offset=&#039;localtime&#039;&gt; &lt;timer name=&#039;rtc&#039; tickpolicy=&#039;catchup&#039;/&gt; &lt;timer name=&#039;pit&#039; tickpolicy=&#039;delay&#039;/&gt; &lt;/clock&gt; &lt;on_poweroff&gt;destroy&lt;/on_poweroff&gt; &lt;on_reboot&gt;restart&lt;/on_reboot&gt; &lt;on_crash&gt;restart&lt;/on_crash&gt; &lt;pm&gt; &lt;suspend-to-mem enabled=&#039;no&#039;/&gt; &lt;suspend-to-disk enabled=&#039;no&#039;/&gt; &lt;/pm&gt; &lt;devices&gt; &lt;emulator&gt;/usr/sbin/qemu-system-x86_64&lt;/emulator&gt; &lt;disk type=&#039;block&#039; device=&#039;cdrom&#039;&gt; &lt;driver name=&#039;qemu&#039; type=&#039;raw&#039;/&gt; &lt;source dev=&#039;/dev/sr0&#039;/&gt; &lt;target dev=&#039;hdb&#039; bus=&#039;ide&#039;/&gt; &lt;readonly/&gt; &lt;address type=&#039;drive&#039; controller=&#039;0&#039; bus=&#039;0&#039; target=&#039;0&#039; unit=&#039;1&#039;/&gt; &lt;/disk&gt; &lt;disk type=&#039;file&#039; device=&#039;disk&#039;&gt; &lt;driver name=&#039;qemu&#039; type=&#039;raw&#039;/&gt; &lt;source file=&#039;/mnt/d2/50.raw&#039;/&gt; &lt;target dev=&#039;vdd&#039; bus=&#039;virtio&#039;/&gt; &lt;address type=&#039;pci&#039; domain=&#039;0x0000&#039; bus=&#039;0x00&#039; slot=&#039;0x0a&#039; function=&#039;0x0&#039;/&gt; &lt;/disk&gt; &lt;disk type=&#039;file&#039; device=&#039;disk&#039;&gt; &lt;driver name=&#039;qemu&#039; type=&#039;raw&#039;/&gt; &lt;source file=&#039;/mnt/d2/d2.img&#039;/&gt; &lt;target dev=&#039;vde&#039; bus=&#039;virtio&#039;/&gt; &lt;address type=&#039;pci&#039; domain=&#039;0x0000&#039; bus=&#039;0x00&#039; slot=&#039;0x09&#039; function=&#039;0x0&#039;/&gt; &lt;/disk&gt; &lt;controller type=&#039;usb&#039; index=&#039;0&#039; model=&#039;ich9-ehci1&#039;&gt; &lt;address type=&#039;pci&#039; domain=&#039;0x0000&#039; bus=&#039;0x00&#039; slot=&#039;0x05&#039; function=&#039;0x7&#039;/&gt; &lt;/controller&gt; &lt;controller type=&#039;usb&#039; index=&#039;0&#039; model=&#039;ich9-uhci1&#039;&gt; &lt;master startport=&#039;0&#039;/&gt; &lt;address type=&#039;pci&#039; domain=&#039;0x0000&#039; bus=&#039;0x00&#039; slot=&#039;0x05&#039; function=&#039;0x0&#039; multifunction=&#039;on&#039;/&gt; &lt;/controller&gt; &lt;controller type=&#039;usb&#039; index=&#039;0&#039; model=&#039;ich9-uhci2&#039;&gt; &lt;master startport=&#039;2&#039;/&gt; &lt;address type=&#039;pci&#039; domain=&#039;0x0000&#039; bus=&#039;0x00&#039; slot=&#039;0x05&#039; function=&#039;0x1&#039;/&gt; &lt;/controller&gt; &lt;controller type=&#039;usb&#039; index=&#039;0&#039; model=&#039;ich9-uhci3&#039;&gt; &lt;master startport=&#039;4&#039;/&gt; &lt;address type=&#039;pci&#039; domain=&#039;0x0000&#039; bus=&#039;0x00&#039; slot=&#039;0x05&#039; function=&#039;0x2&#039;/&gt; &lt;/controller&gt; &lt;controller type=&#039;pci&#039; index=&#039;0&#039; model=&#039;pci-root&#039;/&gt; &lt;controller type=&#039;ide&#039; index=&#039;0&#039;&gt; &lt;address type=&#039;pci&#039; domain=&#039;0x0000&#039; bus=&#039;0x00&#039; slot=&#039;0x01&#039; function=&#039;0x1&#039;/&gt; &lt;/controller&gt; &lt;controller type=&#039;virtio-serial&#039; index=&#039;0&#039;&gt; &lt;address type=&#039;pci&#039; domain=&#039;0x0000&#039; bus=&#039;0x00&#039; slot=&#039;0x06&#039; function=&#039;0x0&#039;/&gt; &lt;/controller&gt; &lt;interface type=&#039;bridge&#039;&gt; &lt;mac address=&#039;52:54:00:17:65:a1&#039;/&gt; &lt;source bridge=&#039;br0&#039;/&gt; &lt;model type=&#039;rtl8139&#039;/&gt; &lt;address type=&#039;pci&#039; domain=&#039;0x0000&#039; bus=&#039;0x00&#039; slot=&#039;0x03&#039; function=&#039;0x0&#039;/&gt; &lt;/interface&gt; &lt;serial type=&#039;pty&#039;&gt; &lt;target port=&#039;0&#039;/&gt; &lt;/serial&gt; &lt;console type=&#039;pty&#039;&gt; &lt;target type=&#039;serial&#039; port=&#039;0&#039;/&gt; &lt;/console&gt; &lt;channel type=&#039;spicevmc&#039;&gt; &lt;target type=&#039;virtio&#039; name=&#039;com.redhat.spice.0&#039;/&gt; &lt;address type=&#039;virtio-serial&#039; controller=&#039;0&#039; bus=&#039;0&#039; port=&#039;1&#039;/&gt; &lt;/channel&gt; &lt;input type=&#039;tablet&#039; bus=&#039;usb&#039;/&gt; &lt;input type=&#039;mouse&#039; bus=&#039;ps2&#039;/&gt; &lt;input type=&#039;keyboard&#039; bus=&#039;ps2&#039;/&gt; &lt;graphics type=&#039;spice&#039; autoport=&#039;yes&#039;/&gt; &lt;video&gt; &lt;model type=&#039;cirrus&#039; vram=&#039;16384&#039; heads=&#039;1&#039;/&gt; &lt;address type=&#039;pci&#039; domain=&#039;0x0000&#039; bus=&#039;0x00&#039; slot=&#039;0x02&#039; function=&#039;0x0&#039;/&gt; &lt;/video&gt; &lt;hostdev mode=&#039;subsystem&#039; type=&#039;pci&#039; managed=&#039;yes&#039;&gt; &lt;source&gt; &lt;address domain=&#039;0x0000&#039; bus=&#039;0x02&#039; slot=&#039;0x00&#039; function=&#039;0x0&#039;/&gt; &lt;/source&gt; &lt;address type=&#039;pci&#039; domain=&#039;0x0000&#039; bus=&#039;0x00&#039; slot=&#039;0x08&#039; function=&#039;0x0&#039;/&gt; &lt;/hostdev&gt; &lt;hostdev mode=&#039;subsystem&#039; type=&#039;pci&#039; managed=&#039;yes&#039;&gt; &lt;source&gt; &lt;address domain=&#039;0x0000&#039; bus=&#039;0x00&#039; slot=&#039;0x1b&#039; function=&#039;0x0&#039;/&gt; &lt;/source&gt; &lt;address type=&#039;pci&#039; domain=&#039;0x0000&#039; bus=&#039;0x00&#039; slot=&#039;0x0b&#039; function=&#039;0x0&#039;/&gt; &lt;/hostdev&gt; &lt;hostdev mode=&#039;subsystem&#039; type=&#039;usb&#039; managed=&#039;yes&#039;&gt; &lt;source&gt; &lt;vendor id=&#039;0x045e&#039;/&gt; &lt;product id=&#039;0x0719&#039;/&gt; &lt;/source&gt; &lt;/hostdev&gt; &lt;hostdev mode=&#039;subsystem&#039; type=&#039;usb&#039; managed=&#039;yes&#039;&gt; &lt;source&gt; &lt;vendor id=&#039;0x1532&#039;/&gt; &lt;product id=&#039;0x0016&#039;/&gt; &lt;/source&gt; &lt;/hostdev&gt; &lt;hostdev mode=&#039;subsystem&#039; type=&#039;pci&#039; managed=&#039;yes&#039;&gt; &lt;source&gt; &lt;address domain=&#039;0x0000&#039; bus=&#039;0x02&#039; slot=&#039;0x00&#039; function=&#039;0x1&#039;/&gt; &lt;/source&gt; &lt;address type=&#039;pci&#039; domain=&#039;0x0000&#039; bus=&#039;0x00&#039; slot=&#039;0x04&#039; function=&#039;0x0&#039;/&gt; &lt;/hostdev&gt; &lt;redirdev bus=&#039;usb&#039; type=&#039;spicevmc&#039;&gt; &lt;/redirdev&gt; &lt;redirdev bus=&#039;usb&#039; type=&#039;spicevmc&#039;&gt; &lt;/redirdev&gt; &lt;redirdev bus=&#039;usb&#039; type=&#039;spicevmc&#039;&gt; &lt;/redirdev&gt; &lt;redirdev bus=&#039;usb&#039; type=&#039;spicevmc&#039;&gt; &lt;/redirdev&gt; &lt;memballoon model=&#039;virtio&#039;&gt; &lt;address type=&#039;pci&#039; domain=&#039;0x0000&#039; bus=&#039;0x00&#039; slot=&#039;0x07&#039; function=&#039;0x0&#039;/&gt; &lt;/memballoon&gt; &lt;/devices&gt; &lt;/domain&gt;</code></pre></div> <p class="postedit"><em>Last edited by dRaiser (2015-06-10 18:11:50)</em></p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1536017">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1536035" class="blockpost roweven"> <h2><span><span class="conr">#5308</span> <a href="viewtopic.php?pid=1536035#p1536035">2015-06-10 18:31:10</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=85314">Duelist</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2014-09-22</span></dd> <dd><span>Posts: 358</span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>dRaiser wrote:</cite><blockquote><div><p>Hi. I&#039;ve finally changed my guest GPU - temporarily to GTX 960, from Radeon 4850. Coming from Radeon I knew that it wouldn&#039;t work without problems - but I can&#039;t overcome them at this moment. I got dreaded &#039;Code 43&#039; on Nvidia GPU. I&#039;ve disabled hyperv extensions and set kvm hidden state to off. I&#039;m now checking if kernel update to linux-vfio could help with anything, but it would be great if you could give me some tips.</p><p>I use Nvidia 9800 GTX+ with nvidia blob for host, have i3-550 CPU and AsRock Z77 Extreme4. All kvm-related things enabled (as I was running it properly with Radeon working on machine). I have 8 GiB total and 3 passed for machine. </p><p>960 GPU plus it&#039;s audio adapter are in pci-stubs and added to machine config.</p><div class="codebox"><pre class="vscroll"><code>&lt;domain type=&#039;kvm&#039;&gt; &lt;name&gt;wintendo&lt;/name&gt; &lt;uuid&gt;bf6bda0e-2664-4bab-998a-aac4dc255c83&lt;/uuid&gt; &lt;memory unit=&#039;KiB&#039;&gt;3145728&lt;/memory&gt; &lt;currentMemory unit=&#039;KiB&#039;&gt;3145728&lt;/currentMemory&gt; &lt;vcpu placement=&#039;static&#039;&gt;3&lt;/vcpu&gt; &lt;os&gt; &lt;type arch=&#039;x86_64&#039; machine=&#039;pc-i440fx-2.1&#039;&gt;hvm&lt;/type&gt; &lt;boot dev=&#039;hd&#039;/&gt; &lt;/os&gt; &lt;features&gt; &lt;acpi/&gt; &lt;apic/&gt; &lt;pae/&gt; &lt;kvm&gt; &lt;hidden state=&#039;on&#039;/&gt; &lt;/kvm&gt; &lt;/features&gt; &lt;cpu mode=&#039;custom&#039; match=&#039;exact&#039;&gt; &lt;model fallback=&#039;allow&#039;&gt;SandyBridge&lt;/model&gt; &lt;vendor&gt;Intel&lt;/vendor&gt; &lt;topology sockets=&#039;1&#039; cores=&#039;3&#039; threads=&#039;1&#039;/&gt; &lt;feature policy=&#039;require&#039; name=&#039;vme&#039;/&gt; &lt;feature policy=&#039;require&#039; name=&#039;dtes64&#039;/&gt; &lt;feature policy=&#039;require&#039; name=&#039;vmx&#039;/&gt; &lt;feature policy=&#039;require&#039; name=&#039;erms&#039;/&gt; &lt;feature policy=&#039;require&#039; name=&#039;xtpr&#039;/&gt; &lt;feature policy=&#039;require&#039; name=&#039;smep&#039;/&gt; &lt;feature policy=&#039;require&#039; name=&#039;pcid&#039;/&gt; &lt;feature policy=&#039;require&#039; name=&#039;est&#039;/&gt; &lt;feature policy=&#039;require&#039; name=&#039;monitor&#039;/&gt; &lt;feature policy=&#039;require&#039; name=&#039;smx&#039;/&gt; &lt;feature policy=&#039;require&#039; name=&#039;tm&#039;/&gt; &lt;feature policy=&#039;require&#039; name=&#039;acpi&#039;/&gt; &lt;feature policy=&#039;require&#039; name=&#039;osxsave&#039;/&gt; &lt;feature policy=&#039;require&#039; name=&#039;ht&#039;/&gt; &lt;feature policy=&#039;require&#039; name=&#039;pdcm&#039;/&gt; &lt;feature policy=&#039;require&#039; name=&#039;fsgsbase&#039;/&gt; &lt;feature policy=&#039;require&#039; name=&#039;f16c&#039;/&gt; &lt;feature policy=&#039;require&#039; name=&#039;ds&#039;/&gt; &lt;feature policy=&#039;require&#039; name=&#039;invtsc&#039;/&gt; &lt;feature policy=&#039;require&#039; name=&#039;tm2&#039;/&gt; &lt;feature policy=&#039;require&#039; name=&#039;ss&#039;/&gt; &lt;feature policy=&#039;require&#039; name=&#039;pbe&#039;/&gt; &lt;feature policy=&#039;require&#039; name=&#039;ds_cpl&#039;/&gt; &lt;feature policy=&#039;require&#039; name=&#039;rdrand&#039;/&gt; &lt;/cpu&gt; &lt;clock offset=&#039;localtime&#039;&gt; &lt;timer name=&#039;rtc&#039; tickpolicy=&#039;catchup&#039;/&gt; &lt;timer name=&#039;pit&#039; tickpolicy=&#039;delay&#039;/&gt; &lt;/clock&gt; &lt;on_poweroff&gt;destroy&lt;/on_poweroff&gt; &lt;on_reboot&gt;restart&lt;/on_reboot&gt; &lt;on_crash&gt;restart&lt;/on_crash&gt; &lt;pm&gt; &lt;suspend-to-mem enabled=&#039;no&#039;/&gt; &lt;suspend-to-disk enabled=&#039;no&#039;/&gt; &lt;/pm&gt; &lt;devices&gt; &lt;emulator&gt;/usr/sbin/qemu-system-x86_64&lt;/emulator&gt; &lt;disk type=&#039;block&#039; device=&#039;cdrom&#039;&gt; &lt;driver name=&#039;qemu&#039; type=&#039;raw&#039;/&gt; &lt;source dev=&#039;/dev/sr0&#039;/&gt; &lt;target dev=&#039;hdb&#039; bus=&#039;ide&#039;/&gt; &lt;readonly/&gt; &lt;address type=&#039;drive&#039; controller=&#039;0&#039; bus=&#039;0&#039; target=&#039;0&#039; unit=&#039;1&#039;/&gt; &lt;/disk&gt; &lt;disk type=&#039;file&#039; device=&#039;disk&#039;&gt; &lt;driver name=&#039;qemu&#039; type=&#039;raw&#039;/&gt; &lt;source file=&#039;/mnt/d2/50.raw&#039;/&gt; &lt;target dev=&#039;vdd&#039; bus=&#039;virtio&#039;/&gt; &lt;address type=&#039;pci&#039; domain=&#039;0x0000&#039; bus=&#039;0x00&#039; slot=&#039;0x0a&#039; function=&#039;0x0&#039;/&gt; &lt;/disk&gt; &lt;disk type=&#039;file&#039; device=&#039;disk&#039;&gt; &lt;driver name=&#039;qemu&#039; type=&#039;raw&#039;/&gt; &lt;source file=&#039;/mnt/d2/d2.img&#039;/&gt; &lt;target dev=&#039;vde&#039; bus=&#039;virtio&#039;/&gt; &lt;address type=&#039;pci&#039; domain=&#039;0x0000&#039; bus=&#039;0x00&#039; slot=&#039;0x09&#039; function=&#039;0x0&#039;/&gt; &lt;/disk&gt; &lt;controller type=&#039;usb&#039; index=&#039;0&#039; model=&#039;ich9-ehci1&#039;&gt; &lt;address type=&#039;pci&#039; domain=&#039;0x0000&#039; bus=&#039;0x00&#039; slot=&#039;0x05&#039; function=&#039;0x7&#039;/&gt; &lt;/controller&gt; &lt;controller type=&#039;usb&#039; index=&#039;0&#039; model=&#039;ich9-uhci1&#039;&gt; &lt;master startport=&#039;0&#039;/&gt; &lt;address type=&#039;pci&#039; domain=&#039;0x0000&#039; bus=&#039;0x00&#039; slot=&#039;0x05&#039; function=&#039;0x0&#039; multifunction=&#039;on&#039;/&gt; &lt;/controller&gt; &lt;controller type=&#039;usb&#039; index=&#039;0&#039; model=&#039;ich9-uhci2&#039;&gt; &lt;master startport=&#039;2&#039;/&gt; &lt;address type=&#039;pci&#039; domain=&#039;0x0000&#039; bus=&#039;0x00&#039; slot=&#039;0x05&#039; function=&#039;0x1&#039;/&gt; &lt;/controller&gt; &lt;controller type=&#039;usb&#039; index=&#039;0&#039; model=&#039;ich9-uhci3&#039;&gt; &lt;master startport=&#039;4&#039;/&gt; &lt;address type=&#039;pci&#039; domain=&#039;0x0000&#039; bus=&#039;0x00&#039; slot=&#039;0x05&#039; function=&#039;0x2&#039;/&gt; &lt;/controller&gt; &lt;controller type=&#039;pci&#039; index=&#039;0&#039; model=&#039;pci-root&#039;/&gt; &lt;controller type=&#039;ide&#039; index=&#039;0&#039;&gt; &lt;address type=&#039;pci&#039; domain=&#039;0x0000&#039; bus=&#039;0x00&#039; slot=&#039;0x01&#039; function=&#039;0x1&#039;/&gt; &lt;/controller&gt; &lt;controller type=&#039;virtio-serial&#039; index=&#039;0&#039;&gt; &lt;address type=&#039;pci&#039; domain=&#039;0x0000&#039; bus=&#039;0x00&#039; slot=&#039;0x06&#039; function=&#039;0x0&#039;/&gt; &lt;/controller&gt; &lt;interface type=&#039;bridge&#039;&gt; &lt;mac address=&#039;52:54:00:17:65:a1&#039;/&gt; &lt;source bridge=&#039;br0&#039;/&gt; &lt;model type=&#039;rtl8139&#039;/&gt; &lt;address type=&#039;pci&#039; domain=&#039;0x0000&#039; bus=&#039;0x00&#039; slot=&#039;0x03&#039; function=&#039;0x0&#039;/&gt; &lt;/interface&gt; &lt;serial type=&#039;pty&#039;&gt; &lt;target port=&#039;0&#039;/&gt; &lt;/serial&gt; &lt;console type=&#039;pty&#039;&gt; &lt;target type=&#039;serial&#039; port=&#039;0&#039;/&gt; &lt;/console&gt; &lt;channel type=&#039;spicevmc&#039;&gt; &lt;target type=&#039;virtio&#039; name=&#039;com.redhat.spice.0&#039;/&gt; &lt;address type=&#039;virtio-serial&#039; controller=&#039;0&#039; bus=&#039;0&#039; port=&#039;1&#039;/&gt; &lt;/channel&gt; &lt;input type=&#039;tablet&#039; bus=&#039;usb&#039;/&gt; &lt;input type=&#039;mouse&#039; bus=&#039;ps2&#039;/&gt; &lt;input type=&#039;keyboard&#039; bus=&#039;ps2&#039;/&gt; &lt;graphics type=&#039;spice&#039; autoport=&#039;yes&#039;/&gt; &lt;video&gt; &lt;model type=&#039;cirrus&#039; vram=&#039;16384&#039; heads=&#039;1&#039;/&gt; &lt;address type=&#039;pci&#039; domain=&#039;0x0000&#039; bus=&#039;0x00&#039; slot=&#039;0x02&#039; function=&#039;0x0&#039;/&gt; &lt;/video&gt; &lt;hostdev mode=&#039;subsystem&#039; type=&#039;pci&#039; managed=&#039;yes&#039;&gt; &lt;source&gt; &lt;address domain=&#039;0x0000&#039; bus=&#039;0x02&#039; slot=&#039;0x00&#039; function=&#039;0x0&#039;/&gt; &lt;/source&gt; &lt;address type=&#039;pci&#039; domain=&#039;0x0000&#039; bus=&#039;0x00&#039; slot=&#039;0x08&#039; function=&#039;0x0&#039;/&gt; &lt;/hostdev&gt; &lt;hostdev mode=&#039;subsystem&#039; type=&#039;pci&#039; managed=&#039;yes&#039;&gt; &lt;source&gt; &lt;address domain=&#039;0x0000&#039; bus=&#039;0x00&#039; slot=&#039;0x1b&#039; function=&#039;0x0&#039;/&gt; &lt;/source&gt; &lt;address type=&#039;pci&#039; domain=&#039;0x0000&#039; bus=&#039;0x00&#039; slot=&#039;0x0b&#039; function=&#039;0x0&#039;/&gt; &lt;/hostdev&gt; &lt;hostdev mode=&#039;subsystem&#039; type=&#039;usb&#039; managed=&#039;yes&#039;&gt; &lt;source&gt; &lt;vendor id=&#039;0x045e&#039;/&gt; &lt;product id=&#039;0x0719&#039;/&gt; &lt;/source&gt; &lt;/hostdev&gt; &lt;hostdev mode=&#039;subsystem&#039; type=&#039;usb&#039; managed=&#039;yes&#039;&gt; &lt;source&gt; &lt;vendor id=&#039;0x1532&#039;/&gt; &lt;product id=&#039;0x0016&#039;/&gt; &lt;/source&gt; &lt;/hostdev&gt; &lt;hostdev mode=&#039;subsystem&#039; type=&#039;pci&#039; managed=&#039;yes&#039;&gt; &lt;source&gt; &lt;address domain=&#039;0x0000&#039; bus=&#039;0x02&#039; slot=&#039;0x00&#039; function=&#039;0x1&#039;/&gt; &lt;/source&gt; &lt;address type=&#039;pci&#039; domain=&#039;0x0000&#039; bus=&#039;0x00&#039; slot=&#039;0x04&#039; function=&#039;0x0&#039;/&gt; &lt;/hostdev&gt; &lt;redirdev bus=&#039;usb&#039; type=&#039;spicevmc&#039;&gt; &lt;/redirdev&gt; &lt;redirdev bus=&#039;usb&#039; type=&#039;spicevmc&#039;&gt; &lt;/redirdev&gt; &lt;redirdev bus=&#039;usb&#039; type=&#039;spicevmc&#039;&gt; &lt;/redirdev&gt; &lt;redirdev bus=&#039;usb&#039; type=&#039;spicevmc&#039;&gt; &lt;/redirdev&gt; &lt;memballoon model=&#039;virtio&#039;&gt; &lt;address type=&#039;pci&#039; domain=&#039;0x0000&#039; bus=&#039;0x00&#039; slot=&#039;0x07&#039; function=&#039;0x0&#039;/&gt; &lt;/memballoon&gt; &lt;/devices&gt; &lt;/domain&gt;</code></pre></div></div></blockquote></div><br /><p>Try force-disabling hyper-V enlightenments, maybe they&#039;re enabled by default now. That would be strange, however.</p><p>Also, you could try swapping the host and the guest cards(to see if it&#039;s not the host nvidia-guest nvidia related conflict, but a card-related problem), and maybe try using nouveau with 9800GTX+(aka GTS250 btw, you can reflash it that way for lulz)<br />Oh, and i think you should use host-passthrough CPU for the true cpu id being shown for GeForce Experience App to work right. That&#039;ll cut all those feature requests stuff you have there now.<br />Also you have Cirrus VGA enabled, ensure that you really need it(QXL is recommended for Windows7, not cirrus).</p> <p class="postedit"><em>Last edited by Duelist (2015-06-10 18:34:48)</em></p> </div> <div class="postsignature postmsg"><hr /><p><span class="bbs">The forum rules prohibit requesting support for distributions other than arch.</span><br /><a href="https://bbs.archlinux.org/viewtopic.php?pid=1551460#p1551460" rel="nofollow">I gave up.</a><a href="https://bbs.archlinux.org/viewtopic.php?id=162768" rel="nofollow"> It was too late.</a><br /><a href="http://pastebin.com/B3fL84bq" rel="nofollow">What I was trying to do</a>.<br /><a href="http://vfio.blogspot.com/" rel="nofollow">The reference about VFIO and KVM VGA passthrough.</a></p></div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1536035">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1536039" class="blockpost rowodd"> <h2><span><span class="conr">#5309</span> <a href="viewtopic.php?pid=1536039#p1536039">2015-06-10 18:42:44</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=71471">dRaiser</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>From: Poland</span></dd> <dd><span>Registered: 2013-05-20</span></dd> <dd><span>Posts: 49</span></dd> <dd class="usercontacts"><span class="email"><a href="mailto:pw@draiser.net">Email</a></span> <span class="website"><a href="http://draiser.net/en" rel="nofollow">Website</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>Duelist wrote:</cite><blockquote><div><div class="quotebox"><cite>dRaiser wrote:</cite><blockquote><div><p>Hi. I&#039;ve finally changed my guest GPU - temporarily to GTX 960, from Radeon 4850. Coming from Radeon I knew that it wouldn&#039;t work without problems - but I can&#039;t overcome them at this moment. I got dreaded &#039;Code 43&#039; on Nvidia GPU. I&#039;ve disabled hyperv extensions and set kvm hidden state to off. I&#039;m now checking if kernel update to linux-vfio could help with anything, but it would be great if you could give me some tips.</p><p>I use Nvidia 9800 GTX+ with nvidia blob for host, have i3-550 CPU and AsRock Z77 Extreme4. All kvm-related things enabled (as I was running it properly with Radeon working on machine). I have 8 GiB total and 3 passed for machine. </p><p>960 GPU plus it&#039;s audio adapter are in pci-stubs and added to machine config.</p><div class="codebox"><pre class="vscroll"><code>&lt;domain type=&#039;kvm&#039;&gt; &lt;name&gt;wintendo&lt;/name&gt; &lt;uuid&gt;bf6bda0e-2664-4bab-998a-aac4dc255c83&lt;/uuid&gt; &lt;memory unit=&#039;KiB&#039;&gt;3145728&lt;/memory&gt; &lt;currentMemory unit=&#039;KiB&#039;&gt;3145728&lt;/currentMemory&gt; &lt;vcpu placement=&#039;static&#039;&gt;3&lt;/vcpu&gt; &lt;os&gt; &lt;type arch=&#039;x86_64&#039; machine=&#039;pc-i440fx-2.1&#039;&gt;hvm&lt;/type&gt; &lt;boot dev=&#039;hd&#039;/&gt; &lt;/os&gt; &lt;features&gt; &lt;acpi/&gt; &lt;apic/&gt; &lt;pae/&gt; &lt;kvm&gt; &lt;hidden state=&#039;on&#039;/&gt; &lt;/kvm&gt; &lt;/features&gt; &lt;cpu mode=&#039;custom&#039; match=&#039;exact&#039;&gt; &lt;model fallback=&#039;allow&#039;&gt;SandyBridge&lt;/model&gt; &lt;vendor&gt;Intel&lt;/vendor&gt; &lt;topology sockets=&#039;1&#039; cores=&#039;3&#039; threads=&#039;1&#039;/&gt; &lt;feature policy=&#039;require&#039; name=&#039;vme&#039;/&gt; &lt;feature policy=&#039;require&#039; name=&#039;dtes64&#039;/&gt; &lt;feature policy=&#039;require&#039; name=&#039;vmx&#039;/&gt; &lt;feature policy=&#039;require&#039; name=&#039;erms&#039;/&gt; &lt;feature policy=&#039;require&#039; name=&#039;xtpr&#039;/&gt; &lt;feature policy=&#039;require&#039; name=&#039;smep&#039;/&gt; &lt;feature policy=&#039;require&#039; name=&#039;pcid&#039;/&gt; &lt;feature policy=&#039;require&#039; name=&#039;est&#039;/&gt; &lt;feature policy=&#039;require&#039; name=&#039;monitor&#039;/&gt; &lt;feature policy=&#039;require&#039; name=&#039;smx&#039;/&gt; &lt;feature policy=&#039;require&#039; name=&#039;tm&#039;/&gt; &lt;feature policy=&#039;require&#039; name=&#039;acpi&#039;/&gt; &lt;feature policy=&#039;require&#039; name=&#039;osxsave&#039;/&gt; &lt;feature policy=&#039;require&#039; name=&#039;ht&#039;/&gt; &lt;feature policy=&#039;require&#039; name=&#039;pdcm&#039;/&gt; &lt;feature policy=&#039;require&#039; name=&#039;fsgsbase&#039;/&gt; &lt;feature policy=&#039;require&#039; name=&#039;f16c&#039;/&gt; &lt;feature policy=&#039;require&#039; name=&#039;ds&#039;/&gt; &lt;feature policy=&#039;require&#039; name=&#039;invtsc&#039;/&gt; &lt;feature policy=&#039;require&#039; name=&#039;tm2&#039;/&gt; &lt;feature policy=&#039;require&#039; name=&#039;ss&#039;/&gt; &lt;feature policy=&#039;require&#039; name=&#039;pbe&#039;/&gt; &lt;feature policy=&#039;require&#039; name=&#039;ds_cpl&#039;/&gt; &lt;feature policy=&#039;require&#039; name=&#039;rdrand&#039;/&gt; &lt;/cpu&gt; &lt;clock offset=&#039;localtime&#039;&gt; &lt;timer name=&#039;rtc&#039; tickpolicy=&#039;catchup&#039;/&gt; &lt;timer name=&#039;pit&#039; tickpolicy=&#039;delay&#039;/&gt; &lt;/clock&gt; &lt;on_poweroff&gt;destroy&lt;/on_poweroff&gt; &lt;on_reboot&gt;restart&lt;/on_reboot&gt; &lt;on_crash&gt;restart&lt;/on_crash&gt; &lt;pm&gt; &lt;suspend-to-mem enabled=&#039;no&#039;/&gt; &lt;suspend-to-disk enabled=&#039;no&#039;/&gt; &lt;/pm&gt; &lt;devices&gt; &lt;emulator&gt;/usr/sbin/qemu-system-x86_64&lt;/emulator&gt; &lt;disk type=&#039;block&#039; device=&#039;cdrom&#039;&gt; &lt;driver name=&#039;qemu&#039; type=&#039;raw&#039;/&gt; &lt;source dev=&#039;/dev/sr0&#039;/&gt; &lt;target dev=&#039;hdb&#039; bus=&#039;ide&#039;/&gt; &lt;readonly/&gt; &lt;address type=&#039;drive&#039; controller=&#039;0&#039; bus=&#039;0&#039; target=&#039;0&#039; unit=&#039;1&#039;/&gt; &lt;/disk&gt; &lt;disk type=&#039;file&#039; device=&#039;disk&#039;&gt; &lt;driver name=&#039;qemu&#039; type=&#039;raw&#039;/&gt; &lt;source file=&#039;/mnt/d2/50.raw&#039;/&gt; &lt;target dev=&#039;vdd&#039; bus=&#039;virtio&#039;/&gt; &lt;address type=&#039;pci&#039; domain=&#039;0x0000&#039; bus=&#039;0x00&#039; slot=&#039;0x0a&#039; function=&#039;0x0&#039;/&gt; &lt;/disk&gt; &lt;disk type=&#039;file&#039; device=&#039;disk&#039;&gt; &lt;driver name=&#039;qemu&#039; type=&#039;raw&#039;/&gt; &lt;source file=&#039;/mnt/d2/d2.img&#039;/&gt; &lt;target dev=&#039;vde&#039; bus=&#039;virtio&#039;/&gt; &lt;address type=&#039;pci&#039; domain=&#039;0x0000&#039; bus=&#039;0x00&#039; slot=&#039;0x09&#039; function=&#039;0x0&#039;/&gt; &lt;/disk&gt; &lt;controller type=&#039;usb&#039; index=&#039;0&#039; model=&#039;ich9-ehci1&#039;&gt; &lt;address type=&#039;pci&#039; domain=&#039;0x0000&#039; bus=&#039;0x00&#039; slot=&#039;0x05&#039; function=&#039;0x7&#039;/&gt; &lt;/controller&gt; &lt;controller type=&#039;usb&#039; index=&#039;0&#039; model=&#039;ich9-uhci1&#039;&gt; &lt;master startport=&#039;0&#039;/&gt; &lt;address type=&#039;pci&#039; domain=&#039;0x0000&#039; bus=&#039;0x00&#039; slot=&#039;0x05&#039; function=&#039;0x0&#039; multifunction=&#039;on&#039;/&gt; &lt;/controller&gt; &lt;controller type=&#039;usb&#039; index=&#039;0&#039; model=&#039;ich9-uhci2&#039;&gt; &lt;master startport=&#039;2&#039;/&gt; &lt;address type=&#039;pci&#039; domain=&#039;0x0000&#039; bus=&#039;0x00&#039; slot=&#039;0x05&#039; function=&#039;0x1&#039;/&gt; &lt;/controller&gt; &lt;controller type=&#039;usb&#039; index=&#039;0&#039; model=&#039;ich9-uhci3&#039;&gt; &lt;master startport=&#039;4&#039;/&gt; &lt;address type=&#039;pci&#039; domain=&#039;0x0000&#039; bus=&#039;0x00&#039; slot=&#039;0x05&#039; function=&#039;0x2&#039;/&gt; &lt;/controller&gt; &lt;controller type=&#039;pci&#039; index=&#039;0&#039; model=&#039;pci-root&#039;/&gt; &lt;controller type=&#039;ide&#039; index=&#039;0&#039;&gt; &lt;address type=&#039;pci&#039; domain=&#039;0x0000&#039; bus=&#039;0x00&#039; slot=&#039;0x01&#039; function=&#039;0x1&#039;/&gt; &lt;/controller&gt; &lt;controller type=&#039;virtio-serial&#039; index=&#039;0&#039;&gt; &lt;address type=&#039;pci&#039; domain=&#039;0x0000&#039; bus=&#039;0x00&#039; slot=&#039;0x06&#039; function=&#039;0x0&#039;/&gt; &lt;/controller&gt; &lt;interface type=&#039;bridge&#039;&gt; &lt;mac address=&#039;52:54:00:17:65:a1&#039;/&gt; &lt;source bridge=&#039;br0&#039;/&gt; &lt;model type=&#039;rtl8139&#039;/&gt; &lt;address type=&#039;pci&#039; domain=&#039;0x0000&#039; bus=&#039;0x00&#039; slot=&#039;0x03&#039; function=&#039;0x0&#039;/&gt; &lt;/interface&gt; &lt;serial type=&#039;pty&#039;&gt; &lt;target port=&#039;0&#039;/&gt; &lt;/serial&gt; &lt;console type=&#039;pty&#039;&gt; &lt;target type=&#039;serial&#039; port=&#039;0&#039;/&gt; &lt;/console&gt; &lt;channel type=&#039;spicevmc&#039;&gt; &lt;target type=&#039;virtio&#039; name=&#039;com.redhat.spice.0&#039;/&gt; &lt;address type=&#039;virtio-serial&#039; controller=&#039;0&#039; bus=&#039;0&#039; port=&#039;1&#039;/&gt; &lt;/channel&gt; &lt;input type=&#039;tablet&#039; bus=&#039;usb&#039;/&gt; &lt;input type=&#039;mouse&#039; bus=&#039;ps2&#039;/&gt; &lt;input type=&#039;keyboard&#039; bus=&#039;ps2&#039;/&gt; &lt;graphics type=&#039;spice&#039; autoport=&#039;yes&#039;/&gt; &lt;video&gt; &lt;model type=&#039;cirrus&#039; vram=&#039;16384&#039; heads=&#039;1&#039;/&gt; &lt;address type=&#039;pci&#039; domain=&#039;0x0000&#039; bus=&#039;0x00&#039; slot=&#039;0x02&#039; function=&#039;0x0&#039;/&gt; &lt;/video&gt; &lt;hostdev mode=&#039;subsystem&#039; type=&#039;pci&#039; managed=&#039;yes&#039;&gt; &lt;source&gt; &lt;address domain=&#039;0x0000&#039; bus=&#039;0x02&#039; slot=&#039;0x00&#039; function=&#039;0x0&#039;/&gt; &lt;/source&gt; &lt;address type=&#039;pci&#039; domain=&#039;0x0000&#039; bus=&#039;0x00&#039; slot=&#039;0x08&#039; function=&#039;0x0&#039;/&gt; &lt;/hostdev&gt; &lt;hostdev mode=&#039;subsystem&#039; type=&#039;pci&#039; managed=&#039;yes&#039;&gt; &lt;source&gt; &lt;address domain=&#039;0x0000&#039; bus=&#039;0x00&#039; slot=&#039;0x1b&#039; function=&#039;0x0&#039;/&gt; &lt;/source&gt; &lt;address type=&#039;pci&#039; domain=&#039;0x0000&#039; bus=&#039;0x00&#039; slot=&#039;0x0b&#039; function=&#039;0x0&#039;/&gt; &lt;/hostdev&gt; &lt;hostdev mode=&#039;subsystem&#039; type=&#039;usb&#039; managed=&#039;yes&#039;&gt; &lt;source&gt; &lt;vendor id=&#039;0x045e&#039;/&gt; &lt;product id=&#039;0x0719&#039;/&gt; &lt;/source&gt; &lt;/hostdev&gt; &lt;hostdev mode=&#039;subsystem&#039; type=&#039;usb&#039; managed=&#039;yes&#039;&gt; &lt;source&gt; &lt;vendor id=&#039;0x1532&#039;/&gt; &lt;product id=&#039;0x0016&#039;/&gt; &lt;/source&gt; &lt;/hostdev&gt; &lt;hostdev mode=&#039;subsystem&#039; type=&#039;pci&#039; managed=&#039;yes&#039;&gt; &lt;source&gt; &lt;address domain=&#039;0x0000&#039; bus=&#039;0x02&#039; slot=&#039;0x00&#039; function=&#039;0x1&#039;/&gt; &lt;/source&gt; &lt;address type=&#039;pci&#039; domain=&#039;0x0000&#039; bus=&#039;0x00&#039; slot=&#039;0x04&#039; function=&#039;0x0&#039;/&gt; &lt;/hostdev&gt; &lt;redirdev bus=&#039;usb&#039; type=&#039;spicevmc&#039;&gt; &lt;/redirdev&gt; &lt;redirdev bus=&#039;usb&#039; type=&#039;spicevmc&#039;&gt; &lt;/redirdev&gt; &lt;redirdev bus=&#039;usb&#039; type=&#039;spicevmc&#039;&gt; &lt;/redirdev&gt; &lt;redirdev bus=&#039;usb&#039; type=&#039;spicevmc&#039;&gt; &lt;/redirdev&gt; &lt;memballoon model=&#039;virtio&#039;&gt; &lt;address type=&#039;pci&#039; domain=&#039;0x0000&#039; bus=&#039;0x00&#039; slot=&#039;0x07&#039; function=&#039;0x0&#039;/&gt; &lt;/memballoon&gt; &lt;/devices&gt; &lt;/domain&gt;</code></pre></div></div></blockquote></div><br /><p>Try force-disabling hyper-V enlightenments, maybe they&#039;re enabled by default now. That would be strange, however.</p></div></blockquote></div><p>I&#039;ve tried both versions (completely deleted and off) without luck.</p><div class="quotebox"><blockquote><div><p>Also, you could try swapping the host and the guest cards(to see if it&#039;s not the host nvidia-guest nvidia related conflict, but a card-related problem), and maybe try using nouveau with 9800GTX+(aka GTS250 btw, you can reflash it that way for lulz)</p><p>Oh, and i think you should use host-passthrough CPU for the true cpu id being shown for GeForce Experience App to work right. That&#039;ll cut all those feature requests stuff you have there now.</p></div></blockquote></div><p>Thanks, I didn&#039;t know that. However it won&#039;t help resolve main issue, am I right?</p><div class="quotebox"><blockquote><div><p>Also you have Cirrus VGA enabled, ensure that you really need it(QXL is recommended for Windows7, not cirrus).</p></div></blockquote></div><p>I&#039;ve just switched between both without any difference. It&#039;s feasible for testing and didn&#039;t caused any problems before, but I&#039;ll try disabling completely.</p> <p class="postedit"><em>Last edited by dRaiser (2015-06-10 18:43:30)</em></p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1536039">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1536045" class="blockpost roweven"> <h2><span><span class="conr">#5310</span> <a href="viewtopic.php?pid=1536045#p1536045">2015-06-10 18:59:42</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=75590">aw</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2013-10-04</span></dd> <dd><span>Posts: 921</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=75590">Email</a></span> <span class="website"><a href="http://vfio.blogspot.com/" rel="nofollow">Website</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <p>@dRaiser</p><p>Emulated primary graphics + secondary nvidia is not how GeForce works, nvidia should be your only graphics.&#160; The mode you&#039;re trying works fine for Quadro.&#160; Also, since you have host and guest nvidia with the host nvidia proprietary drivers, double check that you&#039;re successfully preventing the host nvidia driver from binding to resources on the guest card.&#160; Nvidia does not support unbinding their driver from the device and is known to not release resources.&#160; There&#039;s often dmesg errors when launching the vm if this happens.</p> </div> <div class="postsignature postmsg"><hr /><p><a href="http://vfio.blogspot.com" rel="nofollow">http://vfio.blogspot.com</a><br />Looking for a more open forum to discuss vfio related uses?&#160; Try <a href="https://www.redhat.com/mailman/listinfo/vfio-users" rel="nofollow">https://www.redhat.com/mailman/listinfo/vfio-users</a></p></div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1536045">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1536055" class="blockpost rowodd"> <h2><span><span class="conr">#5311</span> <a href="viewtopic.php?pid=1536055#p1536055">2015-06-10 19:44:48</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=71471">dRaiser</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>From: Poland</span></dd> <dd><span>Registered: 2013-05-20</span></dd> <dd><span>Posts: 49</span></dd> <dd class="usercontacts"><span class="email"><a href="mailto:pw@draiser.net">Email</a></span> <span class="website"><a href="http://draiser.net/en" rel="nofollow">Website</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>aw wrote:</cite><blockquote><div><p>@dRaiser</p><p>Emulated primary graphics + secondary nvidia is not how GeForce works, nvidia should be your only graphics.&#160; The mode you&#039;re trying works fine for Quadro.&#160; Also, since you have host and guest nvidia with the host nvidia proprietary drivers, double check that you&#039;re successfully preventing the host nvidia driver from binding to resources on the guest card.&#160; Nvidia does not support unbinding their driver from the device and is known to not release resources.&#160; There&#039;s often dmesg errors when launching the vm if this happens.</p></div></blockquote></div><br /><p>Ok, I&#039;ve removed emulated graphics, but now can&#039;t see anything at all (so I don&#039;t know any windows errors and such).</p><p>I have pci-stubs in kernel line and vfio-bind configured. No dmesg errors after starting up machine, but it&#039;s not continuing booting properly, so I suspect it can&#039;t use card.</p><p>From lspci --nk I see this lines:</p><div class="codebox"><pre><code>02:00.0 VGA compatible controller [0300]: NVIDIA Corporation GM206 [GeForce GTX 960] [10de:1401] (rev a1) Subsystem: Micro-Star International Co., Ltd. [MSI] Device [1462:3201] Kernel driver in use: vfio-pci Kernel modules: nouveau, nvidia</code></pre></div><p>I think it&#039;s correct, but I&#039;ll ask for confirmation anyway.</p><p>Quick test:</p><div class="codebox"><pre><code>sudo qemu-system-x86_64 -enable-kvm -m 1024 -cpu host,kvm=off -smp 4,sockets=1,cores=4,threads=1 -device vfio-pci,host=02:00.0,x-vga=on -device vfio-pci,host=02:00.1 -vga none</code></pre></div><p>also works properly. So I think that 960 should be accessible for VM. Maybe I&#039;ll struggle and try run new Windows install...</p><p>Edit:</p><p>.. but it won&#039;t work when machines don&#039;t get video output at all. I wonder what&#039;s wrong. When I have emulated video enabled, then 960&#039;s discovered correctly (I&#039;ve installed driver this way without problem).<br />I&#039;ve switched host driver to nouveau and to newer kelner. Nothing changed.</p> <p class="postedit"><em>Last edited by dRaiser (2015-06-10 21:51:16)</em></p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1536055">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1536097" class="blockpost roweven"> <h2><span><span class="conr">#5312</span> <a href="viewtopic.php?pid=1536097#p1536097">2015-06-10 22:53:26</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=91799">supplicant0x90</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2015-06-10</span></dd> <dd><span>Posts: 2</span></dd> <dd class="usercontacts"><span class="email"><a href="mailto:supplicant@mail2tor.com">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <p>[aw] et al -</p><p>Your guides have been hugely valuable to me. I can&#039;t thank you enough for taking the time to share your research with us. </p><p>I&#039;ve gotten everything else working through those (and days of doc review), but I can&#039;t figure out how get my (Windows 8.1) guest to instantiate with a vmx flag on the vcpu (to be clear, I mean for nested virtualization; the host already has it enabled and working fine). </p><p>How do you enable VT-x in the guest through virt-manager or virsh? I tried doing </p><div class="codebox"><pre><code>host-passthrough</code></pre></div><p> on the cpu, since the host supports it, but the vmx flag doesn&#039;t come through. I also tried passing a </p><div class="codebox"><pre><code>&lt;feature policy=&#039;force&#039; name=&#039;vmx&#039;&gt;</code></pre></div><p> argument in the cpu settings of the config using &quot;virsh edit $vm&quot; (along with other options to confirm it works), and some of the other cpu flags do pop as expected, but vmx does not.</p><p>Is there some special setting I&#039;ve overlooked? I see &#039;man qemu&#039; says you can call it using &#039;iommu=on|off&#039; as a qemu-system-x86_64 argument, but I can&#039;t find anything else in the libvirt, virsh, or virt-manager docs. </p><p>Does it matter whether the guest uses BIOS or UEFI?</p><p><span class="postimg"><img src="http://funkyimg.com/i/Y4Dq.png" alt="Y4Dq.png" /></span></p><p>Apps on the guest confirm it&#039;s not a display issue:</p><p><span class="postimg"><img src="http://funkyimg.com/i/Y4Dw.png" alt="Y4Dw.png" /></span></p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1536097">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1536099" class="blockpost rowodd"> <h2><span><span class="conr">#5313</span> <a href="viewtopic.php?pid=1536099#p1536099">2015-06-10 22:54:31</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=85314">Duelist</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2014-09-22</span></dd> <dd><span>Posts: 358</span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>dRaiser wrote:</cite><blockquote><div><p>.. but it won&#039;t work when machines don&#039;t get video output at all. I wonder what&#039;s wrong. When I have emulated video enabled, then 960&#039;s discovered correctly (I&#039;ve installed driver this way without problem).<br />I&#039;ve switched host driver to nouveau and to newer kelner. Nothing changed.</p></div></blockquote></div><p>That&#039;s sad, i wanted to suggest you to grep vgaarb in dmesg to see if there&#039;s any problems with that.</p><p>And..<br />You&#039;re not using OVMF, are you?<br /><a href="http://vfio.blogspot.com/" rel="nofollow">AW</a> descriped some qemu wrapper script to append x-vga option to the device bound to vfio-pci and used by libvirt. <strong>libvirt will never allow x-vga to be on</strong>. So you&#039;ll need a wrapper script.</p><p>Or you could use ovmf to avoid VGA problems at all. You don&#039;t need to have any support of UEFI in your hardware except the GPU, and your 9XX geforce surely does support UEFI.</p> </div> <div class="postsignature postmsg"><hr /><p><span class="bbs">The forum rules prohibit requesting support for distributions other than arch.</span><br /><a href="https://bbs.archlinux.org/viewtopic.php?pid=1551460#p1551460" rel="nofollow">I gave up.</a><a href="https://bbs.archlinux.org/viewtopic.php?id=162768" rel="nofollow"> It was too late.</a><br /><a href="http://pastebin.com/B3fL84bq" rel="nofollow">What I was trying to do</a>.<br /><a href="http://vfio.blogspot.com/" rel="nofollow">The reference about VFIO and KVM VGA passthrough.</a></p></div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1536099">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1536101" class="blockpost roweven"> <h2><span><span class="conr">#5314</span> <a href="viewtopic.php?pid=1536101#p1536101">2015-06-10 22:57:14</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=75590">aw</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2013-10-04</span></dd> <dd><span>Posts: 921</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=75590">Email</a></span> <span class="website"><a href="http://vfio.blogspot.com/" rel="nofollow">Website</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>dRaiser wrote:</cite><blockquote><div><p>Quick test:</p><div class="codebox"><pre><code>sudo qemu-system-x86_64 -enable-kvm -m 1024 -cpu host,kvm=off -smp 4,sockets=1,cores=4,threads=1 -device vfio-pci,host=02:00.0,x-vga=on -device vfio-pci,host=02:00.1 -vga none</code></pre></div><p>also works properly. So I think that 960 should be accessible for VM. Maybe I&#039;ll struggle and try run new Windows install...</p><p>Edit:</p><p>.. but it won&#039;t work when machines don&#039;t get video output at all. I wonder what&#039;s wrong. When I have emulated video enabled, then 960&#039;s discovered correctly (I&#039;ve installed driver this way without problem).<br />I&#039;ve switched host driver to nouveau and to newer kelner. Nothing changed.</p></div></blockquote></div><p>You&#039;re using x-vga=on here, but making no attempt to do so in your xml.&#160; See part 5 of my how-to for a wrapper script around your qemu binary to add x-vga.</p> </div> <div class="postsignature postmsg"><hr /><p><a href="http://vfio.blogspot.com" rel="nofollow">http://vfio.blogspot.com</a><br />Looking for a more open forum to discuss vfio related uses?&#160; Try <a href="https://www.redhat.com/mailman/listinfo/vfio-users" rel="nofollow">https://www.redhat.com/mailman/listinfo/vfio-users</a></p></div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1536101">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1536103" class="blockpost rowodd"> <h2><span><span class="conr">#5315</span> <a href="viewtopic.php?pid=1536103#p1536103">2015-06-10 22:59:23</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=75590">aw</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2013-10-04</span></dd> <dd><span>Posts: 921</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=75590">Email</a></span> <span class="website"><a href="http://vfio.blogspot.com/" rel="nofollow">Website</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>supplicant0x90 wrote:</cite><blockquote><div><p>I&#039;ve gotten everything else working through those (and days of doc review), but I can&#039;t figure out how get my (Windows 8.1) guest to instantiate with a vmx flag on the vcpu (to be clear, I mean for nested virtualization; the host already has it enabled and working fine).</p></div></blockquote></div><p>Are you loading kvm-intel with nested=1?</p> </div> <div class="postsignature postmsg"><hr /><p><a href="http://vfio.blogspot.com" rel="nofollow">http://vfio.blogspot.com</a><br />Looking for a more open forum to discuss vfio related uses?&#160; Try <a href="https://www.redhat.com/mailman/listinfo/vfio-users" rel="nofollow">https://www.redhat.com/mailman/listinfo/vfio-users</a></p></div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1536103">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1536104" class="blockpost roweven"> <h2><span><span class="conr">#5316</span> <a href="viewtopic.php?pid=1536104#p1536104">2015-06-10 22:59:53</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=85314">Duelist</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2014-09-22</span></dd> <dd><span>Posts: 358</span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>supplicant0x90 wrote:</cite><blockquote><div><p>How do you enable VT-x in the guest through virt-manager or virsh? I tried doing </p><div class="codebox"><pre><code>host-passthrough</code></pre></div><p> on the cpu, since the host supports it, but the vmx flag doesn&#039;t come through. I also tried passing a </p><div class="codebox"><pre><code>&lt;feature policy=&#039;force&#039; name=&#039;vmx&#039;&gt;</code></pre></div><p> argument in the cpu settings of the config using &quot;virsh edit $vm&quot; (along with other options to confirm it works), and some of the other cpu flags do pop as expected, but vmx does not.</p></div></blockquote></div><p>I don&#039;t know about intel, but on AMD we have</p><div class="codebox"><pre><code>options kvm-amd npt=1 nested=0</code></pre></div><p>module options. </p><div class="codebox"><pre class="vscroll"><code>[user@crossfire ~]$ modinfo kvm-intel filename: /lib/modules/4.0.4-202.fc21.x86_64/kernel/arch/x86/kvm/kvm-intel.ko.xz license: GPL author: Qumranet alias: cpu:type:x86,ven*fam*mod*:feature:*0085* depends: kvm intree: Y vermagic: 4.0.4-202.fc21.x86_64 SMP mod_unload signer: Fedora kernel signing key sig_key: EC:B8:61:B3:8D:2D:A2:6D:43:B0:15:C1:0B:16:34:C7:33:4F:DD:D3 sig_hashalgo: sha256 parm: vpid:bool parm: flexpriority:bool parm: ept:bool parm: unrestricted_guest:bool parm: eptad:bool parm: emulate_invalid_guest_state:bool parm: vmm_exclusive:bool parm: fasteoi:bool parm: enable_apicv:bool parm: enable_shadow_vmcs:bool parm: nested:bool parm: pml:bool parm: ple_gap:int parm: ple_window:int parm: ple_window_grow:int parm: ple_window_shrink:int parm: ple_window_max:int</code></pre></div><p>As you can see, you have a module option called <strong>nested</strong> too! ensure that you&#039;ve enabled that.</p><br /><p>@aw, you should put a notice somewhere on your blog saying that you&#039;re the one(almost?) who wrote vfio-pci, i have a feeling people massively miss that point.</p> </div> <div class="postsignature postmsg"><hr /><p><span class="bbs">The forum rules prohibit requesting support for distributions other than arch.</span><br /><a href="https://bbs.archlinux.org/viewtopic.php?pid=1551460#p1551460" rel="nofollow">I gave up.</a><a href="https://bbs.archlinux.org/viewtopic.php?id=162768" rel="nofollow"> It was too late.</a><br /><a href="http://pastebin.com/B3fL84bq" rel="nofollow">What I was trying to do</a>.<br /><a href="http://vfio.blogspot.com/" rel="nofollow">The reference about VFIO and KVM VGA passthrough.</a></p></div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1536104">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1536105" class="blockpost rowodd"> <h2><span><span class="conr">#5317</span> <a href="viewtopic.php?pid=1536105#p1536105">2015-06-10 23:00:28</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=85314">Duelist</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2014-09-22</span></dd> <dd><span>Posts: 358</span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <p>Alright, this is getting awkward. Second-in-second. Dude. That&#039;s insane.</p> </div> <div class="postsignature postmsg"><hr /><p><span class="bbs">The forum rules prohibit requesting support for distributions other than arch.</span><br /><a href="https://bbs.archlinux.org/viewtopic.php?pid=1551460#p1551460" rel="nofollow">I gave up.</a><a href="https://bbs.archlinux.org/viewtopic.php?id=162768" rel="nofollow"> It was too late.</a><br /><a href="http://pastebin.com/B3fL84bq" rel="nofollow">What I was trying to do</a>.<br /><a href="http://vfio.blogspot.com/" rel="nofollow">The reference about VFIO and KVM VGA passthrough.</a></p></div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1536105">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1536106" class="blockpost roweven"> <h2><span><span class="conr">#5318</span> <a href="viewtopic.php?pid=1536106#p1536106">2015-06-10 23:04:09</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=91799">supplicant0x90</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2015-06-10</span></dd> <dd><span>Posts: 2</span></dd> <dd class="usercontacts"><span class="email"><a href="mailto:supplicant@mail2tor.com">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <p>aw/Duelist:</p><div class="quotebox"><blockquote><div><p>Are you loading kvm-intel with nested=1?</p></div></blockquote></div><p>No. I didn&#039;t see that anywhere. I&#039;ll research it from here and report back. Thank you!</p> <p class="postedit"><em>Last edited by supplicant0x90 (2015-06-10 23:05:19)</em></p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1536106">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1536117" class="blockpost rowodd"> <h2><span><span class="conr">#5319</span> <a href="viewtopic.php?pid=1536117#p1536117">2015-06-11 01:06:52</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=71471">dRaiser</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>From: Poland</span></dd> <dd><span>Registered: 2013-05-20</span></dd> <dd><span>Posts: 49</span></dd> <dd class="usercontacts"><span class="email"><a href="mailto:pw@draiser.net">Email</a></span> <span class="website"><a href="http://draiser.net/en" rel="nofollow">Website</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <p>Thanks, aw and Duelist.</p><p>I couldn&#039;t utilize aw&#039;s wrapper as virsh edit shouts about wrong binary, so I&#039;ve made simple check with qemu-commandline parameters (I know, it&#039;s ugly, but that was just to figure out..)</p><div class="codebox"><pre><code>&lt;qemu:commandline&gt; &lt;qemu:arg value=&#039;-device&#039;/&gt; &lt;qemu:arg value=&#039;vfio-pci,host=02:00.0,x-vga=on&#039;/&gt; &lt;/qemu:commandline&gt;</code></pre></div><p>I could launch machine with it, but no deal. Still black screen and windows doesn&#039;t even boot (I can&#039;t hear startup). So I assume x-vga doesn&#039;t actually help.</p><p>I was going to try OVMF as Duelist suggested, but it won&#039;t boot to my prepared earlier disk... Do I need to redo install if I want to use it? Sigh. If we can&#039;t find any other cure, I&#039;ll probably try with new OVMF install then...</p><p>--</p><p>One more patient test later: after few minutes of waiting Windows loads, I&#039;ve got startup sound and *device connected* sounds, but no screen image. So near, so far...</p><p>--</p><p>Success! Worked when added also &quot;multifunction&quot; to qemu arg line. Tommorow I&#039;ll post whole xml again for future. <img src="https://bbs.archlinux.org/img/smilies/smile.png" width="15" height="15" alt="smile" /></p> <p class="postedit"><em>Last edited by dRaiser (2015-06-11 01:49:55)</em></p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1536117">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1536127" class="blockpost roweven"> <h2><span><span class="conr">#5320</span> <a href="viewtopic.php?pid=1536127#p1536127">2015-06-11 01:54:46</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=75590">aw</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2013-10-04</span></dd> <dd><span>Posts: 921</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=75590">Email</a></span> <span class="website"><a href="http://vfio.blogspot.com/" rel="nofollow">Website</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>dRaiser wrote:</cite><blockquote><div><p>Thanks, aw and Duelist.</p><p>I couldn&#039;t utilize aw&#039;s wrapper as virsh edit shouts about wrong binary, so I&#039;ve made simple check with qemu-commandline parameters (I know, it&#039;s ugly, but that was just to figure out..)</p><div class="codebox"><pre><code>&lt;qemu:commandline&gt; &lt;qemu:arg value=&#039;-device&#039;/&gt; &lt;qemu:arg value=&#039;vfio-pci,host=02:00.0,x-vga=on&#039;/&gt; &lt;/qemu:commandline&gt;</code></pre></div></div></blockquote></div><p>NNNNNNNNNNNOOOOOOOOOOOOOO!!!!!!!!!!!!!!!!!</p><p>EDIT: did you chmod the wrapper to make it executable?</p> <p class="postedit"><em>Last edited by aw (2015-06-11 01:56:39)</em></p> </div> <div class="postsignature postmsg"><hr /><p><a href="http://vfio.blogspot.com" rel="nofollow">http://vfio.blogspot.com</a><br />Looking for a more open forum to discuss vfio related uses?&#160; Try <a href="https://www.redhat.com/mailman/listinfo/vfio-users" rel="nofollow">https://www.redhat.com/mailman/listinfo/vfio-users</a></p></div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1536127">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1536128" class="blockpost rowodd"> <h2><span><span class="conr">#5321</span> <a href="viewtopic.php?pid=1536128#p1536128">2015-06-11 02:00:41</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=71471">dRaiser</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>From: Poland</span></dd> <dd><span>Registered: 2013-05-20</span></dd> <dd><span>Posts: 49</span></dd> <dd class="usercontacts"><span class="email"><a href="mailto:pw@draiser.net">Email</a></span> <span class="website"><a href="http://draiser.net/en" rel="nofollow">Website</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>aw wrote:</cite><blockquote><div><div class="quotebox"><cite>dRaiser wrote:</cite><blockquote><div><p>Thanks, aw and Duelist.</p><p>I couldn&#039;t utilize aw&#039;s wrapper as virsh edit shouts about wrong binary, so I&#039;ve made simple check with qemu-commandline parameters (I know, it&#039;s ugly, but that was just to figure out..)</p><div class="codebox"><pre><code>&lt;qemu:commandline&gt; &lt;qemu:arg value=&#039;-device&#039;/&gt; &lt;qemu:arg value=&#039;vfio-pci,host=02:00.0,x-vga=on&#039;/&gt; &lt;/qemu:commandline&gt;</code></pre></div></div></blockquote></div><p>NNNNNNNNNNNOOOOOOOOOOOOOO!!!!!!!!!!!!!!!!!</p><p>EDIT: did you chmod the wrapper to make it executable?</p></div></blockquote></div><p>Sorry <img src="https://bbs.archlinux.org/img/smilies/sad.png" width="15" height="15" alt="sad" /> ...but it works...</p><p>Yes, I did chmod. I&#039;ve also corrected path to qemu in its content (as it wasn&#039;t valid location for qemu on my system), I was able to run it by hand by console, but virsh validation couldn&#039;t accept it as correct binary. I&#039;ll post specific error later if you&#039;d like.</p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1536128">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1536134" class="blockpost roweven"> <h2><span><span class="conr">#5322</span> <a href="viewtopic.php?pid=1536134#p1536134">2015-06-11 03:34:07</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=78217">DanaGoyette</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2014-01-03</span></dd> <dd><span>Posts: 46</span></dd> <dd class="usercontacts"><span class="email"><a href="mailto:danagoyette@gmail.com">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <p>I just got around to trying out the Hawaii bus reset patch -- it works wonderfully.&#160; Huge thanks for getting that in!<br />Now I can finally do what I set out to do when building this system: consolidate multiple systems into one.&#160; </p><p>I had to disable AppArmor in libvirt, though.&#160; The AppArmor &quot;helper&quot; suddenly decided to act completely un-helpful.<br />It complained that it was &quot;unable to load profile&quot; (&quot;no such file or directory&quot;), without telling me <strong><em>WHAT</em></strong><em> &quot;file or directory&quot;</em> it can&#039;t find.&#160; <br />It also couldn&#039;t seem to comprehend the split images, and denied write access to the &quot;vars&quot; file.&#160; (Right now, I&#039;m back to using a single image.)</p><p>If you pass through a raw disk via virtio, do TRIM commands get passed through, as well?<br />I found an article about hole-punching via TRIM on virtio-scsi with file-backed drives, but I&#039;d be using virtio and a raw disk.</p><p>For the moment, I&#039;m giving the virtual machine the ASMedia SATA controller, and using a hack to make it bootable..<br />I have a small IDE boot partition with rEFInd installed, so rEFInd can load AHCI.efi (a driver packaged with the &quot;XPC&quot; bootloader).</p><p>Something else I&#039;ve noticed: if I try to use my Xonar U7 (USB Audio Class 2.0) on the passed-through XHCI controller, the entire audio stack hangs after a while.<br />I have to unplug the sound card and plug it back in again.&#160; For now, I&#039;m passing through the onboard Realtek audio and using the USB sound card on the host.</p> <p class="postedit"><em>Last edited by DanaGoyette (2015-06-11 03:37:49)</em></p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1536134">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1536185" class="blockpost rowodd"> <h2><span><span class="conr">#5323</span> <a href="viewtopic.php?pid=1536185#p1536185">2015-06-11 08:54:29</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=58583">Nesousx</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2012-03-27</span></dd> <dd><span>Posts: 46</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=58583">Email</a></span> <span class="website"><a href="https://www.kodi-xbmc.com/" rel="nofollow">Website</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>DanaGoyette wrote:</cite><blockquote><div><p>Something else I&#039;ve noticed: if I try to use my Xonar U7 (USB Audio Class 2.0) on the passed-through XHCI controller, the entire audio stack hangs after a while.<br />I have to unplug the sound card and plug it back in again.&#160; For now, I&#039;m passing through the onboard Realtek audio and using the USB sound card on the host.</p></div></blockquote></div><p>Hi,</p><p>Just so you know I had issues for months with the Xonar U7. IIRC I also had issues with this card I posted about in this thread, but can&#039;t really remember what. Finally, the &quot;clicking&quot; noise of the U7 when you plug / unplug it made me crazy.</p><p>I sold it and bought a cheap USB card, everything works as expected. A part from the fact that I have to &quot;lock&quot; the USB card in the host.. but this is udev related as far as understand it, and will happen with any USB card.</p><p>Edit : page 138, post #3437. Now I remember my issue. Sometimes, totally randomly the sound will stutter and make everything lags for a 1 sec or 2 when the card was used via USB. Then when I emulated the audio while using USB on host I always had a very small delay before sounds occurs. This delay didn&#039;t exist when I emulated sound via the onboard (or others USB) cards.</p> <p class="postedit"><em>Last edited by Nesousx (2015-06-11 09:00:47)</em></p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1536185">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1536186" class="blockpost roweven"> <h2><span><span class="conr">#5324</span> <a href="viewtopic.php?pid=1536186#p1536186">2015-06-11 08:55:46</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=90593">mqddb</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2015-04-24</span></dd> <dd><span>Posts: 5</span></dd> <dd class="usercontacts"><span class="email"><a href="mailto:maqiang@shencloudtech.com">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <p>Dear ALL:<br />&#160; &#160; &#160;intel IGD is not supported YET. But, I asked software engineer of KVMGT project, they say intel IGD can be passthrough to VM. I want know why intel IGD can&#039;t supported, Is this problem can be fix?</p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1536186">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1536217" class="blockpost rowodd"> <h2><span><span class="conr">#5325</span> <a href="viewtopic.php?pid=1536217#p1536217">2015-06-11 13:16:18</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=75590">aw</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2013-10-04</span></dd> <dd><span>Posts: 921</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=75590">Email</a></span> <span class="website"><a href="http://vfio.blogspot.com/" rel="nofollow">Website</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>mqddb wrote:</cite><blockquote><div><p>Dear ALL:<br />&#160; &#160; &#160;intel IGD is not supported YET. But, I asked software engineer of KVMGT project, they say intel IGD can be passthrough to VM. I want know why intel IGD can&#039;t supported, Is this problem can be fix?</p></div></blockquote></div><p>You can assign it, but it won&#039;t work until Intel releases a driver that doesn&#039;t depend on passing through random op-regions, registers on other devices, and modifying device IDs on other components in the VM.&#160; IGD is not confined to the device at 00:02.0, it&#039;s smeared across the chipset.&#160; Ask them when that driver is coming.&#160; Even then, I believe the current plan requires some modifications to the guest BIOS.&#160; It&#039;s also not clear if that driver will require VGA access and therefore permanently lock VGA arbitration for the rest of the system or support UEFI.&#160; Even if it were to support UEFI, I don&#039;t think current Intel IGD hardware can fully disable claiming VGA transactions without disabling parts of the device, which might still require permanently locking arbitration for the duration of the VM.</p> </div> <div class="postsignature postmsg"><hr /><p><a href="http://vfio.blogspot.com" rel="nofollow">http://vfio.blogspot.com</a><br />Looking for a more open forum to discuss vfio related uses?&#160; Try <a href="https://www.redhat.com/mailman/listinfo/vfio-users" rel="nofollow">https://www.redhat.com/mailman/listinfo/vfio-users</a></p></div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1536217">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div class="postlinksb"> <div class="inbox crumbsplus"> <div class="pagepost"> <p class="pagelink conl"><span class="pages-label">Pages: </span><a rel="prev" class="item1" href="viewtopic.php?id=162768&amp;p=212">Previous</a> <a href="viewtopic.php?id=162768">1</a> <span class="spacer">…</span> <a href="viewtopic.php?id=162768&amp;p=211">211</a> <a href="viewtopic.php?id=162768&amp;p=212">212</a> <strong>213</strong> <a href="viewtopic.php?id=162768&amp;p=214">214</a> <a href="viewtopic.php?id=162768&amp;p=215">215</a> <span class="spacer">…</span> <a href="viewtopic.php?id=162768&amp;p=234">234</a> <a rel="next" href="viewtopic.php?id=162768&amp;p=214">Next</a></p> <p class="postlink conr">Topic closed</p> </div> <ul class="crumbs"> <li><a href="index.php">Index</a></li> <li><span>»&#160;</span><a href="viewforum.php?id=48">Topics Going Nowhere</a></li> <li><span>»&#160;</span><strong><a href="viewtopic.php?id=162768">KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</a></strong></li> </ul> <p class="subscribelink clearb"><a href="misc.php?action=subscribe&amp;tid=162768">Subscribe to this topic</a></p> <div class="clearer"></div> </div> </div> </div> <div id="brdfooter" class="block"> <h2><span>Board footer</span></h2> <div class="box"> <div id="brdfooternav" class="inbox"> <div class="conl"> <form id="qjump" method="get" action="viewforum.php"> <div><label><span>Jump to<br /></span> <select name="id" onchange="window.location=('viewforum.php?id='+this.options[this.selectedIndex].value)"> <optgroup label="Technical Issues and Assistance"> <option value="23">Newbie Corner</option> <option value="17">Installation</option> <option value="22">Kernel &amp; Hardware</option> <option value="18">Applications &amp; Desktop Environments</option> <option value="31">Laptop Issues</option> <option value="8">Networking, Server, and Protection</option> <option value="32">Multimedia and Games</option> <option value="50">System Administration</option> <option value="35">Other Architectures</option> </optgroup> <optgroup label="Arch-centric"> <option value="24">Announcements, Package &amp; Security Advisories</option> <option value="1">Arch Discussion</option> <option value="13">Forum &amp; Wiki discussion</option> </optgroup> <optgroup label="Pacman Upgrades, Packaging &amp; AUR"> <option value="44">Pacman &amp; Package Upgrade Issues</option> <option value="49">[testing] Repo Forum</option> <option value="4">Creating &amp; Modifying Packages</option> <option value="38">AUR Issues, Discussion &amp; PKGBUILD Requests</option> </optgroup> <optgroup label="Contributions &amp; Discussion"> <option value="20">GNU/Linux Discussion</option> <option value="27">Community Contributions</option> <option value="33">Programming &amp; Scripting</option> <option value="30">Other Languages</option> <option value="47">Artwork and Screenshots</option> <option value="42">Try This</option> </optgroup> <optgroup label="/dev/null"> <option value="29">Off-Topic</option> <option value="48" selected="selected">Topics Going Nowhere</option> <option value="36">Dustbin</option> </optgroup> </select></label> <input type="submit" value=" Go " accesskey="g" /> </div> </form> </div> <div class="conr"> <p id="feedlinks"><span class="atom"><a href="extern.php?action=feed&amp;tid=162768&amp;type=atom">Atom topic feed</a></span></p> <p id="poweredby">Powered by <a href="http://fluxbb.org/">FluxBB</a></p> </div> <div class="clearer"></div> </div> </div> </div> </div> <div class="end-box"></div> </div> </body> </html>
