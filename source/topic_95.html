<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"> <html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en" dir="ltr"> <head> <meta http-equiv="Content-Type" content="text/html; charset=utf-8" /> <title>KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9 (Page 95) / Topics Going Nowhere / Arch Linux Forums</title> <link rel="stylesheet" type="text/css" href="style/ArchLinux.css" /> <link rel="canonical" href="viewtopic.php?id=162768&amp;p=95" title="Page 95" /> <link rel="prev" href="viewtopic.php?id=162768&amp;p=94" title="Page 94" /> <link rel="next" href="viewtopic.php?id=162768&amp;p=96" title="Page 96" /> <link rel="alternate" type="application/atom+xml" href="extern.php?action=feed&amp;tid=162768&amp;type=atom" title="Atom topic feed" /> <link rel="stylesheet" media="screen" href="style/ArchLinux/arch.css?v=3" /> <link rel="stylesheet" media="screen" href="style/ArchLinux/archnavbar.css?v=2" /> <link rel="shortcut icon" href="style/ArchLinux/favicon.ico" /> </head> <body> <div id="archnavbar" class="anb-forum"> <div id="archnavbarlogo"><h1><a href="http://www.archlinux.org/">Arch Linux</a></h1></div> <div id="archnavbarmenu"> <ul id="archnavbarlist"> <li id="anb-home"><a href="http://www.archlinux.org/">Home</a></li><li id="anb-packages"><a href="http://www.archlinux.org/packages/">Packages</a></li><li id="anb-forums" class="anb-selected"><a href="https://bbs.archlinux.org/">Forums</a></li><li id="anb-wiki"><a href="https://wiki.archlinux.org/">Wiki</a></li><li id="anb-bugs"><a href="https://bugs.archlinux.org/">Bugs</a></li><li id="anb-aur"><a href="https://aur.archlinux.org/">AUR</a></li><li id="anb-download"><a href="http://www.archlinux.org/download/">Download</a></li> </ul> </div> </div> <div id="punviewtopic" class="pun"> <div class="top-box"></div> <div class="punwrap"> <div id="brdheader" class="block"> <div class="box"> <div id="brdmenu" class="inbox"> <ul> <li id="navindex" class="isactive"><a href="index.php">Index</a></li> <li id="navuserlist"><a href="userlist.php">User list</a></li> <li id="navsearch"><a href="search.php">Search</a></li> <li id="navprofile"><a href="profile.php?id=80749">Profile</a></li> <li id="navlogout"><a href="login.php?action=out&amp;id=80749&amp;csrf_token=5c20501ec397bb45ef8ee8c84db232c8d8e421c6">Logout</a></li> </ul> </div> <div id="brdwelcome" class="inbox"> <ul class="conl"> <li><span>Logged in as <strong>SXX</strong></span></li> <li><span>Last visit: 2015-08-16 12:20:09</span></li> </ul> <ul class="conr"> <li><span>Topics: <a href="search.php?action=show_replies" title="Find topics you have posted to.">Posted</a> | <a href="search.php?action=show_new" title="Find topics with new posts since your last visit.">New</a> | <a href="search.php?action=show_recent" title="Find topics with recent posts.">Active</a> | <a href="search.php?action=show_unanswered" title="Find topics with no replies.">Unanswered</a></span></li> </ul> <div class="clearer"></div> </div> </div> </div> <div id="brdmain"> <div class="linkst"> <div class="inbox crumbsplus"> <ul class="crumbs"> <li><a href="index.php">Index</a></li> <li><span>»&#160;</span><a href="viewforum.php?id=48">Topics Going Nowhere</a></li> <li><span>»&#160;</span><strong><a href="viewtopic.php?id=162768">KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</a></strong></li> </ul> <div class="pagepost"> <p class="pagelink conl"><span class="pages-label">Pages: </span><a rel="prev" class="item1" href="viewtopic.php?id=162768&amp;p=94">Previous</a> <a href="viewtopic.php?id=162768">1</a> <span class="spacer">…</span> <a href="viewtopic.php?id=162768&amp;p=93">93</a> <a href="viewtopic.php?id=162768&amp;p=94">94</a> <strong>95</strong> <a href="viewtopic.php?id=162768&amp;p=96">96</a> <a href="viewtopic.php?id=162768&amp;p=97">97</a> <span class="spacer">…</span> <a href="viewtopic.php?id=162768&amp;p=234">234</a> <a rel="next" href="viewtopic.php?id=162768&amp;p=96">Next</a></p> <p class="postlink conr">Topic closed</p> </div> <div class="clearer"></div> </div> </div> <div id="p1438449" class="blockpost rowodd blockpost1"> <h2><span><span class="conr">#2351</span> <a href="viewtopic.php?pid=1438449#p1438449">2014-07-21 13:38:42</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=81541">belliash</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2014-04-25</span></dd> <dd><span>Posts: 16</span></dd> <dd class="usercontacts"><span class="email"><a href="mailto:belliash@asiotec.eu.org">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>ctwdoecoss wrote:</cite><blockquote><div><p>Did anyone passthrough gpu successfully on a laptop?</p></div></blockquote></div><p>What GPU do you have in your notebook?</p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1438449">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1438483" class="blockpost roweven"> <h2><span><span class="conr">#2352</span> <a href="viewtopic.php?pid=1438483#p1438483">2014-07-21 14:36:53</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=83696">ctwdoecoss</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2014-07-20</span></dd> <dd><span>Posts: 3</span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>belliash wrote:</cite><blockquote><div><div class="quotebox"><cite>ctwdoecoss wrote:</cite><blockquote><div><p>Did anyone passthrough gpu successfully on a laptop?</p></div></blockquote></div><p>What GPU do you have in your notebook?</p></div></blockquote></div><p>I.&#160; &#160;MSI GP70 2PE<br />CPU:&#160; &#160; &#160; &#160;I5-4200H<br />Chipset:&#160; &#160;HM86<br />GPU:&#160; &#160; &#160; &#160;NVIDIA GT840M w/ 2G GDDR3 and&#160; Intel HD 4600<br />Video Output:&#160; D-sub and HDMI<br />2.&#160; MSI GE60 2PC<br />CPU:&#160; &#160; &#160; &#160;I5-4200H<br />Chipset:&#160; &#160;HM87<br />GPU:&#160; &#160; &#160; NVIDIA GTX850M w/ 2G GDDR5 and Intel HD 4600<br />Video Output:&#160; D-sub and HDMI</p><p>I would buy one of these two laptop.<br />I know it may be difficult, for the gpu isn&#039;t quadro series.</p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1438483">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1438592" class="blockpost rowodd"> <h2><span><span class="conr">#2353</span> <a href="viewtopic.php?pid=1438592#p1438592">2014-07-21 19:55:05</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=2904">Hippuh</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2005-01-30</span></dd> <dd><span>Posts: 22</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=2904">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <p>Well almost got it working like i want but not there yet.</p><p>Nvidia GTX760 is the main GPU running arch latest mainline kernel.<br />With a Radeon 4870 its all working fine.</p><p>With a GTX 560ti 448 I managed to get it working once but I can&#039;t restart the VM. That gives me an error on the VGA rom (using a rom file doesn&#039;t help) or the screen just stays in standby mode.<br />I tried patching the nvidia drivers as mentioned earlier but that just makes the nvidia installer fail with a build error on nv.c (using patch -p0 &lt; patchfile)</p><p>I&#039;m quite sure its related to the nvidia driver. I have to stub the PCI id&#039;s to make sure the driver doesn&#039;t pick up the second card. I&#039;ll keep on trying to get it to work.<br />If all fails I&#039;ll just have to buy me a reasonable AMD card to run the guest on.</p><p>PC Spec:<br />Mainboard: Asus P8H67-V<br />CPU:&#160; &#160; &#160; &#160; &#160;Intel Core I5 2300<br />Mem:&#160; &#160; &#160; &#160; &#160;8GB Geil DDR3 <br />GPU 1:&#160; &#160; &#160; Asus Nvidia GTX760<br />GPU 2:&#160; &#160; &#160; Gainward Nvidia GTX560ti 448 / HIS IceQ+ 4870<br />Vout:&#160; &#160; &#160; &#160; &#160;HDMI on GTX760 / VGA on GTX560 or 4870<br />Vout2:&#160; &#160; &#160; &#160;VGA on GTX760</p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1438592">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1438605" class="blockpost roweven"> <h2><span><span class="conr">#2354</span> <a href="viewtopic.php?pid=1438605#p1438605">2014-07-21 21:14:33</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=66944">shrubuntu</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2012-12-26</span></dd> <dd><span>Posts: 16</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=66944">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="codebox"><pre><code>qemu-system-x86_64 -enable-kvm -M q35 -m 4096 -cpu host -smp 6,sockets=1,cores=2,threads=1 -bios /usr/share/qemu/bios.bin -vga none -device ioh3420,bus=pcie.0,addr=1c.0,multifunction=on,port=1,chassis=1,id=root.1 -device vfio-pci,host=01:00.0,bus=root.1,addr=00.0,multifunction=on,x-vga=on -device vfio-pci,host=01:00.1,bus=root.1,addr=00.1 -drive file=/home/rishub/windows.img,id=disk,format=raw -device ide-hd,drive=disk -drive file=/home/rishub/Downloads/X17-24395.iso,id=isocd -device ide-cd,bus=ide.1,drive=isocd</code></pre></div><p>Puts me into qemu compat monitor console,<br />How do I get it to run the ISO?</p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1438605">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1438612" class="blockpost rowodd"> <h2><span><span class="conr">#2355</span> <a href="viewtopic.php?pid=1438612#p1438612">2014-07-21 21:39:00</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=83741">monchi</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2014-07-21</span></dd> <dd><span>Posts: 9</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=83741">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <p>Hi,</p><p>I followed the given tutorial step by step.</p><p>1) I compiled a new custom kernel <br />&#160; &#160; &#160; &#160; &#160; (3.15.6 +radeon_load_vbios_from_file.patch, <br />&#160; &#160; &#160; &#160; &#160; &#160;+i915_315.patch, <br />&#160; &#160; &#160; &#160; &#160; &#160;+override_for_missing_acs_capabilities.patch)</p><p>2) installed the new kernel</p><p>3) added new parameter to grub commandline:</p><div class="quotebox"><blockquote><div><p>GRUB_CMDLINE_LINUX_DEFAULT=&quot;iommu=1 intel_iommu=on vm.ignore_msrs=1 nomodeset pci-stub.ids=1002:9540,1002:aa38&#160; vfio_iommu_type1.allow_unsafe_interrupts=1 quiet&quot;</p></div></blockquote></div><p>until here everthing looks good:</p><div class="quotebox"><blockquote><div><p>[&#160; &#160; 0.432038] pci-stub: add 1002:9540 sub=FFFFFFFF:FFFFFFFF cls=00000000/00000000<br />[&#160; &#160; 0.432043] pci-stub 0000:01:00.0: claimed by stub<br />[&#160; &#160; 0.432045] pci-stub: add 1002:AA38 sub=FFFFFFFF:FFFFFFFF cls=00000000/00000000<br />[&#160; &#160; 0.432049] pci-stub 0000:01:00.1: claimed by stub</p></div></blockquote></div><p>4) used the given script for vfio-bind</p><div class="quotebox"><blockquote><div><p>vfio-bind 0000:01:00.0<br />vfio-bind 0000:01:00.1</p></div></blockquote></div><p>5) tryied to start a test VM buy executing this command:</p><div class="quotebox"><blockquote><div><p>qemu-system-x86_64 -enable-kvm -M q35 -m 1024 -cpu host \<br />-smp 6,sockets=1,cores=2,threads=1 \<br />-bios /usr/share/qemu/bios.bin -vga none \<br />-device ioh3420,bus=pcie.0,addr=1c.0,multifunction=on,port=1,chassis=1,id=root.1 \<br />-device vfio-pci,host=01:00.0,bus=root.1,addr=00.0,multifunction=on,x-vga=on \<br />-device vfio-pci,host=01:00.1,bus=root.1,addr=00.0</p></div></blockquote></div><p>but this gives me the following error:</p><div class="quotebox"><blockquote><div><p>qemu-system-x86_64: -device vfio-pci,host=01:00.0,bus=root.1,addr=00.0,multifunction=on,x-vga=on: vfio: error, group 1 is not viable, please ensure all devices within the iommu_group are bound to their vfio bus driver.<br />qemu-system-x86_64: -device vfio-pci,host=01:00.0,bus=root.1,addr=00.0,multifunction=on,x-vga=on: vfio: failed to get group 1<br />qemu-system-x86_64: -device vfio-pci,host=01:00.0,bus=root.1,addr=00.0,multifunction=on,x-vga=on: Device initialization failed.<br />qemu-system-x86_64: -device vfio-pci,host=01:00.0,bus=root.1,addr=00.0,multifunction=on,x-vga=on: Device &#039;vfio-pci&#039; could not be initialized</p></div></blockquote></div><p>Anyone got an idea whats wrong with my config?</p><p>Here are all my connected PCIe-devices:</p><div class="quotebox"><blockquote><div><p>00:00.0 Host bridge: Intel Corporation Haswell DRAM Controller (rev 06)<br />00:01.0 PCI bridge: Intel Corporation Haswell PCI Express x16 Controller (rev 06)<br />00:01.1 PCI bridge: Intel Corporation Haswell PCI Express x8 Controller (rev 06)<br />00:14.0 USB controller: Intel Corporation Lynx Point USB xHCI Host Controller (rev 04)<br />00:19.0 Ethernet controller: Intel Corporation Ethernet Connection I217-LM (rev 04)<br />00:1a.0 USB controller: Intel Corporation Lynx Point USB Enhanced Host Controller #2 (rev 04)<br />00:1c.0 PCI bridge: Intel Corporation Lynx Point PCI Express Root Port #1 (rev d4)<br />00:1c.1 PCI bridge: Intel Corporation Lynx Point PCI Express Root Port #2 (rev d4)<br />00:1d.0 USB controller: Intel Corporation Lynx Point USB Enhanced Host Controller #1 (rev 04)<br />00:1f.0 ISA bridge: Intel Corporation Lynx Point LPC Controller (rev 04)<br />00:1f.2 SATA controller: Intel Corporation Lynx Point 6-port SATA Controller 1 [AHCI mode] (rev 04)<br />00:1f.3 SMBus: Intel Corporation Lynx Point SMBus Controller (rev 04)<br />00:1f.6 Signal processing controller: Intel Corporation Lynx Point Thermal Management Controller (rev 04)<br />01:00.0 VGA compatible controller: Advanced Micro Devices [AMD] nee ATI RV710 [Radeon HD 4550]<br />01:00.1 Audio device: Advanced Micro Devices [AMD] nee ATI RV710/730 HDMI Audio [Radeon HD 4000 series]<br />02:00.0 SATA controller: ASMedia Technology Inc. ASM1062 Serial ATA Controller (rev 01)<br />03:00.0 PCI bridge: ASPEED Technology, Inc. AST1150 PCI-to-PCI Bridge (rev 03)<br />04:00.0 VGA compatible controller: ASPEED Technology, Inc. ASPEED Graphics Family (rev 30)<br />05:00.0 Ethernet controller: Intel Corporation I210 Gigabit Network Connection (rev 03)</p></div></blockquote></div><br /><p>Thanks in advance!</p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1438612">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1438691" class="blockpost roweven"> <h2><span><span class="conr">#2356</span> <a href="viewtopic.php?pid=1438691#p1438691">2014-07-22 06:11:17</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=80701">apex8</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2014-03-29</span></dd> <dd><span>Posts: 47</span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <p>According to the error message you got, you need to ensure that your devices have their own cgroup. This is done by the acs override patch, but its not enough just to apply that patch, you also need to enable it.<br />append</p><div class="codebox"><pre><code>pcie_acs_override=downstream</code></pre></div><p>to your boot parameters and lets see what happens.</p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1438691">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1438700" class="blockpost rowodd"> <h2><span><span class="conr">#2357</span> <a href="viewtopic.php?pid=1438700#p1438700">2014-07-22 07:36:15</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=83741">monchi</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2014-07-21</span></dd> <dd><span>Posts: 9</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=83741">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <p>thx apex8. This boot flag was missing.</p><p>now i get this:</p><div class="quotebox"><blockquote><div><p>qemu-system-x86_64: -device vfio-pci,host=01:00.1,bus=root.1,addr=00.0: PCI: slot 0 function 0 not available for vfio-pci, in use by vfio-pci<br />qemu-system-x86_64: -device vfio-pci,host=01:00.1,bus=root.1,addr=00.0: Device initialization failed.<br />qemu-system-x86_64: -device vfio-pci,host=01:00.1,bus=root.1,addr=00.0: Device &#039;vfio-pci&#039; could not be initialized</p></div></blockquote></div> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1438700">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1438703" class="blockpost roweven"> <h2><span><span class="conr">#2358</span> <a href="viewtopic.php?pid=1438703#p1438703">2014-07-22 08:09:11</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=82442">slis</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2014-06-02</span></dd> <dd><span>Posts: 125</span></dd> <dd class="usercontacts"><span class="email"><a href="mailto:xslisx@gmail.com">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <p>-device vfio-pci,host=01:00.1,bus=root.1,addr=00.0 &lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt; wrong address it should be 00.1</p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1438703">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1438704" class="blockpost rowodd"> <h2><span><span class="conr">#2359</span> <a href="viewtopic.php?pid=1438704#p1438704">2014-07-22 08:22:50</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=83741">monchi</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2014-07-21</span></dd> <dd><span>Posts: 9</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=83741">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <p>atleast the VM starts now. <br />black screen on the terminal, no signal on my hdmi port of the passed through card :-(</p><p>QEMU doesnt give me any error messages. Any tips on how I can proceed the debugging? I&#039;ve read that some cards need to load an &quot;external&quot; bios-rom. Is this worth a try?</p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1438704">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1438755" class="blockpost roweven"> <h2><span><span class="conr">#2360</span> <a href="viewtopic.php?pid=1438755#p1438755">2014-07-22 11:26:22</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=80701">apex8</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2014-03-29</span></dd> <dd><span>Posts: 47</span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <p>Can you try what happens when you adjust your script from above with</p><div class="codebox"><pre><code>-vga std \</code></pre></div><p>instead of</p><div class="codebox"><pre><code>-vga none\</code></pre></div><p>?</p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1438755">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1438808" class="blockpost rowodd"> <h2><span><span class="conr">#2361</span> <a href="viewtopic.php?pid=1438808#p1438808">2014-07-22 15:07:23</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=79909">CharlieBra7o</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2014-03-01</span></dd> <dd><span>Posts: 20</span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <p>Hi guys,<br />I tried to setup the passthrough according to the OP - unfortunally I have not been able to get a signal from my GPU yet.<br />I am using the patched kernel from the OP with qemu 2.0.0-4 and seabios 1.7.5-2 from the official repo.<br />I also enabled the kernel parameters needed for Intel graphics</p><div class="codebox"><pre><code>root@Ununhaswellium / # [b]uname -a[/b] Linux Ununhaswellium 3.15.1-1-mainline #1 SMP PREEMPT Tue Jul 15 22:24:38 CEST 2014 x86_64 GNU/Linux root@Ununhaswellium / # [b]cat /proc/cmdline BOOT_IMAGE=/vmlinuz-linux-mainline root=UUID=6209b873-4a4f-4265-bee6-5b4596d818e0 rw quiet nmi_watchdog=0 intel_iommu=on i915.enable_hd_vgaarb=1 1 root@Ununhaswellium / # lsmod | grep kvm kvm_intel 135528 0 kvm 408519 1 kvm_intel</code></pre></div><p>The hardware ofc supports VT-d:<br />Intel i7-4771 =&gt; IGP for the host<br />Gigabyte Z87-UD4H<br />AMD Radeon HD 7950 =&gt; for the guest</p><div class="codebox"><pre><code>root@Ununhaswellium / # cat /etc/modprobe.d/blacklist.conf blacklist radeon root@Ununhaswellium / # lspci | grep AMD 01:00.0 VGA compatible controller: Advanced Micro Devices, Inc. [AMD/ATI] Tahiti PRO [Radeon HD 7950/8950 OEM / R9 280] 01:00.1 Audio device: Advanced Micro Devices, Inc. [AMD/ATI] Tahiti XT HDMI Audio [Radeon HD 7970 Series] root@Ununhaswellium / # ls /sys/kernel/iommu_groups/1/devices 0000:00:01.0@ 0000:01:00.0@ 0000:01:00.1@ root@Ununhaswellium / # cat /etc/vfio-pci.cfg DEVICES=&quot;0000:00:01.0 0000:01:00.0 0000:01:00.1&quot;</code></pre></div><p>The IOMMU group devices are bound with the systemd service script in the OP.<br />Using the qemu command line from the OP shows the black QEMU window, but the HD 7950 doesn&#039;t output anything.<br />&quot;-vga std&quot; however at least shows the Seabios output in the QEMU window</p><div class="codebox"><pre><code>root@Ununhaswellium / # dmesg | tail [ 87.327240] VFIO - User Level meta-driver version: 0.3 [ 87.330781] pcie_pme 0000:00:01.0:pcie01: unloading service driver pcie_pme [ 583.320937] vfio-pci 0000:01:00.0: enabling device (0000 -&gt; 0003) [ 583.346033] vfio_ecap_init: 0000:01:00.0 hiding ecap 0x19@0x270 [ 583.346037] vfio_ecap_init: 0000:01:00.0 hiding ecap 0x1b@0x2d0 [ 604.697892] [drm:ivb_err_int_handler] *ERROR* Pipe B FIFO underrun</code></pre></div><p>I honestly don&#039;t know what I am missing here..? This was likely already discussed somethere, but I skimmed through the thread and couldn&#039;t find anything helpful...</p> <p class="postedit"><em>Last edited by CharlieBra7o (2014-07-22 15:10:02)</em></p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1438808">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1438819" class="blockpost roweven"> <h2><span><span class="conr">#2362</span> <a href="viewtopic.php?pid=1438819#p1438819">2014-07-22 16:23:07</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=83741">monchi</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2014-07-21</span></dd> <dd><span>Posts: 9</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=83741">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>apex8 wrote:</cite><blockquote><div><p>Can you try what happens when you adjust your script from above with</p><div class="codebox"><pre><code>-vga std \</code></pre></div><p>instead of</p><div class="codebox"><pre><code>-vga none\</code></pre></div><p>?</p></div></blockquote></div><p>if i use -vga std ill get videooutput on the terminal window. but the HDMI connected monitor stays black. Im using Seabios 1.7.4 is this a problem? Do I have to upgrade to 1.7.5.<br />Is there anything I can do to further investigate this issue?</p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1438819">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1438845" class="blockpost rowodd"> <h2><span><span class="conr">#2363</span> <a href="viewtopic.php?pid=1438845#p1438845">2014-07-22 17:57:09</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=80701">apex8</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2014-03-29</span></dd> <dd><span>Posts: 47</span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <p>At this point I have the same problem as you. I had a stable VM until I upgraded to kernel package 3.15.1 and later to 3.15.6. Using -vga std the VM still boots up. With version 3.14 it worked via DP signal monitor output. I&#039;m still trying to figure out whats different now, but I do not really know where to start. <br />Does anyone have the archive for the 3.14 package or can I apply the recent patches to the 3.14 vanilla package?</p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1438845">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1438853" class="blockpost roweven"> <h2><span><span class="conr">#2364</span> <a href="viewtopic.php?pid=1438853#p1438853">2014-07-22 18:22:40</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=80701">apex8</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2014-03-29</span></dd> <dd><span>Posts: 47</span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>nbhs wrote:</cite><blockquote><div><p>You need to boot with i915.enable_hd_vgaarb=1 kernel parameter, this will disable dri on the host though.</p></div></blockquote></div><p>This worked for me. That flag seems to be &quot;new&quot;, at least for me <img src="https://bbs.archlinux.org/img/smilies/smile.png" width="15" height="15" alt="smile" /> If I remember correctly, the vga arbiter was always on previously.</p> <p class="postedit"><em>Last edited by apex8 (2014-07-22 18:23:41)</em></p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1438853">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1438897" class="blockpost rowodd"> <h2><span><span class="conr">#2365</span> <a href="viewtopic.php?pid=1438897#p1438897">2014-07-22 20:37:10</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=83741">monchi</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2014-07-21</span></dd> <dd><span>Posts: 9</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=83741">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>apex8 wrote:</cite><blockquote><div><div class="quotebox"><cite>nbhs wrote:</cite><blockquote><div><p>You need to boot with i915.enable_hd_vgaarb=1 kernel parameter, this will disable dri on the host though.</p></div></blockquote></div><p>This worked for me. That flag seems to be &quot;new&quot;, at least for me <img src="https://bbs.archlinux.org/img/smilies/smile.png" width="15" height="15" alt="smile" /> If I remember correctly, the vga arbiter was always on previously.</p></div></blockquote></div><p>no success with my configuration...<br />Any got an idea what to do next?</p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1438897">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1438959" class="blockpost roweven"> <h2><span><span class="conr">#2366</span> <a href="viewtopic.php?pid=1438959#p1438959">2014-07-23 01:31:44</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=66944">shrubuntu</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2012-12-26</span></dd> <dd><span>Posts: 16</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=66944">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="codebox"><pre><code>root@debian:/home/rishub# dmesg | tail [ 20.391870] IPv6: ADDRCONF(NETDEV_UP): eth0: link is not ready [ 20.392637] alx 0000:03:00.0 eth0: NIC Up: 100 Mbps Full [ 20.392845] IPv6: ADDRCONF(NETDEV_CHANGE): eth0: link becomes ready [ 20.410598] IPv6: ADDRCONF(NETDEV_UP): wlan0: link is not ready [ 78.229382] vfio-pci 0000:01:00.0: enabling device (0000 -&gt; 0003) [ 96.022961] kvm: zapping shadow pages for mmio generation wraparound [ 213.859145] [drm:hsw_unclaimed_reg_clear] *ERROR* Unknown unclaimed register before writing to a068 [ 215.665049] [drm:hsw_unclaimed_reg_clear] *ERROR* Unknown unclaimed register before writing to 2030 [ 318.484445] vfio-pci 0000:01:00.0: Invalid ROM contents [ 361.228915] kvm: zapping shadow pages for mmio generation wraparound</code></pre></div><p>What could invalid ROM content mean? Using VGA -std works, but -none gives me this</p><p>Update: tried a ROM file from tech power up for my graphics card (gtx580) <br />Now I am getting lots of </p><div class="codebox"><pre><code>*ERROR* Unknown unclaimed...</code></pre></div><p> errors in dmesg</p> <p class="postedit"><em>Last edited by shrubuntu (2014-07-23 02:12:05)</em></p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1438959">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1438996" class="blockpost rowodd"> <h2><span><span class="conr">#2367</span> <a href="viewtopic.php?pid=1438996#p1438996">2014-07-23 06:35:36</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=80701">apex8</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2014-03-29</span></dd> <dd><span>Posts: 47</span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>monchi wrote:</cite><blockquote><div><div class="quotebox"><cite>apex8 wrote:</cite><blockquote><div><div class="quotebox"><cite>nbhs wrote:</cite><blockquote><div><p>You need to boot with i915.enable_hd_vgaarb=1 kernel parameter, this will disable dri on the host though.</p></div></blockquote></div><p>This worked for me. That flag seems to be &quot;new&quot;, at least for me <img src="https://bbs.archlinux.org/img/smilies/smile.png" width="15" height="15" alt="smile" /> If I remember correctly, the vga arbiter was always on previously.</p></div></blockquote></div><p>no success with my configuration...<br />Any got an idea what to do next?</p></div></blockquote></div><p>Hard to say where to start, but did you check your hardware for compatibility? Theres an linked Gdrive table document here, where you could look up your configuration.</p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1438996">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1439070" class="blockpost roweven"> <h2><span><span class="conr">#2368</span> <a href="viewtopic.php?pid=1439070#p1439070">2014-07-23 11:10:51</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=83763">rg80</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2014-07-23</span></dd> <dd><span>Posts: 7</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=83763">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <p>Hello,</p><p>i just registered to the forum only for this topic which is, so far, the best resource on the web regarding this matter!<br />Thanks for the good job guys, i was able to successfully launch my VM following this topic. <img src="https://bbs.archlinux.org/img/smilies/smile.png" width="15" height="15" alt="smile" /></p><p>I have only 2 problems i am not able to solve, being myself on Debian maybe i should tune better the workarounds, hope you can help me here.</p><p>1) KVM signature. I am on Nvidia and i am also facing the 337 driver issue (335 is fine). I would like to patch qemu but can&#039;t find the patch itself nor a good guide how to do it. <br />Is there anything similar on this post or the web? Despite searching i could find nothing. <img src="https://bbs.archlinux.org/img/smilies/sad.png" width="15" height="15" alt="sad" /></p><p>2) that&#039;s the tricky one. I am on a Supermicro X10SL7-F mobo, it has an LSI SAS controller onboard which shares the same PCI group with VGA:</p><div class="codebox"><pre><code>### Group 1 ### 00:01.0 PCI bridge: Intel Corporation Xeon E3-1200 v3/4th Gen Core Processor PCI Express x16 Controller (rev 06) 00:01.1 PCI bridge: Intel Corporation Xeon E3-1200 v3/4th Gen Core Processor PCI Express x8 Controller (rev 06) 01:00.0 VGA compatible controller: NVIDIA Corporation GK104 [GeForce GTX 760] (rev a1) 01:00.1 Audio device: NVIDIA Corporation GK104 HDMI Audio Controller (rev a1) 02:00.0 Serial Attached SCSI controller: LSI Logic / Symbios Logic SAS2308 PCI-Express Fusion-MPT SAS-2 (rev 05)</code></pre></div><p>I would like to assing this controller and VGA to different VMs but it seems this is not possible unless i separate them in different groups.<br />I am not sure i can do it however, group is correclty reflecing motherboard&#039;s hw structure, here is the diagram from supermicro manual: <a href="https://www.dropbox.com/s/ojcurfhm65scfk4/x10sl7%20diagram.jpg" rel="nofollow">mobo diagram</a>. Hope you can give me some hints about.</p><p>My setup:</p><p>Intel Xeon 1245v3<br />16Gb ECC DDR<br />Supermicro x10sl7-f<br />MSI GeForce GTX 760 SFF<br />Host: Debian Sid with kernel 3.15.3 and all VM stuff activated<br />Guest1 : Openmediavault NAS distro with 2 HDD passd with &quot;RDM&quot;, these are at the moment on the intel sata controller as i can&#039;t assign the LSI;<br />Guest2 : Win7 64Bit with working VGA passthrough;</p><p>Any help will be really appreciated. <img src="https://bbs.archlinux.org/img/smilies/smile.png" width="15" height="15" alt="smile" /></p><p>Thanks!<br />Cheers.</p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1439070">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1439074" class="blockpost rowodd"> <h2><span><span class="conr">#2369</span> <a href="viewtopic.php?pid=1439074#p1439074">2014-07-23 11:31:34</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=82195">blimpi</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2014-05-22</span></dd> <dd><span>Posts: 2</span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <p>@rg80: for point 1), you can compile <a href="http://git.qemu.org/qemu.git" rel="nofollow">qemu from git</a> and replace debian&#039;s binary with it. For point 2), you need to patch the kernel with the <a href="https://lkml.org/lkml/2013/5/30/513" rel="nofollow">ACS override patch</a> and then boot with kernel parameter &quot;pcie_acs_override=downstream&quot;</p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1439074">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1439096" class="blockpost roweven"> <h2><span><span class="conr">#2370</span> <a href="viewtopic.php?pid=1439096#p1439096">2014-07-23 12:50:34</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=83763">rg80</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2014-07-23</span></dd> <dd><span>Posts: 7</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=83763">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>blimpi wrote:</cite><blockquote><div><p>@rg80: for point 1), you can compile <a href="http://git.qemu.org/qemu.git" rel="nofollow">qemu from git</a> and replace debian&#039;s binary with it. For point 2), you need to patch the kernel with the <a href="https://lkml.org/lkml/2013/5/30/513" rel="nofollow">ACS override patch</a> and then boot with kernel parameter &quot;pcie_acs_override=downstream&quot;</p></div></blockquote></div><p>Thanks Blimpi.</p><p>Point 1, will check it later.</p><p>Point 2, tried to apply it some months ago but got this error:</p><div class="codebox"><pre><code>rino@Hubble:~/kernel/linux-3.15.3$ sudo patch -l -p1 &lt;acs.patch patching file Documentation/kernel-parameters.txt Hunk #1 succeeded at 2554 with fuzz 1 (offset 205 lines). patching file drivers/pci/quirks.c Hunk #1 FAILED at 3292. 1 out of 1 hunk FAILED -- saving rejects to file drivers/pci/quirks.c.rej patch unexpectedly ends in middle of line</code></pre></div><p>that&#039;s char 3292:</p><div class="codebox"><pre><code>+ case PCI_EXP_TYPE_RC_END: + if (acs_on_multifunction &amp;&amp; dev-&gt;multifunction) + return 1;</code></pre></div><p>It&#039;s the &gt; in dev-&gt;multifunction.</p><p>any idea?</p><p>Thanks.<br />Rino.</p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1439096">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1439111" class="blockpost rowodd"> <h2><span><span class="conr">#2371</span> <a href="viewtopic.php?pid=1439111#p1439111">2014-07-23 13:25:12</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=82195">blimpi</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2014-05-22</span></dd> <dd><span>Posts: 2</span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>rg80 wrote:</cite><blockquote><div><p>...</p><p>Point 2, tried to apply it some months ago but got this error:</p><div class="codebox"><pre><code>rino@Hubble:~/kernel/linux-3.15.3$ sudo patch -l -p1 &lt;acs.patch patching file Documentation/kernel-parameters.txt Hunk #1 succeeded at 2554 with fuzz 1 (offset 205 lines). patching file drivers/pci/quirks.c Hunk #1 FAILED at 3292. 1 out of 1 hunk FAILED -- saving rejects to file drivers/pci/quirks.c.rej patch unexpectedly ends in middle of line</code></pre></div><p>that&#039;s char 3292:</p><div class="codebox"><pre><code>+ case PCI_EXP_TYPE_RC_END: + if (acs_on_multifunction &amp;&amp; dev-&gt;multifunction) + return 1;</code></pre></div><p>It&#039;s the &gt; in dev-&gt;multifunction.</p><p>any idea?</p><p>Thanks.<br />Rino.</p></div></blockquote></div><p>The error &quot;patch unexpectedly ends in middle of line&quot; might point to a broken acs.patch file. See this <a href="http://unix.stackexchange.com/questions/1395/what-does-patch-unexpectedly-ends-in-middle-of-line-mean" rel="nofollow">link</a> for some ideas about the cause.</p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1439111">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1439124" class="blockpost roweven"> <h2><span><span class="conr">#2372</span> <a href="viewtopic.php?pid=1439124#p1439124">2014-07-23 13:44:08</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=83606">Child_of_Sun</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2014-07-16</span></dd> <dd><span>Posts: 8</span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <p>First, great Thanks to nbhs for this Howto, it&#039;s was very simple to understand the basics with vfio. (Searched over three Years for a possibility to passthrough my CrossfireX Cards to a VM, with Xen only one Card was possible, or even none).</p><p>Now i have passthrough my Soundcard (5.1 Setup), my 2 Graphic Cards (HD7770) (A third one (HD7750) as Primary Card for Linux), my Sata Controller (Linux boots from a Raid-Controller-Card), and different USB-Devices (Passing through the whole Bus makes Problems). The only negative thing is that my third Graphics Card only use PCIe x4 (But thats a thing i can live with).</p><p>The Performance is good, i have setup cgroups for Portage (Yes, i am a Gentoo User :-) ) and the VM, because when i compile Packages i don&#039;t care how long it takes, but when i play a game in this time, i can&#039;t live with less Performance :-) .</p><p>I use Windows 8.1 x64 Pro, Catalyst Drivers 14.7 Beta (Windows Part).<br />Linux has the Linux-next Kernel and the Radeon Kernel driver, and that is the main Reason i post here. Since i have seen that in this Kernel the Amd Iommu v2 is Supported (Don&#039;t know if i have one really :-) but that&#039;s not important for my Question). Since i only know that the iommu is important for Passthrough, is there any advance of using the v2 Iommu driver (If you have a v2 Iommu on your Board (That is really distracting, because the one site says it&#039;s a chip on the Board, the next one talks from the Cpu)) or is there no support for this at the moment ? (I want to change the Board in near Future because of the PCIe x8 and x4 setup and the Probs with Usb3, so i wanted to know if it is important to look that there is iommu v2 Support on it, my Processor (FX8350) should support this).</p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1439124">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1439162" class="blockpost rowodd"> <h2><span><span class="conr">#2373</span> <a href="viewtopic.php?pid=1439162#p1439162">2014-07-23 15:36:42</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=83763">rg80</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2014-07-23</span></dd> <dd><span>Posts: 7</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=83763">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>blimpi wrote:</cite><blockquote><div><p>The error &quot;patch unexpectedly ends in middle of line&quot; might point to a broken acs.patch file. See this <a href="http://unix.stackexchange.com/questions/1395/what-does-patch-unexpectedly-ends-in-middle-of-line-mean" rel="nofollow">link</a> for some ideas about the cause.</p></div></blockquote></div><p>I think i got it, let me post again the solution found some pages behind.</p><p>If you have any problem applying original acs override patch from Alex Williamson (Hunk #1 FAILED at 3292 in my case) try downloading <a href="http://www.fileswap.com/dl/nBgeX5Twa/" rel="nofollow">this package</a> which contains a new version. </p><p>This one applies correctly on my Debian system with kernel 3.15.3<br />Just built a new kernel image, will test it later and update. <img src="https://bbs.archlinux.org/img/smilies/smile.png" width="15" height="15" alt="smile" /></p><p>Edit: it works! Thanks again to this fantastic thread!</p><div class="codebox"><pre class="vscroll"><code>### Group 0 ### 00:00.0 Host bridge: Intel Corporation Xeon E3-1200 v3 Processor DRAM Controller (rev 06) ### Group 1 ### 00:01.0 PCI bridge: Intel Corporation Xeon E3-1200 v3/4th Gen Core Processor PCI Express x16 Controller (rev 06) ### Group 2 ### 00:01.1 PCI bridge: Intel Corporation Xeon E3-1200 v3/4th Gen Core Processor PCI Express x8 Controller (rev 06) ### Group 3 ### 00:14.0 USB controller: Intel Corporation 8 Series/C220 Series Chipset Family USB xHCI (rev 05) ### Group 4 ### 00:1c.0 PCI bridge: Intel Corporation 8 Series/C220 Series Chipset Family PCI Express Root Port #1 (rev d5) ### Group 5 ### 00:1c.2 PCI bridge: Intel Corporation 8 Series/C220 Series Chipset Family PCI Express Root Port #3 (rev d5) ### Group 6 ### 00:1c.3 PCI bridge: Intel Corporation 8 Series/C220 Series Chipset Family PCI Express Root Port #4 (rev d5) ### Group 7 ### 00:1f.0 ISA bridge: Intel Corporation C222 Series Chipset Family Server Essential SKU LPC Controller (rev 05) 00:1f.2 SATA controller: Intel Corporation 8 Series/C220 Series Chipset Family 6-port SATA Controller 1 [AHCI mode] (rev 05) 00:1f.3 SMBus: Intel Corporation 8 Series/C220 Series Chipset Family SMBus Controller (rev 05) 00:1f.6 Signal processing controller: Intel Corporation 8 Series Chipset Family Thermal Management Controller (rev 05) ### Group 8 ### 01:00.0 VGA compatible controller: NVIDIA Corporation GK104 [GeForce GTX 760] (rev a1) 01:00.1 Audio device: NVIDIA Corporation GK104 HDMI Audio Controller (rev a1) ### Group 9 ### 02:00.0 Serial Attached SCSI controller: LSI Logic / Symbios Logic SAS2308 PCI-Express Fusion-MPT SAS-2 (rev 05) ### Group 10 ### 03:00.0 PCI bridge: ASPEED Technology, Inc. AST1150 PCI-to-PCI Bridge (rev 03) 04:00.0 VGA compatible controller: ASPEED Technology, Inc. ASPEED Graphics Family (rev 30) ### Group 11 ### 05:00.0 Ethernet controller: Intel Corporation I210 Gigabit Network Connection (rev 03) ### Group 12 ### 06:00.0 Ethernet controller: Intel Corporation I210 Gigabit Network Connection (rev 03)</code></pre></div> <p class="postedit"><em>Last edited by rg80 (2014-07-23 22:34:00)</em></p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1439162">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1439211" class="blockpost roweven"> <h2><span><span class="conr">#2374</span> <a href="viewtopic.php?pid=1439211#p1439211">2014-07-23 17:54:48</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=2904">Hippuh</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2005-01-30</span></dd> <dd><span>Posts: 22</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=2904">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <p>Well so far no luck on the NVIDIA card, I can&#039;t reboot the guest, when trying to install NVIDIA drivers in windows 8.1 guest it complains an instance is allready active which is not the case.<br />Does anyone know if there is an nvidia installer for the patched driver (its possible to create it with --apply-patch x.patch) so far on all my attempts I get errors on building the kernel module in nv.c.</p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1439211">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1439216" class="blockpost rowodd"> <h2><span><span class="conr">#2375</span> <a href="viewtopic.php?pid=1439216#p1439216">2014-07-23 18:11:03</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=79909">CharlieBra7o</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2014-03-01</span></dd> <dd><span>Posts: 20</span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>kaeptnb wrote:</cite><blockquote><div><p>&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;<br />&#160; &lt;os&gt;&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; <br />&#160; &#160; &lt;type arch=&#039;x86_64&#039; machine=&#039;pc-q35-1.5&#039;&gt;hvm&lt;/type&gt;&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;<br />&#160; &#160; ...<br />&#160; &lt;/os&gt;&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;<br />&#160; ...<br />&#160; &lt;devices&gt;&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;<br />&#160; &#160; &lt;emulator&gt;/usr/local/kvm/bin/qemu-system-x86_64&lt;/emulator&gt;&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; <br />&#160; &#160; ...<br />&#160; &lt;/devices&gt;<br />&#160; ...<br />&#160; &lt;qemu:commandline&gt;<br />&#160; &#160; &lt;qemu:arg value=&#039;-device&#039;/&gt;<br />&#160; &#160; &lt;qemu:arg value=&#039;ioh3420,bus=pcie.0,addr=1c.0,multifunction=on,port=1,chassis=1,id=root.1&#039;/&gt;<br />&#160; &#160; &lt;qemu:arg value=&#039;-device&#039;/&gt;<br />&#160; &#160; &lt;qemu:arg value=&#039;vfio-pci,host=08:00.0,bus=root.1,addr=00.0,multifunctioIs there n=on,x-vga=on&#039;/&gt;<br />&#160; &#160; &lt;qemu:arg value=&#039;-device&#039;/&gt;<br />&#160; &#160; &lt;qemu:arg value=&#039;vfio-pci,host=08:00.1,bus=root.1,addr=00.1&#039;/&gt;<br />&#160; &#160; ...<br />&#160; &#160; &lt;qemu:arg value=&#039;-bios&#039;/&gt;<br />&#160; &#160; &lt;qemu:arg value=&#039;/usr/src/kvm/seabios-1.7.2-patched/seabios/out/bios.bin&#039;/&gt;<br />&#160; &#160; ...<br />&#160; &lt;/qemu:commandline&gt;</p></div></blockquote></div><p>I tried using these &lt;qemu:*&gt; tags in my virt-manager XML, but no matter if I define a new VM from the XML or edit an existing one, all the qemu tags vanish without an error. This means after I insert them, virsh edit/define, and then reopen the XML file all the qemu tags are gone...<br />I tried virt-manager and libvirt from both official repo and AUR. No difference <img src="https://bbs.archlinux.org/img/smilies/sad.png" width="15" height="15" alt="sad" /><br />Am I missing some setting for qemu integration or why is this happening???</p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1439216">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div class="postlinksb"> <div class="inbox crumbsplus"> <div class="pagepost"> <p class="pagelink conl"><span class="pages-label">Pages: </span><a rel="prev" class="item1" href="viewtopic.php?id=162768&amp;p=94">Previous</a> <a href="viewtopic.php?id=162768">1</a> <span class="spacer">…</span> <a href="viewtopic.php?id=162768&amp;p=93">93</a> <a href="viewtopic.php?id=162768&amp;p=94">94</a> <strong>95</strong> <a href="viewtopic.php?id=162768&amp;p=96">96</a> <a href="viewtopic.php?id=162768&amp;p=97">97</a> <span class="spacer">…</span> <a href="viewtopic.php?id=162768&amp;p=234">234</a> <a rel="next" href="viewtopic.php?id=162768&amp;p=96">Next</a></p> <p class="postlink conr">Topic closed</p> </div> <ul class="crumbs"> <li><a href="index.php">Index</a></li> <li><span>»&#160;</span><a href="viewforum.php?id=48">Topics Going Nowhere</a></li> <li><span>»&#160;</span><strong><a href="viewtopic.php?id=162768">KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</a></strong></li> </ul> <p class="subscribelink clearb"><a href="misc.php?action=subscribe&amp;tid=162768">Subscribe to this topic</a></p> <div class="clearer"></div> </div> </div> </div> <div id="brdfooter" class="block"> <h2><span>Board footer</span></h2> <div class="box"> <div id="brdfooternav" class="inbox"> <div class="conl"> <form id="qjump" method="get" action="viewforum.php"> <div><label><span>Jump to<br /></span> <select name="id" onchange="window.location=('viewforum.php?id='+this.options[this.selectedIndex].value)"> <optgroup label="Technical Issues and Assistance"> <option value="23">Newbie Corner</option> <option value="17">Installation</option> <option value="22">Kernel &amp; Hardware</option> <option value="18">Applications &amp; Desktop Environments</option> <option value="31">Laptop Issues</option> <option value="8">Networking, Server, and Protection</option> <option value="32">Multimedia and Games</option> <option value="50">System Administration</option> <option value="35">Other Architectures</option> </optgroup> <optgroup label="Arch-centric"> <option value="24">Announcements, Package &amp; Security Advisories</option> <option value="1">Arch Discussion</option> <option value="13">Forum &amp; Wiki discussion</option> </optgroup> <optgroup label="Pacman Upgrades, Packaging &amp; AUR"> <option value="44">Pacman &amp; Package Upgrade Issues</option> <option value="49">[testing] Repo Forum</option> <option value="4">Creating &amp; Modifying Packages</option> <option value="38">AUR Issues, Discussion &amp; PKGBUILD Requests</option> </optgroup> <optgroup label="Contributions &amp; Discussion"> <option value="20">GNU/Linux Discussion</option> <option value="27">Community Contributions</option> <option value="33">Programming &amp; Scripting</option> <option value="30">Other Languages</option> <option value="47">Artwork and Screenshots</option> <option value="42">Try This</option> </optgroup> <optgroup label="/dev/null"> <option value="29">Off-Topic</option> <option value="48" selected="selected">Topics Going Nowhere</option> <option value="36">Dustbin</option> </optgroup> </select></label> <input type="submit" value=" Go " accesskey="g" /> </div> </form> </div> <div class="conr"> <p id="feedlinks"><span class="atom"><a href="extern.php?action=feed&amp;tid=162768&amp;type=atom">Atom topic feed</a></span></p> <p id="poweredby">Powered by <a href="http://fluxbb.org/">FluxBB</a></p> </div> <div class="clearer"></div> </div> </div> </div> </div> <div class="end-box"></div> </div> </body> </html>
