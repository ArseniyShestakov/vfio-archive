<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"> <html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en" dir="ltr"> <head> <meta http-equiv="Content-Type" content="text/html; charset=utf-8" /> <title>KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9 (Page 130) / Topics Going Nowhere / Arch Linux Forums</title> <link rel="stylesheet" type="text/css" href="style/ArchLinux.css" /> <link rel="canonical" href="viewtopic.php?id=162768&amp;p=130" title="Page 130" /> <link rel="prev" href="viewtopic.php?id=162768&amp;p=129" title="Page 129" /> <link rel="next" href="viewtopic.php?id=162768&amp;p=131" title="Page 131" /> <link rel="alternate" type="application/atom+xml" href="extern.php?action=feed&amp;tid=162768&amp;type=atom" title="Atom topic feed" /> <link rel="stylesheet" media="screen" href="style/ArchLinux/arch.css?v=3" /> <link rel="stylesheet" media="screen" href="style/ArchLinux/archnavbar.css?v=2" /> <link rel="shortcut icon" href="style/ArchLinux/favicon.ico" /> </head> <body> <div id="archnavbar" class="anb-forum"> <div id="archnavbarlogo"><h1><a href="http://www.archlinux.org/">Arch Linux</a></h1></div> <div id="archnavbarmenu"> <ul id="archnavbarlist"> <li id="anb-home"><a href="http://www.archlinux.org/">Home</a></li><li id="anb-packages"><a href="http://www.archlinux.org/packages/">Packages</a></li><li id="anb-forums" class="anb-selected"><a href="https://bbs.archlinux.org/">Forums</a></li><li id="anb-wiki"><a href="https://wiki.archlinux.org/">Wiki</a></li><li id="anb-bugs"><a href="https://bugs.archlinux.org/">Bugs</a></li><li id="anb-aur"><a href="https://aur.archlinux.org/">AUR</a></li><li id="anb-download"><a href="http://www.archlinux.org/download/">Download</a></li> </ul> </div> </div> <div id="punviewtopic" class="pun"> <div class="top-box"></div> <div class="punwrap"> <div id="brdheader" class="block"> <div class="box"> <div id="brdmenu" class="inbox"> <ul> <li id="navindex" class="isactive"><a href="index.php">Index</a></li> <li id="navuserlist"><a href="userlist.php">User list</a></li> <li id="navsearch"><a href="search.php">Search</a></li> <li id="navprofile"><a href="profile.php?id=80749">Profile</a></li> <li id="navlogout"><a href="login.php?action=out&amp;id=80749&amp;csrf_token=5c20501ec397bb45ef8ee8c84db232c8d8e421c6">Logout</a></li> </ul> </div> <div id="brdwelcome" class="inbox"> <ul class="conl"> <li><span>Logged in as <strong>SXX</strong></span></li> <li><span>Last visit: 2015-08-16 12:20:09</span></li> </ul> <ul class="conr"> <li><span>Topics: <a href="search.php?action=show_replies" title="Find topics you have posted to.">Posted</a> | <a href="search.php?action=show_new" title="Find topics with new posts since your last visit.">New</a> | <a href="search.php?action=show_recent" title="Find topics with recent posts.">Active</a> | <a href="search.php?action=show_unanswered" title="Find topics with no replies.">Unanswered</a></span></li> </ul> <div class="clearer"></div> </div> </div> </div> <div id="brdmain"> <div class="linkst"> <div class="inbox crumbsplus"> <ul class="crumbs"> <li><a href="index.php">Index</a></li> <li><span>»&#160;</span><a href="viewforum.php?id=48">Topics Going Nowhere</a></li> <li><span>»&#160;</span><strong><a href="viewtopic.php?id=162768">KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</a></strong></li> </ul> <div class="pagepost"> <p class="pagelink conl"><span class="pages-label">Pages: </span><a rel="prev" class="item1" href="viewtopic.php?id=162768&amp;p=129">Previous</a> <a href="viewtopic.php?id=162768">1</a> <span class="spacer">…</span> <a href="viewtopic.php?id=162768&amp;p=128">128</a> <a href="viewtopic.php?id=162768&amp;p=129">129</a> <strong>130</strong> <a href="viewtopic.php?id=162768&amp;p=131">131</a> <a href="viewtopic.php?id=162768&amp;p=132">132</a> <span class="spacer">…</span> <a href="viewtopic.php?id=162768&amp;p=234">234</a> <a rel="next" href="viewtopic.php?id=162768&amp;p=131">Next</a></p> <p class="postlink conr">Topic closed</p> </div> <div class="clearer"></div> </div> </div> <div id="p1474637" class="blockpost rowodd blockpost1"> <h2><span><span class="conr">#3226</span> <a href="viewtopic.php?pid=1474637#p1474637">2014-11-12 01:13:50</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=75590">aw</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2013-10-04</span></dd> <dd><span>Posts: 921</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=75590">Email</a></span> <span class="website"><a href="http://vfio.blogspot.com/" rel="nofollow">Website</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>dakabali wrote:</cite><blockquote><div><p>thanks for the quick answer. Getting the card rom helped to eliminate the errors regarding the &quot;Invalid ROM contents&quot;. However, the situation didn&#039;t change - still no signal on the second monitor. Instead of enabling my Titan card /should be something like &quot; vfio-pci 0000:01:00.0: enabling device (0000 -&gt; 0001)&quot; like for the audio 01:00.1/ it drops a memory reservation error:</p><p>[&#160; 179.361851] vfio_ecap_init: 0000:01:00.0 hiding ecap 0x19@0x900<br />[&#160; 179.363102] vfio-pci 0000:01:00.0: BAR 3: can&#039;t reserve [mem 0x98000000-0x99ffffff 64bit pref]<br />[&#160; 179.365305] vfio-pci 0000:01:00.1: enabling device (0000 -&gt; 0002)</p><p>Furthermore starting Qemu says: &quot;VFIO 0000:01:00.0 BAR 3 mmap unsupported. Performance may be slow&quot;</p><p>Any idea? Thx.</p></div></blockquote></div><p>I believe Duelist has figured out that this typically means you have something like vesafb claiming resources of the card you&#039;re trying to assign, which isn&#039;t going to work.&#160; Look in /proc/iomem for the driver using pieces of your GPU and prevent it from happening.</p> </div> <div class="postsignature postmsg"><hr /><p><a href="http://vfio.blogspot.com" rel="nofollow">http://vfio.blogspot.com</a><br />Looking for a more open forum to discuss vfio related uses?&#160; Try <a href="https://www.redhat.com/mailman/listinfo/vfio-users" rel="nofollow">https://www.redhat.com/mailman/listinfo/vfio-users</a></p></div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1474637">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1474642" class="blockpost roweven"> <h2><span><span class="conr">#3227</span> <a href="viewtopic.php?pid=1474642#p1474642">2014-11-12 01:33:32</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=83606">Child_of_Sun</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2014-07-16</span></dd> <dd><span>Posts: 8</span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><blockquote><div><p>I bought a new Graphics Card and tried Primary Passthrough with it and it works perfect :-)</p><p>It&#039;s a Sapphire Radeon R9 280X Tri-X OC and it replaces both Radeon HD7770 and brings slightly better Graphics Performance.</p><p>My Sartup command is now:</p><div class="codebox"><pre><code>until /usr/bin/sudo /usr/bin/nice -n 0 /usr/bin/qemu-system-x86_64 -M q35 -enable-kvm -monitor stdio -nographic \ -balloon none -mem-path /dev/hugepages -mem-prealloc -m 10240 -k de -cpu host -smp 8,sockets=1,cores=8,threads=1 \ -bios /usr/share/qemu/bios.bin-1.7.5 -realtime mlock=on -vga none -D /var/log/qemu-out.log -boot menu=on -usb \ -usbdevice host:046d:c517 -usbdevice host:093a:2510 -usbdevice host:1a2c:0023 \ -device vfio-pci,host=00:11.0,bus=pcie.0,addr=1c.0,multifunction=on,bootindex=0 \ -device vfio-pci,host=00:14.2,bus=pcie.0,addr=1c.1,multifunction=on \ -device ioh3420,bus=pcie.0,addr=1c.2,multifunction=on,port=1,chassis=1,id=root.0 \ -device vfio-pci,host=01:00.0,bus=root.0,addr=00.0,multifunction=on,x-vga=on \ -device vfio-pci,host=01:00.1,bus=pcie.0,multifunction=on \ -device vfio-pci,host=03:00.0,bus=pcie.0,addr=1c.6,multifunction=on \ -device vfio-pci,host=04:00.0,bus=pcie.0,addr=1c.7,multifunction=on \ -drive id=bitlocker_keys,file=/dev/loop0,if=none -device usb-storage,drive=bitlocker_keys \ -netdev type=tap,id=guest0,vhost=on,ifname=&quot;${IFACE}&quot; -device virtio-net-pci,netdev=guest0,mac=&quot;${macaddr}&quot; ${options} ; do echo &quot;Qemu crashed with exit code $?. Respawning..&quot; &gt;&amp;2 sleep 5 done</code></pre></div><p>*EDIT* Since the Card have a switchable Bios (UEFI/Compatible) i wanted to tell you all that both settings work.</p></div></blockquote></div><p>Only the Performance is bad :-(, so i switched back to native Windows for gaming, before with the HD7770s Unigine Heaven 3.01 (Standard Settings) had a score of ~1422 in the VM and ~1522 native, the faster Card had ~822 in the VM and ~864 native, that was good for me, because the Performance loss wasn&#039;t great.</p><p>Now with the 280x i have ~1522 Points in the VM and ~2880 Points native (Tested with the UEFI Bios from the Card), i know there are too many Variables to find the &quot;Bottleneck&quot; by myself, so i only wanted to tell it here in the Thread.</p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1474642">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1474692" class="blockpost rowodd"> <h2><span><span class="conr">#3228</span> <a href="viewtopic.php?pid=1474692#p1474692">2014-11-12 07:27:45</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=78355">anickname</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2014-01-07</span></dd> <dd><span>Posts: 23</span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>Child_of_Sun wrote:</cite><blockquote><div><p>I bought a new Graphics Card and tried Primary Passthrough with it and it works perfect :-)</p><p>It&#039;s a Sapphire Radeon R9 280X Tri-X OC and it replaces both Radeon HD7770 and brings slightly better Graphics Performance.</p><p>Only the Performance is bad :-(, so i switched back to native Windows for gaming, before with the HD7770s Unigine Heaven 3.01 (Standard Settings) had a score of ~1422 in the VM and ~1522 native, the faster Card had ~822 in the VM and ~864 native, that was good for me, because the Performance loss wasn&#039;t great.</p><p>Now with the 280x i have ~1522 Points in the VM and ~2880 Points native (Tested with the UEFI Bios from the Card), i know there are too many Variables to find the &quot;Bottleneck&quot; by myself, so i only wanted to tell it here in the Thread.</p></div></blockquote></div><p>I just run the test on my VM using UEFI, video card Radeon 270X. The score was:<br />Heaven Benchmark v3.0 Basic</p><p>FPS: 102.9 <br />Scores: 2592 <br />Min FPS: 41.3 <br />Max FPS: 189.9 </p><p>Hardware</p><p>Binary: <br />Windows 32bit Visual C++ 1600 Release Mar 7 2012 </p><p>Operating system: <br />Windows NT 6.2 (build 9200) 64bit </p><p>CPU model: <br />Intel(R) Core(TM) i7-3770 CPU @ 3.40GHz </p><p>CPU flags: <br />3399MHz MMX SSE SSE2 SSE3 SSSE3 SSE41 SSE42 HTT </p><p>GPU model: AMD Radeon R9 200 Series 14.301.1001.0 2048Mb </p><br /><p>Settings<br />Render: direct3d11 <br />Mode: 1680x1050 fullscreen <br />Shaders: high <br />Textures: high <br />Filter: trilinear <br />Anisotropy: 4x <br />Occlusion: enabled <br />Refraction: enabled <br />Volumetric: enabled <br />Tessellation: disabled </p><p>The performance is good.</p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1474692">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1474697" class="blockpost roweven"> <h2><span><span class="conr">#3229</span> <a href="viewtopic.php?pid=1474697#p1474697">2014-11-12 08:16:48</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=86302">4kGamer</a></strong></dt> <dd class="usertitle"><strong>Banned</strong></dd> <dd><span>Registered: 2014-10-29</span></dd> <dd><span>Posts: 82</span></dd> <dd class="usercontacts"><span class="email"><a href="mailto:oktayaslantas@gmx.de">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>4kGamer wrote:</cite><blockquote><div><div class="quotebox"><cite>slis wrote:</cite><blockquote><div><p>You need to make sure you are using virtio disk in xml, then add ide cd-rom with virtio-drivers... like here </p><div class="quotebox"><blockquote><div><p>&lt;disk type=&#039;file&#039; device=&#039;disk&#039;&gt;<br />&#160; &#160; &#160; &lt;driver name=&#039;qemu&#039; type=&#039;raw&#039; cache=&#039;none&#039; io=&#039;native&#039;/&gt;<br />&#160; &#160; &#160; &lt;source file=&#039;/mnt/hdd2/win8.img&#039;/&gt;<br />&#160; &#160; &#160; &lt;target dev=&#039;vda&#039; bus=&#039;virtio&#039;/&gt;<br />&#160; &#160; &#160; &lt;address type=&#039;pci&#039; domain=&#039;0x0000&#039; bus=&#039;0x02&#039; slot=&#039;0x03&#039; function=&#039;0x0&#039;/&gt;<br />&#160; &#160; &lt;/disk&gt;<br />&#160; &#160; &lt;disk type=&#039;file&#039; device=&#039;cdrom&#039;&gt;<br />&#160; &#160; &#160; &lt;driver name=&#039;qemu&#039; type=&#039;raw&#039;/&gt;<br />&#160; &#160; &#160; &lt;source file=&#039;/mnt/hdd/INSTALL/en_windows_8.1_professional_vl_with_update_x64_dvd_4065194.iso&#039;/&gt;<br />&#160; &#160; &#160; &lt;target dev=&#039;hda&#039; bus=&#039;ide&#039;/&gt;<br />&#160; &#160; &#160; &lt;readonly/&gt;<br />&#160; &#160; &#160; &lt;address type=&#039;drive&#039; controller=&#039;0&#039; bus=&#039;0&#039; target=&#039;0&#039; unit=&#039;0&#039;/&gt;<br />&#160; &#160; &lt;/disk&gt;<br />&#160; &#160; &lt;disk type=&#039;file&#039; device=&#039;cdrom&#039;&gt;<br />&#160; &#160; &#160; &lt;driver name=&#039;qemu&#039; type=&#039;raw&#039;/&gt;<br />&#160; &#160; &#160; &lt;source file=&#039;/mnt/hdd/INSTALL/virtio-win-0.1-81.iso&#039;/&gt;<br />&#160; &#160; &#160; &lt;target dev=&#039;hdc&#039; bus=&#039;ide&#039;/&gt;<br />&#160; &#160; &#160; &lt;readonly/&gt;<br />&#160; &#160; &#160; &lt;address type=&#039;drive&#039; controller=&#039;0&#039; bus=&#039;1&#039; target=&#039;0&#039; unit=&#039;0&#039;/&gt;<br />&#160; &#160; &lt;/disk&gt;</p></div></blockquote></div><p>At windows setup, when it asks where to install, choose load driver and then point it to mounted cd-rom with viritio drivers.</p></div></blockquote></div><br /><p>Hi there! Thanks for posting part of your XML file. Unfortunately, it didn&#039;t work. Not only did it not ask for the virtio Drivers, it also doesn&#039;t find my storage - a physical device. This is part of my XML file where I made some changes:</p><br /><div class="quotebox"><blockquote><div><p>&lt;domain type=&#039;kvm&#039;&gt;<br />&#160; &lt;name&gt;win8.1&lt;/name&gt;<br />&#160; &lt;uuid&gt;502f5be4-0126-4a32-8d63-3f8d06a1c80a&lt;/uuid&gt;<br />&#160; &lt;memory unit=&#039;KiB&#039;&gt;8388608&lt;/memory&gt;<br />&#160; &lt;currentMemory unit=&#039;KiB&#039;&gt;8388608&lt;/currentMemory&gt;<br />&#160; &lt;vcpu placement=&#039;static&#039;&gt;2&lt;/vcpu&gt;<br />&#160; &lt;os&gt;<br />&#160; &#160; &lt;type arch=&#039;x86_64&#039; machine=&#039;pc-i440fx-2.2&#039;&gt;hvm&lt;/type&gt;<br />&#160; &#160; &lt;loader type=&#039;pflash&#039;&gt;/var/lib/libvirt/images/win8.1-OVMF.fd&lt;/loader&gt;<br />&#160; &lt;/os&gt;<br />....<br />&#160; &#160;&lt;devices&gt;<br />&#160; &#160; &lt;emulator&gt;/usr/sbin/qemu-system-x86_64&lt;/emulator&gt;<br />&#160; &#160; &lt;disk type=&#039;block&#039; device=&#039;disk&#039;&gt;<br />&#160; &#160; &#160; &lt;driver name=&#039;qemu&#039; type=&#039;raw&#039; cache=&#039;none&#039; io=&#039;native&#039;/&gt;<br />&#160; &#160; &#160; &lt;source dev=&#039;/dev/mapper/VG-kvmwin&#039;/&gt;<br />&#160; &#160; &#160; &lt;target dev=&#039;vda&#039; bus=&#039;virtio&#039;/&gt;<br />&#160; &#160; &#160; &lt;boot order=&#039;1&#039;/&gt;<br />&#160; &#160; &#160; &lt;address type=&#039;pci&#039; domain=&#039;0x0000&#039; bus=&#039;0x00&#039; slot=&#039;0x08&#039; function=&#039;0x0&#039;/&gt;<br />&#160; &#160; &lt;/disk&gt;<br />&#160; &#160; &lt;disk type=&#039;file&#039; device=&#039;cdrom&#039;&gt;<br />&#160; &#160; &#160; &lt;driver name=&#039;qemu&#039; type=&#039;raw&#039;/&gt;<br />&#160; &#160; &#160; &lt;source file=&#039;/root/windows.iso&#039;/&gt;<br />&#160; &#160; &#160; &lt;target dev=&#039;hda&#039; bus=&#039;ide&#039;/&gt;<br />&#160; &#160; &#160; &lt;readonly/&gt;<br />&#160; &#160; &#160; &lt;boot order=&#039;3&#039;/&gt;<br />&#160; &#160; &#160; &lt;address type=&#039;drive&#039; controller=&#039;0&#039; bus=&#039;0&#039; target=&#039;0&#039; unit=&#039;1&#039;/&gt;<br />&#160; &#160; &lt;/disk&gt;<br />&#160; &#160; &lt;disk type=&#039;file&#039; device=&#039;cdrom&#039;&gt;<br />&#160; &#160; &#160; &lt;driver name=&#039;qemu&#039; type=&#039;raw&#039;/&gt;<br />&#160; &#160; &#160; &lt;source file=&#039;/root/virtio.iso&#039;/&gt;<br />&#160; &#160; &#160; &lt;target dev=&#039;hdb&#039; bus=&#039;ide&#039;/&gt;<br />&#160; &#160; &#160; &lt;readonly/&gt;<br />&#160; &#160; &#160; &lt;boot order=&#039;2&#039;/&gt;<br />&#160; &#160; &#160; &lt;address type=&#039;drive&#039; controller=&#039;0&#039; bus=&#039;1&#039; target=&#039;0&#039; unit=&#039;1&#039;/&gt;<br />&#160; &#160; &lt;/disk&gt;</p></div></blockquote></div><p>Can you please have a look? Is there something missing or wrong? Thank you very much!</p></div></blockquote></div><p>Does anyone know why it&#039;s not finding the virtio drivers and my storage device? I also use lvm ...</p><br /><p>any help is greatly appreciated!</p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1474697">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1474701" class="blockpost rowodd"> <h2><span><span class="conr">#3230</span> <a href="viewtopic.php?pid=1474701#p1474701">2014-11-12 08:51:00</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=82442">slis</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2014-06-02</span></dd> <dd><span>Posts: 125</span></dd> <dd class="usercontacts"><span class="email"><a href="mailto:xslisx@gmail.com">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <p>It&#039;s normal to not detect any hdd&#039;s (storage drives in windows setup), cause windows doesn&#039;t have viritio drivers, thats why u mount viritio drivers as ide cdrom, so when windows shows select where to install screen, u got there option LOAD DRIVERS, click on it, select virtio cdrom, win8, drivers then select Red Hat Virtio Storage Driver and it should show your virtio disk.</p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1474701">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1474769" class="blockpost roweven"> <h2><span><span class="conr">#3231</span> <a href="viewtopic.php?pid=1474769#p1474769">2014-11-12 14:52:15</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=86620">dakabali</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2014-11-11</span></dd> <dd><span>Posts: 7</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=86620">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>aw wrote:</cite><blockquote><div><p>I believe Duelist has figured out that this typically means you have something like vesafb claiming resources of the card you&#039;re trying to assign, which isn&#039;t going to work.&#160; Look in /proc/iomem for the driver using pieces of your GPU and prevent it from happening.</p></div></blockquote></div><p>All right, I changed the Gigabyte Dual UEFI BIOS setting &quot;legacy only&quot; to &quot;legacy first&quot; regarding the priorities of my NVIDIA cards. This change seems to select my GT730 (I suppose it doesn&#039;t support UEFI anyway) as primary video card over the Titan and this helped to eliminate the BAR error. However, still no signal on the second monitor and having started the vm dmsg delivers the following one line:</p><p>[ 9650.055230] vfio_ecap_init: 0000:01:00.0 hiding ecap 0x19@0x900</p><p>So I managed to decrease the number of error lines to one without coming any closer to solve the problem... &quot;great&quot; :-(&#160; Any idea?</p><p>EDIT: Solved! The above described BIOS setting change did the trick. I had to remove the card bios from the configuration and everything works just fine. Summary: it has to explicitly be set in the BIOS which video card is the primary, &quot;auto&quot; might not be enough. Thanks for your kind help!</p> <p class="postedit"><em>Last edited by dakabali (2014-11-12 15:13:44)</em></p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1474769">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1474790" class="blockpost rowodd"> <h2><span><span class="conr">#3232</span> <a href="viewtopic.php?pid=1474790#p1474790">2014-11-12 16:50:16</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=83606">Child_of_Sun</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2014-07-16</span></dd> <dd><span>Posts: 8</span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>anickname wrote:</cite><blockquote><div><div class="quotebox"><cite>Child_of_Sun wrote:</cite><blockquote><div><p>I bought a new Graphics Card and tried Primary Passthrough with it and it works perfect :-)</p><p>It&#039;s a Sapphire Radeon R9 280X Tri-X OC and it replaces both Radeon HD7770 and brings slightly better Graphics Performance.</p><p>Only the Performance is bad :-(, so i switched back to native Windows for gaming, before with the HD7770s Unigine Heaven 3.01 (Standard Settings) had a score of ~1422 in the VM and ~1522 native, the faster Card had ~822 in the VM and ~864 native, that was good for me, because the Performance loss wasn&#039;t great.</p><p>Now with the 280x i have ~1522 Points in the VM and ~2880 Points native (Tested with the UEFI Bios from the Card), i know there are too many Variables to find the &quot;Bottleneck&quot; by myself, so i only wanted to tell it here in the Thread.</p></div></blockquote></div><p>I just run the test on my VM using UEFI, video card Radeon 270X. The score was:<br />Heaven Benchmark v3.0 Basic</p><p>FPS: 102.9 <br />Scores: 2592 <br />Min FPS: 41.3 <br />Max FPS: 189.9 </p><p>Hardware</p><p>Binary: <br />Windows 32bit Visual C++ 1600 Release Mar 7 2012 </p><p>Operating system: <br />Windows NT 6.2 (build 9200) 64bit </p><p>CPU model: <br />Intel(R) Core(TM) i7-3770 CPU @ 3.40GHz </p><p>CPU flags: <br />3399MHz MMX SSE SSE2 SSE3 SSSE3 SSE41 SSE42 HTT </p><p>GPU model: AMD Radeon R9 200 Series 14.301.1001.0 2048Mb </p><br /><p>Settings<br />Render: direct3d11 <br />Mode: 1680x1050 fullscreen <br />Shaders: high <br />Textures: high <br />Filter: trilinear <br />Anisotropy: 4x <br />Occlusion: enabled <br />Refraction: enabled <br />Volumetric: enabled <br />Tessellation: disabled </p><p>The performance is good.</p></div></blockquote></div><p>As i told before, i don&#039;t want to search for the Problem. I quit my testing with Qemu-KVM-Vfio not only because of the Performance, Powersaving is another Reason for it, don&#039;t want to&#160; blow 2000 kw/h per Anno for my private PC <img src="https://bbs.archlinux.org/img/smilies/big_smile.png" width="15" height="15" alt="big_smile" />.</p><p>My Actual Configuration is:<br />Graka: Radeon R9 280X Tri-X OC<br />Mainboard: Asrock 970 Extreme4<br />HDDs: Sandisk 64GB SSD, Seagate Barracuda 7200.12 1TB, Seagate Barracuda LP 1TB<br />CPU: Amd FX-8350<br />Burners: Optiarc DVD-RW, LG Blueray<br />Ram: 4x4 GB Transcend 1333MHz</p><br /><p>The Devices i had passthrough to the VM:<br />-usbdevice host:046d:c517 -usbdevice host:093a:2510 -usbdevice host:1a2c:0023 \ Keyboard and Mouse ( 2 Different Keyboards, only 1 at a time)<br />-device vfio-pci,host=00:11.0,bus=pcie.0,addr=1c.0,multifunction=on,bootindex=0 \ (Onboard AHCI Controller, only works in AHCI Mode without Bios Option Rom)<br />-device vfio-pci,host=00:14.2,bus=pcie.0,addr=1c.1,multifunction=on \ (Onboard Audio Controller)<br />-device ioh3420,bus=pcie.0,addr=1c.2,multifunction=on,port=1,chassis=1,id=root.0 \ (Graphics Card Port)<br />-device vfio-pci,host=01:00.0,bus=root.0,addr=00.0,multifunction=on,x-vga=on \ (Graphics Card)<br />-device vfio-pci,host=01:00.1,bus=pcie.0,multifunction=on \ (Graphics Card Audio)<br />-device vfio-pci,host=03:00.0,bus=pcie.0,addr=1c.6,multifunction=on \ (Usb 3.0 Controller 1)<br />-device vfio-pci,host=04:00.0,bus=pcie.0,addr=1c.7,multifunction=on \ (Usb 3.0 Controller 2)</p><p>The first thing i would have tested, is&#160; a different niceness, since i set it from 10 to 0 when i changed the Cards (setting it back to 10).</p><p>Maybe i test it another Time (I have backed up my Linux and repartitioned the Drives to use them all under Windows [except for the root drive, my second ssd, i wiped it and added it to my Mailserver as root Device, because of it&#039;s poor Performance]), but for the moment i am Happy with using Windows Native :-)</p><p>*EDIT* Some Corrections.</p> <p class="postedit"><em>Last edited by Child_of_Sun (2014-11-12 16:56:36)</em></p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1474790">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1474791" class="blockpost roweven"> <h2><span><span class="conr">#3233</span> <a href="viewtopic.php?pid=1474791#p1474791">2014-11-12 16:56:31</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=75590">aw</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2013-10-04</span></dd> <dd><span>Posts: 921</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=75590">Email</a></span> <span class="website"><a href="http://vfio.blogspot.com/" rel="nofollow">Website</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>Child_of_Sun wrote:</cite><blockquote><div><p>As i told before, i don&#039;t want to search for the Problem. I quit my testing with Qemu-KVM-Vfio not only because of the Performance, Powersaving is another Reason for it, don&#039;t want to&#160; blow 2000 kw/h per Anno for my private PC <img src="https://bbs.archlinux.org/img/smilies/big_smile.png" width="15" height="15" alt="big_smile" />.</p></div></blockquote></div><p>devianceluka and I were talking on irc yesterday and we think that AMD ZeroCore works for devices assigned with vfio.&#160; We still have all the same reasons that it doesn&#039;t always work on bare-metal though, in my case probably that I started using the hdmi audio.</p> </div> <div class="postsignature postmsg"><hr /><p><a href="http://vfio.blogspot.com" rel="nofollow">http://vfio.blogspot.com</a><br />Looking for a more open forum to discuss vfio related uses?&#160; Try <a href="https://www.redhat.com/mailman/listinfo/vfio-users" rel="nofollow">https://www.redhat.com/mailman/listinfo/vfio-users</a></p></div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1474791">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1474793" class="blockpost rowodd"> <h2><span><span class="conr">#3234</span> <a href="viewtopic.php?pid=1474793#p1474793">2014-11-12 17:04:55</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=83606">Child_of_Sun</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2014-07-16</span></dd> <dd><span>Posts: 8</span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>aw wrote:</cite><blockquote><div><div class="quotebox"><cite>Child_of_Sun wrote:</cite><blockquote><div><p>As i told before, i don&#039;t want to search for the Problem. I quit my testing with Qemu-KVM-Vfio not only because of the Performance, Powersaving is another Reason for it, don&#039;t want to&#160; blow 2000 kw/h per Anno for my private PC <img src="https://bbs.archlinux.org/img/smilies/big_smile.png" width="15" height="15" alt="big_smile" />.</p></div></blockquote></div><p>devianceluka and I were talking on irc yesterday and we think that AMD ZeroCore works for devices assigned with vfio.&#160; We still have all the same reasons that it doesn&#039;t always work on bare-metal though, in my case probably that I started using the hdmi audio.</p></div></blockquote></div><p>It&#039;s mainly because of the second Graphics card for the Host (since i now have a second PC as Mailserver, i wanted to save as much as Possible [I haven&#039;t got a Onboard Graphics device] and the second Monitor. :-)</p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1474793">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1474808" class="blockpost roweven"> <h2><span><span class="conr">#3235</span> <a href="viewtopic.php?pid=1474808#p1474808">2014-11-12 17:46:44</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=85314">Duelist</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2014-09-22</span></dd> <dd><span>Posts: 358</span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>dakabali wrote:</cite><blockquote><div><p>EDIT: Solved! The above described BIOS setting change did the trick. I had to remove the card bios from the configuration and everything works just fine. Summary: it has to explicitly be set in the BIOS which video card is the primary, &quot;auto&quot; might not be enough. Thanks for your kind help!</p></div></blockquote></div><p>Well, that&#039;s simple.<br />Your distributive has kernel mode setting or some other kind of framebuffer enabled.<br />It goes like this:<br />@ the system boot, one of the cards gets assigned as a primary one, and legacy VGA output methods are tied to it. Then the kernel boots up, claims those resources as aw said. Then you start a VM, it tries to pin the whole device, but fails, outputting you that first error line with BAR3.</p><p>Gigabyte motherboards (ASUS, for example, doesn&#039;t have this in their UEFI) allow you to manually choose which GPU will be the primary, instead of assuming that &quot;first 16x pci-e port is primary GPU&quot;.</p><p>Actually, swapping the cards physically would also help and it would be required to do so if you wouldn&#039;t have that UEFI setting. Or you could do what aw said: look up /proc/iomem, see some vesafb or nouveau or some other KMS/framebuffer stuff sitting on VGA MMIO range of the card in question, and go disable it. Oh noes, your system would usually lack a graphical loading screen(like plymouth). I think we can sacrifice that.</p> </div> <div class="postsignature postmsg"><hr /><p><span class="bbs">The forum rules prohibit requesting support for distributions other than arch.</span><br /><a href="https://bbs.archlinux.org/viewtopic.php?pid=1551460#p1551460" rel="nofollow">I gave up.</a><a href="https://bbs.archlinux.org/viewtopic.php?id=162768" rel="nofollow"> It was too late.</a><br /><a href="http://pastebin.com/B3fL84bq" rel="nofollow">What I was trying to do</a>.<br /><a href="http://vfio.blogspot.com/" rel="nofollow">The reference about VFIO and KVM VGA passthrough.</a></p></div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1474808">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1474809" class="blockpost rowodd"> <h2><span><span class="conr">#3236</span> <a href="viewtopic.php?pid=1474809#p1474809">2014-11-12 17:49:33</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=75590">aw</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2013-10-04</span></dd> <dd><span>Posts: 921</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=75590">Email</a></span> <span class="website"><a href="http://vfio.blogspot.com/" rel="nofollow">Website</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>dakabali wrote:</cite><blockquote><div><p>[ 9650.055230] vfio_ecap_init: 0000:01:00.0 hiding ecap 0x19@0x900</p></div></blockquote></div><p>BTW, this is just informational, not an error.</p> </div> <div class="postsignature postmsg"><hr /><p><a href="http://vfio.blogspot.com" rel="nofollow">http://vfio.blogspot.com</a><br />Looking for a more open forum to discuss vfio related uses?&#160; Try <a href="https://www.redhat.com/mailman/listinfo/vfio-users" rel="nofollow">https://www.redhat.com/mailman/listinfo/vfio-users</a></p></div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1474809">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1474814" class="blockpost roweven"> <h2><span><span class="conr">#3237</span> <a href="viewtopic.php?pid=1474814#p1474814">2014-11-12 17:57:31</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=85314">Duelist</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2014-09-22</span></dd> <dd><span>Posts: 358</span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>aw wrote:</cite><blockquote><div><div class="quotebox"><cite>Child_of_Sun wrote:</cite><blockquote><div><p>As i told before, i don&#039;t want to search for the Problem. I quit my testing with Qemu-KVM-Vfio not only because of the Performance, Powersaving is another Reason for it, don&#039;t want to&#160; blow 2000 kw/h per Anno for my private PC <img src="https://bbs.archlinux.org/img/smilies/big_smile.png" width="15" height="15" alt="big_smile" />.</p></div></blockquote></div><p>devianceluka and I were talking on irc yesterday and we think that AMD ZeroCore works for devices assigned with vfio.&#160; We still have all the same reasons that it doesn&#039;t always work on bare-metal though, in my case probably that I started using the hdmi audio.</p></div></blockquote></div><p>Well i can confirm that!<br />My crossfire setup has ULPS(ultra-low-power-state, actually it is zerocore itself) active, and it actually poweroffs the second, rarely used GPU. However, the first gpu doesn&#039;t change it&#039;s power state and doesn&#039;t adjust it&#039;s clocks, but that may be the metering issue here, as it requires some quirky way to check them.<br />The CPU also scales it&#039;s frequency nicely, without any problems so far. The variating frequency is seen inside the VM and on the host, yet cpu-z on VM tries to access some MSRs, which qemu doesn&#039;t pass, even when using -cpu host. That results in false multiplier and system bus clock meters, also i can&#039;t see the voltage and temperature. Neither i can do it on the host, <strong>thank you, AMD, for having such a quirky realization of thermometer, that it took A YEAR to fix native windows AMD OverDrive software. </strong></p><p>Also, when using the whole block device(like hdd) or maybe even scsi/sata controller passed through, it is real to cast a spindown(and TRIM also) command to the block device, putting it in it&#039;s power saving mode.</p> </div> <div class="postsignature postmsg"><hr /><p><span class="bbs">The forum rules prohibit requesting support for distributions other than arch.</span><br /><a href="https://bbs.archlinux.org/viewtopic.php?pid=1551460#p1551460" rel="nofollow">I gave up.</a><a href="https://bbs.archlinux.org/viewtopic.php?id=162768" rel="nofollow"> It was too late.</a><br /><a href="http://pastebin.com/B3fL84bq" rel="nofollow">What I was trying to do</a>.<br /><a href="http://vfio.blogspot.com/" rel="nofollow">The reference about VFIO and KVM VGA passthrough.</a></p></div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1474814">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1474894" class="blockpost rowodd"> <h2><span><span class="conr">#3238</span> <a href="viewtopic.php?pid=1474894#p1474894">2014-11-12 22:03:07</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=84760">Denso</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd class="postavatar"><img src="https://bbs.archlinux.org/img/avatars/84760.png?m=1412533733" width="71" height="80" alt="" /></dd> <dd><span>Registered: 2014-08-30</span></dd> <dd><span>Posts: 179</span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>Denso wrote:</cite><blockquote><div><div class="quotebox"><cite>aw wrote:</cite><blockquote><div><p>When you rebooted the host you saw this error, or do you mean after you rebooted with the new quirk you ran into this problem.&#160; The description doesn&#039;t make much sense to me.&#160; The error indicates that both devices tried to register with no flags (00000000), which I think means exclusive IRQ, which means the INTx disable masking test failed.&#160; By using nointxmask=1, you&#039;re telling vfio to use the same path that it should have been using based on those flags, so I&#039;m not sure why it makes a difference.</p></div></blockquote></div><p>It happened before and after I applied the new quirk . Sorry for not mentioning that <img src="https://bbs.archlinux.org/img/smilies/sad.png" width="15" height="15" alt="sad" /></p><p>It works with nointxmask=1 , but with sound being choppy and slow .</p><p>Also this might be related :</p><div class="codebox"><pre><code>...</code></pre></div><p>Sorry for my lack of knowledge , but I see that both devices use some identical IRQs . Maybe that&#039;s the issue here ?</p><p>EDIT :</p><p>One side note , I use these modules options /etc/modprobe.d/kvm.conf :</p><div class="codebox"><pre><code>options kvm ignore_msrs=1 options intel_kvm emulate_invalid_guest_state=0 options intel_kvm nested=1 options intel_kvm enable_shadow_vmcs=1 options intel_kvm enable_apicv=1 options intel_kvm ept=1 options vfio_pci nointxmask=1 options vfio_iommu_type1 disable_hugepages=1 options vfio_iommu_type1 allow_unsafe_interrupts=1</code></pre></div></div></blockquote></div><p>So I kept digging ! <img src="https://bbs.archlinux.org/img/smilies/smile.png" width="15" height="15" alt="smile" /></p><p>And I found the problem . the BIOS does a &quot;Full Initialization&quot; of the USB card upon booting , which causes all these issues . Setting &quot;USB Initialization&quot; to &quot;Partial Initalization&quot; in BIOS makes everything working like a charm again .</p><p>Hope this helps ! <img src="https://bbs.archlinux.org/img/smilies/smile.png" width="15" height="15" alt="smile" /></p> <p class="postedit"><em>Last edited by Denso (2014-11-12 22:37:42)</em></p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1474894">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1474898" class="blockpost roweven"> <h2><span><span class="conr">#3239</span> <a href="viewtopic.php?pid=1474898#p1474898">2014-11-12 22:07:39</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=86620">dakabali</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2014-11-11</span></dd> <dd><span>Posts: 7</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=86620">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>Duelist wrote:</cite><blockquote><div><p>Your distributive has kernel mode setting or some other kind of framebuffer enabled.<br />It goes like this:<br />@ the system boot, one of the cards gets assigned as a primary one, and legacy VGA output methods are tied to it. Then the kernel boots up, claims those resources as aw said. Then you start a VM, it tries to pin the whole device, but fails, outputting you that first error line with BAR3.</p></div></blockquote></div><p>I see. I find it confusing that Gigabyte calls this option &quot;Legacy only&quot;/&quot;Legacy first&quot; in their BIOS - I had no clue that this setting has something to do with the video card priorities... Trial and error has worked, anyway <img src="https://bbs.archlinux.org/img/smilies/smile.png" width="15" height="15" alt="smile" /></p><div class="quotebox"><blockquote><div><p>Gigabyte motherboards (ASUS, for example, doesn&#039;t have this in their UEFI) allow you to manually choose which GPU will be the primary, instead of assuming that &quot;first 16x pci-e port is primary GPU&quot;.</p></div></blockquote></div><p>Right. However, the available GPU slots are called&#160; &quot;PEG11&quot; &quot;PEG12&quot; and &quot;PEG60&quot; -&#160; I haven&#039;t found anything in the motherboard manual what they stand for. Btw any of these was selected and saved, after the next reboot it set back to &quot;Auto&quot;...</p><div class="quotebox"><blockquote><div><p>Actually, swapping the cards physically would also help and it would be required to do so if you wouldn&#039;t have that UEFI setting.</p></div></blockquote></div><p>No way. I&#039;ve got a microATM and my Titan card has got literally no space in the 2nd PIC-e <img src="https://bbs.archlinux.org/img/smilies/smile.png" width="15" height="15" alt="smile" /></p><p>Something else: can anyone tell me which is the latest working Nvidia driver pack for the passthrough setup? The latest avalable 344.65 installation breaks and falls back to 1024x768 after reboot. My Asus PG278Q monitor has come with 340.52 which works okay, but the Titan card will be shown as &quot;Unknown PCI device&quot; in the Win8.1 device manager.</p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1474898">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1474900" class="blockpost rowodd"> <h2><span><span class="conr">#3240</span> <a href="viewtopic.php?pid=1474900#p1474900">2014-11-12 22:15:17</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=75590">aw</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2013-10-04</span></dd> <dd><span>Posts: 921</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=75590">Email</a></span> <span class="website"><a href="http://vfio.blogspot.com/" rel="nofollow">Website</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>dakabali wrote:</cite><blockquote><div><div class="quotebox"><cite>Duelist wrote:</cite><blockquote><div><p>Your distributive has kernel mode setting or some other kind of framebuffer enabled.<br />It goes like this:<br />@ the system boot, one of the cards gets assigned as a primary one, and legacy VGA output methods are tied to it. Then the kernel boots up, claims those resources as aw said. Then you start a VM, it tries to pin the whole device, but fails, outputting you that first error line with BAR3.</p></div></blockquote></div><p>I see. I find it confusing that Gigabyte calls this option &quot;Legacy only&quot;/&quot;Legacy first&quot; in their BIOS - I had no clue that this setting has something to do with the video card priorities... Trial and error has worked, anyway <img src="https://bbs.archlinux.org/img/smilies/smile.png" width="15" height="15" alt="smile" /></p></div></blockquote></div><p>&quot;Legacy only vs Legacy first&quot; sounds more like preference of PCI option ROM execution, not ordering of VGA device.&#160; A PCI option ROM can contain multiple images, often one for legacy BIOS and one for UEFI.&#160; That option sounds like it&#039;s selecting which one to prefer.&#160; Using a similar option on my Asus board is how I determined my R7790 card came from XFX with a broken UEFI ROM.&#160; The bare metal system boots fine with Legacy First, but if I switch it to opt for the UEFI ROM the screen never turns on.</p> </div> <div class="postsignature postmsg"><hr /><p><a href="http://vfio.blogspot.com" rel="nofollow">http://vfio.blogspot.com</a><br />Looking for a more open forum to discuss vfio related uses?&#160; Try <a href="https://www.redhat.com/mailman/listinfo/vfio-users" rel="nofollow">https://www.redhat.com/mailman/listinfo/vfio-users</a></p></div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1474900">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1474913" class="blockpost roweven"> <h2><span><span class="conr">#3241</span> <a href="viewtopic.php?pid=1474913#p1474913">2014-11-12 23:18:05</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=79899">winie</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2014-03-01</span></dd> <dd><span>Posts: 17</span></dd> <dd class="usercontacts"><span class="email"><a href="mailto:alireza4051@yahoo.com">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>Flyser wrote:</cite><blockquote><div><div class="quotebox"><cite>aw wrote:</cite><blockquote><div><div class="quotebox"><cite>winie wrote:</cite><blockquote><div><p>Is there a way to fix the new nvidia drivers looking for hyper-v parameters? possibly in future releases of qemu or from inside windows?</p></div></blockquote></div><p>Are you asking for a solution beyond simply not using hyper-v extensions?&#160; You might want to revert back to an old nvidia driver and test whether it would be worthwhile.&#160; I don&#039;t know of anyone looking a further solutions.&#160; If you need hyper-v extensions, nvidia professional series cards or AMD cards might be a better option.</p></div></blockquote></div><p>I have been thinking about the whole nvidia situation and came up with two possible solutions. However I don&#039;t know enough about the details of PCI-E and emulation in general to tell if they are feasible or not.</p><p>The first idea is to &quot;softmod&quot; a GeForce to a Quadro by tapping in the vfio driver or pcie subsystem of the linux kernel. So instead of hardmodding the pci id with a soldering iron, you provide a fake pci id to the guest.</p><p>The second idea is mostly a hack. Since the nvidia driver checks the cpuid for hv_* features, would it be possible to patch qemu to change the cpuid during runtime? So during bootup when the nvidia driver is initialized, the hv_* features are hidden and only enabled after two minutes or via the qemu console.</p><p>Maybe @aw or others could comment if one of these approaches could work and which component of the stack needs to be patched.</p></div></blockquote></div><p>What about hacking the nvidia drivers?</p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1474913">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1474962" class="blockpost rowodd"> <h2><span><span class="conr">#3242</span> <a href="viewtopic.php?pid=1474962#p1474962">2014-11-13 06:39:36</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=85314">Duelist</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2014-09-22</span></dd> <dd><span>Posts: 358</span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <p>You guys may already know the news about microsoft getting .net core opensource and giving out free visual studio in 2015. That visual studio, due to xamarin framework and stuff, comes with an android emulator! The android emulator in question is based on <strong>HyperV</strong>.</p><p>So, it gets even more interesting to get the nested virtualization running. Windows 7 does not support HyperV, so to test the nested - you&#039;ll need to upgrade.<br /><strong>BUT</strong>.<br />Nvidia?<br />As it emulates the droid, we&#039;ll definitely need to run at least opengl1.1(they don&#039;t have opengl 2.0 support yet, but it isn&#039;t released in the public either), and that means we must have hardware acceleration. That means we need the drivers working.<br />Is it really possible to passthrough an nvidia card into the VM and have nested hyperv virtualization support without buying you-know-what?</p> </div> <div class="postsignature postmsg"><hr /><p><span class="bbs">The forum rules prohibit requesting support for distributions other than arch.</span><br /><a href="https://bbs.archlinux.org/viewtopic.php?pid=1551460#p1551460" rel="nofollow">I gave up.</a><a href="https://bbs.archlinux.org/viewtopic.php?id=162768" rel="nofollow"> It was too late.</a><br /><a href="http://pastebin.com/B3fL84bq" rel="nofollow">What I was trying to do</a>.<br /><a href="http://vfio.blogspot.com/" rel="nofollow">The reference about VFIO and KVM VGA passthrough.</a></p></div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1474962">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1474977" class="blockpost roweven"> <h2><span><span class="conr">#3243</span> <a href="viewtopic.php?pid=1474977#p1474977">2014-11-13 08:13:39</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=77842">Flyser</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2013-12-19</span></dd> <dd><span>Posts: 29</span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>aw wrote:</cite><blockquote><div><p>I&#039;m going to tread lightly here, but I will confirm that PCI config space of assigned devices is a combination of direct passthrough, emulation, and virtualization.&#160; PCI SR-IOV devices, by the spec, don&#039;t actually have PCI vendor and device IDs, it&#039;s up to system software/VMM to provide them.&#160; Likewise, it&#039;s a trivial matter to virtualize the PCI config space IDs - <a href="http://fpaste.org/149722/72280914/" rel="nofollow">http://fpaste.org/149722/72280914/</a>&#160; In the vast majority of cases, modifying the vendor ID is a bad idea, but I include it to be complete.</p><p>On a completely separate note, I&#039;ll mention that PCI device IDs are also stored in the PCI ROM and the ROM includes a checksum.&#160; In the <strong>unlikely</strong> event that you want to expose the ROM on a modified device, the device ID and checksum need to be updated.</p></div></blockquote></div><p>IT WORKS! <img src="https://bbs.archlinux.org/img/smilies/big_smile.png" width="15" height="15" alt="big_smile" /><br />I set the Quadro k4000 pci ids for my GTX660, supplied the VBIOS on the qemu cmdline and the latest nvidia quadro drivers work like a charm <img src="https://bbs.archlinux.org/img/smilies/smile.png" width="15" height="15" alt="smile" /></p><div class="quotebox"><cite>aw wrote:</cite><blockquote><div><p>Also note that supported Quadro devices operate in a secondary graphics mode, ie. in addition to emulated VGA.&#160; I&#039;ve also never had much luck getting them to work on Q35 machine types, but it&#039;s on my todo list to look further into the Code 12 they get there.&#160; They work fine on a 440FX machine.</p></div></blockquote></div><p>Thanks for the hint as I would have given up on the initial black screen^^. But why is that? From my understanding real quadro devices work as primary graphics devices. Is it possible to use them as such in qemu as well?</p> <p class="postedit"><em>Last edited by Flyser (2014-11-13 08:23:25)</em></p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1474977">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1474998" class="blockpost rowodd"> <h2><span><span class="conr">#3244</span> <a href="viewtopic.php?pid=1474998#p1474998">2014-11-13 10:35:09</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=84760">Denso</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd class="postavatar"><img src="https://bbs.archlinux.org/img/avatars/84760.png?m=1412533733" width="71" height="80" alt="" /></dd> <dd><span>Registered: 2014-08-30</span></dd> <dd><span>Posts: 179</span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>Flyser wrote:</cite><blockquote><div><p>I set the Quadro k4000 pci ids for my GTX660</p></div></blockquote></div><p>Can you explain how did you achieve that without soldering iron ?</p><p>Thank you .</p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1474998">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1475006" class="blockpost roweven"> <h2><span><span class="conr">#3245</span> <a href="viewtopic.php?pid=1475006#p1475006">2014-11-13 11:21:16</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=70922">nbhs</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd class="postavatar"><img src="https://bbs.archlinux.org/img/avatars/70922.jpg?m=1367773811" width="80" height="80" alt="" /></dd> <dd><span>From: Montevideo, Uruguay</span></dd> <dd><span>Registered: 2013-05-02</span></dd> <dd><span>Posts: 402</span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>Denso wrote:</cite><blockquote><div><div class="quotebox"><cite>Flyser wrote:</cite><blockquote><div><p>I set the Quadro k4000 pci ids for my GTX660</p></div></blockquote></div><p>Can you explain how did you achieve that without soldering iron ?</p><p>Thank you .</p><div class="quotebox"><cite>aw wrote:</cite><blockquote><div><p>aw wrote:<br />I&#039;m going to tread lightly here, but I will confirm that PCI config space of assigned devices is a combination of direct passthrough, emulation, and virtualization.&#160; PCI SR-IOV devices, by the spec, don&#039;t actually have PCI vendor and device IDs, it&#039;s up to system software/VMM to provide them.&#160; Likewise, it&#039;s a trivial matter to virtualize the PCI config space IDs - <a href="http://fpaste.org/149722/72280914/" rel="nofollow">http://fpaste.org/149722/72280914/</a>&#160; In the vast majority of cases, modifying the vendor ID is a bad idea, but I include it to be complete.<br />On a completely separate note, I&#039;ll mention that PCI device IDs are also stored in the PCI ROM and the ROM includes a checksum.&#160; In the unlikely event that you want to expose the ROM on a modified device, the device ID and checksum need to be updated.</p></div></blockquote></div></div></blockquote></div><div class="quotebox"><cite>aw wrote:</cite><blockquote><div><p>Also note that supported Quadro devices operate in a secondary graphics mode, ie. in addition to emulated VGA.&#160; I&#039;ve also never had much luck getting them to work on Q35 machine types, but it&#039;s on my todo list to look further into the Code 12 they get there.&#160; They work fine on a 440FX machine.</p></div></blockquote></div><p>I have a quadrified geforce 470gtx --&gt; quadro 5000 and i have no problems either using it as primary on q35 (i do get boot messages using romfile=) or secondary on 440fx</p><p>Q35 primary:</p><p><a href="http://i.imgur.com/YkvfrvH.jpg" rel="nofollow"><span class="postimg"><img src="http://i.imgur.com/xBl8Rhx.jpg" alt="xBl8Rhx.jpg" /></span></a></p><p>440FX secondary:</p><p><a href="http://i.imgur.com/yltPzAl.jpg" rel="nofollow"><span class="postimg"><img src="http://i.imgur.com/XlJ57LW.jpg" alt="XlJ57LW.jpg" /></span></a></p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1475006">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1475016" class="blockpost rowodd"> <h2><span><span class="conr">#3246</span> <a href="viewtopic.php?pid=1475016#p1475016">2014-11-13 12:05:59</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=84760">Denso</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd class="postavatar"><img src="https://bbs.archlinux.org/img/avatars/84760.png?m=1412533733" width="71" height="80" alt="" /></dd> <dd><span>Registered: 2014-08-30</span></dd> <dd><span>Posts: 179</span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <p>hmmm .. changing the device IDs to Quadros + keep Hyper-V enhancements , but is it REALLY worth it ?&#160; I did try to disable Hyper-V enhancements and I don&#039;t see any performance hit in any real world workload (Gaming , surfing &amp; multimedia) . So I think I&#039;ll stick with kvm=off and keep my nVidia drivers up to date .</p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1475016">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1475022" class="blockpost roweven"> <h2><span><span class="conr">#3247</span> <a href="viewtopic.php?pid=1475022#p1475022">2014-11-13 12:55:08</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=85314">Duelist</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2014-09-22</span></dd> <dd><span>Posts: 358</span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>nbhs wrote:</cite><blockquote><div><p>I have a quadrified geforce 470gtx --&gt; quadro 5000 and i have no problems either using it as primary on q35 (i do get boot messages using romfile=) or secondary on 440fx</p></div></blockquote></div><p>Huh?<br />Quadro 5000 core config: 352:44:40<br />GTX470 core config: 448:56:40.</p><p>Ummm.. Ummmm... like who gives a damn as long as the chip architecture is the same.</p> </div> <div class="postsignature postmsg"><hr /><p><span class="bbs">The forum rules prohibit requesting support for distributions other than arch.</span><br /><a href="https://bbs.archlinux.org/viewtopic.php?pid=1551460#p1551460" rel="nofollow">I gave up.</a><a href="https://bbs.archlinux.org/viewtopic.php?id=162768" rel="nofollow"> It was too late.</a><br /><a href="http://pastebin.com/B3fL84bq" rel="nofollow">What I was trying to do</a>.<br /><a href="http://vfio.blogspot.com/" rel="nofollow">The reference about VFIO and KVM VGA passthrough.</a></p></div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1475022">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1475037" class="blockpost rowodd"> <h2><span><span class="conr">#3248</span> <a href="viewtopic.php?pid=1475037#p1475037">2014-11-13 13:44:31</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=80387">dwe11er</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2014-03-18</span></dd> <dd><span>Posts: 73</span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>Duelist wrote:</cite><blockquote><div><div class="quotebox"><cite>nbhs wrote:</cite><blockquote><div><p>I have a quadrified geforce 470gtx --&gt; quadro 5000 and i have no problems either using it as primary on q35 (i do get boot messages using romfile=) or secondary on 440fx</p></div></blockquote></div><p>Huh?<br />Quadro 5000 core config: 352:44:40<br />GTX470 core config: 448:56:40.</p><p>Ummm.. Ummmm... like who gives a damn as long as the chip architecture is the same.</p></div></blockquote></div><p>Now wait for NVIDIA to check core configuration in their driver...</p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1475037">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1475165" class="blockpost roweven"> <h2><span><span class="conr">#3249</span> <a href="viewtopic.php?pid=1475165#p1475165">2014-11-13 21:14:16</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=86302">4kGamer</a></strong></dt> <dd class="usertitle"><strong>Banned</strong></dd> <dd><span>Registered: 2014-10-29</span></dd> <dd><span>Posts: 82</span></dd> <dd class="usercontacts"><span class="email"><a href="mailto:oktayaslantas@gmx.de">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>slis wrote:</cite><blockquote><div><p>It&#039;s normal to not detect any hdd&#039;s (storage drives in windows setup), cause windows doesn&#039;t have viritio drivers, thats why u mount viritio drivers as ide cdrom, so when windows shows select where to install screen, u got there option LOAD DRIVERS, click on it, select virtio cdrom, win8, drivers then select Red Hat Virtio Storage Driver and it should show your virtio disk.</p></div></blockquote></div><p>thank you! Finally I got it <img src="https://bbs.archlinux.org/img/smilies/smile.png" width="15" height="15" alt="smile" /> So I successfully installed Windows 8.1 after some hiccups I managed to install the &quot;Assassin&#039;s Creed Unity&quot;-ready Nvidia drivers (344.65) without any error code (43).</p><p>BUT then:</p><p>After a simple host reboot I got the CODE 43 back and I couldn&#039;t make it work again.</p><p>This is what I changed in the XML:</p><div class="quotebox"><blockquote><div><p>&lt;os&gt;<br />&#160; &#160; &lt;type arch=&#039;x86_64&#039; machine=&#039;pc-i440fx-2.2&#039;&gt;hvm&lt;/type&gt;<br />&#160; &#160; <strong>&lt;loader type=&#039;pflash&#039;&gt;/var/lib/libvirt/images/win8.1-OVMF.fd&lt;/loader&gt;</strong><br />&#160; &lt;/os&gt;</p></div></blockquote></div><div class="quotebox"><blockquote><div><p>&lt;features&gt;<br />&#160; &#160; &lt;acpi/&gt;<br />&#160; &#160; &lt;apic/&gt;<br />&#160; &#160; &lt;pae/&gt;<br />&#160; &#160; <strong>&lt;kvm&gt;<br />&#160; &#160; &#160; &lt;hidden state=&#039;on&#039;/&gt;<br />&#160; &#160; &lt;/kvm&gt;</strong><br />&#160; &lt;/features&gt;</p></div></blockquote></div><div class="quotebox"><blockquote><div><p>&lt;cpu mode=&#039;host-passthrough&#039;&gt;<br />&#160; &lt;/cpu&gt;<br />&#160; &lt;clock offset=&#039;utc&#039;/&gt;</p></div></blockquote></div><p>after that I ran virt-manager and added Nvidia GPU and Audio.</p><p>I use latest linux-mainline and provided by NBHS, ovmf-git, qemu-git and libvirt ...</p><p>this is how I start arch:</p><div class="quotebox"><blockquote><div><p>BOOT_IMAGE=/boot/vmlinuz-linux-mainline root=UUID=07c30ed1-3204-4c6a-8gd1-22r8ae54t1f5 rw i915.enable_hd_vgaarb=1 intel_iommu=on pcie_acs_override=downstream quiet</p></div></blockquote></div><br /><p>Is there something I forgot or got wrong? I am this close to game in 4k in a virtual machine, please help <img src="https://bbs.archlinux.org/img/smilies/smile.png" width="15" height="15" alt="smile" /></p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1475165">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1475167" class="blockpost rowodd"> <h2><span><span class="conr">#3250</span> <a href="viewtopic.php?pid=1475167#p1475167">2014-11-13 21:24:10</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=75590">aw</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2013-10-04</span></dd> <dd><span>Posts: 921</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=75590">Email</a></span> <span class="website"><a href="http://vfio.blogspot.com/" rel="nofollow">Website</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>4kGamer wrote:</cite><blockquote><div><p>Is there something I forgot or got wrong? I am this close to game in 4k in a virtual machine, please help <img src="https://bbs.archlinux.org/img/smilies/smile.png" width="15" height="15" alt="smile" /></p></div></blockquote></div><p>Assuming they haven&#039;t added anything new, any of the following will cause a Code 43:</p><p>&#160; &lt;features&gt;<br /><strong>&#160; &#160; &lt;hyperv&gt;<br />&#160; &#160; &#160; &lt;relaxed state=&#039;on&#039;/&gt;<br />&#160; &#160; &#160; &lt;vapic state=&#039;on&#039;/&gt;<br />&#160; &#160; &#160; &lt;spinlocks state=&#039;on&#039; retries=&#039;8191&#039;/&gt;<br />&#160; &#160; &lt;/hyperv&gt;</strong><br />&#160; &lt;/features&gt;</p><p>&#160; &lt;clock offset=&#039;localtime&#039;&gt;<br /><strong>&#160; &#160; &lt;timer name=&#039;hypervclock&#039; present=&#039;yes&#039;/&gt;</strong><br />&#160; &lt;/clock&gt;</p> </div> <div class="postsignature postmsg"><hr /><p><a href="http://vfio.blogspot.com" rel="nofollow">http://vfio.blogspot.com</a><br />Looking for a more open forum to discuss vfio related uses?&#160; Try <a href="https://www.redhat.com/mailman/listinfo/vfio-users" rel="nofollow">https://www.redhat.com/mailman/listinfo/vfio-users</a></p></div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1475167">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div class="postlinksb"> <div class="inbox crumbsplus"> <div class="pagepost"> <p class="pagelink conl"><span class="pages-label">Pages: </span><a rel="prev" class="item1" href="viewtopic.php?id=162768&amp;p=129">Previous</a> <a href="viewtopic.php?id=162768">1</a> <span class="spacer">…</span> <a href="viewtopic.php?id=162768&amp;p=128">128</a> <a href="viewtopic.php?id=162768&amp;p=129">129</a> <strong>130</strong> <a href="viewtopic.php?id=162768&amp;p=131">131</a> <a href="viewtopic.php?id=162768&amp;p=132">132</a> <span class="spacer">…</span> <a href="viewtopic.php?id=162768&amp;p=234">234</a> <a rel="next" href="viewtopic.php?id=162768&amp;p=131">Next</a></p> <p class="postlink conr">Topic closed</p> </div> <ul class="crumbs"> <li><a href="index.php">Index</a></li> <li><span>»&#160;</span><a href="viewforum.php?id=48">Topics Going Nowhere</a></li> <li><span>»&#160;</span><strong><a href="viewtopic.php?id=162768">KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</a></strong></li> </ul> <p class="subscribelink clearb"><a href="misc.php?action=subscribe&amp;tid=162768">Subscribe to this topic</a></p> <div class="clearer"></div> </div> </div> </div> <div id="brdfooter" class="block"> <h2><span>Board footer</span></h2> <div class="box"> <div id="brdfooternav" class="inbox"> <div class="conl"> <form id="qjump" method="get" action="viewforum.php"> <div><label><span>Jump to<br /></span> <select name="id" onchange="window.location=('viewforum.php?id='+this.options[this.selectedIndex].value)"> <optgroup label="Technical Issues and Assistance"> <option value="23">Newbie Corner</option> <option value="17">Installation</option> <option value="22">Kernel &amp; Hardware</option> <option value="18">Applications &amp; Desktop Environments</option> <option value="31">Laptop Issues</option> <option value="8">Networking, Server, and Protection</option> <option value="32">Multimedia and Games</option> <option value="50">System Administration</option> <option value="35">Other Architectures</option> </optgroup> <optgroup label="Arch-centric"> <option value="24">Announcements, Package &amp; Security Advisories</option> <option value="1">Arch Discussion</option> <option value="13">Forum &amp; Wiki discussion</option> </optgroup> <optgroup label="Pacman Upgrades, Packaging &amp; AUR"> <option value="44">Pacman &amp; Package Upgrade Issues</option> <option value="49">[testing] Repo Forum</option> <option value="4">Creating &amp; Modifying Packages</option> <option value="38">AUR Issues, Discussion &amp; PKGBUILD Requests</option> </optgroup> <optgroup label="Contributions &amp; Discussion"> <option value="20">GNU/Linux Discussion</option> <option value="27">Community Contributions</option> <option value="33">Programming &amp; Scripting</option> <option value="30">Other Languages</option> <option value="47">Artwork and Screenshots</option> <option value="42">Try This</option> </optgroup> <optgroup label="/dev/null"> <option value="29">Off-Topic</option> <option value="48" selected="selected">Topics Going Nowhere</option> <option value="36">Dustbin</option> </optgroup> </select></label> <input type="submit" value=" Go " accesskey="g" /> </div> </form> </div> <div class="conr"> <p id="feedlinks"><span class="atom"><a href="extern.php?action=feed&amp;tid=162768&amp;type=atom">Atom topic feed</a></span></p> <p id="poweredby">Powered by <a href="http://fluxbb.org/">FluxBB</a></p> </div> <div class="clearer"></div> </div> </div> </div> </div> <div class="end-box"></div> </div> </body> </html>
