<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"> <html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en" dir="ltr"> <head> <meta http-equiv="Content-Type" content="text/html; charset=utf-8" /> <title>KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9 (Page 28) / Topics Going Nowhere / Arch Linux Forums</title> <link rel="stylesheet" type="text/css" href="style/ArchLinux.css" /> <link rel="canonical" href="viewtopic.php?id=162768&amp;p=28" title="Page 28" /> <link rel="prev" href="viewtopic.php?id=162768&amp;p=27" title="Page 27" /> <link rel="next" href="viewtopic.php?id=162768&amp;p=29" title="Page 29" /> <link rel="alternate" type="application/atom+xml" href="extern.php?action=feed&amp;tid=162768&amp;type=atom" title="Atom topic feed" /> <link rel="stylesheet" media="screen" href="style/ArchLinux/arch.css?v=3" /> <link rel="stylesheet" media="screen" href="style/ArchLinux/archnavbar.css?v=2" /> <link rel="shortcut icon" href="style/ArchLinux/favicon.ico" /> </head> <body> <div id="archnavbar" class="anb-forum"> <div id="archnavbarlogo"><h1><a href="http://www.archlinux.org/">Arch Linux</a></h1></div> <div id="archnavbarmenu"> <ul id="archnavbarlist"> <li id="anb-home"><a href="http://www.archlinux.org/">Home</a></li><li id="anb-packages"><a href="http://www.archlinux.org/packages/">Packages</a></li><li id="anb-forums" class="anb-selected"><a href="https://bbs.archlinux.org/">Forums</a></li><li id="anb-wiki"><a href="https://wiki.archlinux.org/">Wiki</a></li><li id="anb-bugs"><a href="https://bugs.archlinux.org/">Bugs</a></li><li id="anb-aur"><a href="https://aur.archlinux.org/">AUR</a></li><li id="anb-download"><a href="http://www.archlinux.org/download/">Download</a></li> </ul> </div> </div> <div id="punviewtopic" class="pun"> <div class="top-box"></div> <div class="punwrap"> <div id="brdheader" class="block"> <div class="box"> <div id="brdmenu" class="inbox"> <ul> <li id="navindex" class="isactive"><a href="index.php">Index</a></li> <li id="navuserlist"><a href="userlist.php">User list</a></li> <li id="navsearch"><a href="search.php">Search</a></li> <li id="navprofile"><a href="profile.php?id=80749">Profile</a></li> <li id="navlogout"><a href="login.php?action=out&amp;id=80749&amp;csrf_token=5c20501ec397bb45ef8ee8c84db232c8d8e421c6">Logout</a></li> </ul> </div> <div id="brdwelcome" class="inbox"> <ul class="conl"> <li><span>Logged in as <strong>SXX</strong></span></li> <li><span>Last visit: 2015-08-16 12:20:09</span></li> </ul> <ul class="conr"> <li><span>Topics: <a href="search.php?action=show_replies" title="Find topics you have posted to.">Posted</a> | <a href="search.php?action=show_new" title="Find topics with new posts since your last visit.">New</a> | <a href="search.php?action=show_recent" title="Find topics with recent posts.">Active</a> | <a href="search.php?action=show_unanswered" title="Find topics with no replies.">Unanswered</a></span></li> </ul> <div class="clearer"></div> </div> </div> </div> <div id="brdmain"> <div class="linkst"> <div class="inbox crumbsplus"> <ul class="crumbs"> <li><a href="index.php">Index</a></li> <li><span>»&#160;</span><a href="viewforum.php?id=48">Topics Going Nowhere</a></li> <li><span>»&#160;</span><strong><a href="viewtopic.php?id=162768">KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</a></strong></li> </ul> <div class="pagepost"> <p class="pagelink conl"><span class="pages-label">Pages: </span><a rel="prev" class="item1" href="viewtopic.php?id=162768&amp;p=27">Previous</a> <a href="viewtopic.php?id=162768">1</a> <span class="spacer">…</span> <a href="viewtopic.php?id=162768&amp;p=26">26</a> <a href="viewtopic.php?id=162768&amp;p=27">27</a> <strong>28</strong> <a href="viewtopic.php?id=162768&amp;p=29">29</a> <a href="viewtopic.php?id=162768&amp;p=30">30</a> <span class="spacer">…</span> <a href="viewtopic.php?id=162768&amp;p=234">234</a> <a rel="next" href="viewtopic.php?id=162768&amp;p=29">Next</a></p> <p class="postlink conr">Topic closed</p> </div> <div class="clearer"></div> </div> </div> <div id="p1345627" class="blockpost rowodd blockpost1"> <h2><span><span class="conr">#676</span> <a href="viewtopic.php?pid=1345627#p1345627">2013-11-04 18:41:41</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=60955">Unnamed_Hero</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2012-06-12</span></dd> <dd><span>Posts: 3</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=60955">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <p>Hi to all. I have a problem starting test qemu machine. <br />I&#039;m using kernel 3.11.6, qemu 1.6.1-2</p><p>I bind Radeon card (2 ids) with vfio-bind script. (BTW, should I bind Radeon&#039;s PCI-E with this script<strong>?</strong>)</p><p>My error message:</p><div class="codebox"><pre><code>qemu-system-x86_64: -device vfio-pci,host=00:01.1,bus=root.1,addr=00.1: vfio: error, group 1 is not viable, please ensure all devices within the iommu_group are bound to their vfio bus driver</code></pre></div><br /><br /><p>My card list:</p><div class="codebox"><pre><code>01:00.0 VGA compatible controller: NVIDIA Corporation GK106 [GeForce GTX 660] (rev a1) 02:00.0 VGA compatible controller: Advanced Micro Devices, Inc. [AMD/ATI] Tahiti XT [Radeon HD 7970]</code></pre></div><p>Nvidia is for Linux host, Radeon is for Windows guest.</p><p>My IOMMU list is</p><div class="codebox"><pre><code>lrwxrwxrwx 1 root root 0 ноя 4 21:03 0000:00:01.0 -&gt; ../../../../devices/pci0000:00/0000:00:01.0 &lt;--PCI-E 0 &lt; Nvidia lrwxrwxrwx 1 root root 0 ноя 4 21:03 0000:00:01.1 -&gt; ../../../../devices/pci0000:00/0000:00:01.1 &lt;--PCI-E 1 &lt; Radeon lrwxrwxrwx 1 root root 0 ноя 4 21:03 0000:01:00.0 -&gt; ../../../../devices/pci0000:00/0000:00:01.0/0000:01:00.0 &lt;-- Nvidia lrwxrwxrwx 1 root root 0 ноя 4 21:03 0000:01:00.1 -&gt; ../../../../devices/pci0000:00/0000:00:01.0/0000:01:00.1 &lt;-- Nvidia lrwxrwxrwx 1 root root 0 ноя 4 21:03 0000:02:00.0 -&gt; ../../../../devices/pci0000:00/0000:00:01.1/0000:02:00.0 &lt;-- Radeon lrwxrwxrwx 1 root root 0 ноя 4 21:03 0000:02:00.1 -&gt; ../../../../devices/pci0000:00/0000:00:01.1/0000:02:00.1 &lt;-- Radeon</code></pre></div><p>So, I can&#039;t unbind my system video.</p><p>What should I do?</p> <p class="postedit"><em>Last edited by Unnamed_Hero (2013-11-04 18:42:24)</em></p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1345627">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1345641" class="blockpost roweven"> <h2><span><span class="conr">#677</span> <a href="viewtopic.php?pid=1345641#p1345641">2013-11-04 19:06:09</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=75590">aw</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2013-10-04</span></dd> <dd><span>Posts: 921</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=75590">Email</a></span> <span class="website"><a href="http://vfio.blogspot.com/" rel="nofollow">Website</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>Unnamed_Hero wrote:</cite><blockquote><div><p>Hi to all. I have a problem starting test qemu machine. <br />I&#039;m using kernel 3.11.6, qemu 1.6.1-2</p><p>I bind Radeon card (2 ids) with vfio-bind script. (BTW, should I bind Radeon&#039;s PCI-E with this script<strong>?</strong>)</p><p>My error message:</p><div class="codebox"><pre><code>qemu-system-x86_64: -device vfio-pci,host=00:01.1,bus=root.1,addr=00.1: vfio: error, group 1 is not viable, please ensure all devices within the iommu_group are bound to their vfio bus driver</code></pre></div><br /><br /><p>My card list:</p><div class="codebox"><pre><code>01:00.0 VGA compatible controller: NVIDIA Corporation GK106 [GeForce GTX 660] (rev a1) 02:00.0 VGA compatible controller: Advanced Micro Devices, Inc. [AMD/ATI] Tahiti XT [Radeon HD 7970]</code></pre></div><p>Nvidia is for Linux host, Radeon is for Windows guest.</p><p>My IOMMU list is</p><div class="codebox"><pre><code>lrwxrwxrwx 1 root root 0 ноя 4 21:03 0000:00:01.0 -&gt; ../../../../devices/pci0000:00/0000:00:01.0 &lt;--PCI-E 0 &lt; Nvidia lrwxrwxrwx 1 root root 0 ноя 4 21:03 0000:00:01.1 -&gt; ../../../../devices/pci0000:00/0000:00:01.1 &lt;--PCI-E 1 &lt; Radeon lrwxrwxrwx 1 root root 0 ноя 4 21:03 0000:01:00.0 -&gt; ../../../../devices/pci0000:00/0000:00:01.0/0000:01:00.0 &lt;-- Nvidia lrwxrwxrwx 1 root root 0 ноя 4 21:03 0000:01:00.1 -&gt; ../../../../devices/pci0000:00/0000:00:01.0/0000:01:00.1 &lt;-- Nvidia lrwxrwxrwx 1 root root 0 ноя 4 21:03 0000:02:00.0 -&gt; ../../../../devices/pci0000:00/0000:00:01.1/0000:02:00.0 &lt;-- Radeon lrwxrwxrwx 1 root root 0 ноя 4 21:03 0000:02:00.1 -&gt; ../../../../devices/pci0000:00/0000:00:01.1/0000:02:00.1 &lt;-- Radeon</code></pre></div><p>So, I can&#039;t unbind my system video.</p><p>What should I do?</p></div></blockquote></div><p>First, things are not going to work with the kernel and qemu versions you have.&#160; See the first post for where to get the right versions.&#160; You will need to build from source.</p><p>Next, if your IOMMU group doesn&#039;t let you separate devices it&#039;s because the root ports do not support PCI ACS and we therefore must assume that peer-to-peer traffic between subordinates of those roots is possible.&#160; The long term fix for this is Intel properly supporting ACS on root ports and providing a white list for existing devices.&#160; We&#039;re working with them to do that.&#160; In the interim, several people here are using this patch: <a href="https://lkml.org/lkml/2013/5/30/513" rel="nofollow">https://lkml.org/lkml/2013/5/30/513</a>&#160; This was rejected upstream, so you&#039;ll need to patch it in.</p><p>Finally, I assume by &quot;PCI-E&quot; you mean the root port the device is attached to (00:01.0 &amp; 00:01.1 in your listing), and no, that should not be bound to vfio-pci.</p><p>Also note that if you&#039;re using the proprietary nvidia driver in the host it will grab the VGA arbiter lock and never release it.&#160; The result will be that the first VGA access made by the guest for the Radeon device will hang.&#160; There&#039;s a patch floating around to modify the nvidia driver wrapper to avoid this, perhaps someone can share a link.</p> </div> <div class="postsignature postmsg"><hr /><p><a href="http://vfio.blogspot.com" rel="nofollow">http://vfio.blogspot.com</a><br />Looking for a more open forum to discuss vfio related uses?&#160; Try <a href="https://www.redhat.com/mailman/listinfo/vfio-users" rel="nofollow">https://www.redhat.com/mailman/listinfo/vfio-users</a></p></div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1345641">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1345644" class="blockpost rowodd"> <h2><span><span class="conr">#678</span> <a href="viewtopic.php?pid=1345644#p1345644">2013-11-04 19:13:33</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=53953">andy123</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2011-11-04</span></dd> <dd><span>Posts: 169</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=53953">Email</a></span> <span class="website"><a href="http://ajs124.de" rel="nofollow">Website</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>aw wrote:</cite><blockquote><div><p>There&#039;s a patch floating around to modify the nvidia driver wrapper to avoid this, perhaps someone can share a link.</p></div></blockquote></div><p>That&#039;s actually in the first post, too under &quot;ISSUES&quot;.</p> </div> <div class="postsignature postmsg"><hr /><p>i&#039;m sorry for my poor english wirting skills…</p></div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1345644">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1345651" class="blockpost roweven"> <h2><span><span class="conr">#679</span> <a href="viewtopic.php?pid=1345651#p1345651">2013-11-04 19:27:21</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=70922">nbhs</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd class="postavatar"><img src="https://bbs.archlinux.org/img/avatars/70922.jpg?m=1367773811" width="80" height="80" alt="" /></dd> <dd><span>From: Montevideo, Uruguay</span></dd> <dd><span>Registered: 2013-05-02</span></dd> <dd><span>Posts: 402</span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <p>I have uploaded kernel 3.12.0 (includes acs override patch + i915 patches) and qemu-git (with NoSnoop patch) on the first post</p> <p class="postedit"><em>Last edited by nbhs (2013-11-04 19:27:35)</em></p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1345651">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1345660" class="blockpost rowodd"> <h2><span><span class="conr">#680</span> <a href="viewtopic.php?pid=1345660#p1345660">2013-11-04 19:55:08</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=70922">nbhs</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd class="postavatar"><img src="https://bbs.archlinux.org/img/avatars/70922.jpg?m=1367773811" width="80" height="80" alt="" /></dd> <dd><span>From: Montevideo, Uruguay</span></dd> <dd><span>Registered: 2013-05-02</span></dd> <dd><span>Posts: 402</span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <p>Looks like some dudes got OSX mavericks working on qemu-kvm on intel hardware <a href="http://www.linux.org.ru/gallery/screenshots/9732976" rel="nofollow">http://www.linux.org.ru/gallery/screenshots/9732976</a>, also see: <a href="http://www.contrib.andrew.cmu.edu/~somlo/OSXKVM/" rel="nofollow">http://www.contrib.andrew.cmu.edu/~somlo/OSXKVM/</a></p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1345660">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1345663" class="blockpost roweven"> <h2><span><span class="conr">#681</span> <a href="viewtopic.php?pid=1345663#p1345663">2013-11-04 20:03:07</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=73162">myweb</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2013-07-13</span></dd> <dd><span>Posts: 68</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=73162">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <p>Dear all,</p><p>Could you please help to solve Nvidia driver issue on the guest (nouveau driver works OK, but I need Nvidia due to hardware video acceleration):</p><div class="codebox"><pre><code>[ 42.409] Loading extension NV-GLX [ 44.409] (EE) NVIDIA(GPU-0): WAIT: (E, 0, 0x917d)</code></pre></div><p>I receive the messages when I run startx and when I run xbmc via&#160; &quot;xinit /usr/bin/xbmc-standalone&quot; I receive the following:</p><div class="codebox"><pre><code>[ 5709.592] (EE) NVIDIA(0): The NVIDIA kernel module does not appear to be receiving [ 5709.592] (EE) NVIDIA(0): interrupts generated by the NVIDIA GPU at PCI:1:0:0. [ 5709.592] (EE) NVIDIA(0): Please see Chapter 8: Common Problems in the README for [ 5709.592] (EE) NVIDIA(0): additional information. [ 5709.592] (EE) NVIDIA(0): Failed to initialize the NVIDIA graphics device! [ 5709.592] (EE) NVIDIA(0): Failing initialization of X screen 0</code></pre></div><p>lspci -v shows the following (IRQ 16 is shared between GPU and SMBus Controller)</p><div class="codebox"><pre><code>00:1f.3 SMBus: Intel Corporation 82801I (ICH9 Family) SMBus Controller (rev 02) Subsystem: Red Hat, Inc Device 1100 Physical Slot: 31 Flags: fast devsel, IRQ 16 I/O ports at b100 [size=64] Kernel driver in use: i801_smbus Kernel modules: i2c_i801 01:00.0 VGA compatible controller: NVIDIA Corporation GK107 [GeForce GT 640] (rev a1) (prog-if 00 [VGA controller]) Subsystem: ASUSTeK Computer Inc. Device 840e Physical Slot: 0 Flags: bus master, fast devsel, latency 0, IRQ 16 Memory at fc000000 (32-bit, non-prefetchable) [size=16M] Memory at d0000000 (64-bit, prefetchable) [size=256M] Memory at e0000000 (64-bit, prefetchable) [size=32M] I/O ports at c000 [size=128] [virtual] Expansion ROM at fd000000 [disabled] [size=512K] Capabilities: [60] Power Management version 3 Capabilities: [68] MSI: Enable- Count=1/1 Maskable- 64bit+ Capabilities: [78] Express Endpoint, MSI 00 Capabilities: [b4] Vendor Specific Information: Len=14 &lt;?&gt; Capabilities: [100] Virtual Channel Capabilities: [128] Power Budgeting &lt;?&gt; Capabilities: [600] Vendor Specific Information: ID=0001 Rev=1 Len=024 &lt;?&gt; Kernel driver in use: nvidia Kernel modules: nouveau, nvidia</code></pre></div><p>Could you please help to &quot;disable&quot; sharing GPU IRQ?</p> <p class="postedit"><em>Last edited by myweb (2013-11-04 21:40:31)</em></p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1345663">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1345697" class="blockpost rowodd"> <h2><span><span class="conr">#682</span> <a href="viewtopic.php?pid=1345697#p1345697">2013-11-04 21:38:54</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=75590">aw</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2013-10-04</span></dd> <dd><span>Posts: 921</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=75590">Email</a></span> <span class="website"><a href="http://vfio.blogspot.com/" rel="nofollow">Website</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>myweb wrote:</cite><blockquote><div><p>Dear all,</p><p>Could you please help to solve Nvidia driver issue on the guest (nouveau driver works OK, but I need Nvidia due to hardware video acceleration):</p><div class="codebox"><pre><code>[ 42.409] Loading extension NV-GLX [ 44.409] (EE) NVIDIA(GPU-0): WAIT: (E, 0, 0x917d)</code></pre></div><p>I receive the messages when I run startx and when I run xbmc via&#160; &quot;xinit /usr/bin/xbmc-standalone&quot; I receive the following:</p><div class="codebox"><pre><code>[ 5709.592] (EE) NVIDIA(0): The NVIDIA kernel module does not appear to be receiving [ 5709.592] (EE) NVIDIA(0): interrupts generated by the NVIDIA GPU at PCI:1:0:0. [ 5709.592] (EE) NVIDIA(0): Please see Chapter 8: Common Problems in the README for [ 5709.592] (EE) NVIDIA(0): additional information. [ 5709.592] (EE) NVIDIA(0): Failed to initialize the NVIDIA graphics device! [ 5709.592] (EE) NVIDIA(0): Failing initialization of X screen 0</code></pre></div></div></blockquote></div><p>Have you tried NVreg_EnableMSI=1 as a nvidia module options?&#160; Check /proc/interrupts on the host to see if we&#039;re seeing an interrupt there (grep vfio /proc/interrupts).</p> </div> <div class="postsignature postmsg"><hr /><p><a href="http://vfio.blogspot.com" rel="nofollow">http://vfio.blogspot.com</a><br />Looking for a more open forum to discuss vfio related uses?&#160; Try <a href="https://www.redhat.com/mailman/listinfo/vfio-users" rel="nofollow">https://www.redhat.com/mailman/listinfo/vfio-users</a></p></div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1345697">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1345700" class="blockpost roweven"> <h2><span><span class="conr">#683</span> <a href="viewtopic.php?pid=1345700#p1345700">2013-11-04 21:48:32</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=73162">myweb</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2013-07-13</span></dd> <dd><span>Posts: 68</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=73162">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="codebox"><pre><code>sudo modprobe nvidia NVreg_EnableMSI=1</code></pre></div><p>does not help</p><p>grep vfio /proc/interrupts</p><div class="codebox"><pre><code>16: 5513 3621 960 109 IR-IO-APIC-fasteoi vfio-intx(0000:00:1a.0), vfio-intx(0000:01:00.0) 17: 393 209 261 120 IR-IO-APIC-fasteoi saa7146 (0), vfio-intx(0000:01:00.1)</code></pre></div><p>0000:00:1a.0 - is USB controller<br />I run qemu with the following options</p><div class="codebox"><pre><code>qemu-system-x86_64 -M q35 -m 4096 -enable-kvm -cpu host -vga none -nographic -boot menu=on \ -smp 4,sockets=4,cores=4,threads=4 \ -device ahci,bus=pcie.0,id=ahci \ -device ioh3420,bus=pcie.0,addr=1c.0,multifunction=on,port=1,chassis=1,id=root.1 \ -device vfio-pci,host=01:00.0,x-vga=on,addr=0.0,multifunction=on,bus=root.1 \ -device vfio-pci,host=01:00.1,bus=pcie.0 \ -device vfio-pci,host=00:1a.0,bus=pcie.0 \ -drive file=/dev/sda6,id=rootDisk,format=raw -device ide-hd,bus=ahci.0,drive=rootDisk \ -drive file=/dev/sda7,id=swapDisk,format=raw -device ide-hd,bus=ahci.1,drive=swapDisk \ -netdev bridge,br=br0,id=hostnet0 -device virtio-net-pci,netdev=hostnet0,id=net0</code></pre></div><br /><p>I removed USB controller from qemu options and see the following in Xorg.log</p><div class="codebox"><pre><code>[ 176.854] (II) NVIDIA(0): Validated MetaModes: [ 176.854] (II) NVIDIA(0): &quot;DFP-0:nvidia-auto-select{}&quot; [ 176.854] (II) NVIDIA(0): Virtual screen size determined to be 1920 x 1200 [ 176.889] (--) NVIDIA(0): DPI set to (90, 87); computed from &quot;UseEdidDpi&quot; X config [ 176.889] (--) NVIDIA(0): option [ 176.889] (--) Depth 24 pixmap format is 32 bpp [ 176.890] (II) NVIDIA: Using 3072.00 MB of virtual memory for indirect memory [ 176.890] (II) NVIDIA: access. [ 176.894] (II) NVIDIA(0): ACPI: failed to connect to the ACPI event daemon; the daemon [ 176.894] (II) NVIDIA(0): may not be running or the &quot;AcpidSocketPath&quot; X [ 176.894] (II) NVIDIA(0): configuration option may not be set correctly. When the [ 176.894] (II) NVIDIA(0): ACPI event daemon is available, the NVIDIA X driver will [ 176.894] (II) NVIDIA(0): try to use it to receive ACPI event notifications. For [ 176.894] (II) NVIDIA(0): details, please see the &quot;ConnectToAcpid&quot; and [ 176.894] (II) NVIDIA(0): &quot;AcpidSocketPath&quot; X configuration options in Appendix B: X [ 176.894] (II) NVIDIA(0): Config Options in the README. [ 176.896] (II) NVIDIA(0): Setting mode &quot;DFP-0:nvidia-auto-select{}&quot; [ 179.920] Loading extension NV-GLX [ 181.920] (EE) NVIDIA(GPU-0): WAIT: (E, 0, 0x917d)</code></pre></div> <p class="postedit"><em>Last edited by myweb (2013-11-04 22:00:19)</em></p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1345700">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1345704" class="blockpost rowodd"> <h2><span><span class="conr">#684</span> <a href="viewtopic.php?pid=1345704#p1345704">2013-11-04 22:01:45</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=76479">Norcoen</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>From: Norway</span></dd> <dd><span>Registered: 2013-11-02</span></dd> <dd><span>Posts: 23</span></dd> <dd class="usercontacts"><span class="email"><a href="mailto:frankmoll@gmx.net">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>kaeptnb wrote:</cite><blockquote><div><p>like this:</p><p>kernel commandline parameter: pci-stub.ids=1002:6819,1002:aab0</p><p>the id&#039;s are not the PCI Bus IDs, but the Device Class/Subclass - you get them with &quot;lspci -vn&quot;</p></div></blockquote></div><div class="codebox"><pre class="vscroll"><code># lspci -vnn 03:00.0 SATA controller [0106]: ASMedia Technology Inc. ASM1062 Serial ATA Controller [1b21:0612] (rev 01) (prog-if 01 [AHCI 1.0]) Subsystem: ASRock Incorporation Motherboard [1849:0612] Flags: bus master, fast devsel, latency 0, IRQ 47 I/O ports at d050 [size=8] I/O ports at d040 [size=4] I/O ports at d030 [size=8] I/O ports at d020 [size=4] I/O ports at d000 [size=32] Memory at f0d00000 (32-bit, non-prefetchable) [size=512] Capabilities: [50] MSI: Enable+ Count=1/1 Maskable- 64bit- Capabilities: [78] Power Management version 3 Capabilities: [80] Express Legacy Endpoint, MSI 00 Capabilities: [100] Virtual Channel Kernel driver in use: ahci [...] 05:00.0 SATA controller [0106]: ASMedia Technology Inc. ASM1062 Serial ATA Controller [1b21:0612] (rev 01) (prog-if 01 [AHCI 1.0]) Subsystem: ASRock Incorporation Motherboard [1849:0612] Flags: bus master, fast devsel, latency 0, IRQ 48 I/O ports at b050 [size=8] I/O ports at b040 [size=4] I/O ports at b030 [size=8] I/O ports at b020 [size=4] I/O ports at b000 [size=32] Memory at f0b00000 (32-bit, non-prefetchable) [size=512] Capabilities: [50] MSI: Enable+ Count=1/1 Maskable- 64bit- Capabilities: [78] Power Management version 3 Capabilities: [80] Express Legacy Endpoint, MSI 00 Capabilities: [100] Virtual Channel Kernel driver in use: ahci [...] 08:00.0 SATA controller [0106]: ASMedia Technology Inc. ASM1062 Serial ATA Controller [1b21:0612] (rev 01) (prog-if 01 [AHCI 1.0]) Subsystem: ASMedia Technology Inc. Device [1b21:1060] Flags: bus master, fast devsel, latency 0, IRQ 49 I/O ports at a050 [size=8] I/O ports at a040 [size=4] I/O ports at a030 [size=8] I/O ports at a020 [size=4] I/O ports at a000 [size=32] Memory at f0910000 (32-bit, non-prefetchable) [size=512] Expansion ROM at f0900000 [disabled] [size=64K] Capabilities: [50] MSI: Enable+ Count=1/1 Maskable- 64bit- Capabilities: [78] Power Management version 3 Capabilities: [80] Express Legacy Endpoint, MSI 00 Capabilities: [100] Virtual Channel Kernel driver in use: ahci [...]</code></pre></div><p>So you mean I should not use vendor:device [1b21:0612] but from the ?Subsystem? ID: [1b21:1060] as pci-stub kernelparameter?<br />Does it matter at this point, that it is a pci-express x1 card, not just pci?</p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1345704">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1345715" class="blockpost roweven"> <h2><span><span class="conr">#685</span> <a href="viewtopic.php?pid=1345715#p1345715">2013-11-04 22:20:48</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=75590">aw</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2013-10-04</span></dd> <dd><span>Posts: 921</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=75590">Email</a></span> <span class="website"><a href="http://vfio.blogspot.com/" rel="nofollow">Website</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>myweb wrote:</cite><blockquote><div><div class="codebox"><pre><code>sudo modprobe nvidia NVreg_EnableMSI=1</code></pre></div><p>does not help</p><p>grep vfio /proc/interrupts</p><div class="codebox"><pre><code>16: 5513 3621 960 109 IR-IO-APIC-fasteoi vfio-intx(0000:00:1a.0), vfio-intx(0000:01:00.0) 17: 393 209 261 120 IR-IO-APIC-fasteoi saa7146 (0), vfio-intx(0000:01:00.1)</code></pre></div></div></blockquote></div><p>You&#039;re still using INTx here.&#160; Is that modprobe run from a clean guest boot without the nvidia module previously loaded?&#160; Running modprobe against an already loaded module of course does nothing.&#160; Does a Windows guest with Nvidia drivers work?</p> </div> <div class="postsignature postmsg"><hr /><p><a href="http://vfio.blogspot.com" rel="nofollow">http://vfio.blogspot.com</a><br />Looking for a more open forum to discuss vfio related uses?&#160; Try <a href="https://www.redhat.com/mailman/listinfo/vfio-users" rel="nofollow">https://www.redhat.com/mailman/listinfo/vfio-users</a></p></div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1345715">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1345716" class="blockpost rowodd"> <h2><span><span class="conr">#686</span> <a href="viewtopic.php?pid=1345716#p1345716">2013-11-04 22:23:17</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=75590">aw</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2013-10-04</span></dd> <dd><span>Posts: 921</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=75590">Email</a></span> <span class="website"><a href="http://vfio.blogspot.com/" rel="nofollow">Website</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>Norcoen wrote:</cite><blockquote><div><div class="quotebox"><cite>kaeptnb wrote:</cite><blockquote><div><p>like this:</p><p>kernel commandline parameter: pci-stub.ids=1002:6819,1002:aab0</p><p>the id&#039;s are not the PCI Bus IDs, but the Device Class/Subclass - you get them with &quot;lspci -vn&quot;</p></div></blockquote></div><p>So you mean I should not use vendor:device [1b21:0612] but from the ?Subsystem? ID: [1b21:1060] as pci-stub kernelparameter?<br />Does it matter at this point, that it is a pci-express x1 card, not just pci?</p></div></blockquote></div><p>You should use vendor:device, that&#039;s what the -n option provides.&#160; The first post is mistaken on what those IDs actually are.&#160; PCIe vs conventional PCI doesn&#039;t matter</p> </div> <div class="postsignature postmsg"><hr /><p><a href="http://vfio.blogspot.com" rel="nofollow">http://vfio.blogspot.com</a><br />Looking for a more open forum to discuss vfio related uses?&#160; Try <a href="https://www.redhat.com/mailman/listinfo/vfio-users" rel="nofollow">https://www.redhat.com/mailman/listinfo/vfio-users</a></p></div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1345716">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1345722" class="blockpost roweven"> <h2><span><span class="conr">#687</span> <a href="viewtopic.php?pid=1345722#p1345722">2013-11-04 22:34:47</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=73162">myweb</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2013-07-13</span></dd> <dd><span>Posts: 68</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=73162">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <p>Nvidia under Windows works fine. Modprobe run from a clean guest boot without the nvidia module previously loaded.</p><div class="codebox"><pre><code>grep vfio /proc/interrupts 17: 572 239 284 142 IR-IO-APIC-fasteoi saa7146 (0), vfio-intx(0000:01:00.1) 49: 1 0 0 0 IR-PCI-MSI-edge vfio-msi[0](0000:01:00.0)</code></pre></div> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1345722">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1345785" class="blockpost rowodd"> <h2><span><span class="conr">#688</span> <a href="viewtopic.php?pid=1345785#p1345785">2013-11-05 02:07:52</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=76566">cryptonymous</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2013-11-05</span></dd> <dd><span>Posts: 6</span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <p>Hello. I think I&#039;m running into a problem regarding interrupt handling when trying to pass through my NVIDIA GTX 650 card into OS X Mavericks.</p><div class="codebox"><pre><code>01:00.0 VGA compatible controller [0300]: NVIDIA Corporation GK107 [GeForce GTX 650] [10de:0fc6] (rev a1)</code></pre></div><p>Booting OS X with stock QEMU and GTX 650 passed though results in extremly sluggish graphics. Every now and then Finder process gets killed with the following logged into dmesg:</p><div class="codebox"><pre><code>NVDA(OpenGL): Channel exception! Exception type = 0x8 DMA Engine Error (FIFO Error 8)</code></pre></div><p>However, passing through the same GTX 650 into Windows 7 install works fine. I&#039;ve compared &quot;cat /proc/interrupts | grep vfio&quot; output after booting Windows 7 and OS X:</p><p>Windows 7:</p><div class="codebox"><pre><code> 16: 405613 0 0 0 1 0 0 0 IR-IO-APIC-fasteoi vfio-intx(0000:01:00.0), firewire_ohci</code></pre></div><p>OS X:</p><div class="codebox"><pre><code> 67: 1 0 0 0 0 0 0 0 IR-PCI-MSI-edge vfio-msi[0](0000:01:00.0)</code></pre></div><p>Also, when running OS X the following backtrace is occasionally seen on the host:</p><div class="codebox"><pre class="vscroll"><code>[35849.691253] vfio_ecap_init: 0000:01:00.0 hiding ecap 0x19@0x900 [35910.481384] vfio-pci 0000:01:00.0: irq 67 for MSI/MSI-X [36467.745050] irq 16: nobody cared (try booting with the &quot;irqpoll&quot; option) [36467.745054] CPU: 0 PID: 0 Comm: swapper/0 Tainted: G W 3.12.0+ #8 [36467.745055] Hardware name: [36467.745056] 0000000000000000 ffffffff81390dff ffff880806f71a00 ffffffff8107d0bb [36467.745059] ffff880806f71a00 0000000000000000 ffff880806f71a00 ffffffff8107d463 [36467.745060] 0000000000000000 0000000000000010 ffff880806f71a00 0000000000000000 [36467.745062] Call Trace: [36467.745063] &lt;IRQ&gt; [&lt;ffffffff81390dff&gt;] ? dump_stack+0x41/0x51 [36467.745071] [&lt;ffffffff8107d0bb&gt;] ? __report_bad_irq+0x2c/0xb7 [36467.745072] [&lt;ffffffff8107d463&gt;] ? note_interrupt+0x14b/0x1ce [36467.745074] [&lt;ffffffff8107b7a1&gt;] ? handle_irq_event_percpu+0x120/0x187 [36467.745076] [&lt;ffffffff8107b83a&gt;] ? handle_irq_event+0x32/0x4d [36467.745078] [&lt;ffffffff8107dce6&gt;] ? handle_fasteoi_irq+0x80/0xb4 [36467.745080] [&lt;ffffffff8100ebb2&gt;] ? handle_irq+0x18/0x20 [36467.745081] [&lt;ffffffff8100e82b&gt;] ? do_IRQ+0x40/0x95 [36467.745083] [&lt;ffffffff8139522d&gt;] ? common_interrupt+0x6d/0x6d [36467.745084] &lt;EOI&gt; [&lt;ffffffff812b5b3e&gt;] ? arch_local_irq_enable+0x7/0x8 [36467.745087] [&lt;ffffffff812b5e4e&gt;] ? cpuidle_enter_state+0x50/0xa9 [36467.745089] [&lt;ffffffff812b5f84&gt;] ? cpuidle_idle_call+0xdd/0x132 [36467.745091] [&lt;ffffffff810140ab&gt;] ? arch_cpu_idle+0x5/0x17 [36467.745093] [&lt;ffffffff8107af6b&gt;] ? cpu_startup_entry+0x10c/0x165 [36467.745095] [&lt;ffffffff816b8d33&gt;] ? start_kernel+0x3e8/0x3f3 [36467.745097] [&lt;ffffffff816b876e&gt;] ? repair_env_string+0x54/0x54 [36467.745099] [&lt;ffffffff816b8120&gt;] ? early_idt_handlers+0x120/0x120 [36467.745100] [&lt;ffffffff816b8593&gt;] ? x86_64_start_kernel+0xef/0xf8 [36467.745101] handlers: [36467.745114] [&lt;ffffffffa0144bdb&gt;] irq_handler [firewire_ohci] [36467.745115] Disabling IRQ #16</code></pre></div><p>My theory is that although QEMU/VFIO configures the card to use MSI, it continues to use conventional IRQ and OS X drivers never receive any interrupts. I couldn&#039;t find any option to disable MSI emulation when using VFIO, so I&#039;ve tried the most obvious way of commenting out the following lines in hw/misc/vfio.c:</p><div class="codebox"><pre><code>diff --git a/hw/misc/vfio.c b/hw/misc/vfio.c index fdbb492..459c4ee 100644 --- a/hw/misc/vfio.c +++ b/hw/misc/vfio.c @@ -2800,14 +2804,14 @@ static int vfio_add_std_cap(VFIODevice *vdev, uint8_t pos) switch (cap_id) { case PCI_CAP_ID_MSI: - ret = vfio_setup_msi(vdev, pos); + ret = 0; /1 /bin /boot /cdrom /dev /etc /home /initrd.img /initrd.img.old /lib /lib32 /lib64 /libx32 /lost+found /media /mnt /opt /proc /root /run /sbin /srv /sys /tmp /ubiquity-apt-clone /usr /var /vmlinuz /vmlinuz.old /win81-base.qcow2 /win81-base.qcow2.md5 /win81-writable-amd.qcow2 /win81-writable-nvidia.qcow2 /win81-writable-nvidia.qcow2.backup vfio_setup_msi(vdev, pos); */ break; case PCI_CAP_ID_EXP: vfio_check_pcie_flr(vdev, pos); ret = vfio_setup_pcie_cap(vdev, pos, size); break; case PCI_CAP_ID_MSIX: - ret = vfio_setup_msix(vdev, pos); + ret = 0; /1 /bin /boot /cdrom /dev /etc /home /initrd.img /initrd.img.old /lib /lib32 /lib64 /libx32 /lost+found /media /mnt /opt /proc /root /run /sbin /srv /sys /tmp /ubiquity-apt-clone /usr /var /vmlinuz /vmlinuz.old /win81-base.qcow2 /win81-base.qcow2.md5 /win81-writable-amd.qcow2 /win81-writable-nvidia.qcow2 /win81-writable-nvidia.qcow2.backup vfio_setup_msix(vdev, pos); */ break; case PCI_CAP_ID_PM: vfio_check_pm_reset(vdev, pos);</code></pre></div><p>After rebuilding QEMU with this patch applied interrupt handler switches to vfio-intx instead of vfio-msi and OS X graphics become smooth. Thus, in my case there is something wrong going on when MSI is being utilized.</p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1345785">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1345806" class="blockpost roweven"> <h2><span><span class="conr">#689</span> <a href="viewtopic.php?pid=1345806#p1345806">2013-11-05 03:14:45</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=75590">aw</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2013-10-04</span></dd> <dd><span>Posts: 921</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=75590">Email</a></span> <span class="website"><a href="http://vfio.blogspot.com/" rel="nofollow">Website</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>cryptonymous wrote:</cite><blockquote><div><p>My theory is that although QEMU/VFIO configures the card to use MSI, it continues to use conventional IRQ and OS X drivers never receive any interrupts. I couldn&#039;t find any option to disable MSI emulation when using VFIO, so I&#039;ve tried the most obvious way of commenting out the following lines in hw/misc/vfio.c:</p><p>After rebuilding QEMU with this patch applied interrupt handler switches to vfio-intx instead of vfio-msi and OS X graphics become smooth. Thus, in my case there is something wrong going on when MSI is being utilized.</p></div></blockquote></div><p>Interesting observation.&#160; By removing those lines you&#039;re indeed not exposing MSI or MSI-X capabilities to the guest.&#160; The guest has no choice but to use INTx.&#160; I know I&#039;ve used MSI successfully with a Quadro card and Linux guest, but I don&#039;t think I&#039;ve tried a Linux guest with MSI on a GeForce (I had a Radeon running with MSI just the other day).&#160; What does &#039;sudo lspci -vvv&#039; from the host show for the GTX650 with OSX running without your qemu patch?&#160; Random guess; if lspci shows DisINTx- try using setpci to enable it (ex. dev=01:00.0; val=$(setpci -s $dev COMMAND); newval=$(printf %04x $(( 0x$val | 0x400 ))); setpci -s $dev COMMAND=$newval; echo &quot;restore with: setpci -s $dev COMMAND=$val&quot;).&#160; If it&#039;s DisINTx- and making it DisINT+ makes any difference, perhaps there&#039;s a bug in the emulation of that bit.</p> </div> <div class="postsignature postmsg"><hr /><p><a href="http://vfio.blogspot.com" rel="nofollow">http://vfio.blogspot.com</a><br />Looking for a more open forum to discuss vfio related uses?&#160; Try <a href="https://www.redhat.com/mailman/listinfo/vfio-users" rel="nofollow">https://www.redhat.com/mailman/listinfo/vfio-users</a></p></div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1345806">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1345862" class="blockpost rowodd"> <h2><span><span class="conr">#690</span> <a href="viewtopic.php?pid=1345862#p1345862">2013-11-05 04:48:32</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=75590">aw</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2013-10-04</span></dd> <dd><span>Posts: 921</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=75590">Email</a></span> <span class="website"><a href="http://vfio.blogspot.com/" rel="nofollow">Website</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>aw wrote:</cite><blockquote><div><div class="quotebox"><cite>cryptonymous wrote:</cite><blockquote><div><p>My theory is that although QEMU/VFIO configures the card to use MSI, it continues to use conventional IRQ and OS X drivers never receive any interrupts. I couldn&#039;t find any option to disable MSI emulation when using VFIO, so I&#039;ve tried the most obvious way of commenting out the following lines in hw/misc/vfio.c:</p><p>After rebuilding QEMU with this patch applied interrupt handler switches to vfio-intx instead of vfio-msi and OS X graphics become smooth. Thus, in my case there is something wrong going on when MSI is being utilized.</p></div></blockquote></div><p>Interesting observation.&#160; By removing those lines you&#039;re indeed not exposing MSI or MSI-X capabilities to the guest.&#160; The guest has no choice but to use INTx.&#160; I know I&#039;ve used MSI successfully with a Quadro card and Linux guest, but I don&#039;t think I&#039;ve tried a Linux guest with MSI on a GeForce (I had a Radeon running with MSI just the other day).&#160; What does &#039;sudo lspci -vvv&#039; from the host show for the GTX650 with OSX running without your qemu patch?&#160; Random guess; if lspci shows DisINTx- try using setpci to enable it (ex. dev=01:00.0; val=$(setpci -s $dev COMMAND); newval=$(printf %04x $(( 0x$val | 0x400 ))); setpci -s $dev COMMAND=$newval; echo &quot;restore with: setpci -s $dev COMMAND=$val&quot;).&#160; If it&#039;s DisINTx- and making it DisINT+ makes any difference, perhaps there&#039;s a bug in the emulation of that bit.</p></div></blockquote></div><p>Testing a Linux guest w/ a GTX660, I can confirm that things go bad when using the NV_RegEnableMSI=1 option.&#160; This worked fine for me with a Quadro card.&#160; I see a single interrupt and the monitor goes out of sync and never comes back after OS bootup.&#160; I&#039;ll try to find some time to dig into it.&#160; I also note that the audio driver specifically checks for nvidia devices and blacklists MSI on snd-hda-intel, so at some point nvidia hasn&#039;t played nicely with Linux MSI support.&#160; Perhaps there&#039;s a reason why the Linux nvidia driver defaults to INTx as well.</p> </div> <div class="postsignature postmsg"><hr /><p><a href="http://vfio.blogspot.com" rel="nofollow">http://vfio.blogspot.com</a><br />Looking for a more open forum to discuss vfio related uses?&#160; Try <a href="https://www.redhat.com/mailman/listinfo/vfio-users" rel="nofollow">https://www.redhat.com/mailman/listinfo/vfio-users</a></p></div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1345862">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1345887" class="blockpost roweven"> <h2><span><span class="conr">#691</span> <a href="viewtopic.php?pid=1345887#p1345887">2013-11-05 07:37:04</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=73162">myweb</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2013-07-13</span></dd> <dd><span>Posts: 68</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=73162">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <p>with the following options I get working Nvidia drivers in the guest:</p><div class="codebox"><pre><code>options snd-hda-intel enable_msi=0 options nvidia NVreg_EnableMSI=0</code></pre></div><p>Btw, I found interesting release notice from Nvidia for 325.08 BETA (<a href="http://www.nvidia.com/object/linux-display-ia32-325.08-driver.html" rel="nofollow">http://www.nvidia.com/object/linux-disp … river.html</a>)</p><p>&quot;Changed the default PCIe interrupt delivery method from virtual-wire to MSI. Note that if the NVIDIA Linux driver fails to initialize with an error indicating that it is not receiving interrupts, MSI can be disabled by setting the module parameter &quot;NVreg_EnableMSI=0&quot; when loading the NVIDIA kernel module. - See more at: <a href="http://www.nvidia.com/object/linux-display-ia32-325.08-driver.html#sthash.bXXFjZEK.dpuf" rel="nofollow">http://www.nvidia.com/object/linux-display-ia32-325.08-driver.html#sthash.bXXFjZEK.dpuf&quot;</a></p> <p class="postedit"><em>Last edited by myweb (2013-11-05 09:34:40)</em></p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1345887">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1345926" class="blockpost rowodd"> <h2><span><span class="conr">#692</span> <a href="viewtopic.php?pid=1345926#p1345926">2013-11-05 11:12:35</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=76566">cryptonymous</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2013-11-05</span></dd> <dd><span>Posts: 6</span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>aw wrote:</cite><blockquote><div><p>What does &#039;sudo lspci -vvv&#039; from the host show for the GTX650 with OSX running without your qemu patch?&#160; Random guess; if lspci shows DisINTx- try using setpci to enable it (ex. dev=01:00.0; val=$(setpci -s $dev COMMAND); newval=$(printf %04x $(( 0x$val | 0x400 ))); setpci -s $dev COMMAND=$newval; echo &quot;restore with: setpci -s $dev COMMAND=$val&quot;).&#160; If it&#039;s DisINTx- and making it DisINT+ makes any difference, perhaps there&#039;s a bug in the emulation of that bit.</p></div></blockquote></div><p>When idling at OS X login screen with unpatched QEMU, &#039;sudo lspci -vvv -s 01:00.0&#039; shows the following:</p><div class="codebox"><pre class="vscroll"><code>01:00.0 VGA compatible controller: NVIDIA Corporation GK107 [GeForce GTX 650] (rev a1) (prog-if 00 [VGA controller]) Subsystem: Micro-Star International Co., Ltd. Device 2804 Control: I/O+ Mem+ BusMaster+ SpecCycle- MemWINV- VGASnoop- ParErr- Stepping- SERR+ FastB2B- DisINTx+ Status: Cap+ 66MHz- UDF- FastB2B- ParErr- DEVSEL=fast &gt;TAbort- &lt;TAbort- &lt;MAbort- &gt;SERR- &lt;PERR- INTx- Latency: 0 Interrupt: pin A routed to IRQ 67 Region 0: Memory at f6000000 (32-bit, non-prefetchable) [size=16M] Region 1: Memory at e0000000 (64-bit, prefetchable) [size=256M] Region 3: Memory at f0000000 (64-bit, prefetchable) [size=32M] Region 5: I/O ports at e000 [size=128] Expansion ROM at f7000000 [disabled] [size=512K] Capabilities: [60] Power Management version 3 Flags: PMEClk- DSI- D1- D2- AuxCurrent=0mA PME(D0-,D1-,D2-,D3hot-,D3cold-) Status: D0 NoSoftRst+ PME-Enable- DSel=0 DScale=0 PME- Capabilities: [68] MSI: Enable+ Count=1/1 Maskable- 64bit+ Address: 00000000fee00478 Data: 0000 Capabilities: [78] Express (v2) Endpoint, MSI 00 DevCap: MaxPayload 256 bytes, PhantFunc 0, Latency L0s unlimited, L1 &lt;64us ExtTag+ AttnBtn- AttnInd- PwrInd- RBE+ FLReset- DevCtl: Report errors: Correctable- Non-Fatal- Fatal- Unsupported- RlxdOrd+ ExtTag+ PhantFunc- AuxPwr- NoSnoop- MaxPayload 256 bytes, MaxReadReq 512 bytes DevSta: CorrErr- UncorrErr- FatalErr- UnsuppReq- AuxPwr- TransPend- LnkCap: Port #0, Speed 8GT/s, Width x16, ASPM L0s L1, Latency L0 &lt;1us, L1 &lt;4us ClockPM+ Surprise- LLActRep- BwNot- LnkCtl: ASPM L0s L1 Enabled; RCB 64 bytes Disabled- Retrain- CommClk+ ExtSynch- ClockPM- AutWidDis- BWInt- AutBWInt- LnkSta: Speed 8GT/s, Width x16, TrErr- Train- SlotClk+ DLActive- BWMgmt- ABWMgmt- DevCap2: Completion Timeout: Range AB, TimeoutDis+, LTR-, OBFF Not Supported DevCtl2: Completion Timeout: 50us to 50ms, TimeoutDis-, LTR-, OBFF Disabled LnkCtl2: Target Link Speed: 8GT/s, EnterCompliance- SpeedDis- Transmit Margin: Normal Operating Range, EnterModifiedCompliance- ComplianceSOS- Compliance De-emphasis: -6dB LnkSta2: Current De-emphasis Level: -3.5dB, EqualizationComplete+, EqualizationPhase1+ EqualizationPhase2+, EqualizationPhase3+, LinkEqualizationRequest+ Capabilities: [b4] Vendor Specific Information: Len=14 &lt;?&gt; Capabilities: [100 v1] Virtual Channel Caps: LPEVC=0 RefClk=100ns PATEntryBits=1 Arb: Fixed- WRR32- WRR64- WRR128- Ctrl: ArbSelect=Fixed Status: InProgress- VC0: Caps: PATOffset=00 MaxTimeSlots=1 RejSnoopTrans- Arb: Fixed- WRR32- WRR64- WRR128- TWRR128- WRR256- Ctrl: Enable+ ID=0 ArbSelect=Fixed TC/VC=ff Status: NegoPending- InProgress- Capabilities: [128 v1] Power Budgeting &lt;?&gt; Capabilities: [600 v1] Vendor Specific Information: ID=0001 Rev=1 Len=024 &lt;?&gt; Capabilities: [900 v1] #19 Kernel driver in use: vfio-pci</code></pre></div><p>So it has DisINTx+ flag. Changing it to DisINTx- via setpci does not make any visible difference. After rebooting the guest without exiting QEMU the flag is back to DisINTx+.</p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1345926">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1346148" class="blockpost roweven"> <h2><span><span class="conr">#693</span> <a href="viewtopic.php?pid=1346148#p1346148">2013-11-05 20:50:29</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=75076">SpacePirate</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2013-09-16</span></dd> <dd><span>Posts: 55</span></dd> <dd class="usercontacts"><span class="email"><a href="mailto:hiduei@gmx.de">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <p>After my system ran fine for a week or so now I dont get any sound from the vm at all again.<br />It starts up with this messages:</p><div class="codebox"><pre><code>Nov 05 21:41:07 host windows-vm[1825]: ALSA lib pcm_dmix.c:1022:(snd_pcm_dmix_open) unable to open slave Nov 05 21:41:07 host windows-vm[1825]: alsa: Could not initialize DAC Nov 05 21:41:07 host windows-vm[1825]: alsa: Failed to open `default&#039;: Nov 05 21:41:07 host windows-vm[1825]: alsa: Reason: Device or resource busy Nov 05 21:41:07 host windows-vm[1825]: ALSA lib pcm_dmix.c:1022:(snd_pcm_dmix_open) unable to open slave Nov 05 21:41:07 host windows-vm[1825]: alsa: Could not initialize DAC Nov 05 21:41:07 host windows-vm[1825]: alsa: Failed to open `default&#039;: Nov 05 21:41:07 host windows-vm[1825]: alsa: Reason: Device or resource busy Nov 05 21:41:07 host windows-vm[1825]: audio: Failed to create voice `dac&#039;</code></pre></div><p>I tried googling the issue but I didnt find anything... Have any of you encountered that problem before?</p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1346148">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1347051" class="blockpost rowodd"> <h2><span><span class="conr">#694</span> <a href="viewtopic.php?pid=1347051#p1347051">2013-11-08 00:30:35</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=68201">rabcor</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2013-02-09</span></dd> <dd><span>Posts: 457</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=68201">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <p>You may remember me from earlier in the thread, i tried this but gave up when i couldn&#039;t get Qemu to run. I&#039;m back now with the AUR version of qemu-git and linux-mainline as well as the seabios provided here.</p><p>I have an Nvidia GTX 670 (01:00.0) and Nvidia GTX 550-Ti (02:00.0)</p><p>I have applied this to my cmdline: (The GTX 670 and its Audio)</p><div class="codebox"><pre><code>pci-stub.ids=10de:1189,10de:0e0a</code></pre></div><p>However i&#039;m not actually sure if this is working or not, seeing as the computer is using this GPU when in terminal. When i try to start X if this option is on, i get an error that says the Nvidia Drivers are failing to load the GTX card (PCI 01:00.0), i even set the xorg configuration file to use &quot;PCI:02:00:0&quot; as BusID but that wont work either, and if i try to run the vfio-bind script for the GTX, i get an error just like the one i got the last time i tried to do this.</p><div class="codebox"><pre><code>ls: cannot access /sys/bus/pci/devices/0000:01:00.0/iommu_group/devices: No such file or directory</code></pre></div><p>I think last time setting</p><div class="codebox"><pre><code>CONFIG_INTEL_IOMMU_DEFAULT_ON=y</code></pre></div><p>fixed that specific error(i&#039;m gonna try that again). But how am i to tell the Nvidia drivers to ignore the GTX 670?</p> <p class="postedit"><em>Last edited by rabcor (2013-11-08 00:33:38)</em></p> </div> <div class="postsignature postmsg"><hr /><p><a href="https://bbs.archlinux.org/viewtopic.php?pid=1421825" rel="nofollow">Making Logitech G510 Work on Linux!</a></p></div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1347051">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1347061" class="blockpost roweven"> <h2><span><span class="conr">#695</span> <a href="viewtopic.php?pid=1347061#p1347061">2013-11-08 00:47:48</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=70922">nbhs</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd class="postavatar"><img src="https://bbs.archlinux.org/img/avatars/70922.jpg?m=1367773811" width="80" height="80" alt="" /></dd> <dd><span>From: Montevideo, Uruguay</span></dd> <dd><span>Registered: 2013-05-02</span></dd> <dd><span>Posts: 402</span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>rabcor wrote:</cite><blockquote><div><p>You may remember me from earlier in the thread, i tried this but gave up when i couldn&#039;t get Qemu to run. I&#039;m back now with the AUR version of qemu-git and linux-mainline as well as the seabios provided here.</p><p>I have an Nvidia GTX 670 (01:00.0) and Nvidia GTX 550-Ti (02:00.0)</p><p>I have applied this to my cmdline: (The GTX 670 and its Audio)</p><div class="codebox"><pre><code>pci-stub.ids=10de:1189,10de:0e0a</code></pre></div><p>However i&#039;m not actually sure if this is working or not, seeing as the computer is using this GPU when in terminal. When i try to start X if this option is on, i get an error that says the Nvidia Drivers are failing to load the GTX card (PCI 01:00.0), i even set the xorg configuration file to use &quot;PCI:02:00:0&quot; as BusID but that wont work either, and if i try to run the vfio-bind script for the GTX, i get an error just like the one i got the last time i tried to do this.</p><div class="codebox"><pre><code>ls: cannot access /sys/bus/pci/devices/0000:01:00.0/iommu_group/devices: No such file or directory</code></pre></div><p>I think last time setting</p><div class="codebox"><pre><code>CONFIG_INTEL_IOMMU_DEFAULT_ON=y</code></pre></div><p>fixed that specific error(i&#039;m gonna try that again). But how am i to tell the Nvidia drivers to ignore the GTX 670?</p></div></blockquote></div><p>Since you&#039;re using intel make sure to use the packages i provided instead of the AUR ones, on intel systems you need to boot with intel_iommu=on, add pci-stub to /etc/mkinitcpio.conf in the MODULES section, and rebuild it</p><div class="codebox"><pre><code>mkinitcpio -p linux-mainline</code></pre></div><p>Make sure the Geforce 670 isnt your primary card, and if you&#039;re gonna use the nvidia drivers on the host you&#039;ll need to patch them (patch on the &quot;issues&quot; section)</p> <p class="postedit"><em>Last edited by nbhs (2013-11-08 00:48:25)</em></p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1347061">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1347063" class="blockpost rowodd"> <h2><span><span class="conr">#696</span> <a href="viewtopic.php?pid=1347063#p1347063">2013-11-08 00:58:33</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=68201">rabcor</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2013-02-09</span></dd> <dd><span>Posts: 457</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=68201">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>nbhs wrote:</cite><blockquote><div><p>Since you&#039;re using intel make sure to use the packages i provided instead of the AUR ones, on intel systems you need to boot with intel_iommu=on, add pci-stub to /etc/mkinitcpio.conf in the MODULES section, and rebuild it</p><div class="codebox"><pre><code>mkinitcpio -p linux-mainline</code></pre></div><p>Make sure the Geforce 670 isnt your primary card, and if you&#039;re gonna use the nvidia drivers on the host you&#039;ll need to patch them (patch on the &quot;issues&quot; section)</p></div></blockquote></div><p>by intel_iommu=on do you mean in the cmdline? something like this?</p><div class="codebox"><pre><code>GRUB_CMDLINE_LINUX_DEFAULT=&quot;intel_iommu=on pci-stub.ids=10de:1189,10de:0e0a quiet&quot;</code></pre></div><br /><p> as for mkinitcpio.conf and the command, i already did that. I&#039;ll switch to your linux-mainline and qemu packages then.</p><p>Also, how do i make sure GeForce 670 isn&#039;t my primary card? does it have to do with which PCI port on the motherboard it is placed? or is it something i can configure somewhere? (bios only lets me select between iGPU/PCIe, it doesn&#039;t let me specify which PCIe slot is primary i think)</p> <p class="postedit"><em>Last edited by rabcor (2013-11-08 01:01:43)</em></p> </div> <div class="postsignature postmsg"><hr /><p><a href="https://bbs.archlinux.org/viewtopic.php?pid=1421825" rel="nofollow">Making Logitech G510 Work on Linux!</a></p></div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1347063">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1347069" class="blockpost roweven"> <h2><span><span class="conr">#697</span> <a href="viewtopic.php?pid=1347069#p1347069">2013-11-08 01:22:48</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=70922">nbhs</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd class="postavatar"><img src="https://bbs.archlinux.org/img/avatars/70922.jpg?m=1367773811" width="80" height="80" alt="" /></dd> <dd><span>From: Montevideo, Uruguay</span></dd> <dd><span>Registered: 2013-05-02</span></dd> <dd><span>Posts: 402</span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>rabcor wrote:</cite><blockquote><div><div class="quotebox"><cite>nbhs wrote:</cite><blockquote><div><p>Since you&#039;re using intel make sure to use the packages i provided instead of the AUR ones, on intel systems you need to boot with intel_iommu=on, add pci-stub to /etc/mkinitcpio.conf in the MODULES section, and rebuild it</p><div class="codebox"><pre><code>mkinitcpio -p linux-mainline</code></pre></div><p>Make sure the Geforce 670 isnt your primary card, and if you&#039;re gonna use the nvidia drivers on the host you&#039;ll need to patch them (patch on the &quot;issues&quot; section)</p></div></blockquote></div><p>by intel_iommu=on do you mean in the cmdline? something like this?</p><div class="codebox"><pre><code>GRUB_CMDLINE_LINUX_DEFAULT=&quot;intel_iommu=on pci-stub.ids=10de:1189,10de:0e0a quiet&quot;</code></pre></div><br /><p> as for mkinitcpio.conf and the command, i already did that. I&#039;ll switch to your linux-mainline and qemu packages then.</p><p>Also, how do i make sure GeForce 670 isn&#039;t my primary card? does it have to do with which PCI port on the motherboard it is placed? or is it something i can configure somewhere? (bios only lets me select between iGPU/PCIe, it doesn&#039;t let me specify which PCIe slot is primary i think)</p></div></blockquote></div><p>Yes you have to add intel_iommu=on to your grub config file or whatever bootloader you use, your primary card is the one you see boot messages on</p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1347069">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1347075" class="blockpost rowodd"> <h2><span><span class="conr">#698</span> <a href="viewtopic.php?pid=1347075#p1347075">2013-11-08 01:31:45</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=68201">rabcor</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2013-02-09</span></dd> <dd><span>Posts: 457</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=68201">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <p>I&#039;ve switched the slots of the GPUs, 550-Ti is now in the primary slot and 670 in the secondary slot (i see boot messages and stuff on the 550 now, it also seems to play better with my BIOS too, 670 had a resolution problem until official drivers were loaded) if i boot into windows(dualboot) like this strangely enough the drivers get confused (probably because the older/weaker card is in the primary slot)</p><p>I still get the same error in X11 though</p><p>(PCI 1:0:0 is now the 550-Ti which i want to be using in linux, and 670 is at 2:0:0 which i would like to use in the VM, i didn&#039;t tell my system to do anything with the 550)</p><div class="codebox"><pre><code>Failed to initialize the NVIDIA GPU at PCI:1:0:0. Please check yuor system&#039;s kernel log for additional error messages... Screen(s) found, but none have a usable configuration.</code></pre></div><p>it is quite the pain. i tried to install the linux-mainline you uploaded, it compiled but it didn&#039;t install for some reason, i&#039;ll have to try again <img src="https://bbs.archlinux.org/img/smilies/hmm.png" width="15" height="15" alt="hmm" /></p> <p class="postedit"><em>Last edited by rabcor (2013-11-08 01:53:30)</em></p> </div> <div class="postsignature postmsg"><hr /><p><a href="https://bbs.archlinux.org/viewtopic.php?pid=1421825" rel="nofollow">Making Logitech G510 Work on Linux!</a></p></div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1347075">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1347187" class="blockpost roweven"> <h2><span><span class="conr">#699</span> <a href="viewtopic.php?pid=1347187#p1347187">2013-11-08 11:04:14</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=70922">nbhs</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd class="postavatar"><img src="https://bbs.archlinux.org/img/avatars/70922.jpg?m=1367773811" width="80" height="80" alt="" /></dd> <dd><span>From: Montevideo, Uruguay</span></dd> <dd><span>Registered: 2013-05-02</span></dd> <dd><span>Posts: 402</span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>rabcor wrote:</cite><blockquote><div><p>I&#039;ve switched the slots of the GPUs, 550-Ti is now in the primary slot and 670 in the secondary slot (i see boot messages and stuff on the 550 now, it also seems to play better with my BIOS too, 670 had a resolution problem until official drivers were loaded) if i boot into windows(dualboot) like this strangely enough the drivers get confused (probably because the older/weaker card is in the primary slot)</p><p>I still get the same error in X11 though</p><p>(PCI 1:0:0 is now the 550-Ti which i want to be using in linux, and 670 is at 2:0:0 which i would like to use in the VM, i didn&#039;t tell my system to do anything with the 550)</p><div class="codebox"><pre><code>Failed to initialize the NVIDIA GPU at PCI:1:0:0. Please check yuor system&#039;s kernel log for additional error messages... Screen(s) found, but none have a usable configuration.</code></pre></div><p>it is quite the pain. i tried to install the linux-mainline you uploaded, it compiled but it didn&#039;t install for some reason, i&#039;ll have to try again <img src="https://bbs.archlinux.org/img/smilies/hmm.png" width="15" height="15" alt="hmm" /></p></div></blockquote></div><p>First you have to build it:</p><div class="codebox"><pre><code>makepkg -sf</code></pre></div><p>Then install it:</p><div class="codebox"><pre><code>sudo pacman -U linux-mainline-*</code></pre></div> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1347187">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1347676" class="blockpost rowodd"> <h2><span><span class="conr">#700</span> <a href="viewtopic.php?pid=1347676#p1347676">2013-11-09 16:55:14</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=76719">cmorrow</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2013-11-09</span></dd> <dd><span>Posts: 2</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=76719">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <p>qemu-git (with and without dsnoop patches) is giving me a Windows Stop Error (0x0000007E) when I boot the DVD (immediately after &quot;Starting Windows&quot; with no O/S installed yet) whenever I use q35 as the machine type.&#160; </p><p>Anyone else seeing this?&#160; I downgraded to qemu 1.6.1 and the issue went away.</p><p>(This is prior to any vfio passthrough, I just kept running into bluescreens and was trying to whittle down the configuration to barebones)<br />qemu-system-x86_64 -enable-kvm -M q35 -m 4096 -cpu host \<br />-smp 4,sockets=1,cores=4,threads=1 \<br />-bios /usr/share/qemu/bios.bin -vga std \<br />-boot menu=on \<br />-device ioh3420,bus=pcie.0,addr=1c.0,multifunction=on,port=1,chassis=1,id=root \<br />-device piix4-ide,bus=pcie.0 \<br />-drive file=/home/windows.img,id=disk,format=raw -device ide-hd,drive=disk \<br />-drive file=/rpool/Public/ISO/Windows7HomePremium64bit.iso,id=isocd -device ide-cd,bus=ide.1,drive=isocd</p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1347676">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div class="postlinksb"> <div class="inbox crumbsplus"> <div class="pagepost"> <p class="pagelink conl"><span class="pages-label">Pages: </span><a rel="prev" class="item1" href="viewtopic.php?id=162768&amp;p=27">Previous</a> <a href="viewtopic.php?id=162768">1</a> <span class="spacer">…</span> <a href="viewtopic.php?id=162768&amp;p=26">26</a> <a href="viewtopic.php?id=162768&amp;p=27">27</a> <strong>28</strong> <a href="viewtopic.php?id=162768&amp;p=29">29</a> <a href="viewtopic.php?id=162768&amp;p=30">30</a> <span class="spacer">…</span> <a href="viewtopic.php?id=162768&amp;p=234">234</a> <a rel="next" href="viewtopic.php?id=162768&amp;p=29">Next</a></p> <p class="postlink conr">Topic closed</p> </div> <ul class="crumbs"> <li><a href="index.php">Index</a></li> <li><span>»&#160;</span><a href="viewforum.php?id=48">Topics Going Nowhere</a></li> <li><span>»&#160;</span><strong><a href="viewtopic.php?id=162768">KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</a></strong></li> </ul> <p class="subscribelink clearb"><a href="misc.php?action=subscribe&amp;tid=162768">Subscribe to this topic</a></p> <div class="clearer"></div> </div> </div> </div> <div id="brdfooter" class="block"> <h2><span>Board footer</span></h2> <div class="box"> <div id="brdfooternav" class="inbox"> <div class="conl"> <form id="qjump" method="get" action="viewforum.php"> <div><label><span>Jump to<br /></span> <select name="id" onchange="window.location=('viewforum.php?id='+this.options[this.selectedIndex].value)"> <optgroup label="Technical Issues and Assistance"> <option value="23">Newbie Corner</option> <option value="17">Installation</option> <option value="22">Kernel &amp; Hardware</option> <option value="18">Applications &amp; Desktop Environments</option> <option value="31">Laptop Issues</option> <option value="8">Networking, Server, and Protection</option> <option value="32">Multimedia and Games</option> <option value="50">System Administration</option> <option value="35">Other Architectures</option> </optgroup> <optgroup label="Arch-centric"> <option value="24">Announcements, Package &amp; Security Advisories</option> <option value="1">Arch Discussion</option> <option value="13">Forum &amp; Wiki discussion</option> </optgroup> <optgroup label="Pacman Upgrades, Packaging &amp; AUR"> <option value="44">Pacman &amp; Package Upgrade Issues</option> <option value="49">[testing] Repo Forum</option> <option value="4">Creating &amp; Modifying Packages</option> <option value="38">AUR Issues, Discussion &amp; PKGBUILD Requests</option> </optgroup> <optgroup label="Contributions &amp; Discussion"> <option value="20">GNU/Linux Discussion</option> <option value="27">Community Contributions</option> <option value="33">Programming &amp; Scripting</option> <option value="30">Other Languages</option> <option value="47">Artwork and Screenshots</option> <option value="42">Try This</option> </optgroup> <optgroup label="/dev/null"> <option value="29">Off-Topic</option> <option value="48" selected="selected">Topics Going Nowhere</option> <option value="36">Dustbin</option> </optgroup> </select></label> <input type="submit" value=" Go " accesskey="g" /> </div> </form> </div> <div class="conr"> <p id="feedlinks"><span class="atom"><a href="extern.php?action=feed&amp;tid=162768&amp;type=atom">Atom topic feed</a></span></p> <p id="poweredby">Powered by <a href="http://fluxbb.org/">FluxBB</a></p> </div> <div class="clearer"></div> </div> </div> </div> </div> <div class="end-box"></div> </div> </body> </html>
