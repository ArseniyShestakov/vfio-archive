<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"> <html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en" dir="ltr"> <head> <meta http-equiv="Content-Type" content="text/html; charset=utf-8" /> <title>KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9 (Page 71) / Topics Going Nowhere / Arch Linux Forums</title> <link rel="stylesheet" type="text/css" href="style/ArchLinux.css" /> <link rel="canonical" href="viewtopic.php?id=162768&amp;p=71" title="Page 71" /> <link rel="prev" href="viewtopic.php?id=162768&amp;p=70" title="Page 70" /> <link rel="next" href="viewtopic.php?id=162768&amp;p=72" title="Page 72" /> <link rel="alternate" type="application/atom+xml" href="extern.php?action=feed&amp;tid=162768&amp;type=atom" title="Atom topic feed" /> <link rel="stylesheet" media="screen" href="style/ArchLinux/arch.css?v=3" /> <link rel="stylesheet" media="screen" href="style/ArchLinux/archnavbar.css?v=2" /> <link rel="shortcut icon" href="style/ArchLinux/favicon.ico" /> </head> <body> <div id="archnavbar" class="anb-forum"> <div id="archnavbarlogo"><h1><a href="http://www.archlinux.org/">Arch Linux</a></h1></div> <div id="archnavbarmenu"> <ul id="archnavbarlist"> <li id="anb-home"><a href="http://www.archlinux.org/">Home</a></li><li id="anb-packages"><a href="http://www.archlinux.org/packages/">Packages</a></li><li id="anb-forums" class="anb-selected"><a href="https://bbs.archlinux.org/">Forums</a></li><li id="anb-wiki"><a href="https://wiki.archlinux.org/">Wiki</a></li><li id="anb-bugs"><a href="https://bugs.archlinux.org/">Bugs</a></li><li id="anb-aur"><a href="https://aur.archlinux.org/">AUR</a></li><li id="anb-download"><a href="http://www.archlinux.org/download/">Download</a></li> </ul> </div> </div> <div id="punviewtopic" class="pun"> <div class="top-box"></div> <div class="punwrap"> <div id="brdheader" class="block"> <div class="box"> <div id="brdmenu" class="inbox"> <ul> <li id="navindex" class="isactive"><a href="index.php">Index</a></li> <li id="navuserlist"><a href="userlist.php">User list</a></li> <li id="navsearch"><a href="search.php">Search</a></li> <li id="navprofile"><a href="profile.php?id=80749">Profile</a></li> <li id="navlogout"><a href="login.php?action=out&amp;id=80749&amp;csrf_token=5c20501ec397bb45ef8ee8c84db232c8d8e421c6">Logout</a></li> </ul> </div> <div id="brdwelcome" class="inbox"> <ul class="conl"> <li><span>Logged in as <strong>SXX</strong></span></li> <li><span>Last visit: 2015-08-16 12:20:09</span></li> </ul> <ul class="conr"> <li><span>Topics: <a href="search.php?action=show_replies" title="Find topics you have posted to.">Posted</a> | <a href="search.php?action=show_new" title="Find topics with new posts since your last visit.">New</a> | <a href="search.php?action=show_recent" title="Find topics with recent posts.">Active</a> | <a href="search.php?action=show_unanswered" title="Find topics with no replies.">Unanswered</a></span></li> </ul> <div class="clearer"></div> </div> </div> </div> <div id="brdmain"> <div class="linkst"> <div class="inbox crumbsplus"> <ul class="crumbs"> <li><a href="index.php">Index</a></li> <li><span>»&#160;</span><a href="viewforum.php?id=48">Topics Going Nowhere</a></li> <li><span>»&#160;</span><strong><a href="viewtopic.php?id=162768">KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</a></strong></li> </ul> <div class="pagepost"> <p class="pagelink conl"><span class="pages-label">Pages: </span><a rel="prev" class="item1" href="viewtopic.php?id=162768&amp;p=70">Previous</a> <a href="viewtopic.php?id=162768">1</a> <span class="spacer">…</span> <a href="viewtopic.php?id=162768&amp;p=69">69</a> <a href="viewtopic.php?id=162768&amp;p=70">70</a> <strong>71</strong> <a href="viewtopic.php?id=162768&amp;p=72">72</a> <a href="viewtopic.php?id=162768&amp;p=73">73</a> <span class="spacer">…</span> <a href="viewtopic.php?id=162768&amp;p=234">234</a> <a rel="next" href="viewtopic.php?id=162768&amp;p=72">Next</a></p> <p class="postlink conr">Topic closed</p> </div> <div class="clearer"></div> </div> </div> <div id="p1418112" class="blockpost rowodd blockpost1"> <h2><span><span class="conr">#1751</span> <a href="viewtopic.php?pid=1418112#p1418112">2014-05-22 12:58:41</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=82181">esmth</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2014-05-22</span></dd> <dd><span>Posts: 4</span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>mbroemme wrote:</cite><blockquote><div><div class="quotebox"><cite>esmth wrote:</cite><blockquote><div><div class="codebox"><pre><code>sudo su bin/vfio-bind 0000:01:00:0 0000:01:00.1 ./qemu-system-x86_64 -enable-kvm -M q35 -m 1024 -cpu host -smp 6,sockets=1,cores=6,threads=1 -bios /home/esmth/src/seabios/out/bios.bin -vga std -device ioh3420,bus=pcie.0,addr=1c.0,multifunction=on,port=1,chassis=1,id=root.1 -device vfio-pci,host=01:00.0,bus=root.1,addr=00.0,multifunction=on,x-vga=on -device vfio-pci,host=01:00.1,bus=root.1,addr=00.1 -drive file=/home/esmth/image.img,id=disk,format=raw -device ide-hd,bus=ide.0,drive=disk -drive file=/home/esmth/tmp/windows.iso,id=isocd -device ide-cd,bus=ide.1,drive=isocd -usb -usbdevice host:046d:c52b</code></pre></div><p>if anyone can help, it&#039;d be appreciated, thanks</p></div></blockquote></div><p>Could you try to use it with</p><div class="codebox"><pre><code>-vga none</code></pre></div></div></blockquote></div><p>I actually did run it with -vga none, but i copied the wrong command. I used -vga std to install windows in the VM</p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1418112">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1418140" class="blockpost roweven"> <h2><span><span class="conr">#1752</span> <a href="viewtopic.php?pid=1418140#p1418140">2014-05-22 14:57:23</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=79237">mbroemme</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>From: Cologne</span></dd> <dd><span>Registered: 2014-02-05</span></dd> <dd><span>Posts: 39</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=79237">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <p>@esmth: I had a lot of similar troubles recently (similar to yours with sporadic freeze after start, freeze of VM only, etc...) and I found out that stability of VGA passthrough highly depends on which PCIe x16 slot I&#039;m using. If you don&#039;t mind and if it is possible I would just experiment a bit with it.</p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1418140">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1418143" class="blockpost rowodd"> <h2><span><span class="conr">#1753</span> <a href="viewtopic.php?pid=1418143#p1418143">2014-05-22 15:03:37</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=81745">siddharta</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2014-05-03</span></dd> <dd><span>Posts: 30</span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>siddharta wrote:</cite><blockquote><div><p>dmesg | grep -e vfio then shows</p><div class="codebox"><pre><code>[302278.633004] vfio_pin_pages: RLIMIT_MEMLOCK (65536) exceeded [302278.633015] vfio_pin_pages: RLIMIT_MEMLOCK (65536) exceeded</code></pre></div><p>Permissions for /dev/vfio/ are</p><div class="codebox"><pre><code>crw-rw-rw- 1 root root 251, 0 May 18 22:48 1 crw-rw-rw- 1 root root 10, 196 May 18 22:45 vfio</code></pre></div><p>qemu is running its processes as root and the acl in /etc/libvirt/qemu.conf is</p><div class="codebox"><pre><code>cgroup_device_acl = [ &quot;/dev/null&quot;, &quot;/dev/full&quot;, &quot;/dev/zero&quot;, &quot;/dev/random&quot;, &quot;/dev/urandom&quot;, &quot;/dev/ptmx&quot;, &quot;/dev/kvm&quot;, &quot;/dev/kqemu&quot;, &quot;/dev/rtc&quot;,&quot;/dev/hpet&quot;, &quot;/dev/vfio/vfio&quot;, &quot;/dev/vfio/1&quot; ]</code></pre></div></div></blockquote></div><p>In addition, I&#039;ve increased default memlock limits in /etc/security/limits.conf and confirmed with ulimit.</p><div class="codebox"><pre><code>user@kvmhost-2:~&gt; ulimit -l 1048576 user@kvmhost-2:~&gt; ulimit -Hl 1048576</code></pre></div><p>So I have no idea why dmesg still gives the RLIMIT_MEMLOCK 65k...</p><p>It does look like a permissions issue somewhere but I&#039;m all out of ideas...</p> <p class="postedit"><em>Last edited by siddharta (2014-05-22 15:04:30)</em></p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1418143">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1418195" class="blockpost roweven"> <h2><span><span class="conr">#1754</span> <a href="viewtopic.php?pid=1418195#p1418195">2014-05-22 18:43:44</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=82136">Chrissi</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2014-05-20</span></dd> <dd><span>Posts: 5</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=82136">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <p>Finally I figured out how to start and boot my vm. Passthrough works fine. Performance is also good. The only problem is and therefore I originally tried to use virtualitation that I am not able to start two virtual machines with a dedicated graphic card each. I always get:</p><div class="quotebox"><blockquote><div><p>qemu-system-x86_64: -device vfio-pci,host=02:00.0,bus=root.1,addr=00.0,multifunction=on,x-vga=on: vfio: error opening /dev/vfio/1: Device or resource busy<br />qemu-system-x86_64: -device vfio-pci,host=02:00.0,bus=root.1,addr=00.0,multifunction=on,x-vga=on: vfio: failed to get group 1<br />qemu-system-x86_64: -device vfio-pci,host=02:00.0,bus=root.1,addr=00.0,multifunction=on,x-vga=on: Device initialization failed.<br />qemu-system-x86_64: -device vfio-pci,host=02:00.0,bus=root.1,addr=00.0,multifunction=on,x-vga=on: Device &#039;vfio-pci&#039; could not be initialized</p></div></blockquote></div><p>I figured out that all my 3 cards are in the same iommu_group and therefore got in the same vfio_group (in my case its group 1).<br />Doing some research I even found the procedures/functions in the iommu.c part of the kernel in which iommu_groups are assigned.<br />But i cant manage to find a working solution to change this group.</p><p>Does anybody have an idea how I could solve this issue?<br />Help would be really appreciated, thanks <img src="https://bbs.archlinux.org/img/smilies/smile.png" width="15" height="15" alt="smile" /></p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1418195">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1418197" class="blockpost rowodd"> <h2><span><span class="conr">#1755</span> <a href="viewtopic.php?pid=1418197#p1418197">2014-05-22 18:47:45</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=75590">aw</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2013-10-04</span></dd> <dd><span>Posts: 921</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=75590">Email</a></span> <span class="website"><a href="http://vfio.blogspot.com/" rel="nofollow">Website</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>Chrissi wrote:</cite><blockquote><div><p>Finally I figured out how to start and boot my vm. Passthrough works fine. Performance is also good. The only problem is and therefore I originally tried to use virtualitation that I am not able to start two virtual machines with a dedicated graphic card each. I always get:</p><div class="quotebox"><blockquote><div><p>qemu-system-x86_64: -device vfio-pci,host=02:00.0,bus=root.1,addr=00.0,multifunction=on,x-vga=on: vfio: error opening /dev/vfio/1: Device or resource busy<br />qemu-system-x86_64: -device vfio-pci,host=02:00.0,bus=root.1,addr=00.0,multifunction=on,x-vga=on: vfio: failed to get group 1<br />qemu-system-x86_64: -device vfio-pci,host=02:00.0,bus=root.1,addr=00.0,multifunction=on,x-vga=on: Device initialization failed.<br />qemu-system-x86_64: -device vfio-pci,host=02:00.0,bus=root.1,addr=00.0,multifunction=on,x-vga=on: Device &#039;vfio-pci&#039; could not be initialized</p></div></blockquote></div><p>I figured out that all my 3 cards are in the same iommu_group and therefore got in the same vfio_group (in my case its group 1).<br />Doing some research I even found the procedures/functions in the iommu.c part of the kernel in which iommu_groups are assigned.<br />But i cant manage to find a working solution to change this group.</p><p>Does anybody have an idea how I could solve this issue?<br />Help would be really appreciated, thanks <img src="https://bbs.archlinux.org/img/smilies/smile.png" width="15" height="15" alt="smile" /></p></div></blockquote></div><p>Google for &quot;ACS override&quot;, apply the patch you find and enable it via kernel options.&#160; If one of the cards can be attached to a PCH root port (00:1c.*), the v3.15 kernel may help.</p> </div> <div class="postsignature postmsg"><hr /><p><a href="http://vfio.blogspot.com" rel="nofollow">http://vfio.blogspot.com</a><br />Looking for a more open forum to discuss vfio related uses?&#160; Try <a href="https://www.redhat.com/mailman/listinfo/vfio-users" rel="nofollow">https://www.redhat.com/mailman/listinfo/vfio-users</a></p></div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1418197">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1418198" class="blockpost roweven"> <h2><span><span class="conr">#1756</span> <a href="viewtopic.php?pid=1418198#p1418198">2014-05-22 18:50:37</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=75590">aw</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2013-10-04</span></dd> <dd><span>Posts: 921</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=75590">Email</a></span> <span class="website"><a href="http://vfio.blogspot.com/" rel="nofollow">Website</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>siddharta wrote:</cite><blockquote><div><div class="quotebox"><cite>siddharta wrote:</cite><blockquote><div><p>dmesg | grep -e vfio then shows</p><div class="codebox"><pre><code>[302278.633004] vfio_pin_pages: RLIMIT_MEMLOCK (65536) exceeded [302278.633015] vfio_pin_pages: RLIMIT_MEMLOCK (65536) exceeded</code></pre></div><p>Permissions for /dev/vfio/ are</p><div class="codebox"><pre><code>crw-rw-rw- 1 root root 251, 0 May 18 22:48 1 crw-rw-rw- 1 root root 10, 196 May 18 22:45 vfio</code></pre></div><p>qemu is running its processes as root and the acl in /etc/libvirt/qemu.conf is</p><div class="codebox"><pre><code>cgroup_device_acl = [ &quot;/dev/null&quot;, &quot;/dev/full&quot;, &quot;/dev/zero&quot;, &quot;/dev/random&quot;, &quot;/dev/urandom&quot;, &quot;/dev/ptmx&quot;, &quot;/dev/kvm&quot;, &quot;/dev/kqemu&quot;, &quot;/dev/rtc&quot;,&quot;/dev/hpet&quot;, &quot;/dev/vfio/vfio&quot;, &quot;/dev/vfio/1&quot; ]</code></pre></div></div></blockquote></div><p>In addition, I&#039;ve increased default memlock limits in /etc/security/limits.conf and confirmed with ulimit.</p><div class="codebox"><pre><code>user@kvmhost-2:~&gt; ulimit -l 1048576 user@kvmhost-2:~&gt; ulimit -Hl 1048576</code></pre></div><p>So I have no idea why dmesg still gives the RLIMIT_MEMLOCK 65k...</p><p>It does look like a permissions issue somewhere but I&#039;m all out of ideas...</p></div></blockquote></div><p>VFIO requires that the user has permission to lock the memory used by the guest.&#160; You can change the user libvirt uses to root to avoid the problem (/etc/libvirt/qemu.conf).&#160; You can also assign some other device to the VM using libvirt, then it will know to set the locked memory limit for the process appropriately.</p> </div> <div class="postsignature postmsg"><hr /><p><a href="http://vfio.blogspot.com" rel="nofollow">http://vfio.blogspot.com</a><br />Looking for a more open forum to discuss vfio related uses?&#160; Try <a href="https://www.redhat.com/mailman/listinfo/vfio-users" rel="nofollow">https://www.redhat.com/mailman/listinfo/vfio-users</a></p></div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1418198">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1418204" class="blockpost rowodd"> <h2><span><span class="conr">#1757</span> <a href="viewtopic.php?pid=1418204#p1418204">2014-05-22 19:26:49</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=78080">Slabity</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2013-12-29</span></dd> <dd><span>Posts: 40</span></dd> <dd class="usercontacts"><span class="email"><a href="mailto:tslabinski@mygsc.com">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <p>EDIT: Okay, so it seems I was wrong.</p><p>I can successfully run the test code if I set the host to run only on the intel processor. It does not matter which PCIe slot my passthrough card is in.</p><p>However, if I set my host to run on a dedicated card, I get no output from the other card running the test code.</p><p>Has anyone here successfully run a 2 card setup with 1 for the host and 1 for a passthrough? Or does anyone else have any intuition of what might be going on?</p> <p class="postedit"><em>Last edited by Slabity (2014-05-22 23:00:52)</em></p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1418204">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1418274" class="blockpost roweven"> <h2><span><span class="conr">#1758</span> <a href="viewtopic.php?pid=1418274#p1418274">2014-05-22 23:22:04</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=70922">nbhs</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd class="postavatar"><img src="https://bbs.archlinux.org/img/avatars/70922.jpg?m=1367773811" width="80" height="80" alt="" /></dd> <dd><span>From: Montevideo, Uruguay</span></dd> <dd><span>Registered: 2013-05-02</span></dd> <dd><span>Posts: 402</span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>Slabity wrote:</cite><blockquote><div><p>EDIT: Okay, so it seems I was wrong.</p><p>I can successfully run the test code if I set the host to run only on the intel processor. It does not matter which PCIe slot my passthrough card is in.</p><p>However, if I set my host to run on a dedicated card, I get no output from the other card running the test code.</p><p>Has anyone here successfully run a 2 card setup with 1 for the host and 1 for a passthrough? Or does anyone else have any intuition of what might be going on?</p></div></blockquote></div><p>Are you using 2 nvidia cards on your host?, because if you are you&#039;ll need to patch the nvidia drivers</p> <p class="postedit"><em>Last edited by nbhs (2014-05-22 23:28:55)</em></p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1418274">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1418275" class="blockpost rowodd"> <h2><span><span class="conr">#1759</span> <a href="viewtopic.php?pid=1418275#p1418275">2014-05-22 23:27:46</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=70922">nbhs</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd class="postavatar"><img src="https://bbs.archlinux.org/img/avatars/70922.jpg?m=1367773811" width="80" height="80" alt="" /></dd> <dd><span>From: Montevideo, Uruguay</span></dd> <dd><span>Registered: 2013-05-02</span></dd> <dd><span>Posts: 402</span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>aw wrote:</cite><blockquote><div><div class="quotebox"><cite>Chrissi wrote:</cite><blockquote><div><p>Finally I figured out how to start and boot my vm. Passthrough works fine. Performance is also good. The only problem is and therefore I originally tried to use virtualitation that I am not able to start two virtual machines with a dedicated graphic card each. I always get:</p><div class="quotebox"><blockquote><div><p>qemu-system-x86_64: -device vfio-pci,host=02:00.0,bus=root.1,addr=00.0,multifunction=on,x-vga=on: vfio: error opening /dev/vfio/1: Device or resource busy<br />qemu-system-x86_64: -device vfio-pci,host=02:00.0,bus=root.1,addr=00.0,multifunction=on,x-vga=on: vfio: failed to get group 1<br />qemu-system-x86_64: -device vfio-pci,host=02:00.0,bus=root.1,addr=00.0,multifunction=on,x-vga=on: Device initialization failed.<br />qemu-system-x86_64: -device vfio-pci,host=02:00.0,bus=root.1,addr=00.0,multifunction=on,x-vga=on: Device &#039;vfio-pci&#039; could not be initialized</p></div></blockquote></div><p>I figured out that all my 3 cards are in the same iommu_group and therefore got in the same vfio_group (in my case its group 1).<br />Doing some research I even found the procedures/functions in the iommu.c part of the kernel in which iommu_groups are assigned.<br />But i cant manage to find a working solution to change this group.</p><p>Does anybody have an idea how I could solve this issue?<br />Help would be really appreciated, thanks <img src="https://bbs.archlinux.org/img/smilies/smile.png" width="15" height="15" alt="smile" /></p></div></blockquote></div><p>Google for &quot;ACS override&quot;, apply the patch you find and enable it via kernel options.&#160; If one of the cards can be attached to a PCH root port (00:1c.*), the v3.15 kernel may help.</p></div></blockquote></div><p>You can get the acs override patch from my linux-mainline build, download <a href="http://www.fileswap.com/dl/1XfOihk7x0/" rel="nofollow">linux-mainline.tar.gz</a>, unpack it and it should be there</p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1418275">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1418276" class="blockpost roweven"> <h2><span><span class="conr">#1760</span> <a href="viewtopic.php?pid=1418276#p1418276">2014-05-22 23:43:43</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=78080">Slabity</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2013-12-29</span></dd> <dd><span>Posts: 40</span></dd> <dd class="usercontacts"><span class="email"><a href="mailto:tslabinski@mygsc.com">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>nbhs wrote:</cite><blockquote><div><div class="quotebox"><cite>Slabity wrote:</cite><blockquote><div><p>EDIT: Okay, so it seems I was wrong.</p><p>I can successfully run the test code if I set the host to run only on the intel processor. It does not matter which PCIe slot my passthrough card is in.</p><p>However, if I set my host to run on a dedicated card, I get no output from the other card running the test code.</p><p>Has anyone here successfully run a 2 card setup with 1 for the host and 1 for a passthrough? Or does anyone else have any intuition of what might be going on?</p></div></blockquote></div><p>Are you using 2 nvidia cards on your host?, because if you are you&#039;ll need to patch the nvidia drivers</p></div></blockquote></div><p>No. I have one AMD and one Nvidia. I&#039;m trying to let my host use the AMD card while I pass the Nvidia one to the guest.</p><div class="codebox"><pre><code>$ lspci | grep VGA 00:02.0 VGA compatible controller: Intel Corporation Xeon E3-1200 v3/4th Gen Core Processor Integrated Graphics Controller (rev 06) 01:00.0 VGA compatible controller: Advanced Micro Devices, Inc. [AMD/ATI] Barts XT [Radeon HD 6870] 02:00.0 VGA compatible controller: NVIDIA Corporation GK110 [GeForce GTX 780] (rev a1)</code></pre></div><p>I can pass through the card if I am running my host on integrated graphics. I can&#039;t seem to pass the card if I run the host on the AMD card, which is my current target.</p> <p class="postedit"><em>Last edited by Slabity (2014-05-22 23:46:13)</em></p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1418276">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1418282" class="blockpost rowodd"> <h2><span><span class="conr">#1761</span> <a href="viewtopic.php?pid=1418282#p1418282">2014-05-23 00:29:48</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=70922">nbhs</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd class="postavatar"><img src="https://bbs.archlinux.org/img/avatars/70922.jpg?m=1367773811" width="80" height="80" alt="" /></dd> <dd><span>From: Montevideo, Uruguay</span></dd> <dd><span>Registered: 2013-05-02</span></dd> <dd><span>Posts: 402</span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>Slabity wrote:</cite><blockquote><div><div class="quotebox"><cite>nbhs wrote:</cite><blockquote><div><div class="quotebox"><cite>Slabity wrote:</cite><blockquote><div><p>EDIT: Okay, so it seems I was wrong.</p><p>I can successfully run the test code if I set the host to run only on the intel processor. It does not matter which PCIe slot my passthrough card is in.</p><p>However, if I set my host to run on a dedicated card, I get no output from the other card running the test code.</p><p>Has anyone here successfully run a 2 card setup with 1 for the host and 1 for a passthrough? Or does anyone else have any intuition of what might be going on?</p></div></blockquote></div><p>Are you using 2 nvidia cards on your host?, because if you are you&#039;ll need to patch the nvidia drivers</p></div></blockquote></div><p>No. I have one AMD and one Nvidia. I&#039;m trying to let my host use the AMD card while I pass the Nvidia one to the guest.</p><div class="codebox"><pre><code>$ lspci | grep VGA 00:02.0 VGA compatible controller: Intel Corporation Xeon E3-1200 v3/4th Gen Core Processor Integrated Graphics Controller (rev 06) 01:00.0 VGA compatible controller: Advanced Micro Devices, Inc. [AMD/ATI] Barts XT [Radeon HD 6870] 02:00.0 VGA compatible controller: NVIDIA Corporation GK110 [GeForce GTX 780] (rev a1)</code></pre></div><p>I can pass through the card if I am running my host on integrated graphics. I can&#039;t seem to pass the card if I run the host on the AMD card, which is my current target.</p></div></blockquote></div><p>Are you using the open source driver or fglrx?</p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1418282">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1418283" class="blockpost roweven"> <h2><span><span class="conr">#1762</span> <a href="viewtopic.php?pid=1418283#p1418283">2014-05-23 00:37:38</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=78080">Slabity</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2013-12-29</span></dd> <dd><span>Posts: 40</span></dd> <dd class="usercontacts"><span class="email"><a href="mailto:tslabinski@mygsc.com">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>nbhs wrote:</cite><blockquote><div><p>Are you using the open source driver or fglrx?</p></div></blockquote></div><p>Open source.</p><div class="codebox"><pre class="vscroll"><code>$ lspci -v ... 01:00.0 VGA compatible controller: Advanced Micro Devices, Inc. [AMD/ATI] Barts XT [Radeon HD 6870] (prog-if 00 [VGA controller]) Subsystem: Gigabyte Technology Co., Ltd Device 21fa Flags: bus master, fast devsel, latency 0, IRQ 47 Memory at d0000000 (64-bit, prefetchable) [size=256M] Memory at ef320000 (64-bit, non-prefetchable) [size=128K] I/O ports at e000 [size=256] Expansion ROM at ef300000 [disabled] [size=128K] Capabilities: &lt;access denied&gt; Kernel driver in use: radeon Kernel modules: radeon ... 02:00.0 VGA compatible controller: NVIDIA Corporation GK110 [GeForce GTX 780] (rev a1) (prog-if 00 [VGA controller]) Subsystem: eVga.com. Corp. Device 2784 Flags: fast devsel, IRQ 10 Memory at ee000000 (32-bit, non-prefetchable) [disabled] [size=16M] Memory at e0000000 (64-bit, prefetchable) [disabled] [size=128M] Memory at e8000000 (64-bit, prefetchable) [disabled] [size=32M] I/O ports at d000 [disabled] [size=128] Expansion ROM at ef000000 [disabled] [size=512K] Capabilities: &lt;access denied&gt; Kernel driver in use: vfio-pci Kernel modules: nouveau ...</code></pre></div> <p class="postedit"><em>Last edited by Slabity (2014-05-23 00:38:33)</em></p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1418283">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1418295" class="blockpost rowodd"> <h2><span><span class="conr">#1763</span> <a href="viewtopic.php?pid=1418295#p1418295">2014-05-23 02:07:26</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=82203">shelladept</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2014-05-22</span></dd> <dd><span>Posts: 4</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=82203">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <p>Hello,</p><p>I am also trying to get PCI-Passthrough to work on my system and am having issues generating the test window.&#160; I&#039;ve followed all of the tutorial steps to the best of my knowledge. When attempting to run the test window (sudo):</p><div class="codebox"><pre><code>qemu-system-x86_64 -enable-kvm -M q35 -m 1024 -cpu host \ -smp 6,sockets=1,cores=6,threads=1 \ -bios /usr/share/qemu/bios.bin -vga none \ -device ioh3420,bus=pcie.0,addr=1c.0,multifunction=on,port=1,chassis=1,id=root.1 \ -device vfio-pci,host=01:00.0,bus=root.1,addr=00.0,multifunction=on,x-vga=on \ -device vfio-pci,host=01:00.1,bus=root.1,addr=00.1</code></pre></div><p>I get the following errors:</p><div class="codebox"><pre><code>qemu-system-x86_64: -device vfio-pci,host=01:00.0,bus=root.1,addr=00.0,multifunction=on,x-vga=on: vfio: error opening /dev/vfio/1: No such file or directory qemu-system-x86_64: -device vfio-pci,host=01:00.0,bus=root.1,addr=00.0,multifunction=on,x-vga=on: vfio: failed to get group 1 qemu-system-x86_64: -device vfio-pci,host=01:00.0,bus=root.1,addr=00.0,multifunction=on,x-vga=on: Device initialization failed. qemu-system-x86_64: -device vfio-pci,host=01:00.0,bus=root.1,addr=00.0,multifunction=on,x-vga=on: Device &#039;vfio-pci&#039; could not be initialized</code></pre></div><p>Some notes about my system:</p><p>MOBO: ASROCK Z77 (VT-d enabled)<br />CPU: i7-3770 (non-K)<br />HOST OS: Ubuntu 14.04 LTS<br />Primary GPU: On-Board Graphics<br />Secondary GPU: Saphire Radeon 4770</p><p>and configuration:</p><div class="codebox"><pre><code>~$ grep GRUB_CMDLINE /etc/default/grub GRUB_CMDLINE_LINUX_DEFAULT=&quot;quiet splash intel_iommu=on vfio_iommu_type1.allow_unsafe_interrupts=1 pci-stub.ids=1002:xxxx,1002:yyyy&quot; GRUB_CMDLINE_LINUX=&quot;&quot; ~$ cat /proc/cmdline BOOT_IMAGE=/vmlinuz-3.15.0-rc6 root=/dev/mapper/rocko--vg-root ro quiet splash intel_iommu=on pci-stub.ids=1002:xxxx,1002:yyyy vt.handoff=7</code></pre></div><p>#NOTE: I compiled 3.15.0-rc6 after having the same issue with the stock Ubuntu 14.04-provided kernel.&#160; So it doesn&#039;t seem related.<br />#NOTE: I tried booting with and without &#039;intel_iommu=on&#039; in grub.cfg<br />#NOTE: I can&#039;t seem to get &quot;vfio_iommu_type1.allow_unsafe_interrupts=1&quot; to show up in /proc/cmdline even though its been added to /etc/default/grub, which is used to update /boot/grub/grub.cfg in Ubuntu. I&#039;ve run &#039;update-grub&#039; and &#039;update-initramfs -u&#039;.&#160; I also tried adding &quot;options vfio_iommu_type1 allow_unsafe_interrupts=1&quot; to &quot;/etc/modprobe.d/vfio_iommu_type1.conf&quot;.&#160; I&#039;m not sure if this addition is necessary in my case regardless. </p><p>I&#039;m using QEMU 2.0.0 and included the pci_stub, vfio, vfio_pci, vfio_iommu_type1, kvm, and kvm_intel modules.&#160; I also blacklisted &#039;radeon&#039; and &#039;fglrx&#039; on the host Ubuntu system and bound the Radeon 4770 to PCI-stub.</p><div class="codebox"><pre class="vscroll"><code>~$ qemu -version QEMU emulator version 2.0.0 (Debian 2.0.0+dfsg-2ubuntu1), Copyright (c) 2003-2008 Fabrice Bellard ~$ sudo apt-get install seabios | grep seabios seabios is already the newest version. ~$ lsmod | grep -e pci -e vfio -e kvm| tail -n 6 pci_stub 12622 1 vfio_pci 36474 0 vfio_iommu_type1 17632 0 kvm_intel 143255 0 kvm 446871 1 kvm_intel vfio 25164 2 vfio_iommu_type1,vfio_pci ~$ cat /etc/modprobe.d/blacklist.conf | grep -e radeon -e fglrx blacklist radeon blacklist fglrx ~$ lspci | grep Advanced 01:00.0 VGA compatible controller: Advanced Micro Devices, Inc. [AMD/ATI] RV740 PRO [Radeon HD 4770] 01:00.1 Audio device: Advanced Micro Devices, Inc. [AMD/ATI] RV710/730 HDMI Audio [Radeon HD 4000 series] ~$ lspci -n | grep &quot;01:00&quot; 01:00.0 0300: 1002:xxxx 01:00.1 0403: 1002:yyyy ~$ dmesg | grep pci-stub [ 0.000000] Command line: BOOT_IMAGE=/vmlinuz-3.15.0-rc6 root=/dev/mapper/rocko--vg-root ro quiet splash intel_iommu=on pci-stub.ids=1002:xxxx,1002:yyyy vt.handoff=7 [ 0.000000] Kernel command line: BOOT_IMAGE=/vmlinuz-3.15.0-rc6 root=/dev/mapper/rocko--vg-root ro quiet splash intel_iommu=on pci-stub.ids=1002:xxxx,1002:yyyy vt.handoff=7 [ 47.239570] pci-stub: add 1002:xxxx sub=FFFFFFFF:FFFFFFFF cls=00000000/00000000 [ 47.239584] pci-stub 0000:01:00.0: claimed by stub [ 47.239590] pci-stub: add 1002:yyyy sub=FFFFFFFF:FFFFFFFF cls=00000000/00000000 [ 47.239597] pci-stub 0000:01:00.1: claimed by stub ~$ cat /etc/vfio-pci.cfg DEVICES=&quot;0000:01:00.0 0000:01:00.1&quot;</code></pre></div><p>Note that I have created /usr/bin/vfio-bind and /etc/systemd/system/binds-vfio-pci.service with no customizations.&#160; I am not trying to bind usb ports yet, just the 2 radeon &#039;devices&#039; (gpu+gpu audio component).&#160; From what I can tell there is supposed to be a vfio &#039;group&#039; containing these devices at /dev/vfio/1, but there isn&#039;t:</p><div class="codebox"><pre><code>~$ ls /dev/vfio/ vfio</code></pre></div><p>I&#039;m basing this on 2 of the errors and the output of readlink, <a href="https://github.com/awilliam/linux-vfio/blob/next/Documentation/vfio.txt" rel="nofollow">per further investigation</a>:</p><div class="codebox"><pre><code>vfio: failed to get group 1 vfio: error opening /dev/vfio/1 ~$ readlink /sys/bus/pci/devices/0000\:01\:00.0/iommu_group ../../../../kernel/iommu_groups/1</code></pre></div><p>I apologize if I&#039;ve spammed too much information here; I just want to make sure that I&#039;ve included all relevant troubleshooting information.&#160; Let me know if I need to share something else.&#160; Or if i need to be clearer.&#160; I suspect the key to my issue is the lack of &#039;/dev/vfio/1&#039; creation.&#160; If true, I&#039;m also not sure why it isn&#039;t being created.&#160; I trawled through these 70+ pages yesterday trying to find a solution but am not sure where I&#039;ve gone wrong.&#160; I would appreciate any feedback.</p><p>Thanks in advance,<br />shelladept</p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1418295">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1418297" class="blockpost roweven"> <h2><span><span class="conr">#1764</span> <a href="viewtopic.php?pid=1418297#p1418297">2014-05-23 02:19:30</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=75590">aw</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2013-10-04</span></dd> <dd><span>Posts: 921</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=75590">Email</a></span> <span class="website"><a href="http://vfio.blogspot.com/" rel="nofollow">Website</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>shelladept wrote:</cite><blockquote><div><p>I apologize if I&#039;ve spammed too much information here; I just want to make sure that I&#039;ve included all relevant troubleshooting information.&#160; Let me know if I need to share something else.&#160; Or if i need to be clearer.&#160; I suspect the key to my issue is the lack of &#039;/dev/vfio/1&#039; creation.&#160; If true, I&#039;m also not sure why it isn&#039;t being created.&#160; I trawled through these 70+ pages yesterday trying to find a solution but am not sure where I&#039;ve gone wrong.&#160; I would appreciate any feedback.</p></div></blockquote></div><p>Thanks for the detailed report, more information is always better.&#160; What I don&#039;t see is any evidence that 1:00.0 and 1:00.1 are actually bound to vfio-pci, you&#039;ve kind of skimmed over the vfio-bind scripts you&#039;re using.&#160; What does &#039;lspci -ks 1:&#039; report for the driver in use?&#160; Your lsmod shows the reference count of vfio-pci is 0, so I don&#039;t think you&#039;ve got any devices bound to it.&#160; The vfio group dev file is created when devices are bound to vfio-pci.</p> </div> <div class="postsignature postmsg"><hr /><p><a href="http://vfio.blogspot.com" rel="nofollow">http://vfio.blogspot.com</a><br />Looking for a more open forum to discuss vfio related uses?&#160; Try <a href="https://www.redhat.com/mailman/listinfo/vfio-users" rel="nofollow">https://www.redhat.com/mailman/listinfo/vfio-users</a></p></div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1418297">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1418314" class="blockpost rowodd"> <h2><span><span class="conr">#1765</span> <a href="viewtopic.php?pid=1418314#p1418314">2014-05-23 04:03:30</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=82203">shelladept</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2014-05-22</span></dd> <dd><span>Posts: 4</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=82203">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>aw wrote:</cite><blockquote><div><div class="quotebox"><cite>shelladept wrote:</cite><blockquote><div><p>I apologize if I&#039;ve spammed too much information here; I just want to make sure that I&#039;ve included all relevant troubleshooting information.&#160; Let me know if I need to share something else.&#160; Or if i need to be clearer.&#160; I suspect the key to my issue is the lack of &#039;/dev/vfio/1&#039; creation.&#160; If true, I&#039;m also not sure why it isn&#039;t being created.&#160; I trawled through these 70+ pages yesterday trying to find a solution but am not sure where I&#039;ve gone wrong.&#160; I would appreciate any feedback.</p></div></blockquote></div><p>Thanks for the detailed report, more information is always better.&#160; What I don&#039;t see is any evidence that 1:00.0 and 1:00.1 are actually bound to vfio-pci, you&#039;ve kind of skimmed over the vfio-bind scripts you&#039;re using.&#160; What does &#039;lspci -ks 1:&#039; report for the driver in use?&#160; Your lsmod shows the reference count of vfio-pci is 0, so I don&#039;t think you&#039;ve got any devices bound to it.&#160; The vfio group dev file is created when devices are bound to vfio-pci.</p></div></blockquote></div><p>Thank you for the quick reply!&#160; &#039;lspci -ks 1:&#039; returns the following:</p><div class="codebox"><pre><code>01:00.0 VGA compatible controller: Advanced Micro Devices, Inc. [AMD/ATI] RV740 PRO [Radeon HD 4770] Subsystem: Advanced Micro Devices, Inc. [AMD/ATI] Device 0d00 Kernel driver in use: pci-stub 01:00.1 Audio device: Advanced Micro Devices, Inc. [AMD/ATI] RV710/730 HDMI Audio [Radeon HD 4000 series] Subsystem: Advanced Micro Devices, Inc. [AMD/ATI] RV710/730 HDMI Audio [Radeon HD 4000 series] Kernel driver in use: pci-stub</code></pre></div><p>If I understand what is going on here, &#039;pci-stub&#039; has the 2 card &#039;devices&#039; instead of vfio_pci? But why does it show only 1 in the lsmod output?&#160; Is this because PCI &#039;sees&#039; one object while VFIO distinguishes between the 2 &#039;devices&#039;? Pardon my ignorance, I&#039;m still figuring out exactly how VFIO does its magic.&#160; I also apologize for leaving out those particular details you mentioned.&#160; I was trying to keep my post as short as possible.&#160; To clear up any confusion, the verbatim contents of &#039;/usr/bin/vfio-bind&#039; are:</p><div class="codebox"><pre><code>~$ cat /usr/bin/vfio-bind #!/bin/bash modprobe vfio-pci for dev in &quot;$@&quot;; do vendor=$(cat /sys/bus/pci/devices/$dev/vendor) device=$(cat /sys/bus/pci/devices/$dev/device) if [ -e /sys/bus/pci/devices/$dev/driver ]; then echo $dev &gt; /sys/bus/pci/devices/$dev/driver/unbind fi echo $vendor $device &gt; /sys/bus/pci/drivers/vfio-pci/new_id done</code></pre></div><p>Now on further review I think the &#039;modprobe vfio-pci&#039; line may be redundant since I included vfio-pci in my /etc/modules file:</p><div class="codebox"><pre><code>~$ cat /etc/modules | grep -e vfio -e pci vfio vfio_pci pci_stub vfio_iommu_type1</code></pre></div><p>&#039;vfio-bind&#039; is launched by systemd using &#039;/etc/systemd/system/binds-vfio-pci.service&#039; at boot:</p><div class="codebox"><pre><code>~$ cat /etc/systemd/system/binds-vfio-pci.service [Unit] Description=Binds devices to vfio-pci After=syslog.target [Service] EnvironmentFile=-/etc/vfio-pci.cfg Type=oneshot RemainAfterExit=yes ExecStart=-/usr/bin/vfio-bind $DEVICES [Install] WantedBy=multi-user.target</code></pre></div><p>and &#039;binds-vfio-pci.service&#039; obtains the value of $DEVICES from &#039;/etc/vfio-pci.cfg&#039;:</p><div class="codebox"><pre><code>~$ cat /etc/vfio-pci.cfg DEVICES=&quot;0000:01:00.0 0000:01:00.1&quot;</code></pre></div><p>At least that is what I believe is happening; I very well could be misinterpreting one of these files and would appreciate any clarification.&#160; Let me know if I can provide further details and thank you again!</p><p>shelladept</p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1418314">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1418316" class="blockpost roweven"> <h2><span><span class="conr">#1766</span> <a href="viewtopic.php?pid=1418316#p1418316">2014-05-23 04:15:01</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=75590">aw</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2013-10-04</span></dd> <dd><span>Posts: 921</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=75590">Email</a></span> <span class="website"><a href="http://vfio.blogspot.com/" rel="nofollow">Website</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>shelladept wrote:</cite><blockquote><div><div class="quotebox"><cite>aw wrote:</cite><blockquote><div><div class="quotebox"><cite>shelladept wrote:</cite><blockquote><div><p>I apologize if I&#039;ve spammed too much information here; I just want to make sure that I&#039;ve included all relevant troubleshooting information.&#160; Let me know if I need to share something else.&#160; Or if i need to be clearer.&#160; I suspect the key to my issue is the lack of &#039;/dev/vfio/1&#039; creation.&#160; If true, I&#039;m also not sure why it isn&#039;t being created.&#160; I trawled through these 70+ pages yesterday trying to find a solution but am not sure where I&#039;ve gone wrong.&#160; I would appreciate any feedback.</p></div></blockquote></div><p>Thanks for the detailed report, more information is always better.&#160; What I don&#039;t see is any evidence that 1:00.0 and 1:00.1 are actually bound to vfio-pci, you&#039;ve kind of skimmed over the vfio-bind scripts you&#039;re using.&#160; What does &#039;lspci -ks 1:&#039; report for the driver in use?&#160; Your lsmod shows the reference count of vfio-pci is 0, so I don&#039;t think you&#039;ve got any devices bound to it.&#160; The vfio group dev file is created when devices are bound to vfio-pci.</p></div></blockquote></div><p>Thank you for the quick reply!&#160; &#039;lspci -ks 1:&#039; returns the following:</p><div class="codebox"><pre><code>01:00.0 VGA compatible controller: Advanced Micro Devices, Inc. [AMD/ATI] RV740 PRO [Radeon HD 4770] Subsystem: Advanced Micro Devices, Inc. [AMD/ATI] Device 0d00 Kernel driver in use: pci-stub 01:00.1 Audio device: Advanced Micro Devices, Inc. [AMD/ATI] RV710/730 HDMI Audio [Radeon HD 4000 series] Subsystem: Advanced Micro Devices, Inc. [AMD/ATI] RV710/730 HDMI Audio [Radeon HD 4000 series] Kernel driver in use: pci-stub</code></pre></div><p>...</p><p>At least that is what I believe is happening; I very well could be misinterpreting one of these files and would appreciate any clarification.&#160; Let me know if I can provide further details and thank you again!</p></div></blockquote></div><p>Well, the device are bound to pci-stub, so either something is wrong with the scripts or they aren&#039;t being run.&#160; So start with running them by hand...</p><p>/usr/bin/vfio-bind 0000:01:00.0 0000:01:00.1</p><p>Run lspci -k again, are the device bound to vfio-pci?&#160; If so, is the service enabled in systemd?&#160; If not, is the script executable?</p> </div> <div class="postsignature postmsg"><hr /><p><a href="http://vfio.blogspot.com" rel="nofollow">http://vfio.blogspot.com</a><br />Looking for a more open forum to discuss vfio related uses?&#160; Try <a href="https://www.redhat.com/mailman/listinfo/vfio-users" rel="nofollow">https://www.redhat.com/mailman/listinfo/vfio-users</a></p></div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1418316">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1418329" class="blockpost rowodd"> <h2><span><span class="conr">#1767</span> <a href="viewtopic.php?pid=1418329#p1418329">2014-05-23 04:54:54</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=82203">shelladept</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2014-05-22</span></dd> <dd><span>Posts: 4</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=82203">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>aw wrote:</cite><blockquote><div><div class="quotebox"><cite>shelladept wrote:</cite><blockquote><div><div class="quotebox"><cite>aw wrote:</cite><blockquote><div><p>Thanks for the detailed report, more information is always better.&#160; What I don&#039;t see is any evidence that 1:00.0 and 1:00.1 are actually bound to vfio-pci, you&#039;ve kind of skimmed over the vfio-bind scripts you&#039;re using.&#160; What does &#039;lspci -ks 1:&#039; report for the driver in use?&#160; Your lsmod shows the reference count of vfio-pci is 0, so I don&#039;t think you&#039;ve got any devices bound to it.&#160; The vfio group dev file is created when devices are bound to vfio-pci.</p></div></blockquote></div><p>Thank you for the quick reply!&#160; &#039;lspci -ks 1:&#039; returns the following:</p><div class="codebox"><pre><code>01:00.0 VGA compatible controller: Advanced Micro Devices, Inc. [AMD/ATI] RV740 PRO [Radeon HD 4770] Subsystem: Advanced Micro Devices, Inc. [AMD/ATI] Device 0d00 Kernel driver in use: pci-stub 01:00.1 Audio device: Advanced Micro Devices, Inc. [AMD/ATI] RV710/730 HDMI Audio [Radeon HD 4000 series] Subsystem: Advanced Micro Devices, Inc. [AMD/ATI] RV710/730 HDMI Audio [Radeon HD 4000 series] Kernel driver in use: pci-stub</code></pre></div><p>...</p><p>At least that is what I believe is happening; I very well could be misinterpreting one of these files and would appreciate any clarification.&#160; Let me know if I can provide further details and thank you again!</p></div></blockquote></div><p>Well, the device are bound to pci-stub, so either something is wrong with the scripts or they aren&#039;t being run.&#160; So start with running them by hand...</p><p>/usr/bin/vfio-bind 0000:01:00.0 0000:01:00.1</p><p>Run lspci -k again, are the device bound to vfio-pci?&#160; If so, is the service enabled in systemd?&#160; If not, is the script executable?</p></div></blockquote></div><p>Thank you again, aw!&#160; Running vfio-bind manually works:</p><div class="codebox"><pre><code>~$ lsmod | grep vfio vfio_iommu_type1 17632 0 vfio_pci 36474 0 vfio 25164 2 vfio_iommu_type1,vfio_pci</code></pre></div><p>so the issue is probably related to my configuration of systemd/binds-vfio-pci.service.</p><p>It looks like I am getting the test window to display now, although I get some weird colors on my host screen output afterward.&#160; I&#039;m guessing this is related to the Intel issue addressed by linux-mainline.tar.gz per the first page (If memory serves--more research for me!).&#160; I may have to compile another kernel but this is plenty of progress for me to get back on track.&#160; Thanks again!</p><p>shelladept</p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1418329">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1418330" class="blockpost roweven"> <h2><span><span class="conr">#1768</span> <a href="viewtopic.php?pid=1418330#p1418330">2014-05-23 04:57:35</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=75590">aw</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2013-10-04</span></dd> <dd><span>Posts: 921</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=75590">Email</a></span> <span class="website"><a href="http://vfio.blogspot.com/" rel="nofollow">Website</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>shelladept wrote:</cite><blockquote><div><p>It looks like I am getting the test window to display now, although I get some weird colors on my host screen output afterward.&#160; I&#039;m guessing this is related to the Intel issue addressed by linux-mainline.tar.gz per the first page (If memory serves--more research for me!).&#160; I may have to compile another kernel but this is plenty of progress for me to get back on track.&#160; Thanks again!</p></div></blockquote></div><p>Yes, i915 patches should clear up the host screen.</p> </div> <div class="postsignature postmsg"><hr /><p><a href="http://vfio.blogspot.com" rel="nofollow">http://vfio.blogspot.com</a><br />Looking for a more open forum to discuss vfio related uses?&#160; Try <a href="https://www.redhat.com/mailman/listinfo/vfio-users" rel="nofollow">https://www.redhat.com/mailman/listinfo/vfio-users</a></p></div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1418330">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1418342" class="blockpost rowodd"> <h2><span><span class="conr">#1769</span> <a href="viewtopic.php?pid=1418342#p1418342">2014-05-23 05:50:28</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=78080">Slabity</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2013-12-29</span></dd> <dd><span>Posts: 40</span></dd> <dd class="usercontacts"><span class="email"><a href="mailto:tslabinski@mygsc.com">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <p>Hey guys, sorry for posting again, but I&#039;m at a real loss here on what&#039;s wrong with my setup.</p><p>My current system has 3 VGA outputs. Intel, AMD, and Nvidia:</p><div class="codebox"><pre><code>$ lspci | grep VGA 00:02.0 VGA compatible controller: Intel Corporation Xeon E3-1200 v3/4th Gen Core Processor Integrated Graphics Controller (rev 06) 01:00.0 VGA compatible controller: Advanced Micro Devices, Inc. [AMD/ATI] Barts XT [Radeon HD 6870] 02:00.0 VGA compatible controller: NVIDIA Corporation GK110 [GeForce GTX 780] (rev a1)</code></pre></div><p>When I run the example script:</p><div class="codebox"><pre><code>qemu-system-x86_64 -enable-kvm -M q35 -m 1024 -cpu host \ -smp 6,sockets=1,cores=6,threads=1 \ -bios /usr/share/qemu/bios.bin -vga none \ -device ioh3420,bus=pcie.0,addr=1c.0,multifunction=on,port=1,chassis=1,id=root.1 \ -device vfio-pci,host=02:00.0,bus=root.1,addr=00.0,multifunction=on,x-vga=on \ -device vfio-pci,host=02:00.1,bus=root.1,addr=00.1</code></pre></div><p>My system works perfectly <em>when my host is using intel graphics.</em> A blank window appears and the seabios screen is being passed to another monitor.</p><p>But when I set my host to use the AMD card, the blank window appears, but there is nothing being passed to the other monitor.</p><p>I am using the open source radeon drivers.</p><p>Sorry again for posting so much, but I&#039;m running out of ideas.</p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1418342">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1418373" class="blockpost roweven"> <h2><span><span class="conr">#1770</span> <a href="viewtopic.php?pid=1418373#p1418373">2014-05-23 08:22:52</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=81745">siddharta</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2014-05-03</span></dd> <dd><span>Posts: 30</span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>aw wrote:</cite><blockquote><div><p>VFIO requires that the user has permission to lock the memory used by the guest.&#160; You can change the user libvirt uses to root to avoid the problem (/etc/libvirt/qemu.conf).&#160; You can also assign some other device to the VM using libvirt, then it will know to set the locked memory limit for the process appropriately.</p></div></blockquote></div><p>Thanks for this. I dug back into qemu.conf and found that, while qemu processes were supposed to run as root</p><div class="codebox"><pre><code>user = &quot;root&quot; group = &quot;root&quot;</code></pre></div><p> I had missed the clear_emulator_capabilities flag</p><div class="codebox"><pre><code># If clear_emulator_capabilities is enabled, libvirt will drop all # privileged capabilities of the QEmu/KVM emulator. This is enabled by # default. # # Warning: Disabling this option means that a compromised guest can # exploit the privileges and possibly do damage to the host. # clear_emulator_capabilities = 0</code></pre></div><p> which was set to its default restrictive setting. </p><p>For my understanding, could you please clarify </p><div class="quotebox"><cite>aw wrote:</cite><blockquote><div><p>You can also assign some other device to the VM using libvirt, then it will know to set the locked memory limit for the process appropriately.</p></div></blockquote></div><p>Thanks again, I&#039;m thrilled to have this working.</p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1418373">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1418420" class="blockpost rowodd"> <h2><span><span class="conr">#1771</span> <a href="viewtopic.php?pid=1418420#p1418420">2014-05-23 11:43:57</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=82136">Chrissi</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2014-05-20</span></dd> <dd><span>Posts: 5</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=82136">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>aw wrote:</cite><blockquote><div><p>Google for &quot;ACS override&quot;, apply the patch you find and enable it via kernel options.&#160; If one of the cards can be attached to a PCH root port (00:1c.*), the v3.15 kernel may help.</p></div></blockquote></div><p>I just installed the new 3.15-rc6 kernel which in my understanding contains the acs override patch.&#160; <br />Attaching one card to one vm still works fine. ( Starting more than one vm each with its own card assigned still gives the same &#039;failed to get group 1&#039; error. ) <br />I can&#039;t figure out how to attach a card to a specific PCH root port and what I would have to do afterwards to pass those root ports to my vm.<br />It would be great if you could give me some more advice regarding this topic.</p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1418420">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1418493" class="blockpost roweven"> <h2><span><span class="conr">#1772</span> <a href="viewtopic.php?pid=1418493#p1418493">2014-05-23 15:43:14</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=75590">aw</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2013-10-04</span></dd> <dd><span>Posts: 921</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=75590">Email</a></span> <span class="website"><a href="http://vfio.blogspot.com/" rel="nofollow">Website</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>Slabity wrote:</cite><blockquote><div><p>Hey guys, sorry for posting again, but I&#039;m at a real loss here on what&#039;s wrong with my setup.</p><p>My current system has 3 VGA outputs. Intel, AMD, and Nvidia:</p><div class="codebox"><pre><code>$ lspci | grep VGA 00:02.0 VGA compatible controller: Intel Corporation Xeon E3-1200 v3/4th Gen Core Processor Integrated Graphics Controller (rev 06) 01:00.0 VGA compatible controller: Advanced Micro Devices, Inc. [AMD/ATI] Barts XT [Radeon HD 6870] 02:00.0 VGA compatible controller: NVIDIA Corporation GK110 [GeForce GTX 780] (rev a1)</code></pre></div><p>When I run the example script:</p><div class="codebox"><pre><code>qemu-system-x86_64 -enable-kvm -M q35 -m 1024 -cpu host \ -smp 6,sockets=1,cores=6,threads=1 \ -bios /usr/share/qemu/bios.bin -vga none \ -device ioh3420,bus=pcie.0,addr=1c.0,multifunction=on,port=1,chassis=1,id=root.1 \ -device vfio-pci,host=02:00.0,bus=root.1,addr=00.0,multifunction=on,x-vga=on \ -device vfio-pci,host=02:00.1,bus=root.1,addr=00.1</code></pre></div><p>My system works perfectly <em>when my host is using intel graphics.</em> A blank window appears and the seabios screen is being passed to another monitor.</p><p>But when I set my host to use the AMD card, the blank window appears, but there is nothing being passed to the other monitor.</p><p>I am using the open source radeon drivers.</p><p>Sorry again for posting so much, but I&#039;m running out of ideas.</p></div></blockquote></div><p>It sounds like VGA arbitration isn&#039;t working when the AMD card is in use by the host.&#160; What does &#039;dmesg | grep vgaarb&#039; show?</p> </div> <div class="postsignature postmsg"><hr /><p><a href="http://vfio.blogspot.com" rel="nofollow">http://vfio.blogspot.com</a><br />Looking for a more open forum to discuss vfio related uses?&#160; Try <a href="https://www.redhat.com/mailman/listinfo/vfio-users" rel="nofollow">https://www.redhat.com/mailman/listinfo/vfio-users</a></p></div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1418493">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1418495" class="blockpost rowodd"> <h2><span><span class="conr">#1773</span> <a href="viewtopic.php?pid=1418495#p1418495">2014-05-23 15:46:18</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=75590">aw</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2013-10-04</span></dd> <dd><span>Posts: 921</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=75590">Email</a></span> <span class="website"><a href="http://vfio.blogspot.com/" rel="nofollow">Website</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>siddharta wrote:</cite><blockquote><div><div class="quotebox"><cite>aw wrote:</cite><blockquote><div><p>VFIO requires that the user has permission to lock the memory used by the guest.&#160; You can change the user libvirt uses to root to avoid the problem (/etc/libvirt/qemu.conf).&#160; You can also assign some other device to the VM using libvirt, then it will know to set the locked memory limit for the process appropriately.</p></div></blockquote></div><p>Thanks for this. I dug back into qemu.conf and found that, while qemu processes were supposed to run as root</p><div class="codebox"><pre><code>user = &quot;root&quot; group = &quot;root&quot;</code></pre></div><p> I had missed the clear_emulator_capabilities flag</p><div class="codebox"><pre><code># If clear_emulator_capabilities is enabled, libvirt will drop all # privileged capabilities of the QEmu/KVM emulator. This is enabled by # default. # # Warning: Disabling this option means that a compromised guest can # exploit the privileges and possibly do damage to the host. # clear_emulator_capabilities = 0</code></pre></div><p> which was set to its default restrictive setting. </p><p>For my understanding, could you please clarify</p></div></blockquote></div><p>libvirt attempts to run qemu with as few privileges as possible to protect the host from the guest &quot;breaking out&quot; of it&#039;s VM.&#160; Using an assigned device requires certain privileges which libvirt retains when device assignment is used.&#160; &#160;When libvirt doesn&#039;t know about an assigned device, it can&#039;t grant those privileges.</p> </div> <div class="postsignature postmsg"><hr /><p><a href="http://vfio.blogspot.com" rel="nofollow">http://vfio.blogspot.com</a><br />Looking for a more open forum to discuss vfio related uses?&#160; Try <a href="https://www.redhat.com/mailman/listinfo/vfio-users" rel="nofollow">https://www.redhat.com/mailman/listinfo/vfio-users</a></p></div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1418495">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1418501" class="blockpost roweven"> <h2><span><span class="conr">#1774</span> <a href="viewtopic.php?pid=1418501#p1418501">2014-05-23 16:01:20</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=75590">aw</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2013-10-04</span></dd> <dd><span>Posts: 921</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=75590">Email</a></span> <span class="website"><a href="http://vfio.blogspot.com/" rel="nofollow">Website</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>Chrissi wrote:</cite><blockquote><div><div class="quotebox"><cite>aw wrote:</cite><blockquote><div><p>Google for &quot;ACS override&quot;, apply the patch you find and enable it via kernel options.&#160; If one of the cards can be attached to a PCH root port (00:1c.*), the v3.15 kernel may help.</p></div></blockquote></div><p>I just installed the new 3.15-rc6 kernel which in my understanding contains the acs override patch.</p></div></blockquote></div><p>Nope, 3.15 includes quirks approved by Intel to advertise the ACS-like isolation capabilities of PCH-based root ports and make sure they&#039;re enabled.&#160; This means that the hardware is actually providing the isolation required.&#160; The ACS override patch is a way for the user to override the hardware isolation requirement and is not going upstream.</p><div class="quotebox"><blockquote><div><p>Attaching one card to one vm still works fine. ( Starting more than one vm each with its own card assigned still gives the same &#039;failed to get group 1&#039; error. ) <br />I can&#039;t figure out how to attach a card to a specific PCH root port and what I would have to do afterwards to pass those root ports to my vm.<br />It would be great if you could give me some more advice regarding this topic.</p></div></blockquote></div><p>The host root ports never get passed to the VM.&#160; Which root ports are used is a physical property of your motherboard layout.&#160; It may require that you move the card to a different slot to connect to the PCH root port, if it&#039;s even possible.&#160; On my system I have:</p><div class="codebox"><pre><code>$ lspci | grep &quot;Root Port&quot; 00:01.0 PCI bridge: Intel Corporation Xeon E3-1200 v2/3rd Gen Core processor PCI Express Root Port (rev 09) 00:1c.0 PCI bridge: Intel Corporation 6 Series/C200 Series Chipset Family PCI Express Root Port 1 (rev b5) 00:1c.5 PCI bridge: Intel Corporation 6 Series/C200 Series Chipset Family PCI Express Root Port 6 (rev b5) 00:1c.6 PCI bridge: Intel Corporation 6 Series/C200 Series Chipset Family PCI Express Root Port 7 (rev b5)</code></pre></div><p>You can tell by the description (and bus addresses) that 00:01.0 is a processor-based root port while 00:1c.* are PCH-based root ports.&#160; My graphics cards are installed as:</p><div class="codebox"><pre><code>$ lspci -tv | grep -e NVIDIA -e AMD +-01.0-[01]--+-00.0 NVIDIA Corporation GK208 [GeForce GT 635] | \-00.1 NVIDIA Corporation Device 0e0f +-1c.0-[02]--+-00.0 Advanced Micro Devices, Inc. [AMD/ATI] Oland [Radeon HD 8570 / R7 240 OEM] | \-00.1 Advanced Micro Devices, Inc. [AMD/ATI] Cape Verde/Pitcairn HDMI Audio [Radeon HD 7700/7800 Series]</code></pre></div><p>So that only one is connected to the processor-based root port and the other is connected to the PCH-based root port.&#160; This way I don&#039;t need the ACS override patch since the v3.15 ACS quirks work for this chipset.&#160; Intel currently has no plans to provide information about whether hardware isolation is possible with processor-based root ports, so we shouldn&#039;t expect similar quirks for them anytime soon.&#160; We can hope that they&#039;ve learned their lesson with ACS and intend to support it on future consumer grade processors.&#160; BTW, even though the root port description indicates a Xeon processor, this is just a regular i5, apparently the PCI device ID is re-used between parts.&#160; Actual Xeon processors do have ACS support on the processor-based root ports.</p> </div> <div class="postsignature postmsg"><hr /><p><a href="http://vfio.blogspot.com" rel="nofollow">http://vfio.blogspot.com</a><br />Looking for a more open forum to discuss vfio related uses?&#160; Try <a href="https://www.redhat.com/mailman/listinfo/vfio-users" rel="nofollow">https://www.redhat.com/mailman/listinfo/vfio-users</a></p></div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1418501">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1418559" class="blockpost rowodd"> <h2><span><span class="conr">#1775</span> <a href="viewtopic.php?pid=1418559#p1418559">2014-05-23 18:15:59</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=78080">Slabity</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2013-12-29</span></dd> <dd><span>Posts: 40</span></dd> <dd class="usercontacts"><span class="email"><a href="mailto:tslabinski@mygsc.com">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>aw wrote:</cite><blockquote><div><p>It sounds like VGA arbitration isn&#039;t working when the AMD card is in use by the host.&#160; What does &#039;dmesg | grep vgaarb&#039; show?</p></div></blockquote></div><p>When I run with Intel as the host:</p><div class="codebox"><pre><code>[ 0.333676] vgaarb: device added: PCI:0000:00:02.0,decodes=io+mem,owns=io+mem,locks=none [ 0.333680] vgaarb: device added: PCI:0000:01:00.0,decodes=io+mem,owns=none,locks=none [ 0.333682] vgaarb: device added: PCI:0000:02:00.0,decodes=io+mem,owns=none,locks=none [ 0.333682] vgaarb: loaded [ 0.333683] vgaarb: bridge control possible 0000:02:00.0 [ 0.333683] vgaarb: bridge control possible 0000:01:00.0 [ 0.333684] vgaarb: no bridge control possible 0000:00:02.0 [ 2.855092] vgaarb: device changed decodes: PCI:0000:01:00.0,olddecodes=io+mem,decodes=none:owns=none [ 3.069294] vgaarb: device changed decodes: PCI:0000:00:02.0,olddecodes=io+mem,decodes=io:owns=io</code></pre></div><p>When I run with AMD as the host:</p><div class="codebox"><pre><code>[ 0.330061] vgaarb: device added: PCI:0000:01:00.0,decodes=io+mem,owns=io+mem,locks=none [ 0.330064] vgaarb: device added: PCI:0000:02:00.0,decodes=io+mem,owns=none,locks=none [ 0.330065] vgaarb: loaded [ 0.330065] vgaarb: bridge control possible 0000:02:00.0 [ 0.330066] vgaarb: bridge control possible 0000:01:00.0 [ 2.609390] vgaarb: device changed decodes: PCI:0000:01:00.0,olddecodes=io+mem,decodes=none:owns=none</code></pre></div><p>Doesn&#039;t seem too much different. Anything catch your eye?</p><p>In case it matters:</p><div class="codebox"><pre><code>$ lspci -tv +-01.0-[01]--+-00.0 Advanced Micro Devices, Inc. [AMD/ATI] Barts XT [Radeon HD 6870] | \-00.1 Advanced Micro Devices, Inc. [AMD/ATI] Barts HDMI Audio [Radeon HD 6800 Series] +-01.1-[02]--+-00.0 NVIDIA Corporation GK110 [GeForce GTX 780] | \-00.1 NVIDIA Corporation GK110 HDMI Audio</code></pre></div> <p class="postedit"><em>Last edited by Slabity (2014-05-23 18:19:00)</em></p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1418559">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div class="postlinksb"> <div class="inbox crumbsplus"> <div class="pagepost"> <p class="pagelink conl"><span class="pages-label">Pages: </span><a rel="prev" class="item1" href="viewtopic.php?id=162768&amp;p=70">Previous</a> <a href="viewtopic.php?id=162768">1</a> <span class="spacer">…</span> <a href="viewtopic.php?id=162768&amp;p=69">69</a> <a href="viewtopic.php?id=162768&amp;p=70">70</a> <strong>71</strong> <a href="viewtopic.php?id=162768&amp;p=72">72</a> <a href="viewtopic.php?id=162768&amp;p=73">73</a> <span class="spacer">…</span> <a href="viewtopic.php?id=162768&amp;p=234">234</a> <a rel="next" href="viewtopic.php?id=162768&amp;p=72">Next</a></p> <p class="postlink conr">Topic closed</p> </div> <ul class="crumbs"> <li><a href="index.php">Index</a></li> <li><span>»&#160;</span><a href="viewforum.php?id=48">Topics Going Nowhere</a></li> <li><span>»&#160;</span><strong><a href="viewtopic.php?id=162768">KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</a></strong></li> </ul> <p class="subscribelink clearb"><a href="misc.php?action=subscribe&amp;tid=162768">Subscribe to this topic</a></p> <div class="clearer"></div> </div> </div> </div> <div id="brdfooter" class="block"> <h2><span>Board footer</span></h2> <div class="box"> <div id="brdfooternav" class="inbox"> <div class="conl"> <form id="qjump" method="get" action="viewforum.php"> <div><label><span>Jump to<br /></span> <select name="id" onchange="window.location=('viewforum.php?id='+this.options[this.selectedIndex].value)"> <optgroup label="Technical Issues and Assistance"> <option value="23">Newbie Corner</option> <option value="17">Installation</option> <option value="22">Kernel &amp; Hardware</option> <option value="18">Applications &amp; Desktop Environments</option> <option value="31">Laptop Issues</option> <option value="8">Networking, Server, and Protection</option> <option value="32">Multimedia and Games</option> <option value="50">System Administration</option> <option value="35">Other Architectures</option> </optgroup> <optgroup label="Arch-centric"> <option value="24">Announcements, Package &amp; Security Advisories</option> <option value="1">Arch Discussion</option> <option value="13">Forum &amp; Wiki discussion</option> </optgroup> <optgroup label="Pacman Upgrades, Packaging &amp; AUR"> <option value="44">Pacman &amp; Package Upgrade Issues</option> <option value="49">[testing] Repo Forum</option> <option value="4">Creating &amp; Modifying Packages</option> <option value="38">AUR Issues, Discussion &amp; PKGBUILD Requests</option> </optgroup> <optgroup label="Contributions &amp; Discussion"> <option value="20">GNU/Linux Discussion</option> <option value="27">Community Contributions</option> <option value="33">Programming &amp; Scripting</option> <option value="30">Other Languages</option> <option value="47">Artwork and Screenshots</option> <option value="42">Try This</option> </optgroup> <optgroup label="/dev/null"> <option value="29">Off-Topic</option> <option value="48" selected="selected">Topics Going Nowhere</option> <option value="36">Dustbin</option> </optgroup> </select></label> <input type="submit" value=" Go " accesskey="g" /> </div> </form> </div> <div class="conr"> <p id="feedlinks"><span class="atom"><a href="extern.php?action=feed&amp;tid=162768&amp;type=atom">Atom topic feed</a></span></p> <p id="poweredby">Powered by <a href="http://fluxbb.org/">FluxBB</a></p> </div> <div class="clearer"></div> </div> </div> </div> </div> <div class="end-box"></div> </div> </body> </html>
