<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"> <html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en" dir="ltr"> <head> <meta http-equiv="Content-Type" content="text/html; charset=utf-8" /> <title>KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9 (Page 56) / Topics Going Nowhere / Arch Linux Forums</title> <link rel="stylesheet" type="text/css" href="style/ArchLinux.css" /> <link rel="canonical" href="viewtopic.php?id=162768&amp;p=56" title="Page 56" /> <link rel="prev" href="viewtopic.php?id=162768&amp;p=55" title="Page 55" /> <link rel="next" href="viewtopic.php?id=162768&amp;p=57" title="Page 57" /> <link rel="alternate" type="application/atom+xml" href="extern.php?action=feed&amp;tid=162768&amp;type=atom" title="Atom topic feed" /> <link rel="stylesheet" media="screen" href="style/ArchLinux/arch.css?v=3" /> <link rel="stylesheet" media="screen" href="style/ArchLinux/archnavbar.css?v=2" /> <link rel="shortcut icon" href="style/ArchLinux/favicon.ico" /> </head> <body> <div id="archnavbar" class="anb-forum"> <div id="archnavbarlogo"><h1><a href="http://www.archlinux.org/">Arch Linux</a></h1></div> <div id="archnavbarmenu"> <ul id="archnavbarlist"> <li id="anb-home"><a href="http://www.archlinux.org/">Home</a></li><li id="anb-packages"><a href="http://www.archlinux.org/packages/">Packages</a></li><li id="anb-forums" class="anb-selected"><a href="https://bbs.archlinux.org/">Forums</a></li><li id="anb-wiki"><a href="https://wiki.archlinux.org/">Wiki</a></li><li id="anb-bugs"><a href="https://bugs.archlinux.org/">Bugs</a></li><li id="anb-aur"><a href="https://aur.archlinux.org/">AUR</a></li><li id="anb-download"><a href="http://www.archlinux.org/download/">Download</a></li> </ul> </div> </div> <div id="punviewtopic" class="pun"> <div class="top-box"></div> <div class="punwrap"> <div id="brdheader" class="block"> <div class="box"> <div id="brdmenu" class="inbox"> <ul> <li id="navindex" class="isactive"><a href="index.php">Index</a></li> <li id="navuserlist"><a href="userlist.php">User list</a></li> <li id="navsearch"><a href="search.php">Search</a></li> <li id="navprofile"><a href="profile.php?id=80749">Profile</a></li> <li id="navlogout"><a href="login.php?action=out&amp;id=80749&amp;csrf_token=5c20501ec397bb45ef8ee8c84db232c8d8e421c6">Logout</a></li> </ul> </div> <div id="brdwelcome" class="inbox"> <ul class="conl"> <li><span>Logged in as <strong>SXX</strong></span></li> <li><span>Last visit: 2015-08-16 12:20:09</span></li> </ul> <ul class="conr"> <li><span>Topics: <a href="search.php?action=show_replies" title="Find topics you have posted to.">Posted</a> | <a href="search.php?action=show_new" title="Find topics with new posts since your last visit.">New</a> | <a href="search.php?action=show_recent" title="Find topics with recent posts.">Active</a> | <a href="search.php?action=show_unanswered" title="Find topics with no replies.">Unanswered</a></span></li> </ul> <div class="clearer"></div> </div> </div> </div> <div id="brdmain"> <div class="linkst"> <div class="inbox crumbsplus"> <ul class="crumbs"> <li><a href="index.php">Index</a></li> <li><span>»&#160;</span><a href="viewforum.php?id=48">Topics Going Nowhere</a></li> <li><span>»&#160;</span><strong><a href="viewtopic.php?id=162768">KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</a></strong></li> </ul> <div class="pagepost"> <p class="pagelink conl"><span class="pages-label">Pages: </span><a rel="prev" class="item1" href="viewtopic.php?id=162768&amp;p=55">Previous</a> <a href="viewtopic.php?id=162768">1</a> <span class="spacer">…</span> <a href="viewtopic.php?id=162768&amp;p=54">54</a> <a href="viewtopic.php?id=162768&amp;p=55">55</a> <strong>56</strong> <a href="viewtopic.php?id=162768&amp;p=57">57</a> <a href="viewtopic.php?id=162768&amp;p=58">58</a> <span class="spacer">…</span> <a href="viewtopic.php?id=162768&amp;p=234">234</a> <a rel="next" href="viewtopic.php?id=162768&amp;p=57">Next</a></p> <p class="postlink conr">Topic closed</p> </div> <div class="clearer"></div> </div> </div> <div id="p1393653" class="blockpost rowodd blockpost1"> <h2><span><span class="conr">#1376</span> <a href="viewtopic.php?pid=1393653#p1393653">2014-03-17 22:23:39</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=75590">aw</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2013-10-04</span></dd> <dd><span>Posts: 921</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=75590">Email</a></span> <span class="website"><a href="http://vfio.blogspot.com/" rel="nofollow">Website</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <p>I&#039;ve seen it in several posts recently, so I&#039;ll mention again, if you&#039;re running qemu.git you should not need to build and run a separate seabios.&#160; Only long, long ago before qemu updated their seabios snapshot was this necessary.</p> </div> <div class="postsignature postmsg"><hr /><p><a href="http://vfio.blogspot.com" rel="nofollow">http://vfio.blogspot.com</a><br />Looking for a more open forum to discuss vfio related uses?&#160; Try <a href="https://www.redhat.com/mailman/listinfo/vfio-users" rel="nofollow">https://www.redhat.com/mailman/listinfo/vfio-users</a></p></div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1393653">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1393660" class="blockpost roweven"> <h2><span><span class="conr">#1377</span> <a href="viewtopic.php?pid=1393660#p1393660">2014-03-17 22:39:19</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=80028">trimm</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2014-03-06</span></dd> <dd><span>Posts: 31</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=80028">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>aw wrote:</cite><blockquote><div><div class="quotebox"><cite>trimm wrote:</cite><blockquote><div><p>Another thing though, and its my sound. I gave up on passing through my USB headset(crackling noise) and sharing sound between my host and guest. (I tried following the first post without success)<br />Im thinking I can passthrough my integrated sound on the motherboard, and I tried doing it like this:</p><p>Binding the sound:</p><div class="codebox"><pre><code>vfio-pci 0000:00:1b.0</code></pre></div><p>In my dmesg I get the following: </p><div class="codebox"><pre><code>vfio-pci 0000:00:1b.0: kvm assign device</code></pre></div><p>And in my script I have this:</p><div class="codebox"><pre><code>-device vfio-pci,host=00:1b.0</code></pre></div><p>No errors in Linux, but I get a red mark over my audio icon in Windows. Going into &quot;sound&quot; tab inside audio properties and the whole VM totally freezes.</p><p>I passthroughed with vfio-pci, a drive and my secondary network card without any issues, however I have not had any success with audio.<br />I have also passthroughed my Xbox Controller and Rocksmith USB adapter.</p><p>Any help is appreciated!</p></div></blockquote></div><p>I haven&#039;t had any trouble passing HDA audio from the chipset through to the guest.&#160; I notice a discrepancy in your process though, the string &quot;kvm assign device&quot; is only printed out by virt/kvm/iommu.c:kvm_assign_device() which is only called if using pci-assign instead of vfio-pci.&#160; AFAIK either will work, but I don&#039;t know what to trust in your report...</p></div></blockquote></div><p>You are quite observant aw, I posted my journalctl when I tried pci-assign. <br />This is the message I get when I use vfio-pci: </p><div class="codebox"><pre><code>vfio-pci 0000:00:1b.0: enabling device (0000 -&gt; 0002)</code></pre></div><p>I just tested my VM via Virtual Manager GUI, passed through my audio(0000:00:1b.0) and I got sound working.<br />However the following command is not giving me any audio in Windows. What am I doing wrong? (The last line is my audio..)</p><div class="codebox"><pre><code>sudo -E qemu-system-x86_64 \ -enable-kvm \ -M q35 \ -m 16384 \ -cpu host \ -smp 6,sockets=1,cores=6,threads=1 \ -bios /usr/share/qemu/bios.bin \ -vga none \ -device ioh3420,bus=pcie.0,addr=1c.0,multifunction=on,port=1,chassis=1,id=root.1 \ -device vfio-pci,host=01:00.0,bus=root.1,addr=00.0,multifunction=on,x-vga=on \ -device vfio-pci,host=01:00.1,bus=root.1,addr=00.1 \ -nographic \ -device ahci,bus=pcie.0,id=ahci \ -drive file=/var/lib/libvirt/images/Windows8.1.img,id=disk,format=raw,cache=none \ -device ide-hd,bus=ahci.0,drive=disk \ -device vfio-pci,host=00:19.0,bus=pcie.0 \ -drive file=/dev/sdb1,id=mmo,format=raw,cache=none \ -device ide-hd,bus=ahci.1,drive=mmo \ -drive file=/home/thor/Windows/Windows-Steam.img,id=steam,format=raw,cache=none \ -device ide-hd,bus=ahci.2,drive=steam \ -device vfio-pci,host=00:1b.0</code></pre></div> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1393660">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1393661" class="blockpost rowodd"> <h2><span><span class="conr">#1378</span> <a href="viewtopic.php?pid=1393661#p1393661">2014-03-17 22:43:18</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=75590">aw</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2013-10-04</span></dd> <dd><span>Posts: 921</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=75590">Email</a></span> <span class="website"><a href="http://vfio.blogspot.com/" rel="nofollow">Website</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>trimm wrote:</cite><blockquote><div><div class="codebox"><pre><code>sudo -E qemu-system-x86_64 \ -enable-kvm \ -M q35 \ -m 16384 \ -cpu host \ -smp 6,sockets=1,cores=6,threads=1 \ -bios /usr/share/qemu/bios.bin \ -vga none \ -device ioh3420,bus=pcie.0,addr=1c.0,multifunction=on,port=1,chassis=1,id=root.1 \ -device vfio-pci,host=01:00.0,bus=root.1,addr=00.0,multifunction=on,x-vga=on \ -device vfio-pci,host=01:00.1,bus=root.1,addr=00.1 \ -nographic \ -device ahci,bus=pcie.0,id=ahci \ -drive file=/var/lib/libvirt/images/Windows8.1.img,id=disk,format=raw,cache=none \ -device ide-hd,bus=ahci.0,drive=disk \ -device vfio-pci,host=00:19.0,bus=pcie.0 \ -drive file=/dev/sdb1,id=mmo,format=raw,cache=none \ -device ide-hd,bus=ahci.1,drive=mmo \ -drive file=/home/thor/Windows/Windows-Steam.img,id=steam,format=raw,cache=none \ -device ide-hd,bus=ahci.2,drive=steam \ -device vfio-pci,host=00:1b.0</code></pre></div></div></blockquote></div><p>Why are you passing through both the GPU audio device 1:00.1 and the motherboard device 00:1b.0 if you only plan to use the latter?&#160; Simplify the problem and drop GPU audio.&#160; It&#039;s possible Windows is confused about which device to use.</p> </div> <div class="postsignature postmsg"><hr /><p><a href="http://vfio.blogspot.com" rel="nofollow">http://vfio.blogspot.com</a><br />Looking for a more open forum to discuss vfio related uses?&#160; Try <a href="https://www.redhat.com/mailman/listinfo/vfio-users" rel="nofollow">https://www.redhat.com/mailman/listinfo/vfio-users</a></p></div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1393661">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1393687" class="blockpost roweven"> <h2><span><span class="conr">#1379</span> <a href="viewtopic.php?pid=1393687#p1393687">2014-03-17 23:19:31</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=80028">trimm</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2014-03-06</span></dd> <dd><span>Posts: 31</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=80028">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <p>aw: I just found out the weirdest thing.<br />If I put the audio pass through down at the bottom, it wont work.<br />If I put it right beneath -nographic, it works!</p><p>I cant see the logic, perhaps because of the disks are passed through and it takes too much time or something.</p><p>May be good to know if any of you experience issues with something not working and is in a situation similar to mine.</p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1393687">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1393714" class="blockpost rowodd"> <h2><span><span class="conr">#1380</span> <a href="viewtopic.php?pid=1393714#p1393714">2014-03-18 01:09:31</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=77842">Flyser</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2013-12-19</span></dd> <dd><span>Posts: 29</span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>aw wrote:</cite><blockquote><div><p>I would <strong>strongly</strong> discourage this.&#160; The ROM BAR is entirely emulated to the guest, we enable and read the ROM on the first guest access, from then on the guest only reads from the cached copy.&#160; Any sort of ROM update utility is likely to get very, very confused by this.</p></div></blockquote></div><p>Uhm ... now I am *very* glad, that flashing the bios of my gtx 660 worked <img src="https://bbs.archlinux.org/img/smilies/smile.png" width="15" height="15" alt="smile" /></p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1393714">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1393747" class="blockpost roweven"> <h2><span><span class="conr">#1381</span> <a href="viewtopic.php?pid=1393747#p1393747">2014-03-18 02:53:44</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=75590">aw</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2013-10-04</span></dd> <dd><span>Posts: 921</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=75590">Email</a></span> <span class="website"><a href="http://vfio.blogspot.com/" rel="nofollow">Website</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>Flyser wrote:</cite><blockquote><div><div class="quotebox"><cite>aw wrote:</cite><blockquote><div><p>I would <strong>strongly</strong> discourage this.&#160; The ROM BAR is entirely emulated to the guest, we enable and read the ROM on the first guest access, from then on the guest only reads from the cached copy.&#160; Any sort of ROM update utility is likely to get very, very confused by this.</p></div></blockquote></div><p>Uhm ... now I am *very* glad, that flashing the bios of my gtx 660 worked <img src="https://bbs.archlinux.org/img/smilies/smile.png" width="15" height="15" alt="smile" /></p></div></blockquote></div><p>You people are nuts <img src="https://bbs.archlinux.org/img/smilies/wink.png" width="15" height="15" alt="wink" /></p> </div> <div class="postsignature postmsg"><hr /><p><a href="http://vfio.blogspot.com" rel="nofollow">http://vfio.blogspot.com</a><br />Looking for a more open forum to discuss vfio related uses?&#160; Try <a href="https://www.redhat.com/mailman/listinfo/vfio-users" rel="nofollow">https://www.redhat.com/mailman/listinfo/vfio-users</a></p></div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1393747">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1393757" class="blockpost rowodd"> <h2><span><span class="conr">#1382</span> <a href="viewtopic.php?pid=1393757#p1393757">2014-03-18 03:30:08</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=61335">Jesse2004</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2012-06-25</span></dd> <dd><span>Posts: 9</span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <p>Hi all.</p><p>I have a newbie&#039;s question: why using two scsi-cds in virtio-scsi-pci does not work? </p><p>That is, when using this commandline,</p><p>qemu-system-x86_64&#160; ......&#160; -device virtio-scsi-pci,id=scsi0&#160; \<br />&#160; &#160; &#160; &#160; -drive file=win8.iso,id=cd1&#160; -device scsi-cd,drive=cd1&#160; \<br />&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; -drive file=virtio_driver.iso,id=cd2&#160; -device scsi-cd,drive=cd2</p><p>during windows installation, the drive containing &quot;virtio_driver.iso&quot; will not show up (while on the boot screen, press f12, there are two cdroms there). Why is that? (I&#039;m using qemu 1.7.0 in the official repository and I know using a ide-cd will work, just want to know more about how virtio-scsi-pci works).</p><p>Is there any limitation on the number of device on virto-scsi-pci? These commandlines of virto-scsi-pci are just mysterious to me, can&#039;t find anything about it in the manpage and&#160; `qemu-system-x86_64 -device virtio-scsi-pci,help`&#160; just shows some succinct words. Can anyone please point me to some documentation?</p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1393757">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1393774" class="blockpost roweven"> <h2><span><span class="conr">#1383</span> <a href="viewtopic.php?pid=1393774#p1393774">2014-03-18 05:39:29</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=80333">ahl</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2014-03-16</span></dd> <dd><span>Posts: 20</span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <p>Has anyone managed to get some older Radeon (like HD 3870) to work with Windows? Is there some known reason why only 5000+ Radeons are reported as working? Am I trying to do something hopeless? (If so I&#039;d immediately go buy a new card.)</p><p>I&#039;m getting qemu shutdowns/assertion failures or total host crashes when running Windows 7 guest. Debian guest works fine. I have updated some of my findings on page 55.</p><p>Edit: I just tried WinXP after a while and with radeon module on host loaded. Still getting ATA-errors:</p><div class="codebox"><pre><code>[ 9367.516194] vfio-pci 0000:01:00.0: enabling device (0400 -&gt; 0403) [ 9389.765260] ata2: illegal qc_active transition (0000000f-&gt;93e80875) [ 9389.774688] ata2.00: exception Emask 0x2 SAct 0xf SErr 0x0 action 0x6 frozen [ 9389.774695] ata2.00: failed command: READ FPDMA QUEUED [ 9389.774704] ata2.00: cmd 60/10:00:80:b3:08/00:00:fa:00:00/40 tag 0 ncq 8192 in res 40/00:18:a8:b4:08/00:00:fa:00:00/40 Emask 0x2 (HSM violation) [ 9389.774707] ata2.00: status: { DRDY }</code></pre></div><p>I have seen identical messages with Win 7 too. This time I managed to kill qemu myself. It seems those errors might go away if launching from console without graphics, but it won&#039;t improve anything...</p> <p class="postedit"><em>Last edited by ahl (2014-03-18 06:23:17)</em></p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1393774">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1393810" class="blockpost rowodd"> <h2><span><span class="conr">#1384</span> <a href="viewtopic.php?pid=1393810#p1393810">2014-03-18 09:37:30</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=80279">novist</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2014-03-14</span></dd> <dd><span>Posts: 34</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=80279">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <p>heads-up: 3.14 rc7 is out. There is some stuff we might find interesting:<br /><a href="https://www.kernel.org/diff/diffview.cgi?file=%2Fpub%2Flinux%2Fkernel%2Fv3.x%2Ftesting%2Fpatch-3.14-rc7.xz;z=2534" rel="nofollow">https://www.kernel.org/diff/diffview.cg … .xz;z=2534</a><br /><a href="https://www.kernel.org/diff/diffview.cgi?file=%2Fpub%2Flinux%2Fkernel%2Fv3.x%2Ftesting%2Fpatch-3.14-rc7.xz;z=2539" rel="nofollow">https://www.kernel.org/diff/diffview.cg … .xz;z=2539</a><br /><a href="https://www.kernel.org/diff/diffview.cgi?file=%2Fpub%2Flinux%2Fkernel%2Fv3.x%2Ftesting%2Fpatch-3.14-rc7.xz;z=2540" rel="nofollow">https://www.kernel.org/diff/diffview.cg … .xz;z=2540</a><br /><a href="https://www.kernel.org/diff/diffview.cgi?file=%2Fpub%2Flinux%2Fkernel%2Fv3.x%2Ftesting%2Fpatch-3.14-rc7.xz;z=2541" rel="nofollow">https://www.kernel.org/diff/diffview.cg … .xz;z=2541</a></p><p>Will be testing later today.</p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1393810">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1393820" class="blockpost roweven"> <h2><span><span class="conr">#1385</span> <a href="viewtopic.php?pid=1393820#p1393820">2014-03-18 10:24:16</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=79757">fukhda</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2014-02-24</span></dd> <dd><span>Posts: 2</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=79757">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <p>Hi all,</p><p>Good news here, a success VGA passthrough in Fedora 20. In <a href="https://bbs.archlinux.org/viewtopic.php?pid=1393256#p1393256" rel="nofollow"> my very first post </a>, I swamped in code 12 issue. Finally it is solved. Le tme explain the process in the below.</p><ol class="decimal"><li><p>When the assigned AMD card and QXL vga card coexists in VM (Win7x32), there would be a conflict causing AMD card a code12. (AMD driver to be installed here)</p></li><li><p>By removing the QXL vga (add the swithc -vga none in the script launching VM), there would be a black screen in QEMU window.</p></li><li><p>Attach another monitor to the AMD card, the VM Win7 is succesfully displayed.</p></li><li><p>Pass through (via vfio) a Renesas USB3.0 Controller with Keyboard/mouse connected, otherwise we can not operate VM. (Renesas driver to be installed here)</p></li><li><p>Check the device manager for AMD card, no more code 12. Now, enjoy the VGA passthrough.</p></li></ol><p>Passthrough NVIDIA EGVA GTX650 works too. Thanks for everyone, and especially for nbhs.</p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1393820">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1393822" class="blockpost rowodd"> <h2><span><span class="conr">#1386</span> <a href="viewtopic.php?pid=1393822#p1393822">2014-03-18 10:49:36</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=80279">novist</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2014-03-14</span></dd> <dd><span>Posts: 34</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=80279">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>fukhda wrote:</cite><blockquote><div><p>Hi all,</p><p>Good news here, a success VGA passthrough in Fedora 20. In <a href="https://bbs.archlinux.org/viewtopic.php?pid=1393256#p1393256" rel="nofollow"> my very first post </a>, I swamped in code 12 issue. Finally it is solved. Le tme explain the process in the below.</p><ol class="decimal"><li><p>When the assigned AMD card and QXL vga card coexists in VM (Win7x32), there would be a conflict causing AMD card a code12. (AMD driver to be installed here)</p></li><li><p>By removing the QXL vga (add the swithc -vga none in the script launching VM), there would be a black screen in QEMU window.</p></li><li><p>Attach another monitor to the AMD card, the VM Win7 is succesfully displayed.</p></li><li><p>Pass through (via vfio) a Renesas USB3.0 Controller with Keyboard/mouse connected, otherwise we can not operate VM. (Renesas driver to be installed here)</p></li><li><p>Check the device manager for AMD card, no more code 12. Now, enjoy the VGA passthrough.</p></li></ol><p>Passthrough NVIDIA EGVA GTX650 works too. Thanks for everyone, and especially for nbhs.</p></div></blockquote></div><p>oh you tried emulated vga adapter side by side with dedicated gpu.. interesting. i tried that too and with stock qemu from repositories i also had some error code in task manager. not sure if it was 12. after i compiled qemu from git repo that code was gone (this is still with -vga std -sdl). then qemu window displays everything just fine and dedicated gpu appears to be fine. however i was not able to run anything with full 3d acceleration. not that i tried much anyway. idk how useful this info could be to you... but yeah for full 3d acceleration i have to use -vga none and control VM with keyboard/mouse plugged into passed-through usb port just like you said.</p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1393822">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1393829" class="blockpost roweven"> <h2><span><span class="conr">#1387</span> <a href="viewtopic.php?pid=1393829#p1393829">2014-03-18 11:05:50</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=77904">rawuza</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2013-12-22</span></dd> <dd><span>Posts: 7</span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>ahl wrote:</cite><blockquote><div><p>Has anyone managed to get some older Radeon (like HD 3870) to work with Windows? Is there some known reason why only 5000+ Radeons are reported as working? Am I trying to do something hopeless? (If so I&#039;d immediately go buy a new card.)</p><p>I&#039;m getting qemu shutdowns/assertion failures or total host crashes when running Windows 7 guest. Debian guest works fine. I have updated some of my findings on page 55.</p><p>Edit: I just tried WinXP after a while and with radeon module on host loaded. Still getting ATA-errors:</p></div></blockquote></div><p>I have similar problems with a HD 5770, even though I&#039;ve found reports of this card working. See <a href="https://bbs.archlinux.org/viewtopic.php?pid=1391318#p1391318" rel="nofollow">https://bbs.archlinux.org/viewtopic.php … 8#p1391318</a>.&#160; For what it&#039;s worth, I don&#039;t think it&#039;s a problem with the ATA controller, per se, since I get errors with other PCI devices as well. It seems to be pretty random, which one is affected.</p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1393829">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1393838" class="blockpost rowodd"> <h2><span><span class="conr">#1388</span> <a href="viewtopic.php?pid=1393838#p1393838">2014-03-18 12:10:44</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=79578">AKSN74</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd class="postavatar"><img src="https://bbs.archlinux.org/img/avatars/79578.jpg?m=1423108340" width="80" height="80" alt="" /></dd> <dd><span>From: Taichung, Taiwan</span></dd> <dd><span>Registered: 2014-02-18</span></dd> <dd><span>Posts: 52</span></dd> <dd class="usercontacts"><span class="email"><a href="mailto:missile0407@gmail.com">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <p>After some tests in these days, I found that I can&#039;t use the same card between Host and Guest.</p><p>I re-installed Ubuntu for zero start, and following steps that I done before.&#160; I just plug 2 x GTX480 on my motherboard and want to pass-through one of GTX480 into VM.</p><p>According the 1st post guide, I didn&#039;t write blacklist for Nouveau, and using pci-stub to do this. Write GTX480&#039;s HID into grub.<br />And then, doing the Systemd service, write pci number into /etc/vfio-pci.cfg, then reboot.</p><p>But when I rebooted, my screen turned to 1280X1024, and check dmesg, there is nothing about pci-stub worked log. But I still bind 2nd GTX480 into VFIO.<br />And when I tried to start VM, It gets error say that GTX480 can&#039;t initialze.</p><p>Looks like it&#039;s impossible that make the same product for host and guest, you need to use different product (Ex. GTX480 for Host, and GTX470 for Guest.)<br />Is that correct? Or where I do wrong?</p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1393838">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1393845" class="blockpost roweven"> <h2><span><span class="conr">#1389</span> <a href="viewtopic.php?pid=1393845#p1393845">2014-03-18 12:53:13</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=76479">Norcoen</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>From: Norway</span></dd> <dd><span>Registered: 2013-11-02</span></dd> <dd><span>Posts: 23</span></dd> <dd class="usercontacts"><span class="email"><a href="mailto:frankmoll@gmx.net">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <p>Did anyone succeed using this with the Virtual Machine Managers (<a href="http://virt-manager.org/" rel="nofollow">http://virt-manager.org/</a>) XML-like configuration and could post it as an example?</p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1393845">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1393865" class="blockpost rowodd"> <h2><span><span class="conr">#1390</span> <a href="viewtopic.php?pid=1393865#p1393865">2014-03-18 13:29:30</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=78143">Blind Tree Frog</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2013-12-31</span></dd> <dd><span>Posts: 27</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=78143">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>AKSN74 wrote:</cite><blockquote><div><p>After some tests in these days, I found that I can&#039;t use the same card between Host and Guest.</p><p>I re-installed Ubuntu for zero start, and following steps that I done before.&#160; I just plug 2 x GTX480 on my motherboard and want to pass-through one of GTX480 into VM.</p><p>According the 1st post guide, I didn&#039;t write blacklist for Nouveau, and using pci-stub to do this. Write GTX480&#039;s HID into grub.<br />And then, doing the Systemd service, write pci number into /etc/vfio-pci.cfg, then reboot.</p><p>But when I rebooted, my screen turned to 1280X1024, and check dmesg, there is nothing about pci-stub worked log. But I still bind 2nd GTX480 into VFIO.<br />And when I tried to start VM, It gets error say that GTX480 can&#039;t initialze.</p><p>Looks like it&#039;s impossible that make the same product for host and guest, you need to use different product (Ex. GTX480 for Host, and GTX470 for Guest.)<br />Is that correct? Or where I do wrong?</p></div></blockquote></div><p>I&#039;ve got to double check my notes (read as, redo everything anyhow), but I couldn&#039;t seem to get pci-stub to prevent anything from being loaded.&#160; If I wanted to block my video card I had to blacklist it.&#160; &#160;I fear that when I built my kernel I might not have had pci-assign built in and wonder if I also didn&#039;t include pci-stub correctly.</p><p>I&#039;m pretty sure the first post uses two matching cards though.</p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1393865">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1393878" class="blockpost roweven"> <h2><span><span class="conr">#1391</span> <a href="viewtopic.php?pid=1393878#p1393878">2014-03-18 14:00:26</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=79471">Bronek</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>From: London</span></dd> <dd><span>Registered: 2014-02-14</span></dd> <dd><span>Posts: 90</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=79471">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>Blind Tree Frog wrote:</cite><blockquote><div><div class="quotebox"><cite>AKSN74 wrote:</cite><blockquote><div><p>After some tests in these days, I found that I can&#039;t use the same card between Host and Guest.</p><p>I re-installed Ubuntu for zero start, and following steps that I done before.&#160; I just plug 2 x GTX480 on my motherboard and want to pass-through one of GTX480 into VM.</p><p>According the 1st post guide, I didn&#039;t write blacklist for Nouveau, and using pci-stub to do this. Write GTX480&#039;s HID into grub.<br />And then, doing the Systemd service, write pci number into /etc/vfio-pci.cfg, then reboot.</p><p>But when I rebooted, my screen turned to 1280X1024, and check dmesg, there is nothing about pci-stub worked log. But I still bind 2nd GTX480 into VFIO.<br />And when I tried to start VM, It gets error say that GTX480 can&#039;t initialze.</p><p>Looks like it&#039;s impossible that make the same product for host and guest, you need to use different product (Ex. GTX480 for Host, and GTX470 for Guest.)<br />Is that correct? Or where I do wrong?</p></div></blockquote></div><p>I&#039;ve got to double check my notes (read as, redo everything anyhow), but I couldn&#039;t seem to get pci-stub to prevent anything from being loaded.&#160; If I wanted to block my video card I had to blacklist it.&#160; &#160;I fear that when I built my kernel I might not have had pci-assign built in and wonder if I also didn&#039;t include pci-stub correctly.</p><p>I&#039;m pretty sure the first post uses two matching cards though.</p></div></blockquote></div><p>This might be a matter of driver ordering. If pci-stub is not loaded before your GPU driver, it will not be able to bind to GPU card because GPU driver would have grabbed them both already. To ensure that pci-stub is loaded first you can build it with kernel i.e. CONFIG_PCI_STUB=y (whilst ensuring that GPU driver is just a regular module) or, if using it as a module, use <a href="http://manpages.ubuntu.com/manpages/precise/en/man5/modprobe.conf.5.html" rel="nofollow">softdep command line option</a> to enforce driver ordering.</p><p>Alternatively you might let the driver grab any GPU it wants, but then unbind it before starting qemu, and bind to vfio-pci . The risk here is that the driver might not do it cleanly or that GPU might not reset its state, but I have no experience with nvidia/nouveau drivers.</p><p>Another gotcha is order of cards in PCI, since your computer&#039;s own BIOS will grab primary card, and then pass it to kernel as VESA frame buffer. It should be still possible to unbind it before starting qemu, though.</p><p>Personally I would build kernel with pci-stub, ensure that the GPU passed to pci-stub in kernel parameters is <em>not</em> the primary one, and use that for qemu, because maintaining such setup would probably require the smallest amount of work. Also, you might just blacklist GPU drivers if you actually do not use those on the host.</p> </div> <div class="postsignature postmsg"><hr /><p>Sorry about&#160; &quot;KVM VGA-Passthrough ...&quot; thread <img src="https://bbs.archlinux.org/img/smilies/sad.png" width="15" height="15" alt="sad" /> Anyone interested in continuing this discussion elsewhere, please contact me privately. I might be able to find it a new home.</p></div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1393878">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1393883" class="blockpost rowodd"> <h2><span><span class="conr">#1392</span> <a href="viewtopic.php?pid=1393883#p1393883">2014-03-18 14:10:47</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=78143">Blind Tree Frog</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2013-12-31</span></dd> <dd><span>Posts: 27</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=78143">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>Bronek wrote:</cite><blockquote><div><div class="quotebox"><cite>Blind Tree Frog wrote:</cite><blockquote><div><div class="quotebox"><cite>AKSN74 wrote:</cite><blockquote><div><p>Looks like it&#039;s impossible that make the same product for host and guest, you need to use different product (Ex. GTX480 for Host, and GTX470 for Guest.)<br />Is that correct? Or where I do wrong?</p></div></blockquote></div><p>I&#039;ve got to double check my notes (read as, redo everything anyhow), but I couldn&#039;t seem to get pci-stub to prevent anything from being loaded.&#160; If I wanted to block my video card I had to blacklist it.&#160; &#160;I fear that when I built my kernel I might not have had pci-assign built in and wonder if I also didn&#039;t include pci-stub correctly.</p><p>I&#039;m pretty sure the first post uses two matching cards though.</p></div></blockquote></div><p>This might be a matter of driver ordering. If pci-stub is not loaded before your GPU driver, it will not be able to bind to GPU card because GPU driver would have grabbed them both already. To ensure that pci-stub is loaded first you can build it with kernel i.e. CONFIG_PCI_STUB=y (whilst ensuring that GPU driver is just a regular module) or, if using it as a module, use <a href="http://manpages.ubuntu.com/manpages/precise/en/man5/modprobe.conf.5.html" rel="nofollow">softdep command line option</a> to enforce driver ordering.</p><p>Alternatively you might let the driver grab any GPU it wants, but then unbind it before starting qemu, and bind to vfio-pci . The risk here is that the driver might not do it cleanly or that GPU might not reset its state, but I have no experience with nvidia/nouveau drivers.</p><p>Another gotcha is order of cards in PCI, since your computer&#039;s own BIOS will grab primary card, and then pass it to kernel as VESA frame buffer. It should be still possible to unbind it before starting qemu, though.</p><p>Personally I would build kernel with pci-stub, ensure that the GPU passed to pci-stub in kernel parameters is <em>not</em> the primary one, and use that for qemu, because maintaining such setup would probably require the smallest amount of work. Also, you might just blacklist GPU drivers if you actually do not use those on the host.</p></div></blockquote></div><p>That might be the case, except the script in the first post does unbind first (if I am reading it correctly) and it was hanging on my video card when it ran (without the driver being blacklisted).&#160; Whether or not pci-stub was grabbing the USB devices I don&#039;t know, but the posted script was unbinding them as expected (Confirmed when I redid my boot line and forgot to disable the service only to boot to a system without a working mouse/keyboard).</p><p>Regardless, I may have not done the best kernel config when I built mine.&#160; Blacklisting definitely works and pci-stub is still magic to me.&#160; And none of this conversation is probably of much use to AKSN74</p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1393883">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1393891" class="blockpost roweven"> <h2><span><span class="conr">#1393</span> <a href="viewtopic.php?pid=1393891#p1393891">2014-03-18 14:29:24</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=75076">SpacePirate</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2013-09-16</span></dd> <dd><span>Posts: 55</span></dd> <dd class="usercontacts"><span class="email"><a href="mailto:hiduei@gmx.de">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>trimm wrote:</cite><blockquote><div><p>I cant for the life of me sort out my audio for my VM.</p><p>I use this:</p><div class="codebox"><pre><code>-device ich9-intel-hda,bus=pcie.0,addr=1b.0,id=sound0 \ -device hda-duplex,id=sound0-codec0,bus=sound0.0,cad=0 </code></pre></div><p>I have also tried with -soundhw all and -soundhw ac97.</p><p>This is what I get when I fire up the computer:</p><div class="codebox"><pre><code>pulseaudio: pa_context_connect() failed pulseaudio: Reason: Connection refused pulseaudio: Failed to initialize PA contextaudio: Could not init `pa&#039; audio driver ALSA lib pcm_dmix.c:1022:(snd_pcm_dmix_open) unable to open slave alsa: Could not initialize DAC alsa: Failed to open `default&#039;: alsa: Reason: No such file or directory ALSA lib pcm_dmix.c:1022:(snd_pcm_dmix_open) unable to open slave alsa: Could not initialize DAC alsa: Failed to open `default&#039;: alsa: Reason: No such file or directory audio: Failed to create voice `dac&#039; ALSA lib pcm_dsnoop.c:618:(snd_pcm_dsnoop_open) unable to open slave alsa: Could not initialize ADC alsa: Failed to open `default&#039;: alsa: Reason: No such file or directory ALSA lib pcm_dsnoop.c:618:(snd_pcm_dsnoop_open) unable to open slave alsa: Could not initialize ADC alsa: Failed to open `default&#039;: alsa: Reason: No such file or directory audio: Failed to create voice `adc&#039;</code></pre></div><p>In the first post its stated that I may have to use the QEMU_AUDIO_DRV variable. I have tried this (export QEMU_AUDIO_DRV=alsa and QEMU_AUDIO_DRV=pa as root) without success. Anyone in the same boat as me, and/or found a solution?(except passing a USB headset? <img src="https://bbs.archlinux.org/img/smilies/smile.png" width="15" height="15" alt="smile" />)</p><p>Update: I managed to get audio somewhat working:</p><p>I use sudo -E export QEMU_ALSA_DAC_BUFFER_SIZE=512 QEMU_ALSA_DAC_PERIOD_SIZE=170 QEMU_AUDIO_DRV=alsa <br />and<br />sudo -E qemu-system-x86_64 ....<br />The -E option tries to preserve the environment even though you are running with sudo.</p><p>However the audio is crackling and sounding really disorted... <img src="https://bbs.archlinux.org/img/smilies/hmm.png" width="15" height="15" alt="hmm" /></p></div></blockquote></div><p>I experience the exact same behaviour on my machine. Its working now with ALSA but the quality isnt good. Has anyone fixed this issue or got it working with Pulse Audio (which I would prefer)</p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1393891">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1393911" class="blockpost rowodd"> <h2><span><span class="conr">#1394</span> <a href="viewtopic.php?pid=1393911#p1393911">2014-03-18 15:07:53</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=79578">AKSN74</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd class="postavatar"><img src="https://bbs.archlinux.org/img/avatars/79578.jpg?m=1423108340" width="80" height="80" alt="" /></dd> <dd><span>From: Taichung, Taiwan</span></dd> <dd><span>Registered: 2014-02-18</span></dd> <dd><span>Posts: 52</span></dd> <dd class="usercontacts"><span class="email"><a href="mailto:missile0407@gmail.com">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>Bronek wrote:</cite><blockquote><div><div class="quotebox"><cite>Blind Tree Frog wrote:</cite><blockquote><div><div class="quotebox"><cite>AKSN74 wrote:</cite><blockquote><div><p>After some tests in these days, I found that I can&#039;t use the same card between Host and Guest.</p><p>I re-installed Ubuntu for zero start, and following steps that I done before.&#160; I just plug 2 x GTX480 on my motherboard and want to pass-through one of GTX480 into VM.</p><p>According the 1st post guide, I didn&#039;t write blacklist for Nouveau, and using pci-stub to do this. Write GTX480&#039;s HID into grub.<br />And then, doing the Systemd service, write pci number into /etc/vfio-pci.cfg, then reboot.</p><p>But when I rebooted, my screen turned to 1280X1024, and check dmesg, there is nothing about pci-stub worked log. But I still bind 2nd GTX480 into VFIO.<br />And when I tried to start VM, It gets error say that GTX480 can&#039;t initialze.</p><p>Looks like it&#039;s impossible that make the same product for host and guest, you need to use different product (Ex. GTX480 for Host, and GTX470 for Guest.)<br />Is that correct? Or where I do wrong?</p></div></blockquote></div><p>I&#039;ve got to double check my notes (read as, redo everything anyhow), but I couldn&#039;t seem to get pci-stub to prevent anything from being loaded.&#160; If I wanted to block my video card I had to blacklist it.&#160; &#160;I fear that when I built my kernel I might not have had pci-assign built in and wonder if I also didn&#039;t include pci-stub correctly.</p><p>I&#039;m pretty sure the first post uses two matching cards though.</p></div></blockquote></div><p>This might be a matter of driver ordering. If pci-stub is not loaded before your GPU driver, it will not be able to bind to GPU card because GPU driver would have grabbed them both already. To ensure that pci-stub is loaded first you can build it with kernel i.e. CONFIG_PCI_STUB=y (whilst ensuring that GPU driver is just a regular module) or, if using it as a module, use <a href="http://manpages.ubuntu.com/manpages/precise/en/man5/modprobe.conf.5.html" rel="nofollow">softdep command line option</a> to enforce driver ordering.</p><p>Alternatively you might let the driver grab any GPU it wants, but then unbind it before starting qemu, and bind to vfio-pci . The risk here is that the driver might not do it cleanly or that GPU might not reset its state, but I have no experience with nvidia/nouveau drivers.</p><p>Another gotcha is order of cards in PCI, since your computer&#039;s own BIOS will grab primary card, and then pass it to kernel as VESA frame buffer. It should be still possible to unbind it before starting qemu, though.</p><p>Personally I would build kernel with pci-stub, ensure that the GPU passed to pci-stub in kernel parameters is <em>not</em> the primary one, and use that for qemu, because maintaining such setup would probably require the smallest amount of work. Also, you might just blacklist GPU drivers if you actually do not use those on the host.</p></div></blockquote></div><p>Hmm... that&#039;s interesting, I&#039;m still a Linux newbie so these settings to me may can&#039;t understand. But</p><p>I saw the usage about softdep, maybe this is a best choice to replace the grub function. Only a problem is can softdep support pci-stub command (like echo 0000:02:00.0 &gt; /sys/bus/pci/devices/0000:02:00.0/driver/unbind)</p><p>Because if I use grub, it will according from HID, that means both of GTX480 will bind into pci-stub and host will not have any GPU to display.</p><p>So my idea is, if I can bind 2nd GTX480 at first, then Nouveru will not attach 2nd GTX480. After that everything will be easy.</p><p>Is that possible?</p> <p class="postedit"><em>Last edited by AKSN74 (2014-03-18 15:09:05)</em></p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1393911">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1393933" class="blockpost roweven"> <h2><span><span class="conr">#1395</span> <a href="viewtopic.php?pid=1393933#p1393933">2014-03-18 16:26:07</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=79471">Bronek</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>From: London</span></dd> <dd><span>Registered: 2014-02-14</span></dd> <dd><span>Posts: 90</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=79471">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>AKSN74 wrote:</cite><blockquote><div><div class="quotebox"><cite>Bronek wrote:</cite><blockquote><div><p>This might be a matter of driver ordering. If pci-stub is not loaded before your GPU driver, it will not be able to bind to GPU card because GPU driver would have grabbed them both already. To ensure that pci-stub is loaded first you can build it with kernel i.e. CONFIG_PCI_STUB=y (whilst ensuring that GPU driver is just a regular module) or, if using it as a module, use <a href="http://manpages.ubuntu.com/manpages/precise/en/man5/modprobe.conf.5.html" rel="nofollow">softdep command line option</a> to enforce driver ordering.</p><p>Alternatively you might let the driver grab any GPU it wants, but then unbind it before starting qemu, and bind to vfio-pci . The risk here is that the driver might not do it cleanly or that GPU might not reset its state, but I have no experience with nvidia/nouveau drivers.</p><p>Another gotcha is order of cards in PCI, since your computer&#039;s own BIOS will grab primary card, and then pass it to kernel as VESA frame buffer. It should be still possible to unbind it before starting qemu, though.</p><p>Personally I would build kernel with pci-stub, ensure that the GPU passed to pci-stub in kernel parameters is <em>not</em> the primary one, and use that for qemu, because maintaining such setup would probably require the smallest amount of work. Also, you might just blacklist GPU drivers if you actually do not use those on the host.</p></div></blockquote></div><p>Hmm... that&#039;s interesting, I&#039;m still a Linux newbie so these settings to me may can&#039;t understand. But</p><p>I saw the usage about softdep, maybe this is a best choice to replace the grub function. Only a problem is can softdep support pci-stub command (like echo 0000:02:00.0 &gt; /sys/bus/pci/devices/0000:02:00.0/driver/unbind)</p><p>Because if I use grub, it will according from HID, that means both of GTX480 will bind into pci-stub and host will not have any GPU to display.</p><p>So my idea is, if I can bind 2nd GTX480 at first, then Nouveru will not attach 2nd GTX480. After that everything will be easy.</p><p>Is that possible?</p></div></blockquote></div><p>The point of softdep is that it just orders the drivers, so you can have both pci-stub and your regular GPU drivers. You order it such as to load GPU driver <em>second</em> because they are &quot;greedy&quot; (like all other drivers) and will grab all matching devices, thus preventing pci-stub from doing its work. So, you understand it right : set softdep to ensure pci-stub &quot;grabs&quot; 2nd GFX480 first, and if Nouveau is loaded after this, it will not use this card. It might be easier to build kernel with CONFIG_PCI_STUB=y (but without Nouveau) in which case pci_stub will be guaranteed to be loaded first without use of softdep.</p><p>See also <a href="https://bbs.archlinux.org/viewtopic.php?pid=1278536#p1278536" rel="nofollow">post #93</a>, using modprobe/*conf rather than kernel command line parameter . I am not sure which one is better.</p> </div> <div class="postsignature postmsg"><hr /><p>Sorry about&#160; &quot;KVM VGA-Passthrough ...&quot; thread <img src="https://bbs.archlinux.org/img/smilies/sad.png" width="15" height="15" alt="sad" /> Anyone interested in continuing this discussion elsewhere, please contact me privately. I might be able to find it a new home.</p></div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1393933">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1394146" class="blockpost rowodd"> <h2><span><span class="conr">#1396</span> <a href="viewtopic.php?pid=1394146#p1394146">2014-03-18 23:57:09</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=79578">AKSN74</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd class="postavatar"><img src="https://bbs.archlinux.org/img/avatars/79578.jpg?m=1423108340" width="80" height="80" alt="" /></dd> <dd><span>From: Taichung, Taiwan</span></dd> <dd><span>Registered: 2014-02-18</span></dd> <dd><span>Posts: 52</span></dd> <dd class="usercontacts"><span class="email"><a href="mailto:missile0407@gmail.com">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>Bronek wrote:</cite><blockquote><div><p>The point of softdep is that it just orders the drivers, so you can have both pci-stub and your regular GPU drivers. You order it such as to load GPU driver <em>second</em> because they are &quot;greedy&quot; (like all other drivers) and will grab all matching devices, thus preventing pci-stub from doing its work. So, you understand it right : set softdep to ensure pci-stub &quot;grabs&quot; 2nd GFX480 first, and if Nouveau is loaded after this, it will not use this card. It might be easier to build kernel with CONFIG_PCI_STUB=y (but without Nouveau) in which case pci_stub will be guaranteed to be loaded first without use of softdep.</p><p>See also <a href="https://bbs.archlinux.org/viewtopic.php?pid=1278536#p1278536" rel="nofollow">post #93</a>, using modprobe/*conf rather than kernel command line parameter . I am not sure which one is better.</p></div></blockquote></div><p>Thanks for your hint, now I know how to do. </p><p>I thought that it still a big challenge to do my build, because HID is a big problem, I need to do pci-stub command after pci-stub load up and Nouveau not load up yet.</p><p>I&#039;m thought about rc.local to do this (because GRUB can&#039;t do bash code) , but I found some information, rc.local launched after driver loaded so it&#039;s not an option.</p><p>Although I can&#039;t use both GTX480 for host and guest, I still can pass-through them into VM with softdep.</p><p>I&#039;ll try for this, and hope it work, thanks for your help.</p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1394146">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1394286" class="blockpost roweven"> <h2><span><span class="conr">#1397</span> <a href="viewtopic.php?pid=1394286#p1394286">2014-03-19 11:05:39</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=80279">novist</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2014-03-14</span></dd> <dd><span>Posts: 34</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=80279">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <p>I tested 3.14-rc7 kernel. Everything works good. There is even performance increase for that passmark directx9 complex test. rc6 - 16 FPS, rc7 - 21 FPS.</p><p>P.S. In case noone noticed dr6 patch is already upstream this no longer needed. Adding my compilation of patches should anyone need. Usage - extract them to parent dir of kernel source code and from kernel source code dir run ../patch_kernel.sh</p><p><a href="http://paste2box.com/5/#/3422361273/PsZOuHK1hX3ih-vnpz6BL-7cD-te4xbumcR3LymCvqE/patches.tar.gz" rel="nofollow">http://paste2box.com/5/#/3422361273/PsZ … hes.tar.gz</a></p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1394286">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1394510" class="blockpost rowodd"> <h2><span><span class="conr">#1398</span> <a href="viewtopic.php?pid=1394510#p1394510">2014-03-19 19:21:55</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=48315">TripleSpeeder</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2011-05-02</span></dd> <dd><span>Posts: 43</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=48315">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>Norcoen wrote:</cite><blockquote><div><p>Did anyone succeed using this with the Virtual Machine Managers (<a href="http://virt-manager.org/" rel="nofollow">http://virt-manager.org/</a>) XML-like configuration and could post it as an example?</p></div></blockquote></div><p>I am trying to, but no success so far, see <a href="https://bbs.archlinux.org/viewtopic.php?pid=1393384#p1393384" rel="nofollow">my post</a>. <br />But it seems some people got it to work: <a href="https://bbs.archlinux.org/viewtopic.php?pid=1349595#p1349595" rel="nofollow">Val532</a>, <a href="https://bbs.archlinux.org/viewtopic.php?pid=1343400#p1343400" rel="nofollow">kaeptnb</a></p><p>PS: This thread is at the same time a goldmine and a total mess :-D</p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1394510">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1394543" class="blockpost roweven"> <h2><span><span class="conr">#1399</span> <a href="viewtopic.php?pid=1394543#p1394543">2014-03-19 20:32:19</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=80333">ahl</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2014-03-16</span></dd> <dd><span>Posts: 20</span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>rawuza wrote:</cite><blockquote><div><div class="quotebox"><cite>ahl wrote:</cite><blockquote><div><p>I&#039;m getting qemu shutdowns/assertion failures or total host crashes when running Windows 7 guest. Debian guest works fine. I have updated some of my findings on page 55.</p><p>Edit: I just tried WinXP after a while and with radeon module on host loaded. Still getting ATA-errors:</p></div></blockquote></div><p>I have similar problems with a HD 5770, even though I&#039;ve found reports of this card working. See <a href="https://bbs.archlinux.org/viewtopic.php?pid=1391318#p1391318" rel="nofollow">https://bbs.archlinux.org/viewtopic.php … 8#p1391318</a>.&#160; For what it&#039;s worth, I don&#039;t think it&#039;s a problem with the ATA controller, per se, since I get errors with other PCI devices as well. It seems to be pretty random, which one is affected.</p></div></blockquote></div><p>You are right. The behavior is pretty random. Here&#039;s an incomplete list of problems that I remember occurring: ATA-errors on all connected devices, single port usb failures, full failure of all usb-devices, display port link failure (loss of picture), complete freeze of system, freeze + automatic reboot, and failure of SATA controller with IO_PAGE_FAULTS that resulted in corrupted root file system. Just about anything can happen.</p><p>So I replaced my HD 3870 with a HD 6670. Nothing changed. Random errors continued. I wonder if HD 6670 is broken too?</p><p>Next I tried physically using different slots for all cards. Nothing changed.</p><p>And then I finally made some progress:<br /><strong>Removal of the cheap PCI-E network interface cards that I had on host resulted in tremendous improvement on system stability!</strong> Win 7 started working seemingly perfectly. I got graphics working for the first time and was able to run the system benchmark with good results.</p><p>For a while I thought it fixed everything, but on about 10th identical(snapshot=on) reboot of Windows 7 guest, I got some minor ATA errors on host again. However, all of the other randomness is gone. I wonder if the SATA controller is bad too (AMD A85X FCH)?</p><p>Next I tried WinXP. It seems to be much harder to boot than Win 7. It took a while and a whole lot of minor ATA errors until it finished. But it booted! So for the first time I also got WinXP running. Then I noticed a connection between qemu and those ATA errors: If I run qemu with snapshot=on I only get READ errors. Without snapshot I also get WRITE errors. So I moved WinXP completely in ramdisk and booted it: The exact same snapshot of WinXP that took a long time to boot from disk, now booted in just a few seconds. All of the ATA errors were gone too! Makes sense.</p><p>Any hints on what to try next? (I set my SATA controller to IDE mode now for testing. It used to be AHCI.)</p><p>Edit: By the way I wouldn&#039;t be surprised if a lot of people had this problem I have now. It could easily go unnoticed with Win 7. Also my HD is pretty slow, which could increase the chance of errors.</p><div class="codebox"><pre class="vscroll"><code>### Group 0 ### 00:00.0 Host bridge: Advanced Micro Devices, Inc. [AMD] Family 15h (Models 10h-1fh) Processor Root Complex ### Group 1 ### 00:01.0 VGA compatible controller: Advanced Micro Devices, Inc. [AMD/ATI] Trinity [Radeon HD 7660D] 00:01.1 Audio device: Advanced Micro Devices, Inc. [AMD/ATI] Trinity HDMI Audio Controller ### Group 2 ### 00:03.0 PCI bridge: Advanced Micro Devices, Inc. [AMD] Family 15h (Models 10h-1fh) Processor Root Port 01:00.0 VGA compatible controller: Advanced Micro Devices, Inc. [AMD/ATI] Turks XT [Radeon HD 6670/7670] 01:00.1 Audio device: Advanced Micro Devices, Inc. [AMD/ATI] Turks/Whistler HDMI Audio [Radeon HD 6000 Series] ### Group 3 ### 00:10.0 USB controller: Advanced Micro Devices, Inc. [AMD] FCH USB XHCI Controller (rev 03) 00:10.1 USB controller: Advanced Micro Devices, Inc. [AMD] FCH USB XHCI Controller (rev 03) ### Group 4 ### 00:11.0 SATA controller: Advanced Micro Devices, Inc. [AMD] FCH SATA Controller [IDE mode] (rev 40) ### Group 5 ### 00:12.0 USB controller: Advanced Micro Devices, Inc. [AMD] FCH USB OHCI Controller (rev 11) 00:12.2 USB controller: Advanced Micro Devices, Inc. [AMD] FCH USB EHCI Controller (rev 11) ### Group 6 ### 00:13.0 USB controller: Advanced Micro Devices, Inc. [AMD] FCH USB OHCI Controller (rev 11) 00:13.2 USB controller: Advanced Micro Devices, Inc. [AMD] FCH USB EHCI Controller (rev 11) ### Group 7 ### 00:14.0 SMBus: Advanced Micro Devices, Inc. [AMD] FCH SMBus Controller (rev 14) 00:14.1 IDE interface: Advanced Micro Devices, Inc. [AMD] FCH IDE Controller (rev 40) 00:14.3 ISA bridge: Advanced Micro Devices, Inc. [AMD] FCH LPC Bridge (rev 11) 00:14.4 PCI bridge: Advanced Micro Devices, Inc. [AMD] FCH PCI Bridge (rev 40) ### Group 8 ### 00:15.0 PCI bridge: Advanced Micro Devices, Inc. [AMD] Hudson PCI to PCI bridge (PCIE port 0) 00:15.1 PCI bridge: Advanced Micro Devices, Inc. [AMD] Hudson PCI to PCI bridge (PCIE port 1) 00:15.2 PCI bridge: Advanced Micro Devices, Inc. [AMD] Hudson PCI to PCI bridge (PCIE port 2) 04:00.0 USB controller: ASMedia Technology Inc. ASM1042 SuperSpeed USB Host Controller 05:00.0 Ethernet controller: Realtek Semiconductor Co., Ltd. RTL8111/8168/8411 PCI Express Gigabit Ethernet Controller (rev 09) ### Group 9 ### 00:18.0 Host bridge: Advanced Micro Devices, Inc. [AMD] Family 15h (Models 10h-1fh) Processor Function 0 00:18.1 Host bridge: Advanced Micro Devices, Inc. [AMD] Family 15h (Models 10h-1fh) Processor Function 1 00:18.2 Host bridge: Advanced Micro Devices, Inc. [AMD] Family 15h (Models 10h-1fh) Processor Function 2 00:18.3 Host bridge: Advanced Micro Devices, Inc. [AMD] Family 15h (Models 10h-1fh) Processor Function 3 00:18.4 Host bridge: Advanced Micro Devices, Inc. [AMD] Family 15h (Models 10h-1fh) Processor Function 4 00:18.5 Host bridge: Advanced Micro Devices, Inc. [AMD] Family 15h (Models 10h-1fh) Processor Function 5</code></pre></div> <p class="postedit"><em>Last edited by ahl (2014-03-19 21:17:03)</em></p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1394543">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1394574" class="blockpost rowodd"> <h2><span><span class="conr">#1400</span> <a href="viewtopic.php?pid=1394574#p1394574">2014-03-19 21:35:19</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=73114">noctavian</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2013-07-11</span></dd> <dd><span>Posts: 9</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=73114">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>TripleSpeeder wrote:</cite><blockquote><div><div class="quotebox"><cite>Norcoen wrote:</cite><blockquote><div><p>Did anyone succeed using this with the Virtual Machine Managers (<a href="http://virt-manager.org/" rel="nofollow">http://virt-manager.org/</a>) XML-like configuration and could post it as an example?</p></div></blockquote></div><p>I am trying to, but no success so far, see <a href="https://bbs.archlinux.org/viewtopic.php?pid=1393384#p1393384" rel="nofollow">my post</a>. <br />But it seems some people got it to work: <a href="https://bbs.archlinux.org/viewtopic.php?pid=1349595#p1349595" rel="nofollow">Val532</a>, <a href="https://bbs.archlinux.org/viewtopic.php?pid=1343400#p1343400" rel="nofollow">kaeptnb</a></p><p>PS: This thread is at the same time a goldmine and a total mess :-D</p></div></blockquote></div><p>This is my virt-manager config XML for a Windows 7 VM with AMD HD6770 GPU + HDMI, Audio controller and an usb controller passed to it. I made the vm using the virt-manager gui, I manually configured the number of sockets, cores and threads and after installing windows i used the gui to add the video card and various controllers to the vm. Also I have nested virtualization enabled if this makes a difference.</p><div class="codebox"><pre class="vscroll"><code>&lt;!-- WARNING: THIS IS AN AUTO-GENERATED FILE. CHANGES TO IT ARE LIKELY TO BE OVERWRITTEN AND LOST. Changes to this xml configuration should be made using: virsh edit Windows-7-Main or other application using the libvirt API. --&gt; &lt;domain type=&#039;kvm&#039;&gt; &lt;name&gt;Windows-7-Main&lt;/name&gt; &lt;uuid&gt;fbc03842-e6ea-d94d-eeba-e1dc4da0e1dd&lt;/uuid&gt; &lt;memory unit=&#039;KiB&#039;&gt;6291456&lt;/memory&gt; &lt;currentMemory unit=&#039;KiB&#039;&gt;6291456&lt;/currentMemory&gt; &lt;vcpu placement=&#039;static&#039;&gt;6&lt;/vcpu&gt; &lt;os&gt; &lt;type arch=&#039;x86_64&#039; machine=&#039;pc-i440fx-1.7&#039;&gt;hvm&lt;/type&gt; &lt;boot dev=&#039;cdrom&#039;/&gt; &lt;boot dev=&#039;hd&#039;/&gt; &lt;/os&gt; &lt;features&gt; &lt;acpi/&gt; &lt;apic/&gt; &lt;pae/&gt; &lt;/features&gt; &lt;cpu mode=&#039;custom&#039; match=&#039;exact&#039;&gt; &lt;model fallback=&#039;allow&#039;&gt;SandyBridge&lt;/model&gt; &lt;vendor&gt;Intel&lt;/vendor&gt; &lt;topology sockets=&#039;1&#039; cores=&#039;6&#039; threads=&#039;6&#039;/&gt; &lt;feature policy=&#039;require&#039; name=&#039;pbe&#039;/&gt; &lt;feature policy=&#039;require&#039; name=&#039;tm2&#039;/&gt; &lt;feature policy=&#039;require&#039; name=&#039;est&#039;/&gt; &lt;feature policy=&#039;require&#039; name=&#039;monitor&#039;/&gt; &lt;feature policy=&#039;require&#039; name=&#039;osxsave&#039;/&gt; &lt;feature policy=&#039;require&#039; name=&#039;smx&#039;/&gt; &lt;feature policy=&#039;require&#039; name=&#039;ss&#039;/&gt; &lt;feature policy=&#039;require&#039; name=&#039;vme&#039;/&gt; &lt;feature policy=&#039;require&#039; name=&#039;dtes64&#039;/&gt; &lt;feature policy=&#039;require&#039; name=&#039;ht&#039;/&gt; &lt;feature policy=&#039;require&#039; name=&#039;ds&#039;/&gt; &lt;feature policy=&#039;require&#039; name=&#039;pcid&#039;/&gt; &lt;feature policy=&#039;require&#039; name=&#039;tm&#039;/&gt; &lt;feature policy=&#039;require&#039; name=&#039;pdcm&#039;/&gt; &lt;feature policy=&#039;require&#039; name=&#039;vmx&#039;/&gt; &lt;feature policy=&#039;require&#039; name=&#039;ds_cpl&#039;/&gt; &lt;feature policy=&#039;require&#039; name=&#039;xtpr&#039;/&gt; &lt;feature policy=&#039;require&#039; name=&#039;acpi&#039;/&gt; &lt;/cpu&gt; &lt;clock offset=&#039;localtime&#039;/&gt; &lt;on_poweroff&gt;destroy&lt;/on_poweroff&gt; &lt;on_reboot&gt;restart&lt;/on_reboot&gt; &lt;on_crash&gt;restart&lt;/on_crash&gt; &lt;devices&gt; &lt;emulator&gt;/usr/sbin/qemu-system-x86_64&lt;/emulator&gt; &lt;disk type=&#039;file&#039; device=&#039;disk&#039;&gt; &lt;driver name=&#039;qemu&#039; type=&#039;qcow2&#039;/&gt; &lt;source file=&#039;/var/lib/libvirt/images/windows_7_main.img&#039;/&gt; &lt;target dev=&#039;vdb&#039; bus=&#039;virtio&#039;/&gt; &lt;address type=&#039;pci&#039; domain=&#039;0x0000&#039; bus=&#039;0x00&#039; slot=&#039;0x08&#039; function=&#039;0x0&#039;/&gt; &lt;/disk&gt; &lt;disk type=&#039;file&#039; device=&#039;cdrom&#039;&gt; &lt;driver name=&#039;qemu&#039; type=&#039;raw&#039; cache=&#039;none&#039;/&gt; &lt;target dev=&#039;hda&#039; bus=&#039;ide&#039;/&gt; &lt;readonly/&gt; &lt;address type=&#039;drive&#039; controller=&#039;0&#039; bus=&#039;0&#039; target=&#039;0&#039; unit=&#039;0&#039;/&gt; &lt;/disk&gt; &lt;disk type=&#039;file&#039; device=&#039;cdrom&#039;&gt; &lt;driver name=&#039;qemu&#039; type=&#039;raw&#039; cache=&#039;none&#039;/&gt; &lt;target dev=&#039;hdc&#039; bus=&#039;ide&#039;/&gt; &lt;readonly/&gt; &lt;address type=&#039;drive&#039; controller=&#039;0&#039; bus=&#039;1&#039; target=&#039;0&#039; unit=&#039;0&#039;/&gt; &lt;/disk&gt; &lt;controller type=&#039;usb&#039; index=&#039;0&#039;&gt; &lt;address type=&#039;pci&#039; domain=&#039;0x0000&#039; bus=&#039;0x00&#039; slot=&#039;0x01&#039; function=&#039;0x2&#039;/&gt; &lt;/controller&gt; &lt;controller type=&#039;pci&#039; index=&#039;0&#039; model=&#039;pci-root&#039;/&gt; &lt;controller type=&#039;ide&#039; index=&#039;0&#039;&gt; &lt;address type=&#039;pci&#039; domain=&#039;0x0000&#039; bus=&#039;0x00&#039; slot=&#039;0x01&#039; function=&#039;0x1&#039;/&gt; &lt;/controller&gt; &lt;controller type=&#039;sata&#039; index=&#039;0&#039;&gt; &lt;address type=&#039;pci&#039; domain=&#039;0x0000&#039; bus=&#039;0x00&#039; slot=&#039;0x05&#039; function=&#039;0x0&#039;/&gt; &lt;/controller&gt; &lt;interface type=&#039;bridge&#039;&gt; &lt;mac address=&#039;52:54:00:fe:3e:b0&#039;/&gt; &lt;source bridge=&#039;br0&#039;/&gt; &lt;model type=&#039;virtio&#039;/&gt; &lt;address type=&#039;pci&#039; domain=&#039;0x0000&#039; bus=&#039;0x00&#039; slot=&#039;0x03&#039; function=&#039;0x0&#039;/&gt; &lt;/interface&gt; &lt;serial type=&#039;pty&#039;&gt; &lt;target port=&#039;0&#039;/&gt; &lt;/serial&gt; &lt;console type=&#039;pty&#039;&gt; &lt;target type=&#039;serial&#039; port=&#039;0&#039;/&gt; &lt;/console&gt; &lt;input type=&#039;tablet&#039; bus=&#039;usb&#039;/&gt; &lt;input type=&#039;mouse&#039; bus=&#039;ps2&#039;/&gt; &lt;graphics type=&#039;vnc&#039; port=&#039;-1&#039; autoport=&#039;yes&#039;/&gt; &lt;sound model=&#039;ich6&#039;&gt; &lt;address type=&#039;pci&#039; domain=&#039;0x0000&#039; bus=&#039;0x00&#039; slot=&#039;0x04&#039; function=&#039;0x0&#039;/&gt; &lt;/sound&gt; &lt;video&gt; &lt;model type=&#039;vga&#039; vram=&#039;9216&#039; heads=&#039;1&#039;/&gt; &lt;address type=&#039;pci&#039; domain=&#039;0x0000&#039; bus=&#039;0x00&#039; slot=&#039;0x02&#039; function=&#039;0x0&#039;/&gt; &lt;/video&gt; &lt;hostdev mode=&#039;subsystem&#039; type=&#039;pci&#039; managed=&#039;yes&#039;&gt; &lt;source&gt; &lt;address domain=&#039;0x0000&#039; bus=&#039;0x00&#039; slot=&#039;0x1b&#039; function=&#039;0x0&#039;/&gt; &lt;/source&gt; &lt;address type=&#039;pci&#039; domain=&#039;0x0000&#039; bus=&#039;0x00&#039; slot=&#039;0x07&#039; function=&#039;0x0&#039;/&gt; &lt;/hostdev&gt; &lt;hostdev mode=&#039;subsystem&#039; type=&#039;pci&#039; managed=&#039;yes&#039;&gt; &lt;source&gt; &lt;address domain=&#039;0x0000&#039; bus=&#039;0x00&#039; slot=&#039;0x1a&#039; function=&#039;0x0&#039;/&gt; &lt;/source&gt; &lt;address type=&#039;pci&#039; domain=&#039;0x0000&#039; bus=&#039;0x00&#039; slot=&#039;0x09&#039; function=&#039;0x0&#039;/&gt; &lt;/hostdev&gt; &lt;hostdev mode=&#039;subsystem&#039; type=&#039;pci&#039; managed=&#039;yes&#039;&gt; &lt;source&gt; &lt;address domain=&#039;0x0000&#039; bus=&#039;0x01&#039; slot=&#039;0x00&#039; function=&#039;0x0&#039;/&gt; &lt;/source&gt; &lt;address type=&#039;pci&#039; domain=&#039;0x0000&#039; bus=&#039;0x00&#039; slot=&#039;0x0a&#039; function=&#039;0x0&#039;/&gt; &lt;/hostdev&gt; &lt;hostdev mode=&#039;subsystem&#039; type=&#039;pci&#039; managed=&#039;yes&#039;&gt; &lt;source&gt; &lt;address domain=&#039;0x0000&#039; bus=&#039;0x01&#039; slot=&#039;0x00&#039; function=&#039;0x1&#039;/&gt; &lt;/source&gt; &lt;address type=&#039;pci&#039; domain=&#039;0x0000&#039; bus=&#039;0x00&#039; slot=&#039;0x0b&#039; function=&#039;0x0&#039;/&gt; &lt;/hostdev&gt; &lt;memballoon model=&#039;virtio&#039;&gt; &lt;address type=&#039;pci&#039; domain=&#039;0x0000&#039; bus=&#039;0x00&#039; slot=&#039;0x06&#039; function=&#039;0x0&#039;/&gt; &lt;/memballoon&gt; &lt;/devices&gt; &lt;/domain&gt;</code></pre></div> </div> <div class="postsignature postmsg"><hr /><p><a href="https://docs.google.com/spreadsheet/ccc?key=0Aryg5nO-kBebdFozaW9tUWdVd2VHM0lvck95TUlpMlE&amp;usp=drive_web#gid=0" rel="nofollow">VGA-Passthrough configs</a></p></div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1394574">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div class="postlinksb"> <div class="inbox crumbsplus"> <div class="pagepost"> <p class="pagelink conl"><span class="pages-label">Pages: </span><a rel="prev" class="item1" href="viewtopic.php?id=162768&amp;p=55">Previous</a> <a href="viewtopic.php?id=162768">1</a> <span class="spacer">…</span> <a href="viewtopic.php?id=162768&amp;p=54">54</a> <a href="viewtopic.php?id=162768&amp;p=55">55</a> <strong>56</strong> <a href="viewtopic.php?id=162768&amp;p=57">57</a> <a href="viewtopic.php?id=162768&amp;p=58">58</a> <span class="spacer">…</span> <a href="viewtopic.php?id=162768&amp;p=234">234</a> <a rel="next" href="viewtopic.php?id=162768&amp;p=57">Next</a></p> <p class="postlink conr">Topic closed</p> </div> <ul class="crumbs"> <li><a href="index.php">Index</a></li> <li><span>»&#160;</span><a href="viewforum.php?id=48">Topics Going Nowhere</a></li> <li><span>»&#160;</span><strong><a href="viewtopic.php?id=162768">KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</a></strong></li> </ul> <p class="subscribelink clearb"><a href="misc.php?action=subscribe&amp;tid=162768">Subscribe to this topic</a></p> <div class="clearer"></div> </div> </div> </div> <div id="brdfooter" class="block"> <h2><span>Board footer</span></h2> <div class="box"> <div id="brdfooternav" class="inbox"> <div class="conl"> <form id="qjump" method="get" action="viewforum.php"> <div><label><span>Jump to<br /></span> <select name="id" onchange="window.location=('viewforum.php?id='+this.options[this.selectedIndex].value)"> <optgroup label="Technical Issues and Assistance"> <option value="23">Newbie Corner</option> <option value="17">Installation</option> <option value="22">Kernel &amp; Hardware</option> <option value="18">Applications &amp; Desktop Environments</option> <option value="31">Laptop Issues</option> <option value="8">Networking, Server, and Protection</option> <option value="32">Multimedia and Games</option> <option value="50">System Administration</option> <option value="35">Other Architectures</option> </optgroup> <optgroup label="Arch-centric"> <option value="24">Announcements, Package &amp; Security Advisories</option> <option value="1">Arch Discussion</option> <option value="13">Forum &amp; Wiki discussion</option> </optgroup> <optgroup label="Pacman Upgrades, Packaging &amp; AUR"> <option value="44">Pacman &amp; Package Upgrade Issues</option> <option value="49">[testing] Repo Forum</option> <option value="4">Creating &amp; Modifying Packages</option> <option value="38">AUR Issues, Discussion &amp; PKGBUILD Requests</option> </optgroup> <optgroup label="Contributions &amp; Discussion"> <option value="20">GNU/Linux Discussion</option> <option value="27">Community Contributions</option> <option value="33">Programming &amp; Scripting</option> <option value="30">Other Languages</option> <option value="47">Artwork and Screenshots</option> <option value="42">Try This</option> </optgroup> <optgroup label="/dev/null"> <option value="29">Off-Topic</option> <option value="48" selected="selected">Topics Going Nowhere</option> <option value="36">Dustbin</option> </optgroup> </select></label> <input type="submit" value=" Go " accesskey="g" /> </div> </form> </div> <div class="conr"> <p id="feedlinks"><span class="atom"><a href="extern.php?action=feed&amp;tid=162768&amp;type=atom">Atom topic feed</a></span></p> <p id="poweredby">Powered by <a href="http://fluxbb.org/">FluxBB</a></p> </div> <div class="clearer"></div> </div> </div> </div> </div> <div class="end-box"></div> </div> </body> </html>
