<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"> <html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en" dir="ltr"> <head> <meta http-equiv="Content-Type" content="text/html; charset=utf-8" /> <title>KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9 (Page 2) / Topics Going Nowhere / Arch Linux Forums</title> <link rel="stylesheet" type="text/css" href="style/ArchLinux.css" /> <link rel="canonical" href="viewtopic.php?id=162768&amp;p=2" title="Page 2" /> <link rel="prev" href="viewtopic.php?id=162768" title="Page 1" /> <link rel="next" href="viewtopic.php?id=162768&amp;p=3" title="Page 3" /> <link rel="alternate" type="application/atom+xml" href="extern.php?action=feed&amp;tid=162768&amp;type=atom" title="Atom topic feed" /> <link rel="stylesheet" media="screen" href="style/ArchLinux/arch.css?v=3" /> <link rel="stylesheet" media="screen" href="style/ArchLinux/archnavbar.css?v=2" /> <link rel="shortcut icon" href="style/ArchLinux/favicon.ico" /> </head> <body> <div id="archnavbar" class="anb-forum"> <div id="archnavbarlogo"><h1><a href="http://www.archlinux.org/">Arch Linux</a></h1></div> <div id="archnavbarmenu"> <ul id="archnavbarlist"> <li id="anb-home"><a href="http://www.archlinux.org/">Home</a></li><li id="anb-packages"><a href="http://www.archlinux.org/packages/">Packages</a></li><li id="anb-forums" class="anb-selected"><a href="https://bbs.archlinux.org/">Forums</a></li><li id="anb-wiki"><a href="https://wiki.archlinux.org/">Wiki</a></li><li id="anb-bugs"><a href="https://bugs.archlinux.org/">Bugs</a></li><li id="anb-aur"><a href="https://aur.archlinux.org/">AUR</a></li><li id="anb-download"><a href="http://www.archlinux.org/download/">Download</a></li> </ul> </div> </div> <div id="punviewtopic" class="pun"> <div class="top-box"></div> <div class="punwrap"> <div id="brdheader" class="block"> <div class="box"> <div id="brdmenu" class="inbox"> <ul> <li id="navindex" class="isactive"><a href="index.php">Index</a></li> <li id="navuserlist"><a href="userlist.php">User list</a></li> <li id="navsearch"><a href="search.php">Search</a></li> <li id="navprofile"><a href="profile.php?id=80749">Profile</a></li> <li id="navlogout"><a href="login.php?action=out&amp;id=80749&amp;csrf_token=5c20501ec397bb45ef8ee8c84db232c8d8e421c6">Logout</a></li> </ul> </div> <div id="brdwelcome" class="inbox"> <ul class="conl"> <li><span>Logged in as <strong>SXX</strong></span></li> <li><span>Last visit: 2015-08-16 12:20:09</span></li> </ul> <ul class="conr"> <li><span>Topics: <a href="search.php?action=show_replies" title="Find topics you have posted to.">Posted</a> | <a href="search.php?action=show_new" title="Find topics with new posts since your last visit.">New</a> | <a href="search.php?action=show_recent" title="Find topics with recent posts.">Active</a> | <a href="search.php?action=show_unanswered" title="Find topics with no replies.">Unanswered</a></span></li> </ul> <div class="clearer"></div> </div> </div> </div> <div id="brdmain"> <div class="linkst"> <div class="inbox crumbsplus"> <ul class="crumbs"> <li><a href="index.php">Index</a></li> <li><span>»&#160;</span><a href="viewforum.php?id=48">Topics Going Nowhere</a></li> <li><span>»&#160;</span><strong><a href="viewtopic.php?id=162768">KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</a></strong></li> </ul> <div class="pagepost"> <p class="pagelink conl"><span class="pages-label">Pages: </span><a rel="prev" class="item1" href="viewtopic.php?id=162768">Previous</a> <a href="viewtopic.php?id=162768">1</a> <strong>2</strong> <a href="viewtopic.php?id=162768&amp;p=3">3</a> <a href="viewtopic.php?id=162768&amp;p=4">4</a> <span class="spacer">…</span> <a href="viewtopic.php?id=162768&amp;p=234">234</a> <a rel="next" href="viewtopic.php?id=162768&amp;p=3">Next</a></p> <p class="postlink conr">Topic closed</p> </div> <div class="clearer"></div> </div> </div> <div id="p1274399" class="blockpost rowodd blockpost1"> <h2><span><span class="conr">#26</span> <a href="viewtopic.php?pid=1274399#p1274399">2013-05-17 21:58:13</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=71361">apoapo</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2013-05-16</span></dd> <dd><span>Posts: 15</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=71361">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>nbhs wrote:</cite><blockquote><div><p>Unfortunately, no, your best bet at this point is fill a bug @ qemu-devel, if you&#039;re using my script to bind the devices, you could try doing it manually, only binding the gpu and the gpu_snd, but i dont think vfio will work if all the devices of the same group are not binded to it.</p></div></blockquote></div><p>Yeah will try this again and will then see what I can do <img src="https://bbs.archlinux.org/img/smilies/wink.png" width="15" height="15" alt="wink" />.Or I have to buy a PCIe 1x oder PCI VGA card for host xD</p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1274399">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1274402" class="blockpost roweven"> <h2><span><span class="conr">#27</span> <a href="viewtopic.php?pid=1274402#p1274402">2013-05-17 22:05:18</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=70922">nbhs</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd class="postavatar"><img src="https://bbs.archlinux.org/img/avatars/70922.jpg?m=1367773811" width="80" height="80" alt="" /></dd> <dd><span>From: Montevideo, Uruguay</span></dd> <dd><span>Registered: 2013-05-02</span></dd> <dd><span>Posts: 402</span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <p>This is how you can manually bind it:</p><div class="codebox"><pre><code>echo &quot;0000:07:00.0&quot; &gt; /sys/bus/pci/devices/0000\:07\:00.0/driver/unbind echo 1002 6719 &gt; /sys/bus/pci/drivers/vfio-pci/new_id</code></pre></div> <p class="postedit"><em>Last edited by nbhs (2013-05-17 22:05:30)</em></p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1274402">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1274405" class="blockpost rowodd"> <h2><span><span class="conr">#28</span> <a href="viewtopic.php?pid=1274405#p1274405">2013-05-17 22:12:03</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=71361">apoapo</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2013-05-16</span></dd> <dd><span>Posts: 15</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=71361">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>nbhs wrote:</cite><blockquote><div><p>This is how you can manually bind it:</p><div class="codebox"><pre><code>echo &quot;0000:07:00.0&quot; &gt; /sys/bus/pci/devices/0000\:07\:00.0/driver/unbind echo 1002 6719 &gt; /sys/bus/pci/drivers/vfio-pci/new_id</code></pre></div></div></blockquote></div><p>Yepp thx, know this <img src="https://bbs.archlinux.org/img/smilies/smile.png" width="15" height="15" alt="smile" />.</p><p>Tried to get VGA passthrough working some times ago with different hardware, XEN and kvm with pci-assign <img src="https://bbs.archlinux.org/img/smilies/wink.png" width="15" height="15" alt="wink" /></p> <p class="postedit"><em>Last edited by apoapo (2013-05-17 22:12:59)</em></p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1274405">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1274406" class="blockpost roweven"> <h2><span><span class="conr">#29</span> <a href="viewtopic.php?pid=1274406#p1274406">2013-05-17 22:16:33</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=70922">nbhs</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd class="postavatar"><img src="https://bbs.archlinux.org/img/avatars/70922.jpg?m=1367773811" width="80" height="80" alt="" /></dd> <dd><span>From: Montevideo, Uruguay</span></dd> <dd><span>Registered: 2013-05-02</span></dd> <dd><span>Posts: 402</span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <p>Well if pci-assign worked for you in the past, and it crashed after a guest reboot, you can try the eject method under radeon related problems, that worked for me when using pci-assign</p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1274406">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1274453" class="blockpost rowodd"> <h2><span><span class="conr">#30</span> <a href="viewtopic.php?pid=1274453#p1274453">2013-05-18 01:39:11</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=71361">apoapo</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2013-05-16</span></dd> <dd><span>Posts: 15</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=71361">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <p>It seems to work really well with pci-assign.</p><p>Now I have the Intel GPU as host-GPU. Running with X without any problems. <br />I&#039;m able to reboot the VM with ejecting the card before reboot / shutdown.<br />Perfomance seems good and till now i havn&#039;t got freezes.</p><p>I can&#039;t use q35. If i do, the system says, the graphic card could not be started, so I use this configuration for now:</p><div class="codebox"><pre><code>qemu-system-x86_64 --enable-kvm -m 4096 -cpu host \ -smp 4,sockets=1,cores=4,threads=1 \ -device pci-assign,host=01:00.0 \ -device pci-assign,host=01:00.1 \ -drive file=/var/lib/libvirt/images/win-test.img </code></pre></div> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1274453">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1274455" class="blockpost roweven"> <h2><span><span class="conr">#31</span> <a href="viewtopic.php?pid=1274455#p1274455">2013-05-18 01:49:20</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=70922">nbhs</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd class="postavatar"><img src="https://bbs.archlinux.org/img/avatars/70922.jpg?m=1367773811" width="80" height="80" alt="" /></dd> <dd><span>From: Montevideo, Uruguay</span></dd> <dd><span>Registered: 2013-05-02</span></dd> <dd><span>Posts: 402</span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>apoapo wrote:</cite><blockquote><div><p>It seems to work really well with pci-assign.</p><p>Now I have the Intel GPU as host-GPU. Running with X without any problems. <br />I&#039;m able to reboot the VM with ejecting the card before reboot / shutdown.<br />Perfomance seems good and till now i havn&#039;t got freezes.</p><p>I can&#039;t use q35. If i do, the system says, the graphic card could not be started, so I use this configuration for now:</p><div class="codebox"><pre><code>qemu-system-x86_64 --enable-kvm -m 4096 -cpu host \ -smp 4,sockets=1,cores=4,threads=1 \ -device pci-assign,host=01:00.0 \ -device pci-assign,host=01:00.1 \ -drive file=/var/lib/libvirt/images/win-test.img </code></pre></div></div></blockquote></div><p>Great!</p><p>You can do the ejecting automatically using a tool called deveject, i detailed this process under radeon related problems</p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1274455">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1274471" class="blockpost rowodd"> <h2><span><span class="conr">#32</span> <a href="viewtopic.php?pid=1274471#p1274471">2013-05-18 03:12:15</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=71361">apoapo</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2013-05-16</span></dd> <dd><span>Posts: 15</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=71361">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <p>It is running really great! <img src="https://bbs.archlinux.org/img/smilies/big_smile.png" width="15" height="15" alt="big_smile" /></p><p>The only thing is, that running the scripts automatically with gpedit.msc isn&#039;t working. If i try to use this, the system will freeze at next start, so I think the scripts will not be executed.<br />If I eject the vga card manually I can reboot (shutdown and start again) as often as I want. When rebooting, the System starts without vga-card, because they are still ejected, I think.</p><p>But the performance is stunning!</p><p>Tried a game (Project Cars), where CPU and GPU are utilized very much at same settings.<br />Windows 7 nativ: 58fps<br />Windows 7 VM: 60fps<br />I think the 2 fps come from the clean install/less programms running <img src="https://bbs.archlinux.org/img/smilies/wink.png" width="15" height="15" alt="wink" /></p><p>Also testing with very high Settings of the game (With downsampling 9 =&gt;5760x3600 Pixel resolution), I get ~same fps like native!</p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1274471">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1274475" class="blockpost roweven"> <h2><span><span class="conr">#33</span> <a href="viewtopic.php?pid=1274475#p1274475">2013-05-18 03:16:47</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=70922">nbhs</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd class="postavatar"><img src="https://bbs.archlinux.org/img/avatars/70922.jpg?m=1367773811" width="80" height="80" alt="" /></dd> <dd><span>From: Montevideo, Uruguay</span></dd> <dd><span>Registered: 2013-05-02</span></dd> <dd><span>Posts: 402</span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <p>Gratz, the script should work tho, run cmd.exe as admin and execute</p><div class="codebox"><pre><code> deveject.exe -EjectId:&quot;PCI\VEN_1002&amp;DEV_6719&amp;SUBSYS_31221682&amp;REV_00\4&amp;184E0D10&amp;0&amp;00E0&quot;</code></pre></div><p> change pci\ven.... to match yours, its works the same as manually ejecting so there&#039;s prolly a typo somewhere</p> <p class="postedit"><em>Last edited by nbhs (2013-05-18 03:17:55)</em></p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1274475">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1274477" class="blockpost rowodd"> <h2><span><span class="conr">#34</span> <a href="viewtopic.php?pid=1274477#p1274477">2013-05-18 03:21:39</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=71361">apoapo</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2013-05-16</span></dd> <dd><span>Posts: 15</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=71361">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>nbhs wrote:</cite><blockquote><div><p>Gratz, the script should work tho, run cmd.exe as admin and execute</p><div class="codebox"><pre><code> deveject.exe -EjectId:&quot;PCI\VEN_1002&amp;DEV_6719&amp;SUBSYS_31221682&amp;REV_00\4&amp;184E0D10&amp;0&amp;00E0&quot;</code></pre></div><p> change pci\ven.... to match yours, its works the same as manually ejecting so there&#039;s prolly a typo somewhere</p></div></blockquote></div><p>yeah. running deveject.exe manually is running fine. Only if I want to run it automatically at shutdown (with dpedit.msc script) it isn&#039;t working.</p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1274477">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1274478" class="blockpost roweven"> <h2><span><span class="conr">#35</span> <a href="viewtopic.php?pid=1274478#p1274478">2013-05-18 03:24:37</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=70922">nbhs</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd class="postavatar"><img src="https://bbs.archlinux.org/img/avatars/70922.jpg?m=1367773811" width="80" height="80" alt="" /></dd> <dd><span>From: Montevideo, Uruguay</span></dd> <dd><span>Registered: 2013-05-02</span></dd> <dd><span>Posts: 402</span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <p>copy deveject.exe to C:\Windows\System32\deveject.exe and try again, you need to put the full path under &quot;Script name&quot; and the rest under &quot;Script Parameters&quot; --&gt;&#160; <br />-EjectId:&quot;PCI\VEN_1002&amp;DEV_6719&amp;SUBSYS_31221682&amp;REV_00\4&amp;184E0D10&amp;0&amp;00E0&quot;</p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1274478">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1274479" class="blockpost rowodd"> <h2><span><span class="conr">#36</span> <a href="viewtopic.php?pid=1274479#p1274479">2013-05-18 03:26:01</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=71361">apoapo</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2013-05-16</span></dd> <dd><span>Posts: 15</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=71361">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <p>tried it again... is working now.<br />Did the same, I did before... think it could be a typo <img src="https://bbs.archlinux.org/img/smilies/wink.png" width="15" height="15" alt="wink" /><br />Thanks a lot.</p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1274479">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1274480" class="blockpost roweven"> <h2><span><span class="conr">#37</span> <a href="viewtopic.php?pid=1274480#p1274480">2013-05-18 03:26:29</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=70922">nbhs</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd class="postavatar"><img src="https://bbs.archlinux.org/img/avatars/70922.jpg?m=1367773811" width="80" height="80" alt="" /></dd> <dd><span>From: Montevideo, Uruguay</span></dd> <dd><span>Registered: 2013-05-02</span></dd> <dd><span>Posts: 402</span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <p>np, and gratz</p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1274480">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1274947" class="blockpost rowodd"> <h2><span><span class="conr">#38</span> <a href="viewtopic.php?pid=1274947#p1274947">2013-05-19 07:19:50</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=71441">shadey</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2013-05-19</span></dd> <dd><span>Posts: 2</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=71441">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>apoapo wrote:</cite><blockquote><div><p>It seems to work really well with pci-assign.</p><p>Now I have the Intel GPU as host-GPU. Running with X without any problems. <br />I&#039;m able to reboot the VM with ejecting the card before reboot / shutdown.<br />Perfomance seems good and till now i havn&#039;t got freezes.</p><p>I can&#039;t use q35. If i do, the system says, the graphic card could not be started, so I use this configuration for now:</p><div class="codebox"><pre><code>qemu-system-x86_64 --enable-kvm -m 4096 -cpu host \ -smp 4,sockets=1,cores=4,threads=1 \ -device pci-assign,host=01:00.0 \ -device pci-assign,host=01:00.1 \ -drive file=/var/lib/libvirt/images/win-test.img </code></pre></div></div></blockquote></div><p>Hi there! <br />We have the same motherboard and GPU and almost the same CPU. (I have 3770) It looks like we are both trying to achieve the same thing too! I want to use my Intel IGP as the primary Linux desktop with the Radeon passed through for windows gaming. </p><p>After following this thread and your conversation I have encountered the same problems that you had. I noticed that vfio grabbed the PCI Express root and I could not get the BIOS display on the pass&#039;d thru card. I see that you were able to get that working with PCI Express as the Primary VGA device on the host hardware. I have seen this behavior elsewhere so I think it might be a hardware limitation on our boards. I have been playing with many different VM systems lately and I saw the same behaviour with VMware ESXi 5.0.0 - if I didn&#039;t have primary VGA set to PCI Express AND disabled intel IGP in the host bios then the passed through display would be blank. Before VMWare I tried VGA pass through on Virtualbox and I gave up on that because of the blank screen thing and kernel crashes (I was not aware trying the Primary VGA bios setting at that stage). My best success before KVM has been in Xen using qemu-upstream. </p><p>Thank you for your configuration, I used a similar command line and managed to boot straight into my installed Win7 partition that I had created using Xen the day before, passthrough working and all. Now that I understand more the inner workings of QEMU I realised that I don&#039;t even need Xen to achieve my goals. I think KVM is a neat way to accomplish what we are trying to do.</p><p>Are you planning to use virtio drivers for network, disk etc? Would be interested to hear if you have success with it.</p><p>Dear OP: Thank you for this thread! It is how I discovered Archlinux and now I am converted.</p><p>I am using qemu-1.5.0-rc3 built with the &quot;seabios&quot; branch from seabios.git</p> <p class="postedit"><em>Last edited by shadey (2013-05-19 07:20:57)</em></p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1274947">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1274995" class="blockpost roweven"> <h2><span><span class="conr">#39</span> <a href="viewtopic.php?pid=1274995#p1274995">2013-05-19 09:13:06</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=70922">nbhs</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd class="postavatar"><img src="https://bbs.archlinux.org/img/avatars/70922.jpg?m=1367773811" width="80" height="80" alt="" /></dd> <dd><span>From: Montevideo, Uruguay</span></dd> <dd><span>Registered: 2013-05-02</span></dd> <dd><span>Posts: 402</span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>shadey wrote:</cite><blockquote><div><p>Dear OP: Thank you for this thread! It is how I discovered Archlinux and now I am converted.</p></div></blockquote></div><p>Sweet i&#039;m glad this is useful</p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1274995">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1275017" class="blockpost rowodd"> <h2><span><span class="conr">#40</span> <a href="viewtopic.php?pid=1275017#p1275017">2013-05-19 10:41:42</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=70922">nbhs</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd class="postavatar"><img src="https://bbs.archlinux.org/img/avatars/70922.jpg?m=1367773811" width="80" height="80" alt="" /></dd> <dd><span>From: Montevideo, Uruguay</span></dd> <dd><span>Registered: 2013-05-02</span></dd> <dd><span>Posts: 402</span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <p>Even though this is a kvm thread, i wanna share some of my experiences with XEN, and how to get PRIMARY vga passthrough ( gfx_passthru = 1 ) on radeon cards.</p><p>Sooooo, this is basically what im doing, i&#039;m passing through my secondary radeon ( 6950 ) card ( although you can also pass your primary card), as a primary vga (without cirrus emulated card), my usb3 ports, and my sata controller with my 2TB disk connected to it, using a DUET image ( see <a href="http://www.rodsbooks.com/bios2uefi/" rel="nofollow">http://www.rodsbooks.com/bios2uefi/</a> ), booting windows server 2008 on UEFI Mode straight from the controller ( no emulated disk controller ), with a hacked xen to enable intremap on my broken Asus crosshair v formula ivrs table, using the XM toolstack.</p><p>This is the package i use, xen-4.1.5 based on xen-4.2.2 from AUR: <a href="http://www.filesend.net/download.php?f=8cf6e5b3baeb926b34f3994840d0768d" rel="nofollow">xen.tar.gz</a></p><p>I commented out my hack @ line 37 because this might break working systems.</p><p>Once extracted you&#039;ll find a file called vgabios-pt.bin. That is the rom file for my 6950, you have to dump your card&#039;s rom or d/l it from <a href="http://www.techpowerup.com/vgabios/" rel="nofollow">http://www.techpowerup.com/vgabios/</a>, and replace that file with yours.</p><p>AFTER you copy your rom, build xen, install it then enable the needed services:</p><div class="codebox"><pre><code>systemctl enable xenstored systemctl enable xend</code></pre></div><p>Now you need to actually boot xen so we create a new file called 05_xen @ /etc/grub.d</p><div class="codebox"><pre><code>nano -w /etc/grub.d/05_xen</code></pre></div><p>The fist 2 lines:</p><div class="codebox"><pre><code>#!/bin/sh exec tail -n +3 $0</code></pre></div><p>For the rest the easiest way and the only one i&#039;ll describe here is to copy an entry from you /boot/grub/grub.cfg file:</p><div class="codebox"><pre><code>cat /boot/grub/grub.cfg</code></pre></div><p>Now copy the first menuentry to 05_xen:</p><div class="codebox"><pre><code>menuentry &#039;Arch GNU/Linux, with Linux.... { .... .... }</code></pre></div><p>Add this line on top of &quot;echo&#160; &#160; &#039;Loading Linux core repo kernel .&quot;:</p><div class="codebox"><pre><code>multiboot /xen-4.1.5.gz</code></pre></div><p>Modify &quot;linux&#160; &#160; /vmlinuz-linux&quot; to &quot;module&#160; &#160; /vmlinuz-linux&quot; and &quot;initrd&#160; &#160; /initramfs-linux&quot; to &quot;module&#160; &#160; /initramfs-linux&quot;</p><p>Make 05_xen executable</p><div class="codebox"><pre><code>chmod +x /etc/grub.d/05_xen</code></pre></div><p>Edit /etc/mkinitcpio.conf and include xen-pciback</p><div class="codebox"><pre><code>MODULES=&quot;xen-pciback&quot;</code></pre></div><p>If you wish to bind a device on boot to pciback modify 05_xen like this:</p><div class="codebox"><pre><code>module /vmlinuz-linux root=/dev/mapper/system-root ro xen-pciback.passthrough=1 xen-pciback.permissive=1 xen-pciback.hide=(07:00.0)(07:00.1)</code></pre></div><p>Update grub.cfg</p><div class="codebox"><pre><code>grub-mkconfig -o /boot/grub/grub.cfg</code></pre></div><p>Reboot and check everything is works</p><p>xm info | grep virt_caps</p><div class="codebox"><pre><code>virt_caps : hvm hvm_directio</code></pre></div><p>After this point if everything is working i suggest you read the xen documentation on how to create a vm, this is my configuration:</p><div class="codebox"><pre><code>kernel = &quot;hvmloader&quot; builder=&#039;hvm&#039; memory = 8192 name = &quot;hvm&quot; cpus = [ &quot;2&quot;, &quot;3&quot;, &quot;4&quot;, &quot;5&quot;, &quot;6&quot;, &quot;7&quot; ] vcpus = 6 disk = [ &#039;file:/root/xen/images/duet.img,hda,w&#039; ] pci = [ &#039;00:11.0&#039;, &#039;04:00.0&#039;, &#039;05:00.0&#039;, &#039;06:00.0&#039;, &#039;0000:07:00.*&#039; ] vif = [ &#039;bridge=br0&#039; ] gfx_passthru = 1 localtime = 1 xen_platform_pci = 1 pci_power_mgmt = 1 pci_msitranslate = 0 viridian = 1</code></pre></div><p><strong>How i got windows to boot from my sata controller using qemu-dm and DUET</strong></p><p>Notice this line:</p><div class="codebox"><pre><code>disk = [ &#039;file:/root/xen/images/duet.img,hda,w&#039; ]</code></pre></div><p>This is the duet image i&#039;ve been writing about, its a 200MB image containing DUET and REFIND ( <a href="http://www.rodsbooks.com/refind" rel="nofollow">http://www.rodsbooks.com/refind</a> )( also included is a efi driver dump of the controller for RAID mode (sb950), so you can boot on RAID but i havent experimented with it much )</p><p>Duet image here: <a href="http://www.filesend.net/download.php?f=df555f31139d86c4c4081c3bfa543959" rel="nofollow">Duet.img.zip</a></p><p>The boot sequence is like this ROMBIOS--&gt;DUET--&gt;WINDOWS.</p><p>Duet contains drivers for the controller in ahci mode, it finds the windows efi partition and boots from it.</p><p>Radeon xen primary passthrough on xen:</p><p><a href="http://i.imgur.com/aDqkSaC.jpg" rel="nofollow"><span class="postimg"><img src="http://i.imgur.com/dEGPaNI.jpg" alt="dEGPaNI.jpg" /></span></a></p><p>Duet with REFIND booting windows ( with gfx_passthu = 0 to take the screenshot ):</p><p><a href="http://i.imgur.com/nDDqTRM.jpg" rel="nofollow"><span class="postimg"><img src="http://i.imgur.com/S1bLj7P.png" alt="S1bLj7P.png" /></span></a></p> <p class="postedit"><em>Last edited by nbhs (2013-05-21 08:04:18)</em></p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1275017">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1275246" class="blockpost roweven"> <h2><span><span class="conr">#41</span> <a href="viewtopic.php?pid=1275246#p1275246">2013-05-19 20:40:33</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=47675">jgott</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2011-04-10</span></dd> <dd><span>Posts: 21</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=47675">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>nbhs wrote:</cite><blockquote><div><p>This is the package i use, xen-4.1.5 based on xen-4.2.2 from AUR: <a href="http://www.filesend.net/download.php?f=8cf6e5b3baeb926b34f3994840d0768d" rel="nofollow">xen.tar.gz</a></p></div></blockquote></div><p>Did the Xen people break VGA passthrough in recent versions? I got the sense that they had because I couldn&#039;t ever get 4.2 or 4.3 unstable to work completely (several different problems kept coming up), and I see that you&#039;re using 4.1.</p><p>I know they had a <a href="http://lists.xen.org/archives/html/xen-announce/2013-02/msg00002.html" rel="nofollow">recent security advisory</a> that resulted in tightening up some things and <a href="http://lists.xen.org/archives/html/xen-devel/2013-03/msg01016.html" rel="nofollow">making matters worse for AMD IOMMU users with broken BIOSes</a>. Apparently the switch to xl broke some things too (see the first entry on <a href="http://wiki.xensource.com/wiki/Talk:Xen_VGA_Passthrough_Tested_Adapters" rel="nofollow">this page</a>). And the gfx_passthrough option isn&#039;t yet supported for the new qemu device model (the default in 4.3, I think).</p><p>My sense is that some of the work done early on to make VGA passthrough work in Xen hasn&#039;t kept up with many of the recent changes in the project.</p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1275246">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1275252" class="blockpost rowodd"> <h2><span><span class="conr">#42</span> <a href="viewtopic.php?pid=1275252#p1275252">2013-05-19 21:01:43</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=70922">nbhs</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd class="postavatar"><img src="https://bbs.archlinux.org/img/avatars/70922.jpg?m=1367773811" width="80" height="80" alt="" /></dd> <dd><span>From: Montevideo, Uruguay</span></dd> <dd><span>Registered: 2013-05-02</span></dd> <dd><span>Posts: 402</span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>jgott wrote:</cite><blockquote><div><div class="quotebox"><cite>nbhs wrote:</cite><blockquote><div><p>This is the package i use, xen-4.1.5 based on xen-4.2.2 from AUR: <a href="http://www.filesend.net/download.php?f=8cf6e5b3baeb926b34f3994840d0768d" rel="nofollow">xen.tar.gz</a></p></div></blockquote></div><p>Did the Xen people break VGA passthrough in recent versions? I got the sense that they had because I couldn&#039;t ever get 4.2 or 4.3 unstable to work completely (several different problems kept coming up), and I see that you&#039;re using 4.1.</p><p>I know they had a <a href="http://lists.xen.org/archives/html/xen-announce/2013-02/msg00002.html" rel="nofollow">recent security advisory</a> that resulted in tightening up some things and <a href="http://lists.xen.org/archives/html/xen-devel/2013-03/msg01016.html" rel="nofollow">making matters worse for AMD IOMMU users with broken BIOSes</a>. Apparently the switch to xl broke some things too (see the first entry on <a href="http://wiki.xensource.com/wiki/Talk:Xen_VGA_Passthrough_Tested_Adapters" rel="nofollow">this page</a>). And the gfx_passthrough option isn&#039;t yet supported for the new qemu device model (the default in 4.3, I think).</p><p>My sense is that some of the work done early on to make VGA passthrough work in Xen hasn&#039;t kept up with many of the recent changes in the project.</p></div></blockquote></div><p>Im using xen-4.1 not because xen-4.2+ broke anything, simply because the xl toolstack doesnt support resseting passthru&#039;d devices, what you&#039;re refering about not working on broken ivrs tables is this: <a href="http://lists.xen.org/archives/html/xen-announce/2013-02/msg00002.html" rel="nofollow">XSA-36</a><br />which is also applied on xen 4.1.5, so i had to hack the xen code to make it work, which can aslo be applied (well it has to be modified a little) to xen-4.2+ ( i tried, it worked)</p><p>Included in my build i attached said fix, i have no idea if it breaks working builds, but im sure it works in our boards.</p><p>xm dmesg</p><div class="codebox"><pre><code>... (XEN) IOAPIC[0]: apic_id 9, version 33, address 0xfec00000, GSI 0-23 (XEN) IOAPIC[1]: apic_id 10, version 33, address 0xfec20000, GSI 24-55 (XEN) Enabling APIC mode: Flat. Using 2 I/O APICs (XEN) Using scheduler: SMP Credit Scheduler (credit) (XEN) Detected 4414.882 MHz processor. (XEN) Initing memory sharing. (XEN) AMD-Vi: IOMMU 0 Enabled. (XEN) AMD-Vi: Enabling per-device vector maps (XEN) I/O virtualisation enabled (XEN) - Dom0 mode: Relaxed (XEN) Interrupt remapping enabled ...</code></pre></div><br /><p>The other 2 patches included, is a patch to load the bios from your card from here: <a href="http://markmail.org/message/7gb7djbmlaxruaai" rel="nofollow">http://markmail.org/message/7gb7djbmlaxruaai</a>, which is important if you wish to passthrough a host secondary vga device as primary and this patch: <a href="http://old-list-archives.xenproject.org/archives/html/xen-devel/2010-12/msg00705.html" rel="nofollow">http://old-list-archives.xenproject.org … 00705.html</a>, modified by Greg Wettstein (<a href="http://lists.xen.org/archives/html/xen-devel/2012-12/msg00009.html" rel="nofollow">http://lists.xen.org/archives/html/xen- … 00009.html</a>) which allows to passthrough radeon cards as primary devices on xen with a pvops kernel.</p> <p class="postedit"><em>Last edited by nbhs (2013-05-19 21:42:05)</em></p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1275252">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1275575" class="blockpost roweven"> <h2><span><span class="conr">#43</span> <a href="viewtopic.php?pid=1275575#p1275575">2013-05-20 17:44:19</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=16994">jelly</a></strong></dt> <dd class="usertitle"><strong>Trusted User (TU)</strong></dd> <dd class="postavatar"><img src="https://bbs.archlinux.org/img/avatars/16994.png?m=1244619798" width="80" height="80" alt="" /></dd> <dd><span>From: /dev/null</span></dd> <dd><span>Registered: 2008-06-10</span></dd> <dd><span>Posts: 711</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=16994">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <p>It would be nice if you converted your first post about the KVM pci passthrough to a wiki article. Anyway nice work, sadly I don&#039;t have a VT-d enabled computer <img src="https://bbs.archlinux.org/img/smilies/sad.png" width="15" height="15" alt="sad" /></p> </div> <div class="postsignature postmsg"><hr /><p><a href="http://github.com/jelly/dotfiles/tree/master" rel="nofollow">dotfiles</a></p></div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1275575">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1275724" class="blockpost rowodd"> <h2><span><span class="conr">#44</span> <a href="viewtopic.php?pid=1275724#p1275724">2013-05-20 21:45:15</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=70922">nbhs</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd class="postavatar"><img src="https://bbs.archlinux.org/img/avatars/70922.jpg?m=1367773811" width="80" height="80" alt="" /></dd> <dd><span>From: Montevideo, Uruguay</span></dd> <dd><span>Registered: 2013-05-02</span></dd> <dd><span>Posts: 402</span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>jelly wrote:</cite><blockquote><div><p>It would be nice if you converted your first post about the KVM pci passthrough to a wiki article. Anyway nice work, sadly I don&#039;t have a VT-d enabled computer <img src="https://bbs.archlinux.org/img/smilies/sad.png" width="15" height="15" alt="sad" /></p></div></blockquote></div><p>I&#039;m not sure since this is experimental, and the success rate depends on a lot of variables, so i believe a thread where users can share experiences and solutions is a better alternative for now.</p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1275724">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1276102" class="blockpost roweven"> <h2><span><span class="conr">#45</span> <a href="viewtopic.php?pid=1276102#p1276102">2013-05-21 20:27:13</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=71519">dariocaruso</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2013-05-21</span></dd> <dd><span>Posts: 2</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=71519">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <p>Hi!</p><p>I just read about vfio driver, and i&#039;m looking if it&#039;s possible to use the secondary (or different) gpu AND plug separate displays to have a multi-seat server, with virtualized different indipendent guests. Can i realize this with vfio driver?</p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1276102">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1276164" class="blockpost rowodd"> <h2><span><span class="conr">#46</span> <a href="viewtopic.php?pid=1276164#p1276164">2013-05-21 22:23:32</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=70922">nbhs</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd class="postavatar"><img src="https://bbs.archlinux.org/img/avatars/70922.jpg?m=1367773811" width="80" height="80" alt="" /></dd> <dd><span>From: Montevideo, Uruguay</span></dd> <dd><span>Registered: 2013-05-02</span></dd> <dd><span>Posts: 402</span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>dariocaruso wrote:</cite><blockquote><div><p>Hi!</p><p>I just read about vfio driver, and i&#039;m looking if it&#039;s possible to use the secondary (or different) gpu AND plug separate displays to have a multi-seat server, with virtualized differentin dependentguests. Can i realize this with vfio driver?</p></div></blockquote></div><p>Well yeah, this is exactly what we&#039;re doing, 1 gpu per OS ( or more ), my host linux has 1 GPU and 1 monitor and my windows VM has 1 GPU and 1 monitor, each independent, each with a different usb keyboard and mouse</p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1276164">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1276184" class="blockpost roweven"> <h2><span><span class="conr">#47</span> <a href="viewtopic.php?pid=1276184#p1276184">2013-05-21 22:57:56</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=71519">dariocaruso</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2013-05-21</span></dd> <dd><span>Posts: 2</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=71519">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>nbhs wrote:</cite><blockquote><div><div class="quotebox"><cite>dariocaruso wrote:</cite><blockquote><div><p>Hi!</p><p>I just read about vfio driver, and i&#039;m looking if it&#039;s possible to use the secondary (or different) gpu AND plug separate displays to have a multi-seat server, with virtualized differentin dependentguests. Can i realize this with vfio driver?</p></div></blockquote></div><p>Well yeah, this is exactly what we&#039;re doing, 1 gpu per OS ( or more ), my host linux has 1 GPU and 1 monitor and my windows VM has 1 GPU and 1 monitor, each independent, each with a different usb keyboard and mouse</p></div></blockquote></div><br /><p>it seems exactly what i&#039;m looking for years! I want to put in the office a good one server and plug 3 or 4 workstation for administrate differents vm&#039;s! Please someone tell me if really i can use autocad with no lag on 2-3 guests at same time (of coourse with enough ram, gpu and all). For years followed and tested spice, but it was not good, like i want, to work confortably with cad/cam programs. Really a good chance to get an usable/0 lag application server for architects! I will start to build mine soon!</p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1276184">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1276185" class="blockpost rowodd"> <h2><span><span class="conr">#48</span> <a href="viewtopic.php?pid=1276185#p1276185">2013-05-21 23:00:03</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=70922">nbhs</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd class="postavatar"><img src="https://bbs.archlinux.org/img/avatars/70922.jpg?m=1367773811" width="80" height="80" alt="" /></dd> <dd><span>From: Montevideo, Uruguay</span></dd> <dd><span>Registered: 2013-05-02</span></dd> <dd><span>Posts: 402</span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>dariocaruso wrote:</cite><blockquote><div><div class="quotebox"><cite>nbhs wrote:</cite><blockquote><div><div class="quotebox"><cite>dariocaruso wrote:</cite><blockquote><div><p>Hi!</p><p>I just read about vfio driver, and i&#039;m looking if it&#039;s possible to use the secondary (or different) gpu AND plug separate displays to have a multi-seat server, with virtualized differentin dependentguests. Can i realize this with vfio driver?</p></div></blockquote></div><p>Well yeah, this is exactly what we&#039;re doing, 1 gpu per OS ( or more ), my host linux has 1 GPU and 1 monitor and my windows VM has 1 GPU and 1 monitor, each independent, each with a different usb keyboard and mouse</p></div></blockquote></div><br /><p>it seems exactly what i&#039;m looking for years! I want to put in the office a good one server and plug 3 or 4 workstation for administrate differents vm&#039;s! Please someone tell me if really i can use autocad with no lag on 2-3 guests at same time (of coourse with enough ram, gpu and all). For years followed and tested spice, but it was not good, like i want, to work confortably with cad/cam programs. Really a good chance to get an usable/0 lag application server for architects! I will start to build mine soon!</p></div></blockquote></div><p>Well, i&#039;m playing metro last light and bioshock infinite @ max settings with no lag, while i watch tv on my arch host, everything works like a dream.</p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1276185">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1276257" class="blockpost roweven"> <h2><span><span class="conr">#49</span> <a href="viewtopic.php?pid=1276257#p1276257">2013-05-22 03:11:01</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=71524">powerhouse</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2013-05-22</span></dd> <dd><span>Posts: 15</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=71524">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <p>@nbhs: This is a great tutorial - thanks!</p><p>@dariocaruso: VGA passthrough doesn&#039;t exactly replace Spice. The way it works is that you have multiple VGA cards in your PC which can support multiple VMs (one per VGA card). However, you may have a problem using this one PC for say 2-3 people since they would have to sit together very close, because of the limitations of the DVI or HDMI cables as well as the USB cables, all of which have a limitted length they support. There are extenders, though.</p><p>Other than that you should get good performance for CAD/CAM and two architects sitting opposite or next to each other (because of the length limit of the cables) should be able to work on one PC.</p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1276257">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1276259" class="blockpost rowodd"> <h2><span><span class="conr">#50</span> <a href="viewtopic.php?pid=1276259#p1276259">2013-05-22 03:15:59</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=47675">jgott</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2011-04-10</span></dd> <dd><span>Posts: 21</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=47675">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>jgott wrote:</cite><blockquote><div><div class="quotebox"><cite>nbhs wrote:</cite><blockquote><div><p>Are you sure the kernel and qemu are patched?</p></div></blockquote></div><p>Yes.</p></div></blockquote></div><p>I figured out what was wrong! Turns out, it was all my fault. I built my own packages, and I was pulling in the wrong branch from the qemu-vfio git repository. When troubleshooting, I had tried the linux-mainline package posted here, but not the qemu one. Oops. <img src="https://bbs.archlinux.org/img/smilies/big_smile.png" width="15" height="15" alt="big_smile" /></p><p>VGA reset now works perfectly every time! No more system crashes! Awesome!</p><p><strong>Windows Experience Index:</strong><br /><a href="http://imgur.com/olfKcGz" rel="nofollow"><span class="postimg"><img src="http://i.imgur.com/olfKcGz.png" alt="olfKcGz.png" /></span></a></p><p>Some useful information I&#039;ve gleaned:</p><p><strong>Input devices:</strong><br />Basic usability is achievable by using &#039;-usbdevice tablet -vga none&#039; (without &#039;-nographic&#039;, so the qemu window will still open) and making the qemu window fullscreen so it catches cursor and keyboard events.</p><p>Individual USB device passthrough is problematic for input devices, since at some point you need to tell the host to un-passthru the devices, and your input devices are in the guest. It might be possible to make this work (ssh from guest to host and unbind the input devices), but all the ways I could think of were pretty ugly.</p><p>I&#039;ve had good results passing through an entire USB3 controller (on the motherboard but not part of the chipset). A PCI add-on card would probably work great too, if I had the slots for it. Passing through one of the chipset&#039;s USB2 controllers seemed to result in more headers/ports being assigned than I intended, and it was trickier to determine the PCI device-&gt;USB root hub-&gt;physical port mapping. Your results may vary.</p><p><strong>Audio:</strong><br />Emulated audio was stuttery. My best results were with QEMU_AUDIO_DRV=alsa and QEMU_AUDIO_TIMER_PERIOD=0. AC97 was better than HD Audio for me, although I had to manually download <a href="http://www.realtek.com.tw/downloads/downloadsView.aspx?Langid=1&amp;PNid=14&amp;PFid=23&amp;Level=4&amp;Conn=3&amp;DownTypeID=3&amp;GetDown=false" rel="nofollow">Realtek&#039;s AC97 driver</a> and force it in Add New Hardware (<a href="https://downloadcenter.intel.com/Detail_Desc.aspx?DwnldID=8198" rel="nofollow">Intel&#039;s AC97 driver</a> caused a guest BSoD). I think the PCI IDs are slightly off and Windows doesn&#039;t recognize the AC97 device automatically.</p><p>I&#039;m going to pass through a real sound card device for better audio (and lower CPU usage). Unfortunately, the chipset audio device is tied to other important devices, and the second video card covers up the only PCI slot I have, so I need to buy a PCI Express one. <img src="https://bbs.archlinux.org/img/smilies/hmm.png" width="15" height="15" alt="hmm" /></p><p><strong>Disk:</strong><br />Use the <a href="http://www.linux-kvm.org/page/WindowsGuestDrivers/Download_Drivers" rel="nofollow">Windows virtio drivers</a> unless you want to pass through a real disk controller. This will increase performance quite a bit.</p><p>The default driver is virtio-blk, but the virtio-scsi driver is the only one where I could get Windows to enable TRIM. In Defrag, Windows shows a virtio-scsi disk as a &#039;thin provisioned disk&#039;, which essentially means it knows it&#039;s a VM disk device and will pass TRIM commands (intended for VM disk images, but should work for real SSDs as well).</p><p>TRIM isn&#039;t strictly necessary for VM images or SSDs, but without it, images will take up more space than is necessary and SSD performance will degrade over time.</p><p><strong>My current qemu invocation:</strong><br />In case this is useful to anyone. It&#039;s a little ugly right now, as I&#039;m still in the process of figuring out the best way to configure the devices.</p><div class="codebox"><pre><code>QEMU_AUDIO_DRV=alsa \ QEMU_AUDIO_TIMER_PERIOD=0 \ qemu-system-x86_64 -enable-kvm -name Windows8 \ -M q35 -nodefconfig -readconfig /pool/KVM/Windows8/q35-chipset.cfg \ -m 4096 -balloon none -mem-path /dev/hugepages \ -rtc base=localtime \ -cpu host -smp 8,sockets=1,cores=4,threads=2 \ -bios /usr/share/qemu/bios.bin \ -vga none \ -device vfio-pci,host=02:00.0,bus=ich9-pcie-port-1,addr=0.0,multifunction=on,x-vga=on \ -device vfio-pci,host=02:00.1,bus=ich9-pcie-port-1,addr=0.1 \ -device virtio-scsi-pci,id=scsi \ -drive id=ssd,if=none,format=raw,discard=on,cache=none,file=/dev/CorsairVG/Windows \ -drive if=virtio,format=raw,discard=on,file=/pool/KVM/Windows8/WinData.ntfs.img \ -drive id=cdrom,media=cdrom,format=raw,file=/dev/null \ -device scsi-hd,drive=ssd \ -device ide-cd,bus=ide.0,drive=cdrom \ -device vfio-pci,host=06:00.0,bus=ich9-pcie-port-2 \ -boot order=cd,menu=on \ -net nic,model=virtio,macaddr=00:55:aa:00:00:01 -net bridge,br=vm_br \ -soundhw hda,ac97 \ -usbdevice tablet \ &gt;$LOG 2&gt;$LOG</code></pre></div> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1276259">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div class="postlinksb"> <div class="inbox crumbsplus"> <div class="pagepost"> <p class="pagelink conl"><span class="pages-label">Pages: </span><a rel="prev" class="item1" href="viewtopic.php?id=162768">Previous</a> <a href="viewtopic.php?id=162768">1</a> <strong>2</strong> <a href="viewtopic.php?id=162768&amp;p=3">3</a> <a href="viewtopic.php?id=162768&amp;p=4">4</a> <span class="spacer">…</span> <a href="viewtopic.php?id=162768&amp;p=234">234</a> <a rel="next" href="viewtopic.php?id=162768&amp;p=3">Next</a></p> <p class="postlink conr">Topic closed</p> </div> <ul class="crumbs"> <li><a href="index.php">Index</a></li> <li><span>»&#160;</span><a href="viewforum.php?id=48">Topics Going Nowhere</a></li> <li><span>»&#160;</span><strong><a href="viewtopic.php?id=162768">KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</a></strong></li> </ul> <p class="subscribelink clearb"><a href="misc.php?action=subscribe&amp;tid=162768">Subscribe to this topic</a></p> <div class="clearer"></div> </div> </div> </div> <div id="brdfooter" class="block"> <h2><span>Board footer</span></h2> <div class="box"> <div id="brdfooternav" class="inbox"> <div class="conl"> <form id="qjump" method="get" action="viewforum.php"> <div><label><span>Jump to<br /></span> <select name="id" onchange="window.location=('viewforum.php?id='+this.options[this.selectedIndex].value)"> <optgroup label="Technical Issues and Assistance"> <option value="23">Newbie Corner</option> <option value="17">Installation</option> <option value="22">Kernel &amp; Hardware</option> <option value="18">Applications &amp; Desktop Environments</option> <option value="31">Laptop Issues</option> <option value="8">Networking, Server, and Protection</option> <option value="32">Multimedia and Games</option> <option value="50">System Administration</option> <option value="35">Other Architectures</option> </optgroup> <optgroup label="Arch-centric"> <option value="24">Announcements, Package &amp; Security Advisories</option> <option value="1">Arch Discussion</option> <option value="13">Forum &amp; Wiki discussion</option> </optgroup> <optgroup label="Pacman Upgrades, Packaging &amp; AUR"> <option value="44">Pacman &amp; Package Upgrade Issues</option> <option value="49">[testing] Repo Forum</option> <option value="4">Creating &amp; Modifying Packages</option> <option value="38">AUR Issues, Discussion &amp; PKGBUILD Requests</option> </optgroup> <optgroup label="Contributions &amp; Discussion"> <option value="20">GNU/Linux Discussion</option> <option value="27">Community Contributions</option> <option value="33">Programming &amp; Scripting</option> <option value="30">Other Languages</option> <option value="47">Artwork and Screenshots</option> <option value="42">Try This</option> </optgroup> <optgroup label="/dev/null"> <option value="29">Off-Topic</option> <option value="48" selected="selected">Topics Going Nowhere</option> <option value="36">Dustbin</option> </optgroup> </select></label> <input type="submit" value=" Go " accesskey="g" /> </div> </form> </div> <div class="conr"> <p id="feedlinks"><span class="atom"><a href="extern.php?action=feed&amp;tid=162768&amp;type=atom">Atom topic feed</a></span></p> <p id="poweredby">Powered by <a href="http://fluxbb.org/">FluxBB</a></p> </div> <div class="clearer"></div> </div> </div> </div> </div> <div class="end-box"></div> </div> </body> </html>
