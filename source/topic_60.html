<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"> <html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en" dir="ltr"> <head> <meta http-equiv="Content-Type" content="text/html; charset=utf-8" /> <title>KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9 (Page 60) / Topics Going Nowhere / Arch Linux Forums</title> <link rel="stylesheet" type="text/css" href="style/ArchLinux.css" /> <link rel="canonical" href="viewtopic.php?id=162768&amp;p=60" title="Page 60" /> <link rel="prev" href="viewtopic.php?id=162768&amp;p=59" title="Page 59" /> <link rel="next" href="viewtopic.php?id=162768&amp;p=61" title="Page 61" /> <link rel="alternate" type="application/atom+xml" href="extern.php?action=feed&amp;tid=162768&amp;type=atom" title="Atom topic feed" /> <link rel="stylesheet" media="screen" href="style/ArchLinux/arch.css?v=3" /> <link rel="stylesheet" media="screen" href="style/ArchLinux/archnavbar.css?v=2" /> <link rel="shortcut icon" href="style/ArchLinux/favicon.ico" /> </head> <body> <div id="archnavbar" class="anb-forum"> <div id="archnavbarlogo"><h1><a href="http://www.archlinux.org/">Arch Linux</a></h1></div> <div id="archnavbarmenu"> <ul id="archnavbarlist"> <li id="anb-home"><a href="http://www.archlinux.org/">Home</a></li><li id="anb-packages"><a href="http://www.archlinux.org/packages/">Packages</a></li><li id="anb-forums" class="anb-selected"><a href="https://bbs.archlinux.org/">Forums</a></li><li id="anb-wiki"><a href="https://wiki.archlinux.org/">Wiki</a></li><li id="anb-bugs"><a href="https://bugs.archlinux.org/">Bugs</a></li><li id="anb-aur"><a href="https://aur.archlinux.org/">AUR</a></li><li id="anb-download"><a href="http://www.archlinux.org/download/">Download</a></li> </ul> </div> </div> <div id="punviewtopic" class="pun"> <div class="top-box"></div> <div class="punwrap"> <div id="brdheader" class="block"> <div class="box"> <div id="brdmenu" class="inbox"> <ul> <li id="navindex" class="isactive"><a href="index.php">Index</a></li> <li id="navuserlist"><a href="userlist.php">User list</a></li> <li id="navsearch"><a href="search.php">Search</a></li> <li id="navprofile"><a href="profile.php?id=80749">Profile</a></li> <li id="navlogout"><a href="login.php?action=out&amp;id=80749&amp;csrf_token=5c20501ec397bb45ef8ee8c84db232c8d8e421c6">Logout</a></li> </ul> </div> <div id="brdwelcome" class="inbox"> <ul class="conl"> <li><span>Logged in as <strong>SXX</strong></span></li> <li><span>Last visit: 2015-08-16 12:20:09</span></li> </ul> <ul class="conr"> <li><span>Topics: <a href="search.php?action=show_replies" title="Find topics you have posted to.">Posted</a> | <a href="search.php?action=show_new" title="Find topics with new posts since your last visit.">New</a> | <a href="search.php?action=show_recent" title="Find topics with recent posts.">Active</a> | <a href="search.php?action=show_unanswered" title="Find topics with no replies.">Unanswered</a></span></li> </ul> <div class="clearer"></div> </div> </div> </div> <div id="brdmain"> <div class="linkst"> <div class="inbox crumbsplus"> <ul class="crumbs"> <li><a href="index.php">Index</a></li> <li><span>»&#160;</span><a href="viewforum.php?id=48">Topics Going Nowhere</a></li> <li><span>»&#160;</span><strong><a href="viewtopic.php?id=162768">KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</a></strong></li> </ul> <div class="pagepost"> <p class="pagelink conl"><span class="pages-label">Pages: </span><a rel="prev" class="item1" href="viewtopic.php?id=162768&amp;p=59">Previous</a> <a href="viewtopic.php?id=162768">1</a> <span class="spacer">…</span> <a href="viewtopic.php?id=162768&amp;p=58">58</a> <a href="viewtopic.php?id=162768&amp;p=59">59</a> <strong>60</strong> <a href="viewtopic.php?id=162768&amp;p=61">61</a> <a href="viewtopic.php?id=162768&amp;p=62">62</a> <span class="spacer">…</span> <a href="viewtopic.php?id=162768&amp;p=234">234</a> <a rel="next" href="viewtopic.php?id=162768&amp;p=61">Next</a></p> <p class="postlink conr">Topic closed</p> </div> <div class="clearer"></div> </div> </div> <div id="p1399977" class="blockpost rowodd blockpost1"> <h2><span><span class="conr">#1476</span> <a href="viewtopic.php?pid=1399977#p1399977">2014-04-03 00:32:31</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=79893">jonascj</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2014-02-28</span></dd> <dd><span>Posts: 13</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=79893">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <p>As much as I appreciate the original post for sharing information about this great setup, it is, to say the least, very confusing.</p><p>So I&#039;ve decided to do only what made sense and what could be confirmed elsewhere. See the below short story for a quick overview of my setup and my problem. See the long story for more in depth description: </p><p><strong>#### Short story</strong><br />I am trying to make this work with a minimum of configuration and alterations to different things. This is my setup:</p><p>Kernel: Stock 3.13.6 from Arch base install<br />QEMU: 1.7.0 installed via &#039;pacman -S qemu&#039;<br />Seabios:&#160; 1.7.3.1-2 (already installed, maybe a dependency of qemu)</p><p>PCI-stub or blacklisting: Neither (according to #kvm@irc.freenode.net it is not necessary, unbind is sufficient)</p><p>BOOT options: I have only added &quot;intel_iommu=on&quot; to my boot line in grub.cfg</p><p>I can sucessfully unbind the Radeon card and attach it to vfio-pci:</p><div class="codebox"><pre><code>[jonas@jonascj-pc ~]$ ls -la /sys/bus/pci/devices/0000\:01\:00.0/driver lrwxrwxrwx 1 root root 0 Apr 3 03:52 /sys/bus/pci/devices/0000:01:00.0/driver -&gt; ../../../../bus/pci/drivers/radeon [jonas@jonascj-pc ~]$ ls -la /sys/bus/pci/devices/0000\:01\:00.1/driver lrwxrwxrwx 1 root root 0 Apr 3 03:51 /sys/bus/pci/devices/0000:01:00.1/driver -&gt; ../../../../bus/pci/drivers/snd_hda_intel [jonas@jonascj-pc ~]$ sudo vfio-bind 0000:01:00.1 0000:01:00.0 [sudo] password for jonas: [jonas@jonascj-pc ~]$ ls -la /sys/bus/pci/devices/0000\:01\:00.0/driver lrwxrwxrwx 1 root root 0 Apr 3 03:53 /sys/bus/pci/devices/0000:01:00.0/driver -&gt; ../../../../bus/pci/drivers/vfio-pci [jonas@jonascj-pc ~]$ ls -la /sys/bus/pci/devices/0000\:01\:00.1/driver lrwxrwxrwx 1 root root 0 Apr 3 03:53 /sys/bus/pci/devices/0000:01:00.1/driver -&gt; ../../../../bus/pci/drivers/vfio-pci [jonas@jonascj-pc ~]$</code></pre></div><p>I am testing with this script:</p><div class="codebox"><pre><code>#!/bin/bash qemu-system-x86_64 -enable-kvm -M q35 -m 1024 -cpu host \ -smp 6,sockets=1,cores=6,threads=1 \ -bios /usr/share/qemu/bios.bin -vga none \ -device ioh3420,bus=pcie.0,addr=1c.0,multifunction=on,port=1,chassis=1,id=root.1 \ -device vfio-pci,host=01:00.0,bus=root.1,addr=00.0,multifunction=on,x-vga=on \ -device vfio-pci,host=01:00.1,bus=root.1,addr=00.1</code></pre></div><p>I get a blank window on the host and the monitor connected to my radeon card goes from its standby-mode (blinking led and pitch black screen / no backlight) to its there-is-signal-mode (constant led and lighter black / backlight on). The image on my host monitor (displaying my terminal, blank qemu window etc.) gets miscolored. If I change to tty2 and back to tty1 (ctrl+alt+f2 -&gt; ctrl+alt+f1) the miscoloration disappears but the Radeon screen stays blank and so does the qemu window on the host.</p><p><span style="color: #FF0000"> If I use the kernel from the original post I get output on the Radeon monitor. So the difference seems to be solely with the kernel. Which of those provided patches might be the needed one and where can I find more information about it? I do not like to blindly accept this preconfigured kernel with patches from who knows where. I think I&#039;ve already shown (see long story for details) that quite a few things listd in the original post is not necessary and so have other people posting replies. Maybe only a single patch to the kernel is necessary? </span></p><p><strong>#### Long story</strong><br /><strong>## Software requirements</strong></p><div class="quotebox"><cite>nbhs wrote:</cite><blockquote><div><p><strong>Ingredients</strong></p><ul><li><p><a href="http://www.fileswap.com/dl/tpEVe6aHkq/" rel="nofollow">qemu-git.tar.gz</a></p></li><li><p><a href="http://www.fileswap.com/dl/EJUU9jNeFe/" rel="nofollow">seabios-git.tar.gz</a></p></li><li><p><a href="http://www.fileswap.com/dl/RhitMlp8O1/" rel="nofollow">linux-mainline.tar.gz</a> (3.13.6 includes acs override patch, i935 vga arbiter fixes, memleak fix by xani, debug registers patch)</p></li></ul><p>You can also use these packages from AUR but you might run into problems:</p><ul><li><p><a href="https://aur.archlinux.org/packages/qemu-git" rel="nofollow">qemu-git</a></p></li><li><p><a href="https://aur.archlinux.org/packages/linux-mainline/" rel="nofollow">linux-mainline</a></p></li></ul><ol class="decimal"><li><p>A kernel &gt;= 3.9 (consider using kernel 3.12.0 or later)&#160; is required&#160; or if you&#039;re building it yourself it must be configured with the following:</p><ul><li><p>CONFIG_VFIO_IOMMU_TYPE1=y</p></li><li><p>CONFIG_VFIO=y</p></li><li><p>CONFIG_VFIO_PCI=y</p></li><li><p>CONFIG_VFIO_PCI_VGA=y</p></li></ul></li><li><p>You&#039;ll need qemu &gt;= 1.5.0 (consider using qemu 1.7 or later)&#160; or qemu-git</p></li><li><p>And seabios</p></li></ol></div></blockquote></div><p>Why is there two or three lists here without any clear separation?</p><p>I have chosen to use the stock kernel 3.13.6 which came with my base installation of Arch.</p><p>This kernel is / was configured as (according to &#039;zless /proc/config.gz&#039;)</p><div class="codebox"><pre><code>CONFIG_VFIO_IOMMU_TYPE1=m CONFIG_VFIO=m CONFIG_VFIO_PCI=m CONFIG_VFIO_PCI_VGA=y</code></pre></div><p>(Note the three <strong>m</strong>&#039;s, not y&#039;s)</p><p>For qemu I&#039;ve just installed the one from the official repo (&#039;pacman -S qemu&#039;). This is <strong>qemu 1.7.0</strong> according to &#039;qemu-system-x86_64 -version&#039;.</p><p>For seabios I&#039;ve just used the version which was already installed (maybe it was installed as a requirement of qemu): <strong>seabios-1.7.3.1-2</strong>.</p><br /><p><strong>## Preparing the GPU for vfio binding</strong></p><div class="quotebox"><cite>nbhs wrote:</cite><blockquote><div><p><strong>Preparing the GPU so we can bind it to vfio</strong></p><p>For the next step we need to:</p><ol class="decimal"><li><p>Blacklist radeon or nouveau or nvidia or fglrx on /etc/modprobe.d/blacklist.conf </p><p>Example, blacklisting the opensource radeon module:</p><div class="codebox"><pre><code>echo &quot;blacklist radeon&quot; &gt;&gt; /etc/modprobe.d/blacklist.conf </code></pre></div></li><li><p>Use pci-stub</p><p>In my case since i have 2 radeon cards blacklisting the radeon module is not an option, so i use pci-stub.</p><p>NOTE: If pci-stub was built as a module, you&#039;ll need to modify /etc/mkinitcpio.conf and add pci-stub in the MODULES section, after that you need to update your initramfs like this.</p><div class="codebox"><pre><code>mkinitcpio -p linux-mainline</code></pre></div><p>lspci </p><div class="codebox"><pre><code>07:00.0 VGA compatible controller: Advanced Micro Devices, Inc. [AMD/ATI] Cayman PRO [Radeon HD 6950] &lt;-- radeon 6950 07:00.1 Audio device: Advanced Micro Devices, Inc. [AMD/ATI] Cayman/Antilles HDMI Audio [Radeon HD 6900 Series] &lt;-- radeon 6950 audio</code></pre></div><p>lspci -n</p><div class="codebox"><pre><code>07:00.0 0300: 1002:6719 &lt;-- radeon 6950 07:00.1 0403: 1002:aa80 &lt;-- radeon 6950 audio</code></pre></div><p>Now add this to your grub cfg file:</p><div class="codebox"><pre><code>pci-stub.ids=1002:6719,1002:aa80</code></pre></div><p>dmesg | grep pci-stub</p><div class="codebox"><pre><code>[ 2.096151] pci-stub: add 1002:6719 sub=FFFFFFFF:FFFFFFFF cls=00000000/00000000 [ 2.096160] pci-stub 0000:07:00.0: claimed by stub [ 2.096165] pci-stub: add 1002:AA80 sub=FFFFFFFF:FFFFFFFF cls=00000000/00000000 [ 2.096174] pci-stub 0000:07:00.1: claimed by stub [ 2.096178] pci-stub: add 1B21:1042 sub=FFFFFFFF:FFFFFFFF cls=00000000/00000000</code></pre></div></li></ol></div></blockquote></div><p>According to to people in #kvm@irc.freenode.net it is not necessary to blacklist modules or attach the device (gfx card) to pci-stub before attaching it to vfio-pci. It should be sufficient to unbind it which is already done in/by the vfio-bind script (see next section).</p><p>Do you guys still think this is necessary? I haven&#039;t been able to confirm this anywhere else.</p><p><strong>## Setting up vfio and kvm modules</strong></p><div class="quotebox"><cite>nbhs wrote:</cite><blockquote><div><p><strong>Setting up vfio and kvm modules</strong></p><p>If your board doesn&#039;t enable interrupt remapping, you need to add this to your grub cfg:</p><div class="codebox"><pre><code>vfio_iommu_type1.allow_unsafe_interrupts=1</code></pre></div><p>Or if vfio-pci was built as a module ( default on arch )</p><div class="codebox"><pre><code>echo &quot;options vfio_iommu_type1 allow_unsafe_interrupts=1&quot; &gt; /etc/modprobe.d/vfio_iommu_type1.conf</code></pre></div><p>Some applications like Passmark Performance Test and SiSoftware Sandra crash the VM without this:</p><div class="codebox"><pre><code>echo &quot;options kvm ignore_msrs=1&quot; &gt;&gt; /etc/modprobe.d/kvm.conf</code></pre></div></div></blockquote></div><p>I don&#039;t know about this. I have no idea how to verify if my board enables interrupt remapping or not. According to <a href="http://www.linux-kvm.org/page/How_to_assign_devices_with_VT-d_in_KVM" rel="nofollow">http://www.linux-kvm.org/page/How_to_as … T-d_in_KVM</a> (&#039;dmesg | grep -e DMAR -e IOMMU&#039;) IOMMU is enabled.</p><p>Anyone who knows how to find out if these options are needed (i.e. how to verify if interrupt remapping is enabled)?</p><p><strong>## Binding a device to vfio-pci</strong></p><div class="quotebox"><cite>nbhs wrote:</cite><blockquote><div><p><strong>Binding a device to vfio-pci</strong></p><p>Assuming the kernel, qemu and seabios are built and working, lets bind some devices.<br />You can use this script to make life easier:</p><div class="codebox"><pre><code>#!/bin/bash modprobe vfio-pci for dev in &quot;$@&quot;; do vendor=$(cat /sys/bus/pci/devices/$dev/vendor) device=$(cat /sys/bus/pci/devices/$dev/device) if [ -e /sys/bus/pci/devices/$dev/driver ]; then echo $dev &gt; /sys/bus/pci/devices/$dev/driver/unbind fi echo $vendor $device &gt; /sys/bus/pci/drivers/vfio-pci/new_id done</code></pre></div><p>Save it as /usr/bin/vfio-bind</p><div class="codebox"><pre><code>chmod 755 /usr/bin/vfio-bind</code></pre></div><p>Bind the GPU:</p><div class="codebox"><pre><code>vfio-bind 0000:07:00.0 0000:07:00.1</code></pre></div></div></blockquote></div><p>This here makes really good sense. The script unbinds the device (gfx card) if it is already attached to a driver and afterwards it attaches it to vfio-pci.</p><p>I would say this works perfectly for me. This is my lspci output:</p><div class="codebox"><pre><code>[jonas@jonascj-pc ~]$ lspci | grep -i radeon 01:00.0 VGA compatible controller: Advanced Micro Devices, Inc. [AMD/ATI] Tahiti XT [Radeon HD 7970] 01:00.1 Audio device: Advanced Micro Devices, Inc. [AMD/ATI] Tahiti XT HDMI Audio [Radeon HD 7970 Series]</code></pre></div><p>After booting my stock kernel without any blacklisting or pci-stub&#039;ing I can see the Radeon devices attached to one driver and after doing vfio-bind they are attached to vfio-pci:</p><div class="codebox"><pre><code>[jonas@jonascj-pc ~]$ ls -la /sys/bus/pci/devices/0000\:01\:00.0/driver lrwxrwxrwx 1 root root 0 Apr 3 03:52 /sys/bus/pci/devices/0000:01:00.0/driver -&gt; ../../../../bus/pci/drivers/radeon [jonas@jonascj-pc ~]$ ls -la /sys/bus/pci/devices/0000\:01\:00.1/driver lrwxrwxrwx 1 root root 0 Apr 3 03:51 /sys/bus/pci/devices/0000:01:00.1/driver -&gt; ../../../../bus/pci/drivers/snd_hda_intel [jonas@jonascj-pc ~]$ sudo vfio-bind 0000:01:00.1 0000:01:00.0 [sudo] password for jonas: [jonas@jonascj-pc ~]$ ls -la /sys/bus/pci/devices/0000\:01\:00.0/driver lrwxrwxrwx 1 root root 0 Apr 3 03:53 /sys/bus/pci/devices/0000:01:00.0/driver -&gt; ../../../../bus/pci/drivers/vfio-pci [jonas@jonascj-pc ~]$ ls -la /sys/bus/pci/devices/0000\:01\:00.1/driver lrwxrwxrwx 1 root root 0 Apr 3 03:53 /sys/bus/pci/devices/0000:01:00.1/driver -&gt; ../../../../bus/pci/drivers/vfio-pci [jonas@jonascj-pc ~]$</code></pre></div><br /><p><strong>## Testing if its working out</strong></p><div class="quotebox"><cite>nbhs wrote:</cite><blockquote><div><p><strong>Testing if its working out</strong></p><p>Lets test if its working, as root:</p><div class="codebox"><pre><code>qemu-system-x86_64 -enable-kvm -M q35 -m 1024 -cpu host \ -smp 6,sockets=1,cores=6,threads=1 \ -bios /usr/share/qemu/bios.bin -vga none \ -device ioh3420,bus=pcie.0,addr=1c.0,multifunction=on,port=1,chassis=1,id=root.1 \ -device vfio-pci,host=07:00.0,bus=root.1,addr=00.0,multifunction=on,x-vga=on \ -device vfio-pci,host=07:00.1,bus=root.1,addr=00.1</code></pre></div><p>NOTE: -m | VM memory<br />NOTE: -cpu host | Expose host cpu features.<br />NOTE: -smp 6,sockets=1,cores=6,threads=1 | Expose 1 cpu with 6 cores and 1 thread each.<br />NOTE: -bios | Bios image to load.<br />NOTE: -vga none | Disable cirrus emulated vga.<br />NOTE: -m q35 | Enable the new q35 emulated chipset, qemu defaults to the old i440fx chipset.</p><p>You should see a black qemu window on your main display, and seabios ouput on your monitor from your passthru&#039;d card saying it cant find anything to boot.<br />Its important to use -M q35 which is the new qemu emulated intel chipset with pcie support, <br />&quot;-device ioh3420,bus=pcie.0,addr=1c.0,multifunction=on,port=1,chassis=1,id=root.1&quot; creates a pcie root port and we attach our gpu to it. <br />We must also use x-vga=on option on our gpu (and -vga none) otherwise it wont work</p><p>If you&#039;re using an intel cpu and nothing happens try this:</p><div class="codebox"><pre><code>modprobe -r kvm_intel modprobe kvm_intel emulate_invalid_guest_state=0</code></pre></div><p>NOTE: There might be some problems using nvidia/fglrx/nouveau drivers on the host gpu, see the ISSUES section below on how to solve this.</p></div></blockquote></div><p>I am testing with this script:</p><div class="codebox"><pre><code>#!/bin/bash qemu-system-x86_64 -enable-kvm -M q35 -m 1024 -cpu host \ -smp 6,sockets=1,cores=6,threads=1 \ -bios /usr/share/qemu/bios.bin -vga none \ -device ioh3420,bus=pcie.0,addr=1c.0,multifunction=on,port=1,chassis=1,id=root.1 \ -device vfio-pci,host=01:00.0,bus=root.1,addr=00.0,multifunction=on,x-vga=on \ -device vfio-pci,host=01:00.1,bus=root.1,addr=00.1</code></pre></div><p>I get a blank window on the host and the monitor connected to my radeon card goes from its standby-mode (blinking led and pitch black screen / no backlight) to its there-is-signal-mode (constant led and lighter black / backlight on). The image on my host monitor (displaying my terminal, blank qemu window etc.) gets miscolored. If I change to tty2 and back to tty1 (ctrl+alt+f2 -&gt; ctrl+alt+f1) the miscoloration disappears but the Radeon screen stays blank and so does the qemu window on the host.</p> <p class="postedit"><em>Last edited by jonascj (2014-04-03 01:10:42)</em></p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1399977">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1400142" class="blockpost roweven"> <h2><span><span class="conr">#1477</span> <a href="viewtopic.php?pid=1400142#p1400142">2014-04-03 10:19:42</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=79893">jonascj</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2014-02-28</span></dd> <dd><span>Posts: 13</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=79893">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>etcet wrote:</cite><blockquote><div><p>Thanks to nbhs and everyone else involved in this thread, I&#039;ve got VGA passthrough working using this guide with the following setup:</p><p>Intel 4770<br />Asus Z87-Plus<br />Gigabyte &quot;Windforce&quot; GTX 770 GV-N770OC-2GD</p><p>I&#039;m starting X with the onboard Intel GPU and getting near native Windows performance on a passthroughed 770.</p><p>For others and my future self, here are the steps involved. I think this is everything:</p><p>Install qemu-git<br />Install seabios-git</p><p>The i915 kernel patch is required. I couldn&#039;t get the provided mainline kernel to work. I built the latest kernel and added the i915 patch with the following:</p><div class="codebox"><pre><code>pacman -S abs base-devel ABSROOT=. abs core/linux cd core/linux/ wget https://gist.githubusercontent.com/anonymous/732acf9551136a78e91b/raw/5b97d50e7fb7faced258ad8948b7a82127d25f31/i915_313rc4.patch wget https://gist.githubusercontent.com/etcet/9864922/raw/e49d204ddaf2d6130c91d94d0ce6a9123c6197cb/i915-pkgbuild.patch patch -p3 &lt; i915-pkgbuild.patch makepkg pacman -U linux-i915-headers-3.13.7-1-x86_64.pkg.tar.xz pacman -U linux-i915-3.13.7-1-x86_64.pkg.tar.xz</code></pre></div><p>More: <a href="https://wiki.archlinux.org/index.php/Kernels/Compilation/Arch_Build_System" rel="nofollow">https://wiki.archlinux.org/index.php/Ke … ild_System</a></p></div></blockquote></div><p>Hi etcet</p><p>I am trying to figure out what the minimum requirements in terms of patches and configuration is (for my setup, I cannot test other setups). </p><p>My setup is very similar to yours: <br />Z87 chipset (Asrock Z87M Extreme 4)<br />Intel Core i7 4770, <br />Intel integrated gpu for the host<br />A single dedicated card (Radeon R9 280X / HD7970)</p><p>So far I&#039;ve gotten output on my monitor connected to the dedicated card with these steps:</p><ol class="decimal"><li><p>Use main line kernel provided by OP</p></li><li><p>Use qemu and seabios from offical repo (&#039;pacman -S qemu seabios) which results in qemu 1.7.0 and seabios 1.7.3.1-2</p></li><li><p>vfio-bind 0000:01:00.0 0000:01:00.1&#160; &#160; (no pci-stub or blacklisting) </p></li><li><p>Test with this script and I get seabios output on the monitor connected to the dedicated card:</p><div class="codebox"><pre><code>#!/bin/bash qemu-system-x86_64 -enable-kvm -M q35 -m 1024 -cpu host \ -smp 6,sockets=1,cores=6,threads=1 \ -bios /usr/share/qemu/bios.bin -vga none \ -device ioh3420,bus=pcie.0,addr=1c.0,multifunction=on,port=1,chassis=1,id=root.1 \ -device vfio-pci,host=01:00.0,bus=root.1,addr=00.0,multifunction=on,x-vga=on \ -device vfio-pci,host=01:00.1,bus=root.1,addr=00.1</code></pre></div></li></ol><p>Now I just wonder what the minimum requirements for the kernel is. The stock 3.13.6 kernel (from an Arch base-install) does not work. It gives me blank screen on the monitor connected to the dedicated card and miscolors my host display (the Intel integrated gpu). Then&#160; saw your post about &quot;the i915 patch is needed&quot; and thought maybe that is my minimum requirement.</p><p>But how did you know what the &quot;i915 kernel patch&quot; is and where to obtain it? You use these patches (one for the kernel code itself and one for the pkgbuild file):<br /><a href="https://gist.githubusercontent.com/anonymous/732acf9551136a78e91b/raw/5b97d50e7fb7faced258ad8948b7a82127d25f31/i915_313rc4.patch" rel="nofollow">https://gist.githubusercontent.com/anon … 3rc4.patch</a><br /><a href="https://gist.githubusercontent.com/etcet/9864922/raw/e49d204ddaf2d6130c91d94d0ce6a9123c6197cb/i915-pkgbuild.patch" rel="nofollow">https://gist.githubusercontent.com/etce … uild.patch</a></p><p>How did you find those patches, who made them, where do you plan on finding updates to those if you suddenly decide to upgrade your kernel in a few months?</p><p><span style="color: #ff0000"> Edit: I have patched the 3.13.8 core kernel with the two patches you linked in your post, build it, booted it and it works (i.e. gives me seabios output on the monitor connected to the dedicated Radeon card). So this seems to be the only patching to the kernel I need (I of course haven&#039;t gone any further in the process - installing windows, drivers, played games etc. - maybe I need more patches later on due to performance etc.). The question remains the same though - where do these patches come from etc.?</span></p><p>Best regards<br />Jonas</p> <p class="postedit"><em>Last edited by jonascj (2014-04-03 12:05:06)</em></p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1400142">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1400163" class="blockpost rowodd"> <h2><span><span class="conr">#1478</span> <a href="viewtopic.php?pid=1400163#p1400163">2014-04-03 11:59:30</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=80279">novist</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2014-03-14</span></dd> <dd><span>Posts: 34</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=80279">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <p>headsup - some kvm improvements at <a href="http://lkml.iu.edu/hypermail/linux/kernel/1403.3/03070.html" rel="nofollow">http://lkml.iu.edu/hypermail/linux/kern … 03070.html</a></p><div class="quotebox"><blockquote><div><p>For x86 there are optimizations for debug registers, which trigger on<br />some Windows games, and other important fixes for Windows guests. We now<br />expose to the guest Broadwell instruction set extensions and also Intel<br />MPX. There&#039;s also a fix/workaround for OS X guests, nested virtualization<br />features (preemption timer), and a couple kvmclock refinements.</p></div></blockquote></div><p>Cant test myself just yet</p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1400163">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1400212" class="blockpost roweven"> <h2><span><span class="conr">#1479</span> <a href="viewtopic.php?pid=1400212#p1400212">2014-04-03 15:00:36</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=75590">aw</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2013-10-04</span></dd> <dd><span>Posts: 921</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=75590">Email</a></span> <span class="website"><a href="http://vfio.blogspot.com/" rel="nofollow">Website</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>jonascj wrote:</cite><blockquote><div><p><span style="color: #ff0000"> Edit: I have patched the 3.13.8 core kernel with the two patches you linked in your post, build it, booted it and it works (i.e. gives me seabios output on the monitor connected to the dedicated Radeon card). So this seems to be the only patching to the kernel I need (I of course haven&#039;t gone any further in the process - installing windows, drivers, played games etc. - maybe I need more patches later on due to performance etc.). The question remains the same though - where do these patches come from etc.?</span></p></div></blockquote></div><p>They come from here:</p><p><a href="http://git.kernel.org/cgit/linux/kernel/git/torvalds/linux.git/commit/?id=81b5c7bc8de3e6f63419139c2fc91bf81dea8a7d" rel="nofollow">http://git.kernel.org/cgit/linux/kernel … f81dea8a7d</a><br /><a href="http://git.kernel.org/cgit/linux/kernel/git/torvalds/linux.git/commit/?id=6e1b4fdad5157bb9e88777d525704aba24389bee" rel="nofollow">http://git.kernel.org/cgit/linux/kernel … ba24389bee</a></p><p>And I agree, they should really be the only patches required and hopefully none are required if you don&#039;t have Intel graphics in your system.&#160; Some people are experiencing problems with memory being freed and apply another patch, I suspect that has something to do with the toolchain they&#039;re using to build.&#160; The other popular patch is the ACS override, which allows devices to be separated out of IOMMU groups.&#160; There&#039;s code going into 3.15 to help many Intel chipsets with this problem and I just posted a patch this week that adds IDs for X79 that will hopefully also make 3.15.</p><p>Why are the &quot;i915 patches&quot; needed and why aren&#039;t they upstream?&#160; VGA is a very old standard and was an evolution of things like EGA and CGA.&#160; It was developed back when you were lucky to have one graphics card and ROMs were a new thing.&#160; Like many legacy things, it stuck because it was widely supported and there was nothing better.&#160; One of the problems with VGA is that it lives at a fixed address and only one device can occupy that address space at a time.&#160; PCI attempts to solve this problem by having a VGA enable bit in bridges allowing the chipset to select which single device receives VGA accesses.&#160; There are still complications when two VGA devices live on the same bus, but I&#039;ll skip as it&#039;s not important here.&#160; To manage where VGA is routed we have something in the kernel called the VGA arbiter.&#160; The arbiter requires that any access to VGA space be wrapped in locking that allows the arbiter to switch chipset routing.&#160; When you specify x-vga=on for a device then the vfio-pci driver will claim accesses to the VGA space and forward them to the vfio-pci kernel module, which does this locking.&#160; If everyone plays nice with the VGA arbiter, things work.</p><p>The trouble is that not everyone place nice, some drivers don&#039;t play at all.&#160; The vgacon driver in the kernel doesn&#039;t participate in VGA arbitration.&#160; The i915 driver lies and claims that it doesn&#039;t claim VGA accesses, effectively an opt-out of arbitration, while actually it does claim VGA accesses.&#160; This means that our VM comes along and does a VGA access, it gets forwarded to the kernel and vfio takes the VGA arbiter lock, the arbiter sees that i915 doesn&#039;t claim VGA and the VGA enable bit is set on the bridge for our device and proceeds to give us the lock.&#160; Our access then goes straight to i915.&#160; This is the reason you see both the corruption on the host display and lack of anything happening on the guest display, the accesses are going to the wrong card.</p><p>The first patch above fixes this, making i915 play correctly with VGA arbitration and the second patch cleans up some ordering to avoid a big white box drawn on the screen.&#160; It works and makes everyone happy... except Xorg on the host.&#160; The DRI code in Xorg, so I&#039;m told, wants to mmap(2) VGA MMIO space.&#160; Doing so is incompatible with the VGA arbiter because Xorg would need to hold the VGA arbitration lock for the life of that mmap, effectively a permanent lock.&#160; At that point VGA arbitration is deadlocked.&#160; Rather than do that, Xorg detects that there are multiple VGA devices and disables DRI.&#160; The result is that making i915 not lie about its VGA usage kills desktop performance for anyone with multiple graphics cards.&#160; This is the reason the two patches were reverted.</p><p>Solutions to this are:<br /> a) don&#039;t use VGA space in the guest (DanaGoyette attempted to do this using UEFI/OVMF in place of Seabios, also accomplished on some cards using assigned graphics as a secondary device)<br /> b) create a VGA arbiter interface that would allow mmaps (I have some prototype code to do this, but I don&#039;t have time to figure out how to make Xorg use it)<br /> c) figure out why DRI wants to mmap VGA space and avoid it<br /> d) your idea here</p><p>On the subject of whether you need to blacklist or otherwise avoid allowing the graphics device to attach to host drivers before you unbind it for the guest, it&#039;s a matter of personal preference and host driver capabilities.&#160; In the non-graphics case of PCI device assignment, it&#039;s not needed because Linux has pretty good support for hotplug and thus the bugs have been worked out for detaching and re-attaching devices from drivers.&#160; The hotplug story for graphics cards on Linux has not been as good, so those drivers tend to lag in reliably and cleanly releasing the device.&#160; The nvidia proprietary driver for instance will allow you to unbind the driver with X up and running on the device and X continues to run after unbind.&#160; I filed a bug with Nvidia about this, but they already closed it with no code change.&#160; If you have no intention of using the device in the host, it&#039;s often the safest and easiest path just to blacklist the driver or force it to bind to pci-stub.&#160; If unbinding works for you, do it.</p> </div> <div class="postsignature postmsg"><hr /><p><a href="http://vfio.blogspot.com" rel="nofollow">http://vfio.blogspot.com</a><br />Looking for a more open forum to discuss vfio related uses?&#160; Try <a href="https://www.redhat.com/mailman/listinfo/vfio-users" rel="nofollow">https://www.redhat.com/mailman/listinfo/vfio-users</a></p></div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1400212">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1400288" class="blockpost rowodd"> <h2><span><span class="conr">#1480</span> <a href="viewtopic.php?pid=1400288#p1400288">2014-04-03 18:18:15</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=70922">nbhs</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd class="postavatar"><img src="https://bbs.archlinux.org/img/avatars/70922.jpg?m=1367773811" width="80" height="80" alt="" /></dd> <dd><span>From: Montevideo, Uruguay</span></dd> <dd><span>Registered: 2013-05-02</span></dd> <dd><span>Posts: 402</span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <p>Kernel 3.14 is up on the front page</p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1400288">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1400328" class="blockpost roweven"> <h2><span><span class="conr">#1481</span> <a href="viewtopic.php?pid=1400328#p1400328">2014-04-03 19:57:02</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=80830">gneville</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2014-04-02</span></dd> <dd><span>Posts: 27</span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <p>Just tried the linux-mainline 3.14 Kernel on the OP as posted by nbhs, still hasn&#039;t resolved my issue however I now see some interesting messages in dmesg. I still get video output and can install windows etc however drivers won&#039;t install and even while booting windows I get these messages. Tested with multiple qemu versions as well:</p><p>VM starts fine, video displays, I see these messages as always:</p><div class="quotebox"><blockquote><div><p>[&#160; 351.920675] vfio_ecap_init: 0000:01:00.0 hiding ecap 0x19@0x270<br />[&#160; 351.920684] vfio_ecap_init: 0000:01:00.0 hiding ecap 0x1b@0x2d0</p></div></blockquote></div><p>Then all of a sudden dmesg gets flooded with this:</p><div class="quotebox"><blockquote><div><p>[&#160; 377.186286] ------------[ cut here ]------------<br />[&#160; 377.186288] WARNING: CPU: 3 PID: 618 at arch/x86/kvm/x86.c:1114 kvm_get_msr_common+0x793/0x960 [kvm]()<br />[&#160; 377.186288] Modules linked in: tun vfio_pci vfio_iommu_type1 vfio bridge stp llc snd_hda_codec_realtek snd_hda_codec_generic dm_mod coretemp x86_pkg_temp_thermal intel_powerclamp kvm_intel kvm crct10dif_pclmul crc32_pclmul crc32c_intel joydev ghash_clmulni_intel mousedev iTCO_wdt aesni_intel btusb iTCO_vendor_support bluetooth aes_x86_64 lrw gf128mul glue_helper ablk_helper cryptd 6lowpan_iphc xpad ff_memless rfkill microcode snd_hda_intel led_class hid_generic snd_hda_codec igb snd_hwdep e1000e snd_pcm hwmon psmouse dca serio_raw snd_timer mei_me pcspkr lpc_ich i2c_i801 ptp snd pps_core mei soundcore fan thermal battery evdev shpchp mac_hid processor nfs lockd sunrpc fscache usbhid hid sd_mod crc_t10dif crct10dif_common ata_generic pata_acpi atkbd libps2 ata_piix libata ehci_pci xhci_hcd ehci_hcd<br />[&#160; 377.186305]&#160; scsi_mod usbcore usb_common i8042 serio pci_stub vfat fat ext4 crc16 mbcache jbd2 i915 video button intel_gtt i2c_algo_bit drm_kms_helper drm i2c_core<br />[&#160; 377.186309] CPU: 3 PID: 618 Comm: qemu-system-x86 Tainted: G&#160; &#160; &#160; &#160; W&#160; &#160; 3.14.0-2-mainline #1<br />[&#160; 377.186310] Hardware name:&#160; &#160; / , BIOS 4.6.5 07/26/2013<br />[&#160; 377.186310]&#160; 0000000000000009 ffff880415a81c10 ffffffff814d563c 0000000000000000<br />[&#160; 377.186312]&#160; ffff880415a81c48 ffffffff81064f1d 0000000040000020 ffff880415a81cd8<br />[&#160; 377.186313]&#160; ffff880413bd3ec0 ffff8803378a4000 ffff8803378a4040 ffff880415a81c58<br />[&#160; 377.186314] Call Trace:<br />[&#160; 377.186315]&#160; [&lt;ffffffff814d563c&gt;] dump_stack+0x4d/0x6f<br />[&#160; 377.186316]&#160; [&lt;ffffffff81064f1d&gt;] warn_slowpath_common+0x7d/0xa0<br />[&#160; 377.186317]&#160; [&lt;ffffffff81064ffa&gt;] warn_slowpath_null+0x1a/0x20<br />[&#160; 377.186320]&#160; [&lt;ffffffffa0efa453&gt;] kvm_get_msr_common+0x793/0x960 [kvm]<br />[&#160; 377.186322]&#160; [&lt;ffffffffa13170c2&gt;] vmx_get_msr+0x102/0x370 [kvm_intel]<br />[&#160; 377.186323]&#160; [&lt;ffffffffa131735a&gt;] handle_rdmsr+0x2a/0x140 [kvm_intel]<br />[&#160; 377.186325]&#160; [&lt;ffffffffa131c9a5&gt;] vmx_handle_exit+0xb5/0xa20 [kvm_intel]<br />[&#160; 377.186326]&#160; [&lt;ffffffff81074c02&gt;] ? __set_task_blocked+0x32/0x70<br />[&#160; 377.186328]&#160; [&lt;ffffffffa1314360&gt;] ? vmx_invpcid_supported+0x20/0x20 [kvm_intel]<br />[&#160; 377.186330]&#160; [&lt;ffffffffa0effb60&gt;] kvm_arch_vcpu_ioctl_run+0xc70/0x11c0 [kvm]<br />[&#160; 377.186333]&#160; [&lt;ffffffffa0efb85e&gt;] ? kvm_arch_vcpu_load+0x4e/0x1e0 [kvm]<br />[&#160; 377.186336]&#160; [&lt;ffffffffa0ee85c2&gt;] kvm_vcpu_ioctl+0x2b2/0x5b0 [kvm]<br />[&#160; 377.186336] systemd-journald[168]: /dev/kmsg buffer overrun, some messages lost.<br />[&#160; 377.186338]&#160; [&lt;ffffffff811e4ab8&gt;] ? fsnotify+0x228/0x2f0<br />[&#160; 377.186340]&#160; [&lt;ffffffff810a9bb8&gt;] ? __wake_up_locked_key+0x18/0x20<br />[&#160; 377.186341]&#160; [&lt;ffffffff811b6180&gt;] do_vfs_ioctl+0x2e0/0x4c0<br />[&#160; 377.186342]&#160; [&lt;ffffffff811bff9e&gt;] ? __fget+0x6e/0xb0<br />[&#160; 377.186344]&#160; [&lt;ffffffff811b63e1&gt;] SyS_ioctl+0x81/0xa0<br />[&#160; 377.186345]&#160; [&lt;ffffffff814e3069&gt;] system_call_fastpath+0x16/0x1b<br />[&#160; 377.186346] ---[ end trace 73327e2f3359a7b9 ]---<br />[&#160; 377.186413] systemd-journald[168]: /dev/kmsg buffer overrun, some messages lost.</p></div></blockquote></div><br /><br /><br /><br /><div class="quotebox"><cite>gneville wrote:</cite><blockquote><div><p>On top of this I have just installed the OP linux-mainline (3.13.6-1-mainline),seabios (1.7.4.r1788.g8abc6a8-1) &amp; qemu (2.0.r31714.g03d5142-1) versions (Just added reset patch and manually compiled (<a href="https://lists.gnu.org/archive/html/qemu-devel/2014-02/msg00767.html)" rel="nofollow">https://lists.gnu.org/archive/html/qemu … 0767.html)</a>)</p><p>and still no change <img src="https://bbs.archlinux.org/img/smilies/sad.png" width="15" height="15" alt="sad" /></p><br /><br /><div class="quotebox"><cite>gneville wrote:</cite><blockquote><div><p>Hi All,</p><p>I&#039;m hoping someone will be able to help me out please. I&#039;ve been trying to get vga passthrough working with qemu and vfio for a few months on and off but having no luck. I&#039;m getting similar problems to users redger &amp; DanaGoyette.</p><p>My hardware: CPU: i7 4770s, MB: Jetway NF9J-Q87 GFX: AMD R9 290</p><p>I used to use Xen 4.3 and had vga passthrough working just passing through the intel hd4600 controller to hosts, but since I got the AMD R9 290 card Xen doesn&#039;t seem to passthrough the card whatsoever, so thought I would try qemu and vfio.</p><p>I&#039;ve tried using different linux versions and qemu versions but not having much luck. I am able to successfully vfio-bind my gfx card and I can start QEMU and get video via the GFX Card HDMI cable, I&#039;m also able to successfully install Windows 8.1. However after installation I&#039;m getting problems with either windows installing the amd drivers or using the catalyst driver installer, the host just reboots.</p><p>My latest setup:</p><p>linux 3.13.7-1 + i915 patch<br />Seabios git 1.7.4-66 (31Mar14)<br />Qemu 2.0.0 RC0 + patched pcibus_reset &amp; assertion (<a href="https://lists.nongnu.org/archive/html/qemu-devel/2014-03/msg05901.html" rel="nofollow">https://lists.nongnu.org/archive/html/q … 05901.html</a> &amp; <a href="https://lists.gnu.org/archive/html/qemu-devel/2014-02/msg00767.html" rel="nofollow">https://lists.gnu.org/archive/html/qemu … 00767.html</a>)</p><p>Before the pcibus_reset patch I kept getting the following messages when the host rebooted while trying to install the drivers:</p><div class="quotebox"><blockquote><div><p>&quot;qemu-system-x86_64 shows: hw/pci/pci.c:250: pcibus_reset: Assertion `bus-&gt;irq_count[\i] == 0&#039; failed.&quot;</p></div></blockquote></div><div class="quotebox"><blockquote><div><p>dmesg shows:&#160; 2805.839608 vfio-pci 0000:01:00.0: irq 46 for MSI/MSI-X</p></div></blockquote></div><br /><p>After applying the pcibust_reset patch the host no longer reboots after installing the drivers however the screen just goes blank so I have to manually kill the host. I do see the following messages:</p><div class="quotebox"><blockquote><div><p>qemu-system-x86_64 shows: ehci warning: guest updated active QH</p></div></blockquote></div><div class="quotebox"><blockquote><div><p>dmesg shows:&#160; 4681.189513 vfio-pci 0000:01:00.0: irq 46 for MSI/MSI-X</p></div></blockquote></div><p>This is my QEMU config:</p><div class="quotebox"><blockquote><div><p>/usr/local/qemu-2-0-0-rc0-patched-pci/bin/qemu-system-x86_64 -name win8 -enable-kvm -M q35 -m 6144&#160; \<br />-cpu Haswell,hv-time,hv_relaxed,hv_vapic,hv_spinlocks=0x1000 \<br />-boot order=dc \<br />-smp 2,sockets=1,cores=2,threads=1 \<br />-bios /root/vfio/bios.bin -vga none \<br />-usb -usbdevice tablet \<br />-spice port=5902,disable-ticketing \<br />-vnc 0.0.0.0:0 \<br />-device ioh3420,bus=pcie.0,addr=1c.0,multifunction=on,port=1,chassis=1,id=root.1 \<br />-device ahci,bus=pcie.0,id=ahci \<br />-net nic \<br />-net tap,ifname=tap0,script=no,downscript=no \<br />-device vfio-pci,host=01:00.0,bus=root.1,addr=00.0,multifunction=on,x-vga=on \<br />-device vfio-pci,host=01:00.1,bus=root.1,addr=00.1 \<br />-device vfio-pci,host=00:14.0,bus=pcie.0 \<br />-drive file=/dev/mapper/vg1-winv1,media=disk,index=1,id=disk,cache=none,if=virtio \<br />-drive file=/dev/mapper/vg1-winv1data,media=disk,index=2,id=diskb,cache=none,if=virtio \<br />-drive file=/home/xen/iso/windows/en-gb_windows_8_1_enterprise_x64_dvd_2971910.iso,boot=on,media=cdrom,index=3,id=isocd&#160; \<br />-device ide-cd,bus=ahci.1,drive=isocd \<br />-drive file=/root/virtio-win-0.1-74.iso,media=cdrom,index=4,id=virtio&#160; \<br />-device ide-cd,bus=ahci.2,drive=virtio</p></div></blockquote></div><p>If I enable &quot;-vga cirrus&quot; and VNC to the host I can install the AMD drivers successfully and after a reboot it shows in device manager the AMD card but with a yellow exclamation and code 43. If I then go back to &quot;-vga none&quot; windows no longer wants to boot and I need up in a boot loop (seabios&gt;windows booting&gt;seabios&gt;windows booting).</p><p>Any ideas please?</p></div></blockquote></div></div></blockquote></div> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1400328">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1400366" class="blockpost rowodd"> <h2><span><span class="conr">#1482</span> <a href="viewtopic.php?pid=1400366#p1400366">2014-04-03 21:37:24</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=79893">jonascj</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2014-02-28</span></dd> <dd><span>Posts: 13</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=79893">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <p>Thank you, aw, for that very insightful reply.</p><p>I have a couple of follow-up questions and/or need a few clarifications.</p><div class="quotebox"><cite>aw wrote:</cite><blockquote><div><p>The first patch above fixes this, making i915 play correctly with VGA arbitration and the second patch cleans up some ordering to avoid a big white box drawn on the screen.&#160; It works and makes everyone happy... except Xorg on the host.&#160; The DRI code in Xorg, so I&#039;m told, wants to mmap(2) VGA MMIO space.&#160; Doing so is incompatible with the VGA arbiter because Xorg would need to hold the VGA arbitration lock for the life of that mmap, effectively a permanent lock.&#160; At that point VGA arbitration is deadlocked.&#160; Rather than do that, Xorg detects that there are multiple VGA devices and disables DRI. <span style="color: #ff0000">The result is that making i915 not lie about its VGA usage kills desktop performance for anyone with multiple graphics cards.&#160; This is the reason the two patches were reverted.</span></p><p><span style="color: #0000ff">Solutions to this are:<br /> a) don&#039;t use VGA space in the guest (DanaGoyette attempted to do this using UEFI/OVMF in place of Seabios, also accomplished on some cards using assigned graphics as a secondary device)<br /> b) create a VGA arbiter interface that would allow mmaps (I have some prototype code to do this, but I don&#039;t have time to figure out how to make Xorg use it)<br /> c) figure out why DRI wants to mmap VGA space and avoid it<br /> d) your idea here</span></p></div></blockquote></div><p>Regarding what is marked in <span style="color: #ff0000">red</span>:</p><p>So applying the the first patch (which makes i915 work correctly with VGA arbitration) kills overall performance (because it makes Xorg&#160; disable DRI which forces everyone to make indirect rendering) and because of that that patch was removed / reverted upstream?</p><p>Does this mean that kernels with this patch reapplied (OP&#039;s kernel for example, or etcet&#039;s core repo kernel with i915 patch) suffer from this problem (i.e. bad overall performance)?</p><p>Regarding the text marked in <span style="color: #0000ff">blue</span>:<br />Solutions to which problem? Solutions to the i915 arbiter problem - i.e. an alternative to the current patch?</p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1400366">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1400372" class="blockpost roweven"> <h2><span><span class="conr">#1483</span> <a href="viewtopic.php?pid=1400372#p1400372">2014-04-03 21:49:24</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=75590">aw</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2013-10-04</span></dd> <dd><span>Posts: 921</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=75590">Email</a></span> <span class="website"><a href="http://vfio.blogspot.com/" rel="nofollow">Website</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>jonascj wrote:</cite><blockquote><div><p>Thank you, aw, for that very insightful reply.</p><p>I have a couple of follow-up questions and/or need a few clarifications.</p><div class="quotebox"><cite>aw wrote:</cite><blockquote><div><p>The first patch above fixes this, making i915 play correctly with VGA arbitration and the second patch cleans up some ordering to avoid a big white box drawn on the screen.&#160; It works and makes everyone happy... except Xorg on the host.&#160; The DRI code in Xorg, so I&#039;m told, wants to mmap(2) VGA MMIO space.&#160; Doing so is incompatible with the VGA arbiter because Xorg would need to hold the VGA arbitration lock for the life of that mmap, effectively a permanent lock.&#160; At that point VGA arbitration is deadlocked.&#160; Rather than do that, Xorg detects that there are multiple VGA devices and disables DRI. <span style="color: #ff0000">The result is that making i915 not lie about its VGA usage kills desktop performance for anyone with multiple graphics cards.&#160; This is the reason the two patches were reverted.</span></p><p><span style="color: #0000ff">Solutions to this are:<br /> a) don&#039;t use VGA space in the guest (DanaGoyette attempted to do this using UEFI/OVMF in place of Seabios, also accomplished on some cards using assigned graphics as a secondary device)<br /> b) create a VGA arbiter interface that would allow mmaps (I have some prototype code to do this, but I don&#039;t have time to figure out how to make Xorg use it)<br /> c) figure out why DRI wants to mmap VGA space and avoid it<br /> d) your idea here</span></p></div></blockquote></div><p>Regarding what is marked in <span style="color: #ff0000">red</span>:</p><p>So applying the the first patch (which makes i915 work correctly with VGA arbitration) kills overall performance (because it makes Xorg&#160; disable DRI which forces everyone to make indirect rendering) and because of that that patch was removed / reverted upstream?</p><p>Does this mean that kernels with this patch reapplied (OP&#039;s kernel for example, or etcet&#039;s core repo kernel with i915 patch) suffer from this problem (i.e. bad overall performance)?</p></div></blockquote></div><p>In both cases yes, when multiple VGA devices are present (and possibly only on the i915 devices - radeon and nouveau appear to participate in VGA arbitration just fine).</p><div class="quotebox"><blockquote><div><p>Regarding the text marked in <span style="color: #0000ff">blue</span>:<br />Solutions to which problem? Solutions to the i915 arbiter problem - i.e. an alternative to the current patch?</p></div></blockquote></div><p>Solutions to either fix or avoid the problem that we can&#039;t have multiple VGA devices participate in arbitration without losing host DRI, which means fixing the VGA arbiter and/or fixing Xorg&#039;s use of the VGA arbiter, or avoiding VGA space in the guest.</p> </div> <div class="postsignature postmsg"><hr /><p><a href="http://vfio.blogspot.com" rel="nofollow">http://vfio.blogspot.com</a><br />Looking for a more open forum to discuss vfio related uses?&#160; Try <a href="https://www.redhat.com/mailman/listinfo/vfio-users" rel="nofollow">https://www.redhat.com/mailman/listinfo/vfio-users</a></p></div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1400372">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1400381" class="blockpost rowodd"> <h2><span><span class="conr">#1484</span> <a href="viewtopic.php?pid=1400381#p1400381">2014-04-03 22:11:01</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=79893">jonascj</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2014-02-28</span></dd> <dd><span>Posts: 13</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=79893">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>aw wrote:</cite><blockquote><div><div class="quotebox"><cite>jonascj wrote:</cite><blockquote><div><p>Does this mean that kernels with this patch reapplied (OP&#039;s kernel for example, or etcet&#039;s core repo kernel with i915 patch) suffer from this problem (i.e. bad overall performance)?</p></div></blockquote></div><p>In both cases yes, when multiple VGA devices are present (and possibly only on the i915 devices - radeon and nouveau appear to participate in VGA arbitration just fine).</p></div></blockquote></div><p>Sorry for being so thick, but this means that everyone using the i915 module/driver suffer from disabled DRI while they use kernels patched with this patch? I.e. everyone using Intel IGPU for their host while having a dedicated gfx passed through to a KVM guest have DRI disabled on their host.</p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1400381">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1400383" class="blockpost roweven"> <h2><span><span class="conr">#1485</span> <a href="viewtopic.php?pid=1400383#p1400383">2014-04-03 22:12:51</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=75590">aw</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2013-10-04</span></dd> <dd><span>Posts: 921</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=75590">Email</a></span> <span class="website"><a href="http://vfio.blogspot.com/" rel="nofollow">Website</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>jonascj wrote:</cite><blockquote><div><div class="quotebox"><cite>aw wrote:</cite><blockquote><div><div class="quotebox"><cite>jonascj wrote:</cite><blockquote><div><p>Does this mean that kernels with this patch reapplied (OP&#039;s kernel for example, or etcet&#039;s core repo kernel with i915 patch) suffer from this problem (i.e. bad overall performance)?</p></div></blockquote></div><p>In both cases yes, when multiple VGA devices are present (and possibly only on the i915 devices - radeon and nouveau appear to participate in VGA arbitration just fine).</p></div></blockquote></div><p>Sorry for being so thick, but this means that everyone using the i915 module/driver suffer from disabled DRI while they use kernels patched with this patch? I.e. everyone using Intel IGPU for their host while having a dedicated gfx passed through to a KVM guest have DRI disabled on their host.</p></div></blockquote></div><p>Yes</p> </div> <div class="postsignature postmsg"><hr /><p><a href="http://vfio.blogspot.com" rel="nofollow">http://vfio.blogspot.com</a><br />Looking for a more open forum to discuss vfio related uses?&#160; Try <a href="https://www.redhat.com/mailman/listinfo/vfio-users" rel="nofollow">https://www.redhat.com/mailman/listinfo/vfio-users</a></p></div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1400383">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1400503" class="blockpost rowodd"> <h2><span><span class="conr">#1486</span> <a href="viewtopic.php?pid=1400503#p1400503">2014-04-04 07:49:23</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=79899">winie</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2014-03-01</span></dd> <dd><span>Posts: 17</span></dd> <dd class="usercontacts"><span class="email"><a href="mailto:alireza4051@yahoo.com">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>aw wrote:</cite><blockquote><div><p>The trouble is that not everyone place nice, some drivers don&#039;t play at all.&#160; The vgacon driver in the kernel doesn&#039;t participate in VGA arbitration.&#160; The i915 driver lies and claims that it doesn&#039;t claim VGA accesses, effectively an opt-out of arbitration, while actually it does claim VGA accesses.&#160; This means that our VM comes along and does a VGA access, it gets forwarded to the <br />Solutions to this are:<br /> a) don&#039;t use VGA space in the guest (DanaGoyette attempted to do this using UEFI/OVMF in place of Seabios, also accomplished on some cards using assigned graphics as a secondary device)<br /> b) create a VGA arbiter interface that would allow mmaps (I have some prototype code to do this, but I don&#039;t have time to figure out how to make Xorg use it)<br /> c) figure out why DRI wants to mmap VGA space and avoid it<br /> d) your idea here.</p></div></blockquote></div><p>Does wayland or mir solve this problem?</p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1400503">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1400510" class="blockpost roweven"> <h2><span><span class="conr">#1487</span> <a href="viewtopic.php?pid=1400510#p1400510">2014-04-04 08:06:11</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=80864">MattSpe</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2014-04-04</span></dd> <dd><span>Posts: 2</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=80864">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <p>Hi Everyone<br />I&#039;ve spent the last few days fighting with my VGA passthrough.<br />No matter what I try, I always get the same result : passthrough is successful only on the first launch after host reset. Any following guest launch fail (I see the screen flicking but it stays black).<br />My last attempt was with content from first post (qemu-git seabios-git linux-mainline 3.14) on Arch. Same result.</p><p>My config is : X5680 + Sapphire X58 Pure Black + GT610 + GTX560Ti.<br />I tried both combinations 610 primary/560 secondary and 560 primary/610 secondary, no difference.<br />If I try to pass the secondary, only first attempt is successful. If I try to pass the primary not even the first attempt is working (stays black after flickering).<br />I tried to pass a romfile (I get an error msg on second launch if I don&#039;t pass, no need on the first launch), no difference.</p><p>Could someone point me in the right direction ?<br />Do I miss some patch/config ? Is it a hardware issue ?</p><p>Thanks !<br />Matthieu</p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1400510">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1400526" class="blockpost rowodd"> <h2><span><span class="conr">#1488</span> <a href="viewtopic.php?pid=1400526#p1400526">2014-04-04 09:08:44</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=78355">anickname</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2014-01-07</span></dd> <dd><span>Posts: 23</span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <p>I installed 3.14 from the first page and it didn&#039;t work well. The log is full of :</p><div class="codebox"><pre class="vscroll"><code>------------[ cut here ]------------ WARNING: CPU: 0 PID: 1367 at arch/x86/kvm/x86.c:1114 kvm_get_msr_common+0x793/0x960 [kvm]() Modules linked in: nls_utf8 cifs dns_resolver fscache ebt_ip ebtable_filter bridge stp llc ebtables x_tables nct6775 hwmon_vid coretemp iTCO_wdt iTCO_vendor_support mxm_wmi intel_rapl raid1 md_mod sd_mod crc_t10dif atkbd libps2 crct10dif_pclmul crct10dif_common crc32_pclmul crc32c_intel ghash_clmulni_intel aesni_intel aes_x86_64 lrw gf128mul glue_helper ablk_helpe ehci_pci ehci_hcd r8169 mii usbcore usb_common i8042 serio pci_stub CPU: 0 PID: 1367 Comm: windows_81 Tainted: G W 3.14.0-2-mainline #1 Hardware name: To Be Filled By O.E.M. To Be Filled By O.E.M./Z77 Professional, BIOS P1.70B 11/12/2013 0000000000000009 ffff8802571afc10 ffffffff814d563c 0000000000000000 ffff8802571afc48 ffffffff81064f1d 0000000040000020 ffff8802571afcd8 ffff88025726bec0 ffff88025717c000 ffff88025717c040 ffff8802571afc58 Call Trace: [&lt;ffffffff814d563c&gt;] dump_stack+0x4d/0x6f [&lt;ffffffff81064f1d&gt;] warn_slowpath_common+0x7d/0xa0 [&lt;ffffffff81064ffa&gt;] warn_slowpath_null+0x1a/0x20 [&lt;ffffffffa03da453&gt;] kvm_get_msr_common+0x793/0x960 [kvm] [&lt;ffffffffa00740c2&gt;] vmx_get_msr+0x102/0x370 [kvm_intel] [&lt;ffffffffa007435a&gt;] handle_rdmsr+0x2a/0x140 [kvm_intel] [&lt;ffffffffa00799a5&gt;] vmx_handle_exit+0xb5/0xa20 [kvm_intel] [&lt;ffffffffa0071360&gt;] ? vmx_invpcid_supported+0x20/0x20 [kvm_intel] [&lt;ffffffffa03dfb60&gt;] kvm_arch_vcpu_ioctl_run+0xc70/0x11c0 [kvm] [&lt;ffffffff8101e9d6&gt;] ? ___preempt_schedule+0x56/0xb0 [&lt;ffffffffa03c85c2&gt;] kvm_vcpu_ioctl+0x2b2/0x5b0 [kvm] [&lt;ffffffff814d7909&gt;] ? __schedule+0x3c9/0x900 [&lt;ffffffff811b6180&gt;] do_vfs_ioctl+0x2e0/0x4c0 [&lt;ffffffff811bff9e&gt;] ? __fget+0x6e/0xb0 [&lt;ffffffff811b63e1&gt;] SyS_ioctl+0x81/0xa0 [&lt;ffffffff814e3069&gt;] system_call_fastpath+0x16/0x1b ---[ end trace 1bf431db809123d0 ]---</code></pre></div><p>Before, I had 3.13.6 also from the first page and worked without any issues.</p><p>My config is :</p><div class="codebox"><pre><code>qemu-system-x86_64 \ -daemonize \ -pidfile &quot;/run/qemu-$VM.pid&quot; \ -nodefconfig -nodefaults \ -name &quot;$VM&quot;,process=&quot;$VM&quot; \ -enable-kvm \ -boot menu=on \ -rtc base=localtime \ -machine q35 \ -balloon none \ -m 8192 -mem-path /dev/hugepages -mem-prealloc \ -cpu Haswell,hv-time \ -smp sockets=1,cores=4,threads=1 \ -bios bios-256k.bin \ -chardev file,path=&quot;$VM-seabios.log&quot;,id=seabios -device isa-debugcon,iobase=0x402,chardev=seabios \ -vga none \ -nographic \ -monitor unix:/run/qemu-$VM.monitor,server,nowait \ -serial none \ -parallel none \ -device ioh3420,bus=pcie.0,addr=1c.0,multifunction=on,port=1,chassis=1,id=root.1 \ -device vfio-pci,host=01:00.0,bus=root.1,addr=00.0,multifunction=on,x-vga=on,romfile=$KVM_ROOT/roms/Sapphire_RadeonHD_7790.rom \ -device vfio-pci,host=00:1b.0,bus=pcie.0 \ -device vfio-pci,host=06:00.0,bus=pcie.0 \ -device vfio-pci,host=09:00.0,bus=pcie.0 \ -device vfio-pci,host=0b:00.0,bus=pcie.0</code></pre></div> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1400526">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1400920" class="blockpost roweven"> <h2><span><span class="conr">#1489</span> <a href="viewtopic.php?pid=1400920#p1400920">2014-04-05 14:50:21</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=80387">dwe11er</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2014-03-18</span></dd> <dd><span>Posts: 73</span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>anickname wrote:</cite><blockquote><div><p>I installed 3.14 from the first page and it didn&#039;t work well. The log is full of :</p><div class="codebox"><pre><code>------------[ cut here ]------------ ... ---[ end trace 1bf431db809123d0 ]---</code></pre></div><p>Before, I had 3.13.6 also from the first page and worked without any issues.</p><p>My config is :</p><div class="codebox"><pre><code>qemu-system-x86_64 \ -daemonize \ ... -device vfio-pci,host=0b:00.0,bus=pcie.0</code></pre></div></div></blockquote></div><p>I think hv-time might be doing bad things. It&#039;s working great without tho.</p> <p class="postedit"><em>Last edited by dwe11er (2014-04-05 14:51:04)</em></p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1400920">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1400952" class="blockpost rowodd"> <h2><span><span class="conr">#1490</span> <a href="viewtopic.php?pid=1400952#p1400952">2014-04-05 16:32:44</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=78355">anickname</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2014-01-07</span></dd> <dd><span>Posts: 23</span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <p>I will try, thanks.<br />I upgraded to 3.14 hoping for some speed improvement from hv-time.</p><p>My processor is Sandy Bridge and in the config I have Haswell. Does this creates any problems ?<br />I have Haswell because with Sandy Bridge it wasn&#039;t stable; crashes from time to time.</p><p>EDIT: Yes, without hv-time is working with 3.14. The problems is that now, the cpu load on the host when<br />running Windows 8.1 idle is with ~20-25% higher than when running 3.13.6 with hv-time. With 3.13.6 was<br />~45-50%.<br />I don&#039;t know if it is because of hv-time or because of the new kernel.</p> <p class="postedit"><em>Last edited by anickname (2014-04-05 18:50:10)</em></p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1400952">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1401009" class="blockpost roweven"> <h2><span><span class="conr">#1491</span> <a href="viewtopic.php?pid=1401009#p1401009">2014-04-05 18:45:24</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=80701">apex8</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2014-03-29</span></dd> <dd><span>Posts: 47</span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <p>Using the provided packages with Kernel 3.14 I got rid of the host crashes during VM startup. Graphics pass through is working, as far as I can tell (Windows performance indicator).<br />Now I`m trying to pass through my creative recon3d sound card. Originally I tried XEN where this was working without problems, but now I`m getting the following error during startup:</p><div class="codebox"><pre><code>vfio: error, group 6 is not viable</code></pre></div><p>The corresponding part of my script is:</p><div class="codebox"><pre><code>-device vfio-pci,host=03:00.0 \</code></pre></div><div class="codebox"><pre><code>lspci -k | grep 03 03:00.0 Audio device: Creative Labs Device 0012 (rev 01) lspci -nnn | grep 03:00.0 03:00.0 Audio device [0403]: Creative Labs Device [1102:0012] (rev 01) cat /proc/cmdline ... pci-stub.ids=10de:1187,10de:0e0a,1102:0012,8086:1c2d</code></pre></div><p>Does someone have an idea, whats wrong here?</p><p>BR</p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1401009">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1401075" class="blockpost rowodd"> <h2><span><span class="conr">#1492</span> <a href="viewtopic.php?pid=1401075#p1401075">2014-04-05 21:28:47</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=80387">dwe11er</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2014-03-18</span></dd> <dd><span>Posts: 73</span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <p><a href="http://pastebin.com/KWD4DVcS" rel="nofollow">http://pastebin.com/KWD4DVcS</a></p><p>So, if anyone interested, I did my own launching script with ability to unbind devices and rebind back to their previous driver (useful if passing hd audio) after vm is down.</p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1401075">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1401105" class="blockpost roweven"> <h2><span><span class="conr">#1493</span> <a href="viewtopic.php?pid=1401105#p1401105">2014-04-05 23:26:11</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=80915">eliwallace</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2014-04-05</span></dd> <dd><span>Posts: 2</span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <p>Hi, I&#039;ve been trying to get this working with a GTX 770 on the host passing a GTX 660 through to the guest, but I ran into </p><div class="codebox"><pre><code>qemu-system-x86_64: -device vfio-pci,host=08:00.0,bus=root.1,addr=00.0,multifunction=on,rombar=0,romfile=/usr/local/share/qemu/vgabios-660.rom,x-vga=on: vfio: Device does not support requested feature x-vga qemu-system-x86_64: -device vfio-pci,host=08:00.0,bus=root.1,addr=00.0,multifunction=on,rombar=0,romfile=/usr/local/share/qemu/vgabios-660.rom,x-vga=on: vfio: failed to get device 0000:08:00.0 qemu-system-x86_64: -device vfio-pci,host=08:00.0,bus=root.1,addr=00.0,multifunction=on,rombar=0,romfile=/usr/local/share/qemu/vgabios-660.rom,x-vga=on: Device initialization failed. qemu-system-x86_64: -device vfio-pci,host=08:00.0,bus=root.1,addr=00.0,multifunction=on,rombar=0,romfile=/usr/local/share/qemu/vgabios-660.rom,x-vga=on: Device &#039;vfio-pci&#039; could not be initialized</code></pre></div><p>Using kernel 3.13, qemu 1.7, FX-8350 cpu, Crosshair V F-Z mobo, proprietary Nvidia drivers on host</p><p>launching qemu with</p><div class="codebox"><pre><code>qemu-system-x86_64 -enable-kvm -M q35 -m 1024 -cpu host -smp 6,sockets=1,cores=6,threads=1 -bios /usr/share/qemu/bios.bin -vga none -device ioh3420,bus=pcie.0,addr=1c.0,multifunction=on,port=1,chassis=1,id=root.1 -device vfio-pci,host=08:00.0,bus=root.1,addr=00.0,multifunction=on,rombar=0,romfile=/usr/local/share/qemu/vgabios-660.rom,x-vga=on -device vfio-pci,host=08:00.1,bus=root.1,addr=00.1</code></pre></div><p>lspci -vvvv:</p><div class="codebox"><pre class="vscroll"><code>08:00.0 VGA compatible controller: NVIDIA Corporation GK106 [GeForce GTX 660] (rev a1) (prog-if 00 [VGA controller]) Subsystem: eVga.com. Corp. Device 2662 Control: I/O+ Mem+ BusMaster- SpecCycle- MemWINV- VGASnoop- ParErr- Stepping- SERR- FastB2B- DisINTx- Status: Cap+ 66MHz- UDF- FastB2B- ParErr- DEVSEL=fast &gt;TAbort- &lt;TAbort- &lt;MAbort- &gt;SERR- &lt;PERR- INTx- Interrupt: pin A routed to IRQ 32 Region 0: Memory at f4000000 (32-bit, non-prefetchable) [size=16M] Region 1: Memory at c0000000 (64-bit, prefetchable) [size=128M] Region 3: Memory at c8000000 (64-bit, prefetchable) [size=32M] Region 5: I/O ports at a000 [size=128] Expansion ROM at f5000000 [disabled] [size=512K] Capabilities: [60] Power Management version 3 Flags: PMEClk- DSI- D1- D2- AuxCurrent=0mA PME(D0-,D1-,D2-,D3hot-,D3cold-) Status: D0 NoSoftRst+ PME-Enable- DSel=0 DScale=0 PME- Capabilities: [68] MSI: Enable- Count=1/1 Maskable- 64bit+ Address: 0000000000000000 Data: 0000 Capabilities: [78] Express (v2) Endpoint, MSI 00 DevCap: MaxPayload 256 bytes, PhantFunc 0, Latency L0s unlimited, L1 &lt;64us ExtTag+ AttnBtn- AttnInd- PwrInd- RBE+ FLReset- DevCtl: Report errors: Correctable- Non-Fatal- Fatal- Unsupported- RlxdOrd- ExtTag- PhantFunc- AuxPwr- NoSnoop+ MaxPayload 128 bytes, MaxReadReq 512 bytes DevSta: CorrErr- UncorrErr- FatalErr- UnsuppReq- AuxPwr- TransPend- LnkCap: Port #0, Speed 8GT/s, Width x16, ASPM L0s L1, Exit Latency L0s &lt;512ns, L1 &lt;4us ClockPM+ Surprise- LLActRep- BwNot- LnkCtl: ASPM Disabled; RCB 64 bytes Disabled- CommClk+ ExtSynch- ClockPM- AutWidDis- BWInt- AutBWInt- LnkSta: Speed 2.5GT/s, Width x16, TrErr- Train- SlotClk+ DLActive- BWMgmt- ABWMgmt- DevCap2: Completion Timeout: Range AB, TimeoutDis+, LTR-, OBFF Not Supported DevCtl2: Completion Timeout: 50us to 50ms, TimeoutDis-, LTR-, OBFF Disabled LnkCtl2: Target Link Speed: 8GT/s, EnterCompliance- SpeedDis- Transmit Margin: Normal Operating Range, EnterModifiedCompliance- ComplianceSOS- Compliance De-emphasis: -6dB LnkSta2: Current De-emphasis Level: -3.5dB, EqualizationComplete-, EqualizationPhase1- EqualizationPhase2-, EqualizationPhase3-, LinkEqualizationRequest- Capabilities: [b4] Vendor Specific Information: Len=14 &lt;?&gt; Capabilities: [100 v1] Virtual Channel Caps: LPEVC=0 RefClk=100ns PATEntryBits=1 Arb: Fixed- WRR32- WRR64- WRR128- Ctrl: ArbSelect=Fixed Status: InProgress- VC0: Caps: PATOffset=00 MaxTimeSlots=1 RejSnoopTrans- Arb: Fixed- WRR32- WRR64- WRR128- TWRR128- WRR256- Ctrl: Enable+ ID=0 ArbSelect=Fixed TC/VC=ff Status: NegoPending- InProgress- Capabilities: [128 v1] Power Budgeting &lt;?&gt; Capabilities: [600 v1] Vendor Specific Information: ID=0001 Rev=1 Len=024 &lt;?&gt; Capabilities: [900 v1] #19 Kernel driver in use: vfio-pci 08:00.1 Audio device: NVIDIA Corporation GK106 HDMI Audio Controller (rev a1) Subsystem: eVga.com. Corp. Device 2662 Control: I/O- Mem+ BusMaster+ SpecCycle- MemWINV- VGASnoop- ParErr- Stepping- SERR- FastB2B- DisINTx- Status: Cap+ 66MHz- UDF- FastB2B- ParErr- DEVSEL=fast &gt;TAbort- &lt;TAbort- &lt;MAbort- &gt;SERR- &lt;PERR- INTx- Latency: 0, Cache Line Size: 64 bytes Interrupt: pin B routed to IRQ 33 Region 0: Memory at f5080000 (32-bit, non-prefetchable) [size=16K] Capabilities: [60] Power Management version 3 Flags: PMEClk- DSI- D1- D2- AuxCurrent=0mA PME(D0-,D1-,D2-,D3hot-,D3cold-) Status: D0 NoSoftRst+ PME-Enable- DSel=0 DScale=0 PME- Capabilities: [68] MSI: Enable- Count=1/1 Maskable- 64bit+ Address: 0000000000000000 Data: 0000 Capabilities: [78] Express (v2) Endpoint, MSI 00 DevCap: MaxPayload 256 bytes, PhantFunc 0, Latency L0s unlimited, L1 &lt;64us ExtTag+ AttnBtn- AttnInd- PwrInd- RBE+ FLReset- DevCtl: Report errors: Correctable- Non-Fatal- Fatal- Unsupported- RlxdOrd- ExtTag- PhantFunc- AuxPwr- NoSnoop+ MaxPayload 128 bytes, MaxReadReq 512 bytes DevSta: CorrErr- UncorrErr- FatalErr- UnsuppReq- AuxPwr- TransPend- LnkCap: Port #0, Speed 8GT/s, Width x16, ASPM L0s L1, Exit Latency L0s &lt;512ns, L1 &lt;4us ClockPM+ Surprise- LLActRep- BwNot- LnkCtl: ASPM Disabled; RCB 64 bytes Disabled- CommClk+ ExtSynch- ClockPM- AutWidDis- BWInt- AutBWInt- LnkSta: Speed 2.5GT/s, Width x16, TrErr- Train- SlotClk+ DLActive- BWMgmt- ABWMgmt- DevCap2: Completion Timeout: Range AB, TimeoutDis+, LTR-, OBFF Not Supported DevCtl2: Completion Timeout: 50us to 50ms, TimeoutDis-, LTR-, OBFF Disabled LnkSta2: Current De-emphasis Level: -3.5dB, EqualizationComplete-, EqualizationPhase1- EqualizationPhase2-, EqualizationPhase3-, LinkEqualizationRequest- Kernel driver in use: vfio-pci</code></pre></div><p>dmesg | egrep -i &quot;amd-vi|pci-stub|vfio|iommu&quot;</p><div class="codebox"><pre><code>[ 0.000000] Command line: BOOT_IMAGE=/boot/vmlinuz-3.13.7 root=UUID=5e9c875a-9b8a-418a-b461-b1e08d8a1791 ro quiet iommu=pt iommu=1 amd_iommu=on [ 0.000000] Kernel command line: BOOT_IMAGE=/boot/vmlinuz-3.13.7 root=UUID=5e9c875a-9b8a-418a-b461-b1e08d8a1791 ro quiet iommu=pt iommu=1 amd_iommu=on [ 0.273684] [Firmware Bug]: AMD-Vi: IOAPIC[9] not in IVRS table [ 0.273757] [Firmware Bug]: AMD-Vi: IOAPIC[10] not in IVRS table [ 0.273806] [Firmware Bug]: AMD-Vi: No southbridge IOAPIC found [ 0.273853] AMD-Vi: Disabling interrupt remapping [ 1.220732] AMD-Vi: Found IOMMU at 0000:00:00.2 cap 0x40 [ 1.220863] AMD-Vi: Initialized for Passthrough Mode [ 1.306447] AMD IOMMUv2 driver by Joerg Roedel &lt;joerg.roedel@amd.com&gt; [ 1.306448] AMD IOMMUv2 functionality not available on this system [ 3.703453] pci-stub: add 10DE:11C0 sub=FFFFFFFF:FFFFFFFF cls=00000000/00000000 [ 3.703463] pci-stub 0000:08:00.0: claimed by stub [ 3.703468] pci-stub: add 10DE:0E0B sub=FFFFFFFF:FFFFFFFF cls=00000000/00000000 [ 3.703474] pci-stub 0000:08:00.1: claimed by stub [ 9.215347] pci-stub 0000:08:00.0: enabling device (0000 -&gt; 0003) [ 38.196490] vboxpci: IOMMU found [ 344.289349] VFIO - User Level meta-driver version: 0.3 [ 464.944491] vfio_ecap_init: 0000:08:00.0 hiding ecap 0x19@0x900 [ 664.101872] vfio_ecap_init: 0000:08:00.0 hiding ecap 0x19@0x900 [ 743.049314] vfio_ecap_init: 0000:08:00.0 hiding ecap 0x19@0x900 [ 5881.675217] vfio_ecap_init: 0000:08:00.0 hiding ecap 0x19@0x900 [ 5906.191754] vfio_ecap_init: 0000:08:00.0 hiding ecap 0x19@0x900 [ 5945.493057] vfio_ecap_init: 0000:08:00.0 hiding ecap 0x19@0x900 [ 8566.737047] vfio_ecap_init: 0000:08:00.0 hiding ecap 0x19@0x900 [ 9020.289413] vfio_ecap_init: 0000:08:00.0 hiding ecap 0x19@0x900</code></pre></div><p>cat /boot/config-`uname -r` | grep -i &quot;vfio&quot;</p><div class="codebox"><pre><code>CONFIG_VFIO_IOMMU_TYPE1=m CONFIG_VFIO=m CONFIG_VFIO_PCI=m CONFIG_VFIO_PCI_VGA=y CONFIG_KVM_VFIO=y</code></pre></div><p>EDIT: Solved by bios update</p> <p class="postedit"><em>Last edited by eliwallace (2014-04-06 18:23:45)</em></p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1401105">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1401107" class="blockpost rowodd"> <h2><span><span class="conr">#1494</span> <a href="viewtopic.php?pid=1401107#p1401107">2014-04-05 23:39:23</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=80749">SXX</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2014-03-31</span></dd> <dd><span>Posts: 15</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=80749">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <p>Hey want to say thanks because I successfully set VM on my hardware:<br />i7 4771, ASRock Z87 Extreme6, HD 6950.<br />Though I use Kubuntu 14.04 with:<br />Vanilla seabios and QEMU (version 1.7.91 (Debian 2.0.0~rc1+dfsg-0ubuntu1)) and seabios (1.7.4-4).<br />And kernel 3.14 with OP patches. I not yet sure what options I actually need and which are useless.</p><p>Just wonder about that problem with i915. Is this why I only have LLVMPipe on host when boot with patched kernel?</p> <p class="postedit"><em>Last edited by SXX (2014-04-05 23:44:16)</em></p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><strong>Online</strong></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1401107">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1401149" class="blockpost roweven"> <h2><span><span class="conr">#1495</span> <a href="viewtopic.php?pid=1401149#p1401149">2014-04-06 03:31:09</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=80920">Nex7</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2014-04-06</span></dd> <dd><span>Posts: 5</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=80920">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <p>So I&#039;ve pored through this thread and Google, and can&#039;t find anyone even claiming to be seeing the symptoms I&#039;m seeing. Maybe I&#039;ve missed something, or someone has an idea?</p><p>Motherboard: SuperMicro X10SAE-O<br />CPU: E3-1275v3<br />1st VGA: i915<br />2nd VGA (in top PCI-e x18 slot): GeForce GTX 770 &quot;Windforce&quot;</p><p>After much trial and error, using the latest (3.14) kernel with CONFIG_VFIO stuff compiled in &amp; qemu-git from AUR (OP&#039;s fail to compile), plus OP&#039;s vfio-bind stuff and pci-stub set in kernel cmdline for the GTX770, I have almost full success. The Windows guest boots fine, reboots fine, can even be shut down and restarted without rebooting host.</p><p>However, I can&#039;t install the damn nVidia drivers in the Windows 7 x64 guest. They install fine, but upon reboot, Windows boots past the initial logo and then into a blank screen, I see my USB devices flicker a few times during a rather long pause, and then the VM reboots and sticks you at the &#039;Windows failed to boot&#039; menu asking what to do.</p><p>I&#039;ve tried a rather large number of things to resolve the issue based on every Google search I could craft, too many to list here, and I&#039;m stumped. Anybody seen this/have an idea?</p><p>kernel cmdline:</p><div class="codebox"><pre><code>BOOT_IMAGE=/vmlinuz-linux-mainline root=UUID=f4e70249-85fe-430b-9039-fcd9d7f89327 rw intel_iommu=on vfio_iommu_type1.allow_unsafe_interrupts=1 pci-stub.ids=10de:1184,10de:0e0a quiet</code></pre></div><p>run line:</p><div class="codebox"><pre><code>qemu-system-x86_64 -enable-kvm -M q35 -m 8192 -cpu qemu64 -smp 4,sockets=1,cores=4,threads=1 -bios /usr/share/qemu/bios.bin \ -rtc base=localtime -nodefaults \ -vga none -nographic -device ioh3420,bus=pcie.0,addr=1c.0,multifunction=on,port=1,chassis=1,id=root.1 \ -device vfio-pci,host=01:00.0,bus=root.1,addr=00.0,multifunction=on,x-vga=on \ -device vfio-pci,host=01:00.1,bus=root.1,addr=00.1 \ -net nic,model=virtio,macaddr=52:54:01:01:01:01 -net bridge,br=br0 \ -device virtio-scsi-pci,id=scsi \ -usb -usbdevice host:1532:0016 -usbdevice host:24f0:0137 \ -usbdevice host:1b1c:0a0a -usbdevice host:04a9:1909 \ -drive file=/mnt/homesan/vm-win7-game/os_disk.raw,id=disk,format=raw,cache=none -device scsi-hd,drive=disk \ -drive file=/mnt/homesan/vm-win7-game/steam_disk.raw,id=game-disk,format=raw,cache=none -device scsi-hd,drive=game-disk \ -drive file=/usr/share/qemu/win7.iso,id=installcd -device ide-cd,bus=ide.1,drive=installcd \ -drive file=/usr/share/qemu/virtio-win-0.1-74.iso,id=virtiocd -device ide-cd,bus=ide.2,drive=virtiocd</code></pre></div><p>There&#039;s no output from qemu when I run it, and nothing in dmesg beyond some crap about USB that seems unimportant (as it&#039;s always there, nvidia driver or not), I&#039;m at the point of buying a Radeon, but I see people posting just days ago that they had a working GTX 770, so I have slight hope left.&#160; Help?</p> <p class="postedit"><em>Last edited by Nex7 (2014-04-06 03:31:39)</em></p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1401149">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1401308" class="blockpost rowodd"> <h2><span><span class="conr">#1496</span> <a href="viewtopic.php?pid=1401308#p1401308">2014-04-06 16:03:18</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=80933">Cubex</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2014-04-06</span></dd> <dd><span>Posts: 24</span></dd> <dd class="usercontacts"><span class="email"><a href="mailto:cubexed@gmail.com">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <p>Hello Nex7, I am issuing the same problems, everything works until I install the nvidia driver on Win7, I posted the problem in awilliam&#039;s github but I guess that he didn&#039;t see or something, anyways this is the link <a href="https://github.com/awilliam/qemu-vfio/issues/2" rel="nofollow">https://github.com/awilliam/qemu-vfio/issues/2</a></p><p>My 770 is a Gigabyte 770 WindForce (4GB) so we are in similar situation here...<br />CPU: i7 4770 (without any letter)<br />MB: Asrock Extreme 6 Z87<br />GPU for host: Nvidia 430 at PCIE-3 x16 slot 1<br />GPU for qemu: Nvidia 770 at PCIE-3 x8 slot 2</p><p>I want to add something extra, the 430 succefully works (when I swich their roles and PCIE slots) and nvidia driver installs and works correctly (nvidia panel recognizes the card and the attached monitor) so it&#039;s something within Gigabyte 770 VBIOS maybe? maybe because card has UEFI VBIOS? I&#039;m looking for help too...</p> <p class="postedit"><em>Last edited by Cubex (2014-04-06 16:04:35)</em></p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1401308">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1401318" class="blockpost roweven"> <h2><span><span class="conr">#1497</span> <a href="viewtopic.php?pid=1401318#p1401318">2014-04-06 16:57:06</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=78143">Blind Tree Frog</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2013-12-31</span></dd> <dd><span>Posts: 27</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=78143">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>eliwallace wrote:</cite><blockquote><div><p>dmesg | egrep -i &quot;amd-vi|pci-stub|vfio|iommu&quot;</p><div class="codebox"><pre><code>[ 0.273684] [Firmware Bug]: AMD-Vi: IOAPIC[9] not in IVRS table [ 0.273757] [Firmware Bug]: AMD-Vi: IOAPIC[10] not in IVRS table [ 0.273806] [Firmware Bug]: AMD-Vi: No southbridge IOAPIC found</code></pre></div></div></blockquote></div><p>Updating your BIOS should fix this issue I expect.&#160; May not help with anything else, but FYI.</p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1401318">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1401329" class="blockpost rowodd"> <h2><span><span class="conr">#1498</span> <a href="viewtopic.php?pid=1401329#p1401329">2014-04-06 17:41:47</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=80830">gneville</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2014-04-02</span></dd> <dd><span>Posts: 27</span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <p>I&#039;ve got the same problem but with my AMD R9 290 card, everythings fine until the drivers install. So I don&#039;t think this is exclusive to Nvidia, could be because of UEFI VBIOS......</p><br /><div class="quotebox"><cite>Cubex wrote:</cite><blockquote><div><p>Hello Nex7, I am issuing the same problems, everything works until I install the nvidia driver on Win7, I posted the problem in awilliam&#039;s github but I guess that he didn&#039;t see or something, anyways this is the link <a href="https://github.com/awilliam/qemu-vfio/issues/2" rel="nofollow">https://github.com/awilliam/qemu-vfio/issues/2</a></p><p>My 770 is a Gigabyte 770 WindForce (4GB) so we are in similar situation here...<br />CPU: i7 4770 (without any letter)<br />MB: Asrock Extreme 6 Z87<br />GPU for host: Nvidia 430 at PCIE-3 x16 slot 1<br />GPU for qemu: Nvidia 770 at PCIE-3 x8 slot 2</p><p>I want to add something extra, the 430 succefully works (when I swich their roles and PCIE slots) and nvidia driver installs and works correctly (nvidia panel recognizes the card and the attached monitor) so it&#039;s something within Gigabyte 770 VBIOS maybe? maybe because card has UEFI VBIOS? I&#039;m looking for help too...</p></div></blockquote></div> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1401329">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1401336" class="blockpost roweven"> <h2><span><span class="conr">#1499</span> <a href="viewtopic.php?pid=1401336#p1401336">2014-04-06 18:21:30</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=80915">eliwallace</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2014-04-05</span></dd> <dd><span>Posts: 2</span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>Blind Tree Frog wrote:</cite><blockquote><div><div class="quotebox"><cite>eliwallace wrote:</cite><blockquote><div><p>dmesg | egrep -i &quot;amd-vi|pci-stub|vfio|iommu&quot;</p><div class="codebox"><pre><code>[ 0.273684] [Firmware Bug]: AMD-Vi: IOAPIC[9] not in IVRS table [ 0.273757] [Firmware Bug]: AMD-Vi: IOAPIC[10] not in IVRS table [ 0.273806] [Firmware Bug]: AMD-Vi: No southbridge IOAPIC found</code></pre></div></div></blockquote></div><p>Updating your BIOS should fix this issue I expect.&#160; May not help with anything else, but FYI.</p></div></blockquote></div><p>Thanks, that fixed all the immediate problems</p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1401336">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1401397" class="blockpost rowodd"> <h2><span><span class="conr">#1500</span> <a href="viewtopic.php?pid=1401397#p1401397">2014-04-06 21:34:24</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=80920">Nex7</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2014-04-06</span></dd> <dd><span>Posts: 5</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=80920">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <p>So if I go into Safe Mode after one of these failed boots, the popup says:</p><p>Problem signature:<br />&#160; Problem Event Name:&#160; &#160; BlueScreen<br />&#160; OS Version:&#160; &#160; 6.1.7601.2.1.0.256.4<br />&#160; Locale ID:&#160; &#160; 1033</p><p>Additional information about the problem:<br />&#160; BCCode:&#160; &#160; 116<br />&#160; BCP1:&#160; &#160; FFFFFA8009E404E0<br />&#160; BCP2:&#160; &#160; FFFFF8800F18EE20<br />&#160; BCP3:&#160; &#160; 0000000000000000<br />&#160; BCP4:&#160; &#160; 0000000000000002<br />&#160; OS Version:&#160; &#160; 6_1_7601<br />&#160; Service Pack:&#160; &#160; 1_0<br />&#160; Product:&#160; &#160; 256_1</p><p>Google for this is not helpful - lots of &#039;update your drivers&#039; and &#039;the card might be broken&#039;. <img src="https://bbs.archlinux.org/img/smilies/sad.png" width="15" height="15" alt="sad" /> I did find one thing of some interest, this quote:</p><div class="quotebox"><blockquote><div><p>&quot;It&#039;s not a true crash, in the sense that the bluescreen was initiated only because the combination of video driver and video hardware was being unresponsive, and not because of any synchronous processing exception&quot;.</p><p>Since Vista, the &quot;Timeout Detection and Recovery&quot; (TDR) components of the OS video subsystem have been capable of doing some truly impressive things to try to recover from issues which would have caused earlier OSs like XP to crash.</p><p>As a last resort, the TDR subsystem sends the video driver a &quot;please restart yourself now!&quot; command and waits a few seconds.</p><p>If there&#039;s no response, the OS concludes that the video driver/hardware combo has truly collapsed in a heap, and it fires off that stop 0x116 BSOD.</p><p>If playing with video driver versions hasn&#039;t helped, make sure the box is not overheating.</p><p>Try removing a side panel and aiming a big mains fan straight at the motherboard and GPU.</p></div></blockquote></div><p>Obviously I do not believe my card is overheating, but perhaps that explanation of how you get to a BCC code 116 might spark something in one of the local expert&#039;s minds about what&#039;s going on?</p><p>I&#039;m going to try playing with BIOS settings some more..</p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1401397">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div class="postlinksb"> <div class="inbox crumbsplus"> <div class="pagepost"> <p class="pagelink conl"><span class="pages-label">Pages: </span><a rel="prev" class="item1" href="viewtopic.php?id=162768&amp;p=59">Previous</a> <a href="viewtopic.php?id=162768">1</a> <span class="spacer">…</span> <a href="viewtopic.php?id=162768&amp;p=58">58</a> <a href="viewtopic.php?id=162768&amp;p=59">59</a> <strong>60</strong> <a href="viewtopic.php?id=162768&amp;p=61">61</a> <a href="viewtopic.php?id=162768&amp;p=62">62</a> <span class="spacer">…</span> <a href="viewtopic.php?id=162768&amp;p=234">234</a> <a rel="next" href="viewtopic.php?id=162768&amp;p=61">Next</a></p> <p class="postlink conr">Topic closed</p> </div> <ul class="crumbs"> <li><a href="index.php">Index</a></li> <li><span>»&#160;</span><a href="viewforum.php?id=48">Topics Going Nowhere</a></li> <li><span>»&#160;</span><strong><a href="viewtopic.php?id=162768">KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</a></strong></li> </ul> <p class="subscribelink clearb"><a href="misc.php?action=subscribe&amp;tid=162768">Subscribe to this topic</a></p> <div class="clearer"></div> </div> </div> </div> <div id="brdfooter" class="block"> <h2><span>Board footer</span></h2> <div class="box"> <div id="brdfooternav" class="inbox"> <div class="conl"> <form id="qjump" method="get" action="viewforum.php"> <div><label><span>Jump to<br /></span> <select name="id" onchange="window.location=('viewforum.php?id='+this.options[this.selectedIndex].value)"> <optgroup label="Technical Issues and Assistance"> <option value="23">Newbie Corner</option> <option value="17">Installation</option> <option value="22">Kernel &amp; Hardware</option> <option value="18">Applications &amp; Desktop Environments</option> <option value="31">Laptop Issues</option> <option value="8">Networking, Server, and Protection</option> <option value="32">Multimedia and Games</option> <option value="50">System Administration</option> <option value="35">Other Architectures</option> </optgroup> <optgroup label="Arch-centric"> <option value="24">Announcements, Package &amp; Security Advisories</option> <option value="1">Arch Discussion</option> <option value="13">Forum &amp; Wiki discussion</option> </optgroup> <optgroup label="Pacman Upgrades, Packaging &amp; AUR"> <option value="44">Pacman &amp; Package Upgrade Issues</option> <option value="49">[testing] Repo Forum</option> <option value="4">Creating &amp; Modifying Packages</option> <option value="38">AUR Issues, Discussion &amp; PKGBUILD Requests</option> </optgroup> <optgroup label="Contributions &amp; Discussion"> <option value="20">GNU/Linux Discussion</option> <option value="27">Community Contributions</option> <option value="33">Programming &amp; Scripting</option> <option value="30">Other Languages</option> <option value="47">Artwork and Screenshots</option> <option value="42">Try This</option> </optgroup> <optgroup label="/dev/null"> <option value="29">Off-Topic</option> <option value="48" selected="selected">Topics Going Nowhere</option> <option value="36">Dustbin</option> </optgroup> </select></label> <input type="submit" value=" Go " accesskey="g" /> </div> </form> </div> <div class="conr"> <p id="feedlinks"><span class="atom"><a href="extern.php?action=feed&amp;tid=162768&amp;type=atom">Atom topic feed</a></span></p> <p id="poweredby">Powered by <a href="http://fluxbb.org/">FluxBB</a></p> </div> <div class="clearer"></div> </div> </div> </div> </div> <div class="end-box"></div> </div> </body> </html>
