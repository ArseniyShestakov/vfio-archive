<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"> <html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en" dir="ltr"> <head> <meta http-equiv="Content-Type" content="text/html; charset=utf-8" /> <title>KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9 (Page 160) / Topics Going Nowhere / Arch Linux Forums</title> <link rel="stylesheet" type="text/css" href="style/ArchLinux.css" /> <link rel="canonical" href="viewtopic.php?id=162768&amp;p=160" title="Page 160" /> <link rel="prev" href="viewtopic.php?id=162768&amp;p=159" title="Page 159" /> <link rel="next" href="viewtopic.php?id=162768&amp;p=161" title="Page 161" /> <link rel="alternate" type="application/atom+xml" href="extern.php?action=feed&amp;tid=162768&amp;type=atom" title="Atom topic feed" /> <link rel="stylesheet" media="screen" href="style/ArchLinux/arch.css?v=3" /> <link rel="stylesheet" media="screen" href="style/ArchLinux/archnavbar.css?v=2" /> <link rel="shortcut icon" href="style/ArchLinux/favicon.ico" /> </head> <body> <div id="archnavbar" class="anb-forum"> <div id="archnavbarlogo"><h1><a href="http://www.archlinux.org/">Arch Linux</a></h1></div> <div id="archnavbarmenu"> <ul id="archnavbarlist"> <li id="anb-home"><a href="http://www.archlinux.org/">Home</a></li><li id="anb-packages"><a href="http://www.archlinux.org/packages/">Packages</a></li><li id="anb-forums" class="anb-selected"><a href="https://bbs.archlinux.org/">Forums</a></li><li id="anb-wiki"><a href="https://wiki.archlinux.org/">Wiki</a></li><li id="anb-bugs"><a href="https://bugs.archlinux.org/">Bugs</a></li><li id="anb-aur"><a href="https://aur.archlinux.org/">AUR</a></li><li id="anb-download"><a href="http://www.archlinux.org/download/">Download</a></li> </ul> </div> </div> <div id="punviewtopic" class="pun"> <div class="top-box"></div> <div class="punwrap"> <div id="brdheader" class="block"> <div class="box"> <div id="brdmenu" class="inbox"> <ul> <li id="navindex" class="isactive"><a href="index.php">Index</a></li> <li id="navuserlist"><a href="userlist.php">User list</a></li> <li id="navsearch"><a href="search.php">Search</a></li> <li id="navprofile"><a href="profile.php?id=80749">Profile</a></li> <li id="navlogout"><a href="login.php?action=out&amp;id=80749&amp;csrf_token=5c20501ec397bb45ef8ee8c84db232c8d8e421c6">Logout</a></li> </ul> </div> <div id="brdwelcome" class="inbox"> <ul class="conl"> <li><span>Logged in as <strong>SXX</strong></span></li> <li><span>Last visit: 2015-08-16 12:20:09</span></li> </ul> <ul class="conr"> <li><span>Topics: <a href="search.php?action=show_replies" title="Find topics you have posted to.">Posted</a> | <a href="search.php?action=show_new" title="Find topics with new posts since your last visit.">New</a> | <a href="search.php?action=show_recent" title="Find topics with recent posts.">Active</a> | <a href="search.php?action=show_unanswered" title="Find topics with no replies.">Unanswered</a></span></li> </ul> <div class="clearer"></div> </div> </div> </div> <div id="brdmain"> <div class="linkst"> <div class="inbox crumbsplus"> <ul class="crumbs"> <li><a href="index.php">Index</a></li> <li><span>»&#160;</span><a href="viewforum.php?id=48">Topics Going Nowhere</a></li> <li><span>»&#160;</span><strong><a href="viewtopic.php?id=162768">KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</a></strong></li> </ul> <div class="pagepost"> <p class="pagelink conl"><span class="pages-label">Pages: </span><a rel="prev" class="item1" href="viewtopic.php?id=162768&amp;p=159">Previous</a> <a href="viewtopic.php?id=162768">1</a> <span class="spacer">…</span> <a href="viewtopic.php?id=162768&amp;p=158">158</a> <a href="viewtopic.php?id=162768&amp;p=159">159</a> <strong>160</strong> <a href="viewtopic.php?id=162768&amp;p=161">161</a> <a href="viewtopic.php?id=162768&amp;p=162">162</a> <span class="spacer">…</span> <a href="viewtopic.php?id=162768&amp;p=234">234</a> <a rel="next" href="viewtopic.php?id=162768&amp;p=161">Next</a></p> <p class="postlink conr">Topic closed</p> </div> <div class="clearer"></div> </div> </div> <div id="p1497332" class="blockpost rowodd blockpost1"> <h2><span><span class="conr">#3976</span> <a href="viewtopic.php?pid=1497332#p1497332">2015-01-28 15:40:42</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=75590">aw</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2013-10-04</span></dd> <dd><span>Posts: 921</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=75590">Email</a></span> <span class="website"><a href="http://vfio.blogspot.com/" rel="nofollow">Website</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>Denso wrote:</cite><blockquote><div><p>@aw :</p><p>It seems that DMAR issues made it into 3.18.3 too .</p><p>3.18.3 contains 2 IOMMU commits :</p><p>iommu/vt-d: Fix dmar_domain leak in iommu_attach_device<br />iommu/vt-d: Fix an off-by-one bug in __domain_mapping()</p><p>Which one do you think is to blame ?</p></div></blockquote></div><p>By that, do you mean that it is not present in 3.18.2?&#160; I&#039;m familiar with the first patch, I doubt it&#039;s to blame.&#160; If you can revert one of those patches and toggle the problem let me know and I&#039;ll investigate further.&#160; Easiest way to do a quick revert test is <em>git show &lt;commit ID&gt; | patch -p1 -R</em>&#160; It&#039;s also possible that the problem is a side-effect of other code changes.</p> </div> <div class="postsignature postmsg"><hr /><p><a href="http://vfio.blogspot.com" rel="nofollow">http://vfio.blogspot.com</a><br />Looking for a more open forum to discuss vfio related uses?&#160; Try <a href="https://www.redhat.com/mailman/listinfo/vfio-users" rel="nofollow">https://www.redhat.com/mailman/listinfo/vfio-users</a></p></div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1497332">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1497465" class="blockpost roweven"> <h2><span><span class="conr">#3977</span> <a href="viewtopic.php?pid=1497465#p1497465">2015-01-28 19:59:06</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=78620">mostlyharmless</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2014-01-16</span></dd> <dd><span>Posts: 50</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=78620">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <p>Hmm, here&#039;s an update, in case anyone is interested.&#160; The cd line that allows host access is now</p><div class="codebox"><pre><code>-drive file=/dev/sr0,if=none,id=drive-ide0-0-0,readonly=on,format=raw -device ide-cd,bus=ide.0,unit=0,drive=drive-ide0-0-0,id=ide0-0-0</code></pre></div><p>Why qemu now requires that instead of the previous </p><div class="codebox"><pre><code> -drive file=/dev/sr0,id=cddisk -device ide-cd,bus=ide.1,drive=cddisk </code></pre></div><p>is beyond me. I presume that is a recent qemu development not an arch vs Slackware thing.</p><p>Speaking of which, of course the pulseaudio warning was eliminated by my installing pulseaudio.. heh heh</p><p>However, the bluescreen with error 0x0000007b continues.&#160; Works without passthrough under arch... works under qemu 2.0.0 under Slackware, but not passthrough under arch.&#160; Clearly the screen gets passed through, as I get to see all the futile Windows recovery options.&#160; Perhaps if I uninstall the nvidia driver from Windows while not passing through, and then, assuming I can boot Windows passedthrough with the default Windows VGA driver I can reinstall the NVIDIA driver.&#160; Supposedly 0x0000007b is a drive problem though.</p><p>Any other insight into the problem would be welcome.</p> <p class="postedit"><em>Last edited by mostlyharmless (2015-01-28 19:59:50)</em></p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1497465">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1497473" class="blockpost rowodd"> <h2><span><span class="conr">#3978</span> <a href="viewtopic.php?pid=1497473#p1497473">2015-01-28 20:08:35</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=75590">aw</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2013-10-04</span></dd> <dd><span>Posts: 921</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=75590">Email</a></span> <span class="website"><a href="http://vfio.blogspot.com/" rel="nofollow">Website</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>mostlyharmless wrote:</cite><blockquote><div><p>Hmm, here&#039;s an update, in case anyone is interested.&#160; The cd line that allows host access is now</p><div class="codebox"><pre><code>-drive file=/dev/sr0,if=none,id=drive-ide0-0-0,readonly=on,format=raw -device ide-cd,bus=ide.0,unit=0,drive=drive-ide0-0-0,id=ide0-0-0</code></pre></div><p>Why qemu now requires that instead of the previous </p><div class="codebox"><pre><code> -drive file=/dev/sr0,id=cddisk -device ide-cd,bus=ide.1,drive=cddisk </code></pre></div><p>is beyond me. I presume that is a recent qemu development not an arch vs Slackware thing.</p></div></blockquote></div><p>The difference is <em>if=none</em>.&#160; Without that QEMU assumes an interface for the device, then when you attempt to use the same interface later it&#039;s already in use.</p><div class="quotebox"><blockquote><div><p>Speaking of which, of course the pulseaudio warning was eliminated by my installing pulseaudio.. heh heh</p><p>However, the bluescreen with error 0x0000007b continues.&#160; Works without passthrough under arch... works under qemu 2.0.0 under Slackware, but not passthrough under arch.&#160; Clearly the screen gets passed through, as I get to see all the futile Windows recovery options.&#160; Perhaps if I uninstall the nvidia driver from Windows while not passing through, and then, assuming I can boot Windows passedthrough with the default Windows VGA driver I can reinstall the NVIDIA driver.&#160; Supposedly 0x0000007b is a drive problem though.</p><p>Any other insight into the problem would be welcome.</p></div></blockquote></div><p>If you only get the problem when you attempt to pass through the host drive like this, then apparently it&#039;s related to the drive...</p> </div> <div class="postsignature postmsg"><hr /><p><a href="http://vfio.blogspot.com" rel="nofollow">http://vfio.blogspot.com</a><br />Looking for a more open forum to discuss vfio related uses?&#160; Try <a href="https://www.redhat.com/mailman/listinfo/vfio-users" rel="nofollow">https://www.redhat.com/mailman/listinfo/vfio-users</a></p></div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1497473">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1497500" class="blockpost roweven"> <h2><span><span class="conr">#3979</span> <a href="viewtopic.php?pid=1497500#p1497500">2015-01-28 20:57:11</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=88373">dhiru1602</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2015-01-28</span></dd> <dd><span>Posts: 6</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=88373">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <p>Hi guys,</p><p>I am in need of desperate help. I have followed all of the posts on this topic and I am stuck with no solution to my problem. I was able to passthrough my GPU in Linux guest but on Windows guests I get Code 43.</p><p>Current Setup:<br />Core I7 920<br />Intel Desktop Board DX58SO (No Integrated Graphics)<br />Host GPU: Nvidia 9600 GT<br />Guest GPU: Nvidia 9600 GT</p><p>The Intel Processor page doesn&#039;t show support for VT-d, but instead mentions that the processor supports VT-x. I have passed &quot;intel_iommu=on&quot;&#160; in the commandline to check if IOMMU worked and it did. This is when I have decided to give this method a try.</p><div class="codebox"><pre><code>$ dmesg | grep &quot;IOMMU&quot; [ 0.000000] Intel-IOMMU: enabled [ 0.022507] dmar: IOMMU 0: reg_base_addr fe711000 ver 1:0 cap c9008010e60262 ecap f0207a [ 0.022512] dmar: IOMMU 1: reg_base_addr fe710000 ver 1:0 cap c90780106f0462 ecap f020fa [ 0.468207] IOMMU 0 0xfe711000: using Queued invalidation [ 0.468210] IOMMU 1 0xfe710000: using Queued invalidation [ 0.468214] IOMMU: Setting RMRR: [ 0.468222] IOMMU: Setting identity map for device 0000:00:1d.0 [0xec000 - 0xeefff] [ 0.468245] IOMMU: Setting identity map for device 0000:00:1a.7 [0xbf4a1000 - 0xbf4a1fff] [ 0.468264] IOMMU: Setting identity map for device 0000:00:1a.2 [0xbf4ac000 - 0xbf4acfff] [ 0.468282] IOMMU: Setting identity map for device 0000:00:1a.1 [0xbf4aa000 - 0xbf4aafff] [ 0.468300] IOMMU: Setting identity map for device 0000:00:1a.0 [0xbf4a7000 - 0xbf4a7fff] [ 0.468318] IOMMU: Setting identity map for device 0000:00:1d.7 [0xbf4a5000 - 0xbf4a5fff] [ 0.468335] IOMMU: Setting identity map for device 0000:00:1d.2 [0xbf4b0000 - 0xbf4b0fff] [ 0.468353] IOMMU: Setting identity map for device 0000:00:1d.1 [0xbf4af000 - 0xbf4affff] [ 0.468364] IOMMU: Setting identity map for device 0000:00:1d.0 [0xbf4ad000 - 0xbf4adfff] [ 0.468373] IOMMU: Prepare 0-16MiB unity mapping for LPC [ 0.468379] IOMMU: Setting identity map for device 0000:00:1f.0 [0x0 - 0xffffff]</code></pre></div><p>I have downloaded the kernel from the OP, built and installed it. I am using the following commandline:</p><div class="codebox"><pre><code>intel_iommu=on pcie_acs_override=downstream</code></pre></div><p>and confirmed that ACS override was enabled</p><div class="codebox"><pre><code>[ 0.000000] Warning: PCIe ACS overrides enabled; This may allow non-IOMMU protected peer-to-peer DMA</code></pre></div><p>Since I had 2 identical cards, they had identical vendor and device ID&#039;s. If I used the pci-stub, it would end up stubbing both the graphic cards which will render my host useless.</p><div class="codebox"><pre><code>$ lspci -nn | grep VGA 02:00.0 VGA compatible controller [0300]: NVIDIA Corporation G94 [GeForce 9600 GT] [10de:0622] (rev a1) 03:00.0 VGA compatible controller [0300]: NVIDIA Corporation G94 [GeForce 9600 GT] [10de:0622] (rev a1)</code></pre></div><p>Thanks to @cjn! I was using his workaround to unbind the primary card after the pci-stub module has loaded.</p><div class="codebox"><pre><code>$ cat /etc/modprobe.d/pci-stub.conf options pci-stub ids=10de:0622 install pci-stub /sbin/modprobe --ignore-install pci-stub $CMDLINE_OPTS; /usr/local/sbin/pci-stub-unbind 0000:02:00.0 softdep drm pre: pci-stub</code></pre></div><div class="codebox"><pre><code>$ cat /usr/local/sbin/pci-stub-unbind #!/bin/sh for dev in &quot;$@&quot; do echo $dev &gt; /sys/bus/pci/drivers/pci-stub/unbind done</code></pre></div><p>The first GPU is now used by the Nvidia 340 driver on the host and the GPU is assigned to pci-stub. I have then assigned the GPU to the vfio-pci driver and to confirm the same</p><div class="codebox"><pre><code>03:00.0 VGA compatible controller: NVIDIA Corporation G94 [GeForce 9600 GT] (rev a1) (prog-if 00 [VGA controller]) Subsystem: XFX Pine Group Inc. Device 234b Control: I/O+ Mem+ BusMaster+ SpecCycle- MemWINV- VGASnoop- ParErr- Stepping- SERR+ FastB2B- DisINTx- Status: Cap+ 66MHz- UDF- FastB2B- ParErr- DEVSEL=fast &gt;TAbort- &lt;TAbort- &lt;MAbort- &gt;SERR- &lt;PERR- INTx- Latency: 0, Cache Line Size: 64 bytes Interrupt: pin A routed to IRQ 16 Region 0: Memory at c2000000 (32-bit, non-prefetchable) [size=16M] Region 1: Memory at e0000000 (64-bit, prefetchable) [size=256M] Region 3: Memory at c0000000 (64-bit, non-prefetchable) [size=32M] Region 5: I/O ports at 2000 [size=128] Expansion ROM at &lt;ignored&gt; [disabled] Capabilities: &lt;access denied&gt; Kernel driver in use: vfio-pci Kernel modules: nouveau, nvidia</code></pre></div><p>I have set the following module options.</p><div class="codebox"><pre><code>options kvm ignore_msrs=1 options vfio_iommu_type1 allow_unsafe_interrupts=1 #options kvm_intel emulate_invalid_guest_state=0 [With this set, I had no VGA output even in Virt-Manager console]</code></pre></div><div class="codebox"><pre class="vscroll"><code>&lt;domain type=&#039;kvm&#039; xmlns:qemu=&#039;http://libvirt.org/schemas/domain/qemu/1.0&#039;&gt; &lt;name&gt;Windows7&lt;/name&gt; &lt;uuid&gt;e9a9c56a-0708-4539-9d77-130283cbb354&lt;/uuid&gt; &lt;memory unit=&#039;KiB&#039;&gt;8388608&lt;/memory&gt; &lt;currentMemory unit=&#039;KiB&#039;&gt;8388608&lt;/currentMemory&gt; &lt;vcpu placement=&#039;static&#039;&gt;4&lt;/vcpu&gt; &lt;os&gt; &lt;type arch=&#039;x86_64&#039; machine=&#039;pc-i440fx-2.2&#039;&gt;hvm&lt;/type&gt; &lt;boot dev=&#039;hd&#039;/&gt; &lt;/os&gt; &lt;features&gt; &lt;acpi/&gt; &lt;apic/&gt; &lt;pae/&gt; &lt;kvm&gt; &lt;hidden state=&#039;on&#039;/&gt; &lt;/kvm&gt; &lt;/features&gt; &lt;cpu mode=&#039;custom&#039; match=&#039;exact&#039;&gt; &lt;model fallback=&#039;allow&#039;&gt;Nehalem&lt;/model&gt; &lt;/cpu&gt; &lt;clock offset=&#039;utc&#039;&gt; &lt;timer name=&#039;rtc&#039; tickpolicy=&#039;catchup&#039;/&gt; &lt;timer name=&#039;pit&#039; tickpolicy=&#039;delay&#039;/&gt; &lt;timer name=&#039;hpet&#039; present=&#039;no&#039;/&gt; &lt;/clock&gt; &lt;on_poweroff&gt;destroy&lt;/on_poweroff&gt; &lt;on_reboot&gt;restart&lt;/on_reboot&gt; &lt;on_crash&gt;restart&lt;/on_crash&gt; &lt;pm&gt; &lt;suspend-to-mem enabled=&#039;no&#039;/&gt; &lt;suspend-to-disk enabled=&#039;no&#039;/&gt; &lt;/pm&gt; &lt;devices&gt; &lt;emulator&gt;/usr/sbin/qemu-system-x86_64&lt;/emulator&gt; &lt;disk type=&#039;file&#039; device=&#039;disk&#039;&gt; &lt;driver name=&#039;qemu&#039; type=&#039;qcow2&#039;/&gt; &lt;source file=&#039;/mnt/VMs/qemu/Windows7.qcow2&#039;/&gt; &lt;target dev=&#039;hda&#039; bus=&#039;ide&#039;/&gt; &lt;address type=&#039;drive&#039; controller=&#039;0&#039; bus=&#039;0&#039; target=&#039;0&#039; unit=&#039;0&#039;/&gt; &lt;/disk&gt; &lt;disk type=&#039;block&#039; device=&#039;cdrom&#039;&gt; &lt;driver name=&#039;qemu&#039; type=&#039;raw&#039;/&gt; &lt;target dev=&#039;hdb&#039; bus=&#039;ide&#039;/&gt; &lt;readonly/&gt; &lt;address type=&#039;drive&#039; controller=&#039;0&#039; bus=&#039;0&#039; target=&#039;0&#039; unit=&#039;1&#039;/&gt; &lt;/disk&gt; &lt;controller type=&#039;usb&#039; index=&#039;0&#039; model=&#039;ich9-ehci1&#039;&gt; &lt;address type=&#039;pci&#039; domain=&#039;0x0000&#039; bus=&#039;0x00&#039; slot=&#039;0x06&#039; function=&#039;0x7&#039;/&gt; &lt;/controller&gt; &lt;controller type=&#039;usb&#039; index=&#039;0&#039; model=&#039;ich9-uhci1&#039;&gt; &lt;master startport=&#039;0&#039;/&gt; &lt;address type=&#039;pci&#039; domain=&#039;0x0000&#039; bus=&#039;0x00&#039; slot=&#039;0x06&#039; function=&#039;0x0&#039; multifunction=&#039;on&#039;/&gt; &lt;/controller&gt; &lt;controller type=&#039;usb&#039; index=&#039;0&#039; model=&#039;ich9-uhci2&#039;&gt; &lt;master startport=&#039;2&#039;/&gt; &lt;address type=&#039;pci&#039; domain=&#039;0x0000&#039; bus=&#039;0x00&#039; slot=&#039;0x06&#039; function=&#039;0x1&#039;/&gt; &lt;/controller&gt; &lt;controller type=&#039;usb&#039; index=&#039;0&#039; model=&#039;ich9-uhci3&#039;&gt; &lt;master startport=&#039;4&#039;/&gt; &lt;address type=&#039;pci&#039; domain=&#039;0x0000&#039; bus=&#039;0x00&#039; slot=&#039;0x06&#039; function=&#039;0x2&#039;/&gt; &lt;/controller&gt; &lt;controller type=&#039;pci&#039; index=&#039;0&#039; model=&#039;pci-root&#039;/&gt; &lt;controller type=&#039;ide&#039; index=&#039;0&#039;&gt; &lt;address type=&#039;pci&#039; domain=&#039;0x0000&#039; bus=&#039;0x00&#039; slot=&#039;0x01&#039; function=&#039;0x1&#039;/&gt; &lt;/controller&gt; &lt;controller type=&#039;virtio-serial&#039; index=&#039;0&#039;&gt; &lt;address type=&#039;pci&#039; domain=&#039;0x0000&#039; bus=&#039;0x00&#039; slot=&#039;0x05&#039; function=&#039;0x0&#039;/&gt; &lt;/controller&gt; &lt;interface type=&#039;direct&#039;&gt; &lt;mac address=&#039;52:54:00:91:20:1c&#039;/&gt; &lt;source dev=&#039;enp0s25&#039; mode=&#039;bridge&#039;/&gt; &lt;model type=&#039;rtl8139&#039;/&gt; &lt;address type=&#039;pci&#039; domain=&#039;0x0000&#039; bus=&#039;0x00&#039; slot=&#039;0x03&#039; function=&#039;0x0&#039;/&gt; &lt;/interface&gt; &lt;serial type=&#039;pty&#039;&gt; &lt;target port=&#039;0&#039;/&gt; &lt;/serial&gt; &lt;console type=&#039;pty&#039;&gt; &lt;target type=&#039;serial&#039; port=&#039;0&#039;/&gt; &lt;/console&gt; &lt;channel type=&#039;spicevmc&#039;&gt; &lt;target type=&#039;virtio&#039; name=&#039;com.redhat.spice.0&#039;/&gt; &lt;address type=&#039;virtio-serial&#039; controller=&#039;0&#039; bus=&#039;0&#039; port=&#039;1&#039;/&gt; &lt;/channel&gt; &lt;input type=&#039;mouse&#039; bus=&#039;ps2&#039;/&gt; &lt;input type=&#039;keyboard&#039; bus=&#039;ps2&#039;/&gt; &lt;graphics type=&#039;spice&#039; autoport=&#039;yes&#039;/&gt; &lt;sound model=&#039;ich6&#039;&gt; &lt;address type=&#039;pci&#039; domain=&#039;0x0000&#039; bus=&#039;0x00&#039; slot=&#039;0x04&#039; function=&#039;0x0&#039;/&gt; &lt;/sound&gt; &lt;video&gt; &lt;model type=&#039;qxl&#039; ram=&#039;65536&#039; vram=&#039;65536&#039; vgamem=&#039;16384&#039; heads=&#039;1&#039;/&gt; &lt;address type=&#039;pci&#039; domain=&#039;0x0000&#039; bus=&#039;0x00&#039; slot=&#039;0x02&#039; function=&#039;0x0&#039;/&gt; &lt;/video&gt; &lt;redirdev bus=&#039;usb&#039; type=&#039;spicevmc&#039;&gt; &lt;/redirdev&gt; &lt;redirdev bus=&#039;usb&#039; type=&#039;spicevmc&#039;&gt; &lt;/redirdev&gt; &lt;redirdev bus=&#039;usb&#039; type=&#039;spicevmc&#039;&gt; &lt;/redirdev&gt; &lt;redirdev bus=&#039;usb&#039; type=&#039;spicevmc&#039;&gt; &lt;/redirdev&gt; &lt;memballoon model=&#039;virtio&#039;&gt; &lt;address type=&#039;pci&#039; domain=&#039;0x0000&#039; bus=&#039;0x00&#039; slot=&#039;0x07&#039; function=&#039;0x0&#039;/&gt; &lt;/memballoon&gt; &lt;/devices&gt; &lt;qemu:commandline&gt; &lt;qemu:arg value=&#039;-device&#039;/&gt; &lt;qemu:arg value=&#039;vfio-pci,host=03:00.0,multifunction=on&#039;/&gt; &lt;qemu:arg value=&#039;-vga&#039;/&gt; &lt;qemu:arg value=&#039;none&#039;/&gt; &lt;qemu:arg value=&#039;-cpu&#039;/&gt; &lt;qemu:arg value=&#039;host,kvm=off&#039;/&gt; &lt;/qemu:commandline&gt; &lt;/domain&gt;</code></pre></div><p>With all the above changes, I was able to boot into Ubuntu and install the Nvidia graphic drivers and everything worked fine. I was able to get the display out of the 2nd monitor. However, with Windows, I always get Code 43 error.</p><p>I have done extensive reading and I made sure that I was using &lt;hidden state=&#039;on&#039;/&gt; and kvm=off to make sure that the newer Nvidia driver started properly. I have even tried using an older 304 Nvidia driver in the guest and it didn&#039;t change a thing.</p><p>While looking at the Host Kernel log, I was able to make a comparision.</p><p>Kernel log for Windows booting</p><div class="codebox"><pre><code>&lt;6&gt;[ 3916.375945] vfio-pci 0000:03:00.0: enabling device (0400 -&gt; 0403) &lt;6&gt;[ 3922.353501] kvm: zapping shadow pages for mmio generation wraparound</code></pre></div><p>Kernel log for Linux booting</p><div class="codebox"><pre><code>&lt;6&gt;[ 5821.639931] vfio-pci 0000:03:00.0: enabling device (0400 -&gt; 0403) &lt;6&gt;[ 5827.818355] kvm: zapping shadow pages for mmio generation wraparound &lt;3&gt;[ 5839.699364] kvm [30427]: vcpu0 ignored rdmsr: 0x1c9 &lt;3&gt;[ 5839.699368] kvm [30427]: vcpu0 ignored wrmsr: 0x1c9 data 3 &lt;3&gt;[ 5839.699370] kvm [30427]: vcpu0 ignored rdmsr: 0x1c9 &lt;3&gt;[ 5839.699372] kvm [30427]: vcpu0 ignored rdmsr: 0x1a6 &lt;3&gt;[ 5839.699373] kvm [30427]: vcpu0 ignored wrmsr: 0x1a6 data 1ff &lt;3&gt;[ 5839.699375] kvm [30427]: vcpu0 ignored rdmsr: 0x1a6 &lt;3&gt;[ 5839.699378] kvm [30427]: vcpu0 ignored rdmsr: 0x3f6 &lt;3&gt;[ 5839.699380] kvm [30427]: vcpu0 ignored wrmsr: 0x3f6 data 1ff &lt;3&gt;[ 5839.699381] kvm [30427]: vcpu0 ignored rdmsr: 0x3f6 &lt;7&gt;[ 5844.410667] vfio-pci 0000:03:00.0: irq 36 for MSI/MSI-X</code></pre></div><p>&quot;vfio-pci 0000:03:00.0: irq 36 for MSI/MSI-X&quot; doesn&#039;t occur with windows. Probably the interrupt&#039;s are not working?</p><p>Please advice.</p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1497500">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1497525" class="blockpost rowodd"> <h2><span><span class="conr">#3980</span> <a href="viewtopic.php?pid=1497525#p1497525">2015-01-28 21:41:35</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=78620">mostlyharmless</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2014-01-16</span></dd> <dd><span>Posts: 50</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=78620">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <p>@aw Interesting about the if=none; apparently a new requirement?</p><p>As to the other, I&#039;m not passing through a drive, just my NVIDIA card. It passes through great under Slackware and the older qemu. The same VM with the video pass through stripped out boots fine under Arch and Slackware with their respective qemus.&#160; The CD drive line has nothing to do with that either, as the same problem exists regardless of whether I include the CD host drive line in the qemu arguments.</p><p>@dhiru1602</p><p>Interesting, the intel ark <a href="http://ark.intel.com/search/advanced?s=t&amp;FamilyText=5th%20Generation%20Intel%C2%AE%20Core%E2%84%A2%20i7%20Processors&amp;VTD=true" rel="nofollow">http://ark.intel.com/search/advanced?s= … s&amp;VTD=true</a></p><p>doesn&#039;t list the i7-920 as having Vt-d support, yet you apparently had success with a linux guest.</p><p>[Edit] I see the 920XM on this list <a href="http://ark.intel.com/search/advanced?s=t&amp;VTD=true" rel="nofollow">http://ark.intel.com/search/advanced?s=t&amp;VTD=true</a></p> <p class="postedit"><em>Last edited by mostlyharmless (2015-01-28 21:56:22)</em></p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1497525">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1497530" class="blockpost roweven"> <h2><span><span class="conr">#3981</span> <a href="viewtopic.php?pid=1497530#p1497530">2015-01-28 21:57:30</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=84760">Denso</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd class="postavatar"><img src="https://bbs.archlinux.org/img/avatars/84760.png?m=1412533733" width="71" height="80" alt="" /></dd> <dd><span>Registered: 2014-08-30</span></dd> <dd><span>Posts: 179</span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>aw wrote:</cite><blockquote><div><p>By that, do you mean that it is not present in 3.18.2?&#160; I&#039;m familiar with the first patch, I doubt it&#039;s to blame.&#160; If you can revert one of those patches and toggle the problem let me know and I&#039;ll investigate further.&#160; Easiest way to do a quick revert test is <em>git show &lt;commit ID&gt; | patch -p1 -R</em>&#160; It&#039;s also possible that the problem is a side-effect of other code changes.</p></div></blockquote></div><p>Yes , those errors didn&#039;t happen with 3.18.2 . I noticed that a system upgrade that happened today pulled 3.18.3 . Again , DMAR issues + Code 43 in one Windows VM .</p><p><del>I didn&#039;t know that I can revert a patch from an already compiled \ running kernel ?! Is that what&#160; <strong><em>git show &lt;commit ID&gt; | patch -p1 -R</em></strong> does ?</del></p><p>EDIT : Sorry , I&#039;m just stupid . I&#039;ll pull the source and revert those patches one by one .</p><p>Thanks !</p> <p class="postedit"><em>Last edited by Denso (2015-01-28 21:59:26)</em></p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1497530">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1497531" class="blockpost rowodd"> <h2><span><span class="conr">#3982</span> <a href="viewtopic.php?pid=1497531#p1497531">2015-01-28 21:59:45</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=75590">aw</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2013-10-04</span></dd> <dd><span>Posts: 921</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=75590">Email</a></span> <span class="website"><a href="http://vfio.blogspot.com/" rel="nofollow">Website</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>Denso wrote:</cite><blockquote><div><p>I didn&#039;t know that I can revert a patch from an already compiled \ running kernel ?! Is that what&#160; <strong><em>git show &lt;commit ID&gt; | patch -p1 -R</em></strong> does ?</p></div></blockquote></div><p>No, that reverts it from the source, you&#039;d need to rebuild.</p> </div> <div class="postsignature postmsg"><hr /><p><a href="http://vfio.blogspot.com" rel="nofollow">http://vfio.blogspot.com</a><br />Looking for a more open forum to discuss vfio related uses?&#160; Try <a href="https://www.redhat.com/mailman/listinfo/vfio-users" rel="nofollow">https://www.redhat.com/mailman/listinfo/vfio-users</a></p></div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1497531">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1497542" class="blockpost roweven"> <h2><span><span class="conr">#3983</span> <a href="viewtopic.php?pid=1497542#p1497542">2015-01-28 23:08:06</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=84760">Denso</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd class="postavatar"><img src="https://bbs.archlinux.org/img/avatars/84760.png?m=1412533733" width="71" height="80" alt="" /></dd> <dd><span>Registered: 2014-08-30</span></dd> <dd><span>Posts: 179</span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><blockquote><div><p>No, that reverts it from the source, you&#039;d need to rebuild.</p></div></blockquote></div><p>Yup . I realized how stupid that question was , maybe I was dreaming of runtime dynamic patching / reverting !</p><p>By the way , did I go blind or is git REALLY pulling a 3.9GB tree ?! lol</p><p><a href="http://i.imgur.com/H8JPe2c.png" rel="nofollow">http://i.imgur.com/H8JPe2c.png</a></p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1497542">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1497551" class="blockpost rowodd"> <h2><span><span class="conr">#3984</span> <a href="viewtopic.php?pid=1497551#p1497551">2015-01-28 23:35:51</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=88205">nythrix</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2015-01-22</span></dd> <dd><span>Posts: 4</span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>nythrix wrote:</cite><blockquote><div><p>Thanks to the awesome people helping out in this thread I&#039;ve been able to successfully pass through a 9600GT to a Windows 7 guest.</p><p>Unfortunately, linux guests don&#039;t work. I tried my oldish Debian VM, which has been running on &quot;-vga std&quot; since forever but I loose graphics output around the time the console switches fonts during boot (not sure how to describe it). Everything happens very quickly so the last messages I&#039;m able to make out are stuff about intel RAPL and something about BARs ..? I wiped out the VM and reinstalled Debian but the problem persisted. The installation itself was flawless though (with passthrough). Twice.</p><p>Then I tried installing Fedora 21 Workstation. Couldn&#039;t get much further than some sort of greeting menu. It seems the signal is again lost during attempts to fiddle with the graphics/framebuffer.</p><p>Is this some sort of device reset problems I&#039;m observing?</p><p>PS: I&#039;m running 3.17 with the i915 arbiter patch. Qemu 2.1.2.</p></div></blockquote></div><p>For future reference:<br />Nvidia 9600GT works great with Windows 7 guests (w/o additional ROM file) but not with Linux guests. I plugged in a GTX 460 for those and it worked (requires ROM and guest restart is still kinda hairy).<br />My motherboard is a Gigabyte GA-Z97X-UD3H (rev. 1.0, bios F7). Offers two usable IOMMU groups (i.e. you can safely run 2 independently accelerated VMs w/o the ACS hack): CPU-based, PCIe v3.0 slots in x16 or x8+x8 configurations and PCH-based, PCIe v2.1 slots in x4 or x1+x1+x1 configurations. The primary graphics can be the iGFX or a dGPU plugged into any physical PCIe x16 slot or even the friggin legacy PCI slot (hanging of the PCH-based IOMMU group). Any RIVA TNT owners should be satisfied with this one <img src="https://bbs.archlinux.org/img/smilies/smile.png" width="15" height="15" alt="smile" /><br />Everything is powered by an i5-4590S. I still think AMD is way superior when it comes to virtualization. I hate Intel&#039;s market segmentation and purposeful technology crippling. Were it not for the atrocious TDP, I would&#039;ve rather gone for an FX-8xxx.<br />Kernel 3.17 + VGA patch.<br />Qemu 2.1.2.</p><p>My launcher script:</p><div class="codebox"><pre class="vscroll"><code>#!/bin/bash vfiobind() { pci_addr=&quot;$1&quot; vendor=$(cat /sys/bus/pci/devices/$pci_addr/vendor) device=$(cat /sys/bus/pci/devices/$pci_addr/device) if [ -e /sys/bus/pci/devices/$pci_addr/driver ]; then echo $pci_addr &gt; /sys/bus/pci/devices/$pci_addr/driver/unbind fi echo $vendor $device &gt; /sys/bus/pci/drivers/vfio-pci/new_id } modprobe vfio-pci vfiobind 0000:01:00.0 # PCI Express x16 slot #vfiobind 0000:01:00.1 #vfiobind 0000:02:00.0 # PCI Express x8 slot #vfiobind 0000:05:00.0 # PCI Express x4 slot #vfiobind 0000:05:00.1 export QEMU_AUDIO_DRV=pa pulseaudio --start pacmd set-sink-mute 1 false pacmd set-sink-volume 1 8192 qemu_args=&quot;&quot; qemu_args=$qemu_args&quot; -machine type=q35,accel=kvm&quot; qemu_args=$qemu_args&quot; -cpu host&quot; qemu_args=$qemu_args&quot; -smp cpus=3,cores=1,threads=1&quot; qemu_args=$qemu_args&quot; -boot order=dc,menu=on&quot; qemu_args=$qemu_args&quot; -m size=10G&quot; qemu_args=$qemu_args&quot; -soundhw hda&quot; qemu_args=$qemu_args&quot; -device ahci,id=ahci-id&quot; #qemu_args=$qemu_args&quot; -device ide-cd,bus=ahci-id.0,drive=CD-id&quot; qemu_args=$qemu_args&quot; -device ide-hd,bus=ahci-id.1,drive=HD-id&quot; qemu_args=$qemu_args&quot; -device ioh3420,bus=pcie.0,addr=1c.0,multifunction=on,port=1,chassis=1,id=ioh3420-id&quot; qemu_args=$qemu_args&quot; -device vfio-pci,host=01:00.0,bus=ioh3420-id,addr=00.0,multifunction=on,x-vga=on&quot; qemu_args=$qemu_args&quot; -usb&quot; qemu_args=$qemu_args&quot; -nographic&quot; #qemu_args=$qemu_args&quot; -drive if=none,id=CD-id,file=/dev/cdrom&quot; qemu_args=$qemu_args&quot; -drive if=none,id=HD-id,file=./vm.img&quot; #qemu_args=$qemu_args&quot; -vga none&quot; qemu_args=$qemu_args&quot; -net nic&quot; qemu_args=$qemu_args&quot; -net user,restrict=on&quot; qemu_args=$qemu_args&quot; -enable-kvm&quot; qemu_args=$qemu_args&quot; -nodefaults&quot; #qemu_args=$qemu_args&quot; -runas user&quot; qemu-system-x86_64 $qemu_args</code></pre></div><p>I&#039;m still fighting with access permissions here and there. &quot;-runas user&quot; doesn&#039;t really help.</p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1497551">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1497709" class="blockpost roweven"> <h2><span><span class="conr">#3985</span> <a href="viewtopic.php?pid=1497709#p1497709">2015-01-29 15:05:48</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=78620">mostlyharmless</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2014-01-16</span></dd> <dd><span>Posts: 50</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=78620">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <p>OK, so removing the NVIDIA driver from within Windows didn&#039;t change the 0x0000007b error.&#160; Still mystified. Here&#039;s more data:</p><p>qemu under Slackware is qemu 2.1.0, under Arch qemu 2.2.0&#160; </p><p>Under qemu 2.2.0, removing the </p><div class="codebox"><pre><code>-drive file=/dev/mapper/cryptvg2-win7,id=disk,if=virtio </code></pre></div><p> line allows the system to boot from the install CD for Windows 7...&#160; </p><p>Something has changed in qemu&#039;s hard disk handling, akin to the if=none for the CD, perhaps with virtio? </p><p>but not from a Windows XPSP2 install disk that fails with bluescreen error 0x000000A5 Bios not fully ACPI complaint. Pressing F7 to bypass ACPI leads to the bluescreen with 0x0000007b.</p><p>Now let&#039;s see what happens under Slackware.... nah same thing, obviously that&#039;s a red herring secondary to WinXPSP2.&#160; Hmm, though it runs under libvirt through under both Slackware and Arch, maybe that&#039;s a -M q35 thing since libvirt defaults to 440.</p> <p class="postedit"><em>Last edited by mostlyharmless (2015-01-29 15:13:55)</em></p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1497709">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1497777" class="blockpost rowodd"> <h2><span><span class="conr">#3986</span> <a href="viewtopic.php?pid=1497777#p1497777">2015-01-29 17:53:53</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=88396">vx</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2015-01-29</span></dd> <dd><span>Posts: 1</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=88396">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <p>Hi guys,</p><p>Thanks for this thread. Been playing with this for about a week. I got passthrough working on the first day, but been having one big issue since then...</p><p>Windows installs fine. The first time I get to the desktop, it works fine. I can reboot multiple times and it brings me back to the desktop, until any one of the following happens:</p><p>1) I get near the the end of the catalyst driver installation<br />2) Windows power saving kicks in and turns off the monitor connected to the passthrough GPU<br />3) The host!!! monitor turns off because I haven&#039;t touched that keyboard in a while</p><p>When any of these happens, the passthrough monitor turns off, and can&#039;t be turned back on by touching the passthrough keyboard/mouse. If I kill the qemu process and restart it, it shows me SeaBIOS, the windows splash screen, and then the passthrough monitor goes off again. Can&#039;t recover from this point without reinstalling windows, and then I&#039;m back to square one.</p><p>Apologies if this has been covered already. The closest I can find are a few posts by syllopsium and firewing1 way back on page 37. syllopsium eventually used the NoSnoop patch, which apparently has been deprecated since, so I&#039;m not sure if to try it.</p><p>I&#039;ve been trying a bunch of different stuff (detailed below), and literally every working combination that gets the VM to start ends up with the same issue. Any help or guidance on what to try next would be appreciated. Thanks in advance.</p><p><strong>Setup:</strong><br />I got here via this Puget Systems how-to: <a href="http://www.pugetsystems.com/labs/articles/Multiheaded-NVIDIA-Gaming-using-Ubuntu-14-04-KVM-585/" rel="nofollow">http://www.pugetsystems.com/labs/articl … 4-KVM-585/</a>, so my configuration is somewhat based on their instructions, but I have since updated to a newer Ubuntu version &amp; kernel, applied the i915 arbitration patch and am using qemu 2.1.0.</p><p>Problem was the same in previous setup (14.04 distro / 3.13 kernel / qemu 2.0). Only the arbitration patch made a small difference. My host monitor does not turn blue now when I start the VM. Host monitor just displays Ubuntu Server console, no X. Could not having X installed be a problem?</p><p>GPU ROM was dumped using instructions from the virtio blog. It doesn&#039;t have a UEFI bios, so OVMF is not an option. Whether the romfile is passed to qemu or not makes no difference.</p><p>I&#039;ve tried with both the q35 and 440fx machines (see below for qemu params). Same problem on both of them.</p><p>I&#039;m using the Windows 8.1 90 day eval to make sure it works before I buy it. Not sure if this will make a difference from the retail version. Or maybe I need to use an older version instead? Have not tried that.</p><p>I&#039;ve not tried attaching a cirrus adapter and installing catalyst over VNC yet. Since it happens whether catalyst is installed or not, I&#039;m guessing this is not the issue. Will try it later today anyway though.</p><p><strong>qemu startup (q35):</strong></p><div class="codebox"><pre><code>sudo qemu-system-x86_64 \ -enable-kvm \ -daemonize \ -M q35 \ -m 4096 \ -cpu host \ -smp 2,sockets=1,cores=2 \ -vga none \ -display none \ -serial none -parallel none \ -device ioh3420,bus=pcie.0,addr=1c.0,multifunction=on,port=1,chassis=1,id=root.1 \ -device vfio-pci,host=0000:01:00.0,bus=root.1,addr=00.0,multifunction=on,x-vga=on,romfile=$HOME/r9270.rom \ -device vfio-pci,host=0000:01:00.1,bus=root.1,addr=00.1 \ -usb -usbdevice host:046d:c52e -usbdevice host:1bcf:0007 \ -drive file=$HOME/kvm/gaming.img,id=disk,format=raw -device ide-hd,bus=ide.0,drive=disk \ -drive file=$HOME/win8.iso,id=isocd -device ide-cd,bus=ide.1,drive=isocd \ -boot order=&#039;dc&#039; \</code></pre></div><p><strong>qemu startup (440fx):</strong></p><div class="codebox"><pre><code>sudo qemu-system-x86_64 \ -enable-kvm \ -daemonize \ -M pc \ -m 4096 \ -cpu host \ -smp 2,sockets=1,cores=2 \ -vga none \ -display none \ -serial none \ -parallel none \ -device vfio-pci,host=0000:01:00.0,multifunction=on,x-vga=on,romfile=$HOME/r9270.rom \ -device vfio-pci,host=0000:01:00.1 \ -usb -usbdevice host:046d:c52e -usbdevice host:1bcf:0007 \ -drive file=$HOME/kvm/gaming.img,media=disk,format=raw \ -drive file=$HOME/win8.iso,media=cdrom \ -boot order=&#039;dc&#039; \</code></pre></div><br /><p><strong>Hardware:</strong><br />CPU:&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;Intel i5 3470S - <a href="http://ark.intel.com/products/68315/Intel-Core-i5-3470S-Processor-6M-Cache-up-to-3_60-GHz" rel="nofollow">http://ark.intel.com/products/68315/Int … o-3_60-GHz</a><br />Motherboard:&#160; &#160; MSI H77MA-G43 - <a href="http://www.msi.com/product/mb/H77MA-G43.html#hero-overview" rel="nofollow">http://www.msi.com/product/mb/H77MA-G43 … o-overview</a><br />GPU Host:&#160; &#160; &#160; &#160; Intel HD 2500 from CPU<br />GPU VM:&#160; &#160; &#160; &#160; &#160; Sapphire Radeon R9 270 - <a href="http://www.sapphiretech.com/presentation/product/product_index.aspx?pid=2089&amp;lid=1" rel="nofollow">http://www.sapphiretech.com/presentatio … 2089&amp;lid=1</a> </p><p><strong>Software:</strong><br />Host OS:&#160; &#160; &#160; &#160; &#160; &#160;Ubuntu 14.10 Server<br />Kernel:&#160; &#160; &#160; &#160; &#160; &#160; &#160; 3.16.0-29 (+i915 arbitration patch)<br />qemu version:&#160; &#160;2.1.0<br />Guest OS:&#160; &#160; &#160; &#160; &#160;Windows 8.1 (90 day eval)</p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1497777">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1497782" class="blockpost roweven"> <h2><span><span class="conr">#3987</span> <a href="viewtopic.php?pid=1497782#p1497782">2015-01-29 17:59:29</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=88401">Wooots</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2015-01-29</span></dd> <dd><span>Posts: 3</span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <p>Hello there</p><p>I&#039;ve read this article and some others and got my Nvidia working at the moment using the following command:</p><div class="codebox"><pre><code>qemu-system-x86_64 -enable-kvm -m 1024 -cpu host,kvm=off -smp 6,sockets=1,cores=6,threads=2 -vga none -device vfio-pci,host=03:00.0,x-vga=on -device vfio-pci,host=03:00.1 -drive file=/opt/VirtualMachines/Passthrough-test/win7.qcow2,id=disk,format=qcow2,if=none -device ide-hd,drive=disk -usb -device usb-host,vendorid=0x046d,productid=0xc531 -usb -device usb-host,vendorid=0x046d,productid=0xc24d</code></pre></div><p>But I have one little question do you all start qemu as root? Isn&#039;t this a security problem?</p> <p class="postedit"><em>Last edited by Wooots (2015-01-29 18:17:24)</em></p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1497782">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1497792" class="blockpost rowodd"> <h2><span><span class="conr">#3988</span> <a href="viewtopic.php?pid=1497792#p1497792">2015-01-29 18:46:20</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=88373">dhiru1602</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2015-01-28</span></dd> <dd><span>Posts: 6</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=88373">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <p>I was finally able to get the passthrough working on Windows but I had to use a dirty hack to start the VM everytime.</p><p><a href="http://i.imgur.com/4sOjjB5.png" rel="nofollow"><span class="postimg"><img src="http://i.imgur.com/4sOjjB5s.png" alt="4sOjjB5s.png" /></span></a></p><p>As I have mentioned earlier, my GPU was working fine in passthrough on Linux but I got Code 43 error on Windows. This was because I don&#039;t get &quot;&quot;vfio-pci 0000:03:00.0: irq 36 for MSI/MSI-X&quot; on Windows.</p><p>I created a Linux Virtual Machine and after booting it, whenever I got the irq message in the kernel log, I would immediately turn off the Linux VM and boot the Windows VM. The GPU gets detected and works perfectly on Windows without Code 43. I have even installed the latest 340 nvidia driver and games work great. However, once I shutdown or reboot the VM, I will have to start the Linux VM first and force stop it when the interrupt line is registered and then boot the windows virtual machine. This works like about 5 out of 10 times and it&#039;s really a pain.</p><p>Any thoughts on what might be preventing the interrupts from working on a Windows guest?</p><div class="quotebox"><cite>mostlyharmless wrote:</cite><blockquote><div><p>@dhiru1602</p><p>Interesting, the intel ark <a href="http://ark.intel.com/search/advanced?s=t&amp;FamilyText=5th%20Generation%20Intel%C2%AE%20Core%E2%84%A2%20i7%20Processors&amp;VTD=true" rel="nofollow">http://ark.intel.com/search/advanced?s= … s&amp;VTD=true</a></p><p>doesn&#039;t list the i7-920 as having Vt-d support, yet you apparently had success with a linux guest.</p><p>[Edit] I see the 920XM on this list <a href="http://ark.intel.com/search/advanced?s=t&amp;VTD=true" rel="nofollow">http://ark.intel.com/search/advanced?s=t&amp;VTD=true</a></p></div></blockquote></div><p>Yes. Interestingly enough, the passthrough works even without the patched ACS kernel.</p> <p class="postedit"><em>Last edited by dhiru1602 (2015-01-29 18:49:53)</em></p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1497792">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1497847" class="blockpost roweven"> <h2><span><span class="conr">#3989</span> <a href="viewtopic.php?pid=1497847#p1497847">2015-01-29 21:26:00</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=87826">The_Moves</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2015-01-06</span></dd> <dd><span>Posts: 58</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=87826">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <p>Is there a good post where someone converted from a QEMU command to an XML file? I&#039;m having issues getting my xml file created. I have no issues with multiple device passthrough, GTX760/USB/Ethernet/Creative Sounds Blaster Z, I just want to be able to manage using an XML and LibVirt/Virt-Manager</p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1497847">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1497852" class="blockpost rowodd"> <h2><span><span class="conr">#3990</span> <a href="viewtopic.php?pid=1497852#p1497852">2015-01-29 21:53:12</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=78620">mostlyharmless</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2014-01-16</span></dd> <dd><span>Posts: 50</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=78620">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <p>@Wooots;&#160; I usually run as root or use sudo; I&#039;m pretty sure somewhere in the last 160 pages there&#039;s some detail on how to fudge the permissions to avoid that...</p><p>@The_Moves on that note, see page 94</p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1497852">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1497889" class="blockpost roweven"> <h2><span><span class="conr">#3991</span> <a href="viewtopic.php?pid=1497889#p1497889">2015-01-30 00:10:20</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=82117">devianceluka</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2014-05-19</span></dd> <dd><span>Posts: 43</span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <p>Using Fedora 21 and Virt-Manager, I successfully installed a VM with UEFI/OVMF by editing this:</p><p>/etc/libvirt/qemu.conf<br />nvram = [ &quot;/usr/share/edk2.git/ovmf-x64/OVMF-pure-efi.fd:/usr/share/edk2.git/ovmf-x64/OVMF_VARS-pure-efi.fd&quot; ]</p><p>Everything works flawlessly except my VM is <strong>NOT</strong> saving EFI Boot entry (Ubuntu/Fedora for now, later Windows). What could be the problem? I tried manually adding &quot;by file&quot; but on reboot it resets and forgets the entry. Also tried &quot;sudo grub-install&quot; in Ubuntu so Ubuntu makes the entry with no success either.</p><p>Please help!</p> <p class="postedit"><em>Last edited by devianceluka (2015-01-30 00:12:21)</em></p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1497889">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1497990" class="blockpost rowodd"> <h2><span><span class="conr">#3992</span> <a href="viewtopic.php?pid=1497990#p1497990">2015-01-30 12:01:44</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=29941">maxexcloo</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd class="postavatar"><img src="https://bbs.archlinux.org/img/avatars/29941.png?m=1294114138" width="80" height="80" alt="" /></dd> <dd><span>From: Australia</span></dd> <dd><span>Registered: 2009-10-14</span></dd> <dd><span>Posts: 177</span></dd> <dd class="usercontacts"><span class="website"><a href="http://www.excloo.com/" rel="nofollow">Website</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <p>Is it at all possible to use the dedicated card on my optimus enabled laptop as a passthrough? I&#039;m thinking it could be possible (although probably not implemented) as the output from the card could then be copied to the normal output (as optimus usually works), providing an awesome experience.</p><p>(Just thinking about it, unless the card is different somehow or has some feature disabled why isn&#039;t it possible?)</p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1497990">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1498009" class="blockpost roweven"> <h2><span><span class="conr">#3993</span> <a href="viewtopic.php?pid=1498009#p1498009">2015-01-30 12:48:29</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=88411">fatfingers</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2015-01-30</span></dd> <dd><span>Posts: 1</span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>apoapo wrote:</cite><blockquote><div><p>Tried to get it working for me too, but with no success. <img src="https://bbs.archlinux.org/img/smilies/sad.png" width="15" height="15" alt="sad" /></p><p>My system:<br />Radeon 7950<br />i5 3470 (non-K) incl Intel GPU for Host<br />AsRock Z77 Extreme4<br />8GB Ram</p><p>First thing I was trying was the old way, with pci-assign. I was able to first boot with VNC, installing ATI drivers. After reboot the screen woke up at login prompt and the Performance was ok/good (I wasn&#039;t trying too much. Windows Performance Index at 7.5, so it should have worked <img src="https://bbs.archlinux.org/img/smilies/wink.png" width="15" height="15" alt="wink" />). But at reboot of VM the host crashed....</p><p>So I was looking around the internet and found this thread. Tried many hours to get it working, but I don&#039;t get any picture to the screen. No Seabios Texts and nothing in Windows after installing ATI drivers with vnc (and removing VNC again) like it was working with pci-assign.</p><p>Have tried Qemu-git from AUR, Qemu-1.5-rc1, seabios from your link, stock kernel (3.9.2-1) and kernel 3.10-rc1.<br />Did not change anything <img src="https://bbs.archlinux.org/img/smilies/wink.png" width="15" height="15" alt="wink" />.</p><p>The only thing I havn&#039;t tried till now is to dump the VGA bios and put it in. Will do this today, when I´m at home.</p><p>IOMMU is enabled. logfiles look good (for me <img src="https://bbs.archlinux.org/img/smilies/big_smile.png" width="15" height="15" alt="big_smile" />). The only thing is &quot;DMAR: No ATSR found&quot;. You have a Idea about this?<br />Full logfiles I can add later.&#160; </p><p>Bind everything to vfio-pci seems to work. Also there isn&#039;t any error message at KVM-Start<br />I also tried all with pci-stub entries at grub and without, same with the interrupt remapping entry.</p><p>Do you have any Idea? <img src="https://bbs.archlinux.org/img/smilies/big_smile.png" width="15" height="15" alt="big_smile" /></p><p>Thanks<br />apo</p></div></blockquote></div><p>---------------------------------------------------------------------------------------------------------------------------------<br />I have the same mainboard except its the extreme4-M.</p><p>Brief setup ,kernel 3.18 mainline -recompiled,NO ACS PATCH ,went back to distro re-compiled kernel as issues with mainline.<br />ati 7950 and nvidia q570,xeon 1245v2<br />ATI is the boot card which then swaps to the nvidia.<br />ATI on SLOT1 and the Nvidia on slot3<br />No Xorg.conf<br />Nouveau on nvidia <br />Non UEFI / legacy kernel&#160; <br />Using the cards extracted Rom ,and the Rom Bios option in the qemu config .</p><br /><p>Some testing with the bridges as i did have a fully working pci passthrough till ubuntu went from<br />13.12 to 14.04 and xen to 4.4 i have had issues ,not sure if its xorg or the kernel,still testing <br />and havent had passthrough in xen since 4.3 and earlier kernels,hence the testing with <br />qemu again.xen does utilise the qemu platform.<br />xen 4.5 has no pci passthrough,and iam trying to get it working on qemu.</p><p>eg:</p><p>chmod 660 /sys/bus/pci/devices/0000\:00\:01.0/driver/new_id<br />chmod 660 /sys/bus/pci/devices/0000\:00\:01.0/driver/unbind</p><p>echo 8086 0151 | sudo tee /sys/bus/pci/drivers/vfio-pci/new_id</p><br /><p>I also detach and re-attach in the qemu script </p><p>virsh nodedev-reattach pci_8086_1e31<br />virsh nodedev-detach pci_8086_1e31<br />virsh nodedev-detach&#160; &#160;pci_8086_1e31 # bridge # Be careful ! this can cause major issues if the groups of the ati card and the bridge are not on their own.<br />virsh nodedev-reattach pci_8086_1e31 # bridge # Be careful ! this can cause major issues if the groups of the ati card and the bridge are not on their own.</p><p># Grub Linux Default <br />GRUB_CMDLINE_LINUX_DEFAULT=&quot;intel_iommu=on,pt,igfx_off vfio_iommu_type1.allow_unsafe_interrupts=1&#160; \<br />kvm_intel.emulate_invalid_guest_state=0 radeon.blacklist=1 radeon.modeset=0 rd.driver.blacklist=radeon rd.blacklist=radeon&quot;</p><p>I also have a modified xorg.conf to ignore and remove fbdev and vesa from attaching itself via Xorg ( takes over).<br />Also removed xorg ati and xorg fglrx from the packages.</p><p>I know this isnt a xen forum but i have found that pciback does bind to the bridge although i dont pass it through.</p><p>Regards</p><br /><p>I followed some of the intel vfio ddk ,fortunately the machine didnt fall over like i expected when unbinding this bus,intel vfio ddk -notes page 14</p> <p class="postedit"><em>Last edited by fatfingers (2015-01-31 13:04:45)</em></p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1498009">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1498069" class="blockpost rowodd"> <h2><span><span class="conr">#3994</span> <a href="viewtopic.php?pid=1498069#p1498069">2015-01-30 15:55:43</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=87826">The_Moves</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2015-01-06</span></dd> <dd><span>Posts: 58</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=87826">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>mostlyharmless wrote:</cite><blockquote><div><p>@Wooots;&#160; I usually run as root or use sudo; I&#039;m pretty sure somewhere in the last 160 pages there&#039;s some detail on how to fudge the permissions to avoid that...</p><p>@The_Moves on that note, see page 94</p></div></blockquote></div><br /><p>I&#039;ve gone through page 94, however my goal is to follow Alex&#039;s lead and get rid of all &#039;qemu&#039; calls. I&#039;ll have some dedicated time this weekend to sit and figure it out, but anything to reference will help.</p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1498069">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1498123" class="blockpost roweven"> <h2><span><span class="conr">#3995</span> <a href="viewtopic.php?pid=1498123#p1498123">2015-01-30 19:33:19</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=82709">flack</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2014-06-12</span></dd> <dd><span>Posts: 7</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=82709">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <p>Hi all i have some troubles with my KVM host computer. I dont know what can happened. So sorry for my english.</p><p>I using KVM VGA passthrough for some time i think more than six mounths. All works fine but sometimes i see only some error msq with libusb in console where i run my qemu image. I think this libusb problems is not too much big. I have usb mouse, keyobard, webcam, flashdrive and usb soundcard, usb network card attach to my qemu virtual machine. In virtual machine runs Windows 7 and here is my setting for qemu kvm.</p><div class="codebox"><pre><code>sudo vfio-bind 0000:01:00.0 0000:01:00.1 &amp;&amp; sudo qemu-system-x86_64 -rtc clock=host -cpu host,hv-time -smp 4,sockets=1,cores=2,threads=2 -M q35 -enable-kvm -m 5120 -bios /usr/share/qemu/bios.bin -vga none -device ahci,bus=pcie.0,id=ahci -drive file=/home/back/KVM/windows.iso,id=isocd -device ide-cd,bus=ahci.0,drive=isocd -drive file=/home/back/KVM/virtio.iso,id=isocd2 -device ide-cd,bus=ahci.1,drive=isocd2 -drive file=disk-preallc.qcow2,if=virtio -drive file=/media/back/btrfs-test400/ntfsDisk.qcow2,if=virtio -drive file=/media/back/btrfs-test400/ntfsDisk-preallocated.qcow2,if=virtio -drive file=/media/back/btrfs-test400/ntfs-100-Disk-preallocated.qcow2,if=virtio -boot menu=on -device ioh3420,bus=pcie.0,addr=1c.0,multifunction=on,port=1,chassis=1,id=root.1 -device vfio-pci,host=01:00.0,bus=root.1,addr=00.0,multifunction=on,x-vga=off,romfile=vbios2.rom,x-vga=on -device vfio-pci,host=01:00.1,bus=pcie.0 -usb -usbdevice host:13ba:0018 -usbdevice host:093a:2521 -usbdevice host:1a2c:0002 -usbdevice host:9710:7830 -usbdevice host:0d8c:000c -usbdevice host:041e:4064</code></pre></div><p>Three day ago i shutdown PC becouse i want to clean up the room and relocate table to near window-I have dark room. I plug off all cables from back (Monitor, mouse, power..). With this opportunity i want to try my older VGA card if still working or not. For this i go to BIOS to change primary VGA output from intelGFX(on board) to PCIe card. SHUTDOWN and remove my GTX 560 from PCIe slot and istead put older VGA card and then. Putt the all cables back to PC and POWERON ... i saw POST output on LCD i open BIOS and change primary graphic to intelGFX and shutdown PC. Remove old but workin VGA card and insert back my GTX 560 card.</p><p>Boot computer ubuntu 14.04 start and then i open browser. Site not found? whats wrong. Ohh then i see my ethernet card ETH0 missing in ifconfig. I fast reboot PC just for test. And my card still not registred like eth0. I see only eth1-this is my USB network card for qemu machine. I run my virtual machine they boot verry slow. I also try next restart of PC but pc verry slow boot and hangs. I must more time reboot pc. Now PC boot work but somethimes freeze and network card still not work. Also not blink leds and also lspci dont see this network card-like no exist. I think integrated on board network card is now die- maybe my motherboard go die.</p><p>at this moment i run dmesg and see too much this lines..</p><div class="codebox"><pre><code>[34913.005352] DMAR:[fault reason 06] PTE Read access is not set [35395.484547] dmar: DRHD: handling fault status reg 3 [35395.484553] dmar: DMAR:[DMA Read] Request device [05:00.0] fault addr ffbfc000 [35395.484553] DMAR:[fault reason 06] PTE Read access is not set [35395.957843] dmar: DRHD: handling fault status reg 3 [35395.957851] dmar: DMAR:[DMA Read] Request device [05:00.0] fault addr ffbfc000 [35395.957851] DMAR:[fault reason 06] PTE Read access is not set [36830.943853] dmar: DRHD: handling fault status reg 3 [36830.943858] dmar: DMAR:[DMA Read] Request device [05:00.0] fault addr ffbfc000 [36830.943858] DMAR:[fault reason 06] PTE Read access is not set [37196.245627] dmar: DRHD: handling fault status reg 3 [37196.245633] dmar: DMAR:[DMA Read] Request device [05:00.0] fault addr ffbfc000 </code></pre></div><p> still increasing</p><p>Yesterday i backup all files in /var/log/ but i am not guru for this. In syslog.3 there is last information about module atl1c -this was network module for my integrated network card.<br />There are syslog files <a href="http://www.mediafire.com/download/573143pixfobkbb/syslogs.zip" rel="nofollow">http://www.mediafire.com/download/57314 … yslogs.zip</a><br />I have also PCI NETWORK CARD which i use at this moment instead integrated.</p><p>This is my lspci output:</p><div class="codebox"><pre><code>00:00.0 Host bridge: Intel Corporation Xeon E3-1200 v2/3rd Gen Core processor DRAM Controller (rev 09) 00:01.0 PCI bridge: Intel Corporation Xeon E3-1200 v2/3rd Gen Core processor PCI Express Root Port (rev 09) 00:02.0 VGA compatible controller: Intel Corporation Xeon E3-1200 v2/3rd Gen Core processor Graphics Controller (rev 09) 00:14.0 USB controller: Intel Corporation 7 Series/C210 Series Chipset Family USB xHCI Host Controller (rev 04) 00:16.0 Communication controller: Intel Corporation 7 Series/C210 Series Chipset Family MEI Controller #1 (rev 04) 00:1a.0 USB controller: Intel Corporation 7 Series/C210 Series Chipset Family USB Enhanced Host Controller #2 (rev 04) 00:1b.0 Audio device: Intel Corporation 7 Series/C210 Series Chipset Family High Definition Audio Controller (rev 04) 00:1c.0 PCI bridge: Intel Corporation 7 Series/C210 Series Chipset Family PCI Express Root Port 1 (rev c4) 00:1c.4 PCI bridge: Intel Corporation 7 Series/C210 Series Chipset Family PCI Express Root Port 5 (rev c4) 00:1c.5 PCI bridge: Intel Corporation 82801 PCI Bridge (rev c4) 00:1c.7 PCI bridge: Intel Corporation 7 Series/C210 Series Chipset Family PCI Express Root Port 8 (rev c4) 00:1d.0 USB controller: Intel Corporation 7 Series/C210 Series Chipset Family USB Enhanced Host Controller #1 (rev 04) 00:1f.0 ISA bridge: Intel Corporation Z77 Express Chipset LPC Controller (rev 04) 00:1f.2 SATA controller: Intel Corporation 7 Series/C210 Series Chipset Family 6-port SATA Controller [AHCI mode] (rev 04) 00:1f.3 SMBus: Intel Corporation 7 Series/C210 Series Chipset Family SMBus Controller (rev 04) 01:00.0 VGA compatible controller: NVIDIA Corporation GF114 [GeForce GTX 560] (rev a1) 01:00.1 Audio device: NVIDIA Corporation GF114 HDMI Audio Controller (rev a1) 03:00.0 USB controller: VIA Technologies, Inc. VL80x xHCI USB 3.0 Controller (rev 03) 04:00.0 PCI bridge: Intel Corporation 82801 PCI Bridge (rev 30) 05:00.0 Ethernet controller: Realtek Semiconductor Co., Ltd. RTL8169 PCI Gigabit Ethernet Controller (rev 10) 06:00.0 SATA controller: Marvell Technology Group Ltd. 88SE9172 SATA 6Gb/s Controller (rev 11)</code></pre></div><p>kernel:</p><div class="codebox"><pre><code>Linux KVM-Ubuntu 3.15.1 #1 SMP Thu Jun 19 00:44:25 CEST 2014 x86_64 x86_64 x86_64 GNU/Linux</code></pre></div><p>&#160; &#160; <br />CPU: i7 3770<br />MB: Gigabyte Z77X-D3H ver. 1.0<br />VGA: Asus GTX 560 DCII<br />------------------------------------------<br />RAM: 12Gb=3*4Gb Crucial (i dont know which one)<br />SSD1: intel 530 256Gb&#160; (Ubuntu 14.04)<br />SSD2: samsung evo 840 256Gb (using only for qemu images)<br />HDD3: junk<br />-------------------------------------------</p><p>I think this can be related with virtualization, bios or just my mainboard is broken.</p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1498123">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1498190" class="blockpost rowodd"> <h2><span><span class="conr">#3996</span> <a href="viewtopic.php?pid=1498190#p1498190">2015-01-30 22:16:34</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=79471">Bronek</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>From: London</span></dd> <dd><span>Registered: 2014-02-14</span></dd> <dd><span>Posts: 90</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=79471">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <p>Ok so I&#039;ve finally setup serial console and my host is finally headless. I was able to capture this when restarting virtual machine, which is Windows 7 (no EFI). This happens when VM is started after guest reboot </p><div class="codebox"><pre class="vscroll"><code>[ 250.726291] ------------[ cut here ]------------ [ 250.730914] kernel BUG at drivers/pci/ats.c:138! [ 250.735535] invalid opcode: 0000 [#1] PREEMPT SMP [ 250.740379] Modules linked in: vfio_pci vfio_iommu_type1 vfio iTCO_wdt iTCO_vendor_support ext4 crc16 mbcache jbd2 mxm_wmi coretemp x86_pkg_temp_thermal intel_powerclamp kvm_intel kvm crct10dif_pclmul crc32_pclmul crc32c_intel ghash_clmulni_intel aesni_intel aes_x86_64 lrw gf128mul glue_helper ablk_helper cryptd pcspkr serio_raw sb_edac edac_core igb joydev mousedev evdev mac_hid lpc_ich i2c_i801 ptp pps_core hwmon snd_hda_intel i2c_algo_bit snd_hda_controller i2c_core snd_hda_codec mei_me mei snd_hwdep snd_pcm snd_timer snd soundcore tpm_tis ioatdma tpm dca wmi processor shpchp button sch_fq_codel zfs(PO) zunicode(PO) zavl(PO) zcommon(PO) znvpair(PO) spl(O) hid_generic usbhid hid sd_mod crc_t10dif crct10dif_common atkbd libps2 megaraid_sas ahci isci libahci libsas ehci_pci ehci_hcd xhci_hcd libata mpt2sas raid_class scsi_transport_sas usbcore scsi_mod usb_common i8042 serio bridge stp llc vhost_net tun vhost macvtap macvlan [ 250.824223] CPU: 0 PID: 1305 Comm: qemu:win171 Tainted: P O 3.17.8-2-ARCH #1 [ 250.832308] Hardware name: Supermicro X9DA7/E/X9DA7/E, BIOS 3.0a 07/02/2014 [ 250.839270] task: ffff882027203250 ti: ffff880c3facc000 task.ti: ffff880c3facc000 [ 250.846752] RIP: 0010:[&lt;ffffffff812dd5ff&gt;] [&lt;ffffffff812dd5ff&gt;] pci_restore_ats_state+0x6f/0x80 [ 250.855562] RSP: 0018:ffff880c3facfd80 EFLAGS: 00010246 [ 250.860885] RAX: 0000000000000000 RBX: ffff8820283cb000 RCX: 0000000000000ffc [ 250.868019] RDX: 00000000000000ff RSI: 0000000000000246 RDI: 0000000000000246 [ 250.875163] RBP: ffff880c3facfd88 R08: 0000000000000004 R09: ffff880c3facfd04 [ 250.882309] R10: 0000000000000000 R11: 0000000000000246 R12: ffff8820283cb000 [ 250.889443] R13: 0000000000000001 R14: 0000000000000000 R15: 0000000000000000 [ 250.896572] FS: 00007f7df0a78940(0000) GS:ffff88103fc00000(0000) knlGS:0000000000000000 [ 250.904675] CS: 0010 DS: 0000 ES: 0000 CR0: 0000000080050033 [ 250.910417] CR2: 00007f79437fdc88 CR3: 0000002027240000 CR4: 00000000001427f0 [ 250.917562] Stack: [ 250.919579] 0000000000000000 ffff880c3facfda8 ffffffff812bde59 ffff8820283cb000 [ 250.927035] ffff88202844ac28 ffff880c3facfdc0 ffffffff812be0a5 ffff8820283cb000 [ 250.934510] ffff880c3facfde0 ffffffff812be0d8 ffff88202844ac00 ffff880c3facfe50 [ 250.941967] Call Trace: [ 250.944426] [&lt;ffffffff812bde59&gt;] pci_restore_state.part.31+0x29/0x210 [ 250.950951] [&lt;ffffffff812be0a5&gt;] pci_dev_restore+0x45/0x50 [ 250.956543] [&lt;ffffffff812be0d8&gt;] pci_bus_restore+0x28/0x50 [ 250.962120] [&lt;ffffffff812c028e&gt;] pci_try_reset_bus+0x3e/0x70 [ 250.967895] [&lt;ffffffffa04333bc&gt;] vfio_pci_ioctl+0x9ac/0xa00 [vfio_pci] [ 250.974508] [&lt;ffffffffa04323b0&gt;] ? vfio_pci_mmap+0x1f0/0x1f0 [vfio_pci] [ 250.981239] [&lt;ffffffff811ea3d8&gt;] ? fsnotify+0x228/0x2f0 [ 250.986552] [&lt;ffffffffa0421283&gt;] vfio_device_fops_unl_ioctl+0x23/0x30 [vfio] [ 250.993708] [&lt;ffffffff811c01d0&gt;] do_vfs_ioctl+0x2e0/0x4c0 [ 250.999192] [&lt;ffffffff811ca08e&gt;] ? __fget+0x6e/0xb0 [ 251.004175] [&lt;ffffffff811c0431&gt;] SyS_ioctl+0x81/0xa0 [ 251.009239] [&lt;ffffffff81502129&gt;] system_call_fastpath+0x16/0x1b [ 251.015263] Code: 8b 73 38 48 8b 7b 10 83 c2 06 e8 4d a4 fd ff 5b 5d c3 66 2e 0f 1f 84 00 00 00 00 00 0f b7 70 04 8d 4e f4 83 e1 1f 80 cd 80 eb d3 &lt;0f&gt; 0b 66 66 66 66 66 66 2e 0f 1f 84 00 00 00 00 00 0f 1f 44 00 [ 251.035239] RIP [&lt;ffffffff812dd5ff&gt;] pci_restore_ats_state+0x6f/0x80 [ 251.041697] RSP &lt;ffff880c3facfd80&gt; [ 251.045286] ---[ end trace ff4dde6dedc315f3 ]---</code></pre></div><p>My kernel is 3.17.8 , I&#039;m planning upgrade to 3.18 &quot;any moment now&quot; but due to zfs used as a root filesystem this requires little work. This only happens if I restart virtual machine which is using FirePro W7100 - restart of the other virtual machine using FirePro V4900 does not trigger this bug. After hitting this bug it is not possible to gracefully shutdown qemu.</p> <p class="postedit"><em>Last edited by Bronek (2015-01-30 22:21:58)</em></p> </div> <div class="postsignature postmsg"><hr /><p>Sorry about&#160; &quot;KVM VGA-Passthrough ...&quot; thread <img src="https://bbs.archlinux.org/img/smilies/sad.png" width="15" height="15" alt="sad" /> Anyone interested in continuing this discussion elsewhere, please contact me privately. I might be able to find it a new home.</p></div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1498190">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1498196" class="blockpost roweven"> <h2><span><span class="conr">#3997</span> <a href="viewtopic.php?pid=1498196#p1498196">2015-01-30 22:32:11</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=75590">aw</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2013-10-04</span></dd> <dd><span>Posts: 921</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=75590">Email</a></span> <span class="website"><a href="http://vfio.blogspot.com/" rel="nofollow">Website</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>Bronek wrote:</cite><blockquote><div><p>Ok so I&#039;ve finally setup serial console and my host is finally headless. I was able to capture this when restarting virtual machine, which is Windows 7 (no EFI). This happens when VM is started after guest reboot </p><div class="codebox"><pre><code>[ 250.730914] kernel BUG at drivers/pci/ats.c:138!</code></pre></div><p>My kernel is 3.17.8 , I&#039;m planning upgrade to 3.18 &quot;any moment now&quot; but due to zfs used as a root filesystem this requires little work. This only happens if I restart virtual machine which is using FirePro W7100 - restart of the other virtual machine using FirePro V4900 does not trigger this bug. After hitting this bug it is not possible to gracefully shutdown qemu.</p></div></blockquote></div><p>That&#039;s saying that the device had ATS (Address Translation Services) enabled before reset, but when we went to restore the state of it after reset, we couldn&#039;t even find the capability.&#160; Maybe the device never really recovers from reset?</p> </div> <div class="postsignature postmsg"><hr /><p><a href="http://vfio.blogspot.com" rel="nofollow">http://vfio.blogspot.com</a><br />Looking for a more open forum to discuss vfio related uses?&#160; Try <a href="https://www.redhat.com/mailman/listinfo/vfio-users" rel="nofollow">https://www.redhat.com/mailman/listinfo/vfio-users</a></p></div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1498196">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1498209" class="blockpost rowodd"> <h2><span><span class="conr">#3998</span> <a href="viewtopic.php?pid=1498209#p1498209">2015-01-30 23:23:13</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=71440">cdrjameson</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd class="postavatar"><img src="https://bbs.archlinux.org/img/avatars/71440.png?m=1392914202" width="80" height="73" alt="" /></dd> <dd><span>Registered: 2013-05-19</span></dd> <dd><span>Posts: 33</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=71440">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <p>I am attempting to follow <a href="http://vfio.blogspot.co.uk/2014/08/primary-graphics-assignment-without-vga.html" rel="nofollow"> aw&#039;s blog</a> and have been following this thread on and off for a long time.</p><p>When attempting to follow this part of his instructions:</p><div class="quotebox"><cite>VFIO tips and tricks &gt; Primary Graphics Assignment Without VGA... wrote:</cite><blockquote><div><p>Make the first line of the XML look like this:</p><p>&lt;domain type=&#039;kvm&#039; xmlns:qemu=&#039;http://libvirt.org/schemas/domain/qemu/1.0&#039;&gt;</p><p>The xmlns specification is the part that needs to be added.&#160; Next we need to add OVMF, just before the &lt;/domain&gt; close at the end of the file, add something like this:</p><div class="codebox"><pre><code> &lt;qemu:commandline&gt; &lt;qemu:arg value=&#039;-drive&#039;/&gt; &lt;qemu:arg value=&#039;if=pflash,format=raw,readonly,file=/usr/share/edk2.git/ovmf-x64/OVMF-pure-efi.fd&#039;/&gt; &lt;/qemu:commandline&gt;</code></pre></div><p>Adjust the path as necessary if you&#039;re using a different installation.</p></div></blockquote></div><p>I cannot find a file called OVMF-pure-efi.fd anywhere on my system. I have tried:</p><div class="codebox"><pre><code>sudo find / -name &#039;OVMF*&#039; /home/.bigstore/Downloads/ovmf/ovmf-svn/src/tianocore-edk2-svn_build/Build/OvmfIa32/RELEASE_GCC49/FV/OVMF.fd /home/.bigstore/Downloads/ovmf/ovmf-svn/src/tianocore-edk2-svn_build/Build/OvmfIa32/RELEASE_GCC49/FV/OVMF_CODE.fd /home/.bigstore/Downloads/ovmf/ovmf-svn/src/tianocore-edk2-svn_build/Build/OvmfIa32/RELEASE_GCC49/FV/OVMF_VARS.fd /home/.bigstore/Downloads/ovmf/ovmf-svn/src/tianocore-edk2-svn_build/Build/OvmfX64/RELEASE_GCC49/FV/OVMF.fd /home/.bigstore/Downloads/ovmf/ovmf-svn/src/tianocore-edk2-svn_build/Build/OvmfX64/RELEASE_GCC49/FV/OVMF_CODE.fd /home/.bigstore/Downloads/ovmf/ovmf-svn/src/tianocore-edk2-svn_build/Build/OvmfX64/RELEASE_GCC49/FV/OVMF_VARS.fd</code></pre></div><p>Have I missed something in the installation of the ovmf-svn package? Or which of my installed files do I need to point it to? <br />P.S I am new to this game if my basic question didn&#039;t give it away.</p> <p class="postedit"><em>Last edited by cdrjameson (2015-01-30 23:25:53)</em></p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1498209">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1498211" class="blockpost roweven"> <h2><span><span class="conr">#3999</span> <a href="viewtopic.php?pid=1498211#p1498211">2015-01-30 23:31:33</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=75590">aw</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2013-10-04</span></dd> <dd><span>Posts: 921</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=75590">Email</a></span> <span class="website"><a href="http://vfio.blogspot.com/" rel="nofollow">Website</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>cdrjameson wrote:</cite><blockquote><div><p>I am attempting to follow <a href="http://vfio.blogspot.co.uk/2014/08/primary-graphics-assignment-without-vga.html" rel="nofollow"> aw&#039;s blog</a> and have been following this thread on and off for a long time.</p><p>When attempting to follow this part of his instructions:</p><div class="quotebox"><cite>VFIO tips and tricks &gt; Primary Graphics Assignment Without VGA... wrote:</cite><blockquote><div><p>Make the first line of the XML look like this:</p><p>&lt;domain type=&#039;kvm&#039; xmlns:qemu=&#039;http://libvirt.org/schemas/domain/qemu/1.0&#039;&gt;</p><p>The xmlns specification is the part that needs to be added.&#160; Next we need to add OVMF, just before the &lt;/domain&gt; close at the end of the file, add something like this:</p><div class="codebox"><pre><code> &lt;qemu:commandline&gt; &lt;qemu:arg value=&#039;-drive&#039;/&gt; &lt;qemu:arg value=&#039;if=pflash,format=raw,readonly,file=/usr/share/edk2.git/ovmf-x64/OVMF-pure-efi.fd&#039;/&gt; &lt;/qemu:commandline&gt;</code></pre></div><p>Adjust the path as necessary if you&#039;re using a different installation.</p></div></blockquote></div><p>I cannot find a file called OVMF-pure-efi.fd anywhere on my system. I have tried:</p><div class="codebox"><pre><code>sudo find / -name &#039;OVMF*&#039; /home/.bigstore/Downloads/ovmf/ovmf-svn/src/tianocore-edk2-svn_build/Build/OvmfIa32/RELEASE_GCC49/FV/OVMF.fd /home/.bigstore/Downloads/ovmf/ovmf-svn/src/tianocore-edk2-svn_build/Build/OvmfIa32/RELEASE_GCC49/FV/OVMF_CODE.fd /home/.bigstore/Downloads/ovmf/ovmf-svn/src/tianocore-edk2-svn_build/Build/OvmfIa32/RELEASE_GCC49/FV/OVMF_VARS.fd /home/.bigstore/Downloads/ovmf/ovmf-svn/src/tianocore-edk2-svn_build/Build/OvmfX64/RELEASE_GCC49/FV/OVMF.fd /home/.bigstore/Downloads/ovmf/ovmf-svn/src/tianocore-edk2-svn_build/Build/OvmfX64/RELEASE_GCC49/FV/OVMF_CODE.fd /home/.bigstore/Downloads/ovmf/ovmf-svn/src/tianocore-edk2-svn_build/Build/OvmfX64/RELEASE_GCC49/FV/OVMF_VARS.fd</code></pre></div><p>Have I missed something in the installation of the ovmf-svn package? Or which of my installed files do I need to point it to?</p></div></blockquote></div><br /><p>I&#039;d try the latter set, but you&#039;re missing an update to those instructions here:</p><p><a href="http://vfio.blogspot.com/2014/09/libvirt-now-supports-ovmf.html" rel="nofollow">http://vfio.blogspot.com/2014/09/libvir … -ovmf.html</a></p><p>My slides from KVM Forum include a further updated setup (hit space a couple times):</p><p><a href="http://awilliam.github.io/presentations/KVM-Forum-2014/#/4/2" rel="nofollow">http://awilliam.github.io/presentations … 2014/#/4/2</a></p><p>The &quot;pure&quot; name indicates that it doesn&#039;t include the CSM (Compatibility Support Module), which would provide the legacy support that we&#039;re trying to avoid.&#160; Upstream and your distro provided packages may name it differently.&#160; There are really very, very few reasons that anyone here should be using &lt;qemu:arg&gt; options any longer.&#160; If you are, you&#039;re probably doing something wrong.</p> </div> <div class="postsignature postmsg"><hr /><p><a href="http://vfio.blogspot.com" rel="nofollow">http://vfio.blogspot.com</a><br />Looking for a more open forum to discuss vfio related uses?&#160; Try <a href="https://www.redhat.com/mailman/listinfo/vfio-users" rel="nofollow">https://www.redhat.com/mailman/listinfo/vfio-users</a></p></div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1498211">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1498215" class="blockpost rowodd"> <h2><span><span class="conr">#4000</span> <a href="viewtopic.php?pid=1498215#p1498215">2015-01-30 23:51:15</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=78620">mostlyharmless</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2014-01-16</span></dd> <dd><span>Posts: 50</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=78620">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><blockquote><div><p>There are really very, very few reasons that anyone here should be using &lt;qemu:arg&gt; options any longer.&#160; If you are, you&#039;re probably doing something wrong.</p></div></blockquote></div><p>Correct me if I&#039;m wrong, but Win 7 guests and below who use libvirt will still use qemu:arg since apparently OVMF + EFI + Win 7 seems pretty fragile, at least from what I&#039;ve read here.&#160; So you&#039;re referring to Win 8+</p> <p class="postedit"><em>Last edited by mostlyharmless (2015-01-30 23:51:29)</em></p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1498215">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div class="postlinksb"> <div class="inbox crumbsplus"> <div class="pagepost"> <p class="pagelink conl"><span class="pages-label">Pages: </span><a rel="prev" class="item1" href="viewtopic.php?id=162768&amp;p=159">Previous</a> <a href="viewtopic.php?id=162768">1</a> <span class="spacer">…</span> <a href="viewtopic.php?id=162768&amp;p=158">158</a> <a href="viewtopic.php?id=162768&amp;p=159">159</a> <strong>160</strong> <a href="viewtopic.php?id=162768&amp;p=161">161</a> <a href="viewtopic.php?id=162768&amp;p=162">162</a> <span class="spacer">…</span> <a href="viewtopic.php?id=162768&amp;p=234">234</a> <a rel="next" href="viewtopic.php?id=162768&amp;p=161">Next</a></p> <p class="postlink conr">Topic closed</p> </div> <ul class="crumbs"> <li><a href="index.php">Index</a></li> <li><span>»&#160;</span><a href="viewforum.php?id=48">Topics Going Nowhere</a></li> <li><span>»&#160;</span><strong><a href="viewtopic.php?id=162768">KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</a></strong></li> </ul> <p class="subscribelink clearb"><a href="misc.php?action=subscribe&amp;tid=162768">Subscribe to this topic</a></p> <div class="clearer"></div> </div> </div> </div> <div id="brdfooter" class="block"> <h2><span>Board footer</span></h2> <div class="box"> <div id="brdfooternav" class="inbox"> <div class="conl"> <form id="qjump" method="get" action="viewforum.php"> <div><label><span>Jump to<br /></span> <select name="id" onchange="window.location=('viewforum.php?id='+this.options[this.selectedIndex].value)"> <optgroup label="Technical Issues and Assistance"> <option value="23">Newbie Corner</option> <option value="17">Installation</option> <option value="22">Kernel &amp; Hardware</option> <option value="18">Applications &amp; Desktop Environments</option> <option value="31">Laptop Issues</option> <option value="8">Networking, Server, and Protection</option> <option value="32">Multimedia and Games</option> <option value="50">System Administration</option> <option value="35">Other Architectures</option> </optgroup> <optgroup label="Arch-centric"> <option value="24">Announcements, Package &amp; Security Advisories</option> <option value="1">Arch Discussion</option> <option value="13">Forum &amp; Wiki discussion</option> </optgroup> <optgroup label="Pacman Upgrades, Packaging &amp; AUR"> <option value="44">Pacman &amp; Package Upgrade Issues</option> <option value="49">[testing] Repo Forum</option> <option value="4">Creating &amp; Modifying Packages</option> <option value="38">AUR Issues, Discussion &amp; PKGBUILD Requests</option> </optgroup> <optgroup label="Contributions &amp; Discussion"> <option value="20">GNU/Linux Discussion</option> <option value="27">Community Contributions</option> <option value="33">Programming &amp; Scripting</option> <option value="30">Other Languages</option> <option value="47">Artwork and Screenshots</option> <option value="42">Try This</option> </optgroup> <optgroup label="/dev/null"> <option value="29">Off-Topic</option> <option value="48" selected="selected">Topics Going Nowhere</option> <option value="36">Dustbin</option> </optgroup> </select></label> <input type="submit" value=" Go " accesskey="g" /> </div> </form> </div> <div class="conr"> <p id="feedlinks"><span class="atom"><a href="extern.php?action=feed&amp;tid=162768&amp;type=atom">Atom topic feed</a></span></p> <p id="poweredby">Powered by <a href="http://fluxbb.org/">FluxBB</a></p> </div> <div class="clearer"></div> </div> </div> </div> </div> <div class="end-box"></div> </div> </body> </html>
