<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"> <html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en" dir="ltr"> <head> <meta http-equiv="Content-Type" content="text/html; charset=utf-8" /> <title>KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9 (Page 85) / Topics Going Nowhere / Arch Linux Forums</title> <link rel="stylesheet" type="text/css" href="style/ArchLinux.css" /> <link rel="canonical" href="viewtopic.php?id=162768&amp;p=85" title="Page 85" /> <link rel="prev" href="viewtopic.php?id=162768&amp;p=84" title="Page 84" /> <link rel="next" href="viewtopic.php?id=162768&amp;p=86" title="Page 86" /> <link rel="alternate" type="application/atom+xml" href="extern.php?action=feed&amp;tid=162768&amp;type=atom" title="Atom topic feed" /> <link rel="stylesheet" media="screen" href="style/ArchLinux/arch.css?v=3" /> <link rel="stylesheet" media="screen" href="style/ArchLinux/archnavbar.css?v=2" /> <link rel="shortcut icon" href="style/ArchLinux/favicon.ico" /> </head> <body> <div id="archnavbar" class="anb-forum"> <div id="archnavbarlogo"><h1><a href="http://www.archlinux.org/">Arch Linux</a></h1></div> <div id="archnavbarmenu"> <ul id="archnavbarlist"> <li id="anb-home"><a href="http://www.archlinux.org/">Home</a></li><li id="anb-packages"><a href="http://www.archlinux.org/packages/">Packages</a></li><li id="anb-forums" class="anb-selected"><a href="https://bbs.archlinux.org/">Forums</a></li><li id="anb-wiki"><a href="https://wiki.archlinux.org/">Wiki</a></li><li id="anb-bugs"><a href="https://bugs.archlinux.org/">Bugs</a></li><li id="anb-aur"><a href="https://aur.archlinux.org/">AUR</a></li><li id="anb-download"><a href="http://www.archlinux.org/download/">Download</a></li> </ul> </div> </div> <div id="punviewtopic" class="pun"> <div class="top-box"></div> <div class="punwrap"> <div id="brdheader" class="block"> <div class="box"> <div id="brdmenu" class="inbox"> <ul> <li id="navindex" class="isactive"><a href="index.php">Index</a></li> <li id="navuserlist"><a href="userlist.php">User list</a></li> <li id="navsearch"><a href="search.php">Search</a></li> <li id="navprofile"><a href="profile.php?id=80749">Profile</a></li> <li id="navlogout"><a href="login.php?action=out&amp;id=80749&amp;csrf_token=5c20501ec397bb45ef8ee8c84db232c8d8e421c6">Logout</a></li> </ul> </div> <div id="brdwelcome" class="inbox"> <ul class="conl"> <li><span>Logged in as <strong>SXX</strong></span></li> <li><span>Last visit: 2015-08-16 12:20:09</span></li> </ul> <ul class="conr"> <li><span>Topics: <a href="search.php?action=show_replies" title="Find topics you have posted to.">Posted</a> | <a href="search.php?action=show_new" title="Find topics with new posts since your last visit.">New</a> | <a href="search.php?action=show_recent" title="Find topics with recent posts.">Active</a> | <a href="search.php?action=show_unanswered" title="Find topics with no replies.">Unanswered</a></span></li> </ul> <div class="clearer"></div> </div> </div> </div> <div id="brdmain"> <div class="linkst"> <div class="inbox crumbsplus"> <ul class="crumbs"> <li><a href="index.php">Index</a></li> <li><span>»&#160;</span><a href="viewforum.php?id=48">Topics Going Nowhere</a></li> <li><span>»&#160;</span><strong><a href="viewtopic.php?id=162768">KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</a></strong></li> </ul> <div class="pagepost"> <p class="pagelink conl"><span class="pages-label">Pages: </span><a rel="prev" class="item1" href="viewtopic.php?id=162768&amp;p=84">Previous</a> <a href="viewtopic.php?id=162768">1</a> <span class="spacer">…</span> <a href="viewtopic.php?id=162768&amp;p=83">83</a> <a href="viewtopic.php?id=162768&amp;p=84">84</a> <strong>85</strong> <a href="viewtopic.php?id=162768&amp;p=86">86</a> <a href="viewtopic.php?id=162768&amp;p=87">87</a> <span class="spacer">…</span> <a href="viewtopic.php?id=162768&amp;p=234">234</a> <a rel="next" href="viewtopic.php?id=162768&amp;p=86">Next</a></p> <p class="postlink conr">Topic closed</p> </div> <div class="clearer"></div> </div> </div> <div id="p1425934" class="blockpost rowodd blockpost1"> <h2><span><span class="conr">#2101</span> <a href="viewtopic.php?pid=1425934#p1425934">2014-06-14 13:57:41</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=60514">ttouch</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>From: /dev/null</span></dd> <dd><span>Registered: 2012-05-27</span></dd> <dd><span>Posts: 129</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=60514">Email</a></span> <span class="website"><a href="http://dzervas.gr" rel="nofollow">Website</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <p>Seems that I get &quot;Windows has stopped this device because it has reported problems. (Code 43)&quot;. That may be the cause of the underscan problem.<br />I searched an other users also have this problem but I can&#039;t figure out how to solve it... <img src="https://bbs.archlinux.org/img/smilies/hmm.png" width="15" height="15" alt="hmm" /><br />Any help appreciated <img src="https://bbs.archlinux.org/img/smilies/smile.png" width="15" height="15" alt="smile" /></p> </div> <div class="postsignature postmsg"><hr /><p><a href="http://github.com/ttouch" rel="nofollow">GitHub</a> | <a href="http://git.dzervas.gr" rel="nofollow">Git Server</a> | <a href="http://dzervas.gr" rel="nofollow">Blog</a></p></div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1425934">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1425955" class="blockpost roweven"> <h2><span><span class="conr">#2102</span> <a href="viewtopic.php?pid=1425955#p1425955">2014-06-14 15:15:54</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=82709">flack</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2014-06-12</span></dd> <dd><span>Posts: 7</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=82709">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>Bronek wrote:</cite><blockquote><div><div class="quotebox"><cite>flack wrote:</cite><blockquote><div><p>Hi I am here new in forum. Why you dont use somethink like this. In lsusb you can find your device vendorID and productID.</p><div class="codebox"><pre><code>back@KVM-Ubuntu:~$ lsusb Bus 002 Device 004: ID 058f:6362 Alcor Micro Corp. Flash Card Reader/Writer Bus 002 Device 003: ID 9710:7830 MosChip Semiconductor MCS7830 10/100 Mbps Ethernet adapter Bus 002 Device 002: ID 8087:0024 Intel Corp. Integrated Rate Matching Hub Bus 002 Device 001: ID 1d6b:0002 Linux Foundation 2.0 root hub Bus 006 Device 001: ID 1d6b:0003 Linux Foundation 3.0 root hub Bus 005 Device 003: ID 13ba:0018 PCPlay Barcode PCP-BCG4209 Bus 005 Device 002: ID 2109:0811 Bus 005 Device 001: ID 1d6b:0002 Linux Foundation 2.0 root hub Bus 001 Device 006: ID 04b3:310b IBM Corp. Red Wheel Mouse</code></pre></div><p>my mouse is 04b3:310b then i add this parameter to qemu.</p><div class="codebox"><pre><code>-usb -usbdevice host:04b3:310b</code></pre></div></div></blockquote></div><p>I pass both my mouse and keyboard to VM in the same way as you, it&#039;s very robust. But if you want to use host keyboard at the same time, you need a second one with a different device ID (this probably means different model or vendor). For me it does not matter, I only ssh to host anyway (when running a VM).</p><p>I wonder if a USB hub can be passed through this way (taking with it all the attached devices), didn&#039;t have time to check yet. Even better if this also worked for USB3.0 hub ...</p></div></blockquote></div><p>I know what you think. But i have KVM switch like this <a href="http://www.ebay.com/itm/BELKIN-PS-2-Port-KVM-Switch-Built-in-Cables-F1DK102P-/250710063511" rel="nofollow">http://www.ebay.com/itm/BELKIN-PS-2-Por … 0710063511</a><br />It is PS/2 switch but for Host i use PS2 input. And for Quest i use adapter ps/2--&gt;USB this one <a href="http://www.cablewholesale.com/products/usb-firewire/usb-adapters/product-uc-451g.php" rel="nofollow">http://www.cablewholesale.com/products/ … c-451g.php</a><br />I can use one monitor one keyboard and one mouse together. USB adapter have own vID and pID. But this is older method with PS/2 today all people have USB mouses and keyboards.</p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1425955">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1425974" class="blockpost rowodd"> <h2><span><span class="conr">#2103</span> <a href="viewtopic.php?pid=1425974#p1425974">2014-06-14 15:44:51</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=82762">Jdioutkast</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2014-06-14</span></dd> <dd><span>Posts: 1</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=82762">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <p>Hey aw,</p><p>I was wondering if you had any insight into this issue,</p><p>I&#039;m using a XFX R7 260X and I can get GPU passthrough working fine, but as soon as I either attempt to install the ATI driver(Windows 7) or the driver installs(Windows 8) I get an immediate BSOD, or the screen just goes black and the CPU usage of the guest goes to 100%.&#160; I also have to reboot the host to get the card working again.</p><p>I am running Fedora virt-preview with kernel 3.15.</p><p>I have tried doing the bus reset test you posted a few pages back and the screen did not clear, so I am guessing it is a bus reset issue.&#160; Any ideas on what to do next?&#160; Anything I can try to get around the issue?</p><p>Thanks!</p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1425974">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1426139" class="blockpost roweven"> <h2><span><span class="conr">#2104</span> <a href="viewtopic.php?pid=1426139#p1426139">2014-06-15 07:01:22</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=82577">vais</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2014-06-07</span></dd> <dd><span>Posts: 2</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=82577">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>aw wrote:</cite><blockquote><div><div class="quotebox"><cite>vais wrote:</cite><blockquote><div><p>In the end I believe all I need is the VGA arbiter patch: <a href="https://lkml.org/lkml/2014/5/9/517" rel="nofollow">https://lkml.org/lkml/2014/5/9/517</a> but the host graphics issue persists.</p></div></blockquote></div><p>Using this version of the patch, make sue you boot with i915.enable_hd_vgaarb=1</p></div></blockquote></div><br /><p>Yes, I pass this both as kernel parameter and in /etc/modprobe.d as an option, just in case. Still, it doesn&#039;t seem to work <img src="https://bbs.archlinux.org/img/smilies/sad.png" width="15" height="15" alt="sad" /></p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1426139">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1426149" class="blockpost rowodd"> <h2><span><span class="conr">#2105</span> <a href="viewtopic.php?pid=1426149#p1426149">2014-06-15 08:34:13</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=82779">spstarr</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2014-06-15</span></dd> <dd><span>Posts: 1</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=82779">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <p>Hello folks,</p><p>I have a Lenovo W500 laptop that has an Intel 4gen GPU (HD graphics). I&#039;m trying to pass the discrete Radeon HD3650 GPU to a WIndows 7 guest here is my configuration:</p><p>grub options:</p><div class="codebox"><pre><code>vconsole.keymap=us rhgb slub_debug=- cgroup_disable=memory console=tty0 console=ttyS0,115200n8 radeon.blacklist=1 intel_iommu=on pci-stub.ids=1002:9591 vfio_iommu_type1.allow_unsafe_interrupts=1</code></pre></div><p>/etc/modprobe.d/kvm.conf:</p><div class="codebox"><pre><code>options kvm allow_unsafe_assigned_interrupts=1 options kvm ignore_msrs=1</code></pre></div><p>Kernel sub</p><div class="codebox"><pre><code>[ 0.668873] pci-stub: add 1002:9591 sub=FFFFFFFF:FFFFFFFF cls=00000000/00000000 [ 0.669199] pci-stub 0000:01:00.0: claimed by stub [ 691.577263] pci-stub 0000:01:00.0: claimed by stub</code></pre></div><br /><p>Binded it with the script </p><div class="codebox"><pre><code>vfio-bind 0000:01:00.0</code></pre></div><p>PCI Information</p><div class="codebox"><pre class="vscroll"><code>01:00.0 VGA compatible controller: Advanced Micro Devices, Inc. [AMD/ATI] RV635/M86 [Mobility Radeon HD 3650] (prog-if 00 [VGA controller]) Subsystem: Advanced Micro Devices, Inc. [AMD/ATI] Mobility Radeon HD 3650 Physical Slot: 1-1 Control: I/O- Mem- BusMaster- SpecCycle- MemWINV- VGASnoop- ParErr- Stepping- SERR- FastB2B- DisINTx+ Status: Cap+ 66MHz- UDF- FastB2B- ParErr- DEVSEL=fast &gt;TAbort- &lt;TAbort- &lt;MAbort- &gt;SERR- &lt;PERR- INTx- Interrupt: pin A routed to IRQ 16 Region 0: Memory at c0000000 (32-bit, prefetchable) [disabled] [size=256M] Region 1: I/O ports at 2000 [disabled] [size=256] Region 2: Memory at bfff0000 (32-bit, non-prefetchable) [disabled] [size=64K] [virtual] Expansion ROM at bff00000 [disabled] [size=128K] Capabilities: [50] Power Management version 3 Flags: PMEClk- DSI- D1+ D2+ AuxCurrent=0mA PME(D0-,D1-,D2-,D3hot-,D3cold-) Status: D0 NoSoftRst- PME-Enable- DSel=0 DScale=0 PME- Capabilities: [58] Express (v2) Legacy Endpoint, MSI 00 DevCap: MaxPayload 128 bytes, PhantFunc 0, Latency L0s &lt;4us, L1 unlimited ExtTag+ AttnBtn- AttnInd- PwrInd- RBE+ FLReset- DevCtl: Report errors: Correctable- Non-Fatal- Fatal- Unsupported- RlxdOrd+ ExtTag- PhantFunc- AuxPwr- NoSnoop+ MaxPayload 128 bytes, MaxReadReq 128 bytes DevSta: CorrErr- UncorrErr- FatalErr- UnsuppReq- AuxPwr- TransPend- LnkCap: Port #0, Speed 2.5GT/s, Width x16, ASPM L0s L1, Exit Latency L0s &lt;64ns, L1 &lt;1us ClockPM- Surprise- LLActRep- BwNot- LnkCtl: ASPM Disabled; RCB 64 bytes Disabled- CommClk+ ExtSynch- ClockPM- AutWidDis- BWInt- AutBWInt- LnkSta: Speed 2.5GT/s, Width x16, TrErr- Train- SlotClk+ DLActive- BWMgmt- ABWMgmt- DevCap2: Completion Timeout: Range A, TimeoutDis+, LTR-, OBFF Not Supported DevCtl2: Completion Timeout: 50us to 50ms, TimeoutDis-, LTR-, OBFF Disabled LnkCtl2: Target Link Speed: 2.5GT/s, EnterCompliance- SpeedDis- Transmit Margin: Normal Operating Range, EnterModifiedCompliance- ComplianceSOS- Compliance De-emphasis: -6dB LnkSta2: Current De-emphasis Level: -3.5dB, EqualizationComplete-, EqualizationPhase1- EqualizationPhase2-, EqualizationPhase3-, LinkEqualizationRequest- Capabilities: [a0] MSI: Enable- Count=1/1 Maskable- 64bit+ Address: 0000000000000000 Data: 0000 Capabilities: [100 v1] Vendor Specific Information: ID=0001 Rev=1 Len=010 &lt;?&gt; Kernel driver in use: vfio-pci Kernel modules: radeon</code></pre></div><p>libvirt guest XML config:</p><div class="codebox"><pre class="vscroll"><code>&lt;!-- WARNING: THIS IS AN AUTO-GENERATED FILE. CHANGES TO IT ARE LIKELY TO BE OVERWRITTEN AND LOST. Changes to this xml configuration should be made using: virsh edit Windows7 or other application using the libvirt API. --&gt; &lt;domain type=&#039;kvm&#039; xmlns:qemu=&#039;http://libvirt.org/schemas/domain/qemu/1.0&#039;&gt; &lt;name&gt;Windows7&lt;/name&gt; &lt;uuid&gt;XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX&lt;/uuid&gt; &lt;memory unit=&#039;KiB&#039;&gt;1048576&lt;/memory&gt; &lt;currentMemory unit=&#039;KiB&#039;&gt;1048576&lt;/currentMemory&gt; &lt;vcpu placement=&#039;static&#039;&gt;1&lt;/vcpu&gt; &lt;os&gt; &lt;type arch=&#039;x86_64&#039; machine=&#039;pc-q35-2.0&#039;&gt;hvm&lt;/type&gt; &lt;boot dev=&#039;hd&#039;/&gt; &lt;/os&gt; &lt;features&gt; &lt;acpi/&gt; &lt;apic/&gt; &lt;pae/&gt; &lt;/features&gt; &lt;cpu mode=&#039;custom&#039; match=&#039;exact&#039;&gt; &lt;model fallback=&#039;allow&#039;&gt;Penryn&lt;/model&gt; &lt;/cpu&gt; &lt;clock offset=&#039;localtime&#039;&gt; &lt;timer name=&#039;rtc&#039; tickpolicy=&#039;catchup&#039;/&gt; &lt;timer name=&#039;pit&#039; tickpolicy=&#039;delay&#039;/&gt; &lt;timer name=&#039;hpet&#039; present=&#039;no&#039;/&gt; &lt;/clock&gt; &lt;on_poweroff&gt;destroy&lt;/on_poweroff&gt; &lt;on_reboot&gt;restart&lt;/on_reboot&gt; &lt;on_crash&gt;restart&lt;/on_crash&gt; &lt;pm&gt; &lt;suspend-to-mem enabled=&#039;no&#039;/&gt; &lt;suspend-to-disk enabled=&#039;no&#039;/&gt; &lt;/pm&gt; &lt;devices&gt; &lt;emulator&gt;/usr/bin/qemu-kvm&lt;/emulator&gt; &lt;disk type=&#039;block&#039; device=&#039;disk&#039;&gt; &lt;driver name=&#039;qemu&#039; type=&#039;raw&#039; cache=&#039;none&#039; io=&#039;native&#039;/&gt; &lt;source dev=&#039;/dev/sda&#039;/&gt; &lt;target dev=&#039;vda&#039; bus=&#039;virtio&#039;/&gt; &lt;address type=&#039;pci&#039; domain=&#039;0x0000&#039; bus=&#039;0x02&#039; slot=&#039;0x05&#039; function=&#039;0x0&#039;/&gt; &lt;/disk&gt; &lt;controller type=&#039;usb&#039; index=&#039;0&#039; model=&#039;ich9-ehci1&#039;&gt; &lt;address type=&#039;pci&#039; domain=&#039;0x0000&#039; bus=&#039;0x02&#039; slot=&#039;0x03&#039; function=&#039;0x7&#039;/&gt; &lt;/controller&gt; &lt;controller type=&#039;usb&#039; index=&#039;0&#039; model=&#039;ich9-uhci1&#039;&gt; &lt;master startport=&#039;0&#039;/&gt; &lt;address type=&#039;pci&#039; domain=&#039;0x0000&#039; bus=&#039;0x02&#039; slot=&#039;0x03&#039; function=&#039;0x0&#039; multifunction=&#039;on&#039;/&gt; &lt;/controller&gt; &lt;controller type=&#039;usb&#039; index=&#039;0&#039; model=&#039;ich9-uhci2&#039;&gt; &lt;master startport=&#039;2&#039;/&gt; &lt;address type=&#039;pci&#039; domain=&#039;0x0000&#039; bus=&#039;0x02&#039; slot=&#039;0x03&#039; function=&#039;0x1&#039;/&gt; &lt;/controller&gt; &lt;controller type=&#039;usb&#039; index=&#039;0&#039; model=&#039;ich9-uhci3&#039;&gt; &lt;master startport=&#039;4&#039;/&gt; &lt;address type=&#039;pci&#039; domain=&#039;0x0000&#039; bus=&#039;0x02&#039; slot=&#039;0x03&#039; function=&#039;0x2&#039;/&gt; &lt;/controller&gt; &lt;controller type=&#039;pci&#039; index=&#039;0&#039; model=&#039;pcie-root&#039;/&gt; &lt;controller type=&#039;pci&#039; index=&#039;1&#039; model=&#039;dmi-to-pci-bridge&#039;&gt; &lt;address type=&#039;pci&#039; domain=&#039;0x0000&#039; bus=&#039;0x00&#039; slot=&#039;0x1e&#039; function=&#039;0x0&#039;/&gt; &lt;/controller&gt; &lt;controller type=&#039;pci&#039; index=&#039;2&#039; model=&#039;pci-bridge&#039;&gt; &lt;address type=&#039;pci&#039; domain=&#039;0x0000&#039; bus=&#039;0x01&#039; slot=&#039;0x01&#039; function=&#039;0x0&#039;/&gt; &lt;/controller&gt; &lt;controller type=&#039;sata&#039; index=&#039;0&#039;&gt; &lt;address type=&#039;pci&#039; domain=&#039;0x0000&#039; bus=&#039;0x00&#039; slot=&#039;0x1f&#039; function=&#039;0x2&#039;/&gt; &lt;/controller&gt; &lt;controller type=&#039;virtio-serial&#039; index=&#039;0&#039;&gt; &lt;address type=&#039;pci&#039; domain=&#039;0x0000&#039; bus=&#039;0x02&#039; slot=&#039;0x04&#039; function=&#039;0x0&#039;/&gt; &lt;/controller&gt; &lt;interface type=&#039;bridge&#039;&gt; &lt;mac address=&#039;XXXXXXXXXXXXXXX&#039;/&gt; &lt;source bridge=&#039;Bridge&#039;/&gt; &lt;model type=&#039;virtio&#039;/&gt; &lt;address type=&#039;pci&#039; domain=&#039;0x0000&#039; bus=&#039;0x02&#039; slot=&#039;0x01&#039; function=&#039;0x0&#039;/&gt; &lt;/interface&gt; &lt;serial type=&#039;pty&#039;&gt; &lt;target port=&#039;0&#039;/&gt; &lt;/serial&gt; &lt;console type=&#039;pty&#039;&gt; &lt;target type=&#039;serial&#039; port=&#039;0&#039;/&gt; &lt;/console&gt; &lt;channel type=&#039;spicevmc&#039;&gt; &lt;target type=&#039;virtio&#039; name=&#039;com.redhat.spice.0&#039;/&gt; &lt;address type=&#039;virtio-serial&#039; controller=&#039;0&#039; bus=&#039;0&#039; port=&#039;1&#039;/&gt; &lt;/channel&gt; &lt;input type=&#039;tablet&#039; bus=&#039;usb&#039;/&gt; &lt;input type=&#039;mouse&#039; bus=&#039;ps2&#039;/&gt; &lt;input type=&#039;keyboard&#039; bus=&#039;ps2&#039;/&gt; &lt;graphics type=&#039;spice&#039; autoport=&#039;yes&#039;/&gt; &lt;sound model=&#039;ich6&#039;&gt; &lt;address type=&#039;pci&#039; domain=&#039;0x0000&#039; bus=&#039;0x02&#039; slot=&#039;0x02&#039; function=&#039;0x0&#039;/&gt; &lt;/sound&gt; &lt;video&gt; &lt;model type=&#039;qxl&#039; ram=&#039;65536&#039; vram=&#039;65536&#039; heads=&#039;1&#039;/&gt; &lt;address type=&#039;pci&#039; domain=&#039;0x0000&#039; bus=&#039;0x00&#039; slot=&#039;0x01&#039; function=&#039;0x0&#039;/&gt; &lt;/video&gt; &lt;memballoon model=&#039;virtio&#039;&gt; &lt;address type=&#039;pci&#039; domain=&#039;0x0000&#039; bus=&#039;0x02&#039; slot=&#039;0x06&#039; function=&#039;0x0&#039;/&gt; &lt;/memballoon&gt; &lt;/devices&gt; &lt;qemu:commandline&gt; &lt;qemu:arg value=&#039;-vga&#039;/&gt; &lt;qemu:arg value=&#039;none&#039;/&gt; &lt;qemu:arg value=&#039;-bios&#039;/&gt; &lt;qemu:arg value=&#039;/usr/share/qemu/bios.bin&#039;/&gt; &lt;qemu:arg value=&#039;-device&#039;/&gt; &lt;qemu:arg value=&#039;ioh3420,bus=pcie.0,addr=1c.0,multifunction=on,port=1,chassis=1,id=root.1&#039;/&gt; &lt;qemu:arg value=&#039;-device&#039;/&gt; &lt;qemu:arg value=&#039;vfio-pci,host=01:00.0,bus=root.1,addr=00.0,multifunction=on,x-vga=on,rombar=1,romfile=/home/spstarr/radeon-vbios.rom&#039;/&gt; &lt;/qemu:commandline&gt; &lt;/domain&gt;</code></pre></div><p>I&#039;ve tried with rombar=0, no romfile specified, none work.</p><p>- If I use virt-managet and do PCI passing I get code 43<br />- If I use my QEMU embedded flag options I get code 12.</p><p>I&#039;ve tried</p><div class="codebox"><pre><code>modprobe kvm_intel emulate_invalid_guest_state=0</code></pre></div><p>But this didn&#039;t work. </p><p>Anyone have tips? I saw someone mentioning to use multiple monitors, but when I try, I get VGA conflict errors with I start with virsh start.</p><p>additional info:<br />* I am using kernel 3.15 final<br />* QEMU 2.0.0 final release</p><p>Any help would be great!</p><p>** Update: So I&#039;m told on IRC, you *CANNOT* pass a secondary GPU to QEMU VM window or full-screen directly, there is no such way to get the GPU display to another overlay.</p> <p class="postedit"><em>Last edited by spstarr (2014-06-15 21:05:07)</em></p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1426149">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1426160" class="blockpost roweven"> <h2><span><span class="conr">#2106</span> <a href="viewtopic.php?pid=1426160#p1426160">2014-06-15 09:43:46</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=60514">ttouch</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>From: /dev/null</span></dd> <dd><span>Registered: 2012-05-27</span></dd> <dd><span>Posts: 129</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=60514">Email</a></span> <span class="website"><a href="http://dzervas.gr" rel="nofollow">Website</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>ttouch wrote:</cite><blockquote><div><p>Seems that I get &quot;Windows has stopped this device because it has reported problems. (Code 43)&quot;. That may be the cause of the underscan problem.<br />I searched an other users also have this problem but I can&#039;t figure out how to solve it... <img src="https://bbs.archlinux.org/img/smilies/hmm.png" width="15" height="15" alt="hmm" /><br />Any help appreciated <img src="https://bbs.archlinux.org/img/smilies/smile.png" width="15" height="15" alt="smile" /></p></div></blockquote></div><p>Solved with Nvidia 335 <img src="https://bbs.archlinux.org/img/smilies/big_smile.png" width="15" height="15" alt="big_smile" /><br />(Advanced search in nvidia page)</p> </div> <div class="postsignature postmsg"><hr /><p><a href="http://github.com/ttouch" rel="nofollow">GitHub</a> | <a href="http://git.dzervas.gr" rel="nofollow">Git Server</a> | <a href="http://dzervas.gr" rel="nofollow">Blog</a></p></div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1426160">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1426181" class="blockpost rowodd"> <h2><span><span class="conr">#2107</span> <a href="viewtopic.php?pid=1426181#p1426181">2014-06-15 11:31:08</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=82082">syndtr</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2014-05-18</span></dd> <dd><span>Posts: 4</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=82082">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>ttouch wrote:</cite><blockquote><div><div class="quotebox"><cite>ttouch wrote:</cite><blockquote><div><p>Seems that I get &quot;Windows has stopped this device because it has reported problems. (Code 43)&quot;. That may be the cause of the underscan problem.<br />I searched an other users also have this problem but I can&#039;t figure out how to solve it... <img src="https://bbs.archlinux.org/img/smilies/hmm.png" width="15" height="15" alt="hmm" /><br />Any help appreciated <img src="https://bbs.archlinux.org/img/smilies/smile.png" width="15" height="15" alt="smile" /></p></div></blockquote></div><p>Solved with Nvidia 335 <img src="https://bbs.archlinux.org/img/smilies/big_smile.png" width="15" height="15" alt="big_smile" /><br />(Advanced search in nvidia page)</p></div></blockquote></div><p>Or you can hide KVM hypervisor signature and continue using latest nvidia driver. You can add &#039;-cpu kvm=off&#039; to hide the kvm signature if you use current qemu git.</p><p><a href="http://lists.gnu.org/archive/html/qemu-devel/2014-06/msg00808.html" rel="nofollow">http://lists.gnu.org/archive/html/qemu- … 00808.html</a></p> <p class="postedit"><em>Last edited by syndtr (2014-06-15 11:33:03)</em></p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1426181">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1426184" class="blockpost roweven"> <h2><span><span class="conr">#2108</span> <a href="viewtopic.php?pid=1426184#p1426184">2014-06-15 12:02:49</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=82238">sinny</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2014-05-24</span></dd> <dd><span>Posts: 75</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=82238">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>Midov wrote:</cite><blockquote><div><div class="quotebox"><cite>sinny wrote:</cite><blockquote><div><div class="quotebox"><cite>ttouch wrote:</cite><blockquote><div><p>Yes.</p></div></blockquote></div><p>i&#039;m getting this as well.<br />my setup is one monitor (benq g2420hd) with connected:<br /> - DVI : host (fedora 20, i7-4770 IGP)<br /> - HDMI : guest (win 7, radeon HD 6450)</p><p>i just switch displayed input on monitor when needed.<br />host video (DVI) works just fine - native 1920x1080, no problems at all<br />but when i switch to guest video (HDMI) using 1920x1080 - i get pretty large black frame visible on the screen. so far, i &quot;solved&quot; it by decreasing screen resolution in guest</p><p>but if there is some sort of solution (e.g. it is not a problem with the monitor not being able to handle dual input correctly) - that would be great</p></div></blockquote></div><p>I had exactly same problem with my Geforce 660 over HDMI when i installed newest drivers (version 337.88) in client.<br />It went away after i deleted those drivers and installed older ones (version 335 i belive) and now its working in full screen without that anoying black frame around it.<br />It was also working without any problems when i used default drivers that windows (win8) found on its own.</p></div></blockquote></div><p>ok, found solution to hdmi underscan for radeon cards - works for me: <a href="http://superuser.com/questions/458321/change-overscan-underscan-settings-without-catalyst-control-center" rel="nofollow">link</a></p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1426184">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1426193" class="blockpost rowodd"> <h2><span><span class="conr">#2109</span> <a href="viewtopic.php?pid=1426193#p1426193">2014-06-15 13:06:45</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=60514">ttouch</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>From: /dev/null</span></dd> <dd><span>Registered: 2012-05-27</span></dd> <dd><span>Posts: 129</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=60514">Email</a></span> <span class="website"><a href="http://dzervas.gr" rel="nofollow">Website</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>syndtr wrote:</cite><blockquote><div><div class="quotebox"><cite>ttouch wrote:</cite><blockquote><div><div class="quotebox"><cite>ttouch wrote:</cite><blockquote><div><p>Seems that I get &quot;Windows has stopped this device because it has reported problems. (Code 43)&quot;. That may be the cause of the underscan problem.<br />I searched an other users also have this problem but I can&#039;t figure out how to solve it... <img src="https://bbs.archlinux.org/img/smilies/hmm.png" width="15" height="15" alt="hmm" /><br />Any help appreciated <img src="https://bbs.archlinux.org/img/smilies/smile.png" width="15" height="15" alt="smile" /></p></div></blockquote></div><p>Solved with Nvidia 335 <img src="https://bbs.archlinux.org/img/smilies/big_smile.png" width="15" height="15" alt="big_smile" /><br />(Advanced search in nvidia page)</p></div></blockquote></div><p>Or you can hide KVM hypervisor signature and continue using latest nvidia driver. You can add &#039;-cpu kvm=off&#039; to hide the kvm signature if you use current qemu git.</p><p><a href="http://lists.gnu.org/archive/html/qemu-devel/2014-06/msg00808.html" rel="nofollow">http://lists.gnu.org/archive/html/qemu- … 00808.html</a></p></div></blockquote></div><p>Is this the cause of the lowered FPS I get?<br />I tested battlefield 3 and I get a bit laggy gameplay. Just less FPS.<br />Will this solve it?<br />Also do I pass &quot;-cpu host&quot;, or just &quot;-cpu kvm=off&quot;?</p><p>Thank you.</p> </div> <div class="postsignature postmsg"><hr /><p><a href="http://github.com/ttouch" rel="nofollow">GitHub</a> | <a href="http://git.dzervas.gr" rel="nofollow">Git Server</a> | <a href="http://dzervas.gr" rel="nofollow">Blog</a></p></div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1426193">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1426201" class="blockpost roweven"> <h2><span><span class="conr">#2110</span> <a href="viewtopic.php?pid=1426201#p1426201">2014-06-15 13:46:37</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=60514">ttouch</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>From: /dev/null</span></dd> <dd><span>Registered: 2012-05-27</span></dd> <dd><span>Posts: 129</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=60514">Email</a></span> <span class="website"><a href="http://dzervas.gr" rel="nofollow">Website</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <p>I get &quot;Unable to find CPU definition: kvm=off&quot;<br />Also which are the possible optimizations I could do? (I can not find a way to search only in this topic)<br />My system:<br />Intel i7-3820<br />16GB ram<br />Asus P9X79 Deluxe<br />Asus GTX 660 Ti DirectCU II TOP</p><p>I use kernel 3.15.0-1-mainline provided by nbhs</p> <p class="postedit"><em>Last edited by ttouch (2014-06-15 13:53:24)</em></p> </div> <div class="postsignature postmsg"><hr /><p><a href="http://github.com/ttouch" rel="nofollow">GitHub</a> | <a href="http://git.dzervas.gr" rel="nofollow">Git Server</a> | <a href="http://dzervas.gr" rel="nofollow">Blog</a></p></div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1426201">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1426204" class="blockpost rowodd"> <h2><span><span class="conr">#2111</span> <a href="viewtopic.php?pid=1426204#p1426204">2014-06-15 13:56:10</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=81745">siddharta</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2014-05-03</span></dd> <dd><span>Posts: 30</span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>flack wrote:</cite><blockquote><div><div class="quotebox"><cite>Bronek wrote:</cite><blockquote><div><div class="quotebox"><cite>flack wrote:</cite><blockquote><div><p>Hi I am here new in forum. Why you dont use somethink like this. In lsusb you can find your device vendorID and productID.</p><div class="codebox"><pre><code>back@KVM-Ubuntu:~$ lsusb Bus 002 Device 004: ID 058f:6362 Alcor Micro Corp. Flash Card Reader/Writer Bus 002 Device 003: ID 9710:7830 MosChip Semiconductor MCS7830 10/100 Mbps Ethernet adapter Bus 002 Device 002: ID 8087:0024 Intel Corp. Integrated Rate Matching Hub Bus 002 Device 001: ID 1d6b:0002 Linux Foundation 2.0 root hub Bus 006 Device 001: ID 1d6b:0003 Linux Foundation 3.0 root hub Bus 005 Device 003: ID 13ba:0018 PCPlay Barcode PCP-BCG4209 Bus 005 Device 002: ID 2109:0811 Bus 005 Device 001: ID 1d6b:0002 Linux Foundation 2.0 root hub Bus 001 Device 006: ID 04b3:310b IBM Corp. Red Wheel Mouse</code></pre></div><p>my mouse is 04b3:310b then i add this parameter to qemu.</p><div class="codebox"><pre><code>-usb -usbdevice host:04b3:310b</code></pre></div></div></blockquote></div><p>I pass both my mouse and keyboard to VM in the same way as you, it&#039;s very robust. But if you want to use host keyboard at the same time, you need a second one with a different device ID (this probably means different model or vendor). For me it does not matter, I only ssh to host anyway (when running a VM).</p><p>I wonder if a USB hub can be passed through this way (taking with it all the attached devices), didn&#039;t have time to check yet. Even better if this also worked for USB3.0 hub ...</p></div></blockquote></div><p>I know what you think. But i have KVM switch like this <a href="http://www.ebay.com/itm/BELKIN-PS-2-Port-KVM-Switch-Built-in-Cables-F1DK102P-/250710063511" rel="nofollow">http://www.ebay.com/itm/BELKIN-PS-2-Por … 0710063511</a><br />It is PS/2 switch but for Host i use PS2 input. And for Quest i use adapter ps/2--&gt;USB this one <a href="http://www.cablewholesale.com/products/usb-firewire/usb-adapters/product-uc-451g.php" rel="nofollow">http://www.cablewholesale.com/products/ … c-451g.php</a><br />I can use one monitor one keyboard and one mouse together. USB adapter have own vID and pID. But this is older method with PS/2 today all people have USB mouses and keyboards.</p></div></blockquote></div><p>Having multiple USB devices with same vendor and device ID is possible with libvirt if you address them by the device address on the host (&lt;address&gt; element in &lt;source&gt; rather than &lt;vendor&gt; and &lt;product&gt;), have a look at <a href="http://libvirt.org/formatdomain.html#elementsHostDevSubsys" rel="nofollow">http://libvirt.org/formatdomain.html#el … tDevSubsys</a>. It&#039;s a bit more limiting as the address of the device will change if you plug it into a different USB port for example.</p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1426204">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1426208" class="blockpost roweven"> <h2><span><span class="conr">#2112</span> <a href="viewtopic.php?pid=1426208#p1426208">2014-06-15 14:28:47</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=82784">penetal</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2014-06-15</span></dd> <dd><span>Posts: 10</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=82784">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <p>I was planing to get a setup so I can get passthrough for the games that needs Windows to run.</p><p>My plan is to get:<br />-ASRock z97 extreme 6<br />-i7 4790</p><p>The reason I&#039;m going for that motherboard is the M.2 slot that has a speed of 4x PCIe aswell as the more common 2x slot, so I can use faster M.2 cards (not many available yet but there more might come to market later)<br />Now that will cut the dGPU to 8x lanes as the fast M.2 slot uses the CPU lanes aswell, would this in any way create a problem for the dGPU passthrough?</p><p>Also, I am really lost on memory, I have selected:<br />G.Skill TridentX DDR3 PC21300/2666MHz CL12 2x8GB<br />if anyone wish to comment one way or another on that it would be great.</p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1426208">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1426253" class="blockpost rowodd"> <h2><span><span class="conr">#2113</span> <a href="viewtopic.php?pid=1426253#p1426253">2014-06-15 18:12:27</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=82246">shawly</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2014-05-24</span></dd> <dd><span>Posts: 22</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=82246">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <p>Alright, since I&#039;m sick of not getting my GTX 770 performance problem fixed, I built in my AMD HD 6950.<br />Driver install worked and the short freezes are finally gone. &lt;3<br />BUT the Benchmark is still pretty low.. <a href="http://www.3dmark.com/3dm11/8432530" rel="nofollow">http://www.3dmark.com/3dm11/8432530</a><br />Since there is no user with this setup, I searched for users with the i7 4770 which is pretty much the same like my Xeon E3-1245v3 and these guys have an average of 9000 in physics and 5500 in graphics score.. which means that my performance sucks and isn&#039;t even above 90% of the native performance..</p><p>As you can see it doesn&#039;t even push my Xeon into 3.8Ghz turbomode and my GPU isn&#039;t very fast aswell, with my GTX 770 I had the average of 11000 graphics score which was higher than some native users benchmarks, only the cpu slowed down. But what could cause this now?</p><p>Another little question, I&#039;m using libvirt but can&#039;t get the emulated sound working, passthrough with libvirt works fine, only sound causes me trouble... I used the parameter in the first post, sound device is shown in windows, but I can&#039;t hear anything.</p> <p class="postedit"><em>Last edited by shawly (2014-06-15 18:12:47)</em></p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1426253">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1426259" class="blockpost roweven"> <h2><span><span class="conr">#2114</span> <a href="viewtopic.php?pid=1426259#p1426259">2014-06-15 18:41:13</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=82341">buraktamturk</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2014-05-28</span></dd> <dd><span>Posts: 13</span></dd> <dd class="usercontacts"><span class="email"><a href="mailto:burak@tamturk.in">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <p>I can&#039;t bind HDMI audio device to vfio-pci after compiling new 3.15 kernel.</p><div class="codebox"><pre><code>01:00.0 VGA compatible controller: Advanced Micro Devices, Inc. [AMD/ATI] Cedar [Radeon HD 5000/6000/7350/8350 Series] (prog-if 00 [VGA controller]) Subsystem: Hightech Information System Ltd. Device 2291 Flags: fast devsel, IRQ 11 Memory at e0000000 (64-bit, prefetchable) [disabled] [size=256M] Memory at f7e20000 (64-bit, non-prefetchable) [disabled] [size=128K] I/O ports at e000 [disabled] [size=256] Expansion ROM at f7e00000 [disabled] [size=128K] Capabilities: [50] Power Management version 3 Capabilities: [58] Express Legacy Endpoint, MSI 00 Capabilities: [a0] MSI: Enable- Count=1/1 Maskable- 64bit+ Capabilities: [100] Vendor Specific Information: ID=0001 Rev=1 Len=010 &lt;?&gt; Capabilities: [150] Advanced Error Reporting Kernel driver in use: vfio-pci 01:00.1 Audio device: Advanced Micro Devices, Inc. [AMD/ATI] Cedar HDMI Audio [Radeon HD 5400/6300 Series] Subsystem: Hightech Information System Ltd. Device aa68 Flags: bus master, fast devsel, latency 0, IRQ 46 Memory at f7e40000 (64-bit, non-prefetchable) [size=16K] Capabilities: [50] Power Management version 3 Capabilities: [58] Express Legacy Endpoint, MSI 00 Capabilities: [a0] MSI: Enable+ Count=1/1 Maskable- 64bit+ Capabilities: [100] Vendor Specific Information: ID=0001 Rev=1 Len=010 &lt;?&gt; Capabilities: [150] Advanced Error Reporting</code></pre></div><br /><p>As you can see &quot;vfio-bind 01:00.0&quot; works good, the device claimed by vfio driver. But &quot;vfio-bind 01:00.1&quot; just freezes, this device was claimed by snd_hda_intel, whenever i try to bind to vfio, the vfio-bind script just hangs (Ctrl+C does not stop the script). This device is claimed by snd_hda_intel even my cmdline.</p><div class="codebox"><pre><code>root=UUID=94c11fcb-ec91-4b49-b21d-d2cb08d5929e ro quiet rootfstype=xfs add_efi_memmap intel_iommu=on initrd=\EFI\debian\initrd.img vfio_iommu_type1.allow_unsafe_interrupts=1 kvm.ignore_msrs=1 pci-stub.ids=1002:9505,1002:aa18 pcie_acs_override=downstream i915.enable_hd_vgaarb=1</code></pre></div><p>vfio-bind code, (i get from somewhere at the forum)</p><div class="codebox"><pre><code>#!/bin/bash modprobe vfio-pci for dev in &quot;$@&quot;; do read -r vendor &lt;/sys/bus/pci/devices/$dev/vendor read -r device &lt;/sys/bus/pci/devices/$dev/device if [ -e /sys/bus/pci/devices/$dev/driver ]; then echo $dev &gt; /sys/bus/pci/devices/$dev/driver/unbind fi echo $vendor $device &gt; /sys/bus/pci/drivers/vfio-pci/new_id done</code></pre></div><p>(despite the script, i did not compile the vfio-pci as a module, its bundled on the kernel)</p><p>Any throughts?<br />Thanks.</p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1426259">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1426389" class="blockpost rowodd"> <h2><span><span class="conr">#2115</span> <a href="viewtopic.php?pid=1426389#p1426389">2014-06-16 04:37:42</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=82238">sinny</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2014-05-24</span></dd> <dd><span>Posts: 75</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=82238">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>buraktamturk wrote:</cite><blockquote><div><p>...</p><p>As you can see &quot;vfio-bind 01:00.0&quot; works good, the device claimed by vfio driver. But &quot;vfio-bind 01:00.1&quot; just freezes, this device was claimed by snd_hda_intel, whenever i try to bind to vfio, the vfio-bind script just hangs (Ctrl+C does not stop the script). This device is claimed by snd_hda_intel even my cmdline.</p><div class="codebox"><pre><code>root=UUID=94c11fcb-ec91-4b49-b21d-d2cb08d5929e ro quiet rootfstype=xfs add_efi_memmap intel_iommu=on initrd=\EFI\debian\initrd.img vfio_iommu_type1.allow_unsafe_interrupts=1 kvm.ignore_msrs=1 pci-stub.ids=1002:9505,1002:aa18 pcie_acs_override=downstream i915.enable_hd_vgaarb=1</code></pre></div><p>vfio-bind code, (i get from somewhere at the forum)<br />...</p><p>(despite the script, i did not compile the vfio-pci as a module, its bundled on the kernel)</p><p>Any throughts?<br />Thanks.</p></div></blockquote></div><p>if it is claimed, i guess it&#039;s id is wrong<br />i&#039;d first look at dmesg:</p><div class="codebox"><pre><code>[ 0.000000] Command line: BOOT_IMAGE=/boot/vmlinuz-3.15.0-1.vanilla.mainline.knurd.1.fc20.x86_64 root=UUID=588911d3-23f7-4544-9d46-0b06b85f287c ro pci-stub.ids=1002:6779,1002:aa98,10de:0de1,10de:0bea intel_iommu=on isolcpus=1,2,3,5,6,7 LANG=en_US.UTF-8 ... [ 0.402432] pci-stub: add 1002:6779 sub=FFFFFFFF:FFFFFFFF cls=00000000/00000000 [ 0.402578] pci-stub 0000:01:00.0: claimed by stub [ 0.402669] pci-stub: add 1002:AA98 sub=FFFFFFFF:FFFFFFFF cls=00000000/00000000 [ 0.402813] pci-stub 0000:01:00.1: claimed by stub [ 0.402904] pci-stub: add 10DE:0DE1 sub=FFFFFFFF:FFFFFFFF cls=00000000/00000000 [ 0.403058] pci-stub: add 10DE:0BEA sub=FFFFFFFF:FFFFFFFF cls=00000000/00000000 ...</code></pre></div><p>it is clearly seen here, that radeon HD 6450 is present, while nvidia gt 430 - not (10DE:* reference missing hardware)</p><p>how about &quot;lspci -nn&quot; output for additional clarity?</p><p>p.s. you cut your &quot;lspci -v&quot; output too early for others to see which kernel driver actually is used for amd audio</p> <p class="postedit"><em>Last edited by sinny (2014-06-16 04:42:34)</em></p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1426389">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1426458" class="blockpost roweven"> <h2><span><span class="conr">#2116</span> <a href="viewtopic.php?pid=1426458#p1426458">2014-06-16 11:48:08</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=82801">sedstr</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2014-06-16</span></dd> <dd><span>Posts: 2</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=82801">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <p>I&#039;ve been banging away at this, trying to achieve what may be impossible, please someone tell me.</p><p>I have an asus g74vw, it only has a single nvidia gtx670m.</p><p>What I want to do:<br />Install linux as the host, configure the network, then disable host access to basically everything but the network, I can forward X11 to the guest if I really wanted to, everything else can be done on the command line.<br />Install one windows VM and have it directly access the video card/keyboard/mouse/USB/CD, everything but the network.</p><p>I&#039;ve put all my efforts into a deb installation, I&#039;ve compiled kernels, updated qemu, but after detaching the adapter, I keep getting to...<br />ERROR&#160; &#160; Unable to read from monitor: Connection reset by peer.<br />Only a days efforts, but its tiring.</p><p>I&#039;ll have another go with archlinux, if there is actually a possibility of getting to where I want, but if someone can tell me if its achievable, and possibly some tips, I&#039;ll keep bashing away at it. </p><p>This has been one of my technical wants for like 10 years! Main reason I want things setup this way, is I want to isolate windows but still be able to play a game. else I&#039;d just run windows with linux in vmware.</p><p>TIA for any advice.</p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1426458">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1426573" class="blockpost rowodd"> <h2><span><span class="conr">#2117</span> <a href="viewtopic.php?pid=1426573#p1426573">2014-06-16 16:39:38</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=82238">sinny</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2014-05-24</span></dd> <dd><span>Posts: 75</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=82238">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>sedstr wrote:</cite><blockquote><div><p>I&#039;ve been banging away at this, trying to achieve what may be impossible, please someone tell me.</p><p>I have an asus g74vw, it only has a single nvidia gtx670m.</p><p>What I want to do:<br />Install linux as the host, configure the network, then disable host access to basically everything but the network, I can forward X11 to the guest if I really wanted to, everything else can be done on the command line.<br />Install one windows VM and have it directly access the video card/keyboard/mouse/USB/CD, everything but the network.</p><p>I&#039;ve put all my efforts into a deb installation, I&#039;ve compiled kernels, updated qemu, but after detaching the adapter, I keep getting to...<br />ERROR&#160; &#160; Unable to read from monitor: Connection reset by peer.<br />Only a days efforts, but its tiring.</p><p>I&#039;ll have another go with archlinux, if there is actually a possibility of getting to where I want, but if someone can tell me if its achievable, and possibly some tips, I&#039;ll keep bashing away at it. </p><p>This has been one of my technical wants for like 10 years! Main reason I want things setup this way, is I want to isolate windows but still be able to play a game. else I&#039;d just run windows with linux in vmware.</p><p>TIA for any advice.</p></div></blockquote></div><p>the only &quot;technical&quot; details provided are - motherboard and video card models and a single log line (not even specifying when it happens - e.g. in response to what action(-s)?)<br />imo, you are pretty much limiting the amount of help you may receive yourself</p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1426573">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1426581" class="blockpost roweven"> <h2><span><span class="conr">#2118</span> <a href="viewtopic.php?pid=1426581#p1426581">2014-06-16 16:56:18</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=82801">sedstr</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2014-06-16</span></dd> <dd><span>Posts: 2</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=82801">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>sinny wrote:</cite><blockquote><div><p>the only &quot;technical&quot; details provided are - motherboard and video card models and a single log line (not even specifying when it happens - e.g. in response to what action(-s)?)<br />imo, you are pretty much limiting the amount of help you may receive yourself</p></div></blockquote></div><p>The issue was presenting on trying to define a new VM with virt-install.<br />I&#039;d nodedev-detach the gpu and the audio successfully, the virt-install command would cause the display to reset, then I&#039;d get that message ERROR&#160; &#160; Unable to read from monitor: Connection reset by peer.</p><p>All the examples given have one adapter assigned to the host, and one to the guest, I&#039;m trying to run the host without a graphics adapter at all...<br />I was mostly interested in the &#039;is it possible&#039; question, obviously, if what I&#039;m trying to do is impossible due to some technical restriction, then I&#039;ll stop trying till I have another system more suitable.</p><p>Having said that, a few hours ago, I upgraded qemu to a later version via backports, and it started saying the hardware wasn&#039;t compatible.<br />Installed Arch, and well, learning curve, it&#039;ll take me a while to get to the stage I was at with debian ....AIX is my regular *nix.</p> <p class="postedit"><em>Last edited by sedstr (2014-06-16 17:05:17)</em></p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1426581">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1426667" class="blockpost rowodd"> <h2><span><span class="conr">#2119</span> <a href="viewtopic.php?pid=1426667#p1426667">2014-06-16 20:19:04</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=82818">lojsar</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2014-06-16</span></dd> <dd><span>Posts: 7</span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <p>The problem, RmInitAdapter failed! (0x23:0x2f:*LineNumber*), was fixed with the kvm=off patch!</p> <p class="postedit"><em>Last edited by lojsar (2014-06-17 20:00:51)</em></p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1426667">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1426809" class="blockpost roweven"> <h2><span><span class="conr">#2120</span> <a href="viewtopic.php?pid=1426809#p1426809">2014-06-17 07:15:02</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=82246">shawly</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2014-05-24</span></dd> <dd><span>Posts: 22</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=82246">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>shawly wrote:</cite><blockquote><div><p>Alright, since I&#039;m sick of not getting my GTX 770 performance problem fixed, I built in my AMD HD 6950.<br />Driver install worked and the short freezes are finally gone. &lt;3<br />BUT the Benchmark is still pretty low.. <a href="http://www.3dmark.com/3dm11/8432530" rel="nofollow">http://www.3dmark.com/3dm11/8432530</a><br />Since there is no user with this setup, I searched for users with the i7 4770 which is pretty much the same like my Xeon E3-1245v3 and these guys have an average of 9000 in physics and 5500 in graphics score.. which means that my performance sucks and isn&#039;t even above 90% of the native performance..</p><p>As you can see it doesn&#039;t even push my Xeon into 3.8Ghz turbomode and my GPU isn&#039;t very fast aswell, with my GTX 770 I had the average of 11000 graphics score which was higher than some native users benchmarks, only the cpu slowed down. But what could cause this now?</p><p>Another little question, I&#039;m using libvirt but can&#039;t get the emulated sound working, passthrough with libvirt works fine, only sound causes me trouble... I used the parameter in the first post, sound device is shown in windows, but I can&#039;t hear anything.</p></div></blockquote></div><p>/bump</p><p>I saw the OP has a similar score with the same GPU, but that post was also years ago, so I dunno anymore.. tried with so many different CPU options in libvirt.. I even tried cpu mode host-passthrough, the benchmark said the CPU had 4GHz in turbomode which can&#039;t be possible since the Xeon only has 3,8 GHz in turbomode.. the score was even lower.</p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1426809">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1426848" class="blockpost rowodd"> <h2><span><span class="conr">#2121</span> <a href="viewtopic.php?pid=1426848#p1426848">2014-06-17 10:50:01</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=75968">deniv</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2013-10-16</span></dd> <dd><span>Posts: 27</span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>shawly wrote:</cite><blockquote><div><p>BUT the Benchmark is still pretty low.. <a href="http://www.3dmark.com/3dm11/8432530" rel="nofollow">http://www.3dmark.com/3dm11/8432530</a><br />Since there is no user with this setup, I searched for users with the i7 4770 which is pretty much the same like my Xeon E3-1245v3 and these guys have an average of 9000 in physics and 5500 in graphics score.. which means that my performance sucks and isn&#039;t even above 90% of the native performance..</p></div></blockquote></div><p>Your results aren&#039;t that bad. The average for your graphics card is only 5240 (with 4900 you get 93% of that). The CPU score could be better, though (since the average is 8960).<br />Anyway, if you haven&#039;t done this yet, you can try:<br />1. Backing memory with hugepages.<br />2. Pinning vcpus.<br />3. Adding hyper-v enlightenments (hv-time, hv-relaxed, hv-vapic, hv-spinlocks=0x1000).<br />4. Kernel 3.15 since it has the debug registers patch.<br />5. Let libvirt set the CPU model without host passthrough.</p><p>While I was at it, I tried this benchmark and was quite pleased with what I got: <a href="http://www.3dmark.com/3dm11/8436872" rel="nofollow">http://www.3dmark.com/3dm11/8436872</a> The time measurement error is probably because of hv-time. My grapics card score is 14 points above the average.&#160; As for my CPU (E3-1245v2), it supports HT but for this win7 vm I use only the four main cores because most games don&#039;t profit much from HT and the &quot;emulated&quot; cores are kind of dedicated to kvm and other vms. So for 3DMark needs I have i5-3570 with the average score of 6420 while my score is 7165.</p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1426848">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1427031" class="blockpost roweven"> <h2><span><span class="conr">#2122</span> <a href="viewtopic.php?pid=1427031#p1427031">2014-06-17 20:20:39</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=82818">lojsar</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2014-06-16</span></dd> <dd><span>Posts: 7</span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <p>I have a Dell XPS-15 (L502X) laptop with nVidia GT525M in an nVidia Optimus configuration.<br />The Intel GPU is connected to the internal display.<br />The nVidia GPU is connected to a HDMI port, which to I connected a monitor.<br />VBIOS is stored in ACPI. I extracted it from nouveau&#039;s debugfs.</p><p>After some fiddling, I now have it booting:</p><p>seabios runs the VGA BIOS, but nothing is displayed on the monitor.</p><p>When I open the nVidia device, the driver complains that it can&#039;t load the VBIOS. I suspected that it wanted to find it in ACPI, so I modified the nvidia driver, replacing the function that reads VBIOS from ACPI with one that reads it from my dumpfile. This worked!<br />Is there a way I can avoid modifying the driver? I would like to launch Windows too! Is it &quot;written&quot; somewhere on the GPU that VBIOS is located in ACPI?</p><p>I see that the nVidia driver thinks CRT-0 is connected. Could this be why I don&#039;t see anything from BIOS? I was thinking maybe the card is using the wrong output. (DFP-0/HDMI is working! I just have to disable CRT-0 with xrandr to get a sane resolution)</p><p><strong>qemu command</strong></p><div class="codebox"><pre><code>exec qemu-system-x86_64 \ -enable-kvm \ -M q35 \ -m 2048 \ -cpu host,kvm=off \ -vga none \ -chardev stdio,id=seabios \ -device isa-debugcon,iobase=0x402,chardev=seabios \ -drive if=virtio,file=debian.qcow2,id=disk,format=qcow2,cache=off \ -device ioh3420,bus=pcie.0,addr=1c.0,multifunction=on,port=1,chassis=1,id=root.1 \ -device vfio-pci,host=01:00.0,bus=root.1,addr=00.0,id=gt525m,romfile=nouveau-vbios.rom,x-vga=on \</code></pre></div><p>host: linux-3.15.0 (i915.enable_hd_vgaarb=1)<br />qemu: 2.0.0 with kvm=off patch<br />seabios: 1.7.4<br />guest: Debian Sid /w linux-3.14.1 and nvidia-340.17</p> <p class="postedit"><em>Last edited by lojsar (2014-06-17 20:53:02)</em></p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1427031">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1427034" class="blockpost rowodd"> <h2><span><span class="conr">#2123</span> <a href="viewtopic.php?pid=1427034#p1427034">2014-06-17 20:31:47</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=75590">aw</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2013-10-04</span></dd> <dd><span>Posts: 921</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=75590">Email</a></span> <span class="website"><a href="http://vfio.blogspot.com/" rel="nofollow">Website</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>lojsar wrote:</cite><blockquote><div><p>When I open the nVidia device, the driver complains that it can&#039;t load the VBIOS. I suspected that it wanted to find it in ACPI, so I modified the nvidia driver, replacing the function that reads VBIOS from ACPI with one that reads it from my dumpfile. This worked!<br />Is there a way I can avoid modifying the driver? I would like to launch Windows too! Is it &quot;written&quot; somewhere on the GPU that VBIOS is located in ACPI?</p></div></blockquote></div><p>Is the VBIOS you extracted actually a PCI ROM?&#160; Run &#039;xxd nouveau-vbios.rom | less&#039; and you should see these important markers:</p><div class="codebox"><pre><code>0000000: 55aa 7eeb 4b37 3430 30e9 4c19 77cc 5649 U.~.K7400.L.w.VI 0000010: 4445 4f20 0d00 0000 8801 cf18 0000 4942 DEO ..........IB 0000020: 4d20 5647 4120 436f 6d70 6174 6962 6c65 M VGA Compatible 0000030: 0100 0000 8000 58be 3130 2f32 302f 3039 ......X.10/20/09</code></pre></div><p>The first two bytes should always be 55aa</p><div class="codebox"><pre><code>0000180: 91df aa8c 9af2 f5ff 5043 4952 de10 740a ........PCIR..t.</code></pre></div><p>Somewhere not too far in, you should be able to find &quot;PCIR&quot; and following it will be the device it&#039;s for in little endian, ex: de10 740a = 0x10de 0x0a74, which translates to NVIDIA Vendor ID, G210M device ID (<a href="http://pci-ids.ucw.cz/read/PC/10de/0a74" rel="nofollow">http://pci-ids.ucw.cz/read/PC/10de/0a74</a>).&#160; I just happen to have this ROM sitting around, the device itself only works with the basic VGA driver in a VM.</p> </div> <div class="postsignature postmsg"><hr /><p><a href="http://vfio.blogspot.com" rel="nofollow">http://vfio.blogspot.com</a><br />Looking for a more open forum to discuss vfio related uses?&#160; Try <a href="https://www.redhat.com/mailman/listinfo/vfio-users" rel="nofollow">https://www.redhat.com/mailman/listinfo/vfio-users</a></p></div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1427034">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1427036" class="blockpost roweven"> <h2><span><span class="conr">#2124</span> <a href="viewtopic.php?pid=1427036#p1427036">2014-06-17 20:43:25</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=82818">lojsar</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2014-06-16</span></dd> <dd><span>Posts: 7</span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>aw wrote:</cite><blockquote><div><div class="quotebox"><cite>lojsar wrote:</cite><blockquote><div><p>When I open the nVidia device, the driver complains that it can&#039;t load the VBIOS. I suspected that it wanted to find it in ACPI, so I modified the nvidia driver, replacing the function that reads VBIOS from ACPI with one that reads it from my dumpfile. This worked!<br />Is there a way I can avoid modifying the driver? I would like to launch Windows too! Is it &quot;written&quot; somewhere on the GPU that VBIOS is located in ACPI?</p></div></blockquote></div><p>Is the VBIOS you extracted actually a PCI ROM?&#160; Run &#039;xxd nouveau-vbios.rom | less&#039; and you should see these important markers:</p><div class="codebox"><pre><code>0000000: 55aa 7eeb 4b37 3430 30e9 4c19 77cc 5649 U.~.K7400.L.w.VI 0000010: 4445 4f20 0d00 0000 8801 cf18 0000 4942 DEO ..........IB 0000020: 4d20 5647 4120 436f 6d70 6174 6962 6c65 M VGA Compatible 0000030: 0100 0000 8000 58be 3130 2f32 302f 3039 ......X.10/20/09</code></pre></div><p>The first two bytes should always be 55aa</p><div class="codebox"><pre><code>0000180: 91df aa8c 9af2 f5ff 5043 4952 de10 740a ........PCIR..t.</code></pre></div><p>Somewhere not too far in, you should be able to find &quot;PCIR&quot; and following it will be the device it&#039;s for in little endian, ex: de10 740a = 0x10de 0x0a74, which translates to NVIDIA Vendor ID, G210M device ID (<a href="http://pci-ids.ucw.cz/read/PC/10de/0a74" rel="nofollow">http://pci-ids.ucw.cz/read/PC/10de/0a74</a>).&#160; I just happen to have this ROM sitting around, the device itself only works with the basic VGA driver in a VM.</p></div></blockquote></div><p>I think it is. seabios seemed to run it at least (I enabled seabios debug output).</p><div class="codebox"><pre class="vscroll"><code>0000000: 55aa 7feb 4b37 3430 30e9 4c19 77cc 5649 U...K7400.L.w.VI 0000010: 4445 4f20 0d00 0000 8801 3c19 0000 4942 DEO ......&lt;...IB 0000020: 4d20 5647 4120 436f 6d70 6174 6962 6c65 M VGA Compatible 0000030: 0100 0000 c000 3ab6 3032 2f31 362f 3131 ......:.02/16/11 0000040: 0000 0000 0000 0000 0010 4000 51fd 24fd ..........@.Q.$. 0000050: e996 2a00 2810 6704 ff3f fc7f 0040 0000 ..*.(.g..?...@.. 0000060: ffff ff7f 0000 0080 493f a5de e9fe 46e9 ........I?....F. 0000070: 0547 504d 4944 6c00 6f00 0000 00a0 00b0 .GPMIDl.o....... 0000080: 00b8 00c0 0033 4746 3130 3820 4531 3037 .....3GF108 E107 0000090: 3920 534b 5520 3030 3036 2056 4741 2042 9 SKU 0006 VGA B 00000a0: 494f 530d 0a00 0000 0000 0000 0000 0000 IOS............. 00000b0: 0000 0000 0000 0000 0000 0000 0000 0000 ................ 00000c0: 0000 0000 0000 0000 0000 0000 0000 0000 ................ 00000d0: 0000 0000 0000 0056 6572 7369 6f6e 2037 .......Version 7 00000e0: 302e 3038 2e35 332e 3030 2e30 3420 0d0a 0.08.53.00.04 .. 00000f0: 0043 6f70 7972 6967 6874 2028 4329 2031 .Copyright (C) 1 0000100: 3939 362d 3230 3131 204e 5649 4449 4120 996-2011 NVIDIA 0000110: 436f 7270 2e0d 0a00 0000 ffff 0000 0000 Corp............ 0000120: ffff 4746 3130 3820 426f 6172 6420 2d20 ..GF108 Board - 0000130: 3130 3739 6466 3530 0000 0000 0000 0000 1079df50........ 0000140: 0000 0000 0043 6869 7020 5265 7620 2020 .....Chip Rev 0000150: 0000 0000 0000 0000 00ba 9198 9691 9a9a ................ 0000160: 8d96 9198 dfad 9a93 9a9e 8c9a dfd2 dfb1 ................ 0000170: 908b dfb9 908d dfaf 8d90 9b8a 9c8b 9690 ................ 0000180: 91df aa8c 9af2 f5ff 5043 4952 de10 f50d ........PCIR.... 0000190: 0000 1800 0000 0003 7f00 0100 0080 0000 ................ 00001a0: 4859 4224 ffb8 4249 5400 0001 0c06 1245 HYB$..BIT......E 00001b0: 3201 0400 2c02 4202 2100 3802 4301 0e00 2...,.B.!.8.C... 00001c0: 5902 4401 0400 6702 4101 0300 6b02 4901 Y.D...g.A...k.I. 00001d0: 1200 6e02 4c01 0200 8002 4d02 1100 8202 ..n.L.....M..... 00001e0: 4e00 0000 0000 5002 3000 9302 5302 1500 N.....P.0...S... 00001f0: c302 5401 0200 d802 5501 0300 da02 5601 ..T.....U.....V. 0000200: 0600 dd02 7801 0800 e302 6401 0200 eb02 ....x.....d..... 0000210: 7001 0e00 ed02 6902 4200 fc02 0000 3e03 p.....i.B.....&gt;. 0000220: 81b0 2dc5 46cd b5ef 0000 0000 0000 0000 ..-.F........... 0000230: 0000 0000 0000 0000 0053 0870 0400 0000 .........S.p.... 0000240: 0000 a807 0000 0000 0000 0000 0200 5c5c ..............\\ 0000250: 1c02 0000 3002 0400 0000 0000 0000 0000 ....0........... 0000260: 0065 b1c6 8700 0059 b4d8 4100 0000 94b2 .e.....Y..A..... 0000270: a0b2 a6b2 beb2 0eb4 59b4 a0b2 8aef 59b4 ........Y.....Y. 0000280: 10b9 084e b113 b2b9 d200 00dc d200 008a ...N............ 0000290: b200 0047 cd00 0072 ce00 007a d000 00b9 ...G...r...z.... 00002a0: d100 0061 d200 0000 0000 00a5 d200 0000 ...a............ 00002b0: 0000 00e8 d100 00ac d100 003e d200 0042 ...........&gt;...B 00002c0: d200 0086 0050 d700 19f1 0028 81b0 1495 .....P.....(.... 00002d0: b023 2201 2345 0114 24b5 b8b0 0033 b1ef .#&quot;.#E..$....3.. 00002e0: b000 0000 0001 0100 0000 00dd 4300 0000 ............C... 00002f0: 0000 0000 0000 0000 0000 0000 0053 0870 .............S.p 0000300: 0410 003f 0f85 001e ce00 0030 322f 3033 ...?.......02/03 0000310: 2f31 3100 0000 0000 0000 0000 008e ef01 /11............. 0000320: 0100 0000 0000 0000 0000 0000 3730 3000 ............700. 0000330: 3130 3739 3030 3030 0000 0000 0000 1000 10790000........</code></pre></div><p>I uploaded the whole file here: <a href="http://cnu.no-ip.com/u/KQuzzYhbdKzG2WMIjOm4cg/nouveau-vbios.rom" rel="nofollow">http://cnu.no-ip.com/u/KQuzzYhbdKzG2WMI … -vbios.rom</a></p><p>#nouveau wasn&#039;t sure if the binary driver checked PCIROM at all. They suggested I try a tool called &quot;nvafakebios&quot;. I will do that now!</p><p>Thank you!</p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1427036">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1427037" class="blockpost rowodd"> <h2><span><span class="conr">#2125</span> <a href="viewtopic.php?pid=1427037#p1427037">2014-06-17 20:45:00</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=81541">belliash</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2014-04-25</span></dd> <dd><span>Posts: 16</span></dd> <dd class="usercontacts"><span class="email"><a href="mailto:belliash@asiotec.eu.org">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>lojsar wrote:</cite><blockquote><div><p>I have a Dell XPS-15 (L502X) laptop with nVidia GT525M in an nVidia Optimus configuration.<br />The Intel GPU is connected to the internal display.<br />The nVidia GPU is connected to a HDMI port, which to I connected a monitor.<br />VBIOS is stored in ACPI. I extracted it from nouveau&#039;s debugfs.</p><p>After some fiddling, I now have it booting:</p><p>seabios runs the VGA BIOS, but nothing is displayed on the monitor.</p><p>When I open the nVidia device, the driver complains that it can&#039;t load the VBIOS. I suspected that it wanted to find it in ACPI, so I modified the nvidia driver, replacing the function that reads VBIOS from ACPI with one that reads it from my dumpfile. This worked!<br />Is there a way I can avoid modifying the driver? I would like to launch Windows too! Is it &quot;written&quot; somewhere on the GPU that VBIOS is located in ACPI?</p><p>I see that the nVidia driver thinks CRT-0 is connected. Could this be why I don&#039;t see anything from BIOS? I was thinking maybe the card is using the wrong output.</p><p><strong>qemu command</strong></p><div class="codebox"><pre><code>exec qemu-system-x86_64 \ -enable-kvm \ -M q35 \ -m 2048 \ -cpu host,kvm=off \ -vga none \ -chardev stdio,id=seabios \ -device isa-debugcon,iobase=0x402,chardev=seabios \ -drive if=virtio,file=debian.qcow2,id=disk,format=qcow2,cache=off \ -device ioh3420,bus=pcie.0,addr=1c.0,multifunction=on,port=1,chassis=1,id=root.1 \ -device vfio-pci,host=01:00.0,bus=root.1,addr=00.0,id=gt525m,romfile=nouveau-vbios.rom,x-vga=on \</code></pre></div><p>host: linux-3.15.0 (i915.enable_hd_vgaarb=1)<br />qemu: 2.0.0 with kvm=off patch<br />seabios: 1.7.4<br />guest: Debian Sid /w linux-3.14.1 and nvidia-340.17</p></div></blockquote></div><br /><p>Most probably you nvidia gpu is not connected to HDMI, but to igp. Thats why it thinks it has CRT-0 connected.</p><p>BTW: I&#039;m also fighting with passing through my nVidia GPU, but I always got error 43 and 10/12 (cant remember) before installing nvidia driver in windows.<br />Can you tell sth more about what you done? Maybe some instruction please?</p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1427037">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div class="postlinksb"> <div class="inbox crumbsplus"> <div class="pagepost"> <p class="pagelink conl"><span class="pages-label">Pages: </span><a rel="prev" class="item1" href="viewtopic.php?id=162768&amp;p=84">Previous</a> <a href="viewtopic.php?id=162768">1</a> <span class="spacer">…</span> <a href="viewtopic.php?id=162768&amp;p=83">83</a> <a href="viewtopic.php?id=162768&amp;p=84">84</a> <strong>85</strong> <a href="viewtopic.php?id=162768&amp;p=86">86</a> <a href="viewtopic.php?id=162768&amp;p=87">87</a> <span class="spacer">…</span> <a href="viewtopic.php?id=162768&amp;p=234">234</a> <a rel="next" href="viewtopic.php?id=162768&amp;p=86">Next</a></p> <p class="postlink conr">Topic closed</p> </div> <ul class="crumbs"> <li><a href="index.php">Index</a></li> <li><span>»&#160;</span><a href="viewforum.php?id=48">Topics Going Nowhere</a></li> <li><span>»&#160;</span><strong><a href="viewtopic.php?id=162768">KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</a></strong></li> </ul> <p class="subscribelink clearb"><a href="misc.php?action=subscribe&amp;tid=162768">Subscribe to this topic</a></p> <div class="clearer"></div> </div> </div> </div> <div id="brdfooter" class="block"> <h2><span>Board footer</span></h2> <div class="box"> <div id="brdfooternav" class="inbox"> <div class="conl"> <form id="qjump" method="get" action="viewforum.php"> <div><label><span>Jump to<br /></span> <select name="id" onchange="window.location=('viewforum.php?id='+this.options[this.selectedIndex].value)"> <optgroup label="Technical Issues and Assistance"> <option value="23">Newbie Corner</option> <option value="17">Installation</option> <option value="22">Kernel &amp; Hardware</option> <option value="18">Applications &amp; Desktop Environments</option> <option value="31">Laptop Issues</option> <option value="8">Networking, Server, and Protection</option> <option value="32">Multimedia and Games</option> <option value="50">System Administration</option> <option value="35">Other Architectures</option> </optgroup> <optgroup label="Arch-centric"> <option value="24">Announcements, Package &amp; Security Advisories</option> <option value="1">Arch Discussion</option> <option value="13">Forum &amp; Wiki discussion</option> </optgroup> <optgroup label="Pacman Upgrades, Packaging &amp; AUR"> <option value="44">Pacman &amp; Package Upgrade Issues</option> <option value="49">[testing] Repo Forum</option> <option value="4">Creating &amp; Modifying Packages</option> <option value="38">AUR Issues, Discussion &amp; PKGBUILD Requests</option> </optgroup> <optgroup label="Contributions &amp; Discussion"> <option value="20">GNU/Linux Discussion</option> <option value="27">Community Contributions</option> <option value="33">Programming &amp; Scripting</option> <option value="30">Other Languages</option> <option value="47">Artwork and Screenshots</option> <option value="42">Try This</option> </optgroup> <optgroup label="/dev/null"> <option value="29">Off-Topic</option> <option value="48" selected="selected">Topics Going Nowhere</option> <option value="36">Dustbin</option> </optgroup> </select></label> <input type="submit" value=" Go " accesskey="g" /> </div> </form> </div> <div class="conr"> <p id="feedlinks"><span class="atom"><a href="extern.php?action=feed&amp;tid=162768&amp;type=atom">Atom topic feed</a></span></p> <p id="poweredby">Powered by <a href="http://fluxbb.org/">FluxBB</a></p> </div> <div class="clearer"></div> </div> </div> </div> </div> <div class="end-box"></div> </div> </body> </html>
