<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"> <html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en" dir="ltr"> <head> <meta http-equiv="Content-Type" content="text/html; charset=utf-8" /> <title>KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9 (Page 52) / Topics Going Nowhere / Arch Linux Forums</title> <link rel="stylesheet" type="text/css" href="style/ArchLinux.css" /> <link rel="canonical" href="viewtopic.php?id=162768&amp;p=52" title="Page 52" /> <link rel="prev" href="viewtopic.php?id=162768&amp;p=51" title="Page 51" /> <link rel="next" href="viewtopic.php?id=162768&amp;p=53" title="Page 53" /> <link rel="alternate" type="application/atom+xml" href="extern.php?action=feed&amp;tid=162768&amp;type=atom" title="Atom topic feed" /> <link rel="stylesheet" media="screen" href="style/ArchLinux/arch.css?v=3" /> <link rel="stylesheet" media="screen" href="style/ArchLinux/archnavbar.css?v=2" /> <link rel="shortcut icon" href="style/ArchLinux/favicon.ico" /> </head> <body> <div id="archnavbar" class="anb-forum"> <div id="archnavbarlogo"><h1><a href="http://www.archlinux.org/">Arch Linux</a></h1></div> <div id="archnavbarmenu"> <ul id="archnavbarlist"> <li id="anb-home"><a href="http://www.archlinux.org/">Home</a></li><li id="anb-packages"><a href="http://www.archlinux.org/packages/">Packages</a></li><li id="anb-forums" class="anb-selected"><a href="https://bbs.archlinux.org/">Forums</a></li><li id="anb-wiki"><a href="https://wiki.archlinux.org/">Wiki</a></li><li id="anb-bugs"><a href="https://bugs.archlinux.org/">Bugs</a></li><li id="anb-aur"><a href="https://aur.archlinux.org/">AUR</a></li><li id="anb-download"><a href="http://www.archlinux.org/download/">Download</a></li> </ul> </div> </div> <div id="punviewtopic" class="pun"> <div class="top-box"></div> <div class="punwrap"> <div id="brdheader" class="block"> <div class="box"> <div id="brdmenu" class="inbox"> <ul> <li id="navindex" class="isactive"><a href="index.php">Index</a></li> <li id="navuserlist"><a href="userlist.php">User list</a></li> <li id="navsearch"><a href="search.php">Search</a></li> <li id="navprofile"><a href="profile.php?id=80749">Profile</a></li> <li id="navlogout"><a href="login.php?action=out&amp;id=80749&amp;csrf_token=5c20501ec397bb45ef8ee8c84db232c8d8e421c6">Logout</a></li> </ul> </div> <div id="brdwelcome" class="inbox"> <ul class="conl"> <li><span>Logged in as <strong>SXX</strong></span></li> <li><span>Last visit: 2015-08-16 12:20:09</span></li> </ul> <ul class="conr"> <li><span>Topics: <a href="search.php?action=show_replies" title="Find topics you have posted to.">Posted</a> | <a href="search.php?action=show_new" title="Find topics with new posts since your last visit.">New</a> | <a href="search.php?action=show_recent" title="Find topics with recent posts.">Active</a> | <a href="search.php?action=show_unanswered" title="Find topics with no replies.">Unanswered</a></span></li> </ul> <div class="clearer"></div> </div> </div> </div> <div id="brdmain"> <div class="linkst"> <div class="inbox crumbsplus"> <ul class="crumbs"> <li><a href="index.php">Index</a></li> <li><span>»&#160;</span><a href="viewforum.php?id=48">Topics Going Nowhere</a></li> <li><span>»&#160;</span><strong><a href="viewtopic.php?id=162768">KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</a></strong></li> </ul> <div class="pagepost"> <p class="pagelink conl"><span class="pages-label">Pages: </span><a rel="prev" class="item1" href="viewtopic.php?id=162768&amp;p=51">Previous</a> <a href="viewtopic.php?id=162768">1</a> <span class="spacer">…</span> <a href="viewtopic.php?id=162768&amp;p=50">50</a> <a href="viewtopic.php?id=162768&amp;p=51">51</a> <strong>52</strong> <a href="viewtopic.php?id=162768&amp;p=53">53</a> <a href="viewtopic.php?id=162768&amp;p=54">54</a> <span class="spacer">…</span> <a href="viewtopic.php?id=162768&amp;p=234">234</a> <a rel="next" href="viewtopic.php?id=162768&amp;p=53">Next</a></p> <p class="postlink conr">Topic closed</p> </div> <div class="clearer"></div> </div> </div> <div id="p1388763" class="blockpost rowodd blockpost1"> <h2><span><span class="conr">#1276</span> <a href="viewtopic.php?pid=1388763#p1388763">2014-03-05 12:53:20</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=79471">Bronek</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>From: London</span></dd> <dd><span>Registered: 2014-02-14</span></dd> <dd><span>Posts: 90</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=79471">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>nbhs wrote:</cite><blockquote><div><p>RIght now im passing through my primary card (radeon 6950) what i did was, use pci-stub to bind it at boot and i disabled the efifb framebuffer with video=efifb:off on my grub cmdline</p></div></blockquote></div><p>that&#039;s neat, I didn&#039;t know this option <img src="https://bbs.archlinux.org/img/smilies/smile.png" width="15" height="15" alt="smile" /></p> </div> <div class="postsignature postmsg"><hr /><p>Sorry about&#160; &quot;KVM VGA-Passthrough ...&quot; thread <img src="https://bbs.archlinux.org/img/smilies/sad.png" width="15" height="15" alt="sad" /> Anyone interested in continuing this discussion elsewhere, please contact me privately. I might be able to find it a new home.</p></div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1388763">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1388773" class="blockpost roweven"> <h2><span><span class="conr">#1277</span> <a href="viewtopic.php?pid=1388773#p1388773">2014-03-05 13:19:03</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=77079">stedaniels</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>From: UK</span></dd> <dd><span>Registered: 2013-11-21</span></dd> <dd><span>Posts: 2</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=77079">Email</a></span> <span class="website"><a href="https://www.stedaniels.co.uk" rel="nofollow">Website</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <p>Hi,</p><p>I&#039;ve just set up a bare arch linux install, and I&#039;d like to start experimenting with KVM VGA-passthrough using vfio-vga.</p><p>I see there are source tarballs on the first page with patches pre-applied, and mentions of AUR, but I&#039;d rather put together a script that I can run every time there&#039;s a kernel update.</p><p>There are three patches mentioned:</p><ol class="decimal"><li><p>acs override patch</p></li><li><p>i935 vga arbiter fixes</p></li><li><p>memleak fix by xani</p></li></ol><p>1. Is the <a href="https://www.mail-archive.com/kvm@vger.kernel.org/msg92494.html" rel="nofollow">ACS override patch</a> on the kvm mailing list still the latest one?<br />2. For the <a href="http://lists.freedesktop.org/archives/intel-gfx/2013-August/032263.html" rel="nofollow">i935 vga arbiter fixes patch</a> is version 3 the latest and greatest?<br />3. <a href="https://bbs.archlinux.org/profile.php?id=77960" rel="nofollow">Xani</a> posted the <a href="https://bbs.archlinux.org/viewtopic.php?pid=1363764#p1363764" rel="nofollow">first xani memory leak fix</a> but that link is now dead, I read through and saw that <a href="https://bbs.archlinux.org/viewtopic.php?pid=1363764#p1363764" rel="nofollow">xani posted a second memory leak fix</a> but that link si also dead, does anyone have a current source?</p><p>Thanks!</p><p>I don&#039;t doubt the quality of the packages already provided, I just want a quick and easy way to rebuild and reproduce on a whim.</p><p>Thank you for all your time and energy already exerted on this adventure!</p><p>Steve</p> <p class="postedit"><em>Last edited by stedaniels (2014-03-05 13:19:22)</em></p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1388773">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1388790" class="blockpost rowodd"> <h2><span><span class="conr">#1278</span> <a href="viewtopic.php?pid=1388790#p1388790">2014-03-05 13:51:11</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=70922">nbhs</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd class="postavatar"><img src="https://bbs.archlinux.org/img/avatars/70922.jpg?m=1367773811" width="80" height="80" alt="" /></dd> <dd><span>From: Montevideo, Uruguay</span></dd> <dd><span>Registered: 2013-05-02</span></dd> <dd><span>Posts: 402</span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>stedaniels wrote:</cite><blockquote><div><p>Hi,</p><p>I&#039;ve just set up a bare arch linux install, and I&#039;d like to start experimenting with KVM VGA-passthrough using vfio-vga.</p><p>I see there are source tarballs on the first page with patches pre-applied, and mentions of AUR, but I&#039;d rather put together a script that I can run every time there&#039;s a kernel update.</p><p>There are three patches mentioned:</p><ol class="decimal"><li><p>acs override patch</p></li><li><p>i935 vga arbiter fixes</p></li><li><p>memleak fix by xani</p></li></ol><p>1. Is the <a href="https://www.mail-archive.com/kvm@vger.kernel.org/msg92494.html" rel="nofollow">ACS override patch</a> on the kvm mailing list still the latest one?<br />2. For the <a href="http://lists.freedesktop.org/archives/intel-gfx/2013-August/032263.html" rel="nofollow">i935 vga arbiter fixes patch</a> is version 3 the latest and greatest?<br />3. <a href="https://bbs.archlinux.org/profile.php?id=77960" rel="nofollow">Xani</a> posted the <a href="https://bbs.archlinux.org/viewtopic.php?pid=1363764#p1363764" rel="nofollow">first xani memory leak fix</a> but that link is now dead, I read through and saw that <a href="https://bbs.archlinux.org/viewtopic.php?pid=1363764#p1363764" rel="nofollow">xani posted a second memory leak fix</a> but that link si also dead, does anyone have a current source?</p><p>Thanks!</p><p>I don&#039;t doubt the quality of the packages already provided, I just want a quick and easy way to rebuild and reproduce on a whim.</p><p>Thank you for all your time and energy already exerted on this adventure!</p><p>Steve</p></div></blockquote></div><p>Those are not source packages, and all the patches you mention are there, you can build it yourself using <a href="https://wiki.archlinux.org/index.php/makepkg" rel="nofollow">makepkg</a></p><div class="quotebox"><cite>https://wiki.archlinux.org wrote:</cite><blockquote><div><p>makepkg is used for compiling and building packages suitable for installation with pacman, Arch Linux&#039;s package manager. makepkg is a script that automates the building of packages; it can download and validate source files, check dependencies, configure build-time settings, compile the sources, install into a temporary root, make customizations, generate meta-info, and package everything together.</p></div></blockquote></div> <p class="postedit"><em>Last edited by nbhs (2014-03-05 13:55:04)</em></p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1388790">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1388805" class="blockpost roweven"> <h2><span><span class="conr">#1279</span> <a href="viewtopic.php?pid=1388805#p1388805">2014-03-05 14:21:10</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=77079">stedaniels</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>From: UK</span></dd> <dd><span>Registered: 2013-11-21</span></dd> <dd><span>Posts: 2</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=77079">Email</a></span> <span class="website"><a href="https://www.stedaniels.co.uk" rel="nofollow">Website</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <p>Hi nbhs &amp; others,</p><p>Sorry for my ignorance and thank you for not calling me out on it!&#160; You learn something new everyday it seems.</p><p>Reading through PKGBUILD was enlightening.&#160; I&#039;d previously got this all mostly running on Ubuntu so arch is a whole new experience.</p><p>Cheers,</p><p>Steve</p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1388805">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1388814" class="blockpost rowodd"> <h2><span><span class="conr">#1280</span> <a href="viewtopic.php?pid=1388814#p1388814">2014-03-05 14:35:42</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=70922">nbhs</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd class="postavatar"><img src="https://bbs.archlinux.org/img/avatars/70922.jpg?m=1367773811" width="80" height="80" alt="" /></dd> <dd><span>From: Montevideo, Uruguay</span></dd> <dd><span>Registered: 2013-05-02</span></dd> <dd><span>Posts: 402</span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>stedaniels wrote:</cite><blockquote><div><p>Hi nbhs &amp; others,</p><p>Sorry for my ignorance and thank you for not calling me out on it!&#160; You learn something new everyday it seems.</p><p>Reading through PKGBUILD was enlightening.&#160; I&#039;d previously got this all mostly running on Ubuntu so arch is a whole new experience.</p><p>Cheers,</p><p>Steve</p></div></blockquote></div><p>Here&#039;s how you build and install these packages.</p><p>For example the kernel, unpack the linux-mainline.tar.gz file somewhere then:</p><div class="codebox"><pre><code>cd path/to/linux-mainline makepkg -s sudo pacman -U linux-mainline-*</code></pre></div><p>EDIT: Dont forget to set MAKEFLAGS to the number of cores you have on your /etc/makepkg.conf file</p> <p class="postedit"><em>Last edited by nbhs (2014-03-05 14:41:30)</em></p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1388814">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1388986" class="blockpost roweven"> <h2><span><span class="conr">#1281</span> <a href="viewtopic.php?pid=1388986#p1388986">2014-03-05 21:59:42</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=79991">mv0lnicky</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2014-03-05</span></dd> <dd><span>Posts: 16</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=79991">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <p>VGA passthrough is working great with a Radeon 5850. I have tested with a few games and performance is impressive. Tested guests were Windows 7, Fedora 20, Ubuntu 12.04 and 14.04 and Debian 7.</p><p>Using Debian Sid as host. Linux 3.13.5 with patches and QEMU from the first post in this topic.</p><p>Current script :</p><div class="codebox"><pre><code>${BIN_PATH}qemu-system-x86_64 --enable-kvm \ -M q35 -m ${RAM} -cpu ${CPU} -name ${NAME} \ -smp ${CORES},sockets=1,cores=${CORES},threads=1 \ -bios ${BIOS} \ -vga none -rtc base=localtime,clock=host \ -device ioh3420,bus=pcie.0,addr=1c.0,multifunction=on,port=1,chassis=1,id=root.1 \ -device piix4-ide,bus=pcie.0,id=ide \ -device vfio-pci,host=${GPU_RADEON},bus=root.1,addr=00.0,multifunction=on,x-vga=on,rombar=0,romfile=${GPU_BIOS} \ -device vfio-pci,host=${GPU_AUDIO},bus=root.1 \ -device vfio-pci,host=${USB_PORTS},bus=pcie.0 \ -device ich9-intel-hda,bus=pcie.0,addr=1b.0,id=sound0 \ -device hda-duplex,id=sound0-codec0,bus=sound0.0,cad=0 \ -net nic,macaddr=${MAC_ADDR},model=virtio -net tap,ifname=tap0,script=no,downscript=no \ -drive file=${HD_PATH},id=disk,if=virtio \ -boot order=cd,menu=on</code></pre></div><p>What I&#039;m wondering is how can I rebind some devices so the host after unbinding them from VFIO-PCI?</p><div class="codebox"><pre><code>echo 0000:00:1d.0 &gt; /sys/bus/pci/drivers/vfio-pci/unbind</code></pre></div><p>But I can&#039;t seem to find where to reattach it to the host. It&#039;s a USB controller hub from the motherboard. If I unbind it from host, then I&#039;m losing at least 6 USB ports. I&#039;m guessing I need to echo $vendor and $device to a new_id but I can&#039;t seem to find the right one, all I get is &quot;echo: write error: Invalid argument&quot;.</p> <p class="postedit"><em>Last edited by mv0lnicky (2014-03-06 15:22:04)</em></p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1388986">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1389035" class="blockpost rowodd"> <h2><span><span class="conr">#1282</span> <a href="viewtopic.php?pid=1389035#p1389035">2014-03-06 03:00:16</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=79825">redger</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2014-02-26</span></dd> <dd><span>Posts: 15</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=79825">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <p>A quick update - another success story ... <span style="color: blue">thanks for all your help.</span></p><p>CPU = Intel 4670, MBoard = Asrock Z87 Extreme6, RAM=16GB 1600, GPU = Radeon HD6950, Arch Host Kernel 3.13, Window 7 guest, Renesas based PCIe add-on card passed to the guest</p><p>I get about 70-80% native performance under my test conditions (rfacvtor v1, using 11 AI drivers offline). Most importantly there is no micro-stutter problem and no significant latency issues (any more)<br />I found that allocating multiple CPUs made a noticeable difference to frame rate and subjective experience (surprisingly since I thought this app was GPU limited not CPU)<br />Test results reported below are expressed as frames / sec as reported in the application (all a bit subjective, but good enough to indicate what to expect). The test was deliberately set up to present a reasonable maximum load. In practice most situations present a lower load than the test case so &quot;normal&quot; performance will be better than reported here<br />&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;Qemu&#160; &#160; &#160;Qemu&#160; &#160; &#160; &#160; &#160; Native&#160; &#160; &#160; &#160; Native<br />Track Position&#160; &#160; 2 CPU&#160; &#160; 1 CPU&#160; &#160; &#160; &#160; &#160; 4 CPU&#160; &#160; &#160; &#160;1 CPU<br />---------------------&#160; &#160; ---------&#160; &#160; &#160;--------&#160; &#160; &#160; &#160; &#160; &#160;---------&#160; &#160; &#160; &#160; ---------<br />Pits&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;30+&#160; &#160; &#160; &#160; &#160;20+&#160; &#160; &#160; &#160; &#160; &#160; &#160;40+&#160; &#160; &#160; &#160; &#160; &#160;40+<br />Start Grid&#160; &#160; &#160; &#160; &#160; &#160; &#160;40+&#160; &#160; &#160; &#160; &#160;25+&#160; &#160; &#160; &#160; &#160; &#160; &#160;60+&#160; &#160; &#160; &#160; &#160; &#160;50+<br />StartF Straight&#160; &#160; &#160; 70+&#160; &#160; &#160; &#160; &#160;30+&#160; &#160; &#160; &#160; &#160; &#160;100+&#160; &#160; &#160; &#160; &#160; &#160;90+</p><p>2 lap MAX&#160; &#160; &#160; &#160; &#160; &#160; 70+&#160; &#160; &#160; &#160; &#160;50+&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; 100+</p><p>Note that Native mode is based on a full 4 CPUs on the Intel 4670 ..... CPU constraints are applied at the App level (there&#039;s a parameter with options all-CPUs or 1-CPU) so there&#039;s no obvious way to reproduce the guest CPU count</p><p>Online racing against other (real) people I can see frame rates over 200 fps depending on track and mod (cars) ie. quite acceptable and very useable. Furthermore there are no significant lag issues which means that it is practical to follow closely without crashing eg. if they brake suddenly you have time to react because there is no more detectable lag than a native installation.</p><p>After applying this patch to fix the Qemu assertion error (I had to modify this <a href="https://git.kernel.org/cgit/virt/kvm/mst/qemu.git/commit/?id=0217598857eaf0ceae137cdd71445118af2284cf/" rel="nofollow">PCIE: fix regression with coldplugged multifunction device</a>&#160; to get it to apply)</p><div class="codebox"><pre class="vscroll"><code>diff --git a/qemu/hw/pci/pcie.c b/qemu/hw/pci/pcie.c index 8ecd11e..02cde6f 100644 --- a/qemu/hw/pci/pcie.c +++ b/qemu/hw/pci/pcie.c @@ -221,29 +221,23 @@ DeviceState *dev, uint8_t **exp_cap, Error **errp) { - PCIDevice *pci_dev = PCI_DEVICE(dev); *exp_cap = hotplug_dev-&gt;config + hotplug_dev-&gt;exp.exp_cap; uint16_t sltsta = pci_get_word(*exp_cap + PCI_EXP_SLTSTA); - PCIE_DEV_PRINTF(pci_dev, &quot;hotplug state: %d\n&quot;, state); + PCIE_DEV_PRINTF(PCI_DEVICE(dev), &quot;hotplug state: %d\n&quot;, state); if (sltsta &amp; PCI_EXP_SLTSTA_EIS) { /1 /bin /boot /cdrom /dev /etc /home /initrd.img /initrd.img.old /lib /lib32 /lib64 /libx32 /lost+found /media /mnt /opt /proc /root /run /sbin /srv /sys /tmp /ubiquity-apt-clone /usr /var /vmlinuz /vmlinuz.old /win81-base.qcow2 /win81-base.qcow2.md5 /win81-writable-amd.qcow2 /win81-writable-nvidia.qcow2 /win81-writable-nvidia.qcow2.backup the slot is electromechanically locked. 1.sh topic_10.html topic_11.html topic_12.html topic_13.html topic_14.html topic_15.html topic_16.html topic_17.html topic_18.html topic_19.html topic_1.html topic_20.html topic_21.html topic_22.html topic_23.html topic_24.html topic_25.html topic_26.html topic_27.html topic_28.html topic_29.html topic_2.html topic_30.html topic_31.html topic_32.html topic_33.html topic_34.html topic_35.html topic_36.html topic_37.html topic_38.html topic_39.html topic_3.html topic_40.html topic_41.html topic_42.html topic_43.html topic_44.html topic_45.html topic_46.html topic_47.html topic_48.html topic_49.html topic_4.html topic_50.html topic_51.html topic_5.html topic_6.html topic_7.html topic_8.html topic_9.html This error is propagated up to qdev and then to HMP/QMP. */ error_setg_errno(errp, -EBUSY, &quot;slot is electromechanically locked&quot;); } - - /1 /bin /boot /cdrom /dev /etc /home /initrd.img /initrd.img.old /lib /lib32 /lib64 /libx32 /lost+found /media /mnt /opt /proc /root /run /sbin /srv /sys /tmp /ubiquity-apt-clone /usr /var /vmlinuz /vmlinuz.old /win81-base.qcow2 /win81-base.qcow2.md5 /win81-writable-amd.qcow2 /win81-writable-nvidia.qcow2 /win81-writable-nvidia.qcow2.backup TODO: multifunction hot-plug. - 1.sh topic_10.html topic_11.html topic_12.html topic_13.html topic_14.html topic_15.html topic_16.html topic_17.html topic_18.html topic_19.html topic_1.html topic_20.html topic_21.html topic_22.html topic_23.html topic_24.html topic_25.html topic_26.html topic_27.html topic_28.html topic_29.html topic_2.html topic_30.html topic_31.html topic_32.html topic_33.html topic_34.html topic_35.html topic_36.html topic_37.html topic_38.html topic_39.html topic_3.html topic_40.html topic_41.html topic_42.html topic_43.html topic_44.html topic_45.html topic_46.html topic_47.html topic_48.html topic_49.html topic_4.html topic_50.html topic_51.html topic_5.html topic_6.html topic_7.html topic_8.html topic_9.html Right now, only a device of function = 0 is allowed to be - 1.sh topic_10.html topic_11.html topic_12.html topic_13.html topic_14.html topic_15.html topic_16.html topic_17.html topic_18.html topic_19.html topic_1.html topic_20.html topic_21.html topic_22.html topic_23.html topic_24.html topic_25.html topic_26.html topic_27.html topic_28.html topic_29.html topic_2.html topic_30.html topic_31.html topic_32.html topic_33.html topic_34.html topic_35.html topic_36.html topic_37.html topic_38.html topic_39.html topic_3.html topic_40.html topic_41.html topic_42.html topic_43.html topic_44.html topic_45.html topic_46.html topic_47.html topic_48.html topic_49.html topic_4.html topic_50.html topic_51.html topic_5.html topic_6.html topic_7.html topic_8.html topic_9.html hot plugged/unplugged. - */ - assert(PCI_FUNC(pci_dev-&gt;devfn) == 0); } void pcie_cap_slot_hotplug_cb(HotplugHandler *hotplug_dev, DeviceState *dev, Error **errp) { uint8_t *exp_cap; + PCIDevice *pci_dev = PCI_DEVICE(dev); pcie_cap_slot_hotplug_common(PCI_DEVICE(hotplug_dev), dev, &amp;exp_cap, errp); @@ -255,6 +249,11 @@ PCI_EXP_SLTSTA_PDS); return; } + /1 /bin /boot /cdrom /dev /etc /home /initrd.img /initrd.img.old /lib /lib32 /lib64 /libx32 /lost+found /media /mnt /opt /proc /root /run /sbin /srv /sys /tmp /ubiquity-apt-clone /usr /var /vmlinuz /vmlinuz.old /win81-base.qcow2 /win81-base.qcow2.md5 /win81-writable-amd.qcow2 /win81-writable-nvidia.qcow2 /win81-writable-nvidia.qcow2.backup TODO: multifunction hot-plug. + 1.sh topic_10.html topic_11.html topic_12.html topic_13.html topic_14.html topic_15.html topic_16.html topic_17.html topic_18.html topic_19.html topic_1.html topic_20.html topic_21.html topic_22.html topic_23.html topic_24.html topic_25.html topic_26.html topic_27.html topic_28.html topic_29.html topic_2.html topic_30.html topic_31.html topic_32.html topic_33.html topic_34.html topic_35.html topic_36.html topic_37.html topic_38.html topic_39.html topic_3.html topic_40.html topic_41.html topic_42.html topic_43.html topic_44.html topic_45.html topic_46.html topic_47.html topic_48.html topic_49.html topic_4.html topic_50.html topic_51.html topic_5.html topic_6.html topic_7.html topic_8.html topic_9.html Right now, only a device of function = 0 is allowed to be + 1.sh topic_10.html topic_11.html topic_12.html topic_13.html topic_14.html topic_15.html topic_16.html topic_17.html topic_18.html topic_19.html topic_1.html topic_20.html topic_21.html topic_22.html topic_23.html topic_24.html topic_25.html topic_26.html topic_27.html topic_28.html topic_29.html topic_2.html topic_30.html topic_31.html topic_32.html topic_33.html topic_34.html topic_35.html topic_36.html topic_37.html topic_38.html topic_39.html topic_3.html topic_40.html topic_41.html topic_42.html topic_43.html topic_44.html topic_45.html topic_46.html topic_47.html topic_48.html topic_49.html topic_4.html topic_50.html topic_51.html topic_5.html topic_6.html topic_7.html topic_8.html topic_9.html hot plugged/unplugged. + */ + assert(PCI_FUNC(pci_dev-&gt;devfn) == 0); pci_word_test_and_set_mask(exp_cap + PCI_EXP_SLTSTA, PCI_EXP_SLTSTA_PDS);</code></pre></div><p>And then away it went (using Qemu 1.7 from the repos failed)</p><p>Note that i did apply the following tuning factors -<br />-&#160; hugetlbfs&#160; (mine set to 3200 - for a 6GB guest)<br />-&#160; -cpu Haswell,hv-time,hv_relaxed,hv_vapic,hv_spinlocks=0x1000<br />-&#160; kernel compiled with CONFIG_PCI_STUB=y CONFIG_PREEMPT_VOLUNTARY=y&#160; &#160;and&#160; CONFIG_HZ_1000=y&#160; &#160; and&#160; CONFIG_HZ=1000&#160; &#160; (in addition to the CONFIG_VFIO and parameters set to y)</p><p>final command now looks like this </p><div class="codebox"><pre><code>qemu-system-x86_64 -name win7 -enable-kvm -M q35 -m 6144 -mem-path /dev/hugepages \ -cpu Haswell,hv-time,hv_relaxed,hv_vapic,hv_spinlocks=0x1000 \ -boot menu=on \ -smp 2,sockets=1,cores=2,threads=1 \ -bios /usr/share/qemu/bios.bin -vga none \ -usbdevice tablet \ -spice port=5902,disable-ticketing \ -device ioh3420,bus=pcie.0,addr=1c.0,multifunction=on,port=1,chassis=1,id=root.1 \ -device ahci,bus=pcie.0,id=ahci \ -net nic,macaddr=00:00:00:0a:5b:2c,model=virtio \ -net user \ -device vfio-pci,host=01:00.0,bus=root.1,addr=00.0,multifunction=on,x-vga=on \ -device vfio-pci,host=01:00.1,bus=root.1,addr=00.1 \ -device vfio-pci,host=02:00.0,bus=pcie.0 \ -device vfio-pci,host=04:00.0,bus=pcie.0 \ -device vfio-pci,host=06:00.0,bus=pcie.0 \ -device vfio-pci,host=05:00.0,bus=pcie.0 \ -drive file=/dev/virt-test-xen/lvwin7a_kvm,id=disk1,format=raw,if=virtio \ -drive file=/dev/sda3,id=disk2,format=raw,if=virtio \ -drive file=/dev/sda2,id=disk3,format=raw,if=virtio \ -drive file=/home/redger/Downloads/isos/virtio-win-0.1-74.iso,id=isocd2 \ -device ide-cd,bus=ahci.2,drive=isocd2 \ -drive file=/home/redger/Downloads/isos/winfiles.iso,id=isocd3 \ -device ide-cd,bus=ahci.3,drive=isocd3</code></pre></div><p>You can see above I&#039;m passing through (a) GPUat 1:00:0 (b) Renesas USB card at 2:00.0 (c) NIC at 04:00.0 (d) Asmedia disk controllers at 05:00.0 and 06:00.0 (e) windows install from LVM partition (f) Virtio drivers on iso image as CD-Rom (g) Asrock motherboard drivers and Renesas drivers on iso image as CD-Rom&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;plus a virtual NIC which I disable as soon as the passed through device is running. I also use Spice for initial keyboard communications until the USB card drivers are loaded and working.</p><p>Grub command line -</p><div class="codebox"><pre><code>GRUB_CMDLINE_LINUX_DEFAULT=&quot;intel_iommu=on nohz=off pci-stub.ids=8086:0c01,8086:0c09,1002:6719,1002:aa80,1912:0014,8086:8c10,8086:8c14,8086:8c16,8086:8c18,1b21:0612,8086:1539 quiet&quot;</code></pre></div><p>Things to do -<br />- obtain kernel 3.14 with debug register patches (in addition to existing patches, most of which are presumably included in 3.14)<br />- install Windows on a dedicated disk (requires Asrock Asmedia drivers incorporated into initial install, hence std command includes &quot;Winfiles&quot; &quot;CD-Rom&quot; which makes those drivers available)<br />- Review sound - the GPU sound device is not working (I use USB wireless headphones so not a current issue)</p><p>Thanks again for all your help</p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1389035">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1389307" class="blockpost roweven"> <h2><span><span class="conr">#1283</span> <a href="viewtopic.php?pid=1389307#p1389307">2014-03-06 19:39:45</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=78355">anickname</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2014-01-07</span></dd> <dd><span>Posts: 23</span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><blockquote><div><p>RIght now im passing through my primary card (radeon 6950) what i did was, use pci-stub to bind it at boot and i disabled the efifb framebuffer with video=efifb:off on my grub cmdline</p></div></blockquote></div><p>Are you booting using UEFI or BIOS mode ?<br />The onboard video is it enabled or disabled ?<br />What about &quot;IGPU Multi Monitor&quot; and &quot;Render standby&quot; options ?</p><p>I tried booting using BIOS, onboard GPU, both enabled and disabled; It didn&#039;t worked for me.<br />I see the seabios screen but after it only random pixels. I think that both Windows and Linux are<br />trying to write to the GPU.</p><p>I used pci-stub and video=vesafb:off in the command line.</p><p>Thanks.</p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1389307">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1389329" class="blockpost rowodd"> <h2><span><span class="conr">#1284</span> <a href="viewtopic.php?pid=1389329#p1389329">2014-03-06 20:12:55</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=79991">mv0lnicky</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2014-03-05</span></dd> <dd><span>Posts: 16</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=79991">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>mv0lnicky wrote:</cite><blockquote><div><p>What I&#039;m wondering is how can I rebind some devices so the host after unbinding them from VFIO-PCI?</p><div class="codebox"><pre><code>echo 0000:00:1d.0 &gt; /sys/bus/pci/drivers/vfio-pci/unbind</code></pre></div><p>But I can&#039;t seem to find where to reattach it to the host. It&#039;s a USB controller hub from the motherboard. If I unbind it from host, then I&#039;m losing at least 6 USB ports. I&#039;m guessing I need to echo $vendor and $device to a new_id but I can&#039;t seem to find the right one, all I get is &quot;echo: write error: Invalid argument&quot;.</p></div></blockquote></div><p> Ok I found out that rebind to host, I just need to bind to the driver. So in my case </p><div class="codebox"><pre><code>echo &quot;0000:00:1d.0&quot; &gt; /sys/bus/pci/drivers/ehci-pci/bind </code></pre></div> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1389329">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1389330" class="blockpost roweven"> <h2><span><span class="conr">#1285</span> <a href="viewtopic.php?pid=1389330#p1389330">2014-03-06 20:19:32</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=70922">nbhs</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd class="postavatar"><img src="https://bbs.archlinux.org/img/avatars/70922.jpg?m=1367773811" width="80" height="80" alt="" /></dd> <dd><span>From: Montevideo, Uruguay</span></dd> <dd><span>Registered: 2013-05-02</span></dd> <dd><span>Posts: 402</span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>anickname wrote:</cite><blockquote><div><div class="quotebox"><blockquote><div><p>RIght now im passing through my primary card (radeon 6950) what i did was, use pci-stub to bind it at boot and i disabled the efifb framebuffer with video=efifb:off on my grub cmdline</p></div></blockquote></div><p>Are you booting using UEFI or BIOS mode ?<br />The onboard video is it enabled or disabled ?<br />What about &quot;IGPU Multi Monitor&quot; and &quot;Render standby&quot; options ?</p><p>I tried booting using BIOS, onboard GPU, both enabled and disabled; It didn&#039;t worked for me.<br />I see the seabios screen but after it only random pixels. I think that both Windows and Linux are<br />trying to write to the GPU.</p><p>I used pci-stub and video=vesafb:off in the command line.</p><p>Thanks.</p></div></blockquote></div><p>Im booting in EFI mode, and i dont have an onboard gpu, my primary card is a radeon 6950, and my secondary card is a radeon 5450, im passing though the radeon 6950</p> <p class="postedit"><em>Last edited by nbhs (2014-03-06 20:19:55)</em></p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1389330">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1389377" class="blockpost rowodd"> <h2><span><span class="conr">#1286</span> <a href="viewtopic.php?pid=1389377#p1389377">2014-03-06 23:11:48</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=80028">trimm</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2014-03-06</span></dd> <dd><span>Posts: 31</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=80028">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <p>Hello everyone. First time user here and I am really interested in doing something similar to this. I have read a couple of pages, but its starting to get overwhelming, considering all the new patches, kernels and other fixes. Is it perhaps possible to write an up to date guide, perhaps a bit more in depth on how we can set this up? (What do I need if I boot with UEFI or BIOS, with a NVIDIA or AMD card etc) I am perhaps speaking for myself here, but I know I would appreciate it alot.</p><p>Either way, I will definitely try this out, hopefully I wont pull out all my hairs in the process!</p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1389377">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1389430" class="blockpost roweven"> <h2><span><span class="conr">#1287</span> <a href="viewtopic.php?pid=1389430#p1389430">2014-03-07 02:02:23</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=79991">mv0lnicky</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2014-03-05</span></dd> <dd><span>Posts: 16</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=79991">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <p>Some of the patches depend on your hardware. Also, if you&#039;re using an up to date distribution, you can get some results with just the compiled kernel +&#160; acs override patch,&#160; memleak fix and the patch for your host graphic adapter.</p> <p class="postedit"><em>Last edited by mv0lnicky (2014-03-07 02:12:57)</em></p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1389430">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1389600" class="blockpost rowodd"> <h2><span><span class="conr">#1288</span> <a href="viewtopic.php?pid=1389600#p1389600">2014-03-07 13:10:25</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=75590">aw</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2013-10-04</span></dd> <dd><span>Posts: 921</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=75590">Email</a></span> <span class="website"><a href="http://vfio.blogspot.com/" rel="nofollow">Website</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <p>Paolo has posted new patches to fix performance when debug registers are used in the guest.&#160; Performance should be the same as previous set on Intel, but this series also adds support for AMD.&#160; Patches:</p><p><a href="http://marc.info/?l=linux-kernel&amp;m=139419276204556&amp;q=raw" rel="nofollow">http://marc.info/?l=linux-kernel&amp;m=1394 … 4556&amp;q=raw</a><br /><a href="http://marc.info/?l=linux-kernel&amp;m=139419268004517&amp;q=raw" rel="nofollow">http://marc.info/?l=linux-kernel&amp;m=1394 … 4517&amp;q=raw</a><br /><a href="http://marc.info/?l=linux-kernel&amp;m=139419270004527&amp;q=raw" rel="nofollow">http://marc.info/?l=linux-kernel&amp;m=1394 … 4527&amp;q=raw</a><br /><a href="http://marc.info/?l=linux-kernel&amp;m=139419260404488&amp;q=raw" rel="nofollow">http://marc.info/?l=linux-kernel&amp;m=1394 … 4488&amp;q=raw</a><br /><a href="http://marc.info/?l=linux-kernel&amp;m=139419265404502&amp;q=raw" rel="nofollow">http://marc.info/?l=linux-kernel&amp;m=1394 … 4502&amp;q=raw</a><br /><a href="http://marc.info/?l=linux-kernel&amp;m=139419261204492&amp;q=raw" rel="nofollow">http://marc.info/?l=linux-kernel&amp;m=1394 … 4492&amp;q=raw</a><br /><a href="http://marc.info/?l=linux-kernel&amp;m=139419263204499&amp;q=raw" rel="nofollow">http://marc.info/?l=linux-kernel&amp;m=1394 … 4499&amp;q=raw</a></p> </div> <div class="postsignature postmsg"><hr /><p><a href="http://vfio.blogspot.com" rel="nofollow">http://vfio.blogspot.com</a><br />Looking for a more open forum to discuss vfio related uses?&#160; Try <a href="https://www.redhat.com/mailman/listinfo/vfio-users" rel="nofollow">https://www.redhat.com/mailman/listinfo/vfio-users</a></p></div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1389600">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1389822" class="blockpost roweven"> <h2><span><span class="conr">#1289</span> <a href="viewtopic.php?pid=1389822#p1389822">2014-03-08 02:49:38</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=80028">trimm</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2014-03-06</span></dd> <dd><span>Posts: 31</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=80028">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <p>I have been trying with a clean install of Arch Linux, fully updated(per 08 March 2014) and I think Im getting there, but I havent quite made it yet.<br />i7 processor (Haswell), Kernel 3.13.5-1<br />Host GPU: Intel HD 4600<br />Guest GPU: NVIDIA GTX 670</p><p>Nouveau and nvidia drivers are blacklisted.</p><p>This is the only thing I got in my kernel boot options: intel_iommu=on</p><p>This is my dmesg |grep IOMMU:<br />[&#160; &#160; 0.000000] Intel-IOMMU: enabled<br />[&#160; &#160; 0.036230] dmar: IOMMU 0: reg_base_addr fed90000 ver 1:0 cap c0000020660462 ecap f0101a<br />[&#160; &#160; 0.036235] dmar: IOMMU 1: reg_base_addr fed91000 ver 1:0 cap d2008020660462 ecap f010da<br />[&#160; &#160; 0.036300] IOAPIC id 2 under DRHD base&#160; 0xfed91000 IOMMU 1<br />[&#160; &#160; 0.428676] IOMMU 0 0xfed90000: using Queued invalidation<br />[&#160; &#160; 0.428676] IOMMU 1 0xfed91000: using Queued invalidation<br />[&#160; &#160; 0.428678] IOMMU: Setting RMRR:<br />[&#160; &#160; 0.428686] IOMMU: Setting identity map for device 0000:00:02.0 [0xbf800000 - 0xcf9fffff]<br />[&#160; &#160; 0.429887] IOMMU: Setting identity map for device 0000:00:1d.0 [0xbc0cf000 - 0xbc0dbfff]<br />[&#160; &#160; 0.429907] IOMMU: Setting identity map for device 0000:00:1a.0 [0xbc0cf000 - 0xbc0dbfff]<br />[&#160; &#160; 0.429924] IOMMU: Setting identity map for device 0000:00:14.0 [0xbc0cf000 - 0xbc0dbfff]<br />[&#160; &#160; 0.429936] IOMMU: Prepare 0-16MiB unity mapping for LPC<br />[&#160; &#160; 0.429942] IOMMU: Setting identity map for device 0000:00:1f.0 [0x0 - 0xffffff]</p><p>vfio-bind 0000:01:00.0 0000:01:00.1 gives me this in journalctl: <br />Mar 08 04:26:11 arch kernel: vfio-pci 0000:01:00.0: enabling device (0000 -&gt; 0003)<br />Mar 08 04:26:11 arch kernel: vfio_ecap_init: 0000:01:00.0 hiding ecap 0x19@0x900</p><p>However, when trying to run this command:<br />qemu-system-x86_64 -enable-kvm -M q35 -m 1024 -cpu host \<br />-smp 6,sockets=1,cores=6,threads=1 \<br />-bios /usr/share/qemu/bios.bin -vga none \<br />-device ioh3420,bus=pcie.0,addr=1c.0,multifunction=on,port=1,chassis=1,id=root.1 \<br />-device vfio-pci,host=01:00.0,bus=root.1,addr=00.0,multifunction=on,x-vga=on \<br />-device vfio-pci,host=01:00.1,bus=root.1,addr=00.1</p><p>I get the message: Could not initialize SDL(No available video device) - exiting.<br />Nothing in the journalctl is logged when I try to run qemu-system, besides this message: vfio_ecap_init: 0000:01:00.0 hiding ecap 0x19@0x900</p><p>Any help is greatly appreciated, as this is something I really would like to have.</p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1389822">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1389826" class="blockpost rowodd"> <h2><span><span class="conr">#1290</span> <a href="viewtopic.php?pid=1389826#p1389826">2014-03-08 03:10:47</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=70922">nbhs</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd class="postavatar"><img src="https://bbs.archlinux.org/img/avatars/70922.jpg?m=1367773811" width="80" height="80" alt="" /></dd> <dd><span>From: Montevideo, Uruguay</span></dd> <dd><span>Registered: 2013-05-02</span></dd> <dd><span>Posts: 402</span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>trimm wrote:</cite><blockquote><div><p>I have been trying with a clean install of Arch Linux, fully updated(per 08 March 2014) and I think Im getting there, but I havent quite made it yet.<br />i7 processor (Haswell), Kernel 3.13.5-1<br />Host GPU: Intel HD 4600<br />Guest GPU: NVIDIA GTX 670</p><p>Nouveau and nvidia drivers are blacklisted.</p><p>This is the only thing I got in my kernel boot options: intel_iommu=on</p><p>This is my dmesg |grep IOMMU:<br />[&#160; &#160; 0.000000] Intel-IOMMU: enabled<br />[&#160; &#160; 0.036230] dmar: IOMMU 0: reg_base_addr fed90000 ver 1:0 cap c0000020660462 ecap f0101a<br />[&#160; &#160; 0.036235] dmar: IOMMU 1: reg_base_addr fed91000 ver 1:0 cap d2008020660462 ecap f010da<br />[&#160; &#160; 0.036300] IOAPIC id 2 under DRHD base&#160; 0xfed91000 IOMMU 1<br />[&#160; &#160; 0.428676] IOMMU 0 0xfed90000: using Queued invalidation<br />[&#160; &#160; 0.428676] IOMMU 1 0xfed91000: using Queued invalidation<br />[&#160; &#160; 0.428678] IOMMU: Setting RMRR:<br />[&#160; &#160; 0.428686] IOMMU: Setting identity map for device 0000:00:02.0 [0xbf800000 - 0xcf9fffff]<br />[&#160; &#160; 0.429887] IOMMU: Setting identity map for device 0000:00:1d.0 [0xbc0cf000 - 0xbc0dbfff]<br />[&#160; &#160; 0.429907] IOMMU: Setting identity map for device 0000:00:1a.0 [0xbc0cf000 - 0xbc0dbfff]<br />[&#160; &#160; 0.429924] IOMMU: Setting identity map for device 0000:00:14.0 [0xbc0cf000 - 0xbc0dbfff]<br />[&#160; &#160; 0.429936] IOMMU: Prepare 0-16MiB unity mapping for LPC<br />[&#160; &#160; 0.429942] IOMMU: Setting identity map for device 0000:00:1f.0 [0x0 - 0xffffff]</p><p>vfio-bind 0000:01:00.0 0000:01:00.1 gives me this in journalctl: <br />Mar 08 04:26:11 arch kernel: vfio-pci 0000:01:00.0: enabling device (0000 -&gt; 0003)<br />Mar 08 04:26:11 arch kernel: vfio_ecap_init: 0000:01:00.0 hiding ecap 0x19@0x900</p><p>However, when trying to run this command:<br />qemu-system-x86_64 -enable-kvm -M q35 -m 1024 -cpu host \<br />-smp 6,sockets=1,cores=6,threads=1 \<br />-bios /usr/share/qemu/bios.bin -vga none \<br />-device ioh3420,bus=pcie.0,addr=1c.0,multifunction=on,port=1,chassis=1,id=root.1 \<br />-device vfio-pci,host=01:00.0,bus=root.1,addr=00.0,multifunction=on,x-vga=on \<br />-device vfio-pci,host=01:00.1,bus=root.1,addr=00.1</p><p>I get the message: Could not initialize SDL(No available video device) - exiting.<br />Nothing in the journalctl is logged when I try to run qemu-system, besides this message: vfio_ecap_init: 0000:01:00.0 hiding ecap 0x19@0x900</p><p>Any help is greatly appreciated, as this is something I really would like to have.</p></div></blockquote></div><p>Use the qemu -nographic arg</p> <p class="postedit"><em>Last edited by nbhs (2014-03-08 03:15:33)</em></p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1389826">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1389907" class="blockpost roweven"> <h2><span><span class="conr">#1291</span> <a href="viewtopic.php?pid=1389907#p1389907">2014-03-08 10:20:09</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=80028">trimm</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2014-03-06</span></dd> <dd><span>Posts: 31</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=80028">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <p>Im just going to add the -nographic arg without removing anything from the qemu command?</p><p>This gives me the following in journalctl: </p><p>Mar 08 12:11:33 arch kernel: vfio_ecap_init: 0000:01:00.0 hiding ecap 0x19@0x900<br />Mar 08 12:11:35 arch kernel: [drm:intel_uncore_check_errors] *ERROR* Unclaimed register before interrupt<br />Mar 08 12:11:35 arch kernel: [drm:hsw_unclaimed_reg_check] *ERROR* Unclaimed write to 4400c<br />Mar 08 12:11:35 arch kernel: [drm:intel_uncore_check_errors] *ERROR* Unclaimed register before interrupt<br />Mar 08 12:11:35 arch kernel: [drm:intel_uncore_check_errors] *ERROR* Unclaimed register before interrupt<br />Mar 08 12:11:35 arch kernel: [drm:intel_uncore_check_errors] *ERROR* Unclaimed register before interrupt<br />Mar 08 12:11:37 arch kernel: [drm:intel_uncore_check_errors] *ERROR* Unclaimed register before interrupt</p><p>Looking at the processes with htop I can see two qemu-system processes running at above 90%. But nothing else is happening.</p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1389907">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1389910" class="blockpost rowodd"> <h2><span><span class="conr">#1292</span> <a href="viewtopic.php?pid=1389910#p1389910">2014-03-08 10:26:10</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=70922">nbhs</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd class="postavatar"><img src="https://bbs.archlinux.org/img/avatars/70922.jpg?m=1367773811" width="80" height="80" alt="" /></dd> <dd><span>From: Montevideo, Uruguay</span></dd> <dd><span>Registered: 2013-05-02</span></dd> <dd><span>Posts: 402</span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>trimm wrote:</cite><blockquote><div><p>Im just going to add the -nographic arg without removing anything from the qemu command?</p><p>This gives me the following in journalctl: </p><p>Mar 08 12:11:33 arch kernel: vfio_ecap_init: 0000:01:00.0 hiding ecap 0x19@0x900<br />Mar 08 12:11:35 arch kernel: [drm:intel_uncore_check_errors] *ERROR* Unclaimed register before interrupt<br />Mar 08 12:11:35 arch kernel: [drm:hsw_unclaimed_reg_check] *ERROR* Unclaimed write to 4400c<br />Mar 08 12:11:35 arch kernel: [drm:intel_uncore_check_errors] *ERROR* Unclaimed register before interrupt<br />Mar 08 12:11:35 arch kernel: [drm:intel_uncore_check_errors] *ERROR* Unclaimed register before interrupt<br />Mar 08 12:11:35 arch kernel: [drm:intel_uncore_check_errors] *ERROR* Unclaimed register before interrupt<br />Mar 08 12:11:37 arch kernel: [drm:intel_uncore_check_errors] *ERROR* Unclaimed register before interrupt</p><p>Looking at the processes with htop I can see two qemu-system processes running at above 90%. But nothing else is happening.</p></div></blockquote></div><p>Are you using the kernel i provided?</p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1389910">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1389916" class="blockpost roweven"> <h2><span><span class="conr">#1293</span> <a href="viewtopic.php?pid=1389916#p1389916">2014-03-08 11:30:27</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=80028">trimm</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2014-03-06</span></dd> <dd><span>Posts: 31</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=80028">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <p>Of course, I forgot that. I have compiled it now, installed it and rebooted. <br />Journalctl gives me:</p><p>Mar 08 13:27:09 arch kernel: [drm:intel_uncore_check_errors] *ERROR* Unclaimed register before interrupt<br />Mar 08 13:27:09 arch kernel: [drm:intel_uncore_check_errors] *ERROR* Unclaimed register before interrupt<br />Mar 08 13:27:09 arch kernel: [drm:hsw_unclaimed_reg_clear] *ERROR* Unknown unclaimed register before writing to 44040<br />Mar 08 13:27:09 arch kernel: [drm:intel_uncore_check_errors] *ERROR* Unclaimed register before interrupt<br />Mar 08 13:27:11 arch kernel: [drm:intel_uncore_check_errors] *ERROR* Unclaimed register before interrupt</p><p>Tested with both -nographic and without - nothing happens.</p><p>(Will these patches be implemented upstream in the future, so we dont have to compile our own kernel all the time?)</p><p>As before, Im grateful for your help.</p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1389916">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1389928" class="blockpost rowodd"> <h2><span><span class="conr">#1294</span> <a href="viewtopic.php?pid=1389928#p1389928">2014-03-08 12:40:37</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=75590">aw</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2013-10-04</span></dd> <dd><span>Posts: 921</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=75590">Email</a></span> <span class="website"><a href="http://vfio.blogspot.com/" rel="nofollow">Website</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>trimm wrote:</cite><blockquote><div><p>Of course, I forgot that. I have compiled it now, installed it and rebooted. <br />Journalctl gives me:</p><p>Mar 08 13:27:09 arch kernel: [drm:intel_uncore_check_errors] *ERROR* Unclaimed register before interrupt<br />Mar 08 13:27:09 arch kernel: [drm:intel_uncore_check_errors] *ERROR* Unclaimed register before interrupt<br />Mar 08 13:27:09 arch kernel: [drm:hsw_unclaimed_reg_clear] *ERROR* Unknown unclaimed register before writing to 44040<br />Mar 08 13:27:09 arch kernel: [drm:intel_uncore_check_errors] *ERROR* Unclaimed register before interrupt<br />Mar 08 13:27:11 arch kernel: [drm:intel_uncore_check_errors] *ERROR* Unclaimed register before interrupt</p><p>Tested with both -nographic and without - nothing happens.</p><p>(Will these patches be implemented upstream in the future, so we dont have to compile our own kernel all the time?)</p><p>As before, Im grateful for your help.</p></div></blockquote></div><p>Missing i915 patches</p> </div> <div class="postsignature postmsg"><hr /><p><a href="http://vfio.blogspot.com" rel="nofollow">http://vfio.blogspot.com</a><br />Looking for a more open forum to discuss vfio related uses?&#160; Try <a href="https://www.redhat.com/mailman/listinfo/vfio-users" rel="nofollow">https://www.redhat.com/mailman/listinfo/vfio-users</a></p></div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1389928">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1389931" class="blockpost roweven"> <h2><span><span class="conr">#1295</span> <a href="viewtopic.php?pid=1389931#p1389931">2014-03-08 12:50:30</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=80028">trimm</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2014-03-06</span></dd> <dd><span>Posts: 31</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=80028">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <p>I downloaded this: linux-mainline.tar.gz (3.13.5 includes acs override patch, i935 vga arbiter fixes, memleak fix by xani)<br />tar xfvz<br />makepkg -s<br />pacman -U<br />reboot</p><p>Is there something extra I should have done? By i915 patch you mean the i935 vga arbiter fix?</p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1389931">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1389955" class="blockpost rowodd"> <h2><span><span class="conr">#1296</span> <a href="viewtopic.php?pid=1389955#p1389955">2014-03-08 13:54:52</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=70922">nbhs</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd class="postavatar"><img src="https://bbs.archlinux.org/img/avatars/70922.jpg?m=1367773811" width="80" height="80" alt="" /></dd> <dd><span>From: Montevideo, Uruguay</span></dd> <dd><span>Registered: 2013-05-02</span></dd> <dd><span>Posts: 402</span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>trimm wrote:</cite><blockquote><div><p>I downloaded this: linux-mainline.tar.gz (3.13.5 includes acs override patch, i935 vga arbiter fixes, memleak fix by xani)<br />tar xfvz<br />makepkg -s<br />pacman -U<br />reboot</p><p>Is there something extra I should have done? By i915 patch you mean the i935 vga arbiter fix?</p></div></blockquote></div><p>That patch is included in my kernel package, make sure you have installed it and you are running it</p><p>uname -r</p><div class="codebox"><pre><code>3.13.5-1-mainline</code></pre></div> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1389955">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1389964" class="blockpost roweven"> <h2><span><span class="conr">#1297</span> <a href="viewtopic.php?pid=1389964#p1389964">2014-03-08 14:28:53</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=80028">trimm</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2014-03-06</span></dd> <dd><span>Posts: 31</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=80028">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <p>uname -r<br />3.13.5-1-ARCH</p><p>What am I doing wrong? (sudo pacman -U linux-mainline-3.13.5-1-x86_64.pkg.tar.xz)</p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1389964">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1389970" class="blockpost rowodd"> <h2><span><span class="conr">#1298</span> <a href="viewtopic.php?pid=1389970#p1389970">2014-03-08 14:39:09</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=70922">nbhs</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd class="postavatar"><img src="https://bbs.archlinux.org/img/avatars/70922.jpg?m=1367773811" width="80" height="80" alt="" /></dd> <dd><span>From: Montevideo, Uruguay</span></dd> <dd><span>Registered: 2013-05-02</span></dd> <dd><span>Posts: 402</span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>trimm wrote:</cite><blockquote><div><p>uname -r<br />3.13.5-1-ARCH</p><p>What am I doing wrong? (sudo pacman -U linux-mainline-3.13.5-1-x86_64.pkg.tar.xz)</p></div></blockquote></div><div class="codebox"><pre><code>sudo pacman -U linux-mainline-* sudo grub-mkconfig -o /boot/grub/grub.cfg</code></pre></div><p>You should see a linux mainline boot option on the grub menu now</p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1389970">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1389980" class="blockpost roweven"> <h2><span><span class="conr">#1299</span> <a href="viewtopic.php?pid=1389980#p1389980">2014-03-08 15:03:36</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=80028">trimm</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2014-03-06</span></dd> <dd><span>Posts: 31</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=80028">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <p>Oh stupid, stupid me! I forgot to put the new kernel in my Gummiboot.<br />Loading into X-session takes a while now, before it was rather instant. But lo and behold my GTX 670 has been passthroughed to my Windows 8.1WM! <br />Thank you so much, I am now one (major) step closer to getting this just how I want it to be <img src="https://bbs.archlinux.org/img/smilies/smile.png" width="15" height="15" alt="smile" /></p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1389980">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1390035" class="blockpost rowodd"> <h2><span><span class="conr">#1300</span> <a href="viewtopic.php?pid=1390035#p1390035">2014-03-08 17:33:43</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=80080">zoop2</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2014-03-08</span></dd> <dd><span>Posts: 2</span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <p>Hello all,&#160; first thanks for all the work people are putting into this.&#160; It has been a fun project.</p><p>I wanted to share my experience, so that it might help others as well.</p><p>My system is a Mac Pro (early 2008)&#160; has 8 cores from Xeon E5462&#039;s</p><p>The Hosts Video card:<br />02:00.0 VGA compatible controller: NVIDIA Corporation G92 [GeForce 8800 GT] (rev a2)<br />Passthrough Video card:<br />01:00.0 VGA compatible controller: Advanced Micro Devices, Inc. [AMD/ATI] Turks XT [Radeon HD 6670/7670]</p><p>I am using Gentoo with Gentoo&#039;s moded kernel 3.12.13&#160; I was using QEMU 1.6 from portage,&#160; Now I have changed to the GIT for some new features.&#160; And I have Seabios 1.7.3 also from Portage</p><p>So I first had this VM using libvirt.&#160; I tried playing with it to get it to pass the card to windows without success.&#160; I may try to play wi<br />th it again at a later date.&#160; But I think getting it going without it is a little easier.&#160; I had a lot of problems getting Windows to Boot<br />when passing the Vfio stuff.&#160; I tried the various things with -M and other config settings.&#160; I ran into various issues.&#160; Like tracebacks fr<br />om the host&#160; QEMU crashing on start.&#160; and windows crashing on start with just a blank blue screen etc.&#160; I ended up getting around this by b<br />ooting the system with the original config again and converting everything to only use virtio drivers.&#160; &#160;From what I saw debuging all of th<br />e different ide/sata controllers I tried to setup was causing these problems.&#160; I am sure I could have been making mistakes, but this is wha<br />t I did.</p><p>After converting to that I had a bit of problems with the Ati driver in windows crashing it, but I think that adding these kernel options to the host stopped that from happening. intel_iommu=on,igfx_off,pass-through</p><p>I am still having a problem with audio going through the Hosts audio device.&#160; This seems to be a known issue of using ALSA with windows gue<br />sts.&#160; I dislike pulseaudio so I won&#039;t install it.</p><p>Here is the line I am using to start the system for now.</p><div class="codebox"><pre><code>/home/zoop/tmp/qemu-git/qemu/x86_64-softmmu/qemu-system-x86_64 -enable-kvm -M q35 -cpu qemu64,hv-time,hv-relaxed,hv-vapic,hv-spinlocks=0x1000 -mem-path /dev/hugepages -device virtio-balloon -m 6144 -smp 4,sockets=1,cores=4,threads=1 -bios /usr/share/seabios/bios.bin -device ioh3420,bus=pcie.0,addr=1c.0,multifunction=on,port=1,chassis=1,id=root.1 -device vfio-pci,host=01:00.0,bus=root.1,addr=00.0,multifunction=on,x-vga=on -device vfio-pci,host=01:00.1,bus=root.1,addr=00.1 -boot menu=on -vga none -drive if=virtio,file=/mnt/backup/vm/win8-Mar2014snap.qcow2,id=disk,format=qcow2 -usb -usbdevice host:047d:1048 -device ich9-intel-hda,bus=pcie.0,addr=1b.0,id=sound0 -device hda-duplex,id=sound0-codec0,bus=sound0.0,cad=0 -net nic,model=virtio -net tap,ifname=tap0,script=no,downscript=no</code></pre></div><p>From here i am looking to implement the Debug registers patch that was mentioned by @aw a while back to improve performance.&#160; I am wondering what kernel that Patch was for, I am assuming it was for 3.13.x. </p><p>To help imporove performance a littl more i also plan on assigning the system to use specific CPUs.</p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1390035">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div class="postlinksb"> <div class="inbox crumbsplus"> <div class="pagepost"> <p class="pagelink conl"><span class="pages-label">Pages: </span><a rel="prev" class="item1" href="viewtopic.php?id=162768&amp;p=51">Previous</a> <a href="viewtopic.php?id=162768">1</a> <span class="spacer">…</span> <a href="viewtopic.php?id=162768&amp;p=50">50</a> <a href="viewtopic.php?id=162768&amp;p=51">51</a> <strong>52</strong> <a href="viewtopic.php?id=162768&amp;p=53">53</a> <a href="viewtopic.php?id=162768&amp;p=54">54</a> <span class="spacer">…</span> <a href="viewtopic.php?id=162768&amp;p=234">234</a> <a rel="next" href="viewtopic.php?id=162768&amp;p=53">Next</a></p> <p class="postlink conr">Topic closed</p> </div> <ul class="crumbs"> <li><a href="index.php">Index</a></li> <li><span>»&#160;</span><a href="viewforum.php?id=48">Topics Going Nowhere</a></li> <li><span>»&#160;</span><strong><a href="viewtopic.php?id=162768">KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</a></strong></li> </ul> <p class="subscribelink clearb"><a href="misc.php?action=subscribe&amp;tid=162768">Subscribe to this topic</a></p> <div class="clearer"></div> </div> </div> </div> <div id="brdfooter" class="block"> <h2><span>Board footer</span></h2> <div class="box"> <div id="brdfooternav" class="inbox"> <div class="conl"> <form id="qjump" method="get" action="viewforum.php"> <div><label><span>Jump to<br /></span> <select name="id" onchange="window.location=('viewforum.php?id='+this.options[this.selectedIndex].value)"> <optgroup label="Technical Issues and Assistance"> <option value="23">Newbie Corner</option> <option value="17">Installation</option> <option value="22">Kernel &amp; Hardware</option> <option value="18">Applications &amp; Desktop Environments</option> <option value="31">Laptop Issues</option> <option value="8">Networking, Server, and Protection</option> <option value="32">Multimedia and Games</option> <option value="50">System Administration</option> <option value="35">Other Architectures</option> </optgroup> <optgroup label="Arch-centric"> <option value="24">Announcements, Package &amp; Security Advisories</option> <option value="1">Arch Discussion</option> <option value="13">Forum &amp; Wiki discussion</option> </optgroup> <optgroup label="Pacman Upgrades, Packaging &amp; AUR"> <option value="44">Pacman &amp; Package Upgrade Issues</option> <option value="49">[testing] Repo Forum</option> <option value="4">Creating &amp; Modifying Packages</option> <option value="38">AUR Issues, Discussion &amp; PKGBUILD Requests</option> </optgroup> <optgroup label="Contributions &amp; Discussion"> <option value="20">GNU/Linux Discussion</option> <option value="27">Community Contributions</option> <option value="33">Programming &amp; Scripting</option> <option value="30">Other Languages</option> <option value="47">Artwork and Screenshots</option> <option value="42">Try This</option> </optgroup> <optgroup label="/dev/null"> <option value="29">Off-Topic</option> <option value="48" selected="selected">Topics Going Nowhere</option> <option value="36">Dustbin</option> </optgroup> </select></label> <input type="submit" value=" Go " accesskey="g" /> </div> </form> </div> <div class="conr"> <p id="feedlinks"><span class="atom"><a href="extern.php?action=feed&amp;tid=162768&amp;type=atom">Atom topic feed</a></span></p> <p id="poweredby">Powered by <a href="http://fluxbb.org/">FluxBB</a></p> </div> <div class="clearer"></div> </div> </div> </div> </div> <div class="end-box"></div> </div> </body> </html>
