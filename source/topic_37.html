<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"> <html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en" dir="ltr"> <head> <meta http-equiv="Content-Type" content="text/html; charset=utf-8" /> <title>KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9 (Page 37) / Topics Going Nowhere / Arch Linux Forums</title> <link rel="stylesheet" type="text/css" href="style/ArchLinux.css" /> <link rel="canonical" href="viewtopic.php?id=162768&amp;p=37" title="Page 37" /> <link rel="prev" href="viewtopic.php?id=162768&amp;p=36" title="Page 36" /> <link rel="next" href="viewtopic.php?id=162768&amp;p=38" title="Page 38" /> <link rel="alternate" type="application/atom+xml" href="extern.php?action=feed&amp;tid=162768&amp;type=atom" title="Atom topic feed" /> <link rel="stylesheet" media="screen" href="style/ArchLinux/arch.css?v=3" /> <link rel="stylesheet" media="screen" href="style/ArchLinux/archnavbar.css?v=2" /> <link rel="shortcut icon" href="style/ArchLinux/favicon.ico" /> </head> <body> <div id="archnavbar" class="anb-forum"> <div id="archnavbarlogo"><h1><a href="http://www.archlinux.org/">Arch Linux</a></h1></div> <div id="archnavbarmenu"> <ul id="archnavbarlist"> <li id="anb-home"><a href="http://www.archlinux.org/">Home</a></li><li id="anb-packages"><a href="http://www.archlinux.org/packages/">Packages</a></li><li id="anb-forums" class="anb-selected"><a href="https://bbs.archlinux.org/">Forums</a></li><li id="anb-wiki"><a href="https://wiki.archlinux.org/">Wiki</a></li><li id="anb-bugs"><a href="https://bugs.archlinux.org/">Bugs</a></li><li id="anb-aur"><a href="https://aur.archlinux.org/">AUR</a></li><li id="anb-download"><a href="http://www.archlinux.org/download/">Download</a></li> </ul> </div> </div> <div id="punviewtopic" class="pun"> <div class="top-box"></div> <div class="punwrap"> <div id="brdheader" class="block"> <div class="box"> <div id="brdmenu" class="inbox"> <ul> <li id="navindex" class="isactive"><a href="index.php">Index</a></li> <li id="navuserlist"><a href="userlist.php">User list</a></li> <li id="navsearch"><a href="search.php">Search</a></li> <li id="navprofile"><a href="profile.php?id=80749">Profile</a></li> <li id="navlogout"><a href="login.php?action=out&amp;id=80749&amp;csrf_token=5c20501ec397bb45ef8ee8c84db232c8d8e421c6">Logout</a></li> </ul> </div> <div id="brdwelcome" class="inbox"> <ul class="conl"> <li><span>Logged in as <strong>SXX</strong></span></li> <li><span>Last visit: 2015-08-16 12:20:09</span></li> </ul> <ul class="conr"> <li><span>Topics: <a href="search.php?action=show_replies" title="Find topics you have posted to.">Posted</a> | <a href="search.php?action=show_new" title="Find topics with new posts since your last visit.">New</a> | <a href="search.php?action=show_recent" title="Find topics with recent posts.">Active</a> | <a href="search.php?action=show_unanswered" title="Find topics with no replies.">Unanswered</a></span></li> </ul> <div class="clearer"></div> </div> </div> </div> <div id="brdmain"> <div class="linkst"> <div class="inbox crumbsplus"> <ul class="crumbs"> <li><a href="index.php">Index</a></li> <li><span>»&#160;</span><a href="viewforum.php?id=48">Topics Going Nowhere</a></li> <li><span>»&#160;</span><strong><a href="viewtopic.php?id=162768">KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</a></strong></li> </ul> <div class="pagepost"> <p class="pagelink conl"><span class="pages-label">Pages: </span><a rel="prev" class="item1" href="viewtopic.php?id=162768&amp;p=36">Previous</a> <a href="viewtopic.php?id=162768">1</a> <span class="spacer">…</span> <a href="viewtopic.php?id=162768&amp;p=35">35</a> <a href="viewtopic.php?id=162768&amp;p=36">36</a> <strong>37</strong> <a href="viewtopic.php?id=162768&amp;p=38">38</a> <a href="viewtopic.php?id=162768&amp;p=39">39</a> <span class="spacer">…</span> <a href="viewtopic.php?id=162768&amp;p=234">234</a> <a rel="next" href="viewtopic.php?id=162768&amp;p=38">Next</a></p> <p class="postlink conr">Topic closed</p> </div> <div class="clearer"></div> </div> </div> <div id="p1361385" class="blockpost rowodd blockpost1"> <h2><span><span class="conr">#901</span> <a href="viewtopic.php?pid=1361385#p1361385">2013-12-17 23:51:26</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=77626">Owen77</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2013-12-12</span></dd> <dd><span>Posts: 7</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=77626">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>aw wrote:</cite><blockquote><div><p>Congratulation, it works.&#160; When the Nvidia driver is used, the emulated VGA is only used for text mode and the GPU is used for graphical mode.&#160; They&#039;re mutually exclusive, so it&#039;s expected that the emulated VGA &quot;freezes&quot; when X starts.&#160; In your first case, apps can&#039;t find any display device, probably because the graphical desktop is sitting at a login prompt.&#160; In the second case, you&#039;ve started an X session, therefore there is a display to connect to.&#160; This is the way that GRID cards work and Quadro as well if you ignore that it has a physical display connector.&#160; You need to setup remote access to the desktop first.&#160; You can run a vnc server in the guest or use some other remote&#039;ing solution.&#160; If you were expecting X on the emulated VGA with rendering in the GPU, that doesn&#039;t happen.</p></div></blockquote></div><p>Great! Thanks, I don&#039;t know why I was expecting the qemu vnc server to switch over, but it makes sense that it&#039;s fixed to the emulated vga framebuffer. Looking into vnc installation in the guest now.</p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1361385">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1361453" class="blockpost roweven"> <h2><span><span class="conr">#902</span> <a href="viewtopic.php?pid=1361453#p1361453">2013-12-18 05:51:28</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=77789">syllopsium</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2013-12-18</span></dd> <dd><span>Posts: 4</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=77789">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>firewing1 wrote:</cite><blockquote><div><p>VGA passthrough is working well for me with a Radeon R9 270X (i.e. a rebranded 7870 GHz Edition), however after installing the latest Catalyst driver version 13.11 beta 9.5 on Windows 7 SP1 I am having trouble booting Windows.</p><p>I see &#039;Starting Windows...&#039; with the windows splash screen animation but then the screen goes black and after a bit the monitor loses signal. In Safe mode, the event log shows error 0x00000116 - MSDN says this: &quot;The VIDEO_TDR_ ERROR bug check has a value of 0x00000116. This indicates that an attempt to reset the display driver and recover from a timeout failed.&quot;</p><p>I have tried so moving the HDMI audio device (ID 0000:01:00.1) to pcie.0 instead of root.1 as well as eliminating passthrough of the HDMI audio device entirely, neither of which helped. I also tried manually specifying the ROM (rombar=0 romfile=...) from a ROM bin I dumped using GPU-Z. I dumped it from within the VM, which I read may not work but it didn&#039;t throw any errors and GPU-Z properly detected the card so I think it dumped the VBIOS correctly. Has anyone encountered something similar, or has any ideas on what I could do?<br /> [..] snip<br />VFIO passthrough was normally prior to installing the Catalyst drivers, so my guess is that pass-through is working correctly and the bug is in the machine config or the Windows driver.</p></div></blockquote></div><p>I have a very similar problem here, but suspect the issue is Windows and Qemu/KVM&#039;s virtualised hardware presented, not the passthrough capability.</p><p>Alex, is there any way to debug this, or are we at the mercy of AMD/Microsoft/firing up a Windows kernel debugger? I&#039;ve fiddled around with this a lot and got nowhere. There&#039;s nothing in dmesg.</p><p>I&#039;m able to successfully pass a 6950 through to a Ubuntu VM using both the radeon and fglrx drivers on an S3210SHLC board (basically a server version of the X38 chipset, using a Core2Quad). That&#039;s using the southbridge x4 PCIe 1.x slot (the only one that can run graphics at a sensible rate, due to the enforced chipset limitation of x1 for graphics cards in other slots).</p><p>For Windows it always provides a driver timeout under both Windows 7 and 8 x64, whether catalyst&#039;s control panel is installed or not (before Catalyst, it works fine unaccelerated). In some cases it seems enabling vmx in the virtual CPU causes problems, but this appears to be less of an issue of late. Using 3.12.0 rc4 and qemu 1.7.5.0</p><p>I do have to specify the GPU BIOS when booting the VM - it doesn&#039;t work otherwise.</p><p>I&#039;m also much less importantly having issues with passing through the built in Matrox G200e on the board - that&#039;s a case where it works in Xen and VMWare, but not in KVM.</p><p>Startup, if you&#039;re bothered :</p><p>qemu-system-x86_64 -enable-kvm -M q35 -m 3184 -cpu qemu64,+ssse3,+cx16,+xtpr,+acpi,+ss,+ht,+tm,+pbe,+dtes64,+monitor,+ds_cpl,+est,+tm2,+pdcm,+lahf_lm, -smp 2,sockets=1,cores=2,threads=1 -bios /usr/share/qemu/bios.bin -vga none&#160; -device ioh3420,bus=pcie.0,addr=1c.0,multifunction=on,port=1,chassis=1,id=root.1&#160; -device vfio-pci,host=03:00.0,bus=root.1,addr=00.0,multifunction=on,rombar=0,romfile=/home/peter/6950bios.rom,x-vga=on -device vfio-pci,host=03:00.1,bus=root.1,addr=00.1&#160; &#160;-device ahci,bus=pcie.0,id=ahci&#160; -drive file=/home/peter/debian.img,if=virtio&#160; -drive file=/home/peter/Downloads/ubuntu-13.04-desktop-amd64.iso,id=isocd -device ide-cd,bus=ahci.1,drive=isocd&#160; -drive file=/home/peter/Downloads/virtio-win-0.1-65.iso,id=driviso -device ide-cd,bus=ahci.2,drive=driviso -usb&#160; &#160;-boot order=cd -usb -usbdevice host:03f0:0024 -usbdevice host:046d:c051</p><p>dmesg | grep KVM</p><p>[18766.868390] kvm [3596]: vcpu0 disabled perfctr wrmsr: 0xc1 data 0xffff<br />[18767.310411] kvm: zapping shadow pages for mmio generation wraparound</p><p>dmesg | grep VFIO</p><p>[&#160; &#160; 0.000000] Kernel command line: BOOT_IMAGE=/vmlinuz-3.12.0-rc4 root=/dev/mapper/vmtest--vg-root ro quiet modprobe.blacklist=radeon pci-stub.ids=1002:6719,1002:aa80 intel_iommu=on kvm-intel.emulate_invalid_guest_state=1 vfio_iommu_type1.allow_unsafe_interrupts=1 pcie_acs_override=downstream console=tty0 console=ttyS0,115200n8<br />[&#160; &#160; 2.959621] VFIO - User Level meta-driver version: 0.3<br />[18723.504293] vfio-pci 0000:03:00.0: enabling device (0140 -&gt; 0143)<br />[18771.524071] vfio-pci 0000:03:00.0: irq 48 for MSI/MSI-X<br />[18776.940059] vfio-pci 0000:03:00.1: irq 49 for MSI/MSI-X</p><p>dmesg | grep iommu</p><p>[&#160; &#160; 0.000000] Warning: PCIe ACS overrides enabled; This may allow non-IOMMU protected peer-to-peer DMA<br />[&#160; &#160; 0.000000] Kernel command line: BOOT_IMAGE=/vmlinuz-3.12.0-rc4 root=/dev/mapper/vmtest--vg-root ro quiet modprobe.blacklist=radeon pci-stub.ids=1002:6719,1002:aa80 intel_iommu=on kvm-intel.emulate_invalid_guest_state=1 vfio_iommu_type1.allow_unsafe_interrupts=1 pcie_acs_override=downstream console=tty0 console=ttyS0,115200n8<br />[&#160; &#160; 0.000000] Intel-IOMMU: enabled<br />[&#160; &#160; 0.020122] dmar: IOMMU 0: reg_base_addr feb03000 ver 1:0 cap c9008020230272 ecap 1000<br />[&#160; &#160; 2.886000] IOMMU 0 0xfeb03000: using Register based invalidation<br />[&#160; &#160; 2.886004] IOMMU: Setting RMRR:<br />[&#160; &#160; 2.886022] IOMMU: Setting identity map for device 0000:00:1a.7 [0x9fcfc000 - 0x9fcfefff]<br />[&#160; &#160; 2.886046] IOMMU: Setting identity map for device 0000:00:1d.7 [0x9fcff000 - 0x9fd01fff]<br />[&#160; &#160; 2.886066] IOMMU: Setting identity map for device 0000:00:1d.0 [0x9fd32000 - 0x9fd34fff]<br />[&#160; &#160; 2.886084] IOMMU: Setting identity map for device 0000:00:1d.1 [0x9fd32000 - 0x9fd34fff]<br />[&#160; &#160; 2.886103] IOMMU: Setting identity map for device 0000:00:1d.2 [0x9fd32000 - 0x9fd34fff]<br />[&#160; &#160; 2.886121] IOMMU: Setting identity map for device 0000:00:1a.0 [0x9fd32000 - 0x9fd34fff]<br />[&#160; &#160; 2.886140] IOMMU: Setting identity map for device 0000:00:1a.1 [0x9fd32000 - 0x9fd34fff]<br />[&#160; &#160; 2.886150] IOMMU: Setting identity map for device 0000:00:1d.7 [0x9fd32000 - 0x9fd34fff]<br />[&#160; &#160; 2.886153] IOMMU: Setting identity map for device 0000:00:1a.7 [0x9fd32000 - 0x9fd34fff]<br />[&#160; &#160; 2.886156] IOMMU: Setting identity map for device 0000:00:1a.0 [0x9fd02000 - 0x9fd07fff]<br />[&#160; &#160; 2.886159] IOMMU: Setting identity map for device 0000:00:1a.1 [0x9fd02000 - 0x9fd07fff]<br />[&#160; &#160; 2.886162] IOMMU: Setting identity map for device 0000:00:1d.0 [0x9fd08000 - 0x9fd10fff]<br />[&#160; &#160; 2.886165] IOMMU: Setting identity map for device 0000:00:1d.1 [0x9fd08000 - 0x9fd10fff]<br />[&#160; &#160; 2.886168] IOMMU: Setting identity map for device 0000:00:1d.2 [0x9fd08000 - 0x9fd10fff]<br />[&#160; &#160; 2.886172] IOMMU: Prepare 0-16MiB unity mapping for LPC<br />[&#160; &#160; 2.886182] IOMMU: Setting identity map for device 0000:00:1f.0 [0x0 - 0xffffff]</p><p>Yes, it is using Debian in this case. I started with Arch and it does exactly the same thing (Ubuntu ok, Windows not).</p><p>Any help appreciated!</p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1361453">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1361835" class="blockpost rowodd"> <h2><span><span class="conr">#903</span> <a href="viewtopic.php?pid=1361835#p1361835">2013-12-19 10:02:51</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=77819">tuoni</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2013-12-19</span></dd> <dd><span>Posts: 7</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=77819">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <p>Hi guys, I just registered to thank you all for your work - because of this thread, I have finally got KVM/QEMU VGA passthrough working on my GT660Ti.</p><p>My setup is i7-4770 / ASRock Z87 Extreme 4 / Nvidia GT660Ti, host OS is Debian x64, guest OS is Windows 7 x64, keyboard/mouse sharing with Synergy.</p><p>I had bought the processor/mobo combo specifically to try and do VGA passthrough and had been really struggling first with Xen and latterly with KVM until I found this thread - the information in the OP and the patches it links to have been invaluable.</p><p>Thanks once again, all.</p><p><span class="postimg"><img src="http://tuoni.co.uk/IOMMU/IMG_20131218_221423.jpg" alt="IMG_20131218_221423.jpg" /></span></p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1361835">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1362187" class="blockpost roweven"> <h2><span><span class="conr">#904</span> <a href="viewtopic.php?pid=1362187#p1362187">2013-12-20 04:28:50</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=61335">Jesse2004</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2012-06-25</span></dd> <dd><span>Posts: 9</span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <p>Wow, really a GREAT thread!!!</p><p>It seems that the current generation (haswell) of Intel mobile processors supports vt-d in both cpu (i.e. i7-4700HQ) and chipset (i.e. HM87). Has anyone tried vga-passthrough on a laptop? Looking forward to seeing any successful story.</p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1362187">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1362536" class="blockpost rowodd"> <h2><span><span class="conr">#905</span> <a href="viewtopic.php?pid=1362536#p1362536">2013-12-21 05:24:58</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=77762">firewing1</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2013-12-17</span></dd> <dd><span>Posts: 9</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=77762">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <p>Regarding my initial troubles with Code 10 and BSOD 0x116: I posted <a href="https://lists.fedoraproject.org/pipermail/virt/2013-December/003911.html" rel="nofollow">here</a> to Fedora&#039;s virt mailing list and Alex Williamson suggested I try with Kernel 3.13 release candidates as well as the Haswell i915 VGA arbritration patches. After compiling qemu.git and kernel 3.13 from Fedora rawhide with the VGA arbitration patches, I&#039;m happy my setup is now working flawlessly and I don&#039;t get the BSOD anymore. I didn&#039;t even have to reinstall Windows!</p> <p class="postedit"><em>Last edited by firewing1 (2013-12-21 08:52:50)</em></p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1362536">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1362902" class="blockpost roweven"> <h2><span><span class="conr">#906</span> <a href="viewtopic.php?pid=1362902#p1362902">2013-12-22 13:16:42</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=48315">TripleSpeeder</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2011-05-02</span></dd> <dd><span>Posts: 43</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=48315">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>firewing1 wrote:</cite><blockquote><div><p>Regarding my initial troubles with Code 10 and BSOD 0x116: I posted <a href="https://lists.fedoraproject.org/pipermail/virt/2013-December/003911.html" rel="nofollow">here</a> to Fedora&#039;s virt mailing list and Alex Williamson suggested I try with Kernel 3.13 release candidates as well as the Haswell i915 VGA arbritration patches. After compiling qemu.git and kernel 3.13 from Fedora rawhide with the VGA arbitration patches, I&#039;m happy my setup is now working flawlessly and I don&#039;t get the BSOD anymore. I didn&#039;t even have to reinstall Windows!</p></div></blockquote></div><p>This is good news, as I am seeing exactly the same problem on my system now. Could you provide sources to the patches you applied so I can also give it a try? Thanks!</p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1362902">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1362907" class="blockpost rowodd"> <h2><span><span class="conr">#907</span> <a href="viewtopic.php?pid=1362907#p1362907">2013-12-22 14:16:27</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=76834">Val532</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2013-11-13</span></dd> <dd><span>Posts: 35</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=76834">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>firewing1 wrote:</cite><blockquote><div><p>Regarding my initial troubles with Code 10 and BSOD 0x116: I posted <a href="https://lists.fedoraproject.org/pipermail/virt/2013-December/003911.html" rel="nofollow">here</a> to Fedora&#039;s virt mailing list and Alex Williamson suggested I try with Kernel 3.13 release candidates as well as the Haswell i915 VGA arbritration patches. After compiling qemu.git and kernel 3.13 from Fedora rawhide with the VGA arbitration patches, I&#039;m happy my setup is now working flawlessly and I don&#039;t get the BSOD anymore. I didn&#039;t even have to reinstall Windows!</p></div></blockquote></div><p>Hello,</p><p>Can you provide your patch please.</p><p>Thanks.</p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1362907">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1363077" class="blockpost roweven"> <h2><span><span class="conr">#908</span> <a href="viewtopic.php?pid=1363077#p1363077">2013-12-23 00:09:13</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=77929">revasm</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2013-12-22</span></dd> <dd><span>Posts: 2</span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <p><a href="https://gist.github.com/anonymous/732acf9551136a78e91b" rel="nofollow">i915_313rc4.patch</a></p><p>Applies cleanly, but 100% untested. YMMV.</p><p>The patch was generated by reverting to Linus&#039;s commit:<br />&#160; &#160;cd4edf7 Merge branch &#039;drm-fixes&#039; of git://people.freedesktop.org/~airlied/linux</p><p>Followed by undoing the below changes and merging onto rc4.<br />&#160; &#160;e1264eb Revert &quot;drm/i915: Delay disabling of VGA memory until vgacon-&gt;fbcon handoff is done&quot;<br />&#160; &#160;ebff5fa9 Revert &quot;i915: Update VGA arbiter support for newer devices&quot;</p><p>Alex wrote that these changes are necessary, but they seem intact.<br />&#160; &#160;5c0f6ee vgaarb: Fix VGA decodes changes<br />&#160; &#160;f22d776 vgaarb: Don&#039;t disable resources that are not owned</p><p>Further reading:</p><ol class="decimal"><li><p><a href="https://lkml.org/lkml/2013/8/15/458" rel="nofollow">https://lkml.org/lkml/2013/8/15/458</a></p></li><li><p><a href="https://lkml.org/lkml/2013/8/28/362" rel="nofollow">https://lkml.org/lkml/2013/8/28/362</a></p></li><li><p><a href="http://cgit.freedesktop.org/~danvet/drm-intel/commit/?id=6e1b4fdad5157bb9e88777d525704aba24389bee" rel="nofollow">http://cgit.freedesktop.org/~danvet/drm … ba24389bee</a></p></li></ol> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1363077">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1363147" class="blockpost rowodd"> <h2><span><span class="conr">#909</span> <a href="viewtopic.php?pid=1363147#p1363147">2013-12-23 05:44:23</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=77762">firewing1</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2013-12-17</span></dd> <dd><span>Posts: 9</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=77762">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>TripleSpeeder wrote:</cite><blockquote><div><p>This is good news, as I am seeing exactly the same problem on my system now. Could you provide sources to the patches you applied so I can also give it a try? Thanks!</p></div></blockquote></div><div class="quotebox"><cite>Val532 wrote:</cite><blockquote><div><p>Can you provide your patch please.</p></div></blockquote></div><p>The poster above covers it pretty well - apply the VGA arbitration patch to 3.13rc and you should be good.</p><p>A.W. recommended using kernel 3.13rc + qemu.git OR kernel 3.12.5 + qemu 1.7.0 with the following commits patched in: <a href="https://lists.fedoraproject.org/pipermail/virt/2013-December/003916.html" rel="nofollow">https://lists.fedoraproject.org/piperma … 03916.html</a></p><p>I have tried both 3.13rc4 and 3.12.5, and as A.W. said either work perfectly after applying the patches. I believe the key is the 915 VGA arbiter patch, and NoSnoop if your device is listing NoSnoop+ in &quot;lspci -vv&quot;.</p><p>For those interested in replicating my configuration exactly, I also used this kernel patch to fix an IOMMU-related traceback present in dmesg on boot: Quirk non-compliant PCIe-to-PCI bridges - fixes backtrace in dmesg on certain systems with broken PCIe-to-PCI bridges - <a href="http://lists.linux-foundation.org/pipermail/iommu/2013-May/005668.html" rel="nofollow">http://lists.linux-foundation.org/piper … 05668.html</a></p> <p class="postedit"><em>Last edited by firewing1 (2013-12-23 05:46:08)</em></p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1363147">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1363156" class="blockpost roweven"> <h2><span><span class="conr">#910</span> <a href="viewtopic.php?pid=1363156#p1363156">2013-12-23 06:27:52</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=76834">Val532</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2013-11-13</span></dd> <dd><span>Posts: 35</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=76834">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <p>Ok thanks.</p><p>But i have one problem, with kernel 3.13-rc4 (with i915-patch and acs patch) and qemu from git, my VM (Windows 7) refuse to boot ! But with qemu 1.7 it work.</p><p>And my VGA card, an 7770HD have NoSnoop+ so i patch qemu with NoSnoop patch but the error 0x00000116 is always here !</p><p>It&#039;s crazy, because in the past i managed to work, but i don&#039;t understand what is the difference with my setup now !</p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1363156">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1363181" class="blockpost rowodd"> <h2><span><span class="conr">#911</span> <a href="viewtopic.php?pid=1363181#p1363181">2013-12-23 08:54:53</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=77762">firewing1</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2013-12-17</span></dd> <dd><span>Posts: 9</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=77762">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>Val532 wrote:</cite><blockquote><div><p>And my VGA card, an 7770HD have NoSnoop+ so i patch qemu with NoSnoop patch but the error 0x00000116 is always here !</p><p>It&#039;s crazy, because in the past i managed to work, but i don&#039;t understand what is the difference with my setup now !</p></div></blockquote></div><p>Are you passing an HDMI audio device along with your GPU? If so, try booting after changing &quot;bus=root.1,addr=0x01&quot; for &quot;bus=pcie.0&quot; on the HDMI PCI device or alternatively remove it altogether. In my case (as other Radeon users have suggested in this thread), I had to move my HDMI device to pcie.0 in order to overcome BSOD 0x116, even with all patches applied. Prior to the patches, I would get 0x116 regardless of the status of the HDMI PCI device.</p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1363181">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1363233" class="blockpost roweven"> <h2><span><span class="conr">#912</span> <a href="viewtopic.php?pid=1363233#p1363233">2013-12-23 14:15:15</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=75590">aw</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2013-10-04</span></dd> <dd><span>Posts: 921</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=75590">Email</a></span> <span class="website"><a href="http://vfio.blogspot.com/" rel="nofollow">Website</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>firewing1 wrote:</cite><blockquote><div><p>A.W. recommended using kernel 3.13rc + qemu.git OR kernel 3.12.5 + qemu 1.7.0 with the following commits patched in: <a href="https://lists.fedoraproject.org/pipermail/virt/2013-December/003916.html" rel="nofollow">https://lists.fedoraproject.org/piperma … 03916.html</a></p><p>I have tried both 3.13rc4 and 3.12.5, and as A.W. said either work perfectly after applying the patches. I believe the key is the 915 VGA arbiter patch, and NoSnoop if your device is listing NoSnoop+ in &quot;lspci -vv&quot;.</p></div></blockquote></div><p>The commits in the above url supersede the NoSnoop patch.&#160; The NoSnoop patch should no longer be necessary.</p> </div> <div class="postsignature postmsg"><hr /><p><a href="http://vfio.blogspot.com" rel="nofollow">http://vfio.blogspot.com</a><br />Looking for a more open forum to discuss vfio related uses?&#160; Try <a href="https://www.redhat.com/mailman/listinfo/vfio-users" rel="nofollow">https://www.redhat.com/mailman/listinfo/vfio-users</a></p></div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1363233">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1363244" class="blockpost rowodd"> <h2><span><span class="conr">#913</span> <a href="viewtopic.php?pid=1363244#p1363244">2013-12-23 15:03:53</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=76834">Val532</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2013-11-13</span></dd> <dd><span>Posts: 35</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=76834">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>firewing1 wrote:</cite><blockquote><div><p>Are you passing an HDMI audio device along with your GPU? If so, try booting after changing &quot;bus=root.1,addr=0x01&quot; for &quot;bus=pcie.0&quot; on the HDMI PCI device or alternatively remove it altogether. In my case (as other Radeon users have suggested in this thread), I had to move my HDMI device to pcie.0 in order to overcome BSOD 0x116, even with all patches applied. Prior to the patches, I would get 0x116 regardless of the status of the HDMI PCI device.</p></div></blockquote></div><p>I tested all possibility and i do not understand ! Is it possible that an external library causes the problem ?</p><p>I will do more test during the next hours.</p><p>Thanks.</p><p>And </p><div class="quotebox"><cite>aw wrote:</cite><blockquote><div><p>The commits in the above url supersede the NoSnoop patch.&#160; The NoSnoop patch should no longer be necessary.</p></div></blockquote></div><p>So you&#039;re saying with Kernel 3.13-rc4 and qemu git is no need to use NoSnoop patch, but acs patch and i915 patch is needed ?</p> <p class="postedit"><em>Last edited by Val532 (2013-12-23 15:05:16)</em></p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1363244">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1363249" class="blockpost roweven"> <h2><span><span class="conr">#914</span> <a href="viewtopic.php?pid=1363249#p1363249">2013-12-23 15:17:27</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=75590">aw</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2013-10-04</span></dd> <dd><span>Posts: 921</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=75590">Email</a></span> <span class="website"><a href="http://vfio.blogspot.com/" rel="nofollow">Website</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>Val532 wrote:</cite><blockquote><div><div class="quotebox"><cite>aw wrote:</cite><blockquote><div><p>The commits in the above url supersede the NoSnoop patch.&#160; The NoSnoop patch should no longer be necessary.</p></div></blockquote></div><p>So you say with Kernel 3.13-rc4 and qemu git is no need to use NoSnoop patch, but acs patch and i915 patch is needed ?</p></div></blockquote></div><p>The ACS patch should be used with caution.&#160; It&#039;s purpose is to allow the user to override and supplement the PCI ACS information provided by the hardware.&#160; If used improperly this can indicate that devices are isolated from each other when they actually are not.&#160; Lack of real isolation can mean DMA transactions can go to other devices rather than be translated through the IOMMU.&#160; This can create very difficult to debug problems.&#160; There&#039;s a reason why this patch was rejected upstream.</p><p>The i915 patches are necessary if you have Intel graphics and it will cause DRI to be disabled on the host X session using the Intel device.&#160; AFAIK, these patches are correct other than inducing poor behavior in other layers.</p> </div> <div class="postsignature postmsg"><hr /><p><a href="http://vfio.blogspot.com" rel="nofollow">http://vfio.blogspot.com</a><br />Looking for a more open forum to discuss vfio related uses?&#160; Try <a href="https://www.redhat.com/mailman/listinfo/vfio-users" rel="nofollow">https://www.redhat.com/mailman/listinfo/vfio-users</a></p></div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1363249">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1363286" class="blockpost rowodd"> <h2><span><span class="conr">#915</span> <a href="viewtopic.php?pid=1363286#p1363286">2013-12-23 16:47:14</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=59037">techdude300</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2012-04-09</span></dd> <dd><span>Posts: 4</span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <p>Thanks for this guide! I&#039;ve been wanting to do something like this for a long time, was about to go the Xen route but this seemed a little easier for a noob like me. Mostly everything works, though I&#039;m still having issues with getting it to play nice with pulseaudio (I may go get a cheap usb soundcard and just pass that through if all else fails).</p><p>One strange thing I&#039;ve noticed is that when I start a VM and then shut it down, either using system_powerdown qemu command or shutting it down from within the Windows VM (Win 8) it shuts down cleanly, but doesn&#039;t free up the memory it allocated to the VM. This means that after running and stopping a VM, I have about 3GB of memory my system is telling me is still in use. I can&#039;t find any process that&#039;s using all this memory. There&#039;s no lingering qemu processes, and top/htop doesn&#039;t show anything using up all that memory (even run as root). There also aren&#039;t any huge files in /tmp that might cause this, but free -h and similar tools insist that 3GB is being used and it certainly acts like it, since if I try to run the command to start the VM again it just steals another 3GB, and trying it a 3rd time pushes my poor 8GB machine to start swapping like a maniac, usually so bad I just have to hard reset the host, which I hate to do. Is this normal for qemu, and I&#039;m just not understanding something right? Even if I could allocate that 3GB on boot and have it be re-used by subsequent VM launches would be nice. The command I&#039;m using (as root):</p><div class="codebox"><pre><code>QEMU_PA_SAMPLES=128 QEMU_AUDIO_DRV=pa qemu-system-x86_64 -enable-kvm -M q35 -m 3072 \ -cpu host -smp 6,sockets=1,cores=6,threads=1 -bios /usr/share/qemu/bios.bin -vga none \ -device ioh3420,bus=pcie.0,addr=1c.0,multifunction=on,port=1,chassis=1,id=root.1 \ -device vfio-pci,host=04:00.0,bus=root.1,addr=00.0,multifunction=on,x-vga=on \ -device vfio-pci,host=04:00.1,bus=root.1,addr=00.1 \ -nographic \ -device ahci,bus=pcie.0,id=ahci \ -drive file=/home/william/VirtualBox\ VMs/Windows\ 8/Windows\ 8.vdi,id=disk,format=vdi,cache=none \ -device ide-hd,bus=ahci.0,drive=disk \ -device ich9-intel-hda,bus=pcie.0,addr=1b.0,id=sound0 \ -device hda-duplex,id=sound0-codec0,bus=sound0.0,cad=0 \ -monitor stdio \ -device vfio-pci,host=00:12.0,bus=pcie.0 \ -device vfio-pci,host=00:12.2,bus=pcie.0</code></pre></div><p>Where 04:00.* is the video card (radeon 4850), and 00:12.* is a usb controller. Guest VM is Windows 8 x64, host is running kernel 3.13.0-rc3.</p><p>(EDIT: spaced things out better in the above command for readbility)</p> <p class="postedit"><em>Last edited by techdude300 (2013-12-23 16:52:23)</em></p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1363286">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1363304" class="blockpost roweven"> <h2><span><span class="conr">#916</span> <a href="viewtopic.php?pid=1363304#p1363304">2013-12-23 18:14:07</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=77762">firewing1</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2013-12-17</span></dd> <dd><span>Posts: 9</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=77762">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>Val532 wrote:</cite><blockquote><div><p>I tested all possibility and i do not understand ! Is it possible that an external library causes the problem ?</p></div></blockquote></div><p>In my case it was definitely kernel + QEMU that was the cause. As soon as I upgraded to kernel-3.13rc and QEMU.git, the very same virtual machine image started working without a BSOD.</p><div class="quotebox"><cite>Val532 wrote:</cite><blockquote><div><p>So you&#039;re saying with Kernel 3.13-rc4 and qemu git is no need to use NoSnoop patch, but acs patch and i915 patch is needed ?</p></div></blockquote></div><p>The i915 patches are needed in either case, NoSnoop is only needed if your device is showing &quot;NoSnoop+&quot; when you check &quot;lspci -vv&quot;. I didn&#039;t use the ACS patch, but if you need to refer to A.W.&#039;s post above.</p><div class="quotebox"><cite>techdude300 wrote:</cite><blockquote><div><p>One strange thing I&#039;ve noticed is that when I start a VM and then shut it down, either using system_powerdown qemu command or shutting it down from within the Windows VM (Win 8) it shuts down cleanly, but doesn&#039;t free up the memory it allocated to the VM</p></div></blockquote></div><p>What&#039;s the output of &quot;free -m&quot; after closing the VM? My guess is that the memory is just being cached in case you re-start the VM again, and will be freed automatically as the system demands it. If you see a large amount of memory in the &quot;cached&quot; column from the command, then this is the case.</p> <p class="postedit"><em>Last edited by firewing1 (2013-12-23 18:15:07)</em></p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1363304">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1363317" class="blockpost rowodd"> <h2><span><span class="conr">#917</span> <a href="viewtopic.php?pid=1363317#p1363317">2013-12-23 19:15:35</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=59037">techdude300</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2012-04-09</span></dd> <dd><span>Posts: 4</span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>firewing1 wrote:</cite><blockquote><div><div class="quotebox"><cite>techdude300 wrote:</cite><blockquote><div><p>One strange thing I&#039;ve noticed is that when I start a VM and then shut it down, either using system_powerdown qemu command or shutting it down from within the Windows VM (Win 8) it shuts down cleanly, but doesn&#039;t free up the memory it allocated to the VM</p></div></blockquote></div><p>What&#039;s the output of &quot;free -m&quot; after closing the VM? My guess is that the memory is just being cached in case you re-start the VM again, and will be freed automatically as the system demands it. If you see a large amount of memory in the &quot;cached&quot; column from the command, then this is the case.</p></div></blockquote></div><p>I don&#039;t think it&#039;s cached, because the system doesn&#039;t seem to be freeing it when it&#039;s needed, because when I stop and start the VM three times (3gb vm, 8gb mem on host) it starts swapping very heavily. Here&#039;s free -m before a run:</p><div class="codebox"><pre><code> total used free shared buffers cached Mem: 7953 1666 6287 32 56 564 -/+ buffers/cache: 1046 6907 Swap: 8187 0 8187</code></pre></div><p>While qemu is running:</p><div class="codebox"><pre><code> total used free shared buffers cached Mem: 7953 4837 3116 33 56 577 -/+ buffers/cache: 4202 3751 Swap: 8187 0 8187</code></pre></div><p>And after a clean shutdown (shutdown via guest), qemu not running:</p><div class="codebox"><pre><code> total used free shared buffers cached Mem: 7953 4787 3166 28 57 579 -/+ buffers/cache: 4150 3803 Swap: 8187 0 8187</code></pre></div><p>I&#039;m not very knowledgable on Linux memory management, but if the memory doesn&#039;t appear to be used by a process, or any tmpfs using RAM, could that mean that the kernel is allocating all that memory and not releasing it? Could this be a kernel bug? Some things I&#039;ve noticed after further testing that the issue is not affected by choice of guest OS (tested Ubuntu and Windows 8), and memory is successfully returned if I don&#039;t pass any devices through (both Ubuntu and Windows). However, when I pass either the USB controller, VGA card, or both to the VM (both Ubuntu and Win 8) memory is not returned on qemu exiting. This makes me think it&#039;s some kind of bug in either the kernel, qemu, or my motherboard&#039;s IOMMU stuff. Motherboard is Gigabyte 531020 GA-990FXA-UD3, just bought it a few days ago. I&#039;ve been having issues with USB3 while UEFI booting, and I remember there being something about vga passthrough on Xen not working right when the host was UEFI booted, so I wouldn&#039;t be surprised if that&#039;s messing something up. I&#039;ll set up grub and do a normal bios boot and see if it changes anything.</p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1363317">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1363318" class="blockpost roweven"> <h2><span><span class="conr">#918</span> <a href="viewtopic.php?pid=1363318#p1363318">2013-12-23 19:19:23</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=76834">Val532</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2013-11-13</span></dd> <dd><span>Posts: 35</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=76834">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>aw wrote:</cite><blockquote><div><p>The ACS patch should be used with caution.&#160; It&#039;s purpose is to allow the user to override and supplement the PCI ACS information provided by the hardware.&#160; If used improperly this can indicate that devices are isolated from each other when they actually are not.&#160; Lack of real isolation can mean DMA transactions can go to other devices rather than be translated through the IOMMU.&#160; This can create very difficult to debug problems.&#160; There&#039;s a reason why this patch was rejected upstream.</p><p>The i915 patches are necessary if you have Intel graphics and it will cause DRI to be disabled on the host X session using the Intel device.&#160; AFAIK, these patches are correct other than inducing poor behavior in other layers.</p></div></blockquote></div><p>Ok so with a 3.13-rc4 without patch (no i915 or acs) my VM do not work, but i do not see any BSOD just reboot so it&#039;s maybe an other problem in my machine. Also i see a new problem in dmesg durring the VM work&#160; : </p><div class="codebox"><pre><code>vfio_pin_pages: RLIMIT_MEMLOCK (65536) exceeded</code></pre></div><p>and at the stop of the VM :</p><div class="codebox"><pre class="vscroll"><code>[ 663.077661] WARNING: CPU: 1 PID: 532 at drivers/gpu/drm/i915/intel_display.c:6309 hsw_enable_pc8_work+0x6c9/0x6f0 [i915]() [ 663.077662] Power well on [ 663.077663] Modules linked in: vfio_iommu_type1(F) vfio_pci(F) vfio(F) ip6table_filter(F) ip6_tables(F) iptable_filter(F) ip_tables(F) ebtable_nat(F) ebtables(F) x_tables(F) bnep(F) bridge(F) rfcomm(F) stp(F) bluetooth(F) llc(F) parport_pc(F) ppdev(F) x86_pkg_temp_thermal(F) intel_powerclamp(F) coretemp(F) kvm_intel(F) kvm(F) crct10dif_pclmul(F) crc32_pclmul(F) ghash_clmulni_intel(F) aesni_intel(F) aes_x86_64(F) lrw(F) gf128mul(F) glue_helper(F) ablk_helper(F) cryptd(F) mxm_wmi(F) snd_hda_codec_hdmi(F) snd_hda_codec_realtek(F) snd_hda_intel(F) snd_hda_codec(F) snd_hwdep(F) snd_pcm(F) snd_page_alloc(F) i915(F) snd_seq_midi(F) snd_seq_midi_event(F) snd_rawmidi(F) snd_seq(F) snd_seq_device(F) snd_timer(F) psmouse(F) mei_me(F) drm_kms_helper(F) drm(F) mei(F) microcode(F) snd(F) soundcore(F) serio_raw(F) video(F) wmi(F) lpc_ich(F) mac_hid(F) lp(F) parport(F) hid_generic(F) usbhid(F) hid(F) igb(F) i2c_algo_bit(F) dca(F) ahci(F) libahci(F) e1000e(F) ptp(F) pps_core(F) [ 663.077693] CPU: 1 PID: 532 Comm: kworker/1:2 Tainted: GF W 3.13.0-rc4-no-patch #1 [ 663.077694] Hardware name: To Be Filled By O.E.M. To Be Filled By O.E.M./Z87 Extreme6, BIOS P2.10 07/03/2013 [ 663.077702] Workqueue: events hsw_enable_pc8_work [i915] [ 663.077703] 0000000000000009 ffff88060a671d58 ffffffff81714c09 ffff88060a671da0 [ 663.077706] ffff88060a671d90 ffffffff810643ad ffff88060bf83bc8 ffff88060bf80000 [ 663.077707] ffff88060d116350 ffff88060d116358 0000000000000040 ffff88060a671df0 [ 663.077710] Call Trace: [ 663.077715] [&lt;ffffffff81714c09&gt;] dump_stack+0x45/0x56 [ 663.077718] [&lt;ffffffff810643ad&gt;] warn_slowpath_common+0x7d/0xa0 [ 663.077720] [&lt;ffffffff8106441c&gt;] warn_slowpath_fmt+0x4c/0x50 [ 663.077728] [&lt;ffffffffa026d0e9&gt;] hsw_enable_pc8_work+0x6c9/0x6f0 [i915] [ 663.077730] [&lt;ffffffff810800f2&gt;] process_one_work+0x182/0x450 [ 663.077732] [&lt;ffffffff81080eb1&gt;] worker_thread+0x121/0x410 [ 663.077734] [&lt;ffffffff81080d90&gt;] ? rescuer_thread+0x3e0/0x3e0 [ 663.077737] [&lt;ffffffff81087b52&gt;] kthread+0xd2/0xf0 [ 663.077739] [&lt;ffffffff81087a80&gt;] ? kthread_create_on_node+0x190/0x190 [ 663.077742] [&lt;ffffffff8172577c&gt;] ret_from_fork+0x7c/0xb0 [ 663.077744] [&lt;ffffffff81087a80&gt;] ? kthread_create_on_node+0x190/0x190 [ 663.077745] ---[ end trace 47811739132dc27e ]--- [ 726.106603] ------------[ cut here ]------------ [ 726.106623] WARNING: CPU: 1 PID: 532 at drivers/gpu/drm/i915/intel_display.c:6309 hsw_enable_pc8_work+0x6c9/0x6f0 [i915]() [ 726.106624] Power well on [ 726.106625] Modules linked in: vfio_iommu_type1(F) vfio_pci(F) vfio(F) ip6table_filter(F) ip6_tables(F) iptable_filter(F) ip_tables(F) ebtable_nat(F) ebtables(F) x_tables(F) bnep(F) bridge(F) rfcomm(F) stp(F) bluetooth(F) llc(F) parport_pc(F) ppdev(F) x86_pkg_temp_thermal(F) intel_powerclamp(F) coretemp(F) kvm_intel(F) kvm(F) crct10dif_pclmul(F) crc32_pclmul(F) ghash_clmulni_intel(F) aesni_intel(F) aes_x86_64(F) lrw(F) gf128mul(F) glue_helper(F) ablk_helper(F) cryptd(F) mxm_wmi(F) snd_hda_codec_hdmi(F) snd_hda_codec_realtek(F) snd_hda_intel(F) snd_hda_codec(F) snd_hwdep(F) snd_pcm(F) snd_page_alloc(F) i915(F) snd_seq_midi(F) snd_seq_midi_event(F) snd_rawmidi(F) snd_seq(F) snd_seq_device(F) snd_timer(F) psmouse(F) mei_me(F) drm_kms_helper(F) drm(F) mei(F) microcode(F) snd(F) soundcore(F) serio_raw(F) video(F) wmi(F) lpc_ich(F) mac_hid(F) lp(F) parport(F) hid_generic(F) usbhid(F) hid(F) igb(F) i2c_algo_bit(F) dca(F) ahci(F) libahci(F) e1000e(F) ptp(F) pps_core(F) [ 726.106654] CPU: 1 PID: 532 Comm: kworker/1:2 Tainted: GF W 3.13.0-rc4-no-patch #1 [ 726.106655] Hardware name: To Be Filled By O.E.M. To Be Filled By O.E.M./Z87 Extreme6, BIOS P2.10 07/03/2013 [ 726.106663] Workqueue: events hsw_enable_pc8_work [i915] [ 726.106664] 0000000000000009 ffff88060a671d58 ffffffff81714c09 ffff88060a671da0 [ 726.106667] ffff88060a671d90 ffffffff810643ad ffff88060bf83bc8 ffff88060bf80000 [ 726.106669] ffff88060d116350 ffff88060d116358 0000000000000040 ffff88060a671df0 [ 726.106671] Call Trace: [ 726.106676] [&lt;ffffffff81714c09&gt;] dump_stack+0x45/0x56 [ 726.106679] [&lt;ffffffff810643ad&gt;] warn_slowpath_common+0x7d/0xa0 [ 726.106681] [&lt;ffffffff8106441c&gt;] warn_slowpath_fmt+0x4c/0x50 [ 726.106690] [&lt;ffffffffa026d0e9&gt;] hsw_enable_pc8_work+0x6c9/0x6f0 [i915] [ 726.106693] [&lt;ffffffff810800f2&gt;] process_one_work+0x182/0x450 [ 726.106694] [&lt;ffffffff81080eb1&gt;] worker_thread+0x121/0x410 [ 726.106696] [&lt;ffffffff81080d90&gt;] ? rescuer_thread+0x3e0/0x3e0 [ 726.106699] [&lt;ffffffff81087b52&gt;] kthread+0xd2/0xf0 [ 726.106701] [&lt;ffffffff81087a80&gt;] ? kthread_create_on_node+0x190/0x190 [ 726.106703] [&lt;ffffffff8172577c&gt;] ret_from_fork+0x7c/0xb0 [ 726.106706] [&lt;ffffffff81087a80&gt;] ? kthread_create_on_node+0x190/0x190 [ 726.106707] ---[ end trace 47811739132dc27f ]--- [ 741.101725] ------------[ cut here ]------------ [ 741.101745] WARNING: CPU: 0 PID: 46 at drivers/gpu/drm/i915/intel_display.c:6309 hsw_enable_pc8_work+0x6c9/0x6f0 [i915]() [ 741.101746] Power well on [ 741.101747] Modules linked in: vfio_iommu_type1(F) vfio_pci(F) vfio(F) ip6table_filter(F) ip6_tables(F) iptable_filter(F) ip_tables(F) ebtable_nat(F) ebtables(F) x_tables(F) bnep(F) bridge(F) rfcomm(F) stp(F) bluetooth(F) llc(F) parport_pc(F) ppdev(F) x86_pkg_temp_thermal(F) intel_powerclamp(F) coretemp(F) kvm_intel(F) kvm(F) crct10dif_pclmul(F) crc32_pclmul(F) ghash_clmulni_intel(F) aesni_intel(F) aes_x86_64(F) lrw(F) gf128mul(F) glue_helper(F) ablk_helper(F) cryptd(F) mxm_wmi(F) snd_hda_codec_hdmi(F) snd_hda_codec_realtek(F) snd_hda_intel(F) snd_hda_codec(F) snd_hwdep(F) snd_pcm(F) snd_page_alloc(F) i915(F) snd_seq_midi(F) snd_seq_midi_event(F) snd_rawmidi(F) snd_seq(F) snd_seq_device(F) snd_timer(F) psmouse(F) mei_me(F) drm_kms_helper(F) drm(F) mei(F) microcode(F) snd(F) soundcore(F) serio_raw(F) video(F) wmi(F) lpc_ich(F) mac_hid(F) lp(F) parport(F) hid_generic(F) usbhid(F) hid(F) igb(F) i2c_algo_bit(F) dca(F) ahci(F) libahci(F) e1000e(F) ptp(F) pps_core(F) [ 741.101776] CPU: 0 PID: 46 Comm: kworker/0:1 Tainted: GF W 3.13.0-rc4-no-patch #1 [ 741.101777] Hardware name: To Be Filled By O.E.M. To Be Filled By O.E.M./Z87 Extreme6, BIOS P2.10 07/03/2013 [ 741.101785] Workqueue: events hsw_enable_pc8_work [i915] [ 741.101787] 0000000000000009 ffff88060d3efd58 ffffffff81714c09 ffff88060d3efda0 [ 741.101789] ffff88060d3efd90 ffffffff810643ad ffff88060bf83bc8 ffff88060bf80000 [ 741.101791] ffff88060d116350 ffff88060d116358 0000000000000000 ffff88060d3efdf0 [ 741.101793] Call Trace: [ 741.101797] [&lt;ffffffff81714c09&gt;] dump_stack+0x45/0x56 [ 741.101800] [&lt;ffffffff810643ad&gt;] warn_slowpath_common+0x7d/0xa0 [ 741.101802] [&lt;ffffffff8106441c&gt;] warn_slowpath_fmt+0x4c/0x50 [ 741.101810] [&lt;ffffffffa026d0e9&gt;] hsw_enable_pc8_work+0x6c9/0x6f0 [i915] [ 741.101813] [&lt;ffffffff810800f2&gt;] process_one_work+0x182/0x450 [ 741.101815] [&lt;ffffffff81080eb1&gt;] worker_thread+0x121/0x410 [ 741.101817] [&lt;ffffffff81080d90&gt;] ? rescuer_thread+0x3e0/0x3e0 [ 741.101820] [&lt;ffffffff81087b52&gt;] kthread+0xd2/0xf0 [ 741.101822] [&lt;ffffffff81087a80&gt;] ? kthread_create_on_node+0x190/0x190 [ 741.101825] [&lt;ffffffff8172577c&gt;] ret_from_fork+0x7c/0xb0 [ 741.101827] [&lt;ffffffff81087a80&gt;] ? kthread_create_on_node+0x190/0x190 [ 741.101828] ---[ end trace 47811739132dc280 ]---</code></pre></div> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1363318">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1363321" class="blockpost rowodd"> <h2><span><span class="conr">#919</span> <a href="viewtopic.php?pid=1363321#p1363321">2013-12-23 19:29:41</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=53621">teekay</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2011-10-26</span></dd> <dd><span>Posts: 267</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=53621">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <p>@techdude300: try to uprade your kernel to latest -rc5. -rc3 was very flaky here, too.</p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1363321">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1363366" class="blockpost roweven"> <h2><span><span class="conr">#920</span> <a href="viewtopic.php?pid=1363366#p1363366">2013-12-23 21:36:06</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=77929">revasm</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2013-12-22</span></dd> <dd><span>Posts: 2</span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <p>Code 43 on i5-2500 IGP and Nvidia 560 TI. VGA works well (1200x800). Device/bus reset seems broken: QEMU issues &quot;Invalid ROM&quot; error on restart.</p><p>Z68 was not supposed to have full support for an IOMMU anyway, so I&#039;m surprised that VFIO works at all.</p><p>Linux 3.13-rc4<br />qemu.git 2013-12-20<br />i915 driver arbiter patches<br />qemu-vfio NoSnoop v1 patch (unpatched/patched, didn&#039;t make a difference, except to flip the NoSnoop bit)</p><br /><div class="codebox"><pre><code># cat run-kvm.sh #!/bin/sh ./pcistub-bind &quot;8086 1c2d&quot; &quot;0000:00:1a.0&quot; # USB 2.0 controller ./vfio-group 1 qemu-system-x86_64 -nodefaults \ -enable-kvm -M q35 -m 2048 -cpu SandyBridge \ -smp cores=2,threads=1,sockets=1 \ -bios /usr/share/qemu/bios.bin -rtc base=localtime \ -vga none -nographic -monitor stdio -boot menu=on \ -device ioh3420,bus=pcie.0,addr=1c.0,multifunction=on,port=1,chassis=1,id=ich9-pcie-port-1 \ -device vfio-pci,host=01:00.0,bus=ich9-pcie-port-1,addr=00.0,multifunction=on,x-vga=on,romfile=/export/misc/GF114.bin \ -device vfio-pci,host=01:00.1,bus=ich9-pcie-port-1,addr=00.1 \ -device pci-assign,host=00:1a.0,addr=1a.0,multifunction=on,id=ehci-1 \ -device ide-cd,drive=cd1,bus=ide.1 \ -device ide-cd,drive=cd2,bus=ide.2 \ -drive id=cd1,media=cdrom,index=1,file=/export/iso/en_windows_7*.iso \ -drive id=cd2,media=cdrom,index=2,file=/export/iso/virtio-win-0.1-74.iso \ -drive if=virtio,index=0,cache=none,format=qcow2,file=/export/vm/win7sp1.qcow2 \ -net bridge,br=br0 -net nic,model=virtio</code></pre></div><div class="codebox"><pre><code># cat /proc/cmdline initrd=\initramfs-linux-mainline.img root=PARTUUID=&quot;667c0274-455e-46a4-8f37-cab6d73269a6&quot; rw acpi_osi=Linux intel_iommu=on pci-stub.ids=8086:1c2d,10de:1200,10de:0e0c</code></pre></div><div class="codebox"><pre><code># cat /proc/version Linux version 3.13.0-1-mainline (gcc version 4.8.2 (GCC) ) #1 SMP PREEMPT Sun Dec 22 14:50:44 PST 2013</code></pre></div><div class="codebox"><pre><code># lsgroup | grep &quot;Group 1&quot; -A4 ### Group 1 ### 00:01.0 PCI bridge: Intel Corporation Xeon E3-1200/2nd Generation Core Processor Family PCI Express Root Port (rev 09) 01:00.0 VGA compatible controller: NVIDIA Corporation GF114 [GeForce GTX 560 Ti] (rev a1) 01:00.1 Audio device: NVIDIA Corporation GF114 HDMI Audio Controller (rev a1) ### Group 2 ###</code></pre></div><div class="codebox"><pre><code># lspci | egrep &quot;VGA|Audio&quot; 00:02.0 VGA compatible controller: Intel Corporation 2nd Generation Core Processor Family Integrated Graphics Controller (rev 09) 00:1b.0 Audio device: Intel Corporation 6 Series/C200 Series Chipset Family High Definition Audio Controller (rev 05) 01:00.0 VGA compatible controller: NVIDIA Corporation GF114 [GeForce GTX 560 Ti] (rev a1) 01:00.1 Audio device: NVIDIA Corporation GF114 HDMI Audio Controller (rev a1)</code></pre></div><div class="codebox"><pre><code># head -n1 /dev/vga_arbiter count:2,PCI:0000:00:02.0,decodes=io,owns=none,locks=none(0:0)</code></pre></div><div class="codebox"><pre><code># dmesg | grep -i iommu [ 0.000000] Intel-IOMMU: enabled [ 0.286043] dmar: IOMMU 0: reg_base_addr fed90000 ver 1:0 cap c0000020e60262 ecap f0101a [ 0.286048] dmar: IOMMU 1: reg_base_addr fed91000 ver 1:0 cap c9008020660262 ecap f0105a [ 0.286118] IOAPIC id 2 under DRHD base 0xfed91000 IOMMU 1 [ 0.567671] IOMMU 0 0xfed90000: using Queued invalidation [ 0.567672] IOMMU 1 0xfed91000: using Queued invalidation [ 0.567673] IOMMU: Setting RMRR: [ 0.567683] IOMMU: Setting identity map for device 0000:00:02.0 [0xcb800000 - 0xcf9fffff] [ 0.567983] IOMMU: Setting identity map for device 0000:00:1d.0 [0xca8c1000 - 0xca8d2fff] [ 0.567999] IOMMU: Setting identity map for device 0000:00:1a.0 [0xca8c1000 - 0xca8d2fff] [ 0.568008] IOMMU: Prepare 0-16MiB unity mapping for LPC [ 0.568015] IOMMU: Setting identity map for device 0000:00:1f.0 [0x0 - 0xffffff]</code></pre></div><div class="codebox"><pre><code># dmesg | tail -n12 [ 70.786246] pci-stub 0000:00:1a.0: claimed by stub [ 70.831198] VFIO - User Level meta-driver version: 0.3 [ 71.564129] tun: Universal TUN/TAP device driver, 1.6 [ 71.564132] tun: (C) 1999-2004 Max Krasnyansky &lt;maxk@qualcomm.com&gt; [ 71.564688] device tap0 entered promiscuous mode [ 71.564776] br0: port 2(tap0) entered forwarding state [ 71.564781] br0: port 2(tap0) entered forwarding state [ 72.140304] vfio-pci 0000:01:00.0: enabling device (0000 -&gt; 0003) [ 72.232772] vfio-pci 0000:01:00.1: enabling device (0000 -&gt; 0002) [ 72.675966] pci-stub 0000:00:1a.0: kvm assign device [ 86.574242] br0: port 2(tap0) entered forwarding state [ 87.229914] kvm: zapping shadow pages for mmio generation wraparound</code></pre></div><div class="codebox"><pre><code># dmesg | grep -i vga [ 0.482563] vgaarb: device added: PCI:0000:00:02.0,decodes=io+mem,owns=io+mem,locks=none [ 0.482566] vgaarb: device added: PCI:0000:01:00.0,decodes=io+mem,owns=none,locks=none [ 0.482567] vgaarb: loaded [ 0.482568] vgaarb: bridge control possible 0000:01:00.0 [ 0.482568] vgaarb: no bridge control possible 0000:00:02.0 [ 0.582479] fb0: EFI VGA frame buffer device [ 4.441728] fb: conflicting fb hw usage inteldrmfb vs EFI VGA - removing generic driver [ 4.572183] [drm] GMBUS [i915 gmbus vga] timed out, falling back to bit banging on pin 2 [ 4.852049] vgaarb: device changed decodes: PCI:0000:00:02.0,olddecodes=io+mem,decodes=io:owns=io</code></pre></div><div class="codebox"><pre class="vscroll"><code># lspci -vvv | grep GTX -A48 01:00.0 VGA compatible controller: NVIDIA Corporation GF114 [GeForce GTX 560 Ti] (rev a1) (prog-if 00 [VGA controller]) Subsystem: eVga.com. Corp. Device 1563 Control: I/O+ Mem+ BusMaster+ SpecCycle- MemWINV- VGASnoop- ParErr- Stepping- SERR+ FastB2B- DisINTx- Status: Cap+ 66MHz- UDF- FastB2B- ParErr- DEVSEL=fast &gt;TAbort- &lt;TAbort- &lt;MAbort- &gt;SERR+ &lt;PERR- INTx- Latency: 0, Cache Line Size: 64 bytes Interrupt: pin A routed to IRQ 16 Region 0: Memory at f4000000 (32-bit, non-prefetchable) [size=32M] Region 1: Memory at e0000000 (64-bit, prefetchable) [size=128M] Region 3: Memory at e8000000 (64-bit, prefetchable) [size=64M] Region 5: I/O ports at e000 [size=128] Expansion ROM at f6000000 [disabled] [size=512K] Capabilities: [60] Power Management version 3 Flags: PMEClk- DSI- D1- D2- AuxCurrent=0mA PME(D0-,D1-,D2-,D3hot-,D3cold-) Status: D0 NoSoftRst+ PME-Enable- DSel=0 DScale=0 PME- Capabilities: [68] MSI: Enable- Count=1/1 Maskable- 64bit+ Address: 0000000000000000 Data: 0000 Capabilities: [78] Express (v2) Endpoint, MSI 00 DevCap: MaxPayload 128 bytes, PhantFunc 0, Latency L0s &lt;4us, L1 &lt;64us ExtTag+ AttnBtn- AttnInd- PwrInd- RBE+ FLReset- DevCtl: Report errors: Correctable- Non-Fatal- Fatal- Unsupported- RlxdOrd+ ExtTag+ PhantFunc- AuxPwr- NoSnoop- MaxPayload 128 bytes, MaxReadReq 512 bytes DevSta: CorrErr- UncorrErr+ FatalErr- UnsuppReq- AuxPwr- TransPend- LnkCap: Port #0, Speed 2.5GT/s, Width x16, ASPM L0s L1, Latency L0 &lt;256ns, L1 &lt;4us ClockPM+ Surprise- LLActRep- BwNot- LnkCtl: ASPM Disabled; RCB 128 bytes Disabled- Retrain- CommClk+ ExtSynch- ClockPM- AutWidDis- BWInt- AutBWInt- LnkSta: Speed 2.5GT/s, Width x16, TrErr- Train- SlotClk+ DLActive- BWMgmt- ABWMgmt- DevCap2: Completion Timeout: Not Supported, TimeoutDis+, LTR-, OBFF Not Supported DevCtl2: Completion Timeout: 50us to 50ms, TimeoutDis-, LTR-, OBFF Disabled LnkCtl2: Target Link Speed: 2.5GT/s, EnterCompliance- SpeedDis- Transmit Margin: Normal Operating Range, EnterModifiedCompliance- ComplianceSOS- Compliance De-emphasis: -6dB LnkSta2: Current De-emphasis Level: -6dB, EqualizationComplete-, EqualizationPhase1- EqualizationPhase2-, EqualizationPhase3-, LinkEqualizationRequest- Capabilities: [b4] Vendor Specific Information: Len=14 &lt;?&gt; Capabilities: [100 v1] Virtual Channel Caps: LPEVC=0 RefClk=100ns PATEntryBits=1 Arb: Fixed- WRR32- WRR64- WRR128- Ctrl: ArbSelect=Fixed Status: InProgress- VC0: Caps: PATOffset=00 MaxTimeSlots=1 RejSnoopTrans- Arb: Fixed- WRR32- WRR64- WRR128- TWRR128- WRR256- Ctrl: Enable+ ID=0 ArbSelect=Fixed TC/VC=ff Status: NegoPending- InProgress- Capabilities: [128 v1] Power Budgeting &lt;?&gt; Capabilities: [600 v1] Vendor Specific Information: ID=0001 Rev=1 Len=024 &lt;?&gt; Kernel driver in use: vfio-pci Kernel modules: nouveau</code></pre></div> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1363366">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1363436" class="blockpost rowodd"> <h2><span><span class="conr">#921</span> <a href="viewtopic.php?pid=1363436#p1363436">2013-12-24 02:11:06</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=76834">Val532</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2013-11-13</span></dd> <dd><span>Posts: 35</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=76834">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <p>@aw : </p><p>My first sucess, now i have a working setup, with 3.12.0 kernel and i915 patch, and qemu git + NoSnoop patch (probably v2 but i&#039;m not sure).<br />Now i will try with 3.12.6 kernel.</p><p>Edit : And only with hdmi audio on pcie.0 insted of root.1</p><p>Edit 2nd : Now it work for me with 3.13-rc5 + i915 patch and qemu git without any patch. But only with hdmi audio as bus=pcie.0 and not root.1</p> <p class="postedit"><em>Last edited by Val532 (2013-12-24 04:10:16)</em></p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1363436">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1363440" class="blockpost roweven"> <h2><span><span class="conr">#922</span> <a href="viewtopic.php?pid=1363440#p1363440">2013-12-24 02:19:54</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=77297">paradexes</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2013-11-30</span></dd> <dd><span>Posts: 13</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=77297">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <p>This thread has been great. Thanks for the all the info so far. Also I have hardware now that does work and is supported for IOMMU. However now I am running into an issue when I run the qemu commands. Here is my commands and output:</p><div class="codebox"><pre><code>qemu-system-x86_64 -enable-kvm -M q35 -m 16024 -cpu host -smp 6,sockets=1,cores=6,threads=1 -bios /usr/share/qemu/bios.bin -vga none -device ioh3420,bus=pcie.0,addr=1c.0,multifunction=on,port=1,chassis=1,id=root.1 -device vfio-pci,host=03:00.0,bus=root.1,addr=00.0,multifunction=on,x-vga=on -device vfio-pci,host=03:00.1,bus=root.1,addr=00.1</code></pre></div><div class="codebox"><pre><code>qemu-system-x86_64: -device vfio-pci,host=03:00.0,bus=root.1,addr=00.0,multifunction=on,x-vga=on: vfio: error, group 17 is not viable, please ensure all devices within the iommu_group are bound to their vfio bus driver. qemu-system-x86_64: -device vfio-pci,host=03:00.0,bus=root.1,addr=00.0,multifunction=on,x-vga=on: vfio: failed to get group 17 qemu-system-x86_64: -device vfio-pci,host=03:00.0,bus=root.1,addr=00.0,multifunction=on,x-vga=on: Device initialization failed. qemu-system-x86_64: -device vfio-pci,host=03:00.0,bus=root.1,addr=00.0,multifunction=on,x-vga=on: Device &#039;vfio-pci&#039; could not be initialized</code></pre></div><p>What am I missing here? It seems like its almost there but I am sure I am issing something here. The error seems to indicate to put this in an iommu_group which I was under the impression I did. </p><p>Edit: Specs. Im running on an TYAN S8225 board. Running 32Gb of memory with 2x 4234 Opterons, OS: Linuxmint 16 with 3.12.6 kernel. I have an nvidia 660ti as the host card and my intended card is an AMD R9 270X.</p><p>Thanks</p> <p class="postedit"><em>Last edited by paradexes (2013-12-24 04:48:01)</em></p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1363440">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1363511" class="blockpost rowodd"> <h2><span><span class="conr">#923</span> <a href="viewtopic.php?pid=1363511#p1363511">2013-12-24 10:37:07</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=77651">noobman</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2013-12-13</span></dd> <dd><span>Posts: 21</span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <p>@techdude300: i have exactly same problem with memory, pls let me/us know if you find a fix/workaround;</p><p>@paradexes: i had same output, but i saw it works prefix sudo ...&#160; so looking into it <a href="https://www.kernel.org/doc/Documentation/vfio.txt" rel="nofollow">i found this</a> :</p><div class="quotebox"><blockquote><div><p>...The final step is to provide the user with access to the group if unprivileged operation is desired (note that /dev/vfio/vfio provides no capabilities on its own and is therefore expected to be set to mode 0666 by the system)...</p></div></blockquote></div><div class="codebox"><pre><code># chown user:user /dev/vfio/17</code></pre></div><p>Afterwards i think should work. This is like a default and needs a change, i would vote for this to be mentioned by OP because it was not obvious for me either.</p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1363511">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1363619" class="blockpost roweven"> <h2><span><span class="conr">#924</span> <a href="viewtopic.php?pid=1363619#p1363619">2013-12-24 18:53:02</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=73593">BulliteShot</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2013-07-28</span></dd> <dd><span>Posts: 26</span></dd> <dd class="usercontacts"><span class="email"><a href="mailto:josh@servebyte.com">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <p>Well i&#039;m back with a &quot;Crosshair V Formula&quot; motherboard and FX CPU. Upon booting the VM, my system freezes up when the BIOS screen loads and says no bootable device. The text is also strangly spaced out wide.</p><p>Anyone know how to fix the crash or is this because the BIOS is resetting after failing to boot?</p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1363619">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1363764" class="blockpost rowodd"> <h2><span><span class="conr">#925</span> <a href="viewtopic.php?pid=1363764#p1363764">2013-12-25 11:57:40</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=77960">xani</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2013-12-24</span></dd> <dd><span>Posts: 6</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=77960">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <p>Hi, first of all big thanks to nbhs and Alex for your awesome job!</p><p>I managed to make this work with pci-assign back in July, but I couldn&#039;t reboot even with ejecting gpu on shutdown. I was using windows 8 and it gave BSOD on shutdown everytime and gpu wouldn&#039;t reset.<br />Now I want to do this using vfio. I managed to get it working with acs override and i915 patches for rc3. I&#039;m using qemu-git, seabios-git and linux-mainline provided by nbhs at first page.</p><p>My setup:<br />cpu: i7-4770<br />mobo: asrock z87 extreme6<br />gpu: radeon hd7870 GHz edition</p><p>Anyway, I had the same problem as noobman and techdude300, memory wouldn&#039;t free after closing qemu.<br />I bisected problem to commit </p><div class="codebox"><pre><code>0c44c2d0f459cd7e275242b72f500137c4fa834d</code></pre></div><p>I also reverted this one, I think it would&#039;nt build without reverting this but now I&#039;m not sure.</p><div class="codebox"><pre><code>b021fe3e25094fbec22d0eff846d2adeee1b9736</code></pre></div><p>Now it does free memory, but I cannot reboot anyway because seabios is hanging at &#039;_&#039; and after a while it shows that it cannot find hard drive to boot from.<br />Host reboot is necessary to fire up vm again.</p><p>My config:</p><div class="codebox"><pre><code>$ cat /proc/cmdline BOOT_IMAGE=/vmlinuz-linux-mainline root=UUID=a63d1c94-4682-431c-9788-0cccd29ee598 rw intel_iommu=on pci-stub.ids=1002:6818,1002:aab0,8086:0 c0c,8086:153b pcie_acs_override=downstream</code></pre></div><div class="codebox"><pre><code>qemu-system-x86_64 -M q35 \ -m 8196 -enable-kvm -cpu host -monitor stdio \ -smp 4,sockets=1,cores=4,threads=1 \ -rtc clock=host,base=localtime \ -vga none -net none \ -parallel none -serial none \ -usb -usbdevice host:05ac:0221 -usbdevice host:1532:0037 \ -device ahci,bus=pcie.0,id=ahci \ -device ioh3420,bus=pcie.0,addr=1c.0,multifunction=on,port=1,chassis=1,id=root.1 \ -device vfio-pci,host=01:00.0,bus=root.1,addr=00.0,multifunction=on,x-vga=on \ -device vfio-pci,host=01:00.1,bus=pcie.0 \ -device vfio-pci,host=00:19.0,bus=pcie.0 \ -device vfio-pci,host=05:00.0,bus=pcie.0 </code></pre></div><p>I use nbhs script from first page to bind devices.</p><p>Here&#039;s my directory from which you can test that memory leak issues.<br /><a href="http://www.fileswap.com/dl/qlZAIl1IF/" rel="nofollow">linux-mainline.tar.gz</a></p><p>Provide me with feedback if you have the same problem with seabios after reverting those patches.</p><p>EDIT:<br />Further investigation showed that this problem can lie within gcc itself. <a href="http://www.linux-magazine.com/Issues/2014/158/Kernel-News" rel="nofollow">Here&#039;s</a> link that can give you explanation. I will report on my findings asap.</p><p>EDIT2:<br />OK, so after disabling asm goto with this little <a href="http://www.fileswap.com/dl/WcyVmJgPwt/" rel="nofollow">patch</a>, it works just like reversing commits. But this bug should be fixed by commit </p><div class="codebox"><pre><code>88f182dd77</code></pre></div><p> Maybe it&#039;s another thing then. I still have few options to try.</p> <p class="postedit"><em>Last edited by xani (2013-12-25 14:49:06)</em></p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1363764">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div class="postlinksb"> <div class="inbox crumbsplus"> <div class="pagepost"> <p class="pagelink conl"><span class="pages-label">Pages: </span><a rel="prev" class="item1" href="viewtopic.php?id=162768&amp;p=36">Previous</a> <a href="viewtopic.php?id=162768">1</a> <span class="spacer">…</span> <a href="viewtopic.php?id=162768&amp;p=35">35</a> <a href="viewtopic.php?id=162768&amp;p=36">36</a> <strong>37</strong> <a href="viewtopic.php?id=162768&amp;p=38">38</a> <a href="viewtopic.php?id=162768&amp;p=39">39</a> <span class="spacer">…</span> <a href="viewtopic.php?id=162768&amp;p=234">234</a> <a rel="next" href="viewtopic.php?id=162768&amp;p=38">Next</a></p> <p class="postlink conr">Topic closed</p> </div> <ul class="crumbs"> <li><a href="index.php">Index</a></li> <li><span>»&#160;</span><a href="viewforum.php?id=48">Topics Going Nowhere</a></li> <li><span>»&#160;</span><strong><a href="viewtopic.php?id=162768">KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</a></strong></li> </ul> <p class="subscribelink clearb"><a href="misc.php?action=subscribe&amp;tid=162768">Subscribe to this topic</a></p> <div class="clearer"></div> </div> </div> </div> <div id="brdfooter" class="block"> <h2><span>Board footer</span></h2> <div class="box"> <div id="brdfooternav" class="inbox"> <div class="conl"> <form id="qjump" method="get" action="viewforum.php"> <div><label><span>Jump to<br /></span> <select name="id" onchange="window.location=('viewforum.php?id='+this.options[this.selectedIndex].value)"> <optgroup label="Technical Issues and Assistance"> <option value="23">Newbie Corner</option> <option value="17">Installation</option> <option value="22">Kernel &amp; Hardware</option> <option value="18">Applications &amp; Desktop Environments</option> <option value="31">Laptop Issues</option> <option value="8">Networking, Server, and Protection</option> <option value="32">Multimedia and Games</option> <option value="50">System Administration</option> <option value="35">Other Architectures</option> </optgroup> <optgroup label="Arch-centric"> <option value="24">Announcements, Package &amp; Security Advisories</option> <option value="1">Arch Discussion</option> <option value="13">Forum &amp; Wiki discussion</option> </optgroup> <optgroup label="Pacman Upgrades, Packaging &amp; AUR"> <option value="44">Pacman &amp; Package Upgrade Issues</option> <option value="49">[testing] Repo Forum</option> <option value="4">Creating &amp; Modifying Packages</option> <option value="38">AUR Issues, Discussion &amp; PKGBUILD Requests</option> </optgroup> <optgroup label="Contributions &amp; Discussion"> <option value="20">GNU/Linux Discussion</option> <option value="27">Community Contributions</option> <option value="33">Programming &amp; Scripting</option> <option value="30">Other Languages</option> <option value="47">Artwork and Screenshots</option> <option value="42">Try This</option> </optgroup> <optgroup label="/dev/null"> <option value="29">Off-Topic</option> <option value="48" selected="selected">Topics Going Nowhere</option> <option value="36">Dustbin</option> </optgroup> </select></label> <input type="submit" value=" Go " accesskey="g" /> </div> </form> </div> <div class="conr"> <p id="feedlinks"><span class="atom"><a href="extern.php?action=feed&amp;tid=162768&amp;type=atom">Atom topic feed</a></span></p> <p id="poweredby">Powered by <a href="http://fluxbb.org/">FluxBB</a></p> </div> <div class="clearer"></div> </div> </div> </div> </div> <div class="end-box"></div> </div> </body> </html>
