<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"> <html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en" dir="ltr"> <head> <meta http-equiv="Content-Type" content="text/html; charset=utf-8" /> <title>KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9 (Page 107) / Topics Going Nowhere / Arch Linux Forums</title> <link rel="stylesheet" type="text/css" href="style/ArchLinux.css" /> <link rel="canonical" href="viewtopic.php?id=162768&amp;p=107" title="Page 107" /> <link rel="prev" href="viewtopic.php?id=162768&amp;p=106" title="Page 106" /> <link rel="next" href="viewtopic.php?id=162768&amp;p=108" title="Page 108" /> <link rel="alternate" type="application/atom+xml" href="extern.php?action=feed&amp;tid=162768&amp;type=atom" title="Atom topic feed" /> <link rel="stylesheet" media="screen" href="style/ArchLinux/arch.css?v=3" /> <link rel="stylesheet" media="screen" href="style/ArchLinux/archnavbar.css?v=2" /> <link rel="shortcut icon" href="style/ArchLinux/favicon.ico" /> </head> <body> <div id="archnavbar" class="anb-forum"> <div id="archnavbarlogo"><h1><a href="http://www.archlinux.org/">Arch Linux</a></h1></div> <div id="archnavbarmenu"> <ul id="archnavbarlist"> <li id="anb-home"><a href="http://www.archlinux.org/">Home</a></li><li id="anb-packages"><a href="http://www.archlinux.org/packages/">Packages</a></li><li id="anb-forums" class="anb-selected"><a href="https://bbs.archlinux.org/">Forums</a></li><li id="anb-wiki"><a href="https://wiki.archlinux.org/">Wiki</a></li><li id="anb-bugs"><a href="https://bugs.archlinux.org/">Bugs</a></li><li id="anb-aur"><a href="https://aur.archlinux.org/">AUR</a></li><li id="anb-download"><a href="http://www.archlinux.org/download/">Download</a></li> </ul> </div> </div> <div id="punviewtopic" class="pun"> <div class="top-box"></div> <div class="punwrap"> <div id="brdheader" class="block"> <div class="box"> <div id="brdmenu" class="inbox"> <ul> <li id="navindex" class="isactive"><a href="index.php">Index</a></li> <li id="navuserlist"><a href="userlist.php">User list</a></li> <li id="navsearch"><a href="search.php">Search</a></li> <li id="navprofile"><a href="profile.php?id=80749">Profile</a></li> <li id="navlogout"><a href="login.php?action=out&amp;id=80749&amp;csrf_token=5c20501ec397bb45ef8ee8c84db232c8d8e421c6">Logout</a></li> </ul> </div> <div id="brdwelcome" class="inbox"> <ul class="conl"> <li><span>Logged in as <strong>SXX</strong></span></li> <li><span>Last visit: 2015-08-16 12:20:09</span></li> </ul> <ul class="conr"> <li><span>Topics: <a href="search.php?action=show_replies" title="Find topics you have posted to.">Posted</a> | <a href="search.php?action=show_new" title="Find topics with new posts since your last visit.">New</a> | <a href="search.php?action=show_recent" title="Find topics with recent posts.">Active</a> | <a href="search.php?action=show_unanswered" title="Find topics with no replies.">Unanswered</a></span></li> </ul> <div class="clearer"></div> </div> </div> </div> <div id="brdmain"> <div class="linkst"> <div class="inbox crumbsplus"> <ul class="crumbs"> <li><a href="index.php">Index</a></li> <li><span>»&#160;</span><a href="viewforum.php?id=48">Topics Going Nowhere</a></li> <li><span>»&#160;</span><strong><a href="viewtopic.php?id=162768">KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</a></strong></li> </ul> <div class="pagepost"> <p class="pagelink conl"><span class="pages-label">Pages: </span><a rel="prev" class="item1" href="viewtopic.php?id=162768&amp;p=106">Previous</a> <a href="viewtopic.php?id=162768">1</a> <span class="spacer">…</span> <a href="viewtopic.php?id=162768&amp;p=105">105</a> <a href="viewtopic.php?id=162768&amp;p=106">106</a> <strong>107</strong> <a href="viewtopic.php?id=162768&amp;p=108">108</a> <a href="viewtopic.php?id=162768&amp;p=109">109</a> <span class="spacer">…</span> <a href="viewtopic.php?id=162768&amp;p=234">234</a> <a rel="next" href="viewtopic.php?id=162768&amp;p=108">Next</a></p> <p class="postlink conr">Topic closed</p> </div> <div class="clearer"></div> </div> </div> <div id="p1453701" class="blockpost rowodd blockpost1"> <h2><span><span class="conr">#2651</span> <a href="viewtopic.php?pid=1453701#p1453701">2014-09-04 20:46:14</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=75590">aw</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2013-10-04</span></dd> <dd><span>Posts: 921</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=75590">Email</a></span> <span class="website"><a href="http://vfio.blogspot.com/" rel="nofollow">Website</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>gneville wrote:</cite><blockquote><div><p>I&#039;ve just ran the test from your website and I don&#039;t see the type 3, an EFI ROM. I&#039;m very surprised as to why not as this is a brand new card, UEFI is written on the box and stated on the website. </p><p>Thanks for the heads up with the re-install.</p><p>Edit: Just found there is a BIOS selection switch physically on the card! Will dismantle and switch to the other BIOS and test again.</p><p><a href="http://www.sapphiretech.com/presentation/product/product_index.aspx?cid=1&amp;gid=3&amp;sgid=1227&amp;pid=2091&amp;psn&amp;lid=1" rel="nofollow">http://www.sapphiretech.com/presentatio … &amp;psn&amp;lid=1</a></p><div class="codebox"><pre><code>[root@i7-4770s rom-parser]# ./rom-parser /root/r9-290.rom Valid ROM signature found @0h, PCIR offset 238h PCIR: type 0, vendor: 1002, device: 67b1, class: 030000 PCIR: revision 0, vendor revision: f2a Last image</code></pre></div></div></blockquote></div><p>That&#039;s disappointing.&#160; The MSI &quot;Gaming&quot; version updated in February seems to have an update with EFI support, try that if you dare.</p><p><a href="http://www.techpowerup.com/vgabios/index.php?architecture=ATI&amp;model=R9+290" rel="nofollow">http://www.techpowerup.com/vgabios/inde … del=R9+290</a></p><p>BTW, I pushed a tiny fix to rom-parser that makes it scan that one correctly, otherwise it gets lost with a bogus match.</p> </div> <div class="postsignature postmsg"><hr /><p><a href="http://vfio.blogspot.com" rel="nofollow">http://vfio.blogspot.com</a><br />Looking for a more open forum to discuss vfio related uses?&#160; Try <a href="https://www.redhat.com/mailman/listinfo/vfio-users" rel="nofollow">https://www.redhat.com/mailman/listinfo/vfio-users</a></p></div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1453701">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1453705" class="blockpost roweven"> <h2><span><span class="conr">#2652</span> <a href="viewtopic.php?pid=1453705#p1453705">2014-09-04 20:54:36</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=80830">gneville</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2014-04-02</span></dd> <dd><span>Posts: 27</span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <p>I found a physical switch on the card that I had to move over. I&#039;ve flicked it and booted back up again.</p><p>I now see the &quot;type 3&quot; <img src="https://bbs.archlinux.org/img/smilies/smile.png" width="15" height="15" alt="smile" /></p><div class="codebox"><pre><code>[root@i7-4770s rom-parser]# ./rom-parser /root/r9-290-uefi.rom Valid ROM signature found @0h, PCIR offset 238h PCIR: type 0, vendor: 1002, device: 67b1, class: 030000 PCIR: revision 0, vendor revision: f2a Valid ROM signature found @10000h, PCIR offset 1ch PCIR: type 3, vendor: 1002, device: 67b1, class: 030000 PCIR: revision 0, vendor revision: 0 EFI: Signature Valid Last image</code></pre></div><br /><p>The good news is, I now see a TianoCore BIOS screen via my HDMI port, so I can successfully passthrough my graphics card <img src="https://bbs.archlinux.org/img/smilies/smile.png" width="15" height="15" alt="smile" /></p><p>I&#039;ll install windows from fresh and see if everything works, then once confirmed it does, I&#039;ll be looking to move on to Kernel 3.17 without the i915 patches. </p><p>Fingers Crossed &amp; Thanks for the help!</p><br /><div class="quotebox"><cite>aw wrote:</cite><blockquote><div><p>That&#039;s disappointing.&#160; The MSI &quot;Gaming&quot; version updated in February seems to have an update with EFI support, try that if you dare.</p><p><a href="http://www.techpowerup.com/vgabios/index.php?architecture=ATI&amp;model=R9+290" rel="nofollow">http://www.techpowerup.com/vgabios/inde … del=R9+290</a></p><p>BTW, I pushed a tiny fix to rom-parser that makes it scan that one correctly, otherwise it gets lost with a bogus match.</p></div></blockquote></div> <p class="postedit"><em>Last edited by gneville (2014-09-04 21:03:37)</em></p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1453705">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1453709" class="blockpost rowodd"> <h2><span><span class="conr">#2653</span> <a href="viewtopic.php?pid=1453709#p1453709">2014-09-04 21:24:38</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=75590">aw</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2013-10-04</span></dd> <dd><span>Posts: 921</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=75590">Email</a></span> <span class="website"><a href="http://vfio.blogspot.com/" rel="nofollow">Website</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>gneville wrote:</cite><blockquote><div><p>I found a physical switch on the card that I had to move over. I&#039;ve flicked it and booted back up again.</p><p>I now see the &quot;type 3&quot; <img src="https://bbs.archlinux.org/img/smilies/smile.png" width="15" height="15" alt="smile" /></p><div class="codebox"><pre><code>[root@i7-4770s rom-parser]# ./rom-parser /root/r9-290-uefi.rom Valid ROM signature found @0h, PCIR offset 238h PCIR: type 0, vendor: 1002, device: 67b1, class: 030000 PCIR: revision 0, vendor revision: f2a Valid ROM signature found @10000h, PCIR offset 1ch PCIR: type 3, vendor: 1002, device: 67b1, class: 030000 PCIR: revision 0, vendor revision: 0 EFI: Signature Valid Last image</code></pre></div></div></blockquote></div><p>Very strange, but I&#039;m glad you found it.&#160; The web seems to indicate the switch is for &quot;quiet&quot; or &quot;uber&quot; mode.&#160; Any idea if it&#039;s just the &quot;uber&quot; mode that doesn&#039;t support EFI?&#160; Which is default?</p><div class="quotebox"><blockquote><div><p>The good news is, I now see a TianoCore BIOS screen via my HDMI port, so I can successfully passthrough my graphics card <img src="https://bbs.archlinux.org/img/smilies/smile.png" width="15" height="15" alt="smile" /></p><p>I&#039;ll install windows from fresh and see if everything works, then once confirmed it does, I&#039;ll be looking to move on to Kernel 3.17 without the i915 patches.</p></div></blockquote></div><p>Good luck</p> </div> <div class="postsignature postmsg"><hr /><p><a href="http://vfio.blogspot.com" rel="nofollow">http://vfio.blogspot.com</a><br />Looking for a more open forum to discuss vfio related uses?&#160; Try <a href="https://www.redhat.com/mailman/listinfo/vfio-users" rel="nofollow">https://www.redhat.com/mailman/listinfo/vfio-users</a></p></div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1453709">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1453711" class="blockpost roweven"> <h2><span><span class="conr">#2654</span> <a href="viewtopic.php?pid=1453711#p1453711">2014-09-04 21:34:21</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=84905">zsph</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2014-09-04</span></dd> <dd><span>Posts: 9</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=84905">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <p>Hello. I&#039;m desperadly looking for help. I have a typical problem, that seem to happed to many people in this thread. Unfortunately I cannot overcome it. I don&#039;t see any seabios output on the screen attached to the card.</p><p>My hardware:<br />MB: Asus P8Z77-V LK, firmware 1402<br />CPU: Core i7 3770 (not the one with K)<br />GPU: Asus NVIDIA GTX 770 DirectCU II OC (inserted in the most top pci-e slot)</p><p>Software:<br />Debian Testing (don&#039;t kick me please)<br />3.16 Kernel with &quot;acs override&quot; &amp; &quot;i915 vga arbiter&quot; &amp; &quot;vga arbitrer&quot; patches<br />qemu: latest master from git://git.qemu.org/qemu.git<br />seabios: latest master from git://git.seabios.org/seabios.git</p><p>kernel config:</p><div class="codebox"><pre><code>CONFIG_VFIO_IOMMU_TYPE1=y CONFIG_VFIO=y CONFIG_VFIO_PCI=y CONFIG_VFIO_PCI_VGA=y CONFIG_INTEL_IOMMU=y CONFIG_INTEL_IOMMU_DEFAULT_ON=y</code></pre></div><p>Boot args (I tried all possible combinations):</p><div class="codebox"><pre><code>intel_iommu=on i915.enable_hd_vgaarb=1 pcie_acs_override=downstream vfio_iommu_type1.allow_unsafe_interrupts=1 pci-stub.ids=10de:1184,10de:0e0a</code></pre></div><div class="codebox"><pre><code>cat /etc/modprobe.d/blacklist.conf blacklist nouveau blacklist nvidia blacklist i915</code></pre></div><p>I previously didn&#039;t have i915 blacklisted, no effect. I use nouveau driver, so I don&#039;t have nvidia binary installed, but I blacklist it anyway. I&#039;m just really trying everything.</p><div class="codebox"><pre><code>lspci -nn | grep NVIDIA 01:00.0 VGA compatible controller [0300]: NVIDIA Corporation GK104 [GeForce GTX 770] [10de:1184] (rev a1) 01:00.1 Audio device [0403]: NVIDIA Corporation GK104 HDMI Audio Controller [10de:0e0a] (rev a1)</code></pre></div><p>I set my intel GPU as primary in bios. I can successfully bind NVIDIA using the script in the first post:</p><div class="codebox"><pre><code>sudo /usr/bin/vfio-bind 0000:01:00.0 0000:01:00.1</code></pre></div><p>This looks ok:</p><div class="codebox"><pre><code>ls -l /sys/bus/pci/drivers/vfio-pci/ total 0 lrwxrwxrwx 1 root root 0 Sep 5 00:09 0000:01:00.0 -&gt; ../../../../devices/pci0000:00/0000:00:01.0/0000:01:00.0 lrwxrwxrwx 1 root root 0 Sep 5 00:09 0000:01:00.1 -&gt; ../../../../devices/pci0000:00/0000:00:01.0/0000:01:00.1 --w------- 1 root root 4096 Sep 5 00:09 bind lrwxrwxrwx 1 root root 0 Sep 5 00:09 module -&gt; ../../../../module/vfio_pci --w------- 1 root root 4096 Sep 4 23:31 new_id --w------- 1 root root 4096 Sep 5 00:09 remove_id --w------- 1 root root 4096 Sep 4 23:31 uevent --w------- 1 root root 4096 Sep 5 00:09 unbind</code></pre></div><p>No errors here:</p><div class="codebox"><pre class="vscroll"><code>dmesg |dmesg | grep -i -e pci-stub -e vfio -e iommu -e dmar # (some lines skipped) [ 0.000000] Intel-IOMMU: enabled [ 0.079612] dmar: Host address width 36 [ 0.079614] dmar: DRHD base: 0x000000fed90000 flags: 0x0 [ 0.079621] dmar: IOMMU 0: reg_base_addr fed90000 ver 1:0 cap c0000020e60262 ecap f0101a [ 0.079622] dmar: DRHD base: 0x000000fed91000 flags: 0x1 [ 0.079625] dmar: IOMMU 1: reg_base_addr fed91000 ver 1:0 cap c9008020660262 ecap f0105a [ 0.079626] dmar: RMRR base: 0x000000bc5b3000 end: 0x000000bc5c4fff [ 0.079627] dmar: RMRR base: 0x000000bf000000 end: 0x000000cf1fffff [ 0.079697] IOAPIC id 2 under DRHD base 0xfed91000 IOMMU 1 [ 0.560480] DMAR: No ATSR found [ 0.560500] IOMMU 0 0xfed90000: using Queued invalidation [ 0.560500] IOMMU 1 0xfed91000: using Queued invalidation [ 0.560501] IOMMU: Setting RMRR: [ 0.560510] IOMMU: Setting identity map for device 0000:00:02.0 [0xbf000000 - 0xcf1fffff] [ 0.561572] IOMMU: Setting identity map for device 0000:00:14.0 [0xbc5b3000 - 0xbc5c4fff] [ 0.561587] IOMMU: Setting identity map for device 0000:00:1a.0 [0xbc5b3000 - 0xbc5c4fff] [ 0.561600] IOMMU: Setting identity map for device 0000:00:1d.0 [0xbc5b3000 - 0xbc5c4fff] [ 0.561608] IOMMU: Prepare 0-16MiB unity mapping for LPC [ 0.561613] IOMMU: Setting identity map for device 0000:00:1f.0 [0x0 - 0xffffff] [ 0.561786] CPU: 0 PID: 1 Comm: swapper/0 Not tainted 3.16.0-vfio-ally #1 [ 0.561801] [&lt;ffffffff813e50b6&gt;] ? intel_iommu_add_device+0x36/0x200 [ 0.561803] [&lt;ffffffff813da240&gt;] ? bus_set_iommu+0x50/0x50 [ 0.561805] [&lt;ffffffff813da260&gt;] ? add_iommu_group+0x20/0x50 [ 0.561808] [&lt;ffffffff813da22e&gt;] ? bus_set_iommu+0x3e/0x50 [ 0.561811] [&lt;ffffffff8192ac05&gt;] ? intel_iommu_init+0x4fe/0x582 [ 0.561814] [&lt;ffffffff818ec7de&gt;] ? pci_iommu_init+0xe/0x37 [ 0.588450] VFIO - User Level meta-driver version: 0.3 [ 8.299028] pci-stub: add 10DE:1184 sub=FFFFFFFF:FFFFFFFF cls=00000000/00000000 [ 8.299042] pci-stub 0000:01:00.0: claimed by stub [ 8.299049] pci-stub: add 10DE:0E0A sub=FFFFFFFF:FFFFFFFF cls=00000000/00000000 [ 8.299149] vboxpci: IOMMU found [ 8.392654] [drm] DMAR active, disabling use of stolen memory</code></pre></div><p>Then I run qemu as</p><div class="codebox"><pre><code>sudo ~/qemu.git/x86_64-softmmu/qemu-system-x86_64 \ -enable-kvm \ -M q35 \ -m 1024 \ -cpu host \ -smp 1,sockets=1,cores=1,threads=1 \ -bios ~/seabios.git/out/bios.bin \ -L ~/seabios.git/out/ -L ~/seabios.git/out/bios.bin \ -vga none \ -device ioh3420,bus=pcie.0,addr=1c.0,multifunction=on,port=1,chassis=1,id=root.1 \ -device vfio-pci,host=01:00.0,bus=root.1,addr=00.0,multifunction=on,x-vga=on \ -device vfio-pci,host=01:00.1,bus=root.1,addr=00.1</code></pre></div><p>I see SDL qemu window but no signal on HDMI or DVI output of NVIDIA. I can still see these messages in dmesg when starting qemu:</p><div class="codebox"><pre><code>[ 44.915488] vfio_ecap_init: 0000:01:00.0 hiding ecap 0x19@0x900 [ 71.971217] vfio_ecap_init: 0000:01:00.0 hiding ecap 0x19@0x900 [ 495.033377] vfio_ecap_init: 0000:01:00.0 hiding ecap 0x19@0x900</code></pre></div><p>I googled, read mail lists but nothing helpfull. This is SOS, please help.</p> </div> <div class="postsignature postmsg"><hr /><p>Asus P8Z77-V LK, Core i7 3770, Asus NVIDIA GTX 770 DirectCU II OC, Debian x64, EFI, Kernel 3.16 + i915 arbiter patch. <br />3DMark11: bare metal <a href="http://www.3dmark.com/3dm11/8748717" rel="nofollow">P10231</a> vs vfio <a href="http://www.3dmark.com/3dm11/8754453" rel="nofollow">P10039</a>: 98% of performance!</p></div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1453711">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1453715" class="blockpost rowodd"> <h2><span><span class="conr">#2655</span> <a href="viewtopic.php?pid=1453715#p1453715">2014-09-04 21:48:07</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=81745">siddharta</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2014-05-03</span></dd> <dd><span>Posts: 30</span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>zsph wrote:</cite><blockquote><div><p>Hello. I&#039;m desperadly looking for help. I have a typical problem, that seem to happed to many people in this thread. Unfortunately I cannot overcome it. I don&#039;t see any seabios output on the screen attached to the card.</p><p>My hardware:<br />MB: Asus P8Z77-V LK, firmware 1402<br />CPU: Core i7 3770 (not the one with K)<br />GPU: Asus NVIDIA GTX 770 DirectCU II OC (inserted in the most top pci-e slot)</p><p>Software:<br />Debian Testing (don&#039;t kick me please)<br />3.16 Kernel with &quot;acs override&quot; &amp; &quot;i915 vga arbiter&quot; &amp; &quot;vga arbitrer&quot; patches<br />qemu: latest master from git://git.qemu.org/qemu.git<br />seabios: latest master from git://git.seabios.org/seabios.git</p><p>kernel config:</p><div class="codebox"><pre><code>CONFIG_VFIO_IOMMU_TYPE1=y CONFIG_VFIO=y CONFIG_VFIO_PCI=y CONFIG_VFIO_PCI_VGA=y CONFIG_INTEL_IOMMU=y CONFIG_INTEL_IOMMU_DEFAULT_ON=y</code></pre></div><p>Boot args (I tried all possible combinations):</p><div class="codebox"><pre><code>intel_iommu=on i915.enable_hd_vgaarb=1 pcie_acs_override=downstream vfio_iommu_type1.allow_unsafe_interrupts=1 pci-stub.ids=10de:1184,10de:0e0a</code></pre></div><div class="codebox"><pre><code>cat /etc/modprobe.d/blacklist.conf blacklist nouveau blacklist nvidia blacklist i915</code></pre></div><p>I previously didn&#039;t have i915 blacklisted, no effect. I use nouveau driver, so I don&#039;t have nvidia binary installed, but I blacklist it anyway. I&#039;m just really trying everything.</p><div class="codebox"><pre><code>lspci -nn | grep NVIDIA 01:00.0 VGA compatible controller [0300]: NVIDIA Corporation GK104 [GeForce GTX 770] [10de:1184] (rev a1) 01:00.1 Audio device [0403]: NVIDIA Corporation GK104 HDMI Audio Controller [10de:0e0a] (rev a1)</code></pre></div><p>I set my intel GPU as primary in bios. I can successfully bind NVIDIA using the script in the first post:</p><div class="codebox"><pre><code>sudo /usr/bin/vfio-bind 0000:01:00.0 0000:01:00.1</code></pre></div><p>This looks ok:</p><div class="codebox"><pre><code>ls -l /sys/bus/pci/drivers/vfio-pci/ total 0 lrwxrwxrwx 1 root root 0 Sep 5 00:09 0000:01:00.0 -&gt; ../../../../devices/pci0000:00/0000:00:01.0/0000:01:00.0 lrwxrwxrwx 1 root root 0 Sep 5 00:09 0000:01:00.1 -&gt; ../../../../devices/pci0000:00/0000:00:01.0/0000:01:00.1 --w------- 1 root root 4096 Sep 5 00:09 bind lrwxrwxrwx 1 root root 0 Sep 5 00:09 module -&gt; ../../../../module/vfio_pci --w------- 1 root root 4096 Sep 4 23:31 new_id --w------- 1 root root 4096 Sep 5 00:09 remove_id --w------- 1 root root 4096 Sep 4 23:31 uevent --w------- 1 root root 4096 Sep 5 00:09 unbind</code></pre></div><p>No errors here:</p><div class="codebox"><pre class="vscroll"><code>dmesg |dmesg | grep -i -e pci-stub -e vfio -e iommu -e dmar # (some lines skipped) [ 0.000000] Intel-IOMMU: enabled [ 0.079612] dmar: Host address width 36 [ 0.079614] dmar: DRHD base: 0x000000fed90000 flags: 0x0 [ 0.079621] dmar: IOMMU 0: reg_base_addr fed90000 ver 1:0 cap c0000020e60262 ecap f0101a [ 0.079622] dmar: DRHD base: 0x000000fed91000 flags: 0x1 [ 0.079625] dmar: IOMMU 1: reg_base_addr fed91000 ver 1:0 cap c9008020660262 ecap f0105a [ 0.079626] dmar: RMRR base: 0x000000bc5b3000 end: 0x000000bc5c4fff [ 0.079627] dmar: RMRR base: 0x000000bf000000 end: 0x000000cf1fffff [ 0.079697] IOAPIC id 2 under DRHD base 0xfed91000 IOMMU 1 [ 0.560480] DMAR: No ATSR found [ 0.560500] IOMMU 0 0xfed90000: using Queued invalidation [ 0.560500] IOMMU 1 0xfed91000: using Queued invalidation [ 0.560501] IOMMU: Setting RMRR: [ 0.560510] IOMMU: Setting identity map for device 0000:00:02.0 [0xbf000000 - 0xcf1fffff] [ 0.561572] IOMMU: Setting identity map for device 0000:00:14.0 [0xbc5b3000 - 0xbc5c4fff] [ 0.561587] IOMMU: Setting identity map for device 0000:00:1a.0 [0xbc5b3000 - 0xbc5c4fff] [ 0.561600] IOMMU: Setting identity map for device 0000:00:1d.0 [0xbc5b3000 - 0xbc5c4fff] [ 0.561608] IOMMU: Prepare 0-16MiB unity mapping for LPC [ 0.561613] IOMMU: Setting identity map for device 0000:00:1f.0 [0x0 - 0xffffff] [ 0.561786] CPU: 0 PID: 1 Comm: swapper/0 Not tainted 3.16.0-vfio-ally #1 [ 0.561801] [&lt;ffffffff813e50b6&gt;] ? intel_iommu_add_device+0x36/0x200 [ 0.561803] [&lt;ffffffff813da240&gt;] ? bus_set_iommu+0x50/0x50 [ 0.561805] [&lt;ffffffff813da260&gt;] ? add_iommu_group+0x20/0x50 [ 0.561808] [&lt;ffffffff813da22e&gt;] ? bus_set_iommu+0x3e/0x50 [ 0.561811] [&lt;ffffffff8192ac05&gt;] ? intel_iommu_init+0x4fe/0x582 [ 0.561814] [&lt;ffffffff818ec7de&gt;] ? pci_iommu_init+0xe/0x37 [ 0.588450] VFIO - User Level meta-driver version: 0.3 [ 8.299028] pci-stub: add 10DE:1184 sub=FFFFFFFF:FFFFFFFF cls=00000000/00000000 [ 8.299042] pci-stub 0000:01:00.0: claimed by stub [ 8.299049] pci-stub: add 10DE:0E0A sub=FFFFFFFF:FFFFFFFF cls=00000000/00000000 [ 8.299149] vboxpci: IOMMU found [ 8.392654] [drm] DMAR active, disabling use of stolen memory</code></pre></div><p>Then I run qemu as</p><div class="codebox"><pre><code>sudo ~/qemu.git/x86_64-softmmu/qemu-system-x86_64 \ -enable-kvm \ -M q35 \ -m 1024 \ -cpu host \ -smp 1,sockets=1,cores=1,threads=1 \ -bios ~/seabios.git/out/bios.bin \ -L ~/seabios.git/out/ -L ~/seabios.git/out/bios.bin \ -vga none \ -device ioh3420,bus=pcie.0,addr=1c.0,multifunction=on,port=1,chassis=1,id=root.1 \ -device vfio-pci,host=01:00.0,bus=root.1,addr=00.0,multifunction=on,x-vga=on \ -device vfio-pci,host=01:00.1,bus=root.1,addr=00.1</code></pre></div><p>I see SDL qemu window but no signal on HDMI or DVI output of NVIDIA. I can still see these messages in dmesg when starting qemu:</p><div class="codebox"><pre><code>[ 44.915488] vfio_ecap_init: 0000:01:00.0 hiding ecap 0x19@0x900 [ 71.971217] vfio_ecap_init: 0000:01:00.0 hiding ecap 0x19@0x900 [ 495.033377] vfio_ecap_init: 0000:01:00.0 hiding ecap 0x19@0x900</code></pre></div><p>I googled, read mail lists but nothing helpfull. This is SOS, please help.</p></div></blockquote></div><p>This would probably not be the root cause of your issue, but i915 shouldn&#039;t have to be blacklisted, you probably don&#039;t need allow_unsafe_interrupts=1 nor the other VGA arbiter patch, only the i915 vgaarb patch. Have a look at aw&#039;s blog <a href="http://vfio.blogspot.com" rel="nofollow">vfio.blogspot.com</a> in the FAQ post.<br />edit: also, depending on your exact situation, your video card may already be in its own VFIO group. If that&#039;s the case and you&#039;re not passing other devices that are co-habiting a VFIO group with other devices that you don&#039;t want to pass to the guest then you don&#039;t need the ACS override patch either. You can search this thread for a script called lsgroups.sh that presents this nicely.</p> <p class="postedit"><em>Last edited by siddharta (2014-09-04 21:51:32)</em></p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1453715">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1453718" class="blockpost roweven"> <h2><span><span class="conr">#2656</span> <a href="viewtopic.php?pid=1453718#p1453718">2014-09-04 22:12:39</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=80830">gneville</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2014-04-02</span></dd> <dd><span>Posts: 27</span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <p>It just seems on the Sapphire Radeon R9 290 that the Default BIOS is legacy and the other switch is for UEFI. Don&#039;t think there is a quiet and uber mode on this card.</p><p><a href="http://www.hardwareluxx.com/index.php/reviews/hardware/vgacards/29541-test-sapphire-radeon-r9-290x-tri-x-oc.html" rel="nofollow">http://www.hardwareluxx.com/index.php/r … -x-oc.html</a></p><div class="quotebox"><cite>aw wrote:</cite><blockquote><div><p>Very strange, but I&#039;m glad you found it.&#160; The web seems to indicate the switch is for &quot;quiet&quot; or &quot;uber&quot; mode.&#160; Any idea if it&#039;s just the &quot;uber&quot; mode that doesn&#039;t support EFI?&#160; Which is default?</p></div></blockquote></div> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1453718">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1453728" class="blockpost rowodd"> <h2><span><span class="conr">#2657</span> <a href="viewtopic.php?pid=1453728#p1453728">2014-09-04 23:01:44</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=81745">siddharta</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2014-05-03</span></dd> <dd><span>Posts: 30</span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <p>Interestingly enough, after installing closed source nvidia drivers in the guest instead of nouveau, the host no longer hangs on guest reboot, nor do I have the same behaviour after shutdown and restart of the guest (QEMU throwing &quot;invalid rom contents&quot; error followed by the host locking up unless QEMU is terminated). The guest doesn&#039;t seem to come back up properly after a reboot or shutdown, however I can&#039;t see what is going on now (connected to the host over SSH) so I&#039;ll see that tomorrow. The guest doesn&#039;t respond but doesn&#039; crash the host either which is a step in the right direction, dmesg doesn&#039;t list any errors/warnings either. There are slight differences&#160; between the nouveau and nvidia proprietary drivers in the </p><div class="codebox"><pre><code>lspci -vvv -s 02:00.0</code></pre></div><p> output taken after shutting down the guest, I can post them if it would be of interest. </p><p>I actually had a similar experience with an AMD 5450 card - host hanging after reboot with the radeon open source drivers installed in the guest, but working fine with the closed source fglrx drivers on the guest. </p><p>As to swapping the card around physically to see whether the ACS override is required, I have another (physically) x16 slot but it&#039;s not possible to install the nvidia card there due to the size of the heatsink on the card. Thanks. </p><p>edit: removed quote</p> <p class="postedit"><em>Last edited by siddharta (2014-09-04 23:02:50)</em></p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1453728">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1453731" class="blockpost roweven"> <h2><span><span class="conr">#2658</span> <a href="viewtopic.php?pid=1453731#p1453731">2014-09-04 23:25:47</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=84905">zsph</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2014-09-04</span></dd> <dd><span>Posts: 9</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=84905">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <p>Thank you for prompt reply.</p><div class="quotebox"><cite>siddharta wrote:</cite><blockquote><div><p>This would probably not be the root cause of your issue, but i915 shouldn&#039;t have to be blacklisted, you probably don&#039;t need allow_unsafe_interrupts=1 nor the other VGA arbiter patch, only the i915 vgaarb patch. Have a look at aw&#039;s blog <a href="http://vfio.blogspot.com" rel="nofollow">vfio.blogspot.com</a> in the FAQ post.</p><p>edit: also, depending on your exact situation, your video card may already be in its own VFIO group. If that&#039;s the case and you&#039;re not passing other devices that are co-habiting a VFIO group with other devices that you don&#039;t want to pass to the guest then you don&#039;t need the ACS override patch either. You can search this thread for a script called lsgroups.sh that presents this nicely.</p></div></blockquote></div><p>I found the script, the card is the only member in its group:</p><div class="codebox"><pre><code>### Group 13 ### 01:00.0 VGA compatible controller: NVIDIA Corporation GK104 [GeForce GTX 770] (rev a1) 01:00.1 Audio device: NVIDIA Corporation GK104 HDMI Audio Controller (rev a1)</code></pre></div><p>Is there a chance that without unnecessary patches and boot args the outcome can be different? I will certainly try, it just takes hours to rebuild <img src="https://bbs.archlinux.org/img/smilies/smile.png" width="15" height="15" alt="smile" /></p> </div> <div class="postsignature postmsg"><hr /><p>Asus P8Z77-V LK, Core i7 3770, Asus NVIDIA GTX 770 DirectCU II OC, Debian x64, EFI, Kernel 3.16 + i915 arbiter patch. <br />3DMark11: bare metal <a href="http://www.3dmark.com/3dm11/8748717" rel="nofollow">P10231</a> vs vfio <a href="http://www.3dmark.com/3dm11/8754453" rel="nofollow">P10039</a>: 98% of performance!</p></div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1453731">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1453736" class="blockpost rowodd"> <h2><span><span class="conr">#2659</span> <a href="viewtopic.php?pid=1453736#p1453736">2014-09-04 23:48:17</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=81745">siddharta</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2014-05-03</span></dd> <dd><span>Posts: 30</span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>zsph wrote:</cite><blockquote><div><p>Is there a chance that without unnecessary patches and boot args the outcome can be different? I will certainly try, it just takes hours to rebuild <img src="https://bbs.archlinux.org/img/smilies/smile.png" width="15" height="15" alt="smile" /></p></div></blockquote></div><p>You can remove the allow unsafe interrupts and acs override boot parameters (this will disable the acs override patch) but to remove the non-i915 VGA arbiter patch you&#039;ll need to rebuild the kernel, unless there is a parameter to disable it (look at the patch notes, I&#039;m not sure). The first two will likely not improve matters but removing the non-i915 VGA arbiter patch could possibly solve your issue, I&#039;m not certain though. Do keep the i915 vgaarb patch and the corresponding boot parameter, that one is not optional if using Intel igfx on the host on kernel below 3.17.</p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1453736">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1453739" class="blockpost roweven"> <h2><span><span class="conr">#2660</span> <a href="viewtopic.php?pid=1453739#p1453739">2014-09-04 23:56:39</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=80830">gneville</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2014-04-02</span></dd> <dd><span>Posts: 27</span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <p>aw, everything is looking good for UEFI booting. The only thing I can&#039;t do is restart the Windows8 Guest, this just causes a booting loop, but this was similar to before whereby I have to apply the fixes found in this blog - <a href="http://blog.ktz.me/?p=219" rel="nofollow">http://blog.ktz.me/?p=219</a></p><p>I&#039;ve moved up to Linux 3.17 RC3 Kernel and removed the &quot;i915.enable_hd_vgaarb=1&quot;</p><p>My prompt is now:</p><div class="codebox"><pre><code>intel_iommu=on vfio_iommu_type1.allow_unsafe_interrupts=1 pci-stub.ids=1002:67b1,1002:aac8 quiet</code></pre></div><p>I successfully have my Intel chipset outputting XBMC whilst my AMD R9 290 is outputting Windows. <img src="https://bbs.archlinux.org/img/smilies/smile.png" width="15" height="15" alt="smile" /></p><br /><div class="quotebox"><cite>gneville wrote:</cite><blockquote><div><p>It just seems on the Sapphire Radeon R9 290 that the Default BIOS is legacy and the other switch is for UEFI. Don&#039;t think there is a quiet and uber mode on this card.</p><p><a href="http://www.hardwareluxx.com/index.php/reviews/hardware/vgacards/29541-test-sapphire-radeon-r9-290x-tri-x-oc.html" rel="nofollow">http://www.hardwareluxx.com/index.php/r … -x-oc.html</a></p><div class="quotebox"><cite>aw wrote:</cite><blockquote><div><p>Very strange, but I&#039;m glad you found it.&#160; The web seems to indicate the switch is for &quot;quiet&quot; or &quot;uber&quot; mode.&#160; Any idea if it&#039;s just the &quot;uber&quot; mode that doesn&#039;t support EFI?&#160; Which is default?</p></div></blockquote></div></div></blockquote></div> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1453739">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1453741" class="blockpost rowodd"> <h2><span><span class="conr">#2661</span> <a href="viewtopic.php?pid=1453741#p1453741">2014-09-05 00:05:57</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=75590">aw</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2013-10-04</span></dd> <dd><span>Posts: 921</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=75590">Email</a></span> <span class="website"><a href="http://vfio.blogspot.com/" rel="nofollow">Website</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>siddharta wrote:</cite><blockquote><div><div class="quotebox"><cite>zsph wrote:</cite><blockquote><div><p>Is there a chance that without unnecessary patches and boot args the outcome can be different? I will certainly try, it just takes hours to rebuild <img src="https://bbs.archlinux.org/img/smilies/smile.png" width="15" height="15" alt="smile" /></p></div></blockquote></div><p>You can remove the allow unsafe interrupts and acs override boot parameters (this will disable the acs override patch) but to remove the non-i915 VGA arbiter patch you&#039;ll need to rebuild the kernel, unless there is a parameter to disable it (look at the patch notes, I&#039;m not sure). The first two will likely not improve matters but removing the non-i915 VGA arbiter patch could possibly solve your issue, I&#039;m not certain though. Do keep the i915 vgaarb patch and the corresponding boot parameter, that one is not optional if using Intel igfx on the host on kernel below 3.17.</p></div></blockquote></div><p>I sure hope that removing the <em>other</em> VGA arbiter patch doesn&#039;t make a difference, that&#039;s upstream now.&#160; IIRC, you do need to not blacklist i915 if you&#039;re using VGA-mode assignment.&#160; We need the i915 driver to participate in arbitration and it likely does make a difference.&#160; The ACS override patch shouldn&#039;t matter if it&#039;s not enabled.</p> </div> <div class="postsignature postmsg"><hr /><p><a href="http://vfio.blogspot.com" rel="nofollow">http://vfio.blogspot.com</a><br />Looking for a more open forum to discuss vfio related uses?&#160; Try <a href="https://www.redhat.com/mailman/listinfo/vfio-users" rel="nofollow">https://www.redhat.com/mailman/listinfo/vfio-users</a></p></div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1453741">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1453742" class="blockpost roweven"> <h2><span><span class="conr">#2662</span> <a href="viewtopic.php?pid=1453742#p1453742">2014-09-05 00:08:53</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=75590">aw</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2013-10-04</span></dd> <dd><span>Posts: 921</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=75590">Email</a></span> <span class="website"><a href="http://vfio.blogspot.com/" rel="nofollow">Website</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>gneville wrote:</cite><blockquote><div><p>aw, everything is looking good for UEFI booting. The only thing I can&#039;t do is restart the Windows8 Guest, this just causes a booting loop, but this was similar to before whereby I have to apply the fixes found in this blog - <a href="http://blog.ktz.me/?p=219" rel="nofollow">http://blog.ktz.me/?p=219</a></p></div></blockquote></div><p>Is it really a boot loop or is it a ~1min delay in rebooting?&#160; (see the Aug 28th update on the blog)</p><div class="quotebox"><blockquote><div><p>I&#039;ve moved up to Linux 3.17 RC3 Kernel and removed the &quot;i915.enable_hd_vgaarb=1&quot;</p><p>My prompt is now:</p><div class="codebox"><pre><code>intel_iommu=on vfio_iommu_type1.allow_unsafe_interrupts=1 pci-stub.ids=1002:67b1,1002:aac8 quiet</code></pre></div><p>I successfully have my Intel chipset outputting XBMC whilst my AMD R9 290 is outputting Windows. <img src="https://bbs.archlinux.org/img/smilies/smile.png" width="15" height="15" alt="smile" /></p></div></blockquote></div><p>Great, another satisfied OVMF customer <img src="https://bbs.archlinux.org/img/smilies/wink.png" width="15" height="15" alt="wink" /></p> </div> <div class="postsignature postmsg"><hr /><p><a href="http://vfio.blogspot.com" rel="nofollow">http://vfio.blogspot.com</a><br />Looking for a more open forum to discuss vfio related uses?&#160; Try <a href="https://www.redhat.com/mailman/listinfo/vfio-users" rel="nofollow">https://www.redhat.com/mailman/listinfo/vfio-users</a></p></div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1453742">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1453772" class="blockpost rowodd"> <h2><span><span class="conr">#2663</span> <a href="viewtopic.php?pid=1453772#p1453772">2014-09-05 03:58:56</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=84850">mdx</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2014-09-02</span></dd> <dd><span>Posts: 1</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=84850">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <p>Hi all,</p><p>After finally getting my Win7 guest up and running, I&#039;m not able to install Windows updates without breaking the guest OS.</p><p>I&#039;ve done this a few times, without any anti-virus software and the result has been the same:<br />1. Install Win7 (latest attempt using X17-24209.iso), install latest virtio network driver from Redhat and reboot several times: OK<br />2. Install critical updates using Windows Update and reboot: Guest boots in &quot;Startup Repair&quot; mode, sometimes several times in a loop but is unable to repair --&gt; OS bricked</p><p>I&#039;m using qemu-git from aur.<br />Has anyone experienced this issue?</p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1453772">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1453815" class="blockpost roweven"> <h2><span><span class="conr">#2664</span> <a href="viewtopic.php?pid=1453815#p1453815">2014-09-05 08:07:36</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=84881">friedcpu</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2014-09-03</span></dd> <dd><span>Posts: 3</span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <p>This is really driving me crazy, there must be a way to passthrough your primary PCI device (slot 1) without onboard graphics (X79) and use the host as headless</p><p>My details are in post <a href="https://bbs.archlinux.org/viewtopic.php?pid=1453417#p1453417" rel="nofollow">#2638 on page 106.</a></p><p>Has anyone successfully done this? I have recently found in dmesg this</p><div class="codebox"><pre><code>pci 0000:01:00.0: Boot video device</code></pre></div><p>even after disabling the framebuffer, could this be whats causing it?</p><p>thank you<br />FriedCPU</p> <p class="postedit"><em>Last edited by friedcpu (2014-09-05 08:10:33)</em></p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1453815">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1453823" class="blockpost rowodd"> <h2><span><span class="conr">#2665</span> <a href="viewtopic.php?pid=1453823#p1453823">2014-09-05 09:06:09</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=80830">gneville</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2014-04-02</span></dd> <dd><span>Posts: 27</span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <p>I&#039;m using qemu from git that I pulled down on 29th Aug.</p><p>qemu:&#160; 2.1.50 (git-290814)<br />libvirt:&#160; &#160;1.2.9 (git-290814)<br />Kernel: 3.17.0-1-mainline (RC3)<br />bios:&#160; &#160; OVMF TianoCore (svn 16059)<br />Kernel Boot params:</p><div class="codebox"><pre><code>intel_iommu=on pci-stub.ids=1002:67b1,1002:aac8 quiet</code></pre></div><p>After rebooting the machine comes up with the windows splash screen whilst booting and then reboots so I see the Tianocore BIOS screen again. Windows then goes in to it&#039;s recovery screen.</p><p>I have applied this patch to my qemu: <a href="https://lists.gnu.org/archive/html/qemu-devel/2014-02/msg00767.html" rel="nofollow">https://lists.gnu.org/archive/html/qemu … 00767.html</a> as it helped out before in other areas, maybe I shouldn&#039;t have?</p><div class="quotebox"><cite>aw wrote:</cite><blockquote><div><p>Is it really a boot loop or is it a ~1min delay in rebooting?&#160; (see the Aug 28th update on the blog)</p></div></blockquote></div> <p class="postedit"><em>Last edited by gneville (2014-09-05 09:35:40)</em></p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1453823">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1453864" class="blockpost roweven"> <h2><span><span class="conr">#2666</span> <a href="viewtopic.php?pid=1453864#p1453864">2014-09-05 11:40:15</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=84905">zsph</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2014-09-04</span></dd> <dd><span>Posts: 9</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=84905">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <p>OMG now I see seabios on HDMI output, what a relief! Thank you guys so much.</p><p>Now I use i915 vga arbiter patch only and reduced boot args to:</p><div class="codebox"><pre><code>GRUB_CMDLINE_LINUX_DEFAULT=&quot;quiet intel_iommu=on i915.enable_hd_vgaarb=1 pci-stub.ids=10de:1184,10de:0e0a&quot;</code></pre></div><p>and I removed i915 from blacklist.</p><p>It&#039;s time to install Windows.</p> <p class="postedit"><em>Last edited by zsph (2014-09-05 11:50:44)</em></p> </div> <div class="postsignature postmsg"><hr /><p>Asus P8Z77-V LK, Core i7 3770, Asus NVIDIA GTX 770 DirectCU II OC, Debian x64, EFI, Kernel 3.16 + i915 arbiter patch. <br />3DMark11: bare metal <a href="http://www.3dmark.com/3dm11/8748717" rel="nofollow">P10231</a> vs vfio <a href="http://www.3dmark.com/3dm11/8754453" rel="nofollow">P10039</a>: 98% of performance!</p></div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1453864">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1454075" class="blockpost rowodd"> <h2><span><span class="conr">#2667</span> <a href="viewtopic.php?pid=1454075#p1454075">2014-09-06 03:22:52</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=84564">tuxuser</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2014-08-23</span></dd> <dd><span>Posts: 8</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=84564">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <p>I implemented this a couple of weeks ago on a Mint 17 install so I just wanted to chime in and say thanks for all the info contributed to this thread.&#160; It actually inspired me to finally test out Arch which is running quite well I might add <img src="https://bbs.archlinux.org/img/smilies/smile.png" width="15" height="15" alt="smile" />) </p><p> I believe most people are using pci-stub as builtin, but for those using pci-stub as a module this information may prove helpful.&#160; Basically when I discovered that the MODULES line for mkinitcpio.conf did not allow for module options the next step I took was to include the respective module options file.</p><p>Ex:</p><div class="codebox"><pre><code>[root@archost ~]# grep pci /etc/mkinitcpio.conf MODULES=&quot;pci_stub&quot; FILES=&quot;/etc/modprobe.d/pci_stub.conf&quot; [root@archost ~]# cat /etc/modprobe.d/pci_stub.conf options pci_stub ids=10de:1183,10de:0e0a,8086:1e20</code></pre></div><p>Another thing is that those of you that are passing through Nvidia might find that Nouveau can be quite the ninja even though you feel sure you&#039;ve done everything to get it blacklisted.&#160; You might be better of just building the kernel without Nouveau support or a quick hack would be to rename the module and rebuild your initial ramdisk <img src="https://bbs.archlinux.org/img/smilies/smile.png" width="15" height="15" alt="smile" /></p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1454075">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1454286" class="blockpost roweven"> <h2><span><span class="conr">#2668</span> <a href="viewtopic.php?pid=1454286#p1454286">2014-09-07 00:23:01</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=84564">tuxuser</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2014-08-23</span></dd> <dd><span>Posts: 8</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=84564">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <p>Here are a couple of notes about dual monitor usage on the passthrough card to the windows vm.&#160; That includes making the monitor automatically switch outputs and also automatically starting the vm on boot.<br />NOTE:&#160; in this situation I do not run Xorg nor do I make use of libvirt.&#160; This is just how I like it <img src="https://bbs.archlinux.org/img/smilies/smile.png" width="15" height="15" alt="smile" /></p><p>I boot Arch to text console and that is using the vga connection on the onboard intel HD video to what I consider my secondary monitor.&#160; I also have a DVI connection hooked up to this same monitor that is connected to the second dvi port on the passthrough card.&#160; The first DVI port on the passthrough card connects to my primary monitor.</p><p>Normally on a monitor with multiple inputs I could issue a &#039;vbetool dpms off&#039; and that would cause the monitor to toggle to the next active input (in this case the windows vm).&#160; For whatever reason vbetool isn&#039;t working for me is this setup.</p><p>So I added the following code to my vm start script:</p><div class="codebox"><pre><code># set console screen blank to occur in the next 30 seconds (a delay that allows the vm to start sending a signal to its secondary display) chmod +w /sys/module/kernel/parameters/consoleblank echo 30 &gt; /sys/module/kernel/parameters/consoleblank # wait 60 seconds (in the background) then revert the blanking interval back to the standard 10 minutes (sleep 60 &amp;&amp; echo 600 &gt; /sys/module/kernel/parameters/consoleblank) &amp; ... screen -d -m -S myvm qemu-system-x86_64 ... ...</code></pre></div><br /><p>So the end result is that 30 seconds later both monitors are displaying vm output.</p><br /><p>Now about auto booting.&#160; My start script actually makes use of certain components that make this work:<br />1) GNU screen (screen -d -m -S myvm ...) to invoke qemu and detach<br />this makes it service friendly while still allowing you to reattach and issue Qemu monitor commands as needed</p><p>2) qemu is passed the following extra parameters: -nographic and -echr 2<br />echr 2 changes the qemu hot key from CTRL - A to CTRL - B and that is because GNU screen also uses CTRL - A</p><br /><p># cat /etc/systemd/system/myvm.service </p><div class="codebox"><pre><code>[Unit] Description=myvm After=network.target [Service] Type=forking ExecStart=/root/myvm.sh [Install] WantedBy=multi-user.target</code></pre></div><br /><p>EDIT:&#160; It&#039;s worth mentioning that not all monitors will automatically search for the next input with a signal.&#160; And qemu monitor could be set up for telnet access if you don&#039;t want to mess with GNU screen.</p> <p class="postedit"><em>Last edited by tuxuser (2014-09-07 00:36:20)</em></p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1454286">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1454297" class="blockpost rowodd"> <h2><span><span class="conr">#2669</span> <a href="viewtopic.php?pid=1454297#p1454297">2014-09-07 02:06:17</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=79825">redger</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2014-02-26</span></dd> <dd><span>Posts: 15</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=79825">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <p>A quick note to anyone running VGA Passthrough on Ubuntu Trusty .....</p><p>I added </p><div class="codebox"><pre><code>-nodefaults</code></pre></div><p> to the start command and saw minimum frame rates in my test case go from &lt;20 to &gt;40 .. a Huge performance increase for a very minor change.</p><p>I only added the parameter after I noticed that the libvirt generated command ran much faster .. and eventually narrowed the difference down to this one parameter</p><p>ymmv</p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1454297">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1454319" class="blockpost roweven"> <h2><span><span class="conr">#2670</span> <a href="viewtopic.php?pid=1454319#p1454319">2014-09-07 04:35:39</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=52029">risho</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2011-09-06</span></dd> <dd><span>Posts: 44</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=52029">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <p>rig:</p><p> ASRock Z97 Extreme6<br />Intel 4790K<br />hostgpu:intel<br />passthrough card:Nvidia GTX580</p><br /><br /><p>i am useing the pkgbuild for the kernel on page 1. I am using qemu and seabios from the repo. i am using the vfio-bind script on page 1 and i have nouveau blacklisted.</p><p>mkinitcpio modules: </p><div class="codebox"><pre><code>i915 kvm kvm_intel pci-stub</code></pre></div><p>syslinux.cfg relevant information</p><div class="codebox"><pre><code>LABEL arch-qemu MENU LABEL Arch Qemu LINUX ../vmlinuz-linux-mainline APPEND root=/dev/sda1 rootflags=subvol=__active/rootvol intel_iommu=on i915.enable_hd_vgaarb=1 pcie_acs_override=downstream pci-stub.ids=10de:1080,10de:0e09 rw INITRD ../initramfs-linux-mainline.img</code></pre></div><br /><p>something to note when i have &quot;intel_iommu=on&quot; active on my kernel parameters it says something to the effect of &quot;DRHD handling fault status reg 3&quot; and then stalls for a while while booting, but then when i disable it it boots just fine.<br />here&#039;s a picture: <a href="http://i.imgur.com/whwRVgF.jpg" rel="nofollow">http://i.imgur.com/whwRVgF.jpg</a></p><br /><p>lspci</p><div class="codebox"><pre class="vscroll"><code>00:00.0 Host bridge: Intel Corporation 4th Gen Core Processor DRAM Controller (rev 06) 00:01.0 PCI bridge: Intel Corporation Xeon E3-1200 v3/4th Gen Core Processor PCI Express x16 Controller (rev 06) 00:01.1 PCI bridge: Intel Corporation Xeon E3-1200 v3/4th Gen Core Processor PCI Express x8 Controller (rev 06) 00:02.0 VGA compatible controller: Intel Corporation Xeon E3-1200 v3/4th Gen Core Processor Integrated Graphics Controller (rev 06) 00:03.0 Audio device: Intel Corporation Xeon E3-1200 v3/4th Gen Core Processor HD Audio Controller (rev 06) 00:14.0 USB controller: Intel Corporation 9 Series Chipset Family USB xHCI Controller 00:16.0 Communication controller: Intel Corporation 9 Series Chipset Family ME Interface #1 00:19.0 Ethernet controller: Intel Corporation Ethernet Connection (2) I218-V 00:1a.0 USB controller: Intel Corporation 9 Series Chipset Family USB EHCI Controller #2 00:1b.0 Audio device: Intel Corporation 9 Series Chipset Family HD Audio Controller 00:1c.0 PCI bridge: Intel Corporation 9 Series Chipset Family PCI Express Root Port 1 (rev d0) 00:1c.2 PCI bridge: Intel Corporation 9 Series Chipset Family PCI Express Root Port 3 (rev d0) 00:1c.3 PCI bridge: Intel Corporation 9 Series Chipset Family PCI Express Root Port 4 (rev d0) 00:1c.6 PCI bridge: Intel Corporation 9 Series Chipset Family PCI Express Root Port 7 (rev d0) 00:1d.0 USB controller: Intel Corporation 9 Series Chipset Family USB EHCI Controller #1 00:1f.0 ISA bridge: Intel Corporation 9 Series Chipset Family Z97 LPC Controller 00:1f.2 SATA controller: Intel Corporation 9 Series Chipset Family SATA Controller [AHCI Mode] 00:1f.3 SMBus: Intel Corporation 9 Series Chipset Family SMBus Controller 01:00.0 VGA compatible controller: NVIDIA Corporation GF110 [GeForce GTX 580] (rev a1) 01:00.1 Audio device: NVIDIA Corporation GF110 High Definition Audio Controller (rev a1) 02:00.0 USB controller: Renesas Technology Corp. uPD720201 USB 3.0 Host Controller (rev 03) 04:00.0 Ethernet controller: Realtek Semiconductor Co., Ltd. RTL8111/8168/8411 PCI Express Gigabit Ethernet Controller (rev 11) 05:00.0 PCI bridge: ASMedia Technology Inc. Device 1184 06:01.0 PCI bridge: ASMedia Technology Inc. Device 1184 06:03.0 PCI bridge: ASMedia Technology Inc. Device 1184 06:05.0 PCI bridge: ASMedia Technology Inc. Device 1184 06:07.0 PCI bridge: ASMedia Technology Inc. Device 1184 07:00.0 SATA controller: Marvell Technology Group Ltd. 88SE9128 PCIe SATA 6 Gb/s RAID controller with HyperDuo (rev 11) 08:00.0 SATA controller: ASMedia Technology Inc. ASM1062 Serial ATA Controller (rev 02) 09:00.0 Network controller: Qualcomm Atheros AR93xx Wireless Network Adapter (rev 01) 0a:00.0 SATA controller: ASMedia Technology Inc. ASM1062 Serial ATA Controller (rev 02) 0b:00.0 USB controller: ASMedia Technology Inc. Device 1142</code></pre></div><p>lspci -n</p><div class="codebox"><pre class="vscroll"><code>lspci -n 00:00.0 0600: 8086:0c00 (rev 06) 00:01.0 0604: 8086:0c01 (rev 06) 00:01.1 0604: 8086:0c05 (rev 06) 00:02.0 0300: 8086:0412 (rev 06) 00:03.0 0403: 8086:0c0c (rev 06) 00:14.0 0c03: 8086:8cb1 00:16.0 0780: 8086:8cba 00:19.0 0200: 8086:15a1 00:1a.0 0c03: 8086:8cad 00:1b.0 0403: 8086:8ca0 00:1c.0 0604: 8086:8c90 (rev d0) 00:1c.2 0604: 8086:8c94 (rev d0) 00:1c.3 0604: 8086:8c96 (rev d0) 00:1c.6 0604: 8086:8c9c (rev d0) 00:1d.0 0c03: 8086:8ca6 00:1f.0 0601: 8086:8cc4 00:1f.2 0106: 8086:8c82 00:1f.3 0c05: 8086:8ca2 01:00.0 0300: 10de:1080 (rev a1) 01:00.1 0403: 10de:0e09 (rev a1) 02:00.0 0c03: 1912:0014 (rev 03) 04:00.0 0200: 10ec:8168 (rev 11) 05:00.0 0604: 1b21:1184 06:01.0 0604: 1b21:1184 06:03.0 0604: 1b21:1184 06:05.0 0604: 1b21:1184 06:07.0 0604: 1b21:1184 07:00.0 0106: 1b4b:9130 (rev 11) 08:00.0 0106: 1b21:0612 (rev 02) 09:00.0 0280: 168c:0030 (rev 01) 0a:00.0 0106: 1b21:0612 (rev 02) 0b:00.0 0c03: 1b21:1142</code></pre></div><p>qemu.sh(the op&#039;s script with my card put in and the cpu changed</p><div class="codebox"><pre><code>qemu-system-x86_64 -enable-kvm -M q35 -m 1024 -cpu host \ -smp 6,sockets=1,cores=3,threads=2 \ -bios /usr/share/qemu/bios.bin -vga none \ -device ioh3420,bus=pcie.0,addr=1c.0,multifunction=on,port=1,chassis=1,id=root.1 \ -device vfio-pci,host=01:00.0,bus=root.1,addr=00.0,multifunction=on,x-vga=on \ -device vfio-pci,host=01:00.1,bus=root.1,addr=00.1</code></pre></div><p>and i&#039;m getting output</p><div class="codebox"><pre><code>No protocol specified Could not initialize SDL(No available video device) - exiting</code></pre></div><br /><br /><p>then for some reason after a while i ran that qemu.sh and i got the output</p><div class="codebox"><pre><code>qemu-system-x86_64: -device vfio-pci,host=01:00.0,bus=root.1,addr=00.0,multifunction=on,x-vga=on: vfio: error opening /dev/vfio/16: Device or resource busy qemu-system-x86_64: -device vfio-pci,host=01:00.0,bus=root.1,addr=00.0,multifunction=on,x-vga=on: vfio: failed to get group 16 qemu-system-x86_64: -device vfio-pci,host=01:00.0,bus=root.1,addr=00.0,multifunction=on,x-vga=on: Device initialization failed. qemu-system-x86_64: -device vfio-pci,host=01:00.0,bus=root.1,addr=00.0,multifunction=on,x-vga=on: Device &#039;vfio-pci&#039; could not be initialized</code></pre></div><p>any ideas on whats going on?</p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1454319">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1454322" class="blockpost rowodd"> <h2><span><span class="conr">#2671</span> <a href="viewtopic.php?pid=1454322#p1454322">2014-09-07 04:43:36</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=75590">aw</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2013-10-04</span></dd> <dd><span>Posts: 921</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=75590">Email</a></span> <span class="website"><a href="http://vfio.blogspot.com/" rel="nofollow">Website</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>risho wrote:</cite><blockquote><div><p>rig:</p><p> ASRock Z97 Extreme6<br />Intel 4790K<br />hostgpu:intel<br />passthrough card:Nvidia GTX580</p><br /><br /><p>i am useing the pkgbuild for the kernel on page 1. I am using qemu and seabios from the repo. i am using the vfio-bind script on page 1 and i have nouveau blacklisted.</p><p>mkinitcpio modules: </p><div class="codebox"><pre><code>i915 kvm kvm_intel pci-stub</code></pre></div><p>syslinux.cfg relevant information</p><div class="codebox"><pre><code>LABEL arch-qemu MENU LABEL Arch Qemu LINUX ../vmlinuz-linux-mainline APPEND root=/dev/sda1 rootflags=subvol=__active/rootvol intel_iommu=on i915.enable_hd_vgaarb=1 pcie_acs_override=downstream pci-stub.ids=10de:1080,10de:0e09 rw INITRD ../initramfs-linux-mainline.img</code></pre></div><br /><p>something to note when i have &quot;intel_iommu=on&quot; active on my kernel parameters it says something to the effect of &quot;DRHD handling fault status reg 3&quot; and then stalls for a while while booting, but then when i disable it it boots just fine.<br />here&#039;s a picture: <a href="http://i.imgur.com/whwRVgF.jpg" rel="nofollow">http://i.imgur.com/whwRVgF.jpg</a></p></div></blockquote></div><p>You need to run 3.17-rc or disable the Marvell controller.&#160; That device is known to use an invalid PCIe requester ID for DMA.&#160; 3.17 includes DMA alias support to enable support for these devices.</p> </div> <div class="postsignature postmsg"><hr /><p><a href="http://vfio.blogspot.com" rel="nofollow">http://vfio.blogspot.com</a><br />Looking for a more open forum to discuss vfio related uses?&#160; Try <a href="https://www.redhat.com/mailman/listinfo/vfio-users" rel="nofollow">https://www.redhat.com/mailman/listinfo/vfio-users</a></p></div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1454322">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1454326" class="blockpost roweven"> <h2><span><span class="conr">#2672</span> <a href="viewtopic.php?pid=1454326#p1454326">2014-09-07 05:11:08</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=52029">risho</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2011-09-06</span></dd> <dd><span>Posts: 44</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=52029">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <p>##what patches do i need for 3.17?##</p><p>EDIT:</p><p>I&#039;m going to try to see if i can get it working at all first before i start messing with compiling different kernels, though i really do appreciate the info. I&#039;ve decided to just manually remove the device and it&#039;s working fine now.</p><p>I&#039;m still getting</p><div class="codebox"><pre><code>No protocol specified Could not initialize SDL(No available video device) - exiting</code></pre></div><p>edit 2:</p><p>i&#039;m a dope. i was running it as root</p><p>not running it as root is giving me the error</p><div class="codebox"><pre><code>qemu-system-x86_64: -device vfio-pci,host=01:00.0,bus=root.1,addr=00.0,multifunction=on,x-vga=on: vfio: error opening /dev/vfio/15: Permission denied qemu-system-x86_64: -device vfio-pci,host=01:00.0,bus=root.1,addr=00.0,multifunction=on,x-vga=on: vfio: failed to get group 15 qemu-system-x86_64: -device vfio-pci,host=01:00.0,bus=root.1,addr=00.0,multifunction=on,x-vga=on: Device initialization failed. qemu-system-x86_64: -device vfio-pci,host=01:00.0,bus=root.1,addr=00.0,multifunction=on,x-vga=on: Device &#039;vfio-pci&#039; could not be initialized</code></pre></div> <p class="postedit"><em>Last edited by risho (2014-09-07 06:47:48)</em></p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1454326">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1454406" class="blockpost rowodd"> <h2><span><span class="conr">#2673</span> <a href="viewtopic.php?pid=1454406#p1454406">2014-09-07 15:26:22</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=84564">tuxuser</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2014-08-23</span></dd> <dd><span>Posts: 8</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=84564">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <p>@risho Maybe take a look at your iommu groups using the lsgroup script that aw provided on page 30 or so?&#160; Also you can use lspci -nn to combine the output instead of a seperate lspci / lspci -n run.</p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1454406">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1454455" class="blockpost roweven"> <h2><span><span class="conr">#2674</span> <a href="viewtopic.php?pid=1454455#p1454455">2014-09-07 18:12:04</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=84238">Mardok45</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2014-08-10</span></dd> <dd><span>Posts: 5</span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>shazeal wrote:</cite><blockquote><div><p>The R9 270X is just a 7870 card rebranded and overclocked, regardless any video card can be passed through its just a PCI redirect afaik. Its upto the guest to support the video card.</p><p>More important than the video card is how are you running CPU/RAM, are you using cgroups and hugetlbfs?</p></div></blockquote></div><p>Thanks for the information, if I can&#039;t get my nVidia card to work, I&#039;ll probably get this.&#160; More information below.</p><div class="quotebox"><cite>aw wrote:</cite><blockquote><div><p>Add kvm=off to the -cpu parameter list to make current Nvidia driver not get Code 43.&#160; Also add hv_time to enable hypver-v enlightened time keeping.&#160; Older kernels can have poor performance if the game makes use of debug registers, run something new.&#160; Hugepages, pinning, and vCPU model tuning also help.&#160; All of this is documented in the very, very long thread.</p></div></blockquote></div><p>This worked, but I&#039;m no longer using QEMU.&#160; More information below.</p><div class="quotebox"><cite>slis wrote:</cite><blockquote><div><p>@mardok45 check your cpu config</p><p>&#160; &#160; &lt;topology sockets=&#039;1&#039; cores=&#039;4&#039; threads=&#039;1&#039;/&gt;</p><p>if u set 2 cores 2 threads dota works 2x slower, also check your cpu model, hvtime option... etc... host cpufreq settings....</p></div></blockquote></div><p>I think I was not setting the right CPU topology and the performance was better after tweaking it, but I&#039;m not on QEMU anymore.&#160; More information below.</p><br /><p>I played around with this for about a month and found out a lot of information.</p><p>First things first, the hardware.&#160; If you plan on using this for games, not only should you make sure the CPU and motherboard support IOMMU/VT-x&amp;VT-d, you should pick out a motherboard that either:</p><p>* You can alter the primary display in your motherboards BIOS or it can pick its primary display depending on which GPU slot is plugged in to a montior.<br />or<br />* Has at least two PCI-E slots that work at x16.<br />AND<br />Make sure you have at least one AMD GPU or a nVidia Quadro.&#160; In my case, I have on old ATI 4850 and a Radeon HD 7470.</p><p>I forgot what kind of specs my motherboard had, and found out later that the second PCI-E slot operates at x8 speeds.&#160; Not good for gaming.&#160; That explains why Dota 2 was having rendering problems.&#160; </p><p>So I thought, &quot;Okay, just plug my nVidia card into the first slot so it&#039;ll operate at x16 speeds.&quot;&#160; Well, I don&#039;t know for sure, but I think that because the nVidia GPU was bootstrapped when I turned the physical machine on, it couldn&#039;t re-bootstrap itself when I passed it through to the DomU.&#160; This caused it to just display nothing.</p><p>But here&#039;s where it gets really weird; my AMD cards don&#039;t suffer from this problem.&#160; Both of my Radeon cards have no problem being in the primary display, and then being passed through to the DomU.&#160; They display just fine.&#160; Does anyone else have the same experience?</p><p>My motherboard can either set the primary display to a PCI or PCI-E slot, so I&#039;m going to try to get my hands on a PCI GPU and set the primary display to the PCI slot.&#160; I&#039;m hoping this will cause the nVidia GPU to not get bootstrapped and it can then be passed through to the DomU with no problems.&#160; It had no problems being passed through when it was in the x8 slot, so I&#039;m fairly confident it&#039;ll work.</p><p>Now moving on to the software.&#160; I&#039;m using Gentoo for the host, but it&#039;s just a personal preferance of mine.&#160; You can accomplish this with any distribution.&#160; At first, I was using QEMU.&#160; I had no problems with a Linux guest, but Windows was a different story.</p><p>Right off the bat, the Windows installation took an unusually long time.&#160; The Windows 7 installer would get hung on 0% for over an hour before files started getting copied over.&#160; It&#039;s not due to performance on anything and I can&#039;t explain why it does this.</p><p>Then I had to go through the Windows updates.&#160; This was scary because Windows would just become unbootable.&#160; I cannot explain this to you.&#160; For whatever reason, at some point during updates, Windows would just become completely unbootable.&#160; It goes straight into the &quot;Fix Windows boot problems&quot; prompt and it cannot fix itself.&#160; If anyone can shed some light on this, please do because it has caused so many headaches.</p><p>When I switched to Xen 4.4, I&#039;ve had zero problems with Windows.&#160; Zero, nada, zilch.&#160; It works... almost perfectly.</p><p>Now you have the problem with the GPU, and it&#039;s not Window&#039;s fault.&#160; You have to eject the card before you reboot it, and I cannot figure out how to automate this.&#160; If anyone does, can you explain how?&#160; I&#039;ve tried the automated eject as destribed here, and it didn&#039;t work for me: <a href="http://blog.ktz.me/?p=219" rel="nofollow">http://blog.ktz.me/?p=219</a>.&#160; So if anyone has a suggestion, I would love to hear it.</p><p>Now there&#039;s one detail left: sound.&#160; At first, I tried straight-up ALSA/dmix and gave it a sound card with a config like this:</p><div class="quotebox"><blockquote><div><p>builder=&#039;hvm&#039;<br />device_model_override = &quot;/usr/bin/qemu-system-x86_64&quot;<br />memory = 3072<br />vcpus=6<br />name = &quot;windows&quot;<br />vif = [&#039;&#039;]<br />disk = [&#039;phy:/dev/system/windows,hda,w&#039;]<br />acpi = 1<br />stdvga=1<br />usbdevice=&#039;tablet&#039;<br />boot=&quot;dc&quot;<br />sdl=0<br />serial=&#039;pty&#039;<br />vnc=1<br />vnclisten=&quot;0.0.0.0&quot;<br />xen_platform_pci=1<br />viridian=1<br />apic=1<br />gfx_passthru=0<br />pci=[&#039;01:00.0&#039;, &#039;01:00.1&#039;, &#039;00:12.0&#039;, &#039;00:12.2&#039;]<br />on_poweroff=&#039;destroy&#039;<br />on_reboot=&#039;destroy&#039;<br />on_crash=&#039;destroy&#039; <br />soundhw=&#039;hda&#039;</p></div></blockquote></div><p>This worked fine for Linux, but Windows&#039;s sound was crackly.&#160; I cannot explain why.&#160; So I set up PulseAudio by running system-wide and adding the root user to the pulse and pulse-access groups (which you really shouldn&#039;t do, but I had no other choice), and now sound works great.</p><p>So there you have it.&#160; The only thing that&#039;s left for me to do is to test the nVidia setup as I described above and get a KVM switch, then I&#039;ll have the perfect setup.&#160; If anyone has any suggestions or comments, please give me a shout.</p> <p class="postedit"><em>Last edited by Mardok45 (2014-09-07 18:21:40)</em></p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1454455">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1454462" class="blockpost rowodd"> <h2><span><span class="conr">#2675</span> <a href="viewtopic.php?pid=1454462#p1454462">2014-09-07 18:35:11</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=75590">aw</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2013-10-04</span></dd> <dd><span>Posts: 921</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=75590">Email</a></span> <span class="website"><a href="http://vfio.blogspot.com/" rel="nofollow">Website</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>Mardok45 wrote:</cite><blockquote><div><p>Now moving on to the software.&#160; I&#039;m using Gentoo for the host, but it&#039;s just a personal preferance of mine.&#160; You can accomplish this with any distribution.&#160; At first, I was using QEMU.&#160; I had no problems with a Linux guest, but Windows was a different story.</p><p>Right off the bat, the Windows installation took an unusually long time.&#160; The Windows 7 installer would get hung on 0% for over an hour before files started getting copied over.&#160; It&#039;s not due to performance on anything and I can&#039;t explain why it does this.</p><p>Then I had to go through the Windows updates.&#160; This was scary because Windows would just become unbootable.&#160; I cannot explain this to you.&#160; For whatever reason, at some point during updates, Windows would just become completely unbootable.&#160; It goes straight into the &quot;Fix Windows boot problems&quot; prompt and it cannot fix itself.&#160; If anyone can shed some light on this, please do because it has caused so many headaches.</p></div></blockquote></div><p>I&#039;d guess this likely has a lot to do with the QEMU Q35 machine and AHCI.&#160; It&#039;s terrible.&#160; Regardless of how many times I mention to just use 440FX and give examples of doing it, people continue to use Q35 when they don&#039;t need to.&#160; Xen uses a 440FX model.</p> </div> <div class="postsignature postmsg"><hr /><p><a href="http://vfio.blogspot.com" rel="nofollow">http://vfio.blogspot.com</a><br />Looking for a more open forum to discuss vfio related uses?&#160; Try <a href="https://www.redhat.com/mailman/listinfo/vfio-users" rel="nofollow">https://www.redhat.com/mailman/listinfo/vfio-users</a></p></div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1454462">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div class="postlinksb"> <div class="inbox crumbsplus"> <div class="pagepost"> <p class="pagelink conl"><span class="pages-label">Pages: </span><a rel="prev" class="item1" href="viewtopic.php?id=162768&amp;p=106">Previous</a> <a href="viewtopic.php?id=162768">1</a> <span class="spacer">…</span> <a href="viewtopic.php?id=162768&amp;p=105">105</a> <a href="viewtopic.php?id=162768&amp;p=106">106</a> <strong>107</strong> <a href="viewtopic.php?id=162768&amp;p=108">108</a> <a href="viewtopic.php?id=162768&amp;p=109">109</a> <span class="spacer">…</span> <a href="viewtopic.php?id=162768&amp;p=234">234</a> <a rel="next" href="viewtopic.php?id=162768&amp;p=108">Next</a></p> <p class="postlink conr">Topic closed</p> </div> <ul class="crumbs"> <li><a href="index.php">Index</a></li> <li><span>»&#160;</span><a href="viewforum.php?id=48">Topics Going Nowhere</a></li> <li><span>»&#160;</span><strong><a href="viewtopic.php?id=162768">KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</a></strong></li> </ul> <p class="subscribelink clearb"><a href="misc.php?action=subscribe&amp;tid=162768">Subscribe to this topic</a></p> <div class="clearer"></div> </div> </div> </div> <div id="brdfooter" class="block"> <h2><span>Board footer</span></h2> <div class="box"> <div id="brdfooternav" class="inbox"> <div class="conl"> <form id="qjump" method="get" action="viewforum.php"> <div><label><span>Jump to<br /></span> <select name="id" onchange="window.location=('viewforum.php?id='+this.options[this.selectedIndex].value)"> <optgroup label="Technical Issues and Assistance"> <option value="23">Newbie Corner</option> <option value="17">Installation</option> <option value="22">Kernel &amp; Hardware</option> <option value="18">Applications &amp; Desktop Environments</option> <option value="31">Laptop Issues</option> <option value="8">Networking, Server, and Protection</option> <option value="32">Multimedia and Games</option> <option value="50">System Administration</option> <option value="35">Other Architectures</option> </optgroup> <optgroup label="Arch-centric"> <option value="24">Announcements, Package &amp; Security Advisories</option> <option value="1">Arch Discussion</option> <option value="13">Forum &amp; Wiki discussion</option> </optgroup> <optgroup label="Pacman Upgrades, Packaging &amp; AUR"> <option value="44">Pacman &amp; Package Upgrade Issues</option> <option value="49">[testing] Repo Forum</option> <option value="4">Creating &amp; Modifying Packages</option> <option value="38">AUR Issues, Discussion &amp; PKGBUILD Requests</option> </optgroup> <optgroup label="Contributions &amp; Discussion"> <option value="20">GNU/Linux Discussion</option> <option value="27">Community Contributions</option> <option value="33">Programming &amp; Scripting</option> <option value="30">Other Languages</option> <option value="47">Artwork and Screenshots</option> <option value="42">Try This</option> </optgroup> <optgroup label="/dev/null"> <option value="29">Off-Topic</option> <option value="48" selected="selected">Topics Going Nowhere</option> <option value="36">Dustbin</option> </optgroup> </select></label> <input type="submit" value=" Go " accesskey="g" /> </div> </form> </div> <div class="conr"> <p id="feedlinks"><span class="atom"><a href="extern.php?action=feed&amp;tid=162768&amp;type=atom">Atom topic feed</a></span></p> <p id="poweredby">Powered by <a href="http://fluxbb.org/">FluxBB</a></p> </div> <div class="clearer"></div> </div> </div> </div> </div> <div class="end-box"></div> </div> </body> </html>
