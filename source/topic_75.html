<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"> <html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en" dir="ltr"> <head> <meta http-equiv="Content-Type" content="text/html; charset=utf-8" /> <title>KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9 (Page 75) / Topics Going Nowhere / Arch Linux Forums</title> <link rel="stylesheet" type="text/css" href="style/ArchLinux.css" /> <link rel="canonical" href="viewtopic.php?id=162768&amp;p=75" title="Page 75" /> <link rel="prev" href="viewtopic.php?id=162768&amp;p=74" title="Page 74" /> <link rel="next" href="viewtopic.php?id=162768&amp;p=76" title="Page 76" /> <link rel="alternate" type="application/atom+xml" href="extern.php?action=feed&amp;tid=162768&amp;type=atom" title="Atom topic feed" /> <link rel="stylesheet" media="screen" href="style/ArchLinux/arch.css?v=3" /> <link rel="stylesheet" media="screen" href="style/ArchLinux/archnavbar.css?v=2" /> <link rel="shortcut icon" href="style/ArchLinux/favicon.ico" /> </head> <body> <div id="archnavbar" class="anb-forum"> <div id="archnavbarlogo"><h1><a href="http://www.archlinux.org/">Arch Linux</a></h1></div> <div id="archnavbarmenu"> <ul id="archnavbarlist"> <li id="anb-home"><a href="http://www.archlinux.org/">Home</a></li><li id="anb-packages"><a href="http://www.archlinux.org/packages/">Packages</a></li><li id="anb-forums" class="anb-selected"><a href="https://bbs.archlinux.org/">Forums</a></li><li id="anb-wiki"><a href="https://wiki.archlinux.org/">Wiki</a></li><li id="anb-bugs"><a href="https://bugs.archlinux.org/">Bugs</a></li><li id="anb-aur"><a href="https://aur.archlinux.org/">AUR</a></li><li id="anb-download"><a href="http://www.archlinux.org/download/">Download</a></li> </ul> </div> </div> <div id="punviewtopic" class="pun"> <div class="top-box"></div> <div class="punwrap"> <div id="brdheader" class="block"> <div class="box"> <div id="brdmenu" class="inbox"> <ul> <li id="navindex" class="isactive"><a href="index.php">Index</a></li> <li id="navuserlist"><a href="userlist.php">User list</a></li> <li id="navsearch"><a href="search.php">Search</a></li> <li id="navprofile"><a href="profile.php?id=80749">Profile</a></li> <li id="navlogout"><a href="login.php?action=out&amp;id=80749&amp;csrf_token=5c20501ec397bb45ef8ee8c84db232c8d8e421c6">Logout</a></li> </ul> </div> <div id="brdwelcome" class="inbox"> <ul class="conl"> <li><span>Logged in as <strong>SXX</strong></span></li> <li><span>Last visit: 2015-08-16 12:20:09</span></li> </ul> <ul class="conr"> <li><span>Topics: <a href="search.php?action=show_replies" title="Find topics you have posted to.">Posted</a> | <a href="search.php?action=show_new" title="Find topics with new posts since your last visit.">New</a> | <a href="search.php?action=show_recent" title="Find topics with recent posts.">Active</a> | <a href="search.php?action=show_unanswered" title="Find topics with no replies.">Unanswered</a></span></li> </ul> <div class="clearer"></div> </div> </div> </div> <div id="brdmain"> <div class="linkst"> <div class="inbox crumbsplus"> <ul class="crumbs"> <li><a href="index.php">Index</a></li> <li><span>»&#160;</span><a href="viewforum.php?id=48">Topics Going Nowhere</a></li> <li><span>»&#160;</span><strong><a href="viewtopic.php?id=162768">KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</a></strong></li> </ul> <div class="pagepost"> <p class="pagelink conl"><span class="pages-label">Pages: </span><a rel="prev" class="item1" href="viewtopic.php?id=162768&amp;p=74">Previous</a> <a href="viewtopic.php?id=162768">1</a> <span class="spacer">…</span> <a href="viewtopic.php?id=162768&amp;p=73">73</a> <a href="viewtopic.php?id=162768&amp;p=74">74</a> <strong>75</strong> <a href="viewtopic.php?id=162768&amp;p=76">76</a> <a href="viewtopic.php?id=162768&amp;p=77">77</a> <span class="spacer">…</span> <a href="viewtopic.php?id=162768&amp;p=234">234</a> <a rel="next" href="viewtopic.php?id=162768&amp;p=76">Next</a></p> <p class="postlink conr">Topic closed</p> </div> <div class="clearer"></div> </div> </div> <div id="p1419638" class="blockpost rowodd blockpost1"> <h2><span><span class="conr">#1851</span> <a href="viewtopic.php?pid=1419638#p1419638">2014-05-27 07:27:55</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=82280">thelamer</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2014-05-25</span></dd> <dd><span>Posts: 4</span></dd> <dd class="usercontacts"><span class="email"><a href="mailto:ryankuba@gmail.com">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <p>So I thought I would write down what I needed to do to get my gaming VM up and running. I am not really in a position to answer any hardcore technical questions as this mostly came from googling and this thread. </p><p>I am happy to report I got to get some Wolfenstein in on my linux desktop even if it was only for 2 hours out of the entire weekend <img src="https://bbs.archlinux.org/img/smilies/sad.png" width="15" height="15" alt="sad" /> . </p><p><span class="postimg"><img src="http://i.imgur.com/LBr8ue4.jpg" alt="GameVM" /></span></p><p>I am running relatively bleeding edge hardware. It is a i7-4790 on a Z87X-UD4H and a XFX R9 270x I bought at Best Buy ( it was the weekend and I was desperate to test) </p><p>First problem I had is with IOMMU enabled is my marvell 88SE9172 SATA controller was broken on boot(running the current stable kernel 3.14) which dropped 2 disks out of my 16 driver raid array. Two things I can say is, praise science for raid 6 and bitmap array rebuilds, otherwise I would have said nope right there and just made sure my data was safe. </p><p>Second problem was that my motherboard has a i915 VGA adapter and is effected by an outstanding arbitration bug. </p><p>To resolve this I compiled Alex Williamson&#039;s fork of the kernel mainline and applied a i915 patch he put together ( big shout out to Alex he is the man and extrememly helpful on all the forums he communicates on. As far as I know is the current king of VFIO help it seems like). </p><p>I am running Debian Jessie on my server to checkout and compile Alex&#039;s kernel I needed to: </p><div class="codebox"><pre><code>git clone git://github.com/awilliam/linux-vfio.git linux-vfio cd linux-vfio git checkout dma-alias-v4</code></pre></div><p>created a file called i915patch: </p><p><a href="http://pastebin.com/dZqD3k5a" rel="nofollow">http://pastebin.com/dZqD3k5a</a></p><p>Now patched it in: </p><div class="codebox"><pre><code>patch -i i915patch</code></pre></div><p>Now to compile: </p><div class="codebox"><pre><code>cp /boot/config-`uname -r` ./.config make menuconfig</code></pre></div><p>At this point all the VFIO stuff will be built as modules given my current kernel config, but I ended up setting them anyway.</p><p>edit the .config file and change/add the following lines: </p><div class="codebox"><pre><code>CONFIG_VFIO_IOMMU_TYPE1=y CONFIG_VFIO=y CONFIG_VFIO_PCI=y CONFIG_VFIO_PCI_VGA=y</code></pre></div><p>Now compiled kernel and output debs: </p><div class="codebox"><pre><code>fakeroot make-kpkg -j8 --initrd --append-to-version=-awilliam kernel_image kernel_headers</code></pre></div><p>Before I install them updated grub options: </p><p>in /etc/default/grub: </p><div class="codebox"><pre><code>GRUB_CMDLINE_LINUX_DEFAULT=&quot;quiet intel_iommu=on vfio_iommu_type1.allow_unsafe_interrupts=1 i915.enable_hd_vgaarb=1&quot;</code></pre></div><br /><p>Now install them: </p><div class="codebox"><pre><code>dpkg -i linux-image-3.15.0-rc6-awilliam-i915-2+_3.15.0-rc6-awilliam-10.00.Custom_amd64.deb dpkg -i linux-headers-3.15.0-rc6-awilliam-i915-2+_3.15.0-rc6-awilliam-10.00.Custom_amd64.deb</code></pre></div><p>Finally blacklist radeon: </p><div class="codebox"><pre><code>echo &quot;blacklist radeon&quot; &gt;&gt; /etc/modprobe.d/blacklist.conf</code></pre></div><p>Reboot! </p><p>Ok so now I am booted and have a kernel that finally uses lube. Through troubleshooting I found out I needed the latest qemu and seabios from the current git tree. The ones bundled in jessie even in experimental did not cut it.</p><p>So lets build qemu: </p><div class="codebox"><pre><code>git clone http://git.qemu.org/git/qemu.git cd qemu ./configure --enable-libusb make make install</code></pre></div><p>Resulting binaries will be in /usr/local/bin/ so I just use full path to ensure I am using the latest. </p><p>Now build seabios: </p><div class="codebox"><pre><code>git clone git://git.seabios.org/seabios.git seabios cd seabios/ make menuconfig (save and exit) make </code></pre></div><p>Resulting bios.bin in the out/ subfolder. </p><p>Ok so I got all the tools I need to build a gaming VM, not gonna lie at this point I was 3 days in and was getting pretty excited to play the new Wolfenstein on my linux Desktop from my server using steam&#039;s new streaming service. </p><p>Get networking setup: </p><p>/etc/network/interfaces: </p><div class="codebox"><pre><code> # This file describes the network interfaces available on your system # and how to activate them. For more information, see interfaces(5). # The loopback network interface auto lo br0 iface lo inet loopback # Set up interfaces manually, avoiding conflicts with, e.g., network manager iface eth0 inet manual # Bridge setup iface br0 inet static pre-up ip tuntap add dev tap0 mode tap user root pre-up ip link set tap0 up bridge_ports all tap0 address 192.168.1.150 netmask 255.255.255.0 gateway 192.168.1.1 bridge_stp off bridge_maxwait 0 bridge_fd 0 post-down ip link set tap0 down post-down ip tuntap del dev tap0 mode tap </code></pre></div><p>I only have one NIC and I plan on bridging it. </p><p>Setup qemu.conf: (needed for the card to work properly) </p><p>/etc/qemu/qemu.conf </p><div class="codebox"><pre><code>group = &quot;root&quot; user = &quot;root&quot; clear_emulator_capabilities = 0</code></pre></div><br /><p>First installed windows 7 (windows 8 and 8.1 did not work for me something is broken in the catalyst driver for now) </p><br /><div class="codebox"><pre><code>/usr/local/bin/qemu-system-x86_64 -enable-kvm -M q35 -m 8192 -cpu host -smp 8,sockets=1,cores=4,threads=8 \ -bios /storage/OSs/seabios/out/bios.bin \ -boot menu=on \ -vga none \ -device ioh3420,bus=pcie.0,addr=1c.0,multifunction=on,port=1,chassis=1,id=root.1 \ -device vfio-pci,host=01:00.0,bus=root.1,addr=00.0,multifunction=on,x-vga=on \ -device vfio-pci,host=00:1b.0,bus=pcie.0 \ -device piix4-ide,bus=pcie.0,id=piix4-ide \ -device ide-hd,bus=piix4-ide.0,drive=disk -drive file=/storage/OSs/vm/windows7.img,id=disk,format=raw \ -device ide-cd,bus=piix4-ide.1,drive=isocd -drive file=/storage/OSs/vm/windows7.iso,id=isocd \ -usb -usbdevice host:046d:c051 -usbdevice host:046d:c315 \ -net nic -net tap,ifname=tap0,script=no,downscript=no \ -vnc :1</code></pre></div><p>Explanation, 01:00.0 is my 270x, 00:1b.0 is my MB audio the hdmi audio on the card did not work for me, initially to get windows to install I use the piix4 controller as it does not need drivers at install time virtio or q35 at install did not work for me, the usb devices are keyboard and mouse. </p><p>Got monitor output Hooray! </p><p>Install windows like normal and shutdown.</p><p>Now I installed the virtio drivers found here: <a href="http://alt.fedoraproject.org/pub/alt/virtio-win/latest/images/" rel="nofollow">http://alt.fedoraproject.org/pub/alt/vi … st/images/</a></p><div class="codebox"><pre><code>/usr/local/bin/qemu-system-x86_64 -enable-kvm -M q35 -m 8192 -cpu host -smp 8,sockets=1,cores=4,threads=8 \ -bios /storage/OSs/seabios/out/bios.bin \ -boot menu=on \ -vga none \ -device ioh3420,bus=pcie.0,addr=1c.0,multifunction=on,port=1,chassis=1,id=root.1 \ -device vfio-pci,host=01:00.0,bus=root.1,addr=00.0,multifunction=on,x-vga=on \ -device vfio-pci,host=00:1b.0,bus=pcie.0 \ -device piix4-ide,bus=pcie.0,id=piix4-ide \ -device virtio-scsi-pci,id=storage -drive file=/storage/OSs/vm/storage.img,id=storage,format=raw \ -device ide-hd,bus=piix4-ide.0,drive=disk -drive file=/storage/OSs/vm/windows7.img,id=disk,format=raw \ -device ide-cd,bus=piix4-ide.1,drive=isocd -drive file=/storage/OSs/vm/virtio-win-0.1-74.iso,id=isocd \ -usb -usbdevice host:046d:c051 -usbdevice host:046d:c315 \ -net nic,model=virtio -net tap,ifname=tap0,script=no,downscript=no \ -vnc :1</code></pre></div><p>Here I added a disk image and changed my nic to virtio so I could easily install the drivers in windows 7 and poweroff. </p><p>Now that you have virtio installed boot the machine make sure it works work: </p><div class="codebox"><pre><code>/usr/local/bin/qemu-system-x86_64 -enable-kvm -M q35 -m 8192 -cpu host -smp 8,sockets=1,cores=4,threads=8 \ -bios /storage/OSs/seabios/out/bios.bin \ -boot menu=on \ -vga none \ -device ioh3420,bus=pcie.0,addr=1c.0,multifunction=on,port=1,chassis=1,id=root.1 \ -device vfio-pci,host=01:00.0,bus=root.1,addr=00.0,multifunction=on,x-vga=on \ -device vfio-pci,host=00:1b.0,bus=pcie.0 \ -device virtio-scsi-pci,id=scsi \ -device scsi-hd,drive=disk -drive file=/storage/OSs/vm/windows7.img,id=disk,format=raw \ -device scsi-hd,drive=data -drive file=/storage/OSs/vm/storage.img,id=data,format=raw \ -usb -usbdevice host:046d:c051 -usbdevice host:046d:c315 \ -net nic,model=virtio -net tap,ifname=tap0,script=no,downscript=no \ -vnc :1</code></pre></div><br /><p>Ok driver time. For me I spent a whole day installing and re-installing windows and fighting BSODs only to find out I needed to reboot the host after a driver upgrade. Maybe catalyst writes a new rom to the card or something during the install not sure. </p><p>So with your machine still open installed the latest beta drivers on amd&#039;s website for my card. Then powered off (not reboot only got BSOD with reboot) </p><p>Rebooted the host. </p><p>Fire back up: </p><div class="codebox"><pre><code>/usr/local/bin/qemu-system-x86_64 -enable-kvm -M q35 -m 8192 -cpu host -smp 8,sockets=1,cores=4,threads=8 \ -bios /storage/OSs/seabios/out/bios.bin \ -boot menu=on \ -vga none \ -device ioh3420,bus=pcie.0,addr=1c.0,multifunction=on,port=1,chassis=1,id=root.1 \ -device vfio-pci,host=01:00.0,bus=root.1,addr=00.0,multifunction=on,x-vga=on \ -device vfio-pci,host=00:1b.0,bus=pcie.0 \ -device virtio-scsi-pci,id=scsi \ -device scsi-hd,drive=disk -drive file=/storage/OSs/vm/windows7.img,id=disk,format=raw \ -device scsi-hd,drive=data -drive file=/storage/OSs/vm/storage.img,id=data,format=raw \ -usb -usbdevice host:046d:c051 -usbdevice host:046d:c315 \ -net nic,model=virtio -net tap,ifname=tap0,script=no,downscript=no \ -vnc :1</code></pre></div><p>From here I installed tightvnc and left my monitor and usb devices in the dust. Planning on getting one of these: </p><p><a href="http://www.ebay.com/itm/Headless-server-DVI-D-EDID-Plug-Linux-Windows-1920x1200-1920x1080-EDID-emulator-/201087766664" rel="nofollow">http://www.ebay.com/itm/Headless-server … 1087766664</a></p><p>With steam running I just enabled in game streaming: <a href="https://support.steampowered.com/kb_article.php?ref=3629-RIAV-1617" rel="nofollow">https://support.steampowered.com/kb_art … -RIAV-1617</a></p><p>Now I need to get steamOS as a network boot option for all my HTPCs so I can play games on the couch.</p> <p class="postedit"><em>Last edited by thelamer (2014-05-27 07:28:45)</em></p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1419638">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1419675" class="blockpost roweven"> <h2><span><span class="conr">#1852</span> <a href="viewtopic.php?pid=1419675#p1419675">2014-05-27 11:18:21</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=79534">zzz3000</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2014-02-16</span></dd> <dd><span>Posts: 12</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=79534">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>aw wrote:</cite><blockquote><div><div class="quotebox"><cite>Namelles_One wrote:</cite><blockquote><div><div class="quotebox"><cite>zzz3000 wrote:</cite><blockquote><div><p>I have the same problem with HD7750.<br />The problem with windows radeon driver dissapeared only after I had installed&#160; fedora rawhide, so I am waiting fedora 21.</p></div></blockquote></div><p>Thank you! &quot;Rawhide&quot; - it is a keyword ^^</p></div></blockquote></div><p>If you don&#039;t want to go bleeding edge for the whole distro, you can use the Fedora virt-preview repo: <a href="http://fedoraproject.org/wiki/Virtualization_Preview_Repository" rel="nofollow">http://fedoraproject.org/wiki/Virtualiz … Repository</a></p><p>It effectively gives you &quot;rawhide&quot; virt bits while keeping the rest on the latest stable version.</p></div></blockquote></div><p>Thanks. This is realy help me.</p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1419675">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1419752" class="blockpost rowodd"> <h2><span><span class="conr">#1853</span> <a href="viewtopic.php?pid=1419752#p1419752">2014-05-27 15:52:16</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=75590">aw</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2013-10-04</span></dd> <dd><span>Posts: 921</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=75590">Email</a></span> <span class="website"><a href="http://vfio.blogspot.com/" rel="nofollow">Website</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <p>Thanks for the report and details!</p><div class="quotebox"><cite>thelamer wrote:</cite><blockquote><div><div class="codebox"><pre><code>GRUB_CMDLINE_LINUX_DEFAULT=&quot;quiet intel_iommu=on vfio_iommu_type1.allow_unsafe_interrupts=1 i915.enable_hd_vgaarb=1&quot;</code></pre></div></div></blockquote></div><p>You shouldn not need vfio_iommu_type1.allow_unsafe_interrupts=1 on your hardware</p><div class="quotebox"><blockquote><div><p>Finally blacklist radeon: </p><div class="codebox"><pre><code>echo &quot;blacklist radeon&quot; &gt;&gt; /etc/modprobe.d/blacklist.conf</code></pre></div></div></blockquote></div><p>Some distros require rebuilding the initramfs after this or else the driver is loaded before we get to the rootfs</p><div class="quotebox"><blockquote><div><p>Now build seabios: </p><div class="codebox"><pre><code>git clone git://git.seabios.org/seabios.git seabios cd seabios/ make menuconfig (save and exit) make </code></pre></div><p>Resulting bios.bin in the out/ subfolder.</p></div></blockquote></div><p>Is this really needed?&#160; I don&#039;t know of anything wrong with the BIOS supplied by upstream QEMU.</p><div class="quotebox"><blockquote><div><p>Setup qemu.conf: (needed for the card to work properly) </p><p>/etc/qemu/qemu.conf </p><div class="codebox"><pre><code>group = &quot;root&quot; user = &quot;root&quot; clear_emulator_capabilities = 0</code></pre></div></div></blockquote></div><p>This is only needed for libvirt support, which you don&#039;t seem to be using, at least not yet.</p><div class="quotebox"><blockquote><div><p>Now I installed the virtio drivers found here: <a href="http://alt.fedoraproject.org/pub/alt/virtio-win/latest/images/" rel="nofollow">http://alt.fedoraproject.org/pub/alt/vi … st/images/</a></p><div class="codebox"><pre><code>/usr/local/bin/qemu-system-x86_64 -enable-kvm -M q35 -m 8192 -cpu host -smp 8,sockets=1,cores=4,threads=8 \ -bios /storage/OSs/seabios/out/bios.bin \ -boot menu=on \ -vga none \ -device ioh3420,bus=pcie.0,addr=1c.0,multifunction=on,port=1,chassis=1,id=root.1 \ -device vfio-pci,host=01:00.0,bus=root.1,addr=00.0,multifunction=on,x-vga=on \ -device vfio-pci,host=00:1b.0,bus=pcie.0 \ -device piix4-ide,bus=pcie.0,id=piix4-ide \ -device virtio-scsi-pci,id=storage -drive file=/storage/OSs/vm/storage.img,id=storage,format=raw \ -device ide-hd,bus=piix4-ide.0,drive=disk -drive file=/storage/OSs/vm/windows7.img,id=disk,format=raw \ -device ide-cd,bus=piix4-ide.1,drive=isocd -drive file=/storage/OSs/vm/virtio-win-0.1-74.iso,id=isocd \ -usb -usbdevice host:046d:c051 -usbdevice host:046d:c315 \ -net nic,model=virtio -net tap,ifname=tap0,script=no,downscript=no \ -vnc :1</code></pre></div><p>Here I added a disk image and changed my nic to virtio so I could easily install the drivers in windows 7 and poweroff.</p></div></blockquote></div><p>You can also pass the virtio ISO as a 2nd CD during install, load both the network and disk drivers during install, then you don&#039;t need to do this 2-step process.</p><div class="quotebox"><blockquote><div><p>From here I installed tightvnc and left my monitor and usb devices in the dust. Planning on getting one of these: </p><p><a href="http://www.ebay.com/itm/Headless-server-DVI-D-EDID-Plug-Linux-Windows-1920x1200-1920x1080-EDID-emulator-/201087766664" rel="nofollow">http://www.ebay.com/itm/Headless-server … 1087766664</a></p></div></blockquote></div><p>Heh, neat.&#160; Thanks</p> </div> <div class="postsignature postmsg"><hr /><p><a href="http://vfio.blogspot.com" rel="nofollow">http://vfio.blogspot.com</a><br />Looking for a more open forum to discuss vfio related uses?&#160; Try <a href="https://www.redhat.com/mailman/listinfo/vfio-users" rel="nofollow">https://www.redhat.com/mailman/listinfo/vfio-users</a></p></div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1419752">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1419855" class="blockpost roweven"> <h2><span><span class="conr">#1854</span> <a href="viewtopic.php?pid=1419855#p1419855">2014-05-27 21:57:01</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=79237">mbroemme</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>From: Cologne</span></dd> <dd><span>Registered: 2014-02-05</span></dd> <dd><span>Posts: 39</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=79237">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <p>Alex, so anymore ideas to my lcpsi output at post #1849 and #1850?</p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1419855">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1419869" class="blockpost rowodd"> <h2><span><span class="conr">#1855</span> <a href="viewtopic.php?pid=1419869#p1419869">2014-05-27 22:36:23</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=75590">aw</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2013-10-04</span></dd> <dd><span>Posts: 921</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=75590">Email</a></span> <span class="website"><a href="http://vfio.blogspot.com/" rel="nofollow">Website</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>mbroemme wrote:</cite><blockquote><div><p>Alex, so anymore ideas to my lcpsi output at post #1849 and #1850?</p></div></blockquote></div><p>None yet.&#160; I was going to suggest that we should save/restore ATS support as part of bus reset path since that&#039;s the only notable difference in #1849, but then I found that we already do that, so I don&#039;t know why it&#039;s showing up disabled.&#160; For #1850, does a host suspend/resume make it work or is that just another failing case?&#160; The differences in the correctable error status registers don&#039;t seem like they should make a difference.</p> </div> <div class="postsignature postmsg"><hr /><p><a href="http://vfio.blogspot.com" rel="nofollow">http://vfio.blogspot.com</a><br />Looking for a more open forum to discuss vfio related uses?&#160; Try <a href="https://www.redhat.com/mailman/listinfo/vfio-users" rel="nofollow">https://www.redhat.com/mailman/listinfo/vfio-users</a></p></div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1419869">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1419871" class="blockpost roweven"> <h2><span><span class="conr">#1856</span> <a href="viewtopic.php?pid=1419871#p1419871">2014-05-27 22:47:35</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=79237">mbroemme</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>From: Cologne</span></dd> <dd><span>Registered: 2014-02-05</span></dd> <dd><span>Posts: 39</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=79237">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>aw wrote:</cite><blockquote><div><p>None yet.&#160; I was going to suggest that we should save/restore ATS support as part of bus reset path since that&#039;s the only notable difference in #1849, but then I found that we already do that, so I don&#039;t know why it&#039;s showing up disabled.&#160; For #1850, does a host suspend/resume make it work or is that just another failing case?&#160; The differences in the correctable error status registers don&#039;t seem like they should make a difference.</p></div></blockquote></div><p>In #1850 it is another working case. However I&#039;m not sure if radeon driver maintainer might help as they may know some magic of these devices.</p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1419871">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1419956" class="blockpost rowodd"> <h2><span><span class="conr">#1857</span> <a href="viewtopic.php?pid=1419956#p1419956">2014-05-28 06:53:53</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=82341">buraktamturk</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2014-05-28</span></dd> <dd><span>Posts: 13</span></dd> <dd class="usercontacts"><span class="email"><a href="mailto:burak@tamturk.in">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <p>Hello,</p><p>I want to passthrought my ATI radeon 38xx card to a KVM guest (windows), host is using i7&#039;s onboard video card.</p><p>Blacklisted radeon driver, and successfully bind these two driver to vfio-pci. (via the script in first post)</p><div class="codebox"><pre><code>root@robin:~# lspci | grep ATI 01:00.0 VGA compatible controller: Advanced Micro Devices, Inc. [AMD/ATI] RV670 [Radeon HD 3690/3850] 01:00.1 Audio device: Advanced Micro Devices, Inc. [AMD/ATI] RV670/680 HDMI Audio [Radeon HD 3690/3800 Series]</code></pre></div><p>Getting this error:</p><div class="codebox"><pre><code>Error starting domain: internal error: early end of file from monitor: possible problem: qemu-system-x86_64: -device vfio-pci,host=01:00.0,id=hostdev2,bus=pci.0,addr=0x6: vfio: error, group 6 is not viable, please ensure all devices within the iommu_group are bound to their vfio bus driver. qemu-system-x86_64: -device vfio-pci,host=01:00.0,id=hostdev2,bus=pci.0,addr=0x6: vfio: failed to get group 6 qemu-system-x86_64: -device vfio-pci,host=01:00.0,id=hostdev2,bus=pci.0,addr=0x6: Device initialization failed. qemu-system-x86_64: -device vfio-pci,host=01:00.0,id=hostdev2,bus=pci.0,addr=0x6: Device &#039;vfio-pci&#039; could not be initialized</code></pre></div><p>All of devices are listed in same iommu_group, including my secondary network and onboard network card and graphics.</p><div class="codebox"><pre><code>root@robin:/dev# ls /sys/bus/pci/devices/0000\:01\:00.0/iommu_group/devices/ 0000:00:1c.0 0000:00:1c.5 0000:01:00.0 0000:02:00.0 0000:04:00.0 0000:00:1c.4 0000:00:1c.6 0000:01:00.1 0000:03:00.0</code></pre></div><div class="codebox"><pre><code>00:00.0 Host bridge: Intel Corporation Xeon E3-1200 v2/3rd Gen Core processor DRAM Controller (rev 09) 00:02.0 VGA compatible controller: Intel Corporation Xeon E3-1200 v2/3rd Gen Core processor Graphics Controller (rev 09) 00:14.0 USB controller: Intel Corporation 7 Series/C210 Series Chipset Family USB xHCI Host Controller (rev 04) 00:16.0 Communication controller: Intel Corporation 7 Series/C210 Series Chipset Family MEI Controller #1 (rev 04) 00:1a.0 USB controller: Intel Corporation 7 Series/C210 Series Chipset Family USB Enhanced Host Controller #2 (rev 04) 00:1b.0 Audio device: Intel Corporation 7 Series/C210 Series Chipset Family High Definition Audio Controller (rev 04) 00:1c.0 PCI bridge: Intel Corporation 7 Series/C210 Series Chipset Family PCI Express Root Port 1 (rev c4) 00:1c.4 PCI bridge: Intel Corporation 7 Series/C210 Series Chipset Family PCI Express Root Port 5 (rev c4) 00:1c.5 PCI bridge: Intel Corporation 7 Series/C210 Series Chipset Family PCI Express Root Port 6 (rev c4) 00:1c.6 PCI bridge: Intel Corporation 82801 PCI Bridge (rev c4) 00:1d.0 USB controller: Intel Corporation 7 Series/C210 Series Chipset Family USB Enhanced Host Controller #1 (rev 04) 00:1f.0 ISA bridge: Intel Corporation Z77 Express Chipset LPC Controller (rev 04) 00:1f.2 IDE interface: Intel Corporation 7 Series/C210 Series Chipset Family 4-port SATA Controller [IDE mode] (rev 04) 00:1f.3 SMBus: Intel Corporation 7 Series/C210 Series Chipset Family SMBus Controller (rev 04) 00:1f.5 IDE interface: Intel Corporation 7 Series/C210 Series Chipset Family 2-port SATA Controller [IDE mode] (rev 04) 01:00.0 VGA compatible controller: Advanced Micro Devices, Inc. [AMD/ATI] RV670 [Radeon HD 3690/3850] 01:00.1 Audio device: Advanced Micro Devices, Inc. [AMD/ATI] RV670/680 HDMI Audio [Radeon HD 3690/3800 Series] 02:00.0 Ethernet controller: Qualcomm Atheros AR8161 Gigabit Ethernet (rev 10) 03:00.0 Ethernet controller: Realtek Semiconductor Co., Ltd. RTL8111/8168/8411 PCI Express Gigabit Ethernet Controller (rev 06) 04:00.0 PCI bridge: Intel Corporation 82801 PCI Bridge (rev 41)</code></pre></div><p>My kernel cmdline</p><div class="codebox"><pre><code>root=UUID=94c11fcb-ec91-4b49-b21d-d2cb08d5929e ro quiet rootfstype=xfs add_efi_memmap intel_iommu=on initrd=\EFI\debian\initrd.img</code></pre></div><div class="codebox"><pre><code>Linux robin 3.14-1-amd64 #1 SMP Debian 3.14.4-1 (2014-05-13) x86_64 GNU/Linux</code></pre></div><p>How i can only pass the ATI card to the guest? Not all the devices in iommu group.</p><p>Thanks</p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1419956">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1419982" class="blockpost roweven"> <h2><span><span class="conr">#1858</span> <a href="viewtopic.php?pid=1419982#p1419982">2014-05-28 10:32:15</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=79237">mbroemme</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>From: Cologne</span></dd> <dd><span>Registered: 2014-02-05</span></dd> <dd><span>Posts: 39</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=79237">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>buraktamturk wrote:</cite><blockquote><div><p>How i can only pass the ATI card to the guest? Not all the devices in iommu group.</p></div></blockquote></div><p>You need the ACS override patch for your hardware. It is not in mainline Linux kernel (neither in 3.14 nor in upcoming 3.15). You can get it from <a href="https://lkml.org/lkml/2013/5/30/513" rel="nofollow">https://lkml.org/lkml/2013/5/30/513</a> or in the linux-mainline archive from #1 post in this thread. You need to patch and rebuild your kernel for it.</p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1419982">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1420018" class="blockpost rowodd"> <h2><span><span class="conr">#1859</span> <a href="viewtopic.php?pid=1420018#p1420018">2014-05-28 12:15:20</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=82341">buraktamturk</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2014-05-28</span></dd> <dd><span>Posts: 13</span></dd> <dd class="usercontacts"><span class="email"><a href="mailto:burak@tamturk.in">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>mbroemme wrote:</cite><blockquote><div><div class="quotebox"><cite>buraktamturk wrote:</cite><blockquote><div><p>How i can only pass the ATI card to the guest? Not all the devices in iommu group.</p></div></blockquote></div><p>You need the ACS override patch for your hardware. It is not in mainline Linux kernel (neither in 3.14 nor in upcoming 3.15). You can get it from <a href="https://lkml.org/lkml/2013/5/30/513" rel="nofollow">https://lkml.org/lkml/2013/5/30/513</a> or in the linux-mainline archive from #1 post in this thread. You need to patch and rebuild your kernel for it.</p></div></blockquote></div><p>Thank you, applied patches and rebuilded the kernel, it worked. My new cmdline is</p><div class="codebox"><pre><code>root=UUID=94c11fcb-ec91-4b49-b21d-d2cb08d5929e ro quiet rootfstype=xfs add_efi_memmap intel_iommu=on initrd=\EFI\debian\initrd.img vfio_iommu_type1.allow_unsafe_interrupts=1 kvm.ignore_msrs=1 pci-stub.ids=1002:9505,1002:aa18 pcie_acs_override=downstream</code></pre></div><p>Guest see the graphics card but just used the emulated one, but i see there is two Standard VGA Adapter, i think guest excepting install the drivers to show up the monitor (or excepting to me remove regular one).</p><p>Now when i tried to stop the virtual machine i get following error (dmesg output of error) and kvm, libvirt is complately hanged until i reboot the computer. Is there anything i miss?</p><div class="codebox"><pre class="vscroll"><code>[ 639.297949] BUG: unable to handle kernel paging request at 000000fd000000fc [ 639.298021] IP: [&lt;000000fd000000fc&gt;] 0xfd000000fc [ 639.298066] PGD 0 [ 639.298083] Oops: 0010 [#1] SMP [ 639.298111] Modules linked in: tun nfsd auth_rpcgss oid_registry nfs_acl nfs lockd fscache sunrpc bridge 8021q garp stp mrp llc snd_hda_codec_via snd_hda_codec_generic snd_hda_codec_hdmi nls_utf8 nls_cp437 vfat fat x86_pkg_temp_thermal intel_powerclamp iTCO_wdt iTCO_vendor_support ppdev intel_rapl coretemp crc32_pclmul crc32c_intel ghash_clmulni_intel aesni_intel joydev snd_hda_intel aes_x86_64 lrw snd_hda_codec gf128mul snd_hwdep glue_helper ablk_helper cryptd snd_pcm efi_pstore evdev psmouse pcspkr serio_raw snd_timer snd soundcore i2c_i801 efivars lpc_ich i915 mfd_core drm_kms_helper drm i2c_algo_bit mei_me i2c_core mei parport_pc tpm_infineon battery parport tpm_tis tpm video button processor ip6table_filter ip6_tables ipt_REJECT xt_tcpudp xt_limit nf_conntrack_ipv4 nf_defrag_ipv4 xt_conntrack nf_conntrack iptable_filter ip_tables x_tables fuse autofs4 xfs crc32c libcrc32c dm_mod sd_mod crc_t10dif crct10dif_generic hid_generic ata_generic usbhid hid crct10dif_pclmul crct10dif_common ata_piix libata scsi_mod ehci_pci xhci_hcd ehci_hcd r8169 alx mii mdio usbcore thermal fan usb_common thermal_sys [ 639.298909] CPU: 0 PID: 2361 Comm: libvirtd Tainted: G W 3.14.4-rt5 #3 [ 639.298951] Hardware name: Gigabyte Technology Co., Ltd. To be filled by O.E.M./Z77M-D3H, BIOS F15a 12/31/2013 [ 639.299005] task: ffff88041dcaac80 ti: ffff88041ce52000 task.ti: ffff88041ce52000 [ 639.299046] RIP: 0010:[&lt;000000fd000000fc&gt;] [&lt;000000fd000000fc&gt;] 0xfd000000fc [ 639.299091] RSP: 0018:ffff88041ce53de0 EFLAGS: 00010202 [ 639.299121] RAX: 0000000000000008 RBX: ffff88041e520098 RCX: 0000000000000000 [ 639.299160] RDX: 000000fd000000fc RSI: ffff88041e520098 RDI: ffff88041e520098 [ 639.299200] RBP: ffff88041e520140 R08: 0000000000000000 R09: 0000000000000008 [ 639.299239] R10: 0000000000000074 R11: ffff88041ce53ba6 R12: 0000000000000004 [ 639.299278] R13: 0000000000000000 R14: 000000000000000c R15: ffff88041c01e810 [ 639.299318] FS: 00007f3da4c98700(0000) GS:ffff88042f200000(0000) knlGS:0000000000000000 [ 639.299362] CS: 0010 DS: 0000 ES: 0000 CR0: 0000000080050033 [ 639.299394] CR2: 000000fd000000fc CR3: 000000041b183000 CR4: 00000000001407e0 [ 639.299433] Stack: [ 639.299448] ffffffff813ab9d7 0000000000000004 ffff88041e520098 0000000000000004 [ 639.299497] ffffffff813ac3b8 0000000000000004 ffff88041e520098 ffff88041e520140 [ 639.299546] 0000000000000246 ffffffff813ac504 ffff88041e520098 ffffffff81885b60 [ 639.299594] Call Trace: [ 639.299617] [&lt;ffffffff813ab9d7&gt;] ? __rpm_callback+0x27/0x70 [ 639.299653] [&lt;ffffffff813ac3b8&gt;] ? rpm_idle+0x198/0x290 [ 639.299686] [&lt;ffffffff813ac504&gt;] ? __pm_runtime_idle+0x54/0x80 [ 639.299721] [&lt;ffffffff812ee2e7&gt;] ? pci_device_remove+0x67/0xa0 [ 639.299757] [&lt;ffffffff813a1e45&gt;] ? __device_release_driver+0x75/0xf0 [ 639.299794] [&lt;ffffffff813a1ed9&gt;] ? device_release_driver+0x19/0x30 [ 639.299831] [&lt;ffffffff813a0e35&gt;] ? unbind_store+0xb5/0xe0 [ 639.299865] [&lt;ffffffff81233c2e&gt;] ? kernfs_fop_write+0xbe/0x120 [ 639.299901] [&lt;ffffffff811c5080&gt;] ? vfs_write+0xb0/0x1e0 [ 639.299932] [&lt;ffffffff811c5a2d&gt;] ? SyS_write+0x3d/0xa0 [ 639.299965] [&lt;ffffffff81508e39&gt;] ? system_call_fastpath+0x16/0x1b [ 639.299999] Code: Bad RIP value. [ 639.300024] RIP [&lt;000000fd000000fc&gt;] 0xfd000000fc [ 639.300058] RSP &lt;ffff88041ce53de0&gt; [ 639.300079] CR2: 000000fd000000fc [ 639.313543] ---[ end trace 1613cc056b6b661d ]---</code></pre></div> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1420018">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1420028" class="blockpost roweven"> <h2><span><span class="conr">#1860</span> <a href="viewtopic.php?pid=1420028#p1420028">2014-05-28 12:35:51</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=82341">buraktamturk</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2014-05-28</span></dd> <dd><span>Posts: 13</span></dd> <dd class="usercontacts"><span class="email"><a href="mailto:burak@tamturk.in">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <p>Anyone knows how to add &quot;,multifunction=on,x-vga=on&quot; to pci config on virsh xml configuration file?</p><p>My configuration file is follows</p><div class="codebox"><pre class="vscroll"><code>&lt;domain type=&#039;kvm&#039;&gt; &lt;name&gt;Windows7&lt;/name&gt; &lt;uuid&gt;42716343-35d0-e786-5a86-d6d66dc6ced2&lt;/uuid&gt; &lt;memory unit=&#039;KiB&#039;&gt;4194304&lt;/memory&gt; &lt;currentMemory unit=&#039;KiB&#039;&gt;4194304&lt;/currentMemory&gt; &lt;vcpu placement=&#039;static&#039;&gt;4&lt;/vcpu&gt; &lt;os&gt; &lt;type arch=&#039;x86_64&#039; machine=&#039;pc-i440fx-2.0&#039;&gt;hvm&lt;/type&gt; &lt;loader&gt;/usr/share/ovmf/OVMF.fd&lt;/loader&gt; &lt;boot dev=&#039;cdrom&#039;/&gt; &lt;boot dev=&#039;hd&#039;/&gt; &lt;/os&gt; &lt;features&gt; &lt;acpi/&gt; &lt;apic/&gt; &lt;pae/&gt; &lt;/features&gt; &lt;clock offset=&#039;localtime&#039;/&gt; &lt;on_poweroff&gt;destroy&lt;/on_poweroff&gt; &lt;on_reboot&gt;restart&lt;/on_reboot&gt; &lt;on_crash&gt;restart&lt;/on_crash&gt; &lt;devices&gt; &lt;emulator&gt;/usr/bin/kvm&lt;/emulator&gt; &lt;disk type=&#039;file&#039; device=&#039;cdrom&#039;&gt; &lt;driver name=&#039;qemu&#039; type=&#039;raw&#039;/&gt; &lt;source file=&#039;/storage/share/programlar/ISO/en_windows_8.1_professional_vl_with_update_x64_dvd_4065194.iso&#039;/&gt; &lt;target dev=&#039;hda&#039; bus=&#039;ide&#039;/&gt; &lt;readonly/&gt; &lt;address type=&#039;drive&#039; controller=&#039;0&#039; bus=&#039;0&#039; target=&#039;0&#039; unit=&#039;0&#039;/&gt; &lt;/disk&gt; &lt;disk type=&#039;file&#039; device=&#039;cdrom&#039;&gt; &lt;driver name=&#039;qemu&#039; type=&#039;raw&#039;/&gt; &lt;source file=&#039;/home/buraktamturk/Downloads/virtio-win-0.1-74.iso&#039;/&gt; &lt;target dev=&#039;hdc&#039; bus=&#039;ide&#039;/&gt; &lt;readonly/&gt; &lt;address type=&#039;drive&#039; controller=&#039;0&#039; bus=&#039;1&#039; target=&#039;0&#039; unit=&#039;0&#039;/&gt; &lt;/disk&gt; &lt;disk type=&#039;file&#039; device=&#039;disk&#039;&gt; &lt;driver name=&#039;qemu&#039; type=&#039;raw&#039;/&gt; &lt;source file=&#039;/storage/vm/disk/Windows7_C.img&#039;/&gt; &lt;target dev=&#039;vda&#039; bus=&#039;virtio&#039;/&gt; &lt;address type=&#039;pci&#039; domain=&#039;0x0000&#039; bus=&#039;0x00&#039; slot=&#039;0x03&#039; function=&#039;0x0&#039;/&gt; &lt;/disk&gt; &lt;controller type=&#039;usb&#039; index=&#039;0&#039;&gt; &lt;address type=&#039;pci&#039; domain=&#039;0x0000&#039; bus=&#039;0x00&#039; slot=&#039;0x01&#039; function=&#039;0x2&#039;/&gt; &lt;/controller&gt; &lt;controller type=&#039;pci&#039; index=&#039;0&#039; model=&#039;pci-root&#039;/&gt; &lt;controller type=&#039;ide&#039; index=&#039;0&#039;&gt; &lt;address type=&#039;pci&#039; domain=&#039;0x0000&#039; bus=&#039;0x00&#039; slot=&#039;0x01&#039; function=&#039;0x1&#039;/&gt; &lt;/controller&gt; &lt;controller type=&#039;virtio-serial&#039; index=&#039;0&#039;&gt; &lt;address type=&#039;pci&#039; domain=&#039;0x0000&#039; bus=&#039;0x00&#039; slot=&#039;0x04&#039; function=&#039;0x0&#039;/&gt; &lt;/controller&gt; &lt;interface type=&#039;bridge&#039;&gt; &lt;mac address=&#039;52:54:00:76:17:e2&#039;/&gt; &lt;source bridge=&#039;br0&#039;/&gt; &lt;model type=&#039;virtio&#039;/&gt; &lt;address type=&#039;pci&#039; domain=&#039;0x0000&#039; bus=&#039;0x00&#039; slot=&#039;0x05&#039; function=&#039;0x0&#039;/&gt; &lt;/interface&gt; &lt;channel type=&#039;spicevmc&#039;&gt; &lt;target type=&#039;virtio&#039; name=&#039;com.redhat.spice.0&#039;/&gt; &lt;address type=&#039;virtio-serial&#039; controller=&#039;0&#039; bus=&#039;0&#039; port=&#039;1&#039;/&gt; &lt;/channel&gt; &lt;input type=&#039;tablet&#039; bus=&#039;usb&#039;/&gt; &lt;hostdev mode=&#039;subsystem&#039; type=&#039;usb&#039; managed=&#039;yes&#039;&gt; &lt;source&gt; &lt;vendor id=&#039;0x045e&#039;/&gt; &lt;product id=&#039;0x0752&#039;/&gt; &lt;/source&gt; &lt;/hostdev&gt; &lt;hostdev mode=&#039;subsystem&#039; type=&#039;usb&#039; managed=&#039;yes&#039;&gt; &lt;source&gt; &lt;vendor id=&#039;0x045e&#039;/&gt; &lt;product id=&#039;0x00cb&#039;/&gt; &lt;/source&gt; &lt;/hostdev&gt; &lt;hostdev mode=&#039;subsystem&#039; type=&#039;pci&#039; managed=&#039;yes&#039;&gt; &lt;source&gt; &lt;address domain=&#039;0x0000&#039; bus=&#039;0x01&#039; slot=&#039;0x00&#039; function=&#039;0x0&#039;/&gt; &lt;/source&gt; &lt;address type=&#039;pci&#039; domain=&#039;0x0000&#039; bus=&#039;0x00&#039; slot=&#039;0x06&#039; function=&#039;0x0&#039;/&gt; &lt;/hostdev&gt; &lt;hostdev mode=&#039;subsystem&#039; type=&#039;pci&#039; managed=&#039;yes&#039;&gt; &lt;source&gt; &lt;address domain=&#039;0x0000&#039; bus=&#039;0x01&#039; slot=&#039;0x00&#039; function=&#039;0x1&#039;/&gt; &lt;/source&gt; &lt;address type=&#039;pci&#039; domain=&#039;0x0000&#039; bus=&#039;0x00&#039; slot=&#039;0x08&#039; function=&#039;0x0&#039;/&gt; &lt;/hostdev&gt; &lt;memballoon model=&#039;virtio&#039;&gt; &lt;address type=&#039;pci&#039; domain=&#039;0x0000&#039; bus=&#039;0x00&#039; slot=&#039;0x07&#039; function=&#039;0x0&#039;/&gt; &lt;/memballoon&gt; &lt;/devices&gt; &lt;/domain&gt;</code></pre></div><p>Thanks</p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1420028">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1420032" class="blockpost rowodd"> <h2><span><span class="conr">#1861</span> <a href="viewtopic.php?pid=1420032#p1420032">2014-05-28 12:58:26</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=80387">dwe11er</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2014-03-18</span></dd> <dd><span>Posts: 73</span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>buraktamturk wrote:</cite><blockquote><div><p>Anyone knows how to add &quot;,multifunction=on,x-vga=on&quot; to pci config on virsh xml configuration file?</p><p>My configuration file is follows</p><div class="codebox"><pre class="vscroll"><code>&lt;domain type=&#039;kvm&#039;&gt; &lt;name&gt;Windows7&lt;/name&gt; &lt;uuid&gt;42716343-35d0-e786-5a86-d6d66dc6ced2&lt;/uuid&gt; &lt;memory unit=&#039;KiB&#039;&gt;4194304&lt;/memory&gt; &lt;currentMemory unit=&#039;KiB&#039;&gt;4194304&lt;/currentMemory&gt; &lt;vcpu placement=&#039;static&#039;&gt;4&lt;/vcpu&gt; &lt;os&gt; &lt;type arch=&#039;x86_64&#039; machine=&#039;pc-i440fx-2.0&#039;&gt;hvm&lt;/type&gt; &lt;loader&gt;/usr/share/ovmf/OVMF.fd&lt;/loader&gt; &lt;boot dev=&#039;cdrom&#039;/&gt; &lt;boot dev=&#039;hd&#039;/&gt; &lt;/os&gt; &lt;features&gt; &lt;acpi/&gt; &lt;apic/&gt; &lt;pae/&gt; &lt;/features&gt; &lt;clock offset=&#039;localtime&#039;/&gt; &lt;on_poweroff&gt;destroy&lt;/on_poweroff&gt; &lt;on_reboot&gt;restart&lt;/on_reboot&gt; &lt;on_crash&gt;restart&lt;/on_crash&gt; &lt;devices&gt; &lt;emulator&gt;/usr/bin/kvm&lt;/emulator&gt; &lt;disk type=&#039;file&#039; device=&#039;cdrom&#039;&gt; &lt;driver name=&#039;qemu&#039; type=&#039;raw&#039;/&gt; &lt;source file=&#039;/storage/share/programlar/ISO/en_windows_8.1_professional_vl_with_update_x64_dvd_4065194.iso&#039;/&gt; &lt;target dev=&#039;hda&#039; bus=&#039;ide&#039;/&gt; &lt;readonly/&gt; &lt;address type=&#039;drive&#039; controller=&#039;0&#039; bus=&#039;0&#039; target=&#039;0&#039; unit=&#039;0&#039;/&gt; &lt;/disk&gt; &lt;disk type=&#039;file&#039; device=&#039;cdrom&#039;&gt; &lt;driver name=&#039;qemu&#039; type=&#039;raw&#039;/&gt; &lt;source file=&#039;/home/buraktamturk/Downloads/virtio-win-0.1-74.iso&#039;/&gt; &lt;target dev=&#039;hdc&#039; bus=&#039;ide&#039;/&gt; &lt;readonly/&gt; &lt;address type=&#039;drive&#039; controller=&#039;0&#039; bus=&#039;1&#039; target=&#039;0&#039; unit=&#039;0&#039;/&gt; &lt;/disk&gt; &lt;disk type=&#039;file&#039; device=&#039;disk&#039;&gt; &lt;driver name=&#039;qemu&#039; type=&#039;raw&#039;/&gt; &lt;source file=&#039;/storage/vm/disk/Windows7_C.img&#039;/&gt; &lt;target dev=&#039;vda&#039; bus=&#039;virtio&#039;/&gt; &lt;address type=&#039;pci&#039; domain=&#039;0x0000&#039; bus=&#039;0x00&#039; slot=&#039;0x03&#039; function=&#039;0x0&#039;/&gt; &lt;/disk&gt; &lt;controller type=&#039;usb&#039; index=&#039;0&#039;&gt; &lt;address type=&#039;pci&#039; domain=&#039;0x0000&#039; bus=&#039;0x00&#039; slot=&#039;0x01&#039; function=&#039;0x2&#039;/&gt; &lt;/controller&gt; &lt;controller type=&#039;pci&#039; index=&#039;0&#039; model=&#039;pci-root&#039;/&gt; &lt;controller type=&#039;ide&#039; index=&#039;0&#039;&gt; &lt;address type=&#039;pci&#039; domain=&#039;0x0000&#039; bus=&#039;0x00&#039; slot=&#039;0x01&#039; function=&#039;0x1&#039;/&gt; &lt;/controller&gt; &lt;controller type=&#039;virtio-serial&#039; index=&#039;0&#039;&gt; &lt;address type=&#039;pci&#039; domain=&#039;0x0000&#039; bus=&#039;0x00&#039; slot=&#039;0x04&#039; function=&#039;0x0&#039;/&gt; &lt;/controller&gt; &lt;interface type=&#039;bridge&#039;&gt; &lt;mac address=&#039;52:54:00:76:17:e2&#039;/&gt; &lt;source bridge=&#039;br0&#039;/&gt; &lt;model type=&#039;virtio&#039;/&gt; &lt;address type=&#039;pci&#039; domain=&#039;0x0000&#039; bus=&#039;0x00&#039; slot=&#039;0x05&#039; function=&#039;0x0&#039;/&gt; &lt;/interface&gt; &lt;channel type=&#039;spicevmc&#039;&gt; &lt;target type=&#039;virtio&#039; name=&#039;com.redhat.spice.0&#039;/&gt; &lt;address type=&#039;virtio-serial&#039; controller=&#039;0&#039; bus=&#039;0&#039; port=&#039;1&#039;/&gt; &lt;/channel&gt; &lt;input type=&#039;tablet&#039; bus=&#039;usb&#039;/&gt; &lt;hostdev mode=&#039;subsystem&#039; type=&#039;usb&#039; managed=&#039;yes&#039;&gt; &lt;source&gt; &lt;vendor id=&#039;0x045e&#039;/&gt; &lt;product id=&#039;0x0752&#039;/&gt; &lt;/source&gt; &lt;/hostdev&gt; &lt;hostdev mode=&#039;subsystem&#039; type=&#039;usb&#039; managed=&#039;yes&#039;&gt; &lt;source&gt; &lt;vendor id=&#039;0x045e&#039;/&gt; &lt;product id=&#039;0x00cb&#039;/&gt; &lt;/source&gt; &lt;/hostdev&gt; &lt;hostdev mode=&#039;subsystem&#039; type=&#039;pci&#039; managed=&#039;yes&#039;&gt; &lt;source&gt; &lt;address domain=&#039;0x0000&#039; bus=&#039;0x01&#039; slot=&#039;0x00&#039; function=&#039;0x0&#039;/&gt; &lt;/source&gt; &lt;address type=&#039;pci&#039; domain=&#039;0x0000&#039; bus=&#039;0x00&#039; slot=&#039;0x06&#039; function=&#039;0x0&#039;/&gt; &lt;/hostdev&gt; &lt;hostdev mode=&#039;subsystem&#039; type=&#039;pci&#039; managed=&#039;yes&#039;&gt; &lt;source&gt; &lt;address domain=&#039;0x0000&#039; bus=&#039;0x01&#039; slot=&#039;0x00&#039; function=&#039;0x1&#039;/&gt; &lt;/source&gt; &lt;address type=&#039;pci&#039; domain=&#039;0x0000&#039; bus=&#039;0x00&#039; slot=&#039;0x08&#039; function=&#039;0x0&#039;/&gt; &lt;/hostdev&gt; &lt;memballoon model=&#039;virtio&#039;&gt; &lt;address type=&#039;pci&#039; domain=&#039;0x0000&#039; bus=&#039;0x00&#039; slot=&#039;0x07&#039; function=&#039;0x0&#039;/&gt; &lt;/memballoon&gt; &lt;/devices&gt; &lt;/domain&gt;</code></pre></div><p>Thanks</p></div></blockquote></div><p>Devices you want to pass have to be defined using qemu:commandlie. Here is my config: <a href="http://pastebin.com/ZVwvv9Hc" rel="nofollow">http://pastebin.com/ZVwvv9Hc</a></p><p>Because of this, you have to bind them to vfio by hand. You can use my libvirt&#039;s hook script to bind these devices to vfio (or bind HD Audio to vfio and rebind it to host&#039;s driver after vm is down; should work with every pci device): <a href="http://pastebin.com/fznjWcZ4" rel="nofollow">http://pastebin.com/fznjWcZ4</a> (put it as /etc/libvirt/hooks/qemu and change device id&#039;s).</p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1420032">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1420055" class="blockpost roweven"> <h2><span><span class="conr">#1862</span> <a href="viewtopic.php?pid=1420055#p1420055">2014-05-28 14:25:52</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=82341">buraktamturk</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2014-05-28</span></dd> <dd><span>Posts: 13</span></dd> <dd class="usercontacts"><span class="email"><a href="mailto:burak@tamturk.in">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>dwe11er wrote:</cite><blockquote><div><p>Devices you want to pass have to be defined using qemu:commandlie. Here is my config: <a href="http://pastebin.com/ZVwvv9Hc" rel="nofollow">http://pastebin.com/ZVwvv9Hc</a></p><p>Because of this, you have to bind them to vfio by hand. You can use my libvirt&#039;s hook script to bind these devices to vfio (or bind HD Audio to vfio and rebind it to host&#039;s driver after vm is down; should work with every pci device): <a href="http://pastebin.com/fznjWcZ4" rel="nofollow">http://pastebin.com/fznjWcZ4</a> (put it as /etc/libvirt/hooks/qemu and change device id&#039;s).</p></div></blockquote></div><p>Very thanks.</p><p>I feel very stupid. I can&#039;t find the bus that graphics card attached.</p><div class="codebox"><pre><code> &lt;qemu:commandline&gt; &lt;qemu:arg value=&#039;-device&#039;/&gt; &lt;qemu:arg value=&#039;vfio-pci,host=01:00.0,bus=root.1,addr=00.0,multifunction=on,x-vga=on&#039;/&gt; &lt;/qemu:commandline&gt;</code></pre></div><p>I get &quot;Bus &#039;root.1&#039; not found&quot;, i can&#039;t find the bus with lspci. (tried several ones including root.0 to 5 and not giving bus number but didn&#039;t do the trick)</p><p>How i can find it? The device i want to attach is Advanced Micro Devices, Inc. [AMD/ATI] RV670 [Radeon HD 3690/3850]</p><p>Thank you again,</p><p>lspci output</p><div class="codebox"><pre class="vscroll"><code>00:00.0 Host bridge: Intel Corporation Xeon E3-1200 v2/3rd Gen Core processor DRAM Controller (rev 09) Subsystem: Gigabyte Technology Co., Ltd Device 5000 Flags: bus master, fast devsel, latency 0 Capabilities: [e0] Vendor Specific Information: Len=0c &lt;?&gt; 00:02.0 VGA compatible controller: Intel Corporation Xeon E3-1200 v2/3rd Gen Core processor Graphics Controller (rev 09) (prog-if 00 [VGA controller]) Subsystem: Gigabyte Technology Co., Ltd Device d000 Flags: bus master, fast devsel, latency 0, IRQ 45 Memory at f7800000 (64-bit, non-prefetchable) [size=4M] Memory at d0000000 (64-bit, prefetchable) [size=256M] I/O ports at f000 [size=64] Expansion ROM at &lt;unassigned&gt; [disabled] Capabilities: [90] MSI: Enable+ Count=1/1 Maskable- 64bit- Capabilities: [d0] Power Management version 2 Capabilities: [a4] PCI Advanced Features Kernel driver in use: i915 00:14.0 USB controller: Intel Corporation 7 Series/C210 Series Chipset Family USB xHCI Host Controller (rev 04) (prog-if 30 [XHCI]) Subsystem: Gigabyte Technology Co., Ltd Device 5007 Flags: bus master, medium devsel, latency 0, IRQ 42 Memory at f7f00000 (64-bit, non-prefetchable) [size=64K] Capabilities: [70] Power Management version 2 Capabilities: [80] MSI: Enable+ Count=1/8 Maskable- 64bit+ Kernel driver in use: xhci_hcd 00:16.0 Communication controller: Intel Corporation 7 Series/C210 Series Chipset Family MEI Controller #1 (rev 04) Subsystem: Gigabyte Technology Co., Ltd Device 1c3a Flags: bus master, fast devsel, latency 0, IRQ 44 Memory at f7f19000 (64-bit, non-prefetchable) [size=16] Capabilities: [50] Power Management version 3 Capabilities: [8c] MSI: Enable+ Count=1/1 Maskable- 64bit+ Kernel driver in use: mei_me 00:1a.0 USB controller: Intel Corporation 7 Series/C210 Series Chipset Family USB Enhanced Host Controller #2 (rev 04) (prog-if 20 [EHCI]) Subsystem: Gigabyte Technology Co., Ltd Device 5006 Flags: bus master, medium devsel, latency 0, IRQ 16 Memory at f7f17000 (32-bit, non-prefetchable) [size=1K] Capabilities: [50] Power Management version 2 Capabilities: [58] Debug port: BAR=1 offset=00a0 Capabilities: [98] PCI Advanced Features Kernel driver in use: ehci-pci 00:1b.0 Audio device: Intel Corporation 7 Series/C210 Series Chipset Family High Definition Audio Controller (rev 04) Subsystem: Gigabyte Technology Co., Ltd Device a014 Flags: bus master, fast devsel, latency 0, IRQ 46 Memory at f7f10000 (64-bit, non-prefetchable) [size=16K] Capabilities: [50] Power Management version 2 Capabilities: [60] MSI: Enable+ Count=1/1 Maskable- 64bit+ Capabilities: [70] Express Root Complex Integrated Endpoint, MSI 00 Capabilities: [100] Virtual Channel Capabilities: [130] Root Complex Link Kernel driver in use: snd_hda_intel 00:1c.0 PCI bridge: Intel Corporation 7 Series/C210 Series Chipset Family PCI Express Root Port 1 (rev c4) (prog-if 00 [Normal decode]) Flags: bus master, fast devsel, latency 0 Bus: primary=00, secondary=01, subordinate=01, sec-latency=0 I/O behind bridge: 0000e000-0000efff Memory behind bridge: f7e00000-f7efffff Prefetchable memory behind bridge: 00000000e0000000-00000000efffffff Capabilities: [40] Express Root Port (Slot+), MSI 00 Capabilities: [80] MSI: Enable- Count=1/1 Maskable- 64bit- Capabilities: [90] Subsystem: Gigabyte Technology Co., Ltd Device 5001 Capabilities: [a0] Power Management version 2 Kernel driver in use: pcieport 00:1c.4 PCI bridge: Intel Corporation 7 Series/C210 Series Chipset Family PCI Express Root Port 5 (rev c4) (prog-if 00 [Normal decode]) Flags: bus master, fast devsel, latency 0 Bus: primary=00, secondary=02, subordinate=02, sec-latency=0 I/O behind bridge: 0000d000-0000dfff Memory behind bridge: f7d00000-f7dfffff Capabilities: [40] Express Root Port (Slot+), MSI 00 Capabilities: [80] MSI: Enable- Count=1/1 Maskable- 64bit- Capabilities: [90] Subsystem: Gigabyte Technology Co., Ltd Device 5001 Capabilities: [a0] Power Management version 2 Kernel driver in use: pcieport 00:1c.5 PCI bridge: Intel Corporation 7 Series/C210 Series Chipset Family PCI Express Root Port 6 (rev c4) (prog-if 00 [Normal decode]) Flags: bus master, fast devsel, latency 0 Bus: primary=00, secondary=03, subordinate=03, sec-latency=0 I/O behind bridge: 0000c000-0000cfff Memory behind bridge: f7c00000-f7cfffff Prefetchable memory behind bridge: 00000000f0000000-00000000f00fffff Capabilities: [40] Express Root Port (Slot+), MSI 00 Capabilities: [80] MSI: Enable- Count=1/1 Maskable- 64bit- Capabilities: [90] Subsystem: Gigabyte Technology Co., Ltd Device 5001 Capabilities: [a0] Power Management version 2 Kernel driver in use: pcieport 00:1c.6 PCI bridge: Intel Corporation 82801 PCI Bridge (rev c4) (prog-if 01 [Subtractive decode]) Flags: bus master, fast devsel, latency 0 Bus: primary=00, secondary=04, subordinate=05, sec-latency=0 Capabilities: [40] Express Root Port (Slot+), MSI 00 Capabilities: [80] MSI: Enable- Count=1/1 Maskable- 64bit- Capabilities: [90] Subsystem: Gigabyte Technology Co., Ltd Device 5001 Capabilities: [a0] Power Management version 2 00:1d.0 USB controller: Intel Corporation 7 Series/C210 Series Chipset Family USB Enhanced Host Controller #1 (rev 04) (prog-if 20 [EHCI]) Subsystem: Gigabyte Technology Co., Ltd Device 5006 Flags: bus master, medium devsel, latency 0, IRQ 23 Memory at f7f16000 (32-bit, non-prefetchable) [size=1K] Capabilities: [50] Power Management version 2 Capabilities: [58] Debug port: BAR=1 offset=00a0 Capabilities: [98] PCI Advanced Features Kernel driver in use: ehci-pci 00:1f.0 ISA bridge: Intel Corporation Z77 Express Chipset LPC Controller (rev 04) Subsystem: Gigabyte Technology Co., Ltd Device 5001 Flags: bus master, medium devsel, latency 0 Capabilities: [e0] Vendor Specific Information: Len=0c &lt;?&gt; Kernel driver in use: lpc_ich 00:1f.2 IDE interface: Intel Corporation 7 Series/C210 Series Chipset Family 4-port SATA Controller [IDE mode] (rev 04) (prog-if 8f [Master SecP SecO PriP PriO]) Subsystem: Gigabyte Technology Co., Ltd Device b005 Flags: bus master, 66MHz, medium devsel, latency 0, IRQ 19 I/O ports at f110 [size=8] I/O ports at f100 [size=4] I/O ports at f0f0 [size=8] I/O ports at f0e0 [size=4] I/O ports at f0d0 [size=16] I/O ports at f0c0 [size=16] Capabilities: [70] Power Management version 3 Capabilities: [b0] PCI Advanced Features Kernel driver in use: ata_piix 00:1f.3 SMBus: Intel Corporation 7 Series/C210 Series Chipset Family SMBus Controller (rev 04) Subsystem: Gigabyte Technology Co., Ltd Device 5001 Flags: medium devsel, IRQ 18 Memory at f7f15000 (64-bit, non-prefetchable) [size=256] I/O ports at f040 [size=32] 00:1f.5 IDE interface: Intel Corporation 7 Series/C210 Series Chipset Family 2-port SATA Controller [IDE mode] (rev 04) (prog-if 85 [Master SecO PriO]) Subsystem: Gigabyte Technology Co., Ltd Device b002 Flags: bus master, 66MHz, medium devsel, latency 0, IRQ 19 I/O ports at f0b0 [size=8] I/O ports at f0a0 [size=4] I/O ports at f090 [size=8] I/O ports at f080 [size=4] I/O ports at f070 [size=16] I/O ports at f060 [size=16] Capabilities: [70] Power Management version 3 Capabilities: [b0] PCI Advanced Features Kernel driver in use: ata_piix 01:00.0 VGA compatible controller: Advanced Micro Devices, Inc. [AMD/ATI] RV670 [Radeon HD 3690/3850] (prog-if 00 [VGA controller]) Subsystem: Advanced Micro Devices, Inc. [AMD/ATI] Device 2542 Flags: fast devsel, IRQ 11 Memory at e0000000 (64-bit, prefetchable) [disabled] [size=256M] Memory at f7e20000 (64-bit, non-prefetchable) [disabled] [size=64K] I/O ports at e000 [disabled] [size=256] Expansion ROM at f7e00000 [disabled] [size=128K] Capabilities: [50] Power Management version 3 Capabilities: [58] Express Legacy Endpoint, MSI 00 Capabilities: [a0] MSI: Enable- Count=1/1 Maskable- 64bit+ Capabilities: [100] Vendor Specific Information: ID=0001 Rev=1 Len=010 &lt;?&gt; Kernel driver in use: vfio-pci 01:00.1 Audio device: Advanced Micro Devices, Inc. [AMD/ATI] RV670/680 HDMI Audio [Radeon HD 3690/3800 Series] Subsystem: Advanced Micro Devices, Inc. [AMD/ATI] RV670/680 HDMI Audio [Radeon HD 3690/3800 Series] Flags: fast devsel, IRQ 17 Memory at f7e30000 (64-bit, non-prefetchable) [disabled] [size=16K] Capabilities: [50] Power Management version 3 Capabilities: [58] Express Legacy Endpoint, MSI 00 Capabilities: [a0] MSI: Enable- Count=1/1 Maskable- 64bit+ Capabilities: [100] Vendor Specific Information: ID=0001 Rev=1 Len=010 &lt;?&gt; Kernel driver in use: vfio-pci 02:00.0 Ethernet controller: Qualcomm Atheros AR8161 Gigabit Ethernet (rev 10) Subsystem: Gigabyte Technology Co., Ltd Device e000 Flags: bus master, fast devsel, latency 0, IRQ 48 Memory at f7d00000 (64-bit, non-prefetchable) [size=256K] I/O ports at d000 [size=128] Capabilities: [40] Power Management version 3 Capabilities: [58] Express Endpoint, MSI 00 Capabilities: [c0] MSI: Enable+ Count=1/16 Maskable+ 64bit+ Capabilities: [d8] MSI-X: Enable- Count=16 Masked- Capabilities: [100] Advanced Error Reporting Capabilities: [180] Device Serial Number ff-5e-25-1c-90-2b-34-ff Kernel driver in use: alx 03:00.0 Ethernet controller: Realtek Semiconductor Co., Ltd. RTL8111/8168/8411 PCI Express Gigabit Ethernet Controller (rev 06) Subsystem: Realtek Semiconductor Co., Ltd. Device 0123 Flags: bus master, fast devsel, latency 0, IRQ 43 I/O ports at c000 [size=256] Memory at f7c00000 (64-bit, non-prefetchable) [size=4K] Memory at f0000000 (64-bit, prefetchable) [size=16K] Expansion ROM at f0020000 [disabled] [size=128K] Capabilities: [40] Power Management version 3 Capabilities: [50] MSI: Enable+ Count=1/1 Maskable- 64bit+ Capabilities: [70] Express Endpoint, MSI 01 Capabilities: [b0] MSI-X: Enable- Count=4 Masked- Capabilities: [d0] Vital Product Data Capabilities: [100] Advanced Error Reporting Capabilities: [140] Virtual Channel Capabilities: [160] Device Serial Number 71-02-00-00-68-4c-e0-00 Kernel driver in use: r8169 04:00.0 PCI bridge: Intel Corporation 82801 PCI Bridge (rev 41) (prog-if 01 [Subtractive decode]) Flags: bus master, fast devsel, latency 0 Bus: primary=04, secondary=05, subordinate=05, sec-latency=32 Capabilities: [90] Power Management version 2 Capabilities: [a0] Subsystem: Gigabyte Technology Co., Ltd Device 8892 lspci -t -[0000:00]-+-00.0 +-02.0 +-14.0 +-16.0 +-1a.0 +-1b.0 +-1c.0-[01]--+-00.0 | \-00.1 +-1c.4-[02]----00.0 +-1c.5-[03]----00.0 +-1c.6-[04-05]----00.0-[05]-- +-1d.0 +-1f.0 +-1f.2 +-1f.3 \-1f.5</code></pre></div> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1420055">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1420112" class="blockpost rowodd"> <h2><span><span class="conr">#1863</span> <a href="viewtopic.php?pid=1420112#p1420112">2014-05-28 17:56:13</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=80387">dwe11er</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2014-03-18</span></dd> <dd><span>Posts: 73</span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="codebox"><pre><code>&lt;qemu:arg value=&#039;-device&#039;/&gt; &lt;qemu:arg value=&#039;ioh3420,bus=pcie.0,addr=1c.0,multifunction=on,port=1,chassis=1,id=root.1&#039;/&gt; &lt;qemu:arg value=&#039;-device&#039;/&gt; &lt;qemu:arg value=&#039;vfio-pci,host=01:00.0,bus=root.1,addr=00.0,multifunction=on,x-vga=on,romfile=/var/lib/libvirt/firmware/vbios_GF106.rom&#039;/&gt; &lt;qemu:arg value=&#039;-device&#039;/&gt; &lt;qemu:arg value=&#039;vfio-pci,host=01:00.1,bus=root.1,addr=00.1&#039;/&gt;</code></pre></div><p>First device is PCH bridge emulated by qemu to which you want connect gpu you&#039;re passing, second and third are gpu itself and gpu&#039;s hda. TBH you can just copy-paste it <img src="https://bbs.archlinux.org/img/smilies/wink.png" width="15" height="15" alt="wink" /></p><p>EDIT:<br />Is it only me or new NVIDIA 337.88 driver still has issues with virtualized Windows? I&#039;m getting code 43, 335.23 doesn&#039;t have this issue.</p> <p class="postedit"><em>Last edited by dwe11er (2014-05-28 18:12:54)</em></p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1420112">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1420128" class="blockpost roweven"> <h2><span><span class="conr">#1864</span> <a href="viewtopic.php?pid=1420128#p1420128">2014-05-28 18:30:23</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=82341">buraktamturk</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2014-05-28</span></dd> <dd><span>Posts: 13</span></dd> <dd class="usercontacts"><span class="email"><a href="mailto:burak@tamturk.in">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>dwe11er wrote:</cite><blockquote><div><div class="codebox"><pre><code>&lt;qemu:arg value=&#039;-device&#039;/&gt; &lt;qemu:arg value=&#039;ioh3420,bus=pcie.0,addr=1c.0,multifunction=on,port=1,chassis=1,id=root.1&#039;/&gt; &lt;qemu:arg value=&#039;-device&#039;/&gt; &lt;qemu:arg value=&#039;vfio-pci,host=01:00.0,bus=root.1,addr=00.0,multifunction=on,x-vga=on,romfile=/var/lib/libvirt/firmware/vbios_GF106.rom&#039;/&gt; &lt;qemu:arg value=&#039;-device&#039;/&gt; &lt;qemu:arg value=&#039;vfio-pci,host=01:00.1,bus=root.1,addr=00.1&#039;/&gt;</code></pre></div><p>First device is PCH bridge emulated by qemu to which you want connect gpu you&#039;re passing, second and third are gpu itself and gpu&#039;s hda. TBH you can just copy-paste it <img src="https://bbs.archlinux.org/img/smilies/wink.png" width="15" height="15" alt="wink" /></p><p>EDIT:<br />Is it only me or new NVIDIA 337.88 driver still has issues with virtualized Windows? I&#039;m getting code 43, 335.23 doesn&#039;t have this issue.</p></div></blockquote></div><p>Thank You! I just see the windows installer on the monitor that connected to the ati card. I was giving up!</p><p>Now i understant what &quot;bus&quot; means here. Just had to change &quot;ioh3420,bus=pcie.0&quot; to &quot;ioh3420,bus=pci.0&quot;. Everything seems working! except OVMF UEFI bios firmware (Black screen at all, UEFI doesn&#039;t important for me at this point).</p><p>What does &quot;romfile=/var/lib/libvirt/firmware/vbios_GF106.rom&quot; means? I do not have such file.</p><p>Thank you again!!</p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1420128">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1420140" class="blockpost rowodd"> <h2><span><span class="conr">#1865</span> <a href="viewtopic.php?pid=1420140#p1420140">2014-05-28 19:24:02</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=82341">buraktamturk</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2014-05-28</span></dd> <dd><span>Posts: 13</span></dd> <dd class="usercontacts"><span class="email"><a href="mailto:burak@tamturk.in">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <p>Now another problem at windows installation&#039;s final step :&#039;(. Is there really something that i miss?</p><p><span class="postimg"><img src="http://i.imgur.com/svrhqhD.png" alt="svrhqhD.png" /></span></p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1420140">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1420148" class="blockpost roweven"> <h2><span><span class="conr">#1866</span> <a href="viewtopic.php?pid=1420148#p1420148">2014-05-28 19:37:17</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=79237">mbroemme</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>From: Cologne</span></dd> <dd><span>Registered: 2014-02-05</span></dd> <dd><span>Posts: 39</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=79237">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>buraktamturk wrote:</cite><blockquote><div><p>Now another problem at windows installation&#039;s final step :&#039;(. Is there really something that i miss?</p></div></blockquote></div><p>Did you rebooted your Windows during driver installation? Could you try to make a clean host reboot and then start VM with installed driver.</p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1420148">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1420160" class="blockpost rowodd"> <h2><span><span class="conr">#1867</span> <a href="viewtopic.php?pid=1420160#p1420160">2014-05-28 19:53:00</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=77842">Flyser</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2013-12-19</span></dd> <dd><span>Posts: 29</span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>dwe11er wrote:</cite><blockquote><div><p>Is it only me or new NVIDIA 337.88 driver still has issues with virtualized Windows? I&#039;m getting code 43, 335.23 doesn&#039;t have this issue.</p></div></blockquote></div><p>It&#039;s not only you. Same here for my gtx660</p><p>EDIT: Downgrading worked</p> <p class="postedit"><em>Last edited by Flyser (2014-05-28 19:59:28)</em></p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1420160">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1420164" class="blockpost roweven"> <h2><span><span class="conr">#1868</span> <a href="viewtopic.php?pid=1420164#p1420164">2014-05-28 20:08:55</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=82341">buraktamturk</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2014-05-28</span></dd> <dd><span>Posts: 13</span></dd> <dd class="usercontacts"><span class="email"><a href="mailto:burak@tamturk.in">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>mbroemme wrote:</cite><blockquote><div><div class="quotebox"><cite>buraktamturk wrote:</cite><blockquote><div><p>Now another problem at windows installation&#039;s final step :&#039;(. Is there really something that i miss?</p></div></blockquote></div><p>Did you rebooted your Windows during driver installation? Could you try to make a clean host reboot and then start VM with installed driver.</p></div></blockquote></div><p>Setup automatically rebooted guest after completing step 1. installing windows.</p><p>When installation is in 2. Step (&quot;Completing Installation&quot;), screen flickered (i think it was installing the graphics driver), then BSOD show up. When i start the guest again, (still standard vga driver), installer said something like &quot;the system was unexceptedly restarted and setup cannot contiune&quot;</p><p>Now tried with Windows 8.1 Update 1 iso, the os is installed without any graphics driver, and after setup, i manually installed latest graphics of ati 3800. voilla, worked!, resolution is fine and ATI control center is working.<br />So i have to block the default bundled ati driver installation of unmodified Windows 7 (i belive radeon5400 and older cards have microsoft driver by default), i will figure out somehow. I will edit this post when i can successfully boot windows 7 os.</p><p>Thank you again.</p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1420164">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1420206" class="blockpost rowodd"> <h2><span><span class="conr">#1869</span> <a href="viewtopic.php?pid=1420206#p1420206">2014-05-28 22:12:33</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=82280">thelamer</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2014-05-25</span></dd> <dd><span>Posts: 4</span></dd> <dd class="usercontacts"><span class="email"><a href="mailto:ryankuba@gmail.com">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>buraktamturk wrote:</cite><blockquote><div><div class="quotebox"><cite>mbroemme wrote:</cite><blockquote><div><div class="quotebox"><cite>buraktamturk wrote:</cite><blockquote><div><p>Now another problem at windows installation&#039;s final step :&#039;(. Is there really something that i miss?</p></div></blockquote></div><p>Did you rebooted your Windows during driver installation? Could you try to make a clean host reboot and then start VM with installed driver.</p></div></blockquote></div><p>Setup automatically rebooted guest after completing step 1. installing windows.</p><p>When installation is in 2. Step (&quot;Completing Installation&quot;), screen flickered (i think it was installing the graphics driver), then BSOD show up. When i start the guest again, (still standard vga driver), installer said something like &quot;the system was unexceptedly restarted and setup cannot contiune&quot;</p><p>Now tried with Windows 8.1 Update 1 iso, the os is installed without any graphics driver, and after setup, i manually installed latest graphics of ati 3800. voilla, worked!, resolution is fine and ATI control center is working.<br />So i have to block the default bundled ati driver installation of unmodified Windows 7 (i belive radeon5400 and older cards have microsoft driver by default), i will figure out somehow. I will edit this post when i can successfully boot windows 7 os.</p><p>Thank you again.</p></div></blockquote></div><p>For me to get windows 7 working I needed to reboot the host (not guest) after the ati driver installation. (just selected poweroff after the driver install) </p><p>I was getting the same atikpmag BSOD you were. </p><p>It is worth a try.</p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1420206">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1420226" class="blockpost roweven"> <h2><span><span class="conr">#1870</span> <a href="viewtopic.php?pid=1420226#p1420226">2014-05-28 23:08:46</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=75590">aw</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2013-10-04</span></dd> <dd><span>Posts: 921</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=75590">Email</a></span> <span class="website"><a href="http://vfio.blogspot.com/" rel="nofollow">Website</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>Flyser wrote:</cite><blockquote><div><div class="quotebox"><cite>dwe11er wrote:</cite><blockquote><div><p>Is it only me or new NVIDIA 337.88 driver still has issues with virtualized Windows? I&#039;m getting code 43, 335.23 doesn&#039;t have this issue.</p></div></blockquote></div><p>It&#039;s not only you. Same here for my gtx660</p><p>EDIT: Downgrading worked</p></div></blockquote></div><p>Same here *sigh* time to start comparing traces :-\</p> </div> <div class="postsignature postmsg"><hr /><p><a href="http://vfio.blogspot.com" rel="nofollow">http://vfio.blogspot.com</a><br />Looking for a more open forum to discuss vfio related uses?&#160; Try <a href="https://www.redhat.com/mailman/listinfo/vfio-users" rel="nofollow">https://www.redhat.com/mailman/listinfo/vfio-users</a></p></div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1420226">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1420254" class="blockpost rowodd"> <h2><span><span class="conr">#1871</span> <a href="viewtopic.php?pid=1420254#p1420254">2014-05-29 03:23:38</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=82357">gutleib</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2014-05-29</span></dd> <dd><span>Posts: 5</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=82357">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <p>Hi!<br />I am working on passthrough my gpu to windows VM by this guide, but I can&#039;t resolve one bug:</p><div class="codebox"><pre><code>me@host:~$sudo qemu-system-x86_64 -enable-kvm -M q35 -m 1024 -cpu host -smp 6,sockets=1,cores=6,threads=1 \ -bios /usr/share/qemu/bios.bin -vga none \ -device ioh3420,bus=pcie.0,addr=1c.0,multifunction=on,port=1,chassis=1,id=root.1 \ -device vfio-pci,host=05:00.0,bus=root.1,addr=00.0,multifunction=on,romfile=/root/Gigabyte.GTX590.1536.110223.rom,x-vga=on -device vfio-pci,host=05:00.1,bus=root.1,addr=00.1 \ -device vfio-pci,host=06:00.0,bus=root.1,addr=01.0,multifunction=on,romfile=/root/Gigabyte.GTX590.1536.110223.rom -device vfio-pci,host=06:00.1,bus=root.1,addr=01.1 \ -vga cirrus -cdrom /home/me/Win_8.1.iso </code></pre></div><p>gives</p><div class="codebox"><pre><code>qemu-system-x86_64: -device vfio-pci,host=05:00.0,bus=root.1,addr=00.0,multifunction=on,romfile=/root/Gigabyte.GTX590.1536.110223.rom,x-vga=on: vfio: Device does not support requested feature x-vga qemu-system-x86_64: -device vfio-pci,host=05:00.0,bus=root.1,addr=00.0,multifunction=on,romfile=/root/Gigabyte.GTX590.1536.110223.rom,x-vga=on: vfio: failed to get device 0000:05:00.0 qemu-system-x86_64: -device vfio-pci,host=05:00.0,bus=root.1,addr=00.0,multifunction=on,romfile=/root/Gigabyte.GTX590.1536.110223.rom,x-vga=on: Device initialization failed. qemu-system-x86_64: -device vfio-pci,host=05:00.0,bus=root.1,addr=00.0,multifunction=on,romfile=/root/Gigabyte.GTX590.1536.110223.rom,x-vga=on: Device &#039;vfio-pci&#039; could not be initialized</code></pre></div><p>System is Ubuntu 14.04, </p><div class="codebox"><pre><code>me@host:~# cat /boot/config-3.13.0-27-generic| grep VFIO CONFIG_VFIO_IOMMU_TYPE1=m CONFIG_VFIO=m CONFIG_VFIO_PCI=m CONFIG_VFIO_PCI_VGA=y CONFIG_KVM_VFIO=y me@host:~# lsmod |grep vfio vfio_pci 36474 0 vfio_iommu_type1 17636 0 vfio 24873 2 vfio_iommu_type1,vfio_pci me@host:~# lspci -s 05:00.0 -v 05:00.0 3D controller: NVIDIA Corporation GF110 [GeForce GTX 590] (rev a1) Subsystem: NVIDIA Corporation Device 0868 Flags: bus master, fast devsel, latency 0, IRQ 16 Memory at ec000000 (32-bit, non-prefetchable) [size=16M] Memory at e0000000 (64-bit, prefetchable) [size=128M] Memory at e8000000 (64-bit, prefetchable) [size=32M] Expansion ROM at ed080000 [disabled] [size=512K] Capabilities: [60] Power Management version 3 Capabilities: [68] MSI: Enable- Count=1/1 Maskable- 64bit+ Capabilities: [78] Express Endpoint, MSI 00 Capabilities: [b4] Vendor Specific Information: Len=14 &lt;?&gt; Capabilities: [100] Virtual Channel Capabilities: [128] Power Budgeting &lt;?&gt; Capabilities: [600] Vendor Specific Information: ID=0001 Rev=1 Len=024 &lt;?&gt; Kernel driver in use: vfio-pci</code></pre></div><p>Ummm... Does anyone have an idea? At least how to debug?</p> <p class="postedit"><em>Last edited by gutleib (2014-05-29 03:24:41)</em></p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1420254">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1420255" class="blockpost roweven"> <h2><span><span class="conr">#1872</span> <a href="viewtopic.php?pid=1420255#p1420255">2014-05-29 03:29:48</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=75590">aw</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2013-10-04</span></dd> <dd><span>Posts: 921</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=75590">Email</a></span> <span class="website"><a href="http://vfio.blogspot.com/" rel="nofollow">Website</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>gutleib wrote:</cite><blockquote><div><div class="codebox"><pre><code>qemu-system-x86_64: -device vfio-pci,host=05:00.0,bus=root.1,addr=00.0,multifunction=on,romfile=/root/Gigabyte.GTX590.1536.110223.rom,x-vga=on: vfio: Device does not support requested feature x-vga</code></pre></div><div class="codebox"><pre><code>05:00.0 3D controller: NVIDIA Corporation GF110 [GeForce GTX 590] (rev a1)</code></pre></div><p>Ummm... Does anyone have an idea? At least how to debug?</p></div></blockquote></div><p>The class code for you device is &quot;3D controller&quot;, not &quot;VGA compatible controller&quot;, therefore x-vga doesn&#039;t work for it because it doesn&#039;t support VGA.</p><p>EDIT: Are you using SLI and picked the slave card as your VGA device by mistake?</p> <p class="postedit"><em>Last edited by aw (2014-05-29 03:35:00)</em></p> </div> <div class="postsignature postmsg"><hr /><p><a href="http://vfio.blogspot.com" rel="nofollow">http://vfio.blogspot.com</a><br />Looking for a more open forum to discuss vfio related uses?&#160; Try <a href="https://www.redhat.com/mailman/listinfo/vfio-users" rel="nofollow">https://www.redhat.com/mailman/listinfo/vfio-users</a></p></div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1420255">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1420260" class="blockpost rowodd"> <h2><span><span class="conr">#1873</span> <a href="viewtopic.php?pid=1420260#p1420260">2014-05-29 03:39:40</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=82357">gutleib</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2014-05-29</span></dd> <dd><span>Posts: 5</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=82357">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <p>Ah! thanks<br />search doesn&#039;t show much on how to fix this, do you have a suggestion?</p><p>edit: i see 06.00.0 is vga. going to try use it</p><div class="codebox"><pre><code>sudo qemu-system-x86_64 -enable-kvm -M q35 -m 1024 -cpu host -smp 6,sockets=1,cores=6,threads=1 \ -bios /usr/share/qemu/bios.bin -vga none -device ioh3420,bus=pcie.0,addr=1c.0,multifunction=on,port=1,chassis=1,id=root.1 \ -device vfio-pci,host=05:00.0,bus=root.1,addr=00.0,multifunction=on,romfile=/root/Gigabyte.GTX590.1536.110223.rom \ -device vfio-pci,host=05:00.1,bus=root.1,addr=00.1 \ -device vfio-pci,host=06:00.0,bus=root.1,addr=01.0,multifunction=on,romfile=/root/Gigabyte.GTX590.1536.110223.rom,x-vga=on \ -device vfio-pci,host=06:00.1,bus=root.1,addr=01.1</code></pre></div><p>hmmm.<br />No errors.<br />Nothing in vnc.<br />Nothing on screen, though.</p> <p class="postedit"><em>Last edited by gutleib (2014-05-29 03:54:46)</em></p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1420260">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1420262" class="blockpost roweven"> <h2><span><span class="conr">#1874</span> <a href="viewtopic.php?pid=1420262#p1420262">2014-05-29 04:08:31</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=75590">aw</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2013-10-04</span></dd> <dd><span>Posts: 921</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=75590">Email</a></span> <span class="website"><a href="http://vfio.blogspot.com/" rel="nofollow">Website</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>gutleib wrote:</cite><blockquote><div><p>Ah! thanks<br />search doesn&#039;t show much on how to fix this, do you have a suggestion?</p><p>edit: i see 06.00.0 is vga. going to try use it</p><div class="codebox"><pre><code>sudo qemu-system-x86_64 -enable-kvm -M q35 -m 1024 -cpu host -smp 6,sockets=1,cores=6,threads=1 \ -bios /usr/share/qemu/bios.bin -vga none -device ioh3420,bus=pcie.0,addr=1c.0,multifunction=on,port=1,chassis=1,id=root.1 \ -device vfio-pci,host=05:00.0,bus=root.1,addr=00.0,multifunction=on,romfile=/root/Gigabyte.GTX590.1536.110223.rom \ -device vfio-pci,host=05:00.1,bus=root.1,addr=00.1 \ -device vfio-pci,host=06:00.0,bus=root.1,addr=01.0,multifunction=on,romfile=/root/Gigabyte.GTX590.1536.110223.rom,x-vga=on \ -device vfio-pci,host=06:00.1,bus=root.1,addr=01.1</code></pre></div><p>hmmm.<br />No errors.<br />Nothing in vnc.<br />Nothing on screen, though.</p></div></blockquote></div><p>Maybe you should start with one card and build from there.&#160; You haven&#039;t identified what patches are in your kernel, your host graphics device, the version of qemu used, etc.&#160; Besides, you&#039;ve made a non-standard PCIe configuration in the guest by using PCI slots 0 and 1 behind your root port.&#160; Typically only slot 0 is scanned by the guest.&#160; Once you get your VGA card working, add another ioh3420 and put the other card behind it.</p> </div> <div class="postsignature postmsg"><hr /><p><a href="http://vfio.blogspot.com" rel="nofollow">http://vfio.blogspot.com</a><br />Looking for a more open forum to discuss vfio related uses?&#160; Try <a href="https://www.redhat.com/mailman/listinfo/vfio-users" rel="nofollow">https://www.redhat.com/mailman/listinfo/vfio-users</a></p></div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1420262">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1420266" class="blockpost rowodd"> <h2><span><span class="conr">#1875</span> <a href="viewtopic.php?pid=1420266#p1420266">2014-05-29 04:47:05</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=82238">sinny</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2014-05-24</span></dd> <dd><span>Posts: 75</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=82238">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>buraktamturk wrote:</cite><blockquote><div><p>So i have to block the default bundled ati driver installation of unmodified Windows 7 (i belive radeon5400 and older cards have microsoft driver by default), i will figure out somehow. I will edit this post when i can successfully boot windows 7 os.</p></div></blockquote></div><p>in fact, you dont have to block or figure anything.<br />just dont use passthrough during installation/inital setup (==use only emulated qemu vga, not host cards)<br />after you are done, you can add passthrough and install needed graphics drivers</p><p>in my case (HD 6450) it served one more purpose - i was getting BSOD (stop 0x0000007b i think?) every time i tried to poweroff guest (and at least once after some idle time - i think win7 tried to power down monitor) with passthrough. the following (before installing amd drivers) resolved the issue: i disabled any power saving related stuff i could find - HDD/monitor sleep-on-idle, etc. plus, after installing drivers, just in case, i disabled anything power saving in driver&#039;s settings.</p><div class="quotebox"><cite>gutleib wrote:</cite><blockquote><div><p>hmmm.<br />No errors.<br />Nothing in vnc.<br />Nothing on screen, though.</p></div></blockquote></div><p>you sure you don&#039;t use intel&#039;s IGD for host and miss vga arbiter patch?</p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1420266">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div class="postlinksb"> <div class="inbox crumbsplus"> <div class="pagepost"> <p class="pagelink conl"><span class="pages-label">Pages: </span><a rel="prev" class="item1" href="viewtopic.php?id=162768&amp;p=74">Previous</a> <a href="viewtopic.php?id=162768">1</a> <span class="spacer">…</span> <a href="viewtopic.php?id=162768&amp;p=73">73</a> <a href="viewtopic.php?id=162768&amp;p=74">74</a> <strong>75</strong> <a href="viewtopic.php?id=162768&amp;p=76">76</a> <a href="viewtopic.php?id=162768&amp;p=77">77</a> <span class="spacer">…</span> <a href="viewtopic.php?id=162768&amp;p=234">234</a> <a rel="next" href="viewtopic.php?id=162768&amp;p=76">Next</a></p> <p class="postlink conr">Topic closed</p> </div> <ul class="crumbs"> <li><a href="index.php">Index</a></li> <li><span>»&#160;</span><a href="viewforum.php?id=48">Topics Going Nowhere</a></li> <li><span>»&#160;</span><strong><a href="viewtopic.php?id=162768">KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</a></strong></li> </ul> <p class="subscribelink clearb"><a href="misc.php?action=subscribe&amp;tid=162768">Subscribe to this topic</a></p> <div class="clearer"></div> </div> </div> </div> <div id="brdfooter" class="block"> <h2><span>Board footer</span></h2> <div class="box"> <div id="brdfooternav" class="inbox"> <div class="conl"> <form id="qjump" method="get" action="viewforum.php"> <div><label><span>Jump to<br /></span> <select name="id" onchange="window.location=('viewforum.php?id='+this.options[this.selectedIndex].value)"> <optgroup label="Technical Issues and Assistance"> <option value="23">Newbie Corner</option> <option value="17">Installation</option> <option value="22">Kernel &amp; Hardware</option> <option value="18">Applications &amp; Desktop Environments</option> <option value="31">Laptop Issues</option> <option value="8">Networking, Server, and Protection</option> <option value="32">Multimedia and Games</option> <option value="50">System Administration</option> <option value="35">Other Architectures</option> </optgroup> <optgroup label="Arch-centric"> <option value="24">Announcements, Package &amp; Security Advisories</option> <option value="1">Arch Discussion</option> <option value="13">Forum &amp; Wiki discussion</option> </optgroup> <optgroup label="Pacman Upgrades, Packaging &amp; AUR"> <option value="44">Pacman &amp; Package Upgrade Issues</option> <option value="49">[testing] Repo Forum</option> <option value="4">Creating &amp; Modifying Packages</option> <option value="38">AUR Issues, Discussion &amp; PKGBUILD Requests</option> </optgroup> <optgroup label="Contributions &amp; Discussion"> <option value="20">GNU/Linux Discussion</option> <option value="27">Community Contributions</option> <option value="33">Programming &amp; Scripting</option> <option value="30">Other Languages</option> <option value="47">Artwork and Screenshots</option> <option value="42">Try This</option> </optgroup> <optgroup label="/dev/null"> <option value="29">Off-Topic</option> <option value="48" selected="selected">Topics Going Nowhere</option> <option value="36">Dustbin</option> </optgroup> </select></label> <input type="submit" value=" Go " accesskey="g" /> </div> </form> </div> <div class="conr"> <p id="feedlinks"><span class="atom"><a href="extern.php?action=feed&amp;tid=162768&amp;type=atom">Atom topic feed</a></span></p> <p id="poweredby">Powered by <a href="http://fluxbb.org/">FluxBB</a></p> </div> <div class="clearer"></div> </div> </div> </div> </div> <div class="end-box"></div> </div> </body> </html>
