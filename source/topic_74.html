<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"> <html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en" dir="ltr"> <head> <meta http-equiv="Content-Type" content="text/html; charset=utf-8" /> <title>KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9 (Page 74) / Topics Going Nowhere / Arch Linux Forums</title> <link rel="stylesheet" type="text/css" href="style/ArchLinux.css" /> <link rel="canonical" href="viewtopic.php?id=162768&amp;p=74" title="Page 74" /> <link rel="prev" href="viewtopic.php?id=162768&amp;p=73" title="Page 73" /> <link rel="next" href="viewtopic.php?id=162768&amp;p=75" title="Page 75" /> <link rel="alternate" type="application/atom+xml" href="extern.php?action=feed&amp;tid=162768&amp;type=atom" title="Atom topic feed" /> <link rel="stylesheet" media="screen" href="style/ArchLinux/arch.css?v=3" /> <link rel="stylesheet" media="screen" href="style/ArchLinux/archnavbar.css?v=2" /> <link rel="shortcut icon" href="style/ArchLinux/favicon.ico" /> </head> <body> <div id="archnavbar" class="anb-forum"> <div id="archnavbarlogo"><h1><a href="http://www.archlinux.org/">Arch Linux</a></h1></div> <div id="archnavbarmenu"> <ul id="archnavbarlist"> <li id="anb-home"><a href="http://www.archlinux.org/">Home</a></li><li id="anb-packages"><a href="http://www.archlinux.org/packages/">Packages</a></li><li id="anb-forums" class="anb-selected"><a href="https://bbs.archlinux.org/">Forums</a></li><li id="anb-wiki"><a href="https://wiki.archlinux.org/">Wiki</a></li><li id="anb-bugs"><a href="https://bugs.archlinux.org/">Bugs</a></li><li id="anb-aur"><a href="https://aur.archlinux.org/">AUR</a></li><li id="anb-download"><a href="http://www.archlinux.org/download/">Download</a></li> </ul> </div> </div> <div id="punviewtopic" class="pun"> <div class="top-box"></div> <div class="punwrap"> <div id="brdheader" class="block"> <div class="box"> <div id="brdmenu" class="inbox"> <ul> <li id="navindex" class="isactive"><a href="index.php">Index</a></li> <li id="navuserlist"><a href="userlist.php">User list</a></li> <li id="navsearch"><a href="search.php">Search</a></li> <li id="navprofile"><a href="profile.php?id=80749">Profile</a></li> <li id="navlogout"><a href="login.php?action=out&amp;id=80749&amp;csrf_token=5c20501ec397bb45ef8ee8c84db232c8d8e421c6">Logout</a></li> </ul> </div> <div id="brdwelcome" class="inbox"> <ul class="conl"> <li><span>Logged in as <strong>SXX</strong></span></li> <li><span>Last visit: 2015-08-16 12:20:09</span></li> </ul> <ul class="conr"> <li><span>Topics: <a href="search.php?action=show_replies" title="Find topics you have posted to.">Posted</a> | <a href="search.php?action=show_new" title="Find topics with new posts since your last visit.">New</a> | <a href="search.php?action=show_recent" title="Find topics with recent posts.">Active</a> | <a href="search.php?action=show_unanswered" title="Find topics with no replies.">Unanswered</a></span></li> </ul> <div class="clearer"></div> </div> </div> </div> <div id="brdmain"> <div class="linkst"> <div class="inbox crumbsplus"> <ul class="crumbs"> <li><a href="index.php">Index</a></li> <li><span>»&#160;</span><a href="viewforum.php?id=48">Topics Going Nowhere</a></li> <li><span>»&#160;</span><strong><a href="viewtopic.php?id=162768">KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</a></strong></li> </ul> <div class="pagepost"> <p class="pagelink conl"><span class="pages-label">Pages: </span><a rel="prev" class="item1" href="viewtopic.php?id=162768&amp;p=73">Previous</a> <a href="viewtopic.php?id=162768">1</a> <span class="spacer">…</span> <a href="viewtopic.php?id=162768&amp;p=72">72</a> <a href="viewtopic.php?id=162768&amp;p=73">73</a> <strong>74</strong> <a href="viewtopic.php?id=162768&amp;p=75">75</a> <a href="viewtopic.php?id=162768&amp;p=76">76</a> <span class="spacer">…</span> <a href="viewtopic.php?id=162768&amp;p=234">234</a> <a rel="next" href="viewtopic.php?id=162768&amp;p=75">Next</a></p> <p class="postlink conr">Topic closed</p> </div> <div class="clearer"></div> </div> </div> <div id="p1419239" class="blockpost rowodd blockpost1"> <h2><span><span class="conr">#1826</span> <a href="viewtopic.php?pid=1419239#p1419239">2014-05-26 00:05:17</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=82283">unixninja92</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2014-05-26</span></dd> <dd><span>Posts: 3</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=82283">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <p>Is it possible to just use one GPU? For instance, could the host give up the gpu completely and give it to a vm? Then if you needed to access the host you could ssh in.</p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1419239">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1419240" class="blockpost roweven"> <h2><span><span class="conr">#1827</span> <a href="viewtopic.php?pid=1419240#p1419240">2014-05-26 00:06:02</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=79237">mbroemme</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>From: Cologne</span></dd> <dd><span>Registered: 2014-02-05</span></dd> <dd><span>Posts: 39</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=79237">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>aw wrote:</cite><blockquote><div><div class="codebox"><pre><code>$ lspci -tv | grep AMD +-01.0-[01]--+-00.0 Advanced Micro Devices, Inc. [AMD/ATI] Oland [Radeon HD 8570 / R7 240 OEM] | \-00.1 Advanced Micro Devices, Inc. [AMD/ATI] Cape Verde/Pitcairn HDMI Audio [Radeon HD 7700/7800 Series]</code></pre></div><p>00:01.0 is the upstream bridge.</p><p>Read the bridge control register</p><div class="codebox"><pre><code>$ sudo setpci -s 00:01.0 3e.w 0018</code></pre></div><p>OR 0x40 into the result</p><div class="codebox"><pre><code>$ printf %04x $(( 0x0018 | 0x40 )) 0058</code></pre></div><p>Write this to the same register:</p><div class="codebox"><pre><code>$ sudo sudo setpci -s 00:01.0 3e.w=0058</code></pre></div><p>Then restore the original value:</p><div class="codebox"><pre><code>$ sudo sudo setpci -s 00:01.0 3e.w=0018</code></pre></div><p>If the bus reset works, then the screen should have cleared and the monitor gone out of sync.&#160; If nothing happened, then I don&#039;t know how we can reset the device.&#160; I think one of my old GeForce cards is also impervious to bus resets.</p></div></blockquote></div><p>This works fine with my R9 290X. The monitor is going blank but after starting QEMU a second time nothing happens and kernel logs the following:</p><div class="codebox"><pre><code>[21542.837722] vfio-pci 0000:04:00.0: enabling device (0000 -&gt; 0003) [21542.837872] vfio_ecap_init: 0000:04:00.0 hiding ecap 0x19@0x270 [21542.837879] vfio_ecap_init: 0000:04:00.0 hiding ecap 0x1b@0x2d0 [21542.872417] vfio-pci 0000:04:00.1: enabling device (0000 -&gt; 0002)</code></pre></div><p>Right now I&#039;m using QEMU without the vfio_pci_reset_handler patch from the thread. Should I retry with it?</p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1419240">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1419241" class="blockpost rowodd"> <h2><span><span class="conr">#1828</span> <a href="viewtopic.php?pid=1419241#p1419241">2014-05-26 00:07:44</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=82280">thelamer</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2014-05-25</span></dd> <dd><span>Posts: 4</span></dd> <dd class="usercontacts"><span class="email"><a href="mailto:ryankuba@gmail.com">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <p>Edit: NM I was able to build the latest qemu from source and it can use this config file, 2.0.0 from the debian repos must have a bug in it. I still get a atikmpag.sys bsod but at least I know I have tried everything. Looks like this R9 270x was not meant to be. Time to try some other cards. </p><div class="quotebox"><cite>Norcoen wrote:</cite><blockquote><div><p>Sorry, I was looking in /etc/qemu/, and it wasn&#039;t there, I forgot the connection to libvirtd.<br />I already have &quot;clear_emulator_capabilities=0&quot; in said qemu.conf, because before finding this board, I followed another tutorial and applied the last paragraph of this site:<br /><a href="http://fedoraproject.org/wiki/How_to_debug_Virtualization_problems#PCI_device_assignment" rel="nofollow">http://fedoraproject.org/wiki/How_to_de … assignment</a></p><p>So, I have the same bluescreen error, but your solution somehow does not apply for me :/</p><p>//edit:<br />I found out, the qemu-git I built isn&#039;t looking in /etc/libvirt/ but in /etc/qemu, so I copied my qemu.conf to that location, now getting this error:</p><div class="codebox"><pre><code>qemu-system-x86_64:/etc/qemu/qemu.conf:198: no group defined</code></pre></div><p>Line 198 is</p><div class="codebox"><pre><code>user = &quot;root&quot;</code></pre></div><p>So I&#039;m stuck again...</p><p>//edit2:<br />I played around a bit with the config, and the seems to be around the group for the QEMU processes:</p><div class="codebox"><pre><code># The group for QEMU processes run by the system instance. It can be # specified in a similar way to user. group = &quot;root&quot;</code></pre></div><p>If I delete that line, I get a parser error, but if I set it to any group, root, my user, qemu, kvm, I just get the error above, that no group is defined.</p></div></blockquote></div><p>I am currently running into the same thing, can you define this options from the command line ? I did not see anything in the man page. </p><p>Current config: (/etc/qemu/qemu.conf)</p><div class="codebox"><pre><code>user = &quot;root&quot; group = &quot;root&quot; clear_emulator_capabilities = 0</code></pre></div><p>Error : </p><div class="codebox"><pre><code>qemu-system-x86_64:/etc/qemu/qemu.conf:1: no group defined</code></pre></div><p>Version: </p><div class="codebox"><pre><code>QEMU emulator version 2.0.0 (Debian 2.0.0+dfsg-4+b1), Copyright (c) 2003-2008 Fabrice Bellard</code></pre></div> <p class="postedit"><em>Last edited by thelamer (2014-05-26 02:41:00)</em></p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1419241">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1419242" class="blockpost roweven"> <h2><span><span class="conr">#1829</span> <a href="viewtopic.php?pid=1419242#p1419242">2014-05-26 00:08:14</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=79237">mbroemme</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>From: Cologne</span></dd> <dd><span>Registered: 2014-02-05</span></dd> <dd><span>Posts: 39</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=79237">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>unixninja92 wrote:</cite><blockquote><div><p>Is it possible to just use one GPU? For instance, could the host give up the gpu completely and give it to a vm? Then if you needed to access the host you could ssh in.</p></div></blockquote></div><p>Yes but only if the host has not loaded any GPU related drivers (e.g. for AMD/ATI don&#039;t load radeon/fglrx and for NVidia don&#039;t load nouveau/nvidia). Without loading the drivers you can safely bind the card to vfio and use it.</p> <p class="postedit"><em>Last edited by mbroemme (2014-05-26 00:08:27)</em></p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1419242">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1419244" class="blockpost rowodd"> <h2><span><span class="conr">#1830</span> <a href="viewtopic.php?pid=1419244#p1419244">2014-05-26 00:10:44</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=75590">aw</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2013-10-04</span></dd> <dd><span>Posts: 921</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=75590">Email</a></span> <span class="website"><a href="http://vfio.blogspot.com/" rel="nofollow">Website</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>mbroemme wrote:</cite><blockquote><div><p>This works fine with my R9 290X. The monitor is going blank but after starting QEMU a second time nothing happens and kernel logs the following:</p><div class="codebox"><pre><code>[21542.837722] vfio-pci 0000:04:00.0: enabling device (0000 -&gt; 0003) [21542.837872] vfio_ecap_init: 0000:04:00.0 hiding ecap 0x19@0x270 [21542.837879] vfio_ecap_init: 0000:04:00.0 hiding ecap 0x1b@0x2d0 [21542.872417] vfio-pci 0000:04:00.1: enabling device (0000 -&gt; 0002)</code></pre></div><p>Right now I&#039;m using QEMU without the vfio_pci_reset_handler patch from the thread. Should I retry with it?</p></div></blockquote></div><p>You need to reboot after doing this, I should have mentioned that.&#160; If a bus reset works, then I don&#039;t see why they change to invoke a bus reset regardless of pm-reset support doesn&#039;t work.&#160; Can you uncomment the DEBUG_VFIO in hw/misc/vfio.c, rebuild and pastebin the log? /1 /bin /boot /cdrom /dev /etc /home /initrd.img /initrd.img.old /lib /lib32 /lib64 /libx32 /lost+found /media /mnt /opt /proc /root /run /sbin /srv /sys /tmp /ubiquity-apt-clone /usr /var /vmlinuz /vmlinuz.old /win81-base.qcow2 /win81-base.qcow2.md5 /win81-writable-amd.qcow2 /win81-writable-nvidia.qcow2 /win81-writable-nvidia.qcow2.backup #define DEBUG_VFIO */ -&gt; #define DEBUG_VFIO&#160; Do that with the reset patch applied.</p> </div> <div class="postsignature postmsg"><hr /><p><a href="http://vfio.blogspot.com" rel="nofollow">http://vfio.blogspot.com</a><br />Looking for a more open forum to discuss vfio related uses?&#160; Try <a href="https://www.redhat.com/mailman/listinfo/vfio-users" rel="nofollow">https://www.redhat.com/mailman/listinfo/vfio-users</a></p></div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1419244">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1419248" class="blockpost roweven"> <h2><span><span class="conr">#1831</span> <a href="viewtopic.php?pid=1419248#p1419248">2014-05-26 00:13:00</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=75590">aw</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2013-10-04</span></dd> <dd><span>Posts: 921</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=75590">Email</a></span> <span class="website"><a href="http://vfio.blogspot.com/" rel="nofollow">Website</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>mbroemme wrote:</cite><blockquote><div><div class="quotebox"><cite>unixninja92 wrote:</cite><blockquote><div><p>Is it possible to just use one GPU? For instance, could the host give up the gpu completely and give it to a vm? Then if you needed to access the host you could ssh in.</p></div></blockquote></div><p>Yes but only if the host has not loaded any GPU related drivers (e.g. for AMD/ATI don&#039;t load radeon/fglrx and for NVidia don&#039;t load nouveau/nvidia). Without loading the drivers you can safely bind the card to vfio and use it.</p></div></blockquote></div><p>I dunno about safely... but it mostly works.&#160; Ideally you also want to detach the GPU from vgacon, which you may be able to google to figure out how to do.&#160; Otherwise any dmesg output is potentially writing to the card while it&#039;s in use by the guest.</p> </div> <div class="postsignature postmsg"><hr /><p><a href="http://vfio.blogspot.com" rel="nofollow">http://vfio.blogspot.com</a><br />Looking for a more open forum to discuss vfio related uses?&#160; Try <a href="https://www.redhat.com/mailman/listinfo/vfio-users" rel="nofollow">https://www.redhat.com/mailman/listinfo/vfio-users</a></p></div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1419248">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1419249" class="blockpost rowodd"> <h2><span><span class="conr">#1832</span> <a href="viewtopic.php?pid=1419249#p1419249">2014-05-26 00:17:07</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=79237">mbroemme</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>From: Cologne</span></dd> <dd><span>Registered: 2014-02-05</span></dd> <dd><span>Posts: 39</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=79237">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>aw wrote:</cite><blockquote><div><div class="quotebox"><cite>mbroemme wrote:</cite><blockquote><div><div class="quotebox"><cite>unixninja92 wrote:</cite><blockquote><div><p>Is it possible to just use one GPU? For instance, could the host give up the gpu completely and give it to a vm? Then if you needed to access the host you could ssh in.</p></div></blockquote></div><p>Yes but only if the host has not loaded any GPU related drivers (e.g. for AMD/ATI don&#039;t load radeon/fglrx and for NVidia don&#039;t load nouveau/nvidia). Without loading the drivers you can safely bind the card to vfio and use it.</p></div></blockquote></div><p>I dunno about safely... but it mostly works.&#160; Ideally you also want to detach the GPU from vgacon, which you may be able to google to figure out how to do.&#160; Otherwise any dmesg output is potentially writing to the card while it&#039;s in use by the guest.</p></div></blockquote></div><p>With safely I meant I&#039;ve tried it already several times on another machine and it worked very smooth. <img src="https://bbs.archlinux.org/img/smilies/smile.png" width="15" height="15" alt="smile" /></p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1419249">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1419264" class="blockpost roweven"> <h2><span><span class="conr">#1833</span> <a href="viewtopic.php?pid=1419264#p1419264">2014-05-26 02:32:57</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=79578">AKSN74</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd class="postavatar"><img src="https://bbs.archlinux.org/img/avatars/79578.jpg?m=1423108340" width="80" height="80" alt="" /></dd> <dd><span>From: Taichung, Taiwan</span></dd> <dd><span>Registered: 2014-02-18</span></dd> <dd><span>Posts: 52</span></dd> <dd class="usercontacts"><span class="email"><a href="mailto:missile0407@gmail.com">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>thehighhat wrote:</cite><blockquote><div><div class="quotebox"><cite>thehighhat wrote:</cite><blockquote><div><div class="quotebox"><cite>AKSN74 wrote:</cite><blockquote><div><p>Hi, aw.</p><p>I found that not only VM hangs when reboot with 2 VMs working together, but also only 1 VM working.</p><p>And I tried to shutdown, not reboot, it can back to tty successfully.<br />But when I try to start again with same command, it got another error message.</p><div class="codebox"><pre><code>qemu-system-x86_64: vfio-pci: Cannot read device rom at 0000:03:00.0 Device option ROM contents are probably invalid (check dmesg). Skip option ROM probe with rombar=0, or load from file with romfile=</code></pre></div><p>It&#039;s may a reason why it hangs when reboot.<br />But I found that when&#160; I reboot VM while guest OS is Windows 7, it can reboot successfully some times.<br />So it is very strange for this problem.......</p><p>I&#039;ll try to use 3.14.4 kernel and see it still a same problem or not.</p></div></blockquote></div><br /><p>Same problem here.&#160; I cannot reboot or reissue the qemu command without this error.&#160; Do I need to undo the vfio-bind stuffs?</p></div></blockquote></div><br /><p>Fixed.&#160; I needed to download the rom file from <a href="http://www.techpowerup.com/vgabios/" rel="nofollow">http://www.techpowerup.com/vgabios/</a> .&#160; &#160;Then add romfile=/path/to/romfile.rom to the -device line for the GPU.</p><p>Also changed the -cpu from type &quot;host&quot; to &quot;qemu64&quot;</p></div></blockquote></div><p>Thanks for your solution, looks like some graphic cards need to do this as well.</p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1419264">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1419270" class="blockpost rowodd"> <h2><span><span class="conr">#1834</span> <a href="viewtopic.php?pid=1419270#p1419270">2014-05-26 04:09:12</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=82283">unixninja92</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2014-05-26</span></dd> <dd><span>Posts: 3</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=82283">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>mbroemme wrote:</cite><blockquote><div><div class="quotebox"><cite>aw wrote:</cite><blockquote><div><div class="quotebox"><cite>mbroemme wrote:</cite><blockquote><div><p>Yes but only if the host has not loaded any GPU related drivers (e.g. for AMD/ATI don&#039;t load radeon/fglrx and for NVidia don&#039;t load nouveau/nvidia). Without loading the drivers you can safely bind the card to vfio and use it.</p></div></blockquote></div><p>I dunno about safely... but it mostly works.&#160; Ideally you also want to detach the GPU from vgacon, which you may be able to google to figure out how to do.&#160; Otherwise any dmesg output is potentially writing to the card while it&#039;s in use by the guest.</p></div></blockquote></div><p>With safely I meant I&#039;ve tried it already several times on another machine and it worked very smooth. <img src="https://bbs.archlinux.org/img/smilies/smile.png" width="15" height="15" alt="smile" /></p></div></blockquote></div><p>My GPU is an Intel 4600. I haven&#039;t looked into detaching the GPU from vgacon yet, but I believe I have everything else set up correctly. But I keep getting this error:<br />qemu-system-x86_64: -device vfio-pci,host=00:02.0,bus=root.1,addr=00.0,multifunction=on,x-vga=on: vfio: error no iommu_group for device<br />qemu-system-x86_64: -device vfio-pci,host=00:02.0,bus=root.1,addr=00.0,multifunction=on,x-vga=on: Device initialization failed.<br />qemu-system-x86_64: -device vfio-pci,host=00:02.0,bus=root.1,addr=00.0,multifunction=on,x-vga=on: Device &#039;vfio-pci&#039; could not be initialized<br />when I try running the test qemu stuff from the first post. Dmesg says that Intel IOMMU is enabled, and vfio-pci is loaded. When I boot my pci-stub is set as the driver for my graphics card, and running the vfio-bind script seems to have no effect.</p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1419270">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1419273" class="blockpost roweven"> <h2><span><span class="conr">#1835</span> <a href="viewtopic.php?pid=1419273#p1419273">2014-05-26 04:12:01</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=75590">aw</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2013-10-04</span></dd> <dd><span>Posts: 921</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=75590">Email</a></span> <span class="website"><a href="http://vfio.blogspot.com/" rel="nofollow">Website</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>unixninja92 wrote:</cite><blockquote><div><div class="quotebox"><cite>mbroemme wrote:</cite><blockquote><div><div class="quotebox"><cite>aw wrote:</cite><blockquote><div><p>I dunno about safely... but it mostly works.&#160; Ideally you also want to detach the GPU from vgacon, which you may be able to google to figure out how to do.&#160; Otherwise any dmesg output is potentially writing to the card while it&#039;s in use by the guest.</p></div></blockquote></div><p>With safely I meant I&#039;ve tried it already several times on another machine and it worked very smooth. <img src="https://bbs.archlinux.org/img/smilies/smile.png" width="15" height="15" alt="smile" /></p></div></blockquote></div><p>My GPU is an Intel 4600. I haven&#039;t looked into detaching the GPU from vgacon yet, but I believe I have everything else set up correctly. But I keep getting this error:<br />qemu-system-x86_64: -device vfio-pci,host=00:02.0,bus=root.1,addr=00.0,multifunction=on,x-vga=on: vfio: error no iommu_group for device<br />qemu-system-x86_64: -device vfio-pci,host=00:02.0,bus=root.1,addr=00.0,multifunction=on,x-vga=on: Device initialization failed.<br />qemu-system-x86_64: -device vfio-pci,host=00:02.0,bus=root.1,addr=00.0,multifunction=on,x-vga=on: Device &#039;vfio-pci&#039; could not be initialized<br />when I try running the test qemu stuff from the first post. Dmesg says that Intel IOMMU is enabled, and vfio-pci is loaded. When I boot my pci-stub is set as the driver for my graphics card, and running the vfio-bind script seems to have no effect.</p></div></blockquote></div><p>You don&#039;t have VT-d enabled, but it doesn&#039;t matter, assignment of an IGD device does not currently work.</p> </div> <div class="postsignature postmsg"><hr /><p><a href="http://vfio.blogspot.com" rel="nofollow">http://vfio.blogspot.com</a><br />Looking for a more open forum to discuss vfio related uses?&#160; Try <a href="https://www.redhat.com/mailman/listinfo/vfio-users" rel="nofollow">https://www.redhat.com/mailman/listinfo/vfio-users</a></p></div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1419273">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1419279" class="blockpost rowodd"> <h2><span><span class="conr">#1836</span> <a href="viewtopic.php?pid=1419279#p1419279">2014-05-26 05:19:55</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=82283">unixninja92</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2014-05-26</span></dd> <dd><span>Posts: 3</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=82283">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>aw wrote:</cite><blockquote><div><div class="quotebox"><cite>unixninja92 wrote:</cite><blockquote><div><p>My GPU is an Intel 4600. I haven&#039;t looked into detaching the GPU from vgacon yet, but I believe I have everything else set up correctly. But I keep getting this error:<br />qemu-system-x86_64: -device vfio-pci,host=00:02.0,bus=root.1,addr=00.0,multifunction=on,x-vga=on: vfio: error no iommu_group for device<br />qemu-system-x86_64: -device vfio-pci,host=00:02.0,bus=root.1,addr=00.0,multifunction=on,x-vga=on: Device initialization failed.<br />qemu-system-x86_64: -device vfio-pci,host=00:02.0,bus=root.1,addr=00.0,multifunction=on,x-vga=on: Device &#039;vfio-pci&#039; could not be initialized<br />when I try running the test qemu stuff from the first post. Dmesg says that Intel IOMMU is enabled, and vfio-pci is loaded. When I boot my pci-stub is set as the driver for my graphics card, and running the vfio-bind script seems to have no effect.</p></div></blockquote></div><p>You don&#039;t have VT-d enabled, but it doesn&#039;t matter, assignment of an IGD device does not currently work.</p></div></blockquote></div><p>Ok, good to know. IGD stuff aside, my VT-d is enabled.</p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1419279">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1419289" class="blockpost roweven"> <h2><span><span class="conr">#1837</span> <a href="viewtopic.php?pid=1419289#p1419289">2014-05-26 07:24:14</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=77842">Flyser</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2013-12-19</span></dd> <dd><span>Posts: 29</span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <p>Just fyi, because I have seen the discussion come up a while back:<br />In my setup I am running an X server on my nvidia gpu, can stop it, boot the vm, stop the vm and start the X server again. I mainly use it to save power, because the X server can put the GPU in a low power state with no VM running that wastes CPU cycles.</p><p>The only &quot;special&quot; thing I had to do was to issue a bus reset (?) after shutting down the VM, which I do by:</p><div class="codebox"><pre><code>qemu-system-x86_64 -name noop -enable-kvm -boot order=c,menu=off,reboot-timeout=0 -machine type=q35,accel=kvm -cpu host -smp 1 -m 32 -k de -vga none -display none -device ioh3420,bus=pcie.0,addr=1c.0,multifunction=on,port=1,chassis=1,id=root.1 -device vfio-pci,host=01:00.0,bus=root.1,addr=00.0,multifunction=on,x-vga=on -device vfio-pci,host=01:00.1,bus=root.1,addr=00.1 -net none -no-reboot</code></pre></div><p>Everything else should be relatively standard.</p> <p class="postedit"><em>Last edited by Flyser (2014-05-26 07:43:13)</em></p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1419289">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1419322" class="blockpost rowodd"> <h2><span><span class="conr">#1838</span> <a href="viewtopic.php?pid=1419322#p1419322">2014-05-26 10:07:18</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=82238">sinny</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2014-05-24</span></dd> <dd><span>Posts: 75</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=82238">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <p>ok, i managed to overcome my problems (more like stupidity, in fact) - the i915 module i rebuilt had different vermagic, so it failed loading at boot time, which lead to X server not having any devices to operate on. though i never would expect that X server would just freeze like that on no devices instead of just quitting.</p><p>now comes another portion of problems - successfully managed to install windows 7 64bit using cirrus vga. after that using only HD 6450 passed through downloaded and installed latest catalyst drivers (excluding CCC). now getting solid BSOD on windows login - will try with restarted host system when i get a chance for this restart.</p><p>do catalyst drivers only work on limited set of versions or is it just some random problem with my setup/configuration?</p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1419322">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1419392" class="blockpost roweven"> <h2><span><span class="conr">#1839</span> <a href="viewtopic.php?pid=1419392#p1419392">2014-05-26 15:00:47</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=79237">mbroemme</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>From: Cologne</span></dd> <dd><span>Registered: 2014-02-05</span></dd> <dd><span>Posts: 39</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=79237">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>aw wrote:</cite><blockquote><div><div class="quotebox"><cite>mbroemme wrote:</cite><blockquote><div><p>This works fine with my R9 290X. The monitor is going blank but after starting QEMU a second time nothing happens and kernel logs the following:</p><div class="codebox"><pre><code>[21542.837722] vfio-pci 0000:04:00.0: enabling device (0000 -&gt; 0003) [21542.837872] vfio_ecap_init: 0000:04:00.0 hiding ecap 0x19@0x270 [21542.837879] vfio_ecap_init: 0000:04:00.0 hiding ecap 0x1b@0x2d0 [21542.872417] vfio-pci 0000:04:00.1: enabling device (0000 -&gt; 0002)</code></pre></div><p>Right now I&#039;m using QEMU without the vfio_pci_reset_handler patch from the thread. Should I retry with it?</p></div></blockquote></div><p>You need to reboot after doing this, I should have mentioned that.&#160; If a bus reset works, then I don&#039;t see why they change to invoke a bus reset regardless of pm-reset support doesn&#039;t work.&#160; Can you uncomment the DEBUG_VFIO in hw/misc/vfio.c, rebuild and pastebin the log? /1 /bin /boot /cdrom /dev /etc /home /initrd.img /initrd.img.old /lib /lib32 /lib64 /libx32 /lost+found /media /mnt /opt /proc /root /run /sbin /srv /sys /tmp /ubiquity-apt-clone /usr /var /vmlinuz /vmlinuz.old /win81-base.qcow2 /win81-base.qcow2.md5 /win81-writable-amd.qcow2 /win81-writable-nvidia.qcow2 /win81-writable-nvidia.qcow2.backup #define DEBUG_VFIO */ -&gt; #define DEBUG_VFIO&#160; Do that with the reset patch applied.</p></div></blockquote></div><p>Okay I tested it now with the following sequence for my system:</p><p>#1 Started QEMU to boot Linux VM, load fglrx driver and start X.<br />#2 Graceful shutdown of VM<br />#3 Started QEMU and pressed STRG+C during seabios boot.<br />#4 Executed:</p><div class="codebox"><pre><code>setpci -s 00:0b.0 3e.w printf %04x $(( 0x0008 | 0x40 )) setpci -s 00:0b.0 3e.w=0048 setpci -s 00:0b.0 3e.w=0008</code></pre></div><p>After that screen goes blank<br />#5 Started QEMU again and now it hangs and logfile is here: <a href="http://paste2.org/wEay3vFV" rel="nofollow">http://paste2.org/wEay3vFV</a></p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1419392">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1419400" class="blockpost rowodd"> <h2><span><span class="conr">#1840</span> <a href="viewtopic.php?pid=1419400#p1419400">2014-05-26 15:22:15</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=75590">aw</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2013-10-04</span></dd> <dd><span>Posts: 921</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=75590">Email</a></span> <span class="website"><a href="http://vfio.blogspot.com/" rel="nofollow">Website</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>mbroemme wrote:</cite><blockquote><div><div class="quotebox"><cite>aw wrote:</cite><blockquote><div><div class="quotebox"><cite>mbroemme wrote:</cite><blockquote><div><p>This works fine with my R9 290X. The monitor is going blank but after starting QEMU a second time nothing happens and kernel logs the following:</p><div class="codebox"><pre><code>[21542.837722] vfio-pci 0000:04:00.0: enabling device (0000 -&gt; 0003) [21542.837872] vfio_ecap_init: 0000:04:00.0 hiding ecap 0x19@0x270 [21542.837879] vfio_ecap_init: 0000:04:00.0 hiding ecap 0x1b@0x2d0 [21542.872417] vfio-pci 0000:04:00.1: enabling device (0000 -&gt; 0002)</code></pre></div><p>Right now I&#039;m using QEMU without the vfio_pci_reset_handler patch from the thread. Should I retry with it?</p></div></blockquote></div><p>You need to reboot after doing this, I should have mentioned that.&#160; If a bus reset works, then I don&#039;t see why they change to invoke a bus reset regardless of pm-reset support doesn&#039;t work.&#160; Can you uncomment the DEBUG_VFIO in hw/misc/vfio.c, rebuild and pastebin the log? /1 /bin /boot /cdrom /dev /etc /home /initrd.img /initrd.img.old /lib /lib32 /lib64 /libx32 /lost+found /media /mnt /opt /proc /root /run /sbin /srv /sys /tmp /ubiquity-apt-clone /usr /var /vmlinuz /vmlinuz.old /win81-base.qcow2 /win81-base.qcow2.md5 /win81-writable-amd.qcow2 /win81-writable-nvidia.qcow2 /win81-writable-nvidia.qcow2.backup #define DEBUG_VFIO */ -&gt; #define DEBUG_VFIO&#160; Do that with the reset patch applied.</p></div></blockquote></div><p>Okay I tested it now with the following sequence for my system:</p><p>#1 Started QEMU to boot Linux VM, load fglrx driver and start X.<br />#2 Graceful shutdown of VM<br />#3 Started QEMU and pressed STRG+C during seabios boot.<br />#4 Executed:</p><div class="codebox"><pre><code>setpci -s 00:0b.0 3e.w printf %04x $(( 0x0008 | 0x40 )) setpci -s 00:0b.0 3e.w=0048 setpci -s 00:0b.0 3e.w=0008</code></pre></div><p>After that screen goes blank<br />#5 Started QEMU again and now it hangs and logfile is here: <a href="http://paste2.org/wEay3vFV" rel="nofollow">http://paste2.org/wEay3vFV</a></p></div></blockquote></div><p>Nothing is expected to work after the setpci secondary bus reset, it&#039;s only a test.&#160; Do not attempt to do anything with devices downstream of the bridge until after a reboot.&#160; That said, I do see QEMU reporting success for doing a hot reset on the bus, so I don&#039;t see why we&#039;re seeing so many reports that reset doesn&#039;t work on these cards.</p> <p class="postedit"><em>Last edited by aw (2014-05-26 15:22:46)</em></p> </div> <div class="postsignature postmsg"><hr /><p><a href="http://vfio.blogspot.com" rel="nofollow">http://vfio.blogspot.com</a><br />Looking for a more open forum to discuss vfio related uses?&#160; Try <a href="https://www.redhat.com/mailman/listinfo/vfio-users" rel="nofollow">https://www.redhat.com/mailman/listinfo/vfio-users</a></p></div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1419400">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1419420" class="blockpost roweven"> <h2><span><span class="conr">#1841</span> <a href="viewtopic.php?pid=1419420#p1419420">2014-05-26 16:49:54</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=79237">mbroemme</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>From: Cologne</span></dd> <dd><span>Registered: 2014-02-05</span></dd> <dd><span>Posts: 39</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=79237">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>aw wrote:</cite><blockquote><div><p>Nothing is expected to work after the setpci secondary bus reset, it&#039;s only a test.&#160; Do not attempt to do anything with devices downstream of the bridge until after a reboot.&#160; That said, I do see QEMU reporting success for doing a hot reset on the bus, so I don&#039;t see why we&#039;re seeing so many reports that reset doesn&#039;t work on these cards.</p></div></blockquote></div><p>Looks like only folks from AMD/ATI knows the magic for a proper reset.</p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1419420">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1419432" class="blockpost rowodd"> <h2><span><span class="conr">#1842</span> <a href="viewtopic.php?pid=1419432#p1419432">2014-05-26 17:18:38</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=75590">aw</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2013-10-04</span></dd> <dd><span>Posts: 921</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=75590">Email</a></span> <span class="website"><a href="http://vfio.blogspot.com/" rel="nofollow">Website</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>mbroemme wrote:</cite><blockquote><div><div class="quotebox"><cite>aw wrote:</cite><blockquote><div><p>Nothing is expected to work after the setpci secondary bus reset, it&#039;s only a test.&#160; Do not attempt to do anything with devices downstream of the bridge until after a reboot.&#160; That said, I do see QEMU reporting success for doing a hot reset on the bus, so I don&#039;t see why we&#039;re seeing so many reports that reset doesn&#039;t work on these cards.</p></div></blockquote></div><p>Looks like only folks from AMD/ATI knows the magic for a proper reset.</p></div></blockquote></div><p>I hope not.&#160; You&#039;ve shown that a secondary bus reset seems to reset the card and that QEMU is doing a secondary bus reset, we need to figure out why that&#039;s not sufficient.&#160; Does it help to provide the ROM via romfile instead of reading it from the card?&#160; Does playing with the parameters for the reset help?&#160; Will multiple resets help?&#160; Does PCIe link down produce a different result?&#160; We need someone that can debug and experiment with the card in front of them.&#160; It might help to document what guests and what drivers result in the problem.&#160; Does Windows with the Catalyst driver cause it?&#160; Does Linux with the radeon driver cause it?&#160; fglrx?&#160; What exactly goes wrong in each case?</p> </div> <div class="postsignature postmsg"><hr /><p><a href="http://vfio.blogspot.com" rel="nofollow">http://vfio.blogspot.com</a><br />Looking for a more open forum to discuss vfio related uses?&#160; Try <a href="https://www.redhat.com/mailman/listinfo/vfio-users" rel="nofollow">https://www.redhat.com/mailman/listinfo/vfio-users</a></p></div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1419432">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1419459" class="blockpost roweven"> <h2><span><span class="conr">#1843</span> <a href="viewtopic.php?pid=1419459#p1419459">2014-05-26 18:07:13</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=79237">mbroemme</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>From: Cologne</span></dd> <dd><span>Registered: 2014-02-05</span></dd> <dd><span>Posts: 39</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=79237">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>aw wrote:</cite><blockquote><div><p>I hope not.&#160; You&#039;ve shown that a secondary bus reset seems to reset the card and that QEMU is doing a secondary bus reset, we need to figure out why that&#039;s not sufficient.&#160; Does it help to provide the ROM via romfile instead of reading it from the card?&#160; Does playing with the parameters for the reset help?&#160; Will multiple resets help?&#160; Does PCIe link down produce a different result?&#160; We need someone that can debug and experiment with the card in front of them.&#160; It might help to document what guests and what drivers result in the problem.&#160; Does Windows with the Catalyst driver cause it?&#160; Does Linux with the radeon driver cause it?&#160; fglrx?&#160; What exactly goes wrong in each case?</p></div></blockquote></div><p>I&#039;ve tried it already with romfile half an hour ago but it doesn&#039;t help. The result is the same. About which reset parameters you&#039;re talking? Basically I can debug it and I&#039;ve started already to read instructions on how to use mmio trace as I believe fglrlx did some magic on unloading the module because once I unload the fglrx module before rebooting the VM, everything works fine. So right now I (mabye other as well with R9 series) have the following situation:</p><p>#1 Using Linux VM with radeon driver:</p><p>- This works fine on several reboots, but I guess the test case is not very meaningful because R9 series has only KMS working and everything on-top (Glamor, X, DRI) is unaccelerated.</p><p>#2 Using Linux VM with fglrx driver:</p><p>- Works on first boot only if you don&#039;t unload fglrx module before VM shutdown/reboot.<br />- Works on multiple reboots (I&#039;ve tried around 20 times) if you stop X inside VM, unload fglrx and make VM shutdown/reboot.</p><p>#3 Using Windows VM with catalyst:</p><p>- Works on first boot only if you don&#039;t eject the card before VM shutdown/reboot.<br />- Works on multiple reboots (also tried several times) if you eject the card inside VM from device manager. This is only workaround for Win8/8.1 as Win7 and earlier require reboot once you remove PCI/PCIe device.</p><p>This is what I have for now, maybe others have different experience.</p> <p class="postedit"><em>Last edited by mbroemme (2014-05-26 18:07:49)</em></p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1419459">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1419484" class="blockpost rowodd"> <h2><span><span class="conr">#1844</span> <a href="viewtopic.php?pid=1419484#p1419484">2014-05-26 19:07:18</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=75590">aw</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2013-10-04</span></dd> <dd><span>Posts: 921</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=75590">Email</a></span> <span class="website"><a href="http://vfio.blogspot.com/" rel="nofollow">Website</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>mbroemme wrote:</cite><blockquote><div><div class="quotebox"><cite>aw wrote:</cite><blockquote><div><p>I hope not.&#160; You&#039;ve shown that a secondary bus reset seems to reset the card and that QEMU is doing a secondary bus reset, we need to figure out why that&#039;s not sufficient.&#160; Does it help to provide the ROM via romfile instead of reading it from the card?&#160; Does playing with the parameters for the reset help?&#160; Will multiple resets help?&#160; Does PCIe link down produce a different result?&#160; We need someone that can debug and experiment with the card in front of them.&#160; It might help to document what guests and what drivers result in the problem.&#160; Does Windows with the Catalyst driver cause it?&#160; Does Linux with the radeon driver cause it?&#160; fglrx?&#160; What exactly goes wrong in each case?</p></div></blockquote></div><p>I&#039;ve tried it already with romfile half an hour ago but it doesn&#039;t help. The result is the same. About which reset parameters you&#039;re talking? Basically I can debug it and I&#039;ve started already to read instructions on how to use mmio trace as I believe fglrlx did some magic on unloading the module because once I unload the fglrx module before rebooting the VM, everything works fine. So right now I (mabye other as well with R9 series) have the following situation:</p><p>#1 Using Linux VM with radeon driver:</p><p>- This works fine on several reboots, but I guess the test case is not very meaningful because R9 series has only KMS working and everything on-top (Glamor, X, DRI) is unaccelerated.</p><p>#2 Using Linux VM with fglrx driver:</p><p>- Works on first boot only if you don&#039;t unload fglrx module before VM shutdown/reboot.<br />- Works on multiple reboots (I&#039;ve tried around 20 times) if you stop X inside VM, unload fglrx and make VM shutdown/reboot.</p><p>#3 Using Windows VM with catalyst:</p><p>- Works on first boot only if you don&#039;t eject the card before VM shutdown/reboot.<br />- Works on multiple reboots (also tried several times) if you eject the card inside VM from device manager. This is only workaround for Win8/8.1 as Win7 and earlier require reboot once you remove PCI/PCIe device.</p><p>This is what I have for now, maybe others have different experience.</p></div></blockquote></div><p>So both the Linux and Windows drivers from AMD are doing something to the card on shutdown/reboot that they don&#039;t do if unbinding the device prior to reboot.&#160; My first guess would be that they put it into D3 power state in the former case, but not the latter.&#160; We do try to wake the device back into D0 before we do a bus reset, but maybe that&#039;s not working (it works for most devices).&#160; You could try to hide the PM capability from the guest.&#160; Some drivers will ignore whether we expose the capability and have it hard coded, but it&#039;s worth a shot.&#160; IIRC, to hide the capability, find vfio_add_std_cap() in qemu hw/misc/vfio.c, after the &quot;case PCI_CAP_ID_PM:&quot; line add a new line that does &quot;return 0;&quot;.&#160; You can also compare the state of the device in the host with lspci -vvv after a shutdown with the driver attached and a shutdown with the device ejected/unbound.</p> </div> <div class="postsignature postmsg"><hr /><p><a href="http://vfio.blogspot.com" rel="nofollow">http://vfio.blogspot.com</a><br />Looking for a more open forum to discuss vfio related uses?&#160; Try <a href="https://www.redhat.com/mailman/listinfo/vfio-users" rel="nofollow">https://www.redhat.com/mailman/listinfo/vfio-users</a></p></div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1419484">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1419503" class="blockpost roweven"> <h2><span><span class="conr">#1845</span> <a href="viewtopic.php?pid=1419503#p1419503">2014-05-26 19:56:45</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=79237">mbroemme</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>From: Cologne</span></dd> <dd><span>Registered: 2014-02-05</span></dd> <dd><span>Posts: 39</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=79237">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>aw wrote:</cite><blockquote><div><p>So both the Linux and Windows drivers from AMD are doing something to the card on shutdown/reboot that they don&#039;t do if unbinding the device prior to reboot.&#160; My first guess would be that they put it into D3 power state in the former case, but not the latter.&#160; We do try to wake the device back into D0 before we do a bus reset, but maybe that&#039;s not working (it works for most devices).&#160; You could try to hide the PM capability from the guest.&#160; Some drivers will ignore whether we expose the capability and have it hard coded, but it&#039;s worth a shot.&#160; IIRC, to hide the capability, find vfio_add_std_cap() in qemu hw/misc/vfio.c, after the &quot;case PCI_CAP_ID_PM:&quot; line add a new line that does &quot;return 0;&quot;.</p></div></blockquote></div><p>Okay I tried this but it doesn&#039;t change the behavior. On reboot of Linux VM fglrx still oops and Windows VM get BSOD.</p><div class="quotebox"><cite>aw wrote:</cite><blockquote><div><p>You can also compare the state of the device in the host with lspci -vvv after a shutdown with the driver attached and a shutdown with the device ejected/unbound.</p></div></blockquote></div><p>This is the difference between &quot;#1 boot of Linux VM, start X, stop X, poweroff&quot; and &quot;#2 boot of Linux VM, start X, stop X, rmmod fglrx, poweroff&quot;. Between both tests I&#039;ve rebooted the host.</p><div class="codebox"><pre><code>--- lspci.1 2014-05-26 21:48:06.460661219 +0200 +++ lspci.2 2014-05-26 21:50:23.875239015 +0200 @@ -23,7 +23,7 @@ ClockPM- Surprise- LLActRep- BwNot- LnkCtl: ASPM L0s L1 Enabled; RCB 64 bytes Disabled- CommClk+ ExtSynch- ClockPM- AutWidDis- BWInt- AutBWInt- - LnkSta: Speed 2.5GT/s, Width x1, TrErr- Train- SlotClk+ DLActive- BWMgmt- ABWMgmt- + LnkSta: Speed 5GT/s, Width x16, TrErr- Train- SlotClk+ DLActive- BWMgmt- ABWMgmt- DevCap2: Completion Timeout: Not Supported, TimeoutDis-, LTR-, OBFF Not Supported DevCtl2: Completion Timeout: 50us to 50ms, TimeoutDis-, LTR-, OBFF Disabled LnkCtl2: Target Link Speed: 8GT/s, EnterCompliance- SpeedDis-</code></pre></div><p>lspci.1 is after shutdown of Linux VM in #1<br />lspci.2 is after shutdown of Linux VM in #2</p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1419503">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1419520" class="blockpost rowodd"> <h2><span><span class="conr">#1846</span> <a href="viewtopic.php?pid=1419520#p1419520">2014-05-26 20:36:13</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=75590">aw</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2013-10-04</span></dd> <dd><span>Posts: 921</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=75590">Email</a></span> <span class="website"><a href="http://vfio.blogspot.com/" rel="nofollow">Website</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>mbroemme wrote:</cite><blockquote><div><div class="quotebox"><cite>aw wrote:</cite><blockquote><div><p>So both the Linux and Windows drivers from AMD are doing something to the card on shutdown/reboot that they don&#039;t do if unbinding the device prior to reboot.&#160; My first guess would be that they put it into D3 power state in the former case, but not the latter.&#160; We do try to wake the device back into D0 before we do a bus reset, but maybe that&#039;s not working (it works for most devices).&#160; You could try to hide the PM capability from the guest.&#160; Some drivers will ignore whether we expose the capability and have it hard coded, but it&#039;s worth a shot.&#160; IIRC, to hide the capability, find vfio_add_std_cap() in qemu hw/misc/vfio.c, after the &quot;case PCI_CAP_ID_PM:&quot; line add a new line that does &quot;return 0;&quot;.</p></div></blockquote></div><p>Okay I tried this but it doesn&#039;t change the behavior. On reboot of Linux VM fglrx still oops and Windows VM get BSOD.</p><div class="quotebox"><cite>aw wrote:</cite><blockquote><div><p>You can also compare the state of the device in the host with lspci -vvv after a shutdown with the driver attached and a shutdown with the device ejected/unbound.</p></div></blockquote></div><p>This is the difference between &quot;#1 boot of Linux VM, start X, stop X, poweroff&quot; and &quot;#2 boot of Linux VM, start X, stop X, rmmod fglrx, poweroff&quot;. Between both tests I&#039;ve rebooted the host.</p><div class="codebox"><pre><code>--- lspci.1 2014-05-26 21:48:06.460661219 +0200 +++ lspci.2 2014-05-26 21:50:23.875239015 +0200 @@ -23,7 +23,7 @@ ClockPM- Surprise- LLActRep- BwNot- LnkCtl: ASPM L0s L1 Enabled; RCB 64 bytes Disabled- CommClk+ ExtSynch- ClockPM- AutWidDis- BWInt- AutBWInt- - LnkSta: Speed 2.5GT/s, Width x1, TrErr- Train- SlotClk+ DLActive- BWMgmt- ABWMgmt- + LnkSta: Speed 5GT/s, Width x16, TrErr- Train- SlotClk+ DLActive- BWMgmt- ABWMgmt- DevCap2: Completion Timeout: Not Supported, TimeoutDis-, LTR-, OBFF Not Supported DevCtl2: Completion Timeout: 50us to 50ms, TimeoutDis-, LTR-, OBFF Disabled LnkCtl2: Target Link Speed: 8GT/s, EnterCompliance- SpeedDis-</code></pre></div><p>lspci.1 is after shutdown of Linux VM in #1<br />lspci.2 is after shutdown of Linux VM in #2</p></div></blockquote></div><p>#1 is the case that fails and #2 is the case that works, right?&#160; The link status looks a lot more correct in #2.&#160; The next thing I would try would be testing whether we can poke at the PCIe capability registers on the device to get it to state #2.&#160; So I would look at the LnkSta just after boot, repeat the steps for #1, do the setpci bus reset, then look at the LnkSta for the device again.&#160; Is it any closer to the state just after boot or state #2 (several things should go to reset values after bus reset, concentrate on PCIe status registers)?&#160; If not, we can try to retrain the link.&#160; Here&#039;s another setpci sequence, do this after doing the setpci bus reset:</p><p>(assuming GPU is 2:00.0, replace with your device address)</p><div class="codebox"><pre><code>$ sudo lspci -v -s 2:00.0 | grep Express Capabilities: [58] Express Legacy Endpoint, MSI 00</code></pre></div><p>The PCIe capability is therefore at 0x58, the link control register is offset 0x10 into the PCIe capability, therefore</p><div class="codebox"><pre><code>printf %x $(( 0x58 + 0x10 )) 68</code></pre></div><p>Read the original value of this register</p><div class="codebox"><pre><code>sudo setpci -s 2:00.0 68.w 0040</code></pre></div><p>The retrain bit is bit 5 (0x20)</p><div class="codebox"><pre><code>printf %x $(( 0x40 | 0x20 )) 60</code></pre></div><p>Write this value back</p><div class="codebox"><pre><code>sudo setpci -s 2:00.0 68.w=60</code></pre></div><p>This bit doesn&#039;t need to be cleared, re-read LnkSta with lspci and see if anything has changed.&#160; Regardless of whether it has, a reboot is required before trying to use the device, so don&#039;t bother trying to start QEMU again.</p><p>If it doesn&#039;t do anything, then we might need to look at a VFIO debug trace of case #1 to see if we can get any clues what the driver is doing to the device to get it into that state.</p> </div> <div class="postsignature postmsg"><hr /><p><a href="http://vfio.blogspot.com" rel="nofollow">http://vfio.blogspot.com</a><br />Looking for a more open forum to discuss vfio related uses?&#160; Try <a href="https://www.redhat.com/mailman/listinfo/vfio-users" rel="nofollow">https://www.redhat.com/mailman/listinfo/vfio-users</a></p></div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1419520">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1419556" class="blockpost roweven"> <h2><span><span class="conr">#1847</span> <a href="viewtopic.php?pid=1419556#p1419556">2014-05-26 22:00:59</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=79237">mbroemme</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>From: Cologne</span></dd> <dd><span>Registered: 2014-02-05</span></dd> <dd><span>Posts: 39</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=79237">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>aw wrote:</cite><blockquote><div><p>#1 is the case that fails and #2 is the case that works, right?</p></div></blockquote></div><p>Yes.</p><div class="quotebox"><cite>aw wrote:</cite><blockquote><div><p>The link status looks a lot more correct in #2.</p></div></blockquote></div><p>Yes.</p><div class="quotebox"><cite>aw wrote:</cite><blockquote><div><p>The next thing I would try would be testing whether we can poke at the PCIe capability registers on the device to get it to state #2.&#160; So I would look at the LnkSta just after boot, repeat the steps for #1, do the setpci bus reset, then look at the LnkSta for the device again.&#160; Is it any closer to the state just after boot or state #2 (several things should go to reset values after bus reset, concentrate on PCIe status registers)?</p></div></blockquote></div><p>Okay I did the setpci bus reset using the following command sequence, valid for my system:</p><div class="codebox"><pre><code>setpci -s 00:0b.0 3e.w printf %04x $(( 0x0008 | 0x40 )) setpci -s 00:0b.0 3e.w=0048 setpci -s 00:0b.0 3e.w=0008</code></pre></div><p>I&#039;ll hope it was right as you mentioned in previous post &quot;secondary bus reset&quot;, after that I get original LnkSta back:</p><div class="codebox"><pre><code>LnkSta: Speed 5GT/s, Width x16, TrErr- Train- SlotClk+ DLActive- BWMgmt- ABWMgmt-</code></pre></div><p>And of course I cannot start the VM via QEMU as mentioned by you.</p><div class="quotebox"><cite>aw wrote:</cite><blockquote><div><p>If not, we can try to retrain the link.&#160; Here&#039;s another setpci sequence, do this after doing the setpci bus reset:</p><p>(assuming GPU is 2:00.0, replace with your device address)</p><div class="codebox"><pre><code>$ sudo lspci -v -s 2:00.0 | grep Express Capabilities: [58] Express Legacy Endpoint, MSI 00</code></pre></div><p>The PCIe capability is therefore at 0x58, the link control register is offset 0x10 into the PCIe capability, therefore</p><div class="codebox"><pre><code>printf %x $(( 0x58 + 0x10 )) 68</code></pre></div><p>Read the original value of this register</p><div class="codebox"><pre><code>sudo setpci -s 2:00.0 68.w 0040</code></pre></div><p>The retrain bit is bit 5 (0x20)</p><div class="codebox"><pre><code>printf %x $(( 0x40 | 0x20 )) 60</code></pre></div><p>Write this value back</p><div class="codebox"><pre><code>sudo setpci -s 2:00.0 68.w=60</code></pre></div><p>This bit doesn&#039;t need to be cleared, re-read LnkSta with lspci and see if anything has changed.&#160; Regardless of whether it has, a reboot is required before trying to use the device, so don&#039;t bother trying to start QEMU again.</p><p>If it doesn&#039;t do anything, then we might need to look at a VFIO debug trace of case #1 to see if we can get any clues what the driver is doing to the device to get it into that state.</p></div></blockquote></div><p>This was not needed as bus reset above already restored LinkSta.</p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1419556">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1419557" class="blockpost rowodd"> <h2><span><span class="conr">#1848</span> <a href="viewtopic.php?pid=1419557#p1419557">2014-05-26 22:06:12</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=75590">aw</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2013-10-04</span></dd> <dd><span>Posts: 921</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=75590">Email</a></span> <span class="website"><a href="http://vfio.blogspot.com/" rel="nofollow">Website</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>mbroemme wrote:</cite><blockquote><div><div class="quotebox"><cite>aw wrote:</cite><blockquote><div><p>#1 is the case that fails and #2 is the case that works, right?</p></div></blockquote></div><p>Yes.</p><div class="quotebox"><cite>aw wrote:</cite><blockquote><div><p>The link status looks a lot more correct in #2.</p></div></blockquote></div><p>Yes.</p><div class="quotebox"><cite>aw wrote:</cite><blockquote><div><p>The next thing I would try would be testing whether we can poke at the PCIe capability registers on the device to get it to state #2.&#160; So I would look at the LnkSta just after boot, repeat the steps for #1, do the setpci bus reset, then look at the LnkSta for the device again.&#160; Is it any closer to the state just after boot or state #2 (several things should go to reset values after bus reset, concentrate on PCIe status registers)?</p></div></blockquote></div><p>Okay I did the setpci bus reset using the following command sequence, valid for my system:</p><div class="codebox"><pre><code>setpci -s 00:0b.0 3e.w printf %04x $(( 0x0008 | 0x40 )) setpci -s 00:0b.0 3e.w=0048 setpci -s 00:0b.0 3e.w=0008</code></pre></div><p>I&#039;ll hope it was right as you mentioned in previous post &quot;secondary bus reset&quot;, after that I get original LnkSta back:</p><div class="codebox"><pre><code>LnkSta: Speed 5GT/s, Width x16, TrErr- Train- SlotClk+ DLActive- BWMgmt- ABWMgmt-</code></pre></div><p>And of course I cannot start the VM via QEMU as mentioned by you.</p></div></blockquote></div><p>Ok, so do we get the same result with QEMU?&#160; Setup the #1 case again, then start QEMU again with no disk so the VM only boots up to seabios.&#160; Quit QEMU.&#160; What&#039;s the lspci state of the device at that point compared to clean boot?</p> </div> <div class="postsignature postmsg"><hr /><p><a href="http://vfio.blogspot.com" rel="nofollow">http://vfio.blogspot.com</a><br />Looking for a more open forum to discuss vfio related uses?&#160; Try <a href="https://www.redhat.com/mailman/listinfo/vfio-users" rel="nofollow">https://www.redhat.com/mailman/listinfo/vfio-users</a></p></div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1419557">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1419561" class="blockpost roweven"> <h2><span><span class="conr">#1849</span> <a href="viewtopic.php?pid=1419561#p1419561">2014-05-26 22:19:55</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=79237">mbroemme</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>From: Cologne</span></dd> <dd><span>Registered: 2014-02-05</span></dd> <dd><span>Posts: 39</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=79237">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>aw wrote:</cite><blockquote><div><p>Ok, so do we get the same result with QEMU?&#160; Setup the #1 case again, then start QEMU again with no disk so the VM only boots up to seabios.&#160; Quit QEMU.&#160; What&#039;s the lspci state of the device at that point compared to clean boot?</p></div></blockquote></div><p><strong>EDIT:</strong> Oops I was wrong with diff. I&#039;ve edited the lspci and updated it!</p><p>I created new lspci outputs. This is the diff after this test case:</p><div class="codebox"><pre class="vscroll"><code>--- lspci.3 2014-05-27 00:23:49.016539086 +0200 +++ lspci.4 2014-05-27 00:27:07.796718133 +0200 @@ -1,12 +1,12 @@ 04:00.0 VGA compatible controller: Advanced Micro Devices, Inc. [AMD/ATI] Hawaii XT [Radeon HD 8970] (prog-if 00 [VGA controller]) Subsystem: Advanced Micro Devices, Inc. [AMD/ATI] Device 0b00 - Control: I/O- Mem- BusMaster- SpecCycle- MemWINV- VGASnoop- ParErr- Stepping- SERR- FastB2B- DisINTx- + Control: I/O+ Mem+ BusMaster- SpecCycle- MemWINV- VGASnoop- ParErr- Stepping- SERR- FastB2B- DisINTx- Status: Cap+ 66MHz- UDF- FastB2B- ParErr- DEVSEL=fast &gt;TAbort- &lt;TAbort- &lt;MAbort- &gt;SERR- &lt;PERR- INTx- - Interrupt: pin A routed to IRQ 10 - Region 0: Memory at c0000000 (64-bit, prefetchable) [disabled] [size=256M] - Region 2: Memory at df800000 (64-bit, prefetchable) [disabled] [size=8M] - Region 4: I/O ports at ce00 [disabled] [size=256] - Region 5: Memory at fdc80000 (32-bit, non-prefetchable) [disabled] [size=256K] + Interrupt: pin A routed to IRQ 19 + Region 0: Memory at c0000000 (64-bit, prefetchable) [size=256M] + Region 2: Memory at df800000 (64-bit, prefetchable) [size=8M] + Region 4: I/O ports at ce00 [size=256] + Region 5: Memory at fdc80000 (32-bit, non-prefetchable) [size=256K] [virtual] Expansion ROM at d0000000 [disabled] [size=128K] Capabilities: [48] Vendor Specific Information: Len=08 &lt;?&gt; Capabilities: [50] Power Management version 3 @@ -44,7 +44,7 @@ Capabilities: [270 v1] #19 Capabilities: [2b0 v1] Address Translation Service (ATS) ATSCap: Invalidate Queue Depth: 00 - ATSCtl: Enable+, Smallest Translation Unit: 00 + ATSCtl: Enable-, Smallest Translation Unit: 00 Capabilities: [2c0 v1] #13 Capabilities: [2d0 v1] #1b Kernel driver in use: vfio-pci</code></pre></div> <p class="postedit"><em>Last edited by mbroemme (2014-05-26 22:26:26)</em></p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1419561">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1419566" class="blockpost rowodd"> <h2><span><span class="conr">#1850</span> <a href="viewtopic.php?pid=1419566#p1419566">2014-05-26 22:38:55</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=79237">mbroemme</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>From: Cologne</span></dd> <dd><span>Registered: 2014-02-05</span></dd> <dd><span>Posts: 39</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=79237">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <p>Hmm... If I extend test case #1 by the following scenario I get another lspci diff:</p><p>#1 Test case from original #1<br />#2 Suspend/resume host<br />#3 lspci -vvv -s 04:00.0 &gt; lspci.5<br />#4 Repeat test case from original #1<br />#5 Start QEMU without any drive, wait until seabios shows &quot;No bootable device.&quot; and press STRG+C<br />#6 lspci -vvv -s 04:00.0 &gt; lspci.6</p><p>The diff is the following:</p><div class="codebox"><pre><code>--- lspci.5 2014-05-27 00:34:37.703926234 +0200 +++ lspci.6 2014-05-27 00:35:53.712763395 +0200 @@ -18,7 +18,7 @@ DevCtl: Report errors: Correctable- Non-Fatal- Fatal- Unsupported- RlxdOrd+ ExtTag- PhantFunc- AuxPwr- NoSnoop+ MaxPayload 128 bytes, MaxReadReq 512 bytes - DevSta: CorrErr- UncorrErr- FatalErr- UnsuppReq- AuxPwr- TransPend- + DevSta: CorrErr+ UncorrErr- FatalErr- UnsuppReq+ AuxPwr- TransPend- LnkCap: Port #0, Speed 8GT/s, Width x16, ASPM L0s L1, Exit Latency L0s &lt;64ns, L1 &lt;1us ClockPM- Surprise- LLActRep- BwNot- LnkCtl: ASPM L0s L1 Enabled; RCB 64 bytes Disabled- CommClk+ @@ -38,7 +38,7 @@ UESta: DLP- SDES- TLP- FCP- CmpltTO- CmpltAbrt- UnxCmplt- RxOF- MalfTLP- ECRC- UnsupReq- ACSViol- UEMsk: DLP- SDES- TLP- FCP- CmpltTO- CmpltAbrt- UnxCmplt- RxOF- MalfTLP- ECRC- UnsupReq- ACSViol- UESvrt: DLP+ SDES+ TLP- FCP+ CmpltTO- CmpltAbrt- UnxCmplt- RxOF+ MalfTLP+ ECRC- UnsupReq- ACSViol- - CESta: RxErr- BadTLP- BadDLLP- Rollover- Timeout- NonFatalErr- + CESta: RxErr- BadTLP- BadDLLP- Rollover- Timeout- NonFatalErr+ CEMsk: RxErr- BadTLP- BadDLLP- Rollover- Timeout- NonFatalErr+ AERCap: First Error Pointer: 00, GenCap+ CGenEn- ChkCap+ ChkEn- Capabilities: [270 v1] #19</code></pre></div> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1419566">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div class="postlinksb"> <div class="inbox crumbsplus"> <div class="pagepost"> <p class="pagelink conl"><span class="pages-label">Pages: </span><a rel="prev" class="item1" href="viewtopic.php?id=162768&amp;p=73">Previous</a> <a href="viewtopic.php?id=162768">1</a> <span class="spacer">…</span> <a href="viewtopic.php?id=162768&amp;p=72">72</a> <a href="viewtopic.php?id=162768&amp;p=73">73</a> <strong>74</strong> <a href="viewtopic.php?id=162768&amp;p=75">75</a> <a href="viewtopic.php?id=162768&amp;p=76">76</a> <span class="spacer">…</span> <a href="viewtopic.php?id=162768&amp;p=234">234</a> <a rel="next" href="viewtopic.php?id=162768&amp;p=75">Next</a></p> <p class="postlink conr">Topic closed</p> </div> <ul class="crumbs"> <li><a href="index.php">Index</a></li> <li><span>»&#160;</span><a href="viewforum.php?id=48">Topics Going Nowhere</a></li> <li><span>»&#160;</span><strong><a href="viewtopic.php?id=162768">KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</a></strong></li> </ul> <p class="subscribelink clearb"><a href="misc.php?action=subscribe&amp;tid=162768">Subscribe to this topic</a></p> <div class="clearer"></div> </div> </div> </div> <div id="brdfooter" class="block"> <h2><span>Board footer</span></h2> <div class="box"> <div id="brdfooternav" class="inbox"> <div class="conl"> <form id="qjump" method="get" action="viewforum.php"> <div><label><span>Jump to<br /></span> <select name="id" onchange="window.location=('viewforum.php?id='+this.options[this.selectedIndex].value)"> <optgroup label="Technical Issues and Assistance"> <option value="23">Newbie Corner</option> <option value="17">Installation</option> <option value="22">Kernel &amp; Hardware</option> <option value="18">Applications &amp; Desktop Environments</option> <option value="31">Laptop Issues</option> <option value="8">Networking, Server, and Protection</option> <option value="32">Multimedia and Games</option> <option value="50">System Administration</option> <option value="35">Other Architectures</option> </optgroup> <optgroup label="Arch-centric"> <option value="24">Announcements, Package &amp; Security Advisories</option> <option value="1">Arch Discussion</option> <option value="13">Forum &amp; Wiki discussion</option> </optgroup> <optgroup label="Pacman Upgrades, Packaging &amp; AUR"> <option value="44">Pacman &amp; Package Upgrade Issues</option> <option value="49">[testing] Repo Forum</option> <option value="4">Creating &amp; Modifying Packages</option> <option value="38">AUR Issues, Discussion &amp; PKGBUILD Requests</option> </optgroup> <optgroup label="Contributions &amp; Discussion"> <option value="20">GNU/Linux Discussion</option> <option value="27">Community Contributions</option> <option value="33">Programming &amp; Scripting</option> <option value="30">Other Languages</option> <option value="47">Artwork and Screenshots</option> <option value="42">Try This</option> </optgroup> <optgroup label="/dev/null"> <option value="29">Off-Topic</option> <option value="48" selected="selected">Topics Going Nowhere</option> <option value="36">Dustbin</option> </optgroup> </select></label> <input type="submit" value=" Go " accesskey="g" /> </div> </form> </div> <div class="conr"> <p id="feedlinks"><span class="atom"><a href="extern.php?action=feed&amp;tid=162768&amp;type=atom">Atom topic feed</a></span></p> <p id="poweredby">Powered by <a href="http://fluxbb.org/">FluxBB</a></p> </div> <div class="clearer"></div> </div> </div> </div> </div> <div class="end-box"></div> </div> </body> </html>
