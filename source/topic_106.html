<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"> <html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en" dir="ltr"> <head> <meta http-equiv="Content-Type" content="text/html; charset=utf-8" /> <title>KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9 (Page 106) / Topics Going Nowhere / Arch Linux Forums</title> <link rel="stylesheet" type="text/css" href="style/ArchLinux.css" /> <link rel="canonical" href="viewtopic.php?id=162768&amp;p=106" title="Page 106" /> <link rel="prev" href="viewtopic.php?id=162768&amp;p=105" title="Page 105" /> <link rel="next" href="viewtopic.php?id=162768&amp;p=107" title="Page 107" /> <link rel="alternate" type="application/atom+xml" href="extern.php?action=feed&amp;tid=162768&amp;type=atom" title="Atom topic feed" /> <link rel="stylesheet" media="screen" href="style/ArchLinux/arch.css?v=3" /> <link rel="stylesheet" media="screen" href="style/ArchLinux/archnavbar.css?v=2" /> <link rel="shortcut icon" href="style/ArchLinux/favicon.ico" /> </head> <body> <div id="archnavbar" class="anb-forum"> <div id="archnavbarlogo"><h1><a href="http://www.archlinux.org/">Arch Linux</a></h1></div> <div id="archnavbarmenu"> <ul id="archnavbarlist"> <li id="anb-home"><a href="http://www.archlinux.org/">Home</a></li><li id="anb-packages"><a href="http://www.archlinux.org/packages/">Packages</a></li><li id="anb-forums" class="anb-selected"><a href="https://bbs.archlinux.org/">Forums</a></li><li id="anb-wiki"><a href="https://wiki.archlinux.org/">Wiki</a></li><li id="anb-bugs"><a href="https://bugs.archlinux.org/">Bugs</a></li><li id="anb-aur"><a href="https://aur.archlinux.org/">AUR</a></li><li id="anb-download"><a href="http://www.archlinux.org/download/">Download</a></li> </ul> </div> </div> <div id="punviewtopic" class="pun"> <div class="top-box"></div> <div class="punwrap"> <div id="brdheader" class="block"> <div class="box"> <div id="brdmenu" class="inbox"> <ul> <li id="navindex" class="isactive"><a href="index.php">Index</a></li> <li id="navuserlist"><a href="userlist.php">User list</a></li> <li id="navsearch"><a href="search.php">Search</a></li> <li id="navprofile"><a href="profile.php?id=80749">Profile</a></li> <li id="navlogout"><a href="login.php?action=out&amp;id=80749&amp;csrf_token=5c20501ec397bb45ef8ee8c84db232c8d8e421c6">Logout</a></li> </ul> </div> <div id="brdwelcome" class="inbox"> <ul class="conl"> <li><span>Logged in as <strong>SXX</strong></span></li> <li><span>Last visit: 2015-08-16 12:20:09</span></li> </ul> <ul class="conr"> <li><span>Topics: <a href="search.php?action=show_replies" title="Find topics you have posted to.">Posted</a> | <a href="search.php?action=show_new" title="Find topics with new posts since your last visit.">New</a> | <a href="search.php?action=show_recent" title="Find topics with recent posts.">Active</a> | <a href="search.php?action=show_unanswered" title="Find topics with no replies.">Unanswered</a></span></li> </ul> <div class="clearer"></div> </div> </div> </div> <div id="brdmain"> <div class="linkst"> <div class="inbox crumbsplus"> <ul class="crumbs"> <li><a href="index.php">Index</a></li> <li><span>»&#160;</span><a href="viewforum.php?id=48">Topics Going Nowhere</a></li> <li><span>»&#160;</span><strong><a href="viewtopic.php?id=162768">KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</a></strong></li> </ul> <div class="pagepost"> <p class="pagelink conl"><span class="pages-label">Pages: </span><a rel="prev" class="item1" href="viewtopic.php?id=162768&amp;p=105">Previous</a> <a href="viewtopic.php?id=162768">1</a> <span class="spacer">…</span> <a href="viewtopic.php?id=162768&amp;p=104">104</a> <a href="viewtopic.php?id=162768&amp;p=105">105</a> <strong>106</strong> <a href="viewtopic.php?id=162768&amp;p=107">107</a> <a href="viewtopic.php?id=162768&amp;p=108">108</a> <span class="spacer">…</span> <a href="viewtopic.php?id=162768&amp;p=234">234</a> <a rel="next" href="viewtopic.php?id=162768&amp;p=107">Next</a></p> <p class="postlink conr">Topic closed</p> </div> <div class="clearer"></div> </div> </div> <div id="p1452388" class="blockpost rowodd blockpost1"> <h2><span><span class="conr">#2626</span> <a href="viewtopic.php?pid=1452388#p1452388">2014-08-31 22:02:10</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=75590">aw</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2013-10-04</span></dd> <dd><span>Posts: 921</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=75590">Email</a></span> <span class="website"><a href="http://vfio.blogspot.com/" rel="nofollow">Website</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>Cenm wrote:</cite><blockquote><div><div class="quotebox"><cite>aw wrote:</cite><blockquote><div><p>It&#039;s possible you need the &quot;other&quot; VGA arbiter patch listed in <a href="http://vfio.blogspot.com/2014/08/vfiovga-faq.html" rel="nofollow">question 4 of the FAQ</a>.&#160; That bug in arbitration was found with radeon, but if nouveau behaves similarly, the arbiter might be getting stuck with VGA routing enabled to the wrong device.</p></div></blockquote></div><p>Thanks. Will try that, but the same thing happens when the host is running the nvidia drivers.</p></div></blockquote></div><p>With the nvidia driver the problem is likely different, see FAQ question 9 and the link in the comment.&#160; The nvidia driver takes the vga lock and never releases it, so the monitor stays blank in that case because the guest is stalled waiting for VGA access.</p> </div> <div class="postsignature postmsg"><hr /><p><a href="http://vfio.blogspot.com" rel="nofollow">http://vfio.blogspot.com</a><br />Looking for a more open forum to discuss vfio related uses?&#160; Try <a href="https://www.redhat.com/mailman/listinfo/vfio-users" rel="nofollow">https://www.redhat.com/mailman/listinfo/vfio-users</a></p></div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1452388">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1452530" class="blockpost roweven"> <h2><span><span class="conr">#2627</span> <a href="viewtopic.php?pid=1452530#p1452530">2014-09-01 09:40:29</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=84759">Ansa89</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2014-08-30</span></dd> <dd><span>Posts: 20</span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>slis wrote:</cite><blockquote><div><p>@ansa89 you could try to remove that bios-256k option and u don&#039;t need gpu romfile option... and if u edit that script when adding gpu, care for spaces / new lines... that could be reason for not booting</p></div></blockquote></div><p>Now I&#039;m using this script:</p><div class="codebox"><pre><code># Bind VGA DEVICES=&quot;0000:01:00.0 0000:01:00.1&quot; for dev in $DEVICES ; do vendor=$(cat /sys/bus/pci/devices/$dev/vendor) device=$(cat /sys/bus/pci/devices/$dev/device) if [ -e /sys/bus/pci/devices/$dev/driver ]; then echo $dev &gt; /sys/bus/pci/devices/$dev/driver/unbind fi echo $vendor $device &gt; /sys/bus/pci/drivers/vfio-pci/new_id done # Start QEMU qemu-system-x86_64 -enable-kvm -M q35 -m 4096 -cpu host,kvm=off \ -smp 2,sockets=1,cores=2,threads=1 \ -bios /usr/share/qemu/bios.bin -vga none \ -rtc base=localtime \ -device ioh3420,bus=pcie.0,addr=1c.0,multifunction=on,port=1,chassis=1,id=root.1 \ -device vfio-pci,host=01:00.0,bus=root.1,addr=00.0,multifunction=on,x-vga=on \ -device vfio-pci,host=01:00.1,bus=root.1,addr=00.1 \ -drive file=/dev/sdc,id=disk,format=raw -device ide-hd,bus=ide.0,drive=disk \ -boot menu=on \ -netdev tap,ifname=qemu0,id=qemu_tap -device e1000,netdev=qemu_tap,mac=00:16:3E:12:34:56 \ -usb -usbdevice tablet</code></pre></div><p>The script is ok, since if I change &quot;-vga none&quot; to &quot;-vga std&quot; everything works (so the problem is due to GTX 650 being the primary VGA device).<br />Moreover you said &quot;not booting&quot;, but this isn&#039;t correct: the VM boots, but the monitor stays black and I can&#039;t connect to VNC server inside VM (I&#039;m enough sure about this because I can arping the VM ip).</p> <p class="postedit"><em>Last edited by Ansa89 (2014-09-01 09:42:04)</em></p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1452530">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1452591" class="blockpost rowodd"> <h2><span><span class="conr">#2628</span> <a href="viewtopic.php?pid=1452591#p1452591">2014-09-01 14:05:31</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=84731">Cenm</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2014-08-29</span></dd> <dd><span>Posts: 6</span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>aw wrote:</cite><blockquote><div><div class="quotebox"><cite>Cenm wrote:</cite><blockquote><div><div class="quotebox"><cite>aw wrote:</cite><blockquote><div><p>It&#039;s possible you need the &quot;other&quot; VGA arbiter patch listed in <a href="http://vfio.blogspot.com/2014/08/vfiovga-faq.html" rel="nofollow">question 4 of the FAQ</a>.&#160; That bug in arbitration was found with radeon, but if nouveau behaves similarly, the arbiter might be getting stuck with VGA routing enabled to the wrong device.</p></div></blockquote></div><p>Thanks. Will try that, but the same thing happens when the host is running the nvidia drivers.</p></div></blockquote></div><p>With the nvidia driver the problem is likely different, see FAQ question 9 and the link in the comment.&#160; The nvidia driver takes the vga lock and never releases it, so the monitor stays blank in that case because the guest is stalled waiting for VGA access.</p></div></blockquote></div><p>Thanks again.</p><p>Which host driver would you suggest? I see some reports of instability with nouveau, is that still the case?</p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1452591">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1452616" class="blockpost roweven"> <h2><span><span class="conr">#2629</span> <a href="viewtopic.php?pid=1452616#p1452616">2014-09-01 15:01:28</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=75590">aw</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2013-10-04</span></dd> <dd><span>Posts: 921</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=75590">Email</a></span> <span class="website"><a href="http://vfio.blogspot.com/" rel="nofollow">Website</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>Cenm wrote:</cite><blockquote><div><div class="quotebox"><cite>aw wrote:</cite><blockquote><div><div class="quotebox"><cite>Cenm wrote:</cite><blockquote><div><p>Thanks. Will try that, but the same thing happens when the host is running the nvidia drivers.</p></div></blockquote></div><p>With the nvidia driver the problem is likely different, see FAQ question 9 and the link in the comment.&#160; The nvidia driver takes the vga lock and never releases it, so the monitor stays blank in that case because the guest is stalled waiting for VGA access.</p></div></blockquote></div><p>Thanks again.</p><p>Which host driver would you suggest? I see some reports of instability with nouveau, is that still the case?</p></div></blockquote></div><p>Since I have no idea what you use the host graphics for, use whatever meets your needs.&#160; I prefer to use open source drivers where I can, but with graphics cards you may only get full performance and functionality with proprietary drivers.</p> </div> <div class="postsignature postmsg"><hr /><p><a href="http://vfio.blogspot.com" rel="nofollow">http://vfio.blogspot.com</a><br />Looking for a more open forum to discuss vfio related uses?&#160; Try <a href="https://www.redhat.com/mailman/listinfo/vfio-users" rel="nofollow">https://www.redhat.com/mailman/listinfo/vfio-users</a></p></div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1452616">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1453171" class="blockpost rowodd"> <h2><span><span class="conr">#2630</span> <a href="viewtopic.php?pid=1453171#p1453171">2014-09-03 02:43:44</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=78377">sitonapanotis</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2014-01-08</span></dd> <dd><span>Posts: 15</span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <p>So Ive been experiencing video stuttering when testing games and tried disabling nested page tables to see if that helped, but my system has an intel processor so this didnt seem to do anything.</p><p>I found the option for the intel equivelant (extended page tables) which seems to be kvm-intel.ept=0<br />I and added that to my /etc/modprobe.d/intel-kvm.conf.<br />With extended page tables disabled my windows guest crashes during boot. <br />Is that not how I would do the equivalent of disabling nested page tables on an intel processor?</p><p>Has anyone done this with an intel processor in an attempt to decrease stutter?<br />Any ideas where to go from here?</p> <p class="postedit"><em>Last edited by sitonapanotis (2014-09-03 02:59:16)</em></p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1453171">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1453172" class="blockpost roweven"> <h2><span><span class="conr">#2631</span> <a href="viewtopic.php?pid=1453172#p1453172">2014-09-03 02:55:18</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=75590">aw</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2013-10-04</span></dd> <dd><span>Posts: 921</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=75590">Email</a></span> <span class="website"><a href="http://vfio.blogspot.com/" rel="nofollow">Website</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>sitonapanotis wrote:</cite><blockquote><div><p>So Ive been experiencing video stuttering when testing games and tried disabling nested page tables to see if that helped, but my system has an intel processor so this didnt seem to do anything.</p><p>I found the option for the intel equivelant (extended page tables) which seems to be kvm-intel.ept=0<br />I and added that to my /etc/modprobe.d/intel-kvm.conf.<br />With extended page tables disabled my windows guest crashes during boot. <br />Is that not how I would do the equivalent of disabling nested page tables on an intel processor?</p><p>Has anyone done this with an intel processor in an atempt to decrease stutter?<br />Any ideas where to go from here?</p></div></blockquote></div><p>Nested paging typically provides a significant performance improvement, so I&#039;m not sure why you&#039;d want to disable it.&#160; Some people do claim that disabling nested guest support improves performance, but (a) I haven&#039;t seen substantiated evidence of that and (b) nested guests != nested paging.</p> </div> <div class="postsignature postmsg"><hr /><p><a href="http://vfio.blogspot.com" rel="nofollow">http://vfio.blogspot.com</a><br />Looking for a more open forum to discuss vfio related uses?&#160; Try <a href="https://www.redhat.com/mailman/listinfo/vfio-users" rel="nofollow">https://www.redhat.com/mailman/listinfo/vfio-users</a></p></div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1453172">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1453175" class="blockpost rowodd"> <h2><span><span class="conr">#2632</span> <a href="viewtopic.php?pid=1453175#p1453175">2014-09-03 03:01:03</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=78377">sitonapanotis</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2014-01-08</span></dd> <dd><span>Posts: 15</span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>aw wrote:</cite><blockquote><div><div class="quotebox"><cite>sitonapanotis wrote:</cite><blockquote><div><p>So Ive been experiencing video stuttering when testing games and tried disabling nested page tables to see if that helped, but my system has an intel processor so this didnt seem to do anything.</p><p>I found the option for the intel equivelant (extended page tables) which seems to be kvm-intel.ept=0<br />I and added that to my /etc/modprobe.d/intel-kvm.conf.<br />With extended page tables disabled my windows guest crashes during boot. <br />Is that not how I would do the equivalent of disabling nested page tables on an intel processor?</p><p>Has anyone done this with an intel processor in an atempt to decrease stutter?<br />Any ideas where to go from here?</p></div></blockquote></div><p>Nested paging typically provides a significant performance improvement, so I&#039;m not sure why you&#039;d want to disable it.&#160; Some people do claim that disabling nested guest support improves performance, but (a) I haven&#039;t seen substantiated evidence of that and (b) nested guests != nested paging.</p></div></blockquote></div><br /><p>Ah I was only trying it because OP suggested it, but what I have read about it does seem to make what you are saying make more sense.<br />Any other ideas for troubleshooting latency/stuttering issues?</p><p>edit: in windows LatencyMon is reporting some pretty high latency <a href="http://i.imgur.com/G299o61.jpg" rel="nofollow">http://i.imgur.com/G299o61.jpg</a></p> <p class="postedit"><em>Last edited by sitonapanotis (2014-09-03 03:23:55)</em></p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1453175">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1453257" class="blockpost roweven"> <h2><span><span class="conr">#2633</span> <a href="viewtopic.php?pid=1453257#p1453257">2014-09-03 12:33:29</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=80830">gneville</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2014-04-02</span></dd> <dd><span>Posts: 27</span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <p>Hi,</p><p>I&#039;ve been using vfio-vga passthrough for quite some time now with my Radaeon R9 290 and everything has been working really great.</p><p>However after seeing aw&#039;s blog, I wanted to try to get libvirt working and then move to an OVMF setup but I&#039;m having a few issues which I can&#039;t seem to resolve.</p><p>I have successfully setup 1 ubuntu guest using libvirt and virsh but I can&#039;t get my Windows8 guest, which has a Radeon R9 290 passed through to it to start. I&#039;m getting the following:</p><div class="quotebox"><blockquote><div><p>[root@i7-4770s ~]# virsh start windows8<br />error: Failed to start domain windows8<br />error: internal error: early end of file from monitor: possible problem:<br />2014-09-03T13:07:19.859907Z qemu-system-x86_64: -device vfio-pci,host=01:00.0,bus=root.1,addr=00.0,multifunction=on,x-vga=on: vfio_dma_map(0x7f256&#160; &#160; &#160;220c0c0, 0x0, 0x8be00000, 0x7f24b4200000) = -12 (Cannot allocate memory)<br />2014-09-03T13:07:19.859970Z qemu-system-x86_64: -device vfio-pci,host=01:00.0,bus=root.1,addr=00.0,multifunction=on,x-vga=on: vfio: memory listene&#160; &#160; &#160;r initialization failed for container<br />2014-09-03T13:07:19.859982Z qemu-system-x86_64: -device vfio-pci,host=01:00.0,bus=root.1,addr=00.0,multifunction=on,x-vga=on: vfio: failed to setu&#160; &#160; &#160;p container for group 1<br />2014-09-03T13:07:19.860017Z qemu-system-x86_64: -device vfio-pci,host=01:00.0,bus=root.1,addr=00.0,multifunction=on,x-vga=on: vfio: failed to get&#160; &#160; &#160; group 1<br />2014-09-03T13:07:19.860031Z qemu-system-x86_64: -device vfio-pci,host=01:00.0,bus=root.1,addr=00.0,multifunction=on,x-vga=on: Device initializatio&#160; &#160; &#160;n failed.<br />2014-09-03T13:07:19.860045Z qemu-system-x86_64: -device vfio-pci,host=01:00.0,bus=root.1,</p></div></blockquote></div><p>I see some other posts on here about the same issue, but that seems to be when they wish to run start the guest as another user other than root. Regardless I have tried changing my ulimits but with no effect:</p><p>[root@i7-4770s ~]# ulimit -l<br />8650752</p><p>I have tried changing the RAM allocated to the Guest to 2GB from 6GB to see if there is any difference but no luck also.</p><p>Any suggestions please?</p><p>I&#039;m running Arch Linux with the Kernel from the OP (3.15.0-1-mainline)</p><p>Thanks</p><p>Graham</p> <p class="postedit"><em>Last edited by gneville (2014-09-03 13:15:00)</em></p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1453257">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1453277" class="blockpost rowodd"> <h2><span><span class="conr">#2634</span> <a href="viewtopic.php?pid=1453277#p1453277">2014-09-03 13:35:32</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=80830">gneville</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2014-04-02</span></dd> <dd><span>Posts: 27</span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <p>Just spotted the following in dmseg, need to investigate further:</p><div class="quotebox"><blockquote><div><p>[&#160; &#160;49.781160] qemu-system-x86: sending ioctl 5326 to a partition!<br />[&#160; &#160;49.781168] qemu-system-x86: sending ioctl 80200204 to a partition!<br />[&#160; &#160;49.781572] qemu-system-x86: sending ioctl 5326 to a partition!<br />[&#160; &#160;49.781577] qemu-system-x86: sending ioctl 80200204 to a partition!<br />[&#160; &#160;49.940979] vfio_pin_pages: RLIMIT_MEMLOCK (65536) exceeded<br />[&#160; &#160;49.940993] vfio_pin_pages: RLIMIT_MEMLOCK (65536) exceeded</p></div></blockquote></div><div class="quotebox"><cite>gneville wrote:</cite><blockquote><div><p>Hi,</p><p>I&#039;ve been using vfio-vga passthrough for quite some time now with my Radaeon R9 290 and everything has been working really great.</p><p>However after seeing aw&#039;s blog, I wanted to try to get libvirt working and then move to an OVMF setup but I&#039;m having a few issues which I can&#039;t seem to resolve.</p><p>I have successfully setup 1 ubuntu guest using libvirt and virsh but I can&#039;t get my Windows8 guest, which has a Radeon R9 290 passed through to it to start. I&#039;m getting the following:</p><div class="quotebox"><blockquote><div><p>[root@i7-4770s ~]# virsh start windows8<br />error: Failed to start domain windows8<br />error: internal error: early end of file from monitor: possible problem:<br />2014-09-03T13:07:19.859907Z qemu-system-x86_64: -device vfio-pci,host=01:00.0,bus=root.1,addr=00.0,multifunction=on,x-vga=on: vfio_dma_map(0x7f256&#160; &#160; &#160;220c0c0, 0x0, 0x8be00000, 0x7f24b4200000) = -12 (Cannot allocate memory)<br />2014-09-03T13:07:19.859970Z qemu-system-x86_64: -device vfio-pci,host=01:00.0,bus=root.1,addr=00.0,multifunction=on,x-vga=on: vfio: memory listene&#160; &#160; &#160;r initialization failed for container<br />2014-09-03T13:07:19.859982Z qemu-system-x86_64: -device vfio-pci,host=01:00.0,bus=root.1,addr=00.0,multifunction=on,x-vga=on: vfio: failed to setu&#160; &#160; &#160;p container for group 1<br />2014-09-03T13:07:19.860017Z qemu-system-x86_64: -device vfio-pci,host=01:00.0,bus=root.1,addr=00.0,multifunction=on,x-vga=on: vfio: failed to get&#160; &#160; &#160; group 1<br />2014-09-03T13:07:19.860031Z qemu-system-x86_64: -device vfio-pci,host=01:00.0,bus=root.1,addr=00.0,multifunction=on,x-vga=on: Device initializatio&#160; &#160; &#160;n failed.<br />2014-09-03T13:07:19.860045Z qemu-system-x86_64: -device vfio-pci,host=01:00.0,bus=root.1,</p></div></blockquote></div><p>I see some other posts on here about the same issue, but that seems to be when they wish to run start the guest as another user other than root. Regardless I have tried changing my ulimits but with no effect:</p><p>[root@i7-4770s ~]# ulimit -l<br />8650752</p><p>I have tried changing the RAM allocated to the Guest to 2GB from 6GB to see if there is any difference but no luck also.</p><p>Any suggestions please?</p><p>I&#039;m running Arch Linux with the Kernel from the OP (3.15.0-1-mainline)</p><p>Thanks</p><p>Graham</p></div></blockquote></div> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1453277">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1453368" class="blockpost roweven"> <h2><span><span class="conr">#2635</span> <a href="viewtopic.php?pid=1453368#p1453368">2014-09-03 17:39:33</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=82238">sinny</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2014-05-24</span></dd> <dd><span>Posts: 75</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=82238">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>sitonapanotis wrote:</cite><blockquote><div><div class="quotebox"><cite>aw wrote:</cite><blockquote><div><div class="quotebox"><cite>sitonapanotis wrote:</cite><blockquote><div><p>So Ive been experiencing video stuttering when testing games and tried disabling nested page tables to see if that helped, but my system has an intel processor so this didnt seem to do anything.</p><p>I found the option for the intel equivelant (extended page tables) which seems to be kvm-intel.ept=0<br />I and added that to my /etc/modprobe.d/intel-kvm.conf.<br />With extended page tables disabled my windows guest crashes during boot. <br />Is that not how I would do the equivalent of disabling nested page tables on an intel processor?</p><p>Has anyone done this with an intel processor in an atempt to decrease stutter?<br />Any ideas where to go from here?</p></div></blockquote></div><p>Nested paging typically provides a significant performance improvement, so I&#039;m not sure why you&#039;d want to disable it.&#160; Some people do claim that disabling nested guest support improves performance, but (a) I haven&#039;t seen substantiated evidence of that and (b) nested guests != nested paging.</p></div></blockquote></div><br /><p>Ah I was only trying it because OP suggested it, but what I have read about it does seem to make what you are saying make more sense.<br />Any other ideas for troubleshooting latency/stuttering issues?</p><p>edit: in windows LatencyMon is reporting some pretty high latency <a href="http://i.imgur.com/G299o61.jpg" rel="nofollow">http://i.imgur.com/G299o61.jpg</a></p></div></blockquote></div><p>main idea: explore and investigate yourself. the functionality in question is experimental after all. plus, it&#039;s the first time i hear about video stutter at all (maybe last few months i was not paying enough attention for all the reading i did, but still) so it may be not that common of a problem for you to wait for some outside help.</p><p>just try everything you can think of, including weird (==seemingly unrelated) stuff like playing around with audio settings (this, along with switch to hugetlbfs for memory, resolved my fps problems) or cpu isolation (run vm on cores NOT used by host at all)</p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1453368">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1453375" class="blockpost rowodd"> <h2><span><span class="conr">#2636</span> <a href="viewtopic.php?pid=1453375#p1453375">2014-09-03 17:54:26</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=81745">siddharta</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2014-05-03</span></dd> <dd><span>Posts: 30</span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>sitonapanotis wrote:</cite><blockquote><div><p>Any other ideas for troubleshooting latency/stuttering issues?</p><p>edit: in windows LatencyMon is reporting some pretty high latency <a href="http://i.imgur.com/G299o61.jpg" rel="nofollow">http://i.imgur.com/G299o61.jpg</a></p></div></blockquote></div><p>Have a look at this post <a href="https://bbs.archlinux.org/viewtopic.php?pid=1285910#p1285910" rel="nofollow">https://bbs.archlinux.org/viewtopic.php … 0#p1285910</a>. If using Windows 8.x turning off dynticks could help, also verify whether your host kernel is preemptible (should have CONFIG_PREEMPT set).</p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1453375">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1453385" class="blockpost roweven"> <h2><span><span class="conr">#2637</span> <a href="viewtopic.php?pid=1453385#p1453385">2014-09-03 18:23:12</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=81745">siddharta</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2014-05-03</span></dd> <dd><span>Posts: 30</span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <p>I&#039;m using this for two guests and one guest (Linux guest with nVidia card) brings down the host on guest reboot. </p><p>Asrock Z97 Extreme6 mainboard<br />i4790K<br />i915 for host<br />AMD HD7950 for Win8.1 guest<br />nVidia GT 630 for Linux guest<br />on kernel 3.16 and qemu 2.1.0 with i915 and ACS override patches applied.</p><p>Boot parameters are </p><div class="codebox"><pre><code>BOOT_IMAGE=/vmlinuz-3.16.1-vfio-i915-acs-vol-7.g90bc0f1-desktop root=/dev/mapper/vg1-root resume=/dev/vg1/swap splash=silent quiet showopts intel_iommu=on i915.enable_hd_vgaarb=1 pcie_acs_override=downstream pci-stub.ids=1002:679a,1002:aaa0,10de:0f00,10de:0bea,8086:8ca0 modeset.nouveau=0 modeset.radeon=0</code></pre></div><p>The devices I&#039;m passing through are </p><div class="codebox"><pre><code>00:1b.0 Audio device [0403]: Intel Corporation Device [8086:8ca0] Subsystem: ASRock Incorporation Device [1849:1151] Kernel driver in use: vfio-pci Kernel modules: snd_hda_intel 01:00.0 VGA compatible controller [0300]: Advanced Micro Devices, Inc. [AMD/ATI] Tahiti PRO [Radeon HD 7950] [1002:679a] Subsystem: Gigabyte Technology Co., Ltd Device [1458:254c] Kernel driver in use: vfio-pci Kernel modules: radeon 01:00.1 Audio device [0403]: Advanced Micro Devices, Inc. [AMD/ATI] Tahiti XT HDMI Audio [Radeon HD 7970 Series] [1002:aaa0] Subsystem: Gigabyte Technology Co., Ltd Device [1458:aaa0] Kernel driver in use: vfio-pci Kernel modules: snd_hda_intel 02:00.0 VGA compatible controller [0300]: NVIDIA Corporation GF108 [GeForce GT 630] [10de:0f00] (rev a1) Subsystem: ASUSTeK Computer Inc. Device [1043:8498] Kernel driver in use: vfio-pci Kernel modules: nouveau 02:00.1 Audio device [0403]: NVIDIA Corporation GF108 High Definition Audio Controller [10de:0bea] (rev a1) Subsystem: ASUSTeK Computer Inc. Device [1043:8498] Kernel driver in use: vfio-pci Kernel modules: snd_hda_intel</code></pre></div><p>or the two graphics cards and the on-board sound (for the Win8.1 guest).</p><p>The Win8.1 guest with the AMD 7950 works perfectly. I was using an AMD 5450 for the second guest running Linux as well but was having the host crash on reboot with the radeon open source drivers, as well as low, stuttering desktop performance when using Cinnamon as DE (no issues with XFCE or LXDE), both with open radeon and fglrx drivers. </p><p>The AMD 5450 was swapped out for a nVidia 630 and this resolved the Cinnamon desktop performance issue, however when rebooting the guest this will again lock up the host (hard reset needed). </p><p>QEMU is invoked as </p><div class="codebox"><pre><code>/usr/bin/qemu-system-x86_64 -name vm-linux -enable-kvm -rtc base=utc \ -M q35 -m 4096 -mem-path /dev/hugepages \ -smp sockets=1,cores=4 -cpu host \ -vga none -nographic -monitor stdio -serial none -parallel none -nodefconfig -boot menu=off \ -device ioh3420,bus=pcie.0,addr=1c.0,multifunction=on,port=1,chassis=1,id=root.1 \ -device vfio-pci,host=0000:02:00.0,bus=root.1,addr=00.0,multifunction=on,x-vga=on \ -device vfio-pci,host=0000:02:00.1,bus=root.1,addr=00.1 -device virtio-scsi-pci,id=scsi \ -device ahci,bus=pcie.0,id=ahci -drive file=/dev/vg2/linux,id=disk,format=raw,cache=none,aio=threads,discard=unmap \ -device scsi-hd,drive=disk -drive file=/home/maarten/Downloads/openSUSE-13.1-DVD-x86_64.iso,id=isocd -device ide-cd,bus=ahci.1,drive=isocd -net nic,model=virtio,macaddr=52:54:00:6b:04:1d -net bridge,br=br0</code></pre></div><p>I don&#039;t have this issue with the Windows guest at any point. I don&#039;t know if this is an issue resolved with the &quot;other&quot; VGA arbiter patch on <a href="https://lkml.org/lkml/2014/5/25/94" rel="nofollow">https://lkml.org/lkml/2014/5/25/94</a>, I do have the gfx card output on screen but I don&#039;t have complete understanding of what&#039;s going on here so I&#039;m not certain. Thanks.</p><p>edit: I can shutdown the Linux guest without having the host hang but the guest cannot be started again: </p><div class="codebox"><pre><code>(qemu) qemu-system-x86_64: vfio-pci: Cannot read device rom at 0000:02:00.0 Device option ROM contents are probably invalid (check dmesg). Skip option ROM probe with rombar=0, or load from file with romfile=</code></pre></div> <p class="postedit"><em>Last edited by siddharta (2014-09-03 18:52:42)</em></p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1453385">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1453417" class="blockpost rowodd"> <h2><span><span class="conr">#2638</span> <a href="viewtopic.php?pid=1453417#p1453417">2014-09-03 20:13:18</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=84881">friedcpu</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2014-09-03</span></dd> <dd><span>Posts: 3</span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <p>Hi,<br />I&#039;ve been following this thread for a while now, and a few months ago tried to passthrough my 2 NVIDIA Graphics cards, with the same results I am getting now, but this time I am determined to get it to work.</p><p>My specs are.<br />Asus X79-Deluxe<br />Intel 4930k<br />64 GB Ram<br />2GB NVIDIA GeForce GTX 770 (10de:1184) (Primary 16x Slot)<br />1GB NVIDIA GeForce GTX550Ti (10de:1244) (Secondary 16x Slot)</p><p>I am running the latest linux-mainline kernel from the #1 post with all patches, along with qemu-git, as of about 3hours ago. As I have no built in GPU with the processor, I am finding it very hard to release the primary GPU after booting. Here is my info and then I will get to what it is and isn&#039;t doing.</p><div class="codebox"><pre><code>lspci 01:00.0 VGA compatible controller: NVIDIA Corporation GK104 [GeForce GTX 770] (rev a1) 01:00.1 Audio device: NVIDIA Corporation GK104 HDMI Audio Controller (rev a1) 02:00.0 VGA compatible controller: NVIDIA Corporation GF116 [GeForce GTX 550 Ti] (rev a1) 02:00.1 Audio device: NVIDIA Corporation GF116 High Definition Audio Controller (rev a1) lspci -n 01:00.0 0300: 10de:1184 (rev a1) 01:00.1 0403: 10de:0e0a (rev a1) 02:00.0 0300: 10de:1244 (rev a1) 02:00.1 0403: 10de:0bee (rev a1)</code></pre></div><div class="codebox"><pre><code> Kernel command line: initrd=\initramfs-linux-mainline.img root=/dev/sda2 rw video=efifb:off intel_iommu=on pci-stub.ids=10de:1184,10de:0e0a,10de:1244,10de:0bee [ 0.950144] pci-stub: add 10DE:1184 sub=FFFFFFFF:FFFFFFFF cls=00000000/00000000 [ 0.950164] pci-stub 0000:01:00.0: claimed by stub [ 0.950182] pci-stub: add 10DE:0E0A sub=FFFFFFFF:FFFFFFFF cls=00000000/00000000 [ 0.950194] pci-stub 0000:01:00.1: claimed by stub [ 0.950203] pci-stub: add 10DE:1244 sub=FFFFFFFF:FFFFFFFF cls=00000000/00000000 [ 0.950214] pci-stub 0000:02:00.0: claimed by stub [ 0.950226] pci-stub: add 10DE:0BEE sub=FFFFFFFF:FFFFFFFF cls=00000000/00000000 [ 0.950237] pci-stub 0000:02:00.1: claimed by stub</code></pre></div><div class="codebox"><pre><code>Kernel Arguments (efifb:off to turn framebuffer off) root=/dev/sda2 rw video=efifb:off intel_iommu=on pci-stub.ids=10de:1184,10de:0e0a,10de:1244,10de:0bee vfio-bind 0000:01:00.0 0000:01:00.1 0000:02:00.0 0000:02.1 qemu (executed over ssh) qemu-system-x86_64 -enable-kvm -M q35 -m 1024 -cpu host \ -smp 6,sockets=1,cores=6,threads=1 -bios /usr/share/qemu/bios.bin -vga none \ -device ioh3420,bus=pcie.0,addr=1c.0,multifunction=on,port=1,chassis=1,id=root.1 \ -device vfio-pci,host=01:00.0,bus=root.1,addr=00.0,multifunction=on,x-vga=on,romfile=/root/GK104.rom \ -device vfio-pci,host=01:00.1,bus=root.1,addr=00.1 -nographic qemu-system-x86_64 -enable-kvm -M q35 -m 1024 -cpu host \ -smp 6,sockets=1,cores=6,threads=1 -bios /usr/share/qemu/bios.bin -vga none \ -device ioh3420,bus=pcie.0,addr=1c.0,multifunction=on,port=1,chassis=1,id=root.1 \ -device vfio-pci,host=02:00.0,bus=root.1,addr=00.0,multifunction=on,x-vga=on \ -device vfio-pci,host=02:00.1,bus=root.1,addr=00.1 -nographic blacklist nouveau</code></pre></div><p>Currently I can use device 02:00.0 absolutely fine, but if I try and use 01:00.0, I don&#039;t get any errors, just the monitor goes to sleep and this is in dmesg</p><div class="codebox"><pre><code> vfio_ecap_init: 0000:01:00.0 hiding ecap 0x19@0x900</code></pre></div><p>I can still exit qemu fine, no lockups etc... </p><p>I have tried changing the cards around, and moving them to slower PCI slots, the GPU started by POST is the one that refuses to pass through. Both cards will pass through individually, providing they are not the first card. and I only get an Invalid ROM message when the GTX770 is in Slot 1, not in any other slot, I have verified my BIOS Dump with rom-parser, everything checks out. </p><p>When passing through the second card (in any PCI Slot, Either of the cards) I get the following in DMESG</p><div class="codebox"><pre><code>vfio-pci 0000:02:00.0: enabling device (0000 -&gt; 0003) vfio-pci 0000:02:00.1: enabling device (0000 -&gt; 0002)</code></pre></div><p>But whenever I try and passthrough the first card, I get this</p><div class="codebox"><pre><code>vfio_ecap_init: 0000:01:00.0 hiding ecap 0x19@0x900 vfio-pci 0000:01:00.1: enabling device (0000 -&gt; 0002)</code></pre></div><p>The VGA part of the first card never gets enabled.</p><p>All todays testing was done on a fresh install with only the minimum for this installed, no xorg or any sort of graphics drivers.<br />I believe something is grabbing the primary card, but I have exhausted most of the search results related to passing through your only graphics cards without leaving one for the host.</p> <p class="postedit"><em>Last edited by friedcpu (2014-09-04 08:10:42)</em></p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1453417">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1453453" class="blockpost roweven"> <h2><span><span class="conr">#2639</span> <a href="viewtopic.php?pid=1453453#p1453453">2014-09-03 23:58:16</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=75590">aw</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2013-10-04</span></dd> <dd><span>Posts: 921</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=75590">Email</a></span> <span class="website"><a href="http://vfio.blogspot.com/" rel="nofollow">Website</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>sitonapanotis wrote:</cite><blockquote><div><div class="quotebox"><cite>aw wrote:</cite><blockquote><div><div class="quotebox"><cite>sitonapanotis wrote:</cite><blockquote><div><p>So Ive been experiencing video stuttering when testing games and tried disabling nested page tables to see if that helped, but my system has an intel processor so this didnt seem to do anything.</p><p>I found the option for the intel equivelant (extended page tables) which seems to be kvm-intel.ept=0<br />I and added that to my /etc/modprobe.d/intel-kvm.conf.<br />With extended page tables disabled my windows guest crashes during boot. <br />Is that not how I would do the equivalent of disabling nested page tables on an intel processor?</p><p>Has anyone done this with an intel processor in an atempt to decrease stutter?<br />Any ideas where to go from here?</p></div></blockquote></div><p>Nested paging typically provides a significant performance improvement, so I&#039;m not sure why you&#039;d want to disable it.&#160; Some people do claim that disabling nested guest support improves performance, but (a) I haven&#039;t seen substantiated evidence of that and (b) nested guests != nested paging.</p></div></blockquote></div><br /><p>Ah I was only trying it because OP suggested it, but what I have read about it does seem to make what you are saying make more sense.<br />Any other ideas for troubleshooting latency/stuttering issues?</p><p>edit: in windows LatencyMon is reporting some pretty high latency <a href="http://i.imgur.com/G299o61.jpg" rel="nofollow">http://i.imgur.com/G299o61.jpg</a></p></div></blockquote></div><p>- huge pages<br />- vCPU pinning<br />- don&#039;t over commit CPUs<br />- try to get your assigned devices using MSI<br />- ???</p><p>Please share your findings.</p> </div> <div class="postsignature postmsg"><hr /><p><a href="http://vfio.blogspot.com" rel="nofollow">http://vfio.blogspot.com</a><br />Looking for a more open forum to discuss vfio related uses?&#160; Try <a href="https://www.redhat.com/mailman/listinfo/vfio-users" rel="nofollow">https://www.redhat.com/mailman/listinfo/vfio-users</a></p></div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1453453">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1453456" class="blockpost rowodd"> <h2><span><span class="conr">#2640</span> <a href="viewtopic.php?pid=1453456#p1453456">2014-09-04 00:01:36</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=75590">aw</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2013-10-04</span></dd> <dd><span>Posts: 921</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=75590">Email</a></span> <span class="website"><a href="http://vfio.blogspot.com/" rel="nofollow">Website</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>gneville wrote:</cite><blockquote><div><p>Just spotted the following in dmseg, need to investigate further:</p><div class="quotebox"><blockquote><div><p>[&#160; &#160;49.781160] qemu-system-x86: sending ioctl 5326 to a partition!<br />[&#160; &#160;49.781168] qemu-system-x86: sending ioctl 80200204 to a partition!<br />[&#160; &#160;49.781572] qemu-system-x86: sending ioctl 5326 to a partition!<br />[&#160; &#160;49.781577] qemu-system-x86: sending ioctl 80200204 to a partition!<br />[&#160; &#160;49.940979] vfio_pin_pages: RLIMIT_MEMLOCK (65536) exceeded<br />[&#160; &#160;49.940993] vfio_pin_pages: RLIMIT_MEMLOCK (65536) exceeded</p></div></blockquote></div></div></blockquote></div><p>What version of libvirt are you using?&#160; Seems like it doesn&#039;t fully support vfio--based device assignment.&#160; libvirt should be setting the locked memory limit for the vm process to a sufficient value to pin all of guest memory.</p> </div> <div class="postsignature postmsg"><hr /><p><a href="http://vfio.blogspot.com" rel="nofollow">http://vfio.blogspot.com</a><br />Looking for a more open forum to discuss vfio related uses?&#160; Try <a href="https://www.redhat.com/mailman/listinfo/vfio-users" rel="nofollow">https://www.redhat.com/mailman/listinfo/vfio-users</a></p></div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1453456">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1453600" class="blockpost roweven"> <h2><span><span class="conr">#2641</span> <a href="viewtopic.php?pid=1453600#p1453600">2014-09-04 14:50:59</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=80830">gneville</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2014-04-02</span></dd> <dd><span>Posts: 27</span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <p>Thanks for the reply aw, this was totally my fault! I didn&#039;t add &quot;clear_emulator_capabilities = 0&quot; to /etc/libvirt/qemu.conf.</p><p>I am running libvirt 1.2.9.</p><p>I have successfully booted my Windows8 guest with the Radeon R9 290 passed through using libvirt now using a Q35 machine.</p><p>However when I try to define the OVMF Guest I get the following message:</p><div class="quotebox"><blockquote><div><p>error: Failed to define domain from /root/windows-ovmf-virsh-xml.xml<br />error: internal error: PCI bus is not compatible with the device at 0000:00:01.0. Device requires a standard PCI slot, which is not provided by bus 0000:00</p></div></blockquote></div><p>My XML contains:</p><div class="quotebox"><blockquote><div><p>&lt;type arch=&#039;i686&#039; machine=&#039;pc&#039;&gt;hvm&lt;/type&gt;<br />&#160; &#160; &lt;controller type=&#039;pci&#039; index=&#039;0&#039; model=&#039;pcie-root&#039;&gt;<br />&#160; &#160; &#160; &lt;alias name=&#039;pcie.0&#039;/&gt;<br />&#160; &#160; &lt;/controller&gt;<br />&#160; &#160; &lt;controller type=&#039;pci&#039; index=&#039;1&#039; model=&#039;dmi-to-pci-bridge&#039;&gt;<br />&#160; &#160; &#160; &lt;alias name=&#039;pci.1&#039;/&gt;<br />&#160; &#160; &#160; &lt;address type=&#039;pci&#039; domain=&#039;0x0000&#039; bus=&#039;0x00&#039; slot=&#039;0x02&#039; function=&#039;0x0&#039;/&gt;<br />&#160; &#160; &lt;/controller&gt;<br />&#160; &#160; &lt;controller type=&#039;pci&#039; index=&#039;2&#039; model=&#039;pci-bridge&#039;&gt;<br />&#160; &#160; &#160; &lt;alias name=&#039;pci.2&#039;/&gt;<br />&#160; &#160; &#160; &lt;address type=&#039;pci&#039; domain=&#039;0x0000&#039; bus=&#039;0x01&#039; slot=&#039;0x01&#039; function=&#039;0x0&#039;/&gt;<br />&#160; &#160; &lt;/controller&gt;</p><p>&#160; &lt;qemu:commandline&gt;<br />&#160; &#160; &lt;qemu:arg value=&#039;-no-hpet&#039;/&gt;<br />&#160; &#160; &lt;qemu:arg value=&#039;-drive&#039;/&gt;<br />&#160; &#160; &lt;qemu:arg value=&#039;if=pflash,format=raw,readonly,file=/home/xen/vfio/OVMF.fd&#039;/&gt;<br />&#160; &#160; &lt;qemu:arg value=&#039;ioh3420,bus=pcie.0,addr=1c.0,multifunction=on,port=1,chassis=1,id=root.1&#039;/&gt;<br />&#160; &#160; &lt;qemu:arg value=&#039;-device&#039;/&gt;<br />&#160; &#160; &lt;qemu:arg value=&#039;vfio-pci,host=01:00.0,bus=root.1,addr=00.0,multifunction=on,x-vga=on&#039;/&gt;<br />&#160; &#160; &lt;qemu:arg value=&#039;-device&#039;/&gt;<br />&#160; &#160; &lt;qemu:arg value=&#039;vfio-pci,host=01:00.1,bus=pcie.0&#039;/&gt;<br />&#160; &#160; &lt;qemu:arg value=&#039;-device&#039;/&gt;<br />&#160; &#160; &lt;qemu:arg value=&#039;ahci,bus=pcie.0,id=ahci&#039;/&gt;<br /> &lt;/qemu:commandline&gt;</p></div></blockquote></div><p>I&#039;ve tried different varients of configuration but not having much luck, how does your xml look?</p><br /><div class="quotebox"><cite>aw wrote:</cite><blockquote><div><div class="quotebox"><cite>gneville wrote:</cite><blockquote><div><p>Just spotted the following in dmseg, need to investigate further:</p><div class="quotebox"><blockquote><div><p>[&#160; &#160;49.781160] qemu-system-x86: sending ioctl 5326 to a partition!<br />[&#160; &#160;49.781168] qemu-system-x86: sending ioctl 80200204 to a partition!<br />[&#160; &#160;49.781572] qemu-system-x86: sending ioctl 5326 to a partition!<br />[&#160; &#160;49.781577] qemu-system-x86: sending ioctl 80200204 to a partition!<br />[&#160; &#160;49.940979] vfio_pin_pages: RLIMIT_MEMLOCK (65536) exceeded<br />[&#160; &#160;49.940993] vfio_pin_pages: RLIMIT_MEMLOCK (65536) exceeded</p></div></blockquote></div></div></blockquote></div><p>What version of libvirt are you using?&#160; Seems like it doesn&#039;t fully support vfio--based device assignment.&#160; libvirt should be setting the locked memory limit for the vm process to a sufficient value to pin all of guest memory.</p></div></blockquote></div><p>Thanks</p><p>Graham</p> <p class="postedit"><em>Last edited by gneville (2014-09-04 15:13:46)</em></p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1453600">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1453605" class="blockpost rowodd"> <h2><span><span class="conr">#2642</span> <a href="viewtopic.php?pid=1453605#p1453605">2014-09-04 15:22:59</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=75590">aw</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2013-10-04</span></dd> <dd><span>Posts: 921</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=75590">Email</a></span> <span class="website"><a href="http://vfio.blogspot.com/" rel="nofollow">Website</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>gneville wrote:</cite><blockquote><div><p>Thanks for the reply aw, this was totally my fault! I didn&#039;t add &quot;clear_emulator_capabilities = 0&quot; to /etc/libvirt/qemu.conf.</p><p>I am running libvirt 1.2.9.</p><p>I have successfully booted my Windows8 guest with the Radeon R9 290 passed through using libvirt now using a Q35 machine.</p><p>However when I try to define the OVMF Guest I get the following message:</p><div class="quotebox"><blockquote><div><p>error: Failed to define domain from /root/windows-ovmf-virsh-xml.xml<br />error: internal error: PCI bus is not compatible with the device at 0000:00:01.0. Device requires a standard PCI slot, which is not provided by bus 0000:00</p></div></blockquote></div><p>My XML contains:</p><div class="quotebox"><blockquote><div><p>&lt;type arch=&#039;i686&#039; machine=&#039;pc&#039;&gt;hvm&lt;/type&gt;<br />&#160; &#160; &lt;controller type=&#039;pci&#039; index=&#039;0&#039; model=&#039;pcie-root&#039;&gt;<br />&#160; &#160; &#160; &lt;alias name=&#039;pcie.0&#039;/&gt;<br />&#160; &#160; &lt;/controller&gt;<br />&#160; &#160; &lt;controller type=&#039;pci&#039; index=&#039;1&#039; model=&#039;dmi-to-pci-bridge&#039;&gt;<br />&#160; &#160; &#160; &lt;alias name=&#039;pci.1&#039;/&gt;<br />&#160; &#160; &#160; &lt;address type=&#039;pci&#039; domain=&#039;0x0000&#039; bus=&#039;0x00&#039; slot=&#039;0x02&#039; function=&#039;0x0&#039;/&gt;<br />&#160; &#160; &lt;/controller&gt;<br />&#160; &#160; &lt;controller type=&#039;pci&#039; index=&#039;2&#039; model=&#039;pci-bridge&#039;&gt;<br />&#160; &#160; &#160; &lt;alias name=&#039;pci.2&#039;/&gt;<br />&#160; &#160; &#160; &lt;address type=&#039;pci&#039; domain=&#039;0x0000&#039; bus=&#039;0x01&#039; slot=&#039;0x01&#039; function=&#039;0x0&#039;/&gt;<br />&#160; &#160; &lt;/controller&gt;</p><p>&#160; &lt;qemu:commandline&gt;<br />&#160; &#160; &lt;qemu:arg value=&#039;-no-hpet&#039;/&gt;<br />&#160; &#160; &lt;qemu:arg value=&#039;-drive&#039;/&gt;<br />&#160; &#160; &lt;qemu:arg value=&#039;if=pflash,format=raw,readonly,file=/home/xen/vfio/OVMF.fd&#039;/&gt;<br />&#160; &#160; &lt;qemu:arg value=&#039;ioh3420,bus=pcie.0,addr=1c.0,multifunction=on,port=1,chassis=1,id=root.1&#039;/&gt;<br />&#160; &#160; &lt;qemu:arg value=&#039;-device&#039;/&gt;<br />&#160; &#160; &lt;qemu:arg value=&#039;vfio-pci,host=01:00.0,bus=root.1,addr=00.0,multifunction=on,x-vga=on&#039;/&gt;<br />&#160; &#160; &lt;qemu:arg value=&#039;-device&#039;/&gt;<br />&#160; &#160; &lt;qemu:arg value=&#039;vfio-pci,host=01:00.1,bus=pcie.0&#039;/&gt;<br />&#160; &#160; &lt;qemu:arg value=&#039;-device&#039;/&gt;<br />&#160; &#160; &lt;qemu:arg value=&#039;ahci,bus=pcie.0,id=ahci&#039;/&gt;<br /> &lt;/qemu:commandline&gt;</p></div></blockquote></div><p>I&#039;ve tried different varients of configuration but not having much luck, how does your xml look?</p></div></blockquote></div><p>Please re-read the blog post, especially the bit about OVMF not supporting Q35.&#160; If you assign the GPU with a hostdev definition (which you can do when you don&#039;t need the x-vga=on option, which you don&#039;t need when using OVMF), then you don&#039;t need any special libvirt configurations (like retaining capabilities, running as root, or defining ACLs for /dev/vfio/foo).</p> </div> <div class="postsignature postmsg"><hr /><p><a href="http://vfio.blogspot.com" rel="nofollow">http://vfio.blogspot.com</a><br />Looking for a more open forum to discuss vfio related uses?&#160; Try <a href="https://www.redhat.com/mailman/listinfo/vfio-users" rel="nofollow">https://www.redhat.com/mailman/listinfo/vfio-users</a></p></div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1453605">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1453607" class="blockpost roweven"> <h2><span><span class="conr">#2643</span> <a href="viewtopic.php?pid=1453607#p1453607">2014-09-04 15:34:06</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=80830">gneville</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2014-04-02</span></dd> <dd><span>Posts: 27</span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <p>Thanks again, aw. I&#039;ll re-read it.</p><p>I did change the PC to:</p><div class="quotebox"><blockquote><div><p>&lt;type arch=&#039;i686&#039; machine=&#039;pc&#039;&gt;hvm&lt;/type&gt;</p></div></blockquote></div><p>I&#039;m guessing the config will be something like this then, I&#039;ll give it a go when I get home:</p><div class="quotebox"><blockquote><div><p>&lt;hostdev mode=&#039;subsystem&#039; type=&#039;pci&#039; managed=&#039;yes&#039;&gt;<br />&#160; &#160; &#160; &lt;source&gt;<br />&#160; &#160; &#160; &#160; &lt;address domain=&#039;0x0000&#039; bus=&#039;0x01&#039; slot=&#039;0x00&#039; function=&#039;0x0&#039;/&gt;<br />&#160; &#160; &#160; &lt;/source&gt;<br />&#160; &#160; &#160; &lt;address type=&#039;pci&#039; domain=&#039;0x0000&#039; bus=&#039;0x00&#039; slot=&#039;0x01&#039; function=&#039;0x0&#039; multifunction=&#039;on&#039;/&gt;<br />&#160; &#160; &lt;/hostdev&gt;<br />&#160; &#160; &lt;hostdev mode=&#039;subsystem&#039; type=&#039;pci&#039; managed=&#039;yes&#039;&gt;<br />&#160; &#160; &#160; &lt;source&gt;<br />&#160; &#160; &#160; &#160; &lt;address domain=&#039;0x0000&#039; bus=&#039;0x01&#039; slot=&#039;0x00&#039; function=&#039;0x1&#039;/&gt;<br />&#160; &#160; &#160; &lt;/source&gt;<br />&#160; &#160; &#160; &lt;address type=&#039;pci&#039; domain=&#039;0x0000&#039; bus=&#039;0x00&#039; slot=&#039;0x01&#039; function=&#039;0x1&#039;/&gt;<br />&#160; &#160; &lt;/hostdev&gt;</p></div></blockquote></div><div class="quotebox"><cite>aw wrote:</cite><blockquote><div><p>Please re-read the blog post, especially the bit about OVMF not supporting Q35.&#160; If you assign the GPU with a hostdev definition (which you can do when you don&#039;t need the x-vga=on option, which you don&#039;t need when using OVMF), then you don&#039;t need any special libvirt configurations (like retaining capabilities, running as root, or defining ACLs for /dev/vfio/foo).</p></div></blockquote></div> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1453607">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1453609" class="blockpost rowodd"> <h2><span><span class="conr">#2644</span> <a href="viewtopic.php?pid=1453609#p1453609">2014-09-04 15:39:42</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=75590">aw</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2013-10-04</span></dd> <dd><span>Posts: 921</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=75590">Email</a></span> <span class="website"><a href="http://vfio.blogspot.com/" rel="nofollow">Website</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>gneville wrote:</cite><blockquote><div><p>Thanks again, aw. I&#039;ll re-read it.</p><p>I did change the PC to:</p><div class="quotebox"><blockquote><div><p>&lt;type arch=&#039;i686&#039; machine=&#039;pc&#039;&gt;hvm&lt;/type&gt;</p></div></blockquote></div><p>I&#039;m guessing the config will be something like this then, I&#039;ll give it a go when I get home:</p><div class="quotebox"><blockquote><div><p>&lt;hostdev mode=&#039;subsystem&#039; type=&#039;pci&#039; managed=&#039;yes&#039;&gt;<br />&#160; &#160; &#160; &lt;source&gt;<br />&#160; &#160; &#160; &#160; &lt;address domain=&#039;0x0000&#039; bus=&#039;0x01&#039; slot=&#039;0x00&#039; function=&#039;0x0&#039;/&gt;<br />&#160; &#160; &#160; &lt;/source&gt;<br />&#160; &#160; &#160; &lt;address type=&#039;pci&#039; domain=&#039;0x0000&#039; bus=&#039;0x00&#039; slot=&#039;0x01&#039; function=&#039;0x0&#039; multifunction=&#039;on&#039;/&gt;<br />&#160; &#160; &lt;/hostdev&gt;<br />&#160; &#160; &lt;hostdev mode=&#039;subsystem&#039; type=&#039;pci&#039; managed=&#039;yes&#039;&gt;<br />&#160; &#160; &#160; &lt;source&gt;<br />&#160; &#160; &#160; &#160; &lt;address domain=&#039;0x0000&#039; bus=&#039;0x01&#039; slot=&#039;0x00&#039; function=&#039;0x1&#039;/&gt;<br />&#160; &#160; &#160; &lt;/source&gt;<br />&#160; &#160; &#160; &lt;address type=&#039;pci&#039; domain=&#039;0x0000&#039; bus=&#039;0x00&#039; slot=&#039;0x01&#039; function=&#039;0x1&#039;/&gt;<br />&#160; &#160; &lt;/hostdev&gt;</p></div></blockquote></div></div></blockquote></div><p>Yes, exactly.&#160; My full xml looks like this:</p><div class="codebox"><pre class="vscroll"><code>&lt;domain type=&#039;kvm&#039; xmlns:qemu=&#039;http://libvirt.org/schemas/domain/qemu/1.0&#039;&gt; &lt;name&gt;Windows8-OVMF&lt;/name&gt; &lt;uuid&gt;98dd8584-aa6a-49c3-b19e-8cbb942d5261&lt;/uuid&gt; &lt;memory unit=&#039;KiB&#039;&gt;4194304&lt;/memory&gt; &lt;currentMemory unit=&#039;KiB&#039;&gt;4194304&lt;/currentMemory&gt; &lt;vcpu placement=&#039;static&#039;&gt;2&lt;/vcpu&gt; &lt;cputune&gt; &lt;vcpupin vcpu=&#039;0&#039; cpuset=&#039;2&#039;/&gt; &lt;vcpupin vcpu=&#039;1&#039; cpuset=&#039;3&#039;/&gt; &lt;/cputune&gt; &lt;os&gt; &lt;type arch=&#039;x86_64&#039; machine=&#039;pc-i440fx-2.1&#039;&gt;hvm&lt;/type&gt; &lt;boot dev=&#039;hd&#039;/&gt; &lt;/os&gt; &lt;features&gt; &lt;acpi/&gt; &lt;apic/&gt; &lt;pae/&gt; &lt;hyperv&gt; &lt;relaxed state=&#039;on&#039;/&gt; &lt;vapic state=&#039;on&#039;/&gt; &lt;spinlocks state=&#039;on&#039; retries=&#039;8191&#039;/&gt; &lt;/hyperv&gt; &lt;kvm&gt; &lt;hidden state=&#039;on&#039;/&gt; &lt;/kvm&gt; &lt;/features&gt; &lt;cpu mode=&#039;custom&#039; match=&#039;exact&#039;&gt; &lt;model fallback=&#039;allow&#039;&gt;SandyBridge&lt;/model&gt; &lt;topology sockets=&#039;1&#039; cores=&#039;2&#039; threads=&#039;1&#039;/&gt; &lt;/cpu&gt; &lt;clock offset=&#039;localtime&#039;&gt; &lt;timer name=&#039;rtc&#039; tickpolicy=&#039;catchup&#039;/&gt; &lt;timer name=&#039;pit&#039; tickpolicy=&#039;delay&#039;/&gt; &lt;timer name=&#039;hpet&#039; present=&#039;no&#039;/&gt; &lt;timer name=&#039;hypervclock&#039; present=&#039;yes&#039;/&gt; &lt;/clock&gt; &lt;on_poweroff&gt;destroy&lt;/on_poweroff&gt; &lt;on_reboot&gt;restart&lt;/on_reboot&gt; &lt;on_crash&gt;restart&lt;/on_crash&gt; &lt;pm&gt; &lt;suspend-to-mem enabled=&#039;no&#039;/&gt; &lt;suspend-to-disk enabled=&#039;no&#039;/&gt; &lt;/pm&gt; &lt;devices&gt; &lt;emulator&gt;/home/alwillia/local/bin/qemu-system-x86_64&lt;/emulator&gt; &lt;disk type=&#039;file&#039; device=&#039;disk&#039;&gt; &lt;driver name=&#039;qemu&#039; type=&#039;raw&#039;/&gt; &lt;source file=&#039;/mnt/store/vm/win8.ovmf&#039;/&gt; &lt;target dev=&#039;vda&#039; bus=&#039;virtio&#039;/&gt; &lt;address type=&#039;pci&#039; domain=&#039;0x0000&#039; bus=&#039;0x00&#039; slot=&#039;0x07&#039; function=&#039;0x0&#039;/&gt; &lt;/disk&gt; &lt;controller type=&#039;pci&#039; index=&#039;0&#039; model=&#039;pci-root&#039;/&gt; &lt;controller type=&#039;usb&#039; index=&#039;0&#039; model=&#039;ich9-ehci1&#039;&gt; &lt;address type=&#039;pci&#039; domain=&#039;0x0000&#039; bus=&#039;0x00&#039; slot=&#039;0x02&#039; function=&#039;0x7&#039;/&gt; &lt;/controller&gt; &lt;controller type=&#039;usb&#039; index=&#039;0&#039; model=&#039;ich9-uhci1&#039;&gt; &lt;master startport=&#039;0&#039;/&gt; &lt;address type=&#039;pci&#039; domain=&#039;0x0000&#039; bus=&#039;0x00&#039; slot=&#039;0x02&#039; function=&#039;0x0&#039; multifunction=&#039;on&#039;/&gt; &lt;/controller&gt; &lt;controller type=&#039;usb&#039; index=&#039;0&#039; model=&#039;ich9-uhci2&#039;&gt; &lt;master startport=&#039;2&#039;/&gt; &lt;address type=&#039;pci&#039; domain=&#039;0x0000&#039; bus=&#039;0x00&#039; slot=&#039;0x02&#039; function=&#039;0x1&#039;/&gt; &lt;/controller&gt; &lt;controller type=&#039;usb&#039; index=&#039;0&#039; model=&#039;ich9-uhci3&#039;&gt; &lt;master startport=&#039;4&#039;/&gt; &lt;address type=&#039;pci&#039; domain=&#039;0x0000&#039; bus=&#039;0x00&#039; slot=&#039;0x02&#039; function=&#039;0x2&#039;/&gt; &lt;/controller&gt; &lt;interface type=&#039;bridge&#039;&gt; &lt;mac address=&#039;02:12:34:56:78:92&#039;/&gt; &lt;source bridge=&#039;br0&#039;/&gt; &lt;model type=&#039;virtio&#039;/&gt; &lt;address type=&#039;pci&#039; domain=&#039;0x0000&#039; bus=&#039;0x00&#039; slot=&#039;0x03&#039; function=&#039;0x0&#039;/&gt; &lt;/interface&gt; &lt;input type=&#039;tablet&#039; bus=&#039;usb&#039;/&gt; &lt;sound model=&#039;ich6&#039;&gt; &lt;address type=&#039;pci&#039; domain=&#039;0x0000&#039; bus=&#039;0x00&#039; slot=&#039;0x04&#039; function=&#039;0x0&#039;/&gt; &lt;/sound&gt; &lt;hostdev mode=&#039;subsystem&#039; type=&#039;pci&#039; managed=&#039;yes&#039;&gt; &lt;source&gt; &lt;address domain=&#039;0x0000&#039; bus=&#039;0x02&#039; slot=&#039;0x00&#039; function=&#039;0x0&#039;/&gt; &lt;/source&gt; &lt;address type=&#039;pci&#039; domain=&#039;0x0000&#039; bus=&#039;0x00&#039; slot=&#039;0x08&#039; function=&#039;0x0&#039;/&gt; &lt;/hostdev&gt; &lt;hostdev mode=&#039;subsystem&#039; type=&#039;pci&#039; managed=&#039;yes&#039;&gt; &lt;source&gt; &lt;address domain=&#039;0x0000&#039; bus=&#039;0x02&#039; slot=&#039;0x00&#039; function=&#039;0x1&#039;/&gt; &lt;/source&gt; &lt;address type=&#039;pci&#039; domain=&#039;0x0000&#039; bus=&#039;0x00&#039; slot=&#039;0x09&#039; function=&#039;0x0&#039;/&gt; &lt;/hostdev&gt; &lt;memballoon model=&#039;virtio&#039;&gt; &lt;address type=&#039;pci&#039; domain=&#039;0x0000&#039; bus=&#039;0x00&#039; slot=&#039;0x0a&#039; function=&#039;0x0&#039;/&gt; &lt;/memballoon&gt; &lt;/devices&gt; &lt;qemu:commandline&gt; &lt;qemu:arg value=&#039;-drive&#039;/&gt; &lt;qemu:arg value=&#039;if=pflash,format=raw,readonly,file=/usr/share/edk2.git/ovmf-x64/OVMF-pure-efi.fd&#039;/&gt; &lt;/qemu:commandline&gt; &lt;/domain&gt;</code></pre></div> </div> <div class="postsignature postmsg"><hr /><p><a href="http://vfio.blogspot.com" rel="nofollow">http://vfio.blogspot.com</a><br />Looking for a more open forum to discuss vfio related uses?&#160; Try <a href="https://www.redhat.com/mailman/listinfo/vfio-users" rel="nofollow">https://www.redhat.com/mailman/listinfo/vfio-users</a></p></div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1453609">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1453633" class="blockpost roweven"> <h2><span><span class="conr">#2645</span> <a href="viewtopic.php?pid=1453633#p1453633">2014-09-04 17:07:47</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=81745">siddharta</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2014-05-03</span></dd> <dd><span>Posts: 30</span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>siddharta wrote:</cite><blockquote><div><p>edit: Rebooting the Linux guest will lock up the host. I can shutdown the Linux guest without having the host hang but the guest cannot then be started again: </p><div class="codebox"><pre><code>(qemu) qemu-system-x86_64: vfio-pci: Cannot read device rom at 0000:02:00.0 Device option ROM contents are probably invalid (check dmesg). Skip option ROM probe with rombar=0, or load from file with romfile=</code></pre></div></div></blockquote></div><p>In trying to resolve this I&#039;ve been going through this thread again as I had diagnonally read most posts involving nVidia cards (didn&#039;t own one until now).&#160; I dumped the ROM of the GT 630 from within the guest with the nVidia gpu using </p><div class="codebox"><pre><code>echo 1 &gt; /sys/bus/pci/devices/0000:01:00.0/rom cat /sys/bus/pci/devices/0000:01:00.0/rom &gt; asus-gt630-dcsl-2gd3-v2-vbios.rom echo 0 &gt; /sys/bus/pci/devices/0000:01:00.0/rom</code></pre></div><p> and added this to the QEMU invocation as </p><div class="codebox"><pre><code>-device vfio-pci,host=$GPU,bus=root.1,addr=00.0,multifunction=on,x-vga=on,romfile=/home/user/asus-gt630-dcsl-2gd3-v2-vbios.rom</code></pre></div><p> but no success - host still hangs on guest reboot, same as without romfile specified. </p><p>The other suggestion in the error message, adding rombar=0, doesn&#039;t work either. - there is no display output when specifying this. I didn&#039;t try both together as a previous post indicated this doesn&#039;t make sense. I don&#039;t find another way forward in this thread unless I missed something. Any help would be very much appreciated, this is really bugging me.</p><p>A second issue I&#039;m seeing is when passing through a USB controller </p><div class="codebox"><pre><code>### Group 25 ### 0b:00.0 USB controller: ASMedia Technology Inc. Device 1142</code></pre></div><p> that is bound to pci-stub at boot </p><div class="codebox"><pre><code>0b:00.0 USB controller [0c03]: ASMedia Technology Inc. Device [1b21:1142] Subsystem: ASRock Incorporation Device [1849:1142] Kernel driver in use: pci-stub Kernel modules: xhci_hcd</code></pre></div><p>. Using </p><div class="codebox"><pre><code>-device vfio-pci,host=$USB,bus=pcie.0</code></pre></div><p> in the QEMU command results in dmesg </p><div class="codebox"><pre><code>[2014-09-04T17:45:38.943613+01:00 kvmhost-3 kernel: [ 1553.980492] dmar: DRHD: handling fault status reg 2 2014-09-04T17:45:38.943638+01:00 kvmhost-3 kernel: [ 1553.980504] dmar: DMAR:[DMA Read] Request device [0b:00.0] fault addr ee000 2014-09-04T17:45:38.943642+01:00 kvmhost-3 kernel: [ 1553.980504] DMAR:[fault reason 06] PTE Read access is not set</code></pre></div><p> and nothing beyond that. The guest doesn&#039;t see the USB controller. </p><p>I&#039;m attempting to passthrough the whole controller because passing a single usb device (regardless of the device type and port the device is attached to) gives a stream of errors as </p><div class="codebox"><pre><code>2014-09-04T10:09:31.794293+01:00 kvmhost-3 kernel: [ 153.883612] xhci_hcd 0000:00:14.0: Command completion event does not match command 2014-09-04T10:09:31.794311+01:00 kvmhost-3 kernel: [ 153.883633] xhci_hcd 0000:00:14.0: Timeout while waiting for setup device command 2014-09-04T10:09:37.010279+01:00 kvmhost-3 kernel: [ 159.099819] xhci_hcd 0000:00:14.0: Timeout while waiting for setup device command 2014-09-04T10:09:37.211259+01:00 kvmhost-3 kernel: [ 159.300820] usb 3-9.1: device not accepting address 4, error -62 2014-09-04T10:09:37.291256+01:00 kvmhost-3 kernel: [ 159.380909] usb 3-9.1: reset full-speed USB device number 4 using xhci_hcd 2014-09-04T10:09:37.291260+01:00 kvmhost-3 kernel: [ 159.381010] usb 3-9.1: Device not responding to setup address. 2014-09-04T10:09:37.492268+01:00 kvmhost-3 kernel: [ 159.581889] usb 3-9.1: Device not responding to setup address. 2014-09-04T10:09:37.693274+01:00 kvmhost-3 kernel: [ 159.782852] usb 3-9.1: device not accepting address 4, error -71 2014-09-04T10:09:37.693287+01:00 kvmhost-3 kernel: [ 159.783255] usb 3-9.1: USB disconnect, device number 4 2014-09-04T10:09:37.693288+01:00 kvmhost-3 kernel: [ 159.783347] xhci_hcd 0000:00:14.0: xHCI xhci_drop_endpoint called with disabled ep ffff880444cff940 2014-09-04T10:09:37.774261+01:00 kvmhost-3 kernel: [ 159.863962] usb 3-9.1: new full-speed USB device number 6 using xhci_hcd 2014-09-04T10:09:37.855287+01:00 kvmhost-3 kernel: [ 159.944987] usb 3-9.1: device descriptor read/64, error -32 2014-09-04T10:09:37.956285+01:00 kvmhost-3 kernel: [ 160.045876] xhci_hcd 0000:00:14.0: Setup ERROR: setup context command for slot 6. 2014-09-04T10:09:37.956292+01:00 kvmhost-3 kernel: [ 160.045878] usb 3-9.1: hub failed to enable device, error -22 2014-09-04T10:09:38.037284+01:00 kvmhost-3 kernel: [ 160.126992] usb 3-9.1: new full-speed USB device number 7 using xhci_hcd 2014-09-04T10:09:38.118289+01:00 kvmhost-3 kernel: [ 160.208006] usb 3-9.1: device descriptor read/64, error -32 2014-09-04T10:09:38.219271+01:00 kvmhost-3 kernel: [ 160.308883] xhci_hcd 0000:00:14.0: Setup ERROR: setup context command for slot 7. 2014-09-04T10:09:38.219278+01:00 kvmhost-3 kernel: [ 160.308886] usb 3-9.1: hub failed to enable device, error -22 2014-09-04T10:09:38.299285+01:00 kvmhost-3 kernel: [ 160.389022] usb 3-9.1: new full-speed USB device number 8 using xhci_hcd 2014-09-04T10:09:38.299291+01:00 kvmhost-3 kernel: [ 160.389127] usb 3-9.1: Device not responding to setup address. 2014-09-04T10:09:38.500284+01:00 kvmhost-3 kernel: [ 160.589984] usb 3-9.1: Device not responding to setup address. 2014-09-04T10:09:38.701266+01:00 kvmhost-3 kernel: [ 160.790900] usb 3-9.1: device not accepting address 8, error -71 2014-09-04T10:09:38.781261+01:00 kvmhost-3 kernel: [ 160.870989] usb 3-9.1: new full-speed USB device number 9 using xhci_hcd 2014-09-04T10:09:38.781268+01:00 kvmhost-3 kernel: [ 160.871083] usb 3-9.1: Device not responding to setup address. 2014-09-04T10:09:38.982281+01:00 kvmhost-3 kernel: [ 161.071992] usb 3-9.1: Device not responding to setup address. 2014-09-04T10:09:39.183287+01:00 kvmhost-3 kernel: [ 161.272923] usb 3-9.1: device not accepting address 9, error -71 2014-09-04T10:09:39.183294+01:00 kvmhost-3 kernel: [ 161.273058] usb 3-9-port1: unable to enumerate USB device</code></pre></div><p> and brings down the host eventually. Any insight into this is also appreciated. I&#039;ve googled what I can and it may be a problem with libusb that I&#039;m seeing but I&#039;m not certain how to pinpoint the root cause definitely.</p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1453633">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1453650" class="blockpost rowodd"> <h2><span><span class="conr">#2646</span> <a href="viewtopic.php?pid=1453650#p1453650">2014-09-04 18:04:55</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=75590">aw</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2013-10-04</span></dd> <dd><span>Posts: 921</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=75590">Email</a></span> <span class="website"><a href="http://vfio.blogspot.com/" rel="nofollow">Website</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>siddharta wrote:</cite><blockquote><div><div class="quotebox"><cite>siddharta wrote:</cite><blockquote><div><p>edit: Rebooting the Linux guest will lock up the host. I can shutdown the Linux guest without having the host hang but the guest cannot then be started again: </p><div class="codebox"><pre><code>(qemu) qemu-system-x86_64: vfio-pci: Cannot read device rom at 0000:02:00.0 Device option ROM contents are probably invalid (check dmesg). Skip option ROM probe with rombar=0, or load from file with romfile=</code></pre></div></div></blockquote></div><p>In trying to resolve this I&#039;ve been going through this thread again as I had diagnonally read most posts involving nVidia cards (didn&#039;t own one until now).&#160; I dumped the ROM of the GT 630 from within the guest with the nVidia gpu using </p><div class="codebox"><pre><code>echo 1 &gt; /sys/bus/pci/devices/0000:01:00.0/rom cat /sys/bus/pci/devices/0000:01:00.0/rom &gt; asus-gt630-dcsl-2gd3-v2-vbios.rom echo 0 &gt; /sys/bus/pci/devices/0000:01:00.0/rom</code></pre></div><p> and added this to the QEMU invocation as </p><div class="codebox"><pre><code>-device vfio-pci,host=$GPU,bus=root.1,addr=00.0,multifunction=on,x-vga=on,romfile=/home/user/asus-gt630-dcsl-2gd3-v2-vbios.rom</code></pre></div><p> but no success - host still hangs on guest reboot, same as without romfile specified. </p><p>The other suggestion in the error message, adding rombar=0, doesn&#039;t work either. - there is no display output when specifying this. I didn&#039;t try both together as a previous post indicated this doesn&#039;t make sense. I don&#039;t find another way forward in this thread unless I missed something. Any help would be very much appreciated, this is really bugging me.</p></div></blockquote></div><p>Host hangs can be pretty challenging to debug, especially without at least a serial console.&#160; I&#039;d probably start with the shutdown case you list and compare lspci -vvv in the host before and after a guest boot + shutdown.&#160; Also, don&#039;t forget that you&#039;re applying and enabling ACS override in your kernel, which assumes isolation where it may not exist.&#160; I&#039;m not sure if that&#039;s contributing or not, but you may want to try the card in another slot rather than ignoring the advertised isolation of devices.&#160; Things like ASPM and AER may play a role.&#160; You can find options to change or disable these in kernel-parameters.txt (<a href="https://git.kernel.org/cgit/linux/kernel/git/torvalds/linux.git/tree/Documentation/kernel-parameters.txt" rel="nofollow">https://git.kernel.org/cgit/linux/kerne … meters.txt</a>).</p><div class="quotebox"><blockquote><div><p>A second issue I&#039;m seeing is when passing through a USB controller </p><div class="codebox"><pre><code>### Group 25 ### 0b:00.0 USB controller: ASMedia Technology Inc. Device 1142</code></pre></div><p> that is bound to pci-stub at boot </p><div class="codebox"><pre><code>0b:00.0 USB controller [0c03]: ASMedia Technology Inc. Device [1b21:1142] Subsystem: ASRock Incorporation Device [1849:1142] Kernel driver in use: pci-stub Kernel modules: xhci_hcd</code></pre></div><p>. Using </p><div class="codebox"><pre><code>-device vfio-pci,host=$USB,bus=pcie.0</code></pre></div><p> in the QEMU command results in dmesg </p><div class="codebox"><pre><code>[2014-09-04T17:45:38.943613+01:00 kvmhost-3 kernel: [ 1553.980492] dmar: DRHD: handling fault status reg 2 2014-09-04T17:45:38.943638+01:00 kvmhost-3 kernel: [ 1553.980504] dmar: DMAR:[DMA Read] Request device [0b:00.0] fault addr ee000 2014-09-04T17:45:38.943642+01:00 kvmhost-3 kernel: [ 1553.980504] DMAR:[fault reason 06] PTE Read access is not set</code></pre></div><p> and nothing beyond that. The guest doesn&#039;t see the USB controller.</p></div></blockquote></div><p>Another quality ASMedia product...</p> </div> <div class="postsignature postmsg"><hr /><p><a href="http://vfio.blogspot.com" rel="nofollow">http://vfio.blogspot.com</a><br />Looking for a more open forum to discuss vfio related uses?&#160; Try <a href="https://www.redhat.com/mailman/listinfo/vfio-users" rel="nofollow">https://www.redhat.com/mailman/listinfo/vfio-users</a></p></div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1453650">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1453673" class="blockpost roweven"> <h2><span><span class="conr">#2647</span> <a href="viewtopic.php?pid=1453673#p1453673">2014-09-04 18:56:22</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=81745">siddharta</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2014-05-03</span></dd> <dd><span>Posts: 30</span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>aw wrote:</cite><blockquote><div><p>Host hangs can be pretty challenging to debug, especially without at least a serial console.&#160; I&#039;d probably start with the shutdown case you list and compare lspci -vvv in the host before and after a guest boot + shutdown.&#160; Also, don&#039;t forget that you&#039;re applying and enabling ACS override in your kernel, which assumes isolation where it may not exist.&#160; I&#039;m not sure if that&#039;s contributing or not, but you may want to try the card in another slot rather than ignoring the advertised isolation of devices.&#160; Things like ASPM and AER may play a role.&#160; You can find options to change or disable these in kernel-parameters.txt (<a href="https://git.kernel.org/cgit/linux/kernel/git/torvalds/linux.git/tree/Documentation/kernel-parameters.txt" rel="nofollow">https://git.kernel.org/cgit/linux/kerne … meters.txt</a>).</p></div></blockquote></div><p>Thanks for your feedback. Interesting. </p><div class="codebox"><pre><code>lspci -vvv -s 02:00.</code></pre></div><p> gives </p><div class="codebox"><pre class="vscroll"><code>02:00.0 VGA compatible controller: NVIDIA Corporation GF108 [GeForce GT 630] (rev a1) (prog-if 00 [VGA controller]) Subsystem: ASUSTeK Computer Inc. Device 8498 Control: I/O- Mem- BusMaster- SpecCycle- MemWINV- VGASnoop- ParErr- Stepping- SERR- FastB2B- DisINTx- Status: Cap+ 66MHz- UDF- FastB2B- ParErr- DEVSEL=fast &gt;TAbort- &lt;TAbort- &lt;MAbort- &gt;SERR- &lt;PERR- INTx- Interrupt: pin A routed to IRQ 10 Region 0: Memory at ee000000 (32-bit, non-prefetchable) [disabled] [size=16M] Region 1: Memory at b0000000 (64-bit, prefetchable) [disabled] [size=256M] Region 3: Memory at c0000000 (64-bit, prefetchable) [disabled] [size=32M] Region 5: I/O ports at d000 [disabled] [size=128] Expansion ROM at ef000000 [disabled] [size=512K] Capabilities: [60] Power Management version 3 Flags: PMEClk- DSI- D1- D2- AuxCurrent=0mA PME(D0-,D1-,D2-,D3hot-,D3cold-) Status: D0 NoSoftRst+ PME-Enable- DSel=0 DScale=0 PME- Capabilities: [68] MSI: Enable- Count=1/1 Maskable- 64bit+ Address: 0000000000000000 Data: 0000 Capabilities: [78] Express (v1) Endpoint, MSI 00 DevCap: MaxPayload 128 bytes, PhantFunc 0, Latency L0s &lt;4us, L1 &lt;64us ExtTag+ AttnBtn- AttnInd- PwrInd- RBE+ FLReset- DevCtl: Report errors: Correctable- Non-Fatal- Fatal- Unsupported- RlxdOrd- ExtTag+ PhantFunc- AuxPwr- NoSnoop+ MaxPayload 128 bytes, MaxReadReq 512 bytes DevSta: CorrErr- UncorrErr- FatalErr- UnsuppReq- AuxPwr- TransPend- LnkCap: Port #1, Speed 2.5GT/s, Width x16, ASPM L0s L1, Latency L0 &lt;256ns, L1 &lt;4us ClockPM+ Surprise- LLActRep- BwNot- LnkCtl: ASPM Disabled; RCB 128 bytes Disabled- Retrain- CommClk+ ExtSynch- ClockPM- AutWidDis- BWInt- AutBWInt- LnkSta: Speed 2.5GT/s, Width x8, TrErr- Train- SlotClk+ DLActive- BWMgmt- ABWMgmt- Capabilities: [b4] Vendor Specific Information: Len=14 &lt;?&gt; Capabilities: [100 v1] Virtual Channel Caps: LPEVC=0 RefClk=100ns PATEntryBits=1 Arb: Fixed- WRR32- WRR64- WRR128- Ctrl: ArbSelect=Fixed Status: InProgress- VC0: Caps: PATOffset=00 MaxTimeSlots=1 RejSnoopTrans- Arb: Fixed- WRR32- WRR64- WRR128- TWRR128- WRR256- Ctrl: Enable+ ID=0 ArbSelect=Fixed TC/VC=01 Status: NegoPending- InProgress- Capabilities: [128 v1] Power Budgeting &lt;?&gt; Capabilities: [600 v1] Vendor Specific Information: ID=0001 Rev=1 Len=024 &lt;?&gt; Kernel driver in use: pci-stub Kernel modules: nouveau</code></pre></div><p> whereas after boot and shutdown of guest this becomes (with diff before after)</p><div class="codebox"><pre><code>3,9c3,9 &lt; Control: I/O- Mem- BusMaster- SpecCycle- MemWINV- VGASnoop- ParErr- Stepping- SERR- FastB2B- DisINTx- &lt; Status: Cap+ 66MHz- UDF- FastB2B- ParErr- DEVSEL=fast &gt;TAbort- &lt;TAbort- &lt;MAbort- &gt;SERR- &lt;PERR- INTx- &lt; Interrupt: pin A routed to IRQ 10 &lt; Region 0: Memory at ee000000 (32-bit, non-prefetchable) [disabled] [size=16M] &lt; Region 1: Memory at b0000000 (64-bit, prefetchable) [disabled] [size=256M] &lt; Region 3: Memory at c0000000 (64-bit, prefetchable) [disabled] [size=32M] &lt; Region 5: I/O ports at d000 [disabled] [size=128] --- &gt; Control: I/O+ Mem+ BusMaster- SpecCycle- MemWINV- VGASnoop- ParErr- Stepping- SERR- FastB2B- DisINTx- &gt; Status: Cap+ 66MHz- UDF- FastB2B- ParErr- DEVSEL=fast &gt;TAbort- &lt;TAbort- &lt;MAbort- &gt;SERR- &lt;PERR- INTx+ &gt; Interrupt: pin A routed to IRQ 17 &gt; Region 0: Memory at ee000000 (32-bit, non-prefetchable) [size=16M] &gt; Region 1: Memory at b0000000 (64-bit, prefetchable) [size=256M] &gt; Region 3: Memory at c0000000 (64-bit, prefetchable) [size=32M] &gt; Region 5: I/O ports at d000 [size=128] 15c15 &lt; Address: 0000000000000000 Data: 0000 --- &gt; Address: 00000000fee004b8 Data: 0000 17c17 &lt; DevCap: MaxPayload 128 bytes, PhantFunc 0, Latency L0s &lt;4us, L1 &lt;64us --- &gt; DevCap: MaxPayload 128 bytes, PhantFunc 0, Latency L0s unlimited, L1 &lt;64us</code></pre></div><p> but I&#039;m not certain how to relate this correctly and whether this would be related to the issues I&#039;m seeing (host hang on guest reboot and host crash + QEMU stating &quot;invalid ROM contents&quot; on guest shutdown+boot again). </p><div class="quotebox"><cite>aw wrote:</cite><blockquote><div><p>Another quality ASMedia product...</p></div></blockquote></div><p>I wouldn&#039;t touch it with a ten foot pole if I would have USB device passthrough working properly, which unfortunately is not the case. edit: interestingly enough I find the same USB passthrough errors in dmesg on an Asrock Z77 mainboard but these don&#039;t seem to bring down the host there. Thanks.</p> <p class="postedit"><em>Last edited by siddharta (2014-09-04 19:50:00)</em></p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1453673">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1453678" class="blockpost rowodd"> <h2><span><span class="conr">#2648</span> <a href="viewtopic.php?pid=1453678#p1453678">2014-09-04 19:16:53</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=80830">gneville</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2014-04-02</span></dd> <dd><span>Posts: 27</span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <p>Getting there slowly, but still having issues.</p><p>It looks like I&#039;ve managed to successfully pass through my Radeon R9 290, although I can only tell his if I enable cirrus graphics and VNC and when at the UEFI Shell performing &quot;pci&quot; to see the Vendor and Device IDs that match the same as when performing &quot;lsusb -n&quot;</p><p>However, I can&#039;t get any display to appear when starting the guest without cirrus and VNC and can&#039;t get it to boot in to Windows either.</p><p>My XML now looks like so</p><div class="codebox"><pre><code> &lt;hostdev mode=&#039;subsystem&#039; type=&#039;pci&#039; managed=&#039;yes&#039;&gt; &lt;source&gt; &lt;address domain=&#039;0x0000&#039; bus=&#039;0x01&#039; slot=&#039;0x00&#039; function=&#039;0x0&#039; /&gt; &lt;/source&gt; &lt;address type=&#039;pci&#039; domain=&#039;0x0000&#039; bus=&#039;0x00&#039; slot=&#039;0x08&#039; function=&#039;0x0&#039; multifunction=&#039;on&#039;/&gt; &lt;/hostdev&gt; &lt;hostdev mode=&#039;subsystem&#039; type=&#039;pci&#039; managed=&#039;yes&#039;&gt; &lt;source&gt; &lt;address domain=&#039;0x0000&#039; bus=&#039;0x01&#039; slot=&#039;0x00&#039; function=&#039;0x1&#039;/&gt; &lt;/source&gt; &lt;address type=&#039;pci&#039; domain=&#039;0x0000&#039; bus=&#039;0x00&#039; slot=&#039;0x09&#039; function=&#039;0x0&#039;/&gt; &lt;/hostdev&gt; &lt;qemu:commandline&gt; &lt;qemu:arg value=&#039;-no-hpet&#039;/&gt; &lt;qemu:arg value=&#039;-drive&#039;/&gt; &lt;qemu:arg value=&#039;if=pflash,format=raw,readonly,file=/usr/share/ovmf/x64/ovmf_x64.bin&#039;/&gt; &lt;/qemu:commandline&gt;</code></pre></div><p>I have just built the latest TianoCore OVMF image using &quot;yaourt -S ovmf-svn&quot; svn version was 16059.</p><p>If I VNC in to the device, I see :</p><div class="codebox"><pre><code>Boot Failed EFI Floppy Boot Failed EFI Floppy 1 Boot Failed Misc Device Boot Failed Misc Device 1</code></pre></div><p>The next screen shows me a mapping table where by I can see what looks like 3 Hard Drives with MBRs on, but I get no further.</p><br /><div class="quotebox"><cite>aw wrote:</cite><blockquote><div><p>Yes, exactly.&#160; My full xml looks like this:</p></div></blockquote></div> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1453678">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1453692" class="blockpost roweven"> <h2><span><span class="conr">#2649</span> <a href="viewtopic.php?pid=1453692#p1453692">2014-09-04 20:19:21</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=75590">aw</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2013-10-04</span></dd> <dd><span>Posts: 921</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=75590">Email</a></span> <span class="website"><a href="http://vfio.blogspot.com/" rel="nofollow">Website</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>gneville wrote:</cite><blockquote><div><p>Getting there slowly, but still having issues.</p><p>It looks like I&#039;ve managed to successfully pass through my Radeon R9 290, although I can only tell his if I enable cirrus graphics and VNC and when at the UEFI Shell performing &quot;pci&quot; to see the Vendor and Device IDs that match the same as when performing &quot;lsusb -n&quot;</p><p>However, I can&#039;t get any display to appear when starting the guest without cirrus and VNC and can&#039;t get it to boot in to Windows either.</p><p>My XML now looks like so</p><div class="codebox"><pre><code> &lt;hostdev mode=&#039;subsystem&#039; type=&#039;pci&#039; managed=&#039;yes&#039;&gt; &lt;source&gt; &lt;address domain=&#039;0x0000&#039; bus=&#039;0x01&#039; slot=&#039;0x00&#039; function=&#039;0x0&#039; /&gt; &lt;/source&gt; &lt;address type=&#039;pci&#039; domain=&#039;0x0000&#039; bus=&#039;0x00&#039; slot=&#039;0x08&#039; function=&#039;0x0&#039; multifunction=&#039;on&#039;/&gt; &lt;/hostdev&gt; &lt;hostdev mode=&#039;subsystem&#039; type=&#039;pci&#039; managed=&#039;yes&#039;&gt; &lt;source&gt; &lt;address domain=&#039;0x0000&#039; bus=&#039;0x01&#039; slot=&#039;0x00&#039; function=&#039;0x1&#039;/&gt; &lt;/source&gt; &lt;address type=&#039;pci&#039; domain=&#039;0x0000&#039; bus=&#039;0x00&#039; slot=&#039;0x09&#039; function=&#039;0x0&#039;/&gt; &lt;/hostdev&gt; &lt;qemu:commandline&gt; &lt;qemu:arg value=&#039;-no-hpet&#039;/&gt; &lt;qemu:arg value=&#039;-drive&#039;/&gt; &lt;qemu:arg value=&#039;if=pflash,format=raw,readonly,file=/usr/share/ovmf/x64/ovmf_x64.bin&#039;/&gt; &lt;/qemu:commandline&gt;</code></pre></div><p>I have just built the latest TianoCore OVMF image using &quot;yaourt -S ovmf-svn&quot; svn version was 16059.</p><p>If I VNC in to the device, I see :</p><div class="codebox"><pre><code>Boot Failed EFI Floppy Boot Failed EFI Floppy 1 Boot Failed Misc Device Boot Failed Misc Device 1</code></pre></div><p>The next screen shows me a mapping table where by I can see what looks like 3 Hard Drives with MBRs on, but I get no further.</p></div></blockquote></div><p>Did you test the ROM for your card to see if it includes EFI support?&#160; When I have emulated graphics and an assigned graphics, OVMF initializes both.&#160; You will need to reinstall your guest, you can&#039;t simply move the disk from a legacy BIOS to a UEFI system and expect it to work, on bare metal or virtual machine.</p> </div> <div class="postsignature postmsg"><hr /><p><a href="http://vfio.blogspot.com" rel="nofollow">http://vfio.blogspot.com</a><br />Looking for a more open forum to discuss vfio related uses?&#160; Try <a href="https://www.redhat.com/mailman/listinfo/vfio-users" rel="nofollow">https://www.redhat.com/mailman/listinfo/vfio-users</a></p></div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1453692">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1453696" class="blockpost rowodd"> <h2><span><span class="conr">#2650</span> <a href="viewtopic.php?pid=1453696#p1453696">2014-09-04 20:28:35</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=80830">gneville</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2014-04-02</span></dd> <dd><span>Posts: 27</span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <p>I&#039;ve just ran the test from your website and I don&#039;t see the type 3, an EFI ROM. I&#039;m very surprised as to why not as this is a brand new card, UEFI is written on the box and stated on the website. </p><p>Thanks for the heads up with the re-install.</p><p>Edit: Just found there is a BIOS selection switch physically on the card! Will dismantle and switch to the other BIOS and test again.</p><p><a href="http://www.sapphiretech.com/presentation/product/product_index.aspx?cid=1&amp;gid=3&amp;sgid=1227&amp;pid=2091&amp;psn&amp;lid=1" rel="nofollow">http://www.sapphiretech.com/presentatio … &amp;psn&amp;lid=1</a></p><div class="codebox"><pre><code>[root@i7-4770s rom-parser]# ./rom-parser /root/r9-290.rom Valid ROM signature found @0h, PCIR offset 238h PCIR: type 0, vendor: 1002, device: 67b1, class: 030000 PCIR: revision 0, vendor revision: f2a Last image</code></pre></div><div class="quotebox"><cite>aw wrote:</cite><blockquote><div><p>Did you test the ROM for your card to see if it includes EFI support?&#160; When I have emulated graphics and an assigned graphics, OVMF initializes both.&#160; You will need to reinstall your guest, you can&#039;t simply move the disk from a legacy BIOS to a UEFI system and expect it to work, on bare metal or virtual machine.</p></div></blockquote></div> <p class="postedit"><em>Last edited by gneville (2014-09-04 20:31:45)</em></p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1453696">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div class="postlinksb"> <div class="inbox crumbsplus"> <div class="pagepost"> <p class="pagelink conl"><span class="pages-label">Pages: </span><a rel="prev" class="item1" href="viewtopic.php?id=162768&amp;p=105">Previous</a> <a href="viewtopic.php?id=162768">1</a> <span class="spacer">…</span> <a href="viewtopic.php?id=162768&amp;p=104">104</a> <a href="viewtopic.php?id=162768&amp;p=105">105</a> <strong>106</strong> <a href="viewtopic.php?id=162768&amp;p=107">107</a> <a href="viewtopic.php?id=162768&amp;p=108">108</a> <span class="spacer">…</span> <a href="viewtopic.php?id=162768&amp;p=234">234</a> <a rel="next" href="viewtopic.php?id=162768&amp;p=107">Next</a></p> <p class="postlink conr">Topic closed</p> </div> <ul class="crumbs"> <li><a href="index.php">Index</a></li> <li><span>»&#160;</span><a href="viewforum.php?id=48">Topics Going Nowhere</a></li> <li><span>»&#160;</span><strong><a href="viewtopic.php?id=162768">KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</a></strong></li> </ul> <p class="subscribelink clearb"><a href="misc.php?action=subscribe&amp;tid=162768">Subscribe to this topic</a></p> <div class="clearer"></div> </div> </div> </div> <div id="brdfooter" class="block"> <h2><span>Board footer</span></h2> <div class="box"> <div id="brdfooternav" class="inbox"> <div class="conl"> <form id="qjump" method="get" action="viewforum.php"> <div><label><span>Jump to<br /></span> <select name="id" onchange="window.location=('viewforum.php?id='+this.options[this.selectedIndex].value)"> <optgroup label="Technical Issues and Assistance"> <option value="23">Newbie Corner</option> <option value="17">Installation</option> <option value="22">Kernel &amp; Hardware</option> <option value="18">Applications &amp; Desktop Environments</option> <option value="31">Laptop Issues</option> <option value="8">Networking, Server, and Protection</option> <option value="32">Multimedia and Games</option> <option value="50">System Administration</option> <option value="35">Other Architectures</option> </optgroup> <optgroup label="Arch-centric"> <option value="24">Announcements, Package &amp; Security Advisories</option> <option value="1">Arch Discussion</option> <option value="13">Forum &amp; Wiki discussion</option> </optgroup> <optgroup label="Pacman Upgrades, Packaging &amp; AUR"> <option value="44">Pacman &amp; Package Upgrade Issues</option> <option value="49">[testing] Repo Forum</option> <option value="4">Creating &amp; Modifying Packages</option> <option value="38">AUR Issues, Discussion &amp; PKGBUILD Requests</option> </optgroup> <optgroup label="Contributions &amp; Discussion"> <option value="20">GNU/Linux Discussion</option> <option value="27">Community Contributions</option> <option value="33">Programming &amp; Scripting</option> <option value="30">Other Languages</option> <option value="47">Artwork and Screenshots</option> <option value="42">Try This</option> </optgroup> <optgroup label="/dev/null"> <option value="29">Off-Topic</option> <option value="48" selected="selected">Topics Going Nowhere</option> <option value="36">Dustbin</option> </optgroup> </select></label> <input type="submit" value=" Go " accesskey="g" /> </div> </form> </div> <div class="conr"> <p id="feedlinks"><span class="atom"><a href="extern.php?action=feed&amp;tid=162768&amp;type=atom">Atom topic feed</a></span></p> <p id="poweredby">Powered by <a href="http://fluxbb.org/">FluxBB</a></p> </div> <div class="clearer"></div> </div> </div> </div> </div> <div class="end-box"></div> </div> </body> </html>
