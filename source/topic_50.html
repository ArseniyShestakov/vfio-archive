<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"> <html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en" dir="ltr"> <head> <meta http-equiv="Content-Type" content="text/html; charset=utf-8" /> <title>KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9 (Page 50) / Topics Going Nowhere / Arch Linux Forums</title> <link rel="stylesheet" type="text/css" href="style/ArchLinux.css" /> <link rel="canonical" href="viewtopic.php?id=162768&amp;p=50" title="Page 50" /> <link rel="prev" href="viewtopic.php?id=162768&amp;p=49" title="Page 49" /> <link rel="next" href="viewtopic.php?id=162768&amp;p=51" title="Page 51" /> <link rel="alternate" type="application/atom+xml" href="extern.php?action=feed&amp;tid=162768&amp;type=atom" title="Atom topic feed" /> <link rel="stylesheet" media="screen" href="style/ArchLinux/arch.css?v=3" /> <link rel="stylesheet" media="screen" href="style/ArchLinux/archnavbar.css?v=2" /> <link rel="shortcut icon" href="style/ArchLinux/favicon.ico" /> </head> <body> <div id="archnavbar" class="anb-forum"> <div id="archnavbarlogo"><h1><a href="http://www.archlinux.org/">Arch Linux</a></h1></div> <div id="archnavbarmenu"> <ul id="archnavbarlist"> <li id="anb-home"><a href="http://www.archlinux.org/">Home</a></li><li id="anb-packages"><a href="http://www.archlinux.org/packages/">Packages</a></li><li id="anb-forums" class="anb-selected"><a href="https://bbs.archlinux.org/">Forums</a></li><li id="anb-wiki"><a href="https://wiki.archlinux.org/">Wiki</a></li><li id="anb-bugs"><a href="https://bugs.archlinux.org/">Bugs</a></li><li id="anb-aur"><a href="https://aur.archlinux.org/">AUR</a></li><li id="anb-download"><a href="http://www.archlinux.org/download/">Download</a></li> </ul> </div> </div> <div id="punviewtopic" class="pun"> <div class="top-box"></div> <div class="punwrap"> <div id="brdheader" class="block"> <div class="box"> <div id="brdmenu" class="inbox"> <ul> <li id="navindex" class="isactive"><a href="index.php">Index</a></li> <li id="navuserlist"><a href="userlist.php">User list</a></li> <li id="navsearch"><a href="search.php">Search</a></li> <li id="navprofile"><a href="profile.php?id=80749">Profile</a></li> <li id="navlogout"><a href="login.php?action=out&amp;id=80749&amp;csrf_token=5c20501ec397bb45ef8ee8c84db232c8d8e421c6">Logout</a></li> </ul> </div> <div id="brdwelcome" class="inbox"> <ul class="conl"> <li><span>Logged in as <strong>SXX</strong></span></li> <li><span>Last visit: 2015-08-16 12:20:09</span></li> </ul> <ul class="conr"> <li><span>Topics: <a href="search.php?action=show_replies" title="Find topics you have posted to.">Posted</a> | <a href="search.php?action=show_new" title="Find topics with new posts since your last visit.">New</a> | <a href="search.php?action=show_recent" title="Find topics with recent posts.">Active</a> | <a href="search.php?action=show_unanswered" title="Find topics with no replies.">Unanswered</a></span></li> </ul> <div class="clearer"></div> </div> </div> </div> <div id="brdmain"> <div class="linkst"> <div class="inbox crumbsplus"> <ul class="crumbs"> <li><a href="index.php">Index</a></li> <li><span>»&#160;</span><a href="viewforum.php?id=48">Topics Going Nowhere</a></li> <li><span>»&#160;</span><strong><a href="viewtopic.php?id=162768">KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</a></strong></li> </ul> <div class="pagepost"> <p class="pagelink conl"><span class="pages-label">Pages: </span><a rel="prev" class="item1" href="viewtopic.php?id=162768&amp;p=49">Previous</a> <a href="viewtopic.php?id=162768">1</a> <span class="spacer">…</span> <a href="viewtopic.php?id=162768&amp;p=48">48</a> <a href="viewtopic.php?id=162768&amp;p=49">49</a> <strong>50</strong> <a href="viewtopic.php?id=162768&amp;p=51">51</a> <a href="viewtopic.php?id=162768&amp;p=52">52</a> <span class="spacer">…</span> <a href="viewtopic.php?id=162768&amp;p=234">234</a> <a rel="next" href="viewtopic.php?id=162768&amp;p=51">Next</a></p> <p class="postlink conr">Topic closed</p> </div> <div class="clearer"></div> </div> </div> <div id="p1386213" class="blockpost rowodd blockpost1"> <h2><span><span class="conr">#1226</span> <a href="viewtopic.php?pid=1386213#p1386213">2014-02-26 17:06:46</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=75590">aw</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2013-10-04</span></dd> <dd><span>Posts: 921</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=75590">Email</a></span> <span class="website"><a href="http://vfio.blogspot.com/" rel="nofollow">Website</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>aw wrote:</cite><blockquote><div><p>Borderlands folks, I think this is the problem you&#039;re trying to describe:</p><p><span class="postimg"><img src="https://dl.dropboxusercontent.com/u/19831938/borderlands2-baremetal.jpg" alt="Bare Metal" /></span></p><p><span class="postimg"><img src="https://dl.dropboxusercontent.com/u/19831938/borderlands2-vm.jpg" alt="VM" /></span></p><p>This vantage point in the training area seems to give me a consistently low FPS and high latency and seems invariant to the lighting.&#160; The VM shows about 1/3rd the FPS and 3x the latency.&#160; What is that latency actually measuring anyway?&#160; These are separate win7x64 installs on the same Haswell/GTX660 hardware with Nvidia Experience optimizing the game in both (highest settings for all).</p><p>I don&#039;t have any solutions yet, but it&#039;s good to understand the problem.&#160; I did run the VM with vfio debugging turned on and I&#039;m not seeing any excessive hits to the card, which means we&#039;re not bouncing out to userspace regularly as a result of the assigned devices (GPU + audio + NIC in this case).&#160; I see a write to 0x88154 at a rate of about 10/s.&#160; This is an area we must trap because it&#039;s an mmio mirror of PCI config space.&#160; That happens regardless of what&#039;s going on in the game and also happens at a basic desktop, so if it was causing any trouble I&#039;d expect it would be across the board and not select games.</p><p>I&#039;m suspicious of USB passthrough, but my only evidence is that hitting the escape key in the game is not as responsive as bare metal and often requires a second hit.&#160; Assignment of the USB controller might be an option, but didn&#039;t just work in my first attempt, maybe an issue with windows drivers.</p><p>EDIT: game reported latency appears to just be the inverse of FPS, so it&#039;s SPF (seconds per frame)</p><p>EDIT2: Further analysis (special thanks to Paolo Bonzini) shows two issues that are hurting performance here.&#160; First is a known issue with Windows that it pounds on the time source, whether it&#039;s ACPI PM timer or HPET.&#160; Code just recently went upstream (kernel and qemu) that enables a Hyper-V enlightened timer that can help to reduce this.&#160; To enable it add &quot;hv-time&quot; to your -cpu option, ex. -cpu Haswell,hv-time&#160; This gives me about 20% more FPS and is likely to help performance of any game running in a Windows guest.&#160; The second problem is that we see extensive use of the processor debug registers.&#160; Each move to or from these registers traps into the hypvervisor and they appear to be batched into a context switch function, so we have a burst of them all at once.&#160; I&#039;ve submitted a support ticket to gearbox software to see if they have any suggestions to avoid these registers.</p></div></blockquote></div><p>Hello performance!&#160; Patches were just posted upstream to do lazy tracking of the debug registers.&#160; With &quot;-cpu Haswell,hv-time&quot; and <a href="http://www.spinics.net/lists/kernel/msg1695823.html" rel="nofollow">these patches</a>, this is what I can get now (better than 80% of bare metal):</p><p><span class="postimg"><img src="https://dl.dropboxusercontent.com/u/19831938/borderlands2-vm-new.jpg" alt="VM-new" /></span></p><p>This initial implementation is Intel-only, but hopefully we can do the same for AMD.</p> </div> <div class="postsignature postmsg"><hr /><p><a href="http://vfio.blogspot.com" rel="nofollow">http://vfio.blogspot.com</a><br />Looking for a more open forum to discuss vfio related uses?&#160; Try <a href="https://www.redhat.com/mailman/listinfo/vfio-users" rel="nofollow">https://www.redhat.com/mailman/listinfo/vfio-users</a></p></div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1386213">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1386232" class="blockpost roweven"> <h2><span><span class="conr">#1227</span> <a href="viewtopic.php?pid=1386232#p1386232">2014-02-26 17:33:12</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=79825">redger</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2014-02-26</span></dd> <dd><span>Posts: 15</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=79825">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <p>thanks kaeptnb !&#160; Reverting to to qemu-1.7.0 and Seabios-1.7.3.1 overcame that problem<br />then the following &quot;Could not initialize SDL&quot; error was addressed by setting the -nographic option</p><p>now the test passes (text appears on the GPU <img src="https://bbs.archlinux.org/img/smilies/smile.png" width="15" height="15" alt="smile" /> ) ..... though for some strange reason my mouse now insists on constantly moving rapidly left .... which is making life entertaining </p><p>thanks again</p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1386232">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1386354" class="blockpost rowodd"> <h2><span><span class="conr">#1228</span> <a href="viewtopic.php?pid=1386354#p1386354">2014-02-26 22:01:15</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=76834">Val532</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2013-11-13</span></dd> <dd><span>Posts: 35</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=76834">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <p>Hi all (again ^^)</p><p>@aw</p><p>I saw a new set of patch for qemu to use Intel IGD as a passthrough device but only with Xen, do you think with this new information you can add Intel IGD to vfio ?</p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1386354">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1386359" class="blockpost roweven"> <h2><span><span class="conr">#1229</span> <a href="viewtopic.php?pid=1386359#p1386359">2014-02-26 22:11:26</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=75590">aw</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2013-10-04</span></dd> <dd><span>Posts: 921</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=75590">Email</a></span> <span class="website"><a href="http://vfio.blogspot.com/" rel="nofollow">Website</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>Val532 wrote:</cite><blockquote><div><p>Hi all (again ^^)</p><p>@aw</p><p>I saw a new set of patch for qemu to use Intel IGD as a passthrough device but only with Xen, do you think with this new information you can add Intel IGD to vfio ?</p></div></blockquote></div><p>There&#039;s already someone in the community working on IGD passthrough.</p> </div> <div class="postsignature postmsg"><hr /><p><a href="http://vfio.blogspot.com" rel="nofollow">http://vfio.blogspot.com</a><br />Looking for a more open forum to discuss vfio related uses?&#160; Try <a href="https://www.redhat.com/mailman/listinfo/vfio-users" rel="nofollow">https://www.redhat.com/mailman/listinfo/vfio-users</a></p></div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1386359">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1386368" class="blockpost rowodd"> <h2><span><span class="conr">#1230</span> <a href="viewtopic.php?pid=1386368#p1386368">2014-02-26 22:19:40</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=76834">Val532</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2013-11-13</span></dd> <dd><span>Posts: 35</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=76834">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>aw wrote:</cite><blockquote><div><div class="quotebox"><cite>Val532 wrote:</cite><blockquote><div><p>Hi all (again ^^)</p><p>@aw</p><p>I saw a new set of patch for qemu to use Intel IGD as a passthrough device but only with Xen, do you think with this new information you can add Intel IGD to vfio ?</p></div></blockquote></div><p>There&#039;s already someone in the community working on IGD passthrough.</p></div></blockquote></div><p>Really ? Where can i find some information about this ?</p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1386368">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1386370" class="blockpost roweven"> <h2><span><span class="conr">#1231</span> <a href="viewtopic.php?pid=1386370#p1386370">2014-02-26 22:23:11</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=77819">tuoni</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2013-12-19</span></dd> <dd><span>Posts: 7</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=77819">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>neona wrote:</cite><blockquote><div><p>The other major issue i&#039;m having is trouble getting networking working in any configuration other than the default user mode (as it is in my commandline).&#160; All attempts to use tap/tun result in various &quot;device busy&quot; or &quot;device can&#039;t be accessed&quot; messages.&#160; This wouldn&#039;t be a big deal, but it&#039;s clear that tap/tun should provide better performance, and also I need the guest to be able to talk to the host so I can use synergy, so it&#039;s a bit of an issue.</p></div></blockquote></div><p>I don&#039;t specify a networking switch and have synergy working just fine by giving it the host&#039;s IP address (192.168.0.X) to the Win7 guest.&#160; Saying that, I&#039;m having similar problems getting tap/tun working, but I&#039;m still getting plenty good enough throughput on the guest.</p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1386370">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1386425" class="blockpost rowodd"> <h2><span><span class="conr">#1232</span> <a href="viewtopic.php?pid=1386425#p1386425">2014-02-27 03:05:21</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=79802">neona</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2014-02-25</span></dd> <dd><span>Posts: 6</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=79802">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>tuoni wrote:</cite><blockquote><div><div class="quotebox"><cite>neona wrote:</cite><blockquote><div><p>The other major issue i&#039;m having is trouble getting networking working in any configuration other than the default user mode (as it is in my commandline).&#160; All attempts to use tap/tun result in various &quot;device busy&quot; or &quot;device can&#039;t be accessed&quot; messages.&#160; This wouldn&#039;t be a big deal, but it&#039;s clear that tap/tun should provide better performance, and also I need the guest to be able to talk to the host so I can use synergy, so it&#039;s a bit of an issue.</p></div></blockquote></div><p>I don&#039;t specify a networking switch and have synergy working just fine by giving it the host&#039;s IP address (192.168.0.X) to the Win7 guest.&#160; Saying that, I&#039;m having similar problems getting tap/tun working, but I&#039;m still getting plenty good enough throughput on the guest.</p></div></blockquote></div><p>The reason that synergy isn&#039;t working for me is that I&#039;m trying to run the server on the guest (which is behind NAT by default) so I can usb passthrough my kb/m, both for ease of use and to expose all features on them (particularly a razer naga).</p><p>Of course, you&#039;ve reminded me that the opposite setup is an option for the time being, so I should probably just do that until I can properly configure networking.&#160; I&#039;m considering just being lazy and sticking in an extra NIC to pass through though, that may offer better performance than any virtual option anyway.</p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1386425">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1386476" class="blockpost roweven"> <h2><span><span class="conr">#1233</span> <a href="viewtopic.php?pid=1386476#p1386476">2014-02-27 09:19:56</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=79802">neona</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2014-02-25</span></dd> <dd><span>Posts: 6</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=79802">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>neona wrote:</cite><blockquote><div><p>For some reason, qemu only claims to support oss, wav, and spice output, so sound won&#039;t work.&#160; I double checked the PKGBUILD for qemu, and it&#039;s clearly being compiled with pulse and alsa support (or should be, anyway), so I have no clue what&#039;s causing this, and some googling around hasn&#039;t found anything.&#160; I&#039;ve tried various ways of wrapping oss to pulse/alsa, and none of that has worked either.&#160; This is rather inconvienient, but at least if I can get networking to behave then I think it&#039;s possible to have windows output to pulse if nothing else works.&#160; I might also get a usb soundcard, but I&#039;d rather avoid spending money if I can.</p></div></blockquote></div><p>Turns out I&#039;m an idiot, and installed a different qemu at some point that was earlier in my path than the one from qemu-git.&#160; Cleaned that out and sound works fine now.</p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1386476">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1386481" class="blockpost rowodd"> <h2><span><span class="conr">#1234</span> <a href="viewtopic.php?pid=1386481#p1386481">2014-02-27 09:47:27</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=77842">Flyser</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2013-12-19</span></dd> <dd><span>Posts: 29</span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <p>Before I spend hours trying ... is it possible to pass the intel onboard sound card to the guest with vfio?</p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1386481">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1386487" class="blockpost roweven"> <h2><span><span class="conr">#1235</span> <a href="viewtopic.php?pid=1386487#p1386487">2014-02-27 10:36:05</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=78355">anickname</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2014-01-07</span></dd> <dd><span>Posts: 23</span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>Flyser wrote:</cite><blockquote><div><p>Before I spend hours trying ... is it possible to pass the intel onboard sound card to the guest with vfio?</p></div></blockquote></div><p>On my motherboard &quot;Asrock Z77 Professional Fatal1ty&quot; worked without any problems.<br />The sound is like on the real hardware.</p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1386487">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1386705" class="blockpost rowodd"> <h2><span><span class="conr">#1236</span> <a href="viewtopic.php?pid=1386705#p1386705">2014-02-27 19:33:33</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=76834">Val532</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2013-11-13</span></dd> <dd><span>Posts: 35</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=76834">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <p>Is anybody have a working audio on HDMI for AMD card ?<br />For me, i have no audio on all of my VM.</p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1386705">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1386708" class="blockpost roweven"> <h2><span><span class="conr">#1237</span> <a href="viewtopic.php?pid=1386708#p1386708">2014-02-27 19:42:54</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=53953">andy123</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2011-11-04</span></dd> <dd><span>Posts: 169</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=53953">Email</a></span> <span class="website"><a href="http://ajs124.de" rel="nofollow">Website</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>Val532 wrote:</cite><blockquote><div><p>Is anybody have a working audio on HDMI for AMD card ?<br />For me, i have no audio on all of my VM.</p></div></blockquote></div><p>I actually used to have my sound setup like this &quot;AMD guest gpu HDMI → Display → audio cable output on Display → line in on onboard sound&quot;, which worked pretty well.</p><p>As far as my understanding of the stuff goes the &quot;soundcard&quot; on the GPU is the .1 function in most cases, so you need to make sure that it&#039;s passed through. What GPU are you using and do you have any error messages besides no output?&#160; </p><p>Since qemu is running as root and I&#039;m using pulseaudio I&#039;m now doing &quot;remote&quot; pulseaudio over localhost.</p> </div> <div class="postsignature postmsg"><hr /><p>i&#039;m sorry for my poor english wirting skills…</p></div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1386708">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1386721" class="blockpost rowodd"> <h2><span><span class="conr">#1238</span> <a href="viewtopic.php?pid=1386721#p1386721">2014-02-27 20:04:51</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=76834">Val532</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2013-11-13</span></dd> <dd><span>Posts: 35</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=76834">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>andy123 wrote:</cite><blockquote><div><div class="quotebox"><cite>Val532 wrote:</cite><blockquote><div><p>Is anybody have a working audio on HDMI for AMD card ?<br />For me, i have no audio on all of my VM.</p></div></blockquote></div><p>I actually used to have my sound setup like this &quot;AMD guest gpu HDMI → Display → audio cable output on Display → line in on onboard sound&quot;, which worked pretty well.</p><p>As far as my understanding of the stuff goes the &quot;soundcard&quot; on the GPU is the .1 function in most cases, so you need to make sure that it&#039;s passed through. What GPU are you using and do you have any error messages besides no output?&#160; </p><p>Since qemu is running as root and I&#039;m using pulseaudio I&#039;m now doing &quot;remote&quot; pulseaudio over localhost.</p></div></blockquote></div><p>So i start (one of) my VM with :</p><div class="codebox"><pre><code>sudo qemu-system-x86_64 \ -M q35 -m 8G -enable-kvm -cpu host,hv-time -vga none -boot menu=on -no-fdc \ -smp 4,sockets=1,cores=4,threads=1 \ -device ioh3420,bus=pcie.0,id=root.1,port=1,chassis=1,addr=1c.0,multifunction=on \ -device vfio-pci,host=01:00.0,bus=root.1,addr=00.0,multifunction=on,x-vga=on \ -device vfio-pci,host=01:00.1,bus=root.1 \ -device ahci,bus=pcie.0,id=ahci \ -drive file=/home/val/Image\ HDD/Windows-7-Test.img,id=disk,format=qcow2 \ -device ide-hd,bus=ahci.0,drive=disk \ -net nic,model=e1000 -net tap,ifname=tap0 \ -usb -usbdevice host:05e3:0607 -usbdevice host:1532:002f -usbdevice host:046d:c229 -usbdevice host:046d:c228</code></pre></div><p>And my graphique card is an AMD HD5570.</p><p>I see an audio card in the device manager of Windows, but with error code 10.</p><br /><p>About another subject, i try hv-time and i do not understand why but with -cpu host,hv-time does not work with Windows 8.1 Entreprise, but work with Windows 7 it&#039;s ok. It works with -cpu Haswell,hv-time for both.</p> <p class="postedit"><em>Last edited by Val532 (2014-02-27 20:05:48)</em></p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1386721">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1386758" class="blockpost roweven"> <h2><span><span class="conr">#1239</span> <a href="viewtopic.php?pid=1386758#p1386758">2014-02-27 21:37:18</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=78331">MichaelLong</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2014-01-06</span></dd> <dd><span>Posts: 3</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=78331">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>aw wrote:</cite><blockquote><div><div class="quotebox"><cite>aw wrote:</cite><blockquote><div><p>Borderlands folks, I think this is the problem you&#039;re trying to describe:</p><p><a href="https://dl.dropboxusercontent.com/u/19831938/borderlands2-baremetal.jpg" rel="nofollow">https://dl.dropboxusercontent.com/u/198 … emetal.jpg</a></p><p><a href="https://dl.dropboxusercontent.com/u/19831938/borderlands2-vm.jpg" rel="nofollow">https://dl.dropboxusercontent.com/u/198 … ds2-vm.jpg</a></p><p>This vantage point in the training area seems to give me a consistently low FPS and high latency and seems invariant to the lighting.&#160; The VM shows about 1/3rd the FPS and 3x the latency.&#160; What is that latency actually measuring anyway?&#160; These are separate win7x64 installs on the same Haswell/GTX660 hardware with Nvidia Experience optimizing the game in both (highest settings for all).</p><p>I don&#039;t have any solutions yet, but it&#039;s good to understand the problem.&#160; I did run the VM with vfio debugging turned on and I&#039;m not seeing any excessive hits to the card, which means we&#039;re not bouncing out to userspace regularly as a result of the assigned devices (GPU + audio + NIC in this case).&#160; I see a write to 0x88154 at a rate of about 10/s.&#160; This is an area we must trap because it&#039;s an mmio mirror of PCI config space.&#160; That happens regardless of what&#039;s going on in the game and also happens at a basic desktop, so if it was causing any trouble I&#039;d expect it would be across the board and not select games.</p><p>I&#039;m suspicious of USB passthrough, but my only evidence is that hitting the escape key in the game is not as responsive as bare metal and often requires a second hit.&#160; Assignment of the USB controller might be an option, but didn&#039;t just work in my first attempt, maybe an issue with windows drivers.</p><p>EDIT: game reported latency appears to just be the inverse of FPS, so it&#039;s SPF (seconds per frame)</p><p>EDIT2: Further analysis (special thanks to Paolo Bonzini) shows two issues that are hurting performance here.&#160; First is a known issue with Windows that it pounds on the time source, whether it&#039;s ACPI PM timer or HPET.&#160; Code just recently went upstream (kernel and qemu) that enables a Hyper-V enlightened timer that can help to reduce this.&#160; To enable it add &quot;hv-time&quot; to your -cpu option, ex. -cpu Haswell,hv-time&#160; This gives me about 20% more FPS and is likely to help performance of any game running in a Windows guest.&#160; The second problem is that we see extensive use of the processor debug registers.&#160; Each move to or from these registers traps into the hypvervisor and they appear to be batched into a context switch function, so we have a burst of them all at once.&#160; I&#039;ve submitted a support ticket to gearbox software to see if they have any suggestions to avoid these registers.</p></div></blockquote></div><p>Hello performance!&#160; Patches were just posted upstream to do lazy tracking of the debug registers.&#160; With &quot;-cpu Haswell,hv-time&quot; and <a href="http://www.spinics.net/lists/kernel/msg1695823.html" rel="nofollow">these patches</a>, this is what I can get now (better than 80% of bare metal):</p><p><a href="https://dl.dropboxusercontent.com/u/19831938/borderlands2-vm-new.jpg" rel="nofollow">https://dl.dropboxusercontent.com/u/198 … vm-new.jpg</a></p><p>This initial implementation is Intel-only, but hopefully we can do the same for AMD.</p></div></blockquote></div><p>Great news. I applied those patches ontop of kernel 3.14-rc4 and I can report that they also fixed my performance problems in Battlefield 4! I couldn&#039;t do any intensive tests yet but after playing about 1h or so it is clear that the performance has nearly restored. Thx a lot.</p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1386758">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1386805" class="blockpost rowodd"> <h2><span><span class="conr">#1240</span> <a href="viewtopic.php?pid=1386805#p1386805">2014-02-27 22:38:51</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=76834">Val532</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2013-11-13</span></dd> <dd><span>Posts: 35</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=76834">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <p>Is anybody tried to install Hyper-V on a Windows 8 or 2012 server VM ?</p><p>When i want add Hyper-V to my Windows 8 Entreprise (juste for testing purpose) i can because of an &quot;hypervisor is already run&quot; (something like that, because the message is in french for me ^^)</p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1386805">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1386817" class="blockpost roweven"> <h2><span><span class="conr">#1241</span> <a href="viewtopic.php?pid=1386817#p1386817">2014-02-27 23:01:22</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=75590">aw</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2013-10-04</span></dd> <dd><span>Posts: 921</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=75590">Email</a></span> <span class="website"><a href="http://vfio.blogspot.com/" rel="nofollow">Website</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>Val532 wrote:</cite><blockquote><div><p>Is anybody tried to install Hyper-V on a Windows 8 or 2012 server VM ?</p><p>When i want add Hyper-V to my Windows 8 Entreprise (juste for testing purpose) i can because of an &quot;hypervisor is already run&quot; (something like that, because the message is in french for me ^^)</p></div></blockquote></div><p>You need to enabled nested hypervisor support for that to work... but it&#039;s not really relevant to this thread.</p> </div> <div class="postsignature postmsg"><hr /><p><a href="http://vfio.blogspot.com" rel="nofollow">http://vfio.blogspot.com</a><br />Looking for a more open forum to discuss vfio related uses?&#160; Try <a href="https://www.redhat.com/mailman/listinfo/vfio-users" rel="nofollow">https://www.redhat.com/mailman/listinfo/vfio-users</a></p></div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1386817">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1386841" class="blockpost rowodd"> <h2><span><span class="conr">#1242</span> <a href="viewtopic.php?pid=1386841#p1386841">2014-02-28 00:04:31</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=79333">Kaidax</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd class="postavatar"><img src="https://bbs.archlinux.org/img/avatars/79333.png?m=1391951511" width="80" height="80" alt="" /></dd> <dd><span>Registered: 2014-02-09</span></dd> <dd><span>Posts: 6</span></dd> <dd class="usercontacts"><span class="email"><a href="mailto:kudahkukarek@gmail.com">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>aw wrote:</cite><blockquote><div><p>Hello performance!&#160; Patches were just posted upstream to do lazy tracking of the debug registers.&#160; With &quot;-cpu Haswell,hv-time&quot; and <a href="http://www.spinics.net/lists/kernel/msg1695823.html" rel="nofollow">these patches</a>, this is what I can get now (better than 80% of bare metal):</p><p><a href="https://dl.dropboxusercontent.com/u/19831938/borderlands2-vm-new.jpg" rel="nofollow">https://dl.dropboxusercontent.com/u/198 … vm-new.jpg</a></p><p>This initial implementation is Intel-only, but hopefully we can do the same for AMD.</p></div></blockquote></div><p>That does the trick! Except I have to disable hv-time to play; enabling it drops performance to 15 fps, introduces severe graphical corruption, and makes journald dump gigabytes of logs.</p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1386841">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1386843" class="blockpost roweven"> <h2><span><span class="conr">#1243</span> <a href="viewtopic.php?pid=1386843#p1386843">2014-02-28 00:11:05</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=76834">Val532</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2013-11-13</span></dd> <dd><span>Posts: 35</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=76834">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>aw wrote:</cite><blockquote><div><div class="quotebox"><cite>Val532 wrote:</cite><blockquote><div><p>Is anybody tried to install Hyper-V on a Windows 8 or 2012 server VM ?</p><p>When i want add Hyper-V to my Windows 8 Entreprise (juste for testing purpose) i can because of an &quot;hypervisor is already run&quot; (something like that, because the message is in french for me ^^)</p></div></blockquote></div><p>You need to enabled nested hypervisor support for that to work... but it&#039;s not really relevant to this thread.</p></div></blockquote></div><p>Yeah i know it seems not relevant to the thread, but if i want to try it, it because of GPU passtrough ^^.</p><p>I have a working setup with two GPU on the same VM and i want to try the remoteFX fonction ^^.</p><p>But could you explain to me how to enable nested fonction ? (i see nested:bool in kvm_intel module).</p><p>Thanks.</p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1386843">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1386846" class="blockpost rowodd"> <h2><span><span class="conr">#1244</span> <a href="viewtopic.php?pid=1386846#p1386846">2014-02-28 00:17:11</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=75590">aw</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2013-10-04</span></dd> <dd><span>Posts: 921</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=75590">Email</a></span> <span class="website"><a href="http://vfio.blogspot.com/" rel="nofollow">Website</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>Val532 wrote:</cite><blockquote><div><div class="quotebox"><cite>aw wrote:</cite><blockquote><div><div class="quotebox"><cite>Val532 wrote:</cite><blockquote><div><p>Is anybody tried to install Hyper-V on a Windows 8 or 2012 server VM ?</p><p>When i want add Hyper-V to my Windows 8 Entreprise (juste for testing purpose) i can because of an &quot;hypervisor is already run&quot; (something like that, because the message is in french for me ^^)</p></div></blockquote></div><p>You need to enabled nested hypervisor support for that to work... but it&#039;s not really relevant to this thread.</p></div></blockquote></div><p>Yeah i know it seems not relevant to the thread, but if i want to try it, it because of GPU passtrough ^^.</p><p>I have a working setup with two GPU on the same VM and i want to try the remoteFX fonction ^^.</p><p>But could you explain to me how to enable nested fonction ? (i see nested:bool in kvm_intel module).</p><p>Thanks.</p></div></blockquote></div><p>More than I know here - <a href="http://git.kernel.org/cgit/linux/kernel/git/torvalds/linux.git/tree/Documentation/virtual/kvm/nested-vmx.txt" rel="nofollow">http://git.kernel.org/cgit/linux/kernel … ed-vmx.txt</a></p> </div> <div class="postsignature postmsg"><hr /><p><a href="http://vfio.blogspot.com" rel="nofollow">http://vfio.blogspot.com</a><br />Looking for a more open forum to discuss vfio related uses?&#160; Try <a href="https://www.redhat.com/mailman/listinfo/vfio-users" rel="nofollow">https://www.redhat.com/mailman/listinfo/vfio-users</a></p></div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1386846">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1386850" class="blockpost roweven"> <h2><span><span class="conr">#1245</span> <a href="viewtopic.php?pid=1386850#p1386850">2014-02-28 00:30:18</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=76834">Val532</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2013-11-13</span></dd> <dd><span>Posts: 35</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=76834">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>aw wrote:</cite><blockquote><div><div class="quotebox"><cite>Val532 wrote:</cite><blockquote><div><div class="quotebox"><cite>aw wrote:</cite><blockquote><div><p>You need to enabled nested hypervisor support for that to work... but it&#039;s not really relevant to this thread.</p></div></blockquote></div><p>Yeah i know it seems not relevant to the thread, but if i want to try it, it because of GPU passtrough ^^.</p><p>I have a working setup with two GPU on the same VM and i want to try the remoteFX fonction ^^.</p><p>But could you explain to me how to enable nested fonction ? (i see nested:bool in kvm_intel module).</p><p>Thanks.</p></div></blockquote></div><p>More than I know here - <a href="http://git.kernel.org/cgit/linux/kernel/git/torvalds/linux.git/tree/Documentation/virtual/kvm/nested-vmx.txt" rel="nofollow">http://git.kernel.org/cgit/linux/kernel … ed-vmx.txt</a></p></div></blockquote></div><p>Ok so this is what i already do.</p><p>But Windows 8.1 knows it&#039;s runing on the top of an hypervisor, so i does not let me install Hyper-V.</p><p>Probably it&#039;s because of some modification to some Hyper-V change on qemu ?</p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1386850">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1386886" class="blockpost rowodd"> <h2><span><span class="conr">#1246</span> <a href="viewtopic.php?pid=1386886#p1386886">2014-02-28 06:08:18</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=78314">MacCoaster</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2014-01-06</span></dd> <dd><span>Posts: 10</span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <p>Sigh... my system was working fine with a R9 290X, even after the new ACS patch (no downstream). But now I&#039;m getting:</p><div class="codebox"><pre><code>[ 310.018977] dmar: DRHD: handling fault status reg 3 [ 310.033576] dmar: DMAR:[DMA Read] Request device [01:00.0] fault addr 1e9fae0000 [ 310.033576] DMAR:[fault reason 06] PTE Read access is not set [ 310.218996] dmar: DRHD: handling fault status reg 3 [ 310.233609] dmar: DMAR:[DMA Read] Request device [01:00.0] fault addr 1e9fae0000 [ 310.233609] DMAR:[fault reason 06] PTE Read access is not set [ 310.468989] dmar: DRHD: handling fault status reg 3 [ 310.483594] dmar: DMAR:[DMA Read] Request device [01:00.0] fault addr 1e9fae0000 [ 310.483594] DMAR:[fault reason 06] PTE Read access is not set</code></pre></div><p>1:00.0 is my R9 290X. <img src="https://bbs.archlinux.org/img/smilies/sad.png" width="15" height="15" alt="sad" /> Screen goes crazy once the AMD drivers load.</p><p>lsgroup:</p><div class="codebox"><pre class="vscroll"><code>### Group 0 ### 00:00.0 Host bridge: Intel Corporation Xeon E3-1200 v3 Processor DRAM Controller (rev 06) ### Group 1 ### 00:01.0 PCI bridge: Intel Corporation Xeon E3-1200 v3/4th Gen Core Processor PCI Express x16 Controller (rev 06) 01:00.0 VGA compatible controller: Advanced Micro Devices, Inc. [AMD/ATI] Hawaii XT [Radeon HD 8970] 01:00.1 Audio device: Advanced Micro Devices, Inc. [AMD/ATI] Device aac8 ### Group 2 ### 00:02.0 VGA compatible controller: Intel Corporation Xeon E3-1200 v3 Processor Integrated Graphics Controller (rev 06) ### Group 3 ### 00:03.0 Audio device: Intel Corporation Xeon E3-1200 v3/4th Gen Core Processor HD Audio Controller (rev 06) ### Group 4 ### 00:14.0 USB controller: Intel Corporation 8 Series/C220 Series Chipset Family USB xHCI (rev 04) ### Group 5 ### 00:16.0 Communication controller: Intel Corporation 8 Series/C220 Series Chipset Family MEI Controller #1 (rev 04) ### Group 6 ### 00:1a.0 USB controller: Intel Corporation 8 Series/C220 Series Chipset Family USB EHCI #2 (rev 04) ### Group 7 ### 00:1b.0 Audio device: Intel Corporation 8 Series/C220 Series Chipset High Definition Audio Controller (rev 04) ### Group 8 ### 00:1c.0 PCI bridge: Intel Corporation 8 Series/C220 Series Chipset Family PCI Express Root Port #1 (rev d4) ### Group 9 ### 00:1c.1 PCI bridge: Intel Corporation 82801 PCI Bridge (rev d4) 03:00.0 PCI bridge: ASMedia Technology Inc. ASM1083/1085 PCIe to PCI Bridge (rev 03) 04:02.0 FireWire (IEEE 1394): VIA Technologies, Inc. VT6306/7/8 [Fire II(M)] IEEE 1394 OHCI Controller (rev c0) ### Group 10 ### 00:1c.2 PCI bridge: Intel Corporation 8 Series/C220 Series Chipset Family PCI Express Root Port #3 (rev d4) ### Group 11 ### 00:1c.3 PCI bridge: Intel Corporation 8 Series/C220 Series Chipset Family PCI Express Root Port #4 (rev d4) ### Group 12 ### 00:1c.4 PCI bridge: Intel Corporation 8 Series/C220 Series Chipset Family PCI Express Root Port #5 (rev d4) ### Group 13 ### 00:1d.0 USB controller: Intel Corporation 8 Series/C220 Series Chipset Family USB EHCI #1 (rev 04) ### Group 14 ### 00:1f.0 ISA bridge: Intel Corporation C226 Series Chipset Family Server Advanced SKU LPC Controller (rev 04) 00:1f.2 SATA controller: Intel Corporation 8 Series/C220 Series Chipset Family 6-port SATA Controller 1 [AHCI mode] (rev 04) 00:1f.3 SMBus: Intel Corporation 8 Series/C220 Series Chipset Family SMBus Controller (rev 04) ### Group 15 ### 05:00.0 Ethernet controller: Intel Corporation I210 Gigabit Network Connection (rev 03) ### Group 16 ### 06:00.0 Ethernet controller: Intel Corporation I210 Gigabit Network Connection (rev 03) ### Group 17 ### 07:00.0 Serial Attached SCSI controller: LSI Logic / Symbios Logic SAS2008 PCI-Express Fusion-MPT SAS-2 [Falcon] (rev 03)</code></pre></div><p>GRUB_CMDLINE_LINUX:</p><div class="codebox"><pre><code>GRUB_CMDLINE_LINUX=&quot;cryptdevice=/dev/disk/by-uuid/442a2a16-e934-48d6-a043-ff00534c5dfe:sys vfio_iommu_type1.allow_unsafe_interrupts=1 intel_iommu=on pci-stub.ids=1002:67b0,1002:aac8 kvm_intel.emulate_invalid_guest_state=0 nohz=off&quot;</code></pre></div><p>Am I screwed?</p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1386886">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1386950" class="blockpost roweven"> <h2><span><span class="conr">#1247</span> <a href="viewtopic.php?pid=1386950#p1386950">2014-02-28 10:44:24</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=79471">Bronek</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>From: London</span></dd> <dd><span>Registered: 2014-02-14</span></dd> <dd><span>Posts: 90</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=79471">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>MacCoaster wrote:</cite><blockquote><div><p>Sigh... my system was working fine with a R9 290X, even after the new ACS patch (no downstream). But now I&#039;m getting:</p><div class="codebox"><pre><code>[ 310.018977] dmar: DRHD: handling fault status reg 3 [ 310.033576] dmar: DMAR:[DMA Read] Request device [01:00.0] fault addr 1e9fae0000 [ 310.033576] DMAR:[fault reason 06] PTE Read access is not set [ 310.218996] dmar: DRHD: handling fault status reg 3 [ 310.233609] dmar: DMAR:[DMA Read] Request device [01:00.0] fault addr 1e9fae0000 [ 310.233609] DMAR:[fault reason 06] PTE Read access is not set [ 310.468989] dmar: DRHD: handling fault status reg 3 [ 310.483594] dmar: DMAR:[DMA Read] Request device [01:00.0] fault addr 1e9fae0000 [ 310.483594] DMAR:[fault reason 06] PTE Read access is not set</code></pre></div><p>1:00.0 is my R9 290X. <img src="https://bbs.archlinux.org/img/smilies/sad.png" width="15" height="15" alt="sad" /> Screen goes crazy once the AMD drivers load.</p><br /><p>Am I screwed?</p></div></blockquote></div><p>This is not your primary GPU now, is it? These things may change depending on your computer BIOS setup and PCIe slot location it is attached to. </p><p>Basically what I learned from reading <strong>aw</strong> posts above is that if you use pci-stub on a GPU device (as you should) this will prevent device driver from attaching to it, but will <strong>not</strong> prevent vgacon from using the same device. And vgacon is not smart enough to care about hypervisor arbitration etc, it will simply corrupt your device state when the GPU gets attached to VM.</p><p>So the trick here is either to ensure that <strong>some other card is primary</strong> on boot, or <strong>let the smarter driver</strong> (rather than vgacon) use the device prior to VM startup, by not assigning it to the pci-stub module on kernel boot.</p><p><em>At least, that&#039;s my understanding, but I&#039;m very much beginner in such setup</em></p> <p class="postedit"><em>Last edited by Bronek (2014-02-28 10:45:41)</em></p> </div> <div class="postsignature postmsg"><hr /><p>Sorry about&#160; &quot;KVM VGA-Passthrough ...&quot; thread <img src="https://bbs.archlinux.org/img/smilies/sad.png" width="15" height="15" alt="sad" /> Anyone interested in continuing this discussion elsewhere, please contact me privately. I might be able to find it a new home.</p></div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1386950">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1387045" class="blockpost rowodd"> <h2><span><span class="conr">#1248</span> <a href="viewtopic.php?pid=1387045#p1387045">2014-02-28 15:09:28</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=75590">aw</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2013-10-04</span></dd> <dd><span>Posts: 921</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=75590">Email</a></span> <span class="website"><a href="http://vfio.blogspot.com/" rel="nofollow">Website</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>Bronek wrote:</cite><blockquote><div><div class="quotebox"><cite>MacCoaster wrote:</cite><blockquote><div><p>Sigh... my system was working fine with a R9 290X, even after the new ACS patch (no downstream). But now I&#039;m getting:</p><div class="codebox"><pre><code>[ 310.018977] dmar: DRHD: handling fault status reg 3 [ 310.033576] dmar: DMAR:[DMA Read] Request device [01:00.0] fault addr 1e9fae0000 [ 310.033576] DMAR:[fault reason 06] PTE Read access is not set [ 310.218996] dmar: DRHD: handling fault status reg 3 [ 310.233609] dmar: DMAR:[DMA Read] Request device [01:00.0] fault addr 1e9fae0000 [ 310.233609] DMAR:[fault reason 06] PTE Read access is not set [ 310.468989] dmar: DRHD: handling fault status reg 3 [ 310.483594] dmar: DMAR:[DMA Read] Request device [01:00.0] fault addr 1e9fae0000 [ 310.483594] DMAR:[fault reason 06] PTE Read access is not set</code></pre></div><p>1:00.0 is my R9 290X. <img src="https://bbs.archlinux.org/img/smilies/sad.png" width="15" height="15" alt="sad" /> Screen goes crazy once the AMD drivers load.</p><br /><p>Am I screwed?</p></div></blockquote></div><p>This is not your primary GPU now, is it? These things may change depending on your computer BIOS setup and PCIe slot location it is attached to. </p><p>Basically what I learned from reading <strong>aw</strong> posts above is that if you use pci-stub on a GPU device (as you should) this will prevent device driver from attaching to it, but will <strong>not</strong> prevent vgacon from using the same device. And vgacon is not smart enough to care about hypervisor arbitration etc, it will simply corrupt your device state when the GPU gets attached to VM.</p><p>So the trick here is either to ensure that <strong>some other card is primary</strong> on boot, or <strong>let the smarter driver</strong> (rather than vgacon) use the device prior to VM startup, by not assigning it to the pci-stub module on kernel boot.</p><p><em>At least, that&#039;s my understanding, but I&#039;m very much beginner in such setup</em></p></div></blockquote></div><p>That&#039;s true, but I&#039;m not sure it would cause this problem.&#160; The VGA region is accessed by the CPU and therefore not subject to IOMMU translation.&#160; The IOMMU only handles accesses initiated by the device.&#160; So if vgacon is being used we&#039;ll get corrupted screens, as you indicate, but we won&#039;t get DMAR faults.</p><p>The DMAR faults indicate they are blocking the 8970 from reading memory just below 128GB.&#160; It seems like a safe assumption that you don&#039;t have a 128GB VM, so the IOMMU is probably doing it&#039;s job by preventing these.&#160; Does the card still work on bare metal?&#160; It is possible that a failed memory controller on the card could be generating these accesses.&#160; Does the address remotely resemble the host or guest address of the device?&#160; (lspci in the host, info pci/info mtree in the qemu monitor)&#160; If you haven&#039;t already, a hard power cycle might be a good idea.</p> </div> <div class="postsignature postmsg"><hr /><p><a href="http://vfio.blogspot.com" rel="nofollow">http://vfio.blogspot.com</a><br />Looking for a more open forum to discuss vfio related uses?&#160; Try <a href="https://www.redhat.com/mailman/listinfo/vfio-users" rel="nofollow">https://www.redhat.com/mailman/listinfo/vfio-users</a></p></div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1387045">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1387086" class="blockpost roweven"> <h2><span><span class="conr">#1249</span> <a href="viewtopic.php?pid=1387086#p1387086">2014-02-28 17:23:52</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=79237">mbroemme</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>From: Cologne</span></dd> <dd><span>Registered: 2014-02-05</span></dd> <dd><span>Posts: 39</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=79237">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>andy123 wrote:</cite><blockquote><div><p>The nvidia guys seem to have a problem with their setup: <a href="https://devtalk.nvidia.com/default/topic/545560/linux/vfio-vga-arbitration-lock/post/4131164/#4131164" rel="nofollow">https://devtalk.nvidia.com/default/topi … 4/#4131164</a></p><p>We have a number on their internal bugtracker, so maybe we should try helping them with their issues, so they can reproduce it and fix it at some point.</p></div></blockquote></div><p>I&#039;ve told the guy at Nvidia already in a private message that I will follow-up next week as I was on a conference.</p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1387086">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1387216" class="blockpost rowodd"> <h2><span><span class="conr">#1250</span> <a href="viewtopic.php?pid=1387216#p1387216">2014-02-28 22:15:41</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=79893">jonascj</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2014-02-28</span></dd> <dd><span>Posts: 13</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=79893">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <p>I am new to passthrough with KVM and have read this thread from beginning to end with the intention of setting up a similar system but I have a some basic / &quot;superficial&quot; questions before I begin.</p><p>#1: How is the Windows guest visualized (what/where is its display)?<br />My only experience with &quot;graphical access&quot; to KVM guests is via VNC, but that will not do it for gaming. So how is the guest visualized / what is its display? As far as I can understand from the thread people simply have a monitor connected directly to the graphics card which is passed through to the guest, is this understood correctly? This directly connected monitor can then have multiple inputs which can be changed on the monitor itself or one could use a display switch box.</p><p>#2: Any alternatives to #1?<br />In the thread I see a couple of discussions about copying the frame buffer of one graphics card to another, but all of them end with the poster saying it is just speculation and that it should be theoretically possible. Anyone who have succeeded with getting the video output from the guest into a window on the host via whatever method?</p><p>#3: Are two powerful graphics cards needed?<br />Quite a few posters have two quite powerful graphics cards installed. Isn&#039;t one powerful graphics card enough (one to pass to the guest used for playing games) and a less powerful one for running the host displays?</p><p>#4: Is a dedicated sound card needed?<br />Do I need a dedicated sound card or can the host and guest share the onboard sound card?</p><p>#5: Requirements for CPU and mother board?<br />Is it (more or less) sufficient to select a CPU with Intel VT-d or AMD-Vi, and a matching mother board (supporting the CPU and Intel VT-d / AMD-Vi)?</p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1387216">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div class="postlinksb"> <div class="inbox crumbsplus"> <div class="pagepost"> <p class="pagelink conl"><span class="pages-label">Pages: </span><a rel="prev" class="item1" href="viewtopic.php?id=162768&amp;p=49">Previous</a> <a href="viewtopic.php?id=162768">1</a> <span class="spacer">…</span> <a href="viewtopic.php?id=162768&amp;p=48">48</a> <a href="viewtopic.php?id=162768&amp;p=49">49</a> <strong>50</strong> <a href="viewtopic.php?id=162768&amp;p=51">51</a> <a href="viewtopic.php?id=162768&amp;p=52">52</a> <span class="spacer">…</span> <a href="viewtopic.php?id=162768&amp;p=234">234</a> <a rel="next" href="viewtopic.php?id=162768&amp;p=51">Next</a></p> <p class="postlink conr">Topic closed</p> </div> <ul class="crumbs"> <li><a href="index.php">Index</a></li> <li><span>»&#160;</span><a href="viewforum.php?id=48">Topics Going Nowhere</a></li> <li><span>»&#160;</span><strong><a href="viewtopic.php?id=162768">KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</a></strong></li> </ul> <p class="subscribelink clearb"><a href="misc.php?action=subscribe&amp;tid=162768">Subscribe to this topic</a></p> <div class="clearer"></div> </div> </div> </div> <div id="brdfooter" class="block"> <h2><span>Board footer</span></h2> <div class="box"> <div id="brdfooternav" class="inbox"> <div class="conl"> <form id="qjump" method="get" action="viewforum.php"> <div><label><span>Jump to<br /></span> <select name="id" onchange="window.location=('viewforum.php?id='+this.options[this.selectedIndex].value)"> <optgroup label="Technical Issues and Assistance"> <option value="23">Newbie Corner</option> <option value="17">Installation</option> <option value="22">Kernel &amp; Hardware</option> <option value="18">Applications &amp; Desktop Environments</option> <option value="31">Laptop Issues</option> <option value="8">Networking, Server, and Protection</option> <option value="32">Multimedia and Games</option> <option value="50">System Administration</option> <option value="35">Other Architectures</option> </optgroup> <optgroup label="Arch-centric"> <option value="24">Announcements, Package &amp; Security Advisories</option> <option value="1">Arch Discussion</option> <option value="13">Forum &amp; Wiki discussion</option> </optgroup> <optgroup label="Pacman Upgrades, Packaging &amp; AUR"> <option value="44">Pacman &amp; Package Upgrade Issues</option> <option value="49">[testing] Repo Forum</option> <option value="4">Creating &amp; Modifying Packages</option> <option value="38">AUR Issues, Discussion &amp; PKGBUILD Requests</option> </optgroup> <optgroup label="Contributions &amp; Discussion"> <option value="20">GNU/Linux Discussion</option> <option value="27">Community Contributions</option> <option value="33">Programming &amp; Scripting</option> <option value="30">Other Languages</option> <option value="47">Artwork and Screenshots</option> <option value="42">Try This</option> </optgroup> <optgroup label="/dev/null"> <option value="29">Off-Topic</option> <option value="48" selected="selected">Topics Going Nowhere</option> <option value="36">Dustbin</option> </optgroup> </select></label> <input type="submit" value=" Go " accesskey="g" /> </div> </form> </div> <div class="conr"> <p id="feedlinks"><span class="atom"><a href="extern.php?action=feed&amp;tid=162768&amp;type=atom">Atom topic feed</a></span></p> <p id="poweredby">Powered by <a href="http://fluxbb.org/">FluxBB</a></p> </div> <div class="clearer"></div> </div> </div> </div> </div> <div class="end-box"></div> </div> </body> </html>
