<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"> <html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en" dir="ltr"> <head> <meta http-equiv="Content-Type" content="text/html; charset=utf-8" /> <title>KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9 (Page 178) / Topics Going Nowhere / Arch Linux Forums</title> <link rel="stylesheet" type="text/css" href="style/ArchLinux.css" /> <link rel="canonical" href="viewtopic.php?id=162768&amp;p=178" title="Page 178" /> <link rel="prev" href="viewtopic.php?id=162768&amp;p=177" title="Page 177" /> <link rel="next" href="viewtopic.php?id=162768&amp;p=179" title="Page 179" /> <link rel="alternate" type="application/atom+xml" href="extern.php?action=feed&amp;tid=162768&amp;type=atom" title="Atom topic feed" /> <link rel="stylesheet" media="screen" href="style/ArchLinux/arch.css?v=3" /> <link rel="stylesheet" media="screen" href="style/ArchLinux/archnavbar.css?v=2" /> <link rel="shortcut icon" href="style/ArchLinux/favicon.ico" /> </head> <body> <div id="archnavbar" class="anb-forum"> <div id="archnavbarlogo"><h1><a href="http://www.archlinux.org/">Arch Linux</a></h1></div> <div id="archnavbarmenu"> <ul id="archnavbarlist"> <li id="anb-home"><a href="http://www.archlinux.org/">Home</a></li><li id="anb-packages"><a href="http://www.archlinux.org/packages/">Packages</a></li><li id="anb-forums" class="anb-selected"><a href="https://bbs.archlinux.org/">Forums</a></li><li id="anb-wiki"><a href="https://wiki.archlinux.org/">Wiki</a></li><li id="anb-bugs"><a href="https://bugs.archlinux.org/">Bugs</a></li><li id="anb-aur"><a href="https://aur.archlinux.org/">AUR</a></li><li id="anb-download"><a href="http://www.archlinux.org/download/">Download</a></li> </ul> </div> </div> <div id="punviewtopic" class="pun"> <div class="top-box"></div> <div class="punwrap"> <div id="brdheader" class="block"> <div class="box"> <div id="brdmenu" class="inbox"> <ul> <li id="navindex" class="isactive"><a href="index.php">Index</a></li> <li id="navuserlist"><a href="userlist.php">User list</a></li> <li id="navsearch"><a href="search.php">Search</a></li> <li id="navprofile"><a href="profile.php?id=80749">Profile</a></li> <li id="navlogout"><a href="login.php?action=out&amp;id=80749&amp;csrf_token=5c20501ec397bb45ef8ee8c84db232c8d8e421c6">Logout</a></li> </ul> </div> <div id="brdwelcome" class="inbox"> <ul class="conl"> <li><span>Logged in as <strong>SXX</strong></span></li> <li><span>Last visit: 2015-08-16 12:20:09</span></li> </ul> <ul class="conr"> <li><span>Topics: <a href="search.php?action=show_replies" title="Find topics you have posted to.">Posted</a> | <a href="search.php?action=show_new" title="Find topics with new posts since your last visit.">New</a> | <a href="search.php?action=show_recent" title="Find topics with recent posts.">Active</a> | <a href="search.php?action=show_unanswered" title="Find topics with no replies.">Unanswered</a></span></li> </ul> <div class="clearer"></div> </div> </div> </div> <div id="brdmain"> <div class="linkst"> <div class="inbox crumbsplus"> <ul class="crumbs"> <li><a href="index.php">Index</a></li> <li><span>»&#160;</span><a href="viewforum.php?id=48">Topics Going Nowhere</a></li> <li><span>»&#160;</span><strong><a href="viewtopic.php?id=162768">KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</a></strong></li> </ul> <div class="pagepost"> <p class="pagelink conl"><span class="pages-label">Pages: </span><a rel="prev" class="item1" href="viewtopic.php?id=162768&amp;p=177">Previous</a> <a href="viewtopic.php?id=162768">1</a> <span class="spacer">…</span> <a href="viewtopic.php?id=162768&amp;p=176">176</a> <a href="viewtopic.php?id=162768&amp;p=177">177</a> <strong>178</strong> <a href="viewtopic.php?id=162768&amp;p=179">179</a> <a href="viewtopic.php?id=162768&amp;p=180">180</a> <span class="spacer">…</span> <a href="viewtopic.php?id=162768&amp;p=234">234</a> <a rel="next" href="viewtopic.php?id=162768&amp;p=179">Next</a></p> <p class="postlink conr">Topic closed</p> </div> <div class="clearer"></div> </div> </div> <div id="p1509349" class="blockpost rowodd blockpost1"> <h2><span><span class="conr">#4426</span> <a href="viewtopic.php?pid=1509349#p1509349">2015-03-08 02:40:33</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=89222">stl</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2015-03-02</span></dd> <dd><span>Posts: 1</span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <p>Thanks for the great guide here.&#160; I&#039;ve been trying to set this up lately and have had some success.</p><p>Hardware:<br />Asus Z97-A motherboard<br />Intel Core i7-4790K cpu<br />AMD Radeon HD 7850</p><p>Host system:<br />Arch Linux x86_64<br />default kernel and qemu, unpatched</p><p>Windows 7 test, with default BIOS:<br />Command line: QEMU_AUDIO_DRV=alsa QEMU_ALSA_DAC_SIZE_IN_USEC=100 QEMU_ALSA_DAC_DEV=dac qemu-system-x86_64 -m 4G -enable-kvm -machine type=pc,accel=kvm -cpu host -smp cores=4,threads=2 -drive file=w7.img,media=disk,cache=none,format=raw,discard=unmap,detect-zeroes=unmap,if=virtio -vga none -nographic -net nic,model=virtio -net user -soundhw hda -vga none -nographic -device vfio-pci,host=01:00.0,x-vga=on -usb -device usb-host,hostbus=3,hostport=13 -device usb-host,hostbus=3,hostport=14 -monitor telnet::4444,server,nowait<br />Results:&#160; Mostly flawless.&#160; GPU is recognized fully by its drivers, games run well.&#160; 3Dmark crashes but I&#039;m not concerned about that really.&#160; The only issue is an occasional crackle/skip in the audio.&#160; It doesn&#039;t happen frequently enough to really bother me, but I&#039;d still like to get rid of it if possible.</p><p>Windows 8 test, with OVMF (using <a href="https://aur.archlinux.org/packages/ovmf-bin/" rel="nofollow">https://aur.archlinux.org/packages/ovmf-bin/</a> ):<br />Command line: QEMU_AUDIO_DRV=alsa QEMU_ALSA_DAC_SIZE_IN_USEC=100 QEMU_ALSA_DAC_DEV=dac qemu-system-x86_64 -m 4G -enable-kvm -machine type=pc,accel=kvm -cpu host -smp cores=4,threads=2 -drive file=w8.img,media=disk,cache=none,format=raw,discard=unmap,detect-zeroes=unmap,if=virtio -vga none -nographic -net nic,model=virtio -net user -soundhw hda -vga none -nographic -device vfio-pci,host=01:00.0,x-vga=on -usb -device usb-host,hostbus=3,hostport=13 -device usb-host,hostbus=3,hostport=14 -monitor telnet::4444,server,nowait<br />Results: No video from the AMD GPU when using gpu passthrough with vfio.&#160; Just a black screen.&#160; No errors from QEMU or in dmesg.&#160; VM boots fine without gpu passthrough, with -vga std.&#160; Leaving out x-vga=on didn&#039;t change anything.</p><p>Audio:<br />I get an occasional crackle/skip in the audio.&#160; It isn&#039;t a huge bother.&#160; But what I&#039;d really like to do is to avoid going through alsa and instead pass my USB DAC to the VM using USB passthrough.&#160; That doesn&#039;t seem to work though.&#160; QEMU gives me this:</p><div class="codebox"><pre><code>qemu-system-x86_64: libusb_claim_interface: -5 [NOT_FOUND] qemu-system-x86_64: libusb_set_configuration: -6 [BUSY] qemu-system-x86_64: libusb_set_configuration: -6 [BUSY] qemu-system-x86_64: libusb_set_configuration: -6 [BUSY]</code></pre></div><p>And in dmesg I get lots of this:</p><div class="codebox"><pre><code>[ +0.201511] usb 3-4: reset full-speed USB device number 2 using xhci_hcd [ +0.211482] xhci_hcd 0000:00:14.0: xHCI xhci_drop_endpoint called with disabled ep ffff8804396d53c0 [ +0.169216] usb 3-4: usbfs: interface 0 claimed by usbfs while &#039;qemu-system-x86&#039; sets config #1 [ +0.158978] usb 3-4: reset full-speed USB device number 2 using xhci_hcd [ +0.211597] xhci_hcd 0000:00:14.0: xHCI xhci_drop_endpoint called with disabled ep ffff8804396d53c0 [ +0.194835] usb 3-4: reset full-speed USB device number 2 using xhci_hcd [ +0.211542] xhci_hcd 0000:00:14.0: xHCI xhci_drop_endpoint called with disabled ep ffff8804396d53c0</code></pre></div><p>Any ideas on this?&#160; The DAC shouldn&#039;t be in use from anything after I&#039;ve removed the snd-usb-audio module.&#160; Inside the VM, I get &quot;This device cannot start (Code 10).&quot;</p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1509349">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1509421" class="blockpost roweven"> <h2><span><span class="conr">#4427</span> <a href="viewtopic.php?pid=1509421#p1509421">2015-03-08 11:20:25</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=89375">gmk</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2015-03-08</span></dd> <dd><span>Posts: 2</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=89375">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <p>after avoiding archlinux and testing with debian, ubuntu and proxmox, out of a fear of having to do too much fine tuning to make things work, I was pleasantly surprised. In the other mentioned distributions I couldn&#039;t get passthrough to work or ran into issues when it worked.</p><p>@nbhs thank you for the guide, with the kernel you provide and the settings you suggest everything works more or less &quot;out of the box&quot;<br />I am not savvy on using a custom kernel though, how likely is it that updating the host will break the setup?</p><br /><p>I have tested two windows 7 VMs (one for each graphics card). Both work fine, benchmark results are great, not far off from the ones I got with vmware esxi 5.5<br />my hardware:<br />i7-4790k <br />Asrock z97 Pro4<br />Radeon R9 280, msi twin frozr<br />Radeon 4850, asus</p><p>The only issue: as soon as hdtune (in windows) is started, the vm locks up and the host reports a segfault. Can anyone point me in the direction where to best report this behaviour/bug or even how to fix it?</p> <p class="postedit"><em>Last edited by gmk (2015-03-08 11:21:25)</em></p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1509421">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1509425" class="blockpost rowodd"> <h2><span><span class="conr">#4428</span> <a href="viewtopic.php?pid=1509425#p1509425">2015-03-08 11:41:04</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=70922">nbhs</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd class="postavatar"><img src="https://bbs.archlinux.org/img/avatars/70922.jpg?m=1367773811" width="80" height="80" alt="" /></dd> <dd><span>From: Montevideo, Uruguay</span></dd> <dd><span>Registered: 2013-05-02</span></dd> <dd><span>Posts: 402</span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>gmk wrote:</cite><blockquote><div><p>after avoiding archlinux and testing with debian, ubuntu and proxmox, out of a fear of having to do too much fine tuning to make things work, I was pleasantly surprised. In the other mentioned distributions I couldn&#039;t get passthrough to work or ran into issues when it worked.</p><p>@nbhs thank you for the guide, with the kernel you provide and the settings you suggest everything works more or less &quot;out of the box&quot;<br />I am not savvy on using a custom kernel though, how likely is it that updating the host will break the setup?</p><br /><p>I have tested two windows 7 VMs (one for each graphics card). Both work fine, benchmark results are great, not far off from the ones I got with vmware esxi 5.5<br />my hardware:<br />i7-4790k <br />Asrock z97 Pro4<br />Radeon R9 280, msi twin frozr<br />Radeon 4850, asus</p></div></blockquote></div><br /><p>You can have as many kernels installed on arch as you want, upgrading is not an issue, it wont break anything</p><div class="quotebox"><cite>gmk wrote:</cite><blockquote><div><p>The only issue: as soon as hdtune (in windows) is started, the vm locks up and the host reports a segfault. Can anyone point me in the direction where to best report this behaviour/bug or even how to fix it?</p></div></blockquote></div><p>Post your logs, i assume you&#039;ve done this already </p><div class="codebox"><pre><code>echo &quot;options kvm ignore_msrs=1&quot; &gt;&gt; /etc/modprobe.d/kvm.conf</code></pre></div> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1509425">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1509497" class="blockpost roweven"> <h2><span><span class="conr">#4429</span> <a href="viewtopic.php?pid=1509497#p1509497">2015-03-08 16:53:06</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=84760">Denso</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd class="postavatar"><img src="https://bbs.archlinux.org/img/avatars/84760.png?m=1412533733" width="71" height="80" alt="" /></dd> <dd><span>Registered: 2014-08-30</span></dd> <dd><span>Posts: 179</span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>hurenkam wrote:</cite><blockquote><div><p>Passing a secondary device (from host perspective) is indeed easier.<br />However, after some fiddling, i managed to passthrough the primary card on my system, but it does involve some extra work.<br />Apart from the usual driver blacklisting (radeon in my case) i had to do the following as well:<br />- Switch grub to text-only mode by adding &quot;GRUB_GFXPAYLOAD_LINUX=text&quot; to /etc/defaults/grub<br />- Switch linux boot to text-only mode by adding &quot;nomodeset nofb&quot; to GRUB_CMDLINE_LINUX_DEFAULT=... in /etc/defaults/grub</p><p>After adding these parameters, I was able to passthrough the host primary graphics to qemu guest in the same way as i passthrough my secondary graphics.</p><p>Note that you will completely lose your host console when you do this, so make sure you can ssh in, and perhaps have a serial terminal ready as well.</p></div></blockquote></div><p>Hi . I am also interested at running a headless server .</p><p>I tried your method but the whole machine hangs as soon as I start the VM that uses the host&#039;s primary GPU .</p><p>I blacklisted nouveau and added &quot;nomodeset nofb&quot; to my kernel options . Still no go <img src="https://bbs.archlinux.org/img/smilies/sad.png" width="15" height="15" alt="sad" /></p><p>I&#039;m using UEFI host with Gummiboot boot manager if that would matter .</p><p>EDIT : Setting <strong>rombar=0</strong> solves the hanging issue !!! The VM boots fine and I can even use VNC to access it m but no HDMI output . </p><p>I must obtain a ROM file and test ASAP <img src="https://bbs.archlinux.org/img/smilies/smile.png" width="15" height="15" alt="smile" /></p><p>EDIT2 : Still no luck :</p><div class="codebox"><pre><code>vfio-pci 0000:01:00.0: BAR 3: can&#039;t reserve [mem 0xd8000000-0xd9ffffff 64bit pref]</code></pre></div> <p class="postedit"><em>Last edited by Denso (2015-03-08 17:35:26)</em></p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1509497">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1509513" class="blockpost rowodd"> <h2><span><span class="conr">#4430</span> <a href="viewtopic.php?pid=1509513#p1509513">2015-03-08 17:41:40</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=70922">nbhs</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd class="postavatar"><img src="https://bbs.archlinux.org/img/avatars/70922.jpg?m=1367773811" width="80" height="80" alt="" /></dd> <dd><span>From: Montevideo, Uruguay</span></dd> <dd><span>Registered: 2013-05-02</span></dd> <dd><span>Posts: 402</span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>Denso wrote:</cite><blockquote><div><div class="quotebox"><cite>hurenkam wrote:</cite><blockquote><div><p>Passing a secondary device (from host perspective) is indeed easier.<br />However, after some fiddling, i managed to passthrough the primary card on my system, but it does involve some extra work.<br />Apart from the usual driver blacklisting (radeon in my case) i had to do the following as well:<br />- Switch grub to text-only mode by adding &quot;GRUB_GFXPAYLOAD_LINUX=text&quot; to /etc/defaults/grub<br />- Switch linux boot to text-only mode by adding &quot;nomodeset nofb&quot; to GRUB_CMDLINE_LINUX_DEFAULT=... in /etc/defaults/grub</p><p>After adding these parameters, I was able to passthrough the host primary graphics to qemu guest in the same way as i passthrough my secondary graphics.</p><p>Note that you will completely lose your host console when you do this, so make sure you can ssh in, and perhaps have a serial terminal ready as well.</p></div></blockquote></div><p>Hi . I am also interested at running a headless server .</p><p>I tried your method but the whole machine hangs as soon as I start the VM that uses the host&#039;s primary GPU .</p><p>I blacklisted nouveau and added &quot;nomodeset nofb&quot; to my kernel options . Still no go <img src="https://bbs.archlinux.org/img/smilies/sad.png" width="15" height="15" alt="sad" /></p><p>I&#039;m using UEFI host with Gummiboot boot manager if that would matter .</p><p>EDIT : Setting <strong>rombar=0</strong> solves the hanging issue !!! The VM boots fine and I can even use VNC to access it m but no HDMI output . </p><p>I must obtain a ROM file and test ASAP <img src="https://bbs.archlinux.org/img/smilies/smile.png" width="15" height="15" alt="smile" /></p><p>EDIT2 : Still no luck :</p><div class="codebox"><pre><code>vfio-pci 0000:01:00.0: BAR 3: can&#039;t reserve [mem 0xd8000000-0xd9ffffff 64bit pref]</code></pre></div></div></blockquote></div><p>Boot with video=efifb:off, i think i explained somewhere in the previous 100 pages or so how i did it.</p><p>Edit: here <a href="https://bbs.archlinux.org/viewtopic.php?pid=1427202#p1427202" rel="nofollow">https://bbs.archlinux.org/viewtopic.php … 2#p1427202</a></p> <p class="postedit"><em>Last edited by nbhs (2015-03-08 17:44:06)</em></p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1509513">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1509521" class="blockpost roweven"> <h2><span><span class="conr">#4431</span> <a href="viewtopic.php?pid=1509521#p1509521">2015-03-08 18:13:15</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=75590">aw</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2013-10-04</span></dd> <dd><span>Posts: 921</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=75590">Email</a></span> <span class="website"><a href="http://vfio.blogspot.com/" rel="nofollow">Website</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>blu3bird wrote:</cite><blockquote><div><div class="quotebox"><cite>aw wrote:</cite><blockquote><div><p>Specifying a CPU topology with threads is generally only recommended in combination with pinning.&#160; Using 100% of the host CPU resources for a guest is also likely to cause glitches when the host needs some CPU resources.&#160; There&#039;s plenty of information online for vCPU pinning.&#160; libvirt can do this for you and is detailed on their site.</p></div></blockquote></div><p>Could you elaborate on that? I always assumed the point of cpu pinning was to reserve/restrict cpu usage, regardless of topology. For example to preventing a test vm from stealing resources from a production vm.</p><p>The reason I&#039;m asking is that I&#039;m also using threads without pinning. When I first tried kvm with vfio I did some benchmarks(cinebench) and threads=8,cores=1,sockets=1 gave me the best results for a quad-core cpu with ht.</p></div></blockquote></div><p>It&#039;s a complicated issue, probably worthy of research papers, but the thing to keep in mind is that physically, threads on the same core share execution units.&#160; A process that can run at 100% on an otherwise idle core may only run at 75% performance if the other thread of that core is under load.&#160; We can theoretically run two instances of that process simultaneously on a single core with hyperthreading, but our aggregate throughput would be only 150% whereas running those two instances on separate cores would result in 200% throughput.&#160; This is where we rely on the scheduler knowing the difference between threads on the same core and separate cores.</p><p>Moving that to a virtual machine, the host doesn&#039;t implicitly know how any given vCPU is exposed in the guest, they&#039;re all equal processes for host scheduling.&#160; By exposing threads to the guest without pinning, the guest is making scheduling decisions that don&#039;t necessarily make sense.&#160; Maybe these work out, maybe they don&#039;t.</p><p>If we pin vCPUs in the host and expose the topology in the guest, then the topology we expose to the guest actually holds true to the vCPU processes on the host.&#160; The guest also has more visibility than the host to running process threads from the same application on vCPU threads and cores that share cache.&#160; The host can&#039;t know that vCPUs are running related code and therefore may make poor decisions when migrating a vCPU task to another core or thread.</p><p>In your case, you&#039;ve told the guest that it has a single core with 8 threads, which I suspect the guest scheduler would handle the same as a single 8-core processor or the same as 8 single-core processors.&#160; IOW, it doesn&#039;t really matter that they&#039;re threads vs cores vs sockets because they&#039;re all equal.&#160; In your case, maybe it is worthwhile to ignore the locality of threads to cores since the guest can&#039;t make any useful scheduling decisions between cores with un-pinned vCPUs anyway.&#160; Exposing 8-cores or 8-sockets to the guest also implies to the guest that each execution unit is independent of others, which is not actually true of the physical hardware.&#160; The 8-core or 8-socket model would effectively be over-committing the host resources whereas 8-threads seems closer to accurate.&#160; Maybe you&#039;re on to something, but I&#039;d still expect pinning with an accurate physical topology exposed to the guest to provide a slight advantage.</p> </div> <div class="postsignature postmsg"><hr /><p><a href="http://vfio.blogspot.com" rel="nofollow">http://vfio.blogspot.com</a><br />Looking for a more open forum to discuss vfio related uses?&#160; Try <a href="https://www.redhat.com/mailman/listinfo/vfio-users" rel="nofollow">https://www.redhat.com/mailman/listinfo/vfio-users</a></p></div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1509521">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1509530" class="blockpost rowodd"> <h2><span><span class="conr">#4432</span> <a href="viewtopic.php?pid=1509530#p1509530">2015-03-08 18:37:46</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=89375">gmk</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2015-03-08</span></dd> <dd><span>Posts: 2</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=89375">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>nbhs wrote:</cite><blockquote><div><div class="quotebox"><cite>gmk wrote:</cite><blockquote><div><p>The only issue: as soon as hdtune (in windows) is started, the vm locks up and the host reports a segfault. Can anyone point me in the direction where to best report this behaviour/bug or even how to fix it?</p></div></blockquote></div><p>Post your logs, i assume you&#039;ve done this already </p><div class="codebox"><pre><code>echo &quot;options kvm ignore_msrs=1&quot; &gt;&gt; /etc/modprobe.d/kvm.conf</code></pre></div></div></blockquote></div><p>yes, &quot;ignore_msrs=1&quot; is in use as it was required for passmark to work, otherwise it would cause a bsod (but no segfault/crash of qemu)</p><br /><p>the relevant logs I found:</p><div class="codebox"><pre><code>Mar 08 20:07:57 archy kernel: qemu-system-x86[9157]: segfault at 7ffffcb17000 ip 00007f8643f8c5be sp 00007ffffcb15c88 error 6 in libc-2.21.so[7f8643e65000+199000] Mar 08 20:08:05 archy systemd-coredump[9190]: Coredump of 9157 (qemu-system-x86) is larger than configured processing limit, refusing. Mar 08 20:08:05 archy systemd-coredump[9190]: Process 9157 (qemu-system-x86) of user 0 dumped core.</code></pre></div><p>the vm is using a raw-imagefile that resides on an ext4 partition (dd&#039;ing that image to a lvm-partition yielded the same result)</p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1509530">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1509563" class="blockpost roweven"> <h2><span><span class="conr">#4433</span> <a href="viewtopic.php?pid=1509563#p1509563">2015-03-08 20:27:46</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=84760">Denso</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd class="postavatar"><img src="https://bbs.archlinux.org/img/avatars/84760.png?m=1412533733" width="71" height="80" alt="" /></dd> <dd><span>Registered: 2014-08-30</span></dd> <dd><span>Posts: 179</span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>nbhs wrote:</cite><blockquote><div><p>Boot with video=efifb:off, i think i explained somewhere in the previous 100 pages or so how i did it.</p><p>Edit: here <a href="https://bbs.archlinux.org/viewtopic.php?pid=1427202#p1427202" rel="nofollow">https://bbs.archlinux.org/viewtopic.php … 2#p1427202</a></p></div></blockquote></div><p>Hi . Thanks for sharing this !</p><p>Indeed &quot;video=efifb:off&quot; solves the hanging issue without editing the VM script , but now I&#039;m faced with with :</p><div class="codebox"><pre><code>vfio-pci 0000:01:00.0: Invalid ROM contents vfio-pci 0000:01:00.0: Invalid ROM contents</code></pre></div><p>I used a ROM file dumped from GPU-Z as well as a downloaded one from TPU but without any luck .</p><p>Trying to dump the ROM from host while GPU isn&#039;t initialized produces 0 byte file .</p><p>EDIT :&#160; This is a GTX 770 by the way .</p> <p class="postedit"><em>Last edited by Denso (2015-03-08 20:28:24)</em></p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1509563">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1509567" class="blockpost rowodd"> <h2><span><span class="conr">#4434</span> <a href="viewtopic.php?pid=1509567#p1509567">2015-03-08 20:36:10</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=70922">nbhs</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd class="postavatar"><img src="https://bbs.archlinux.org/img/avatars/70922.jpg?m=1367773811" width="80" height="80" alt="" /></dd> <dd><span>From: Montevideo, Uruguay</span></dd> <dd><span>Registered: 2013-05-02</span></dd> <dd><span>Posts: 402</span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>Denso wrote:</cite><blockquote><div><div class="quotebox"><cite>nbhs wrote:</cite><blockquote><div><p>Boot with video=efifb:off, i think i explained somewhere in the previous 100 pages or so how i did it.</p><p>Edit: here <a href="https://bbs.archlinux.org/viewtopic.php?pid=1427202#p1427202" rel="nofollow">https://bbs.archlinux.org/viewtopic.php … 2#p1427202</a></p></div></blockquote></div><p>Hi . Thanks for sharing this !</p><p>Indeed &quot;video=efifb:off&quot; solves the hanging issue without editing the VM script , but now I&#039;m faced with with :</p><div class="codebox"><pre><code>vfio-pci 0000:01:00.0: Invalid ROM contents vfio-pci 0000:01:00.0: Invalid ROM contents</code></pre></div><p>I used a ROM file dumped from GPU-Z as well as a downloaded one from TPU but without any luck .</p><p>Trying to dump the ROM from host while GPU isn&#039;t initialized produces 0 byte file .</p><p>EDIT :&#160; This is a GTX 770 by the way .</p></div></blockquote></div><p>I had this problem before with my 470gtx, reboot your pc, start your vm, the first vm boot should start ok, dump your rom with gpu-z, transfer it to your host, then add romfile=... to your script</p> <p class="postedit"><em>Last edited by nbhs (2015-03-08 20:38:54)</em></p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1509567">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1509574" class="blockpost roweven"> <h2><span><span class="conr">#4435</span> <a href="viewtopic.php?pid=1509574#p1509574">2015-03-08 21:01:26</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=84760">Denso</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd class="postavatar"><img src="https://bbs.archlinux.org/img/avatars/84760.png?m=1412533733" width="71" height="80" alt="" /></dd> <dd><span>Registered: 2014-08-30</span></dd> <dd><span>Posts: 179</span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><blockquote><div><p>I had this problem before with my 470gtx, reboot your pc, start your vm, the first vm boot should start ok, dump your rom with gpu-z, transfer it to your host, then add romfile=... to your script</p></div></blockquote></div><p>GPU-Z won&#039;t produce a full &quot;pre-POST&quot; ROM . the only way to do so is to install the card as a secondary card on host , then dump the image from there . </p><p>Please feel free to correct me if I&#039;m wrong .</p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1509574">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1509601" class="blockpost rowodd"> <h2><span><span class="conr">#4436</span> <a href="viewtopic.php?pid=1509601#p1509601">2015-03-08 22:13:59</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=57655">n0rv</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2012-02-27</span></dd> <dd><span>Posts: 38</span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <p>Hi.<br />Anyone can confirm that ASRock Z97 Extreme3 motherboard supports vt-d?</p><p>I know that Pro4 supports it (and Extreme4 / 6 probably too), but I would like to buy Extreme3 because of better layout.</p> <p class="postedit"><em>Last edited by n0rv (2015-03-08 22:14:29)</em></p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1509601">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1509652" class="blockpost roweven"> <h2><span><span class="conr">#4437</span> <a href="viewtopic.php?pid=1509652#p1509652">2015-03-09 02:44:16</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=87584">pkim</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2014-12-27</span></dd> <dd><span>Posts: 9</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=87584">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>n0rv wrote:</cite><blockquote><div><p>Hi.<br />Anyone can confirm that ASRock Z97 Extreme3 motherboard supports vt-d?</p><p>I know that Pro4 supports it (and Extreme4 / 6 probably too), but I would like to buy Extreme3 because of better layout.</p></div></blockquote></div><p>A user named noctavian put a comprehensive list of success/failure cases here -</p><p><a href="https://docs.google.com/spreadsheet/ccc?key=0Aryg5nO-kBebdFozaW9tUWdVd2VHM0lvck95TUlpMlE&amp;usp=drive_web#gid=0" rel="nofollow">https://docs.google.com/spreadsheet/ccc … _web#gid=0</a></p><p>Check for your motherboard and GPU on that list.</p><p>- Peter</p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1509652">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1509653" class="blockpost rowodd"> <h2><span><span class="conr">#4438</span> <a href="viewtopic.php?pid=1509653#p1509653">2015-03-09 02:50:14</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=87584">pkim</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2014-12-27</span></dd> <dd><span>Posts: 9</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=87584">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><blockquote><div><p>Audio:<br />I get an occasional crackle/skip in the audio.&#160; It isn&#039;t a huge bother.&#160; But what I&#039;d really like to do is to avoid going through alsa and instead pass my USB DAC to the VM using USB passthrough.</p></div></blockquote></div><p>I used to think that I need to get a dedicated sound because of a stutter issue with ICH6 and ICH9 - it turns out many people are having issues with the ICH6/9 emulation - something to do with small buffer size. I switched over to AC97 and it works fine. In Win7, I had to install the Realtek AC97 driver. Win8.1 barfs at the Realtek AC97 driver because it is unsigned, but you can disable that protection and it will install fine. Once I switched to AC97, sound works flawlessly.</p><p>- Peter</p> <p class="postedit"><em>Last edited by pkim (2015-03-09 04:37:10)</em></p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1509653">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1509656" class="blockpost roweven"> <h2><span><span class="conr">#4439</span> <a href="viewtopic.php?pid=1509656#p1509656">2015-03-09 02:59:03</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=87584">pkim</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2014-12-27</span></dd> <dd><span>Posts: 9</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=87584">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>giantegg wrote:</cite><blockquote><div><p>hmmh thanks. I thought it supported it since it was in the bios options</p><p>EDIT: can someone please tell me why the 3570 supports vt-d but the 3570k doesnt ? How does this make any sense ?</p></div></blockquote></div><p>There is really no good reason other than that Intel is trying to be strategic. They think the Vt-d is a &quot;corporate feature&quot; along with vpro, etc. And since the &quot;K&quot; processors are targeted at the over-clock happy gamers, the VM features don&#039;t go together with those &quot;gamer&quot; processors - so the logic goes. I kind of got lucky - I really wanted the VM features, but the non-K processors were much lower on the bang-per-buck ratio. I bought a i7-3790K anyway (not knowing how good/bad the VM support woudl be), but it turns out Vt-d is one of the VM features that it supports - for the first time for a K processor. I don&#039;t know why Intel decided to start including Vt-d on the K processor. Maybe they thought VM features are starting to become more mainstream? I really don&#039;t know why Vt-d is part of the new K-type processor feature set but I&#039;m happy with my 3790K.</p><p>- Peter</p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1509656">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1509672" class="blockpost rowodd"> <h2><span><span class="conr">#4440</span> <a href="viewtopic.php?pid=1509672#p1509672">2015-03-09 04:35:36</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=87584">pkim</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2014-12-27</span></dd> <dd><span>Posts: 9</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=87584">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>hotfunction wrote:</cite><blockquote><div><p>EDIT 3 : i finally tried using -vga none and -nographics menu, now the black qemu monitor shows up, then when i plug in my monitor to my secondary GPU ( the passthrough GPU ), finally i am able to see my VM using -vga none.. but this vm installs windows 8 with any installed NVIDIA drivers yet,&#160; and also, this only works on the first boot of the VM, lets say i kill the VM and i change the script, then i start my VM again, the output won&#039;t show up again in the passthrough&#039;d monitor, the only way to make it show up again is by rebooting the host.. and after it reboots i can only boot the VM again once... if i boot the VM twice, starting from that time it won&#039;t show the output again unless i reboot one more time..</p><p>any help on this please !! i think im almost there..</p></div></blockquote></div><p>I had the same exact problem with my 560Ti card - it would work in the guest once but after shutting down the guest, it wouldn&#039;t work again - probably a failure to cleanly reset the hardware. Also I couldn&#039;t get it to work on Win8.1 with UEFI, the firmware wasn&#039;t compatible with UEFI. I ended up throwing a GTX 970 at the guest - and it solved both problems: win8.1 UEFI compatibility and also I can shutdown and restart the guest an infinite number of times. I sold the 560Ti card and some old computer hardware on ebay and bought a GTX 960 for the host so I now have a very nice setup - with the Vt-d processor and IOMMU motherboard, I really have two machines in one. And the new GTX 960 is also more power efficient than the 560Ti (about 20W - I estimate about $36 per year in energy savings) - so more money savings there - just a quick note to those of you who is overclocking your CPU thinking you are saving money on the CPU price and getting more computation power, think again: the power ramp up is exponential with the clock frequency/supply power and the money you saved on the CPU will be quickly eaten up by the electricity bill.</p><p>If you&#039;re sticking with your 560Ti card, please know that I was able to get mine to reset with the host pm-suspend - still a bit inconvenient, but beats rebooting.</p><p>- Peter</p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1509672">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1509791" class="blockpost roweven"> <h2><span><span class="conr">#4441</span> <a href="viewtopic.php?pid=1509791#p1509791">2015-03-09 17:56:02</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=85314">Duelist</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2014-09-22</span></dd> <dd><span>Posts: 358</span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <p>Yikes.<br />So i&#039;ve had my windows 7 system installed on bare metal into a partition on my hard drive.<br />Then i&#039;ve made windows 8.1 virtual machine, and connected that partition to the virtual machine via virtio-blk-pci, just for data transferring needs.<br />That way, following cases are possible:<br />1. Linux host is offline since windows 7 is booted, accessing the partition.<br />2. Linux host is online, and the partition is mounted in host system for file transfers.<br />3. Linux host is online, partition is unmounted and VM boots, grabbing access to that partition. Linux host can not mount that partition, since mount is preventing me to shoot my leg.</p><p>Common sense hints me that EVERYTHING should be fine as long as no two systems use same partition concurrently.</p><p>But windows 8.1 defies common sense. Seems like it frigging starts defragging that darn partition if the user is idle(like, when i&#039;m doing something on the host). I&#039;ll omit the heavy i/o issues generated by that, but..<br />I&#039;ve shut down the guest via regular and fully legit way. I thought it would finish whatever it was doing with the disk and leave it free.</p><p><strong>NOPE</strong><br />I&#039;ve started my windows 7 system, and a wild CHKDSK message appears. Let it go, i thought, and... CHKDSK uses filesystem checking! It&#039;s not very effective.. 40 gigabytes of data is now corrupted. <br />YAY FOR WINDOWNS!</p><p>Interesting, if i&#039;ll have two PCs and connect a physical hard drive in a similar way(like, came to work, plugged in my hard drive into windows 8 system, shutted it down, came home, plugged the hard disk back into windows 7 machine), will it go nuts as well?</p><p>Morale:<br />You shouldn&#039;t let VM touch your dual boot partition, especially if it is windows 8 vm.</p> <p class="postedit"><em>Last edited by Duelist (2015-03-09 18:03:08)</em></p> </div> <div class="postsignature postmsg"><hr /><p><span class="bbs">The forum rules prohibit requesting support for distributions other than arch.</span><br /><a href="https://bbs.archlinux.org/viewtopic.php?pid=1551460#p1551460" rel="nofollow">I gave up.</a><a href="https://bbs.archlinux.org/viewtopic.php?id=162768" rel="nofollow"> It was too late.</a><br /><a href="http://pastebin.com/B3fL84bq" rel="nofollow">What I was trying to do</a>.<br /><a href="http://vfio.blogspot.com/" rel="nofollow">The reference about VFIO and KVM VGA passthrough.</a></p></div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1509791">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1509794" class="blockpost rowodd"> <h2><span><span class="conr">#4442</span> <a href="viewtopic.php?pid=1509794#p1509794">2015-03-09 18:01:06</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=85314">Duelist</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2014-09-22</span></dd> <dd><span>Posts: 358</span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>pkim wrote:</cite><blockquote><div><p>a quick note to those of you who is overclocking your CPU thinking you are saving money on the CPU price and getting more computation power, think again: the power ramp up is exponential with the clock frequency/supply power and the money you saved on the CPU will be quickly eaten up by the electricity bill.</p></div></blockquote></div><p>But what if my CPU was free when i got it? <img src="https://bbs.archlinux.org/img/smilies/wink.png" width="15" height="15" alt="wink" /><br />What if the electricity at my area costs less than 0.02$ per kw-h? <img src="https://bbs.archlinux.org/img/smilies/wink.png" width="15" height="15" alt="wink" /></p> </div> <div class="postsignature postmsg"><hr /><p><span class="bbs">The forum rules prohibit requesting support for distributions other than arch.</span><br /><a href="https://bbs.archlinux.org/viewtopic.php?pid=1551460#p1551460" rel="nofollow">I gave up.</a><a href="https://bbs.archlinux.org/viewtopic.php?id=162768" rel="nofollow"> It was too late.</a><br /><a href="http://pastebin.com/B3fL84bq" rel="nofollow">What I was trying to do</a>.<br /><a href="http://vfio.blogspot.com/" rel="nofollow">The reference about VFIO and KVM VGA passthrough.</a></p></div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1509794">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1509880" class="blockpost roweven"> <h2><span><span class="conr">#4443</span> <a href="viewtopic.php?pid=1509880#p1509880">2015-03-09 21:50:17</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=80387">dwe11er</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2014-03-18</span></dd> <dd><span>Posts: 73</span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>Denso wrote:</cite><blockquote><div><div class="quotebox"><blockquote><div><p>I had this problem before with my 470gtx, reboot your pc, start your vm, the first vm boot should start ok, dump your rom with gpu-z, transfer it to your host, then add romfile=... to your script</p></div></blockquote></div><p>GPU-Z won&#039;t produce a full &quot;pre-POST&quot; ROM . the only way to do so is to install the card as a secondary card on host , then dump the image from there . </p><p>Please feel free to correct me if I&#039;m wrong .</p></div></blockquote></div><p>Indeed, but it can still work anyway. At least worked for my NVIDIA cards.</p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1509880">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1509958" class="blockpost rowodd"> <h2><span><span class="conr">#4444</span> <a href="viewtopic.php?pid=1509958#p1509958">2015-03-10 05:26:15</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=88848">mutiny</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2015-02-15</span></dd> <dd><span>Posts: 13</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=88848">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <p>I am having the most bizarre problem with vfio and NIC device. My motherboard has 2 network interfaces, Intel e1000e as well as an Atheros AR8161, so I planned on passing the Atheros device to guest along with GPU. However, when the guest is not running, the Atheros NIC is held by pci-stub/vfio-pci driver, and brings my entire home network down when ethernet cable is plugged in. What could possibly be going on here? Anyone experience anything similar or have an idea what could be happening? Thanks!</p><p>Also, aw, on your vfio.blogspot.com FAQ, the use of vfio-pci.ids= is mentioned. Is this option no longer valid (it seems I could not get it to work the way pci-stub.ids= works)?</p> <p class="postedit"><em>Last edited by mutiny (2015-03-10 05:40:36)</em></p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1509958">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1509975" class="blockpost roweven"> <h2><span><span class="conr">#4445</span> <a href="viewtopic.php?pid=1509975#p1509975">2015-03-10 08:05:29</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=84760">Denso</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd class="postavatar"><img src="https://bbs.archlinux.org/img/avatars/84760.png?m=1412533733" width="71" height="80" alt="" /></dd> <dd><span>Registered: 2014-08-30</span></dd> <dd><span>Posts: 179</span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>dwe11er wrote:</cite><blockquote><div><p>Indeed, but it can still work anyway. At least worked for my NVIDIA cards.</p></div></blockquote></div><p>It doesn&#039;t work when trying to passthrough the host&#039;s primary GPU unfortunately : (</p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1509975">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1510011" class="blockpost rowodd"> <h2><span><span class="conr">#4446</span> <a href="viewtopic.php?pid=1510011#p1510011">2015-03-10 11:18:41</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=89334">efeu</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2015-03-06</span></dd> <dd><span>Posts: 4</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=89334">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>n0rv wrote:</cite><blockquote><div><p>Hi.<br />Anyone can confirm that ASRock Z97 Extreme3 motherboard supports vt-d?</p><p>I know that Pro4 supports it (and Extreme4 / 6 probably too), but I would like to buy Extreme3 because of better layout.</p></div></blockquote></div><p>I am running Ubuntu 14.10 as host on ASRock Z97 Extreme3 with an i7 4790K and Win8.1 as VM. The Intel HD as primary and a nVidia GTX970 as passthrough adapter.<br />Everything is running well out of the box with a fresh build of OVMF UEFI instead of sea bios. So I am able to use stock kernel without any patches.</p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1510011">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1510031" class="blockpost roweven"> <h2><span><span class="conr">#4447</span> <a href="viewtopic.php?pid=1510031#p1510031">2015-03-10 13:22:58</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=75590">aw</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2013-10-04</span></dd> <dd><span>Posts: 921</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=75590">Email</a></span> <span class="website"><a href="http://vfio.blogspot.com/" rel="nofollow">Website</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>mutiny wrote:</cite><blockquote><div><p>I am having the most bizarre problem with vfio and NIC device. My motherboard has 2 network interfaces, Intel e1000e as well as an Atheros AR8161, so I planned on passing the Atheros device to guest along with GPU. However, when the guest is not running, the Atheros NIC is held by pci-stub/vfio-pci driver, and brings my entire home network down when ethernet cable is plugged in. What could possibly be going on here? Anyone experience anything similar or have an idea what could be happening? Thanks!</p><p>Also, aw, on your vfio.blogspot.com FAQ, the use of vfio-pci.ids= is mentioned. Is this option no longer valid (it seems I could not get it to work the way pci-stub.ids= works)?</p></div></blockquote></div><p>Sorry, vfio-pci.ids was complete mis-information, but I&#039;m working to make it true.&#160; I&#039;ve never heard of a NIC affecting the network when simply bound to pci-stub or vfio-pci.&#160; The e1000e may be a better target for device assignment.&#160; I can&#039;t say i&#039;m surprised that an atheros NIC has issues.</p> </div> <div class="postsignature postmsg"><hr /><p><a href="http://vfio.blogspot.com" rel="nofollow">http://vfio.blogspot.com</a><br />Looking for a more open forum to discuss vfio related uses?&#160; Try <a href="https://www.redhat.com/mailman/listinfo/vfio-users" rel="nofollow">https://www.redhat.com/mailman/listinfo/vfio-users</a></p></div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1510031">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1510110" class="blockpost rowodd"> <h2><span><span class="conr">#4448</span> <a href="viewtopic.php?pid=1510110#p1510110">2015-03-10 17:39:32</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=59241">tritron4</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2012-04-14</span></dd> <dd><span>Posts: 146</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=59241">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <p>I wonder if anyone had been using asus A88x-Pro with kvm. I had it setup with xen 4.4.3 and I was able to pass R9 270 and couple of other&#160; ati cards. I was using 1201 bios version. I had flashed latest bios 1701. I can boot windows 8.1 without ati drivers and with vga none my R 270 displays out put but the moment I had installed ati drivers the system only boots to blue screen it get stuck and does not show desktop.&#160; I had to use this options vfio_iommu_type1 disable_hugepages=1. to work around bios bug. <br />Any tips on geting that motherboard working with kvm ? How I can get uefi emulation working under kvm. So far I had it load uefi but i dont see any options to boot from my hard drive,</p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1510110">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1510163" class="blockpost roweven"> <h2><span><span class="conr">#4449</span> <a href="viewtopic.php?pid=1510163#p1510163">2015-03-10 20:15:19</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=39767">Naruni</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2010-08-05</span></dd> <dd><span>Posts: 29</span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <p>Sorry if this is a hijack, but I felt it was in paralell to OP.</p><p>tl;dr: Does anyone have a way of asking Gerd Hoffman to build OVMF with <a href="http://sourceforge.net/p/edk2/mailman/message/30377799/" rel="nofollow">http://sourceforge.net/p/edk2/mailman/message/30377799/</a> this patch?</p><p>After a ton of digging to what seemed like the bottom of the internet, I found out Windows 7 on OVMF (uefi) won&#039;t boot to a vfio bound GPU due to it needing something called an int 10h.&#160; I think: windows 7 will work on UEFI outside of vfio OVMF because CSM enables the int 10h legacy or something to move windows along.&#160; Someone suggested making it possible for OVMF to allow this without(?) CSM in the link above.</p><p>My problem is I totally suck at building EDK2 and after a couple days of failing I&#039;d like to see if anyone knows how to contact the owner of that repo to try a special build.</p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1510163">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1510164" class="blockpost rowodd"> <h2><span><span class="conr">#4450</span> <a href="viewtopic.php?pid=1510164#p1510164">2015-03-10 20:25:49</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=85314">Duelist</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2014-09-22</span></dd> <dd><span>Posts: 358</span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>Naruni wrote:</cite><blockquote><div><p>Sorry if this is a hijack, but I felt it was in paralell to OP.</p><p>tl;dr: Does anyone have a way of asking Gerd Hoffman to build OVMF with <a href="http://sourceforge.net/p/edk2/mailman/message/30377799/" rel="nofollow">http://sourceforge.net/p/edk2/mailman/message/30377799/</a> this patch?</p><p>After a ton of digging to what seemed like the bottom of the internet, I found out Windows 7 on OVMF (uefi) won&#039;t boot to a vfio bound GPU due to it needing <strong>something called an int 10h.</strong>&#160; I think: windows 7 will work on UEFI outside of vfio OVMF because CSM enables the int 10h legacy or something to move windows along.&#160; Someone suggested making it possible for OVMF to allow this without(?) CSM in the link above.</p><p>My problem is I totally suck at building EDK2 and after a couple days of failing I&#039;d like to see if anyone knows how to contact the owner of that repo to try a special build.</p></div></blockquote></div><p>That&#039;s where i begin to feel really, REALLY old. Int 10h is, basically, call &quot;bios function&quot;. You set up some registers, then do int 10h and the machine does stuff.<br />Kek point is - there&#039;s certain things that UEFI really wouldn&#039;t like, in my opinion. <span class="bbs">Like, using int 10h you could output text(say hi to VGA maybe?) or change the video mode, if i recall correctly.</span> I remember correctly: <a href="http://en.wikipedia.org/wiki/INT_10H" rel="nofollow">http://en.wikipedia.org/wiki/INT_10H</a> <a href="http://en.wikipedia.org/wiki/BIOS_interrupt_call" rel="nofollow">http://en.wikipedia.org/wiki/BIOS_interrupt_call</a><br />I guess you can&#039;t have int 10h working with GOP.</p><p>I can&#039;t comprehend the patch&#039; insides, but this is very, very interesting.</p><p>Also, i&#039;ve recently tried to install windows 7 on hardware UEFI platform, and failed just like i failed on the VM: stuck when windowns tries to output something on screen.</p><p>I guess if you could&#039;ve feed it with some video drivers(there&#039;s some ways to do this, but i ain&#039;t no windows magician) before the install - it might work.</p><p>Seems like so far my guess is proving true - windows 7 doesn&#039;t work with GOP, it can&#039;t output graphics that way. If you fetch it drivers which do their own magic way(you can&#039;t change resolution on windowns 8 until you install drivers) outputting video - it should work.</p> <p class="postedit"><em>Last edited by Duelist (2015-03-10 20:47:34)</em></p> </div> <div class="postsignature postmsg"><hr /><p><span class="bbs">The forum rules prohibit requesting support for distributions other than arch.</span><br /><a href="https://bbs.archlinux.org/viewtopic.php?pid=1551460#p1551460" rel="nofollow">I gave up.</a><a href="https://bbs.archlinux.org/viewtopic.php?id=162768" rel="nofollow"> It was too late.</a><br /><a href="http://pastebin.com/B3fL84bq" rel="nofollow">What I was trying to do</a>.<br /><a href="http://vfio.blogspot.com/" rel="nofollow">The reference about VFIO and KVM VGA passthrough.</a></p></div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1510164">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div class="postlinksb"> <div class="inbox crumbsplus"> <div class="pagepost"> <p class="pagelink conl"><span class="pages-label">Pages: </span><a rel="prev" class="item1" href="viewtopic.php?id=162768&amp;p=177">Previous</a> <a href="viewtopic.php?id=162768">1</a> <span class="spacer">…</span> <a href="viewtopic.php?id=162768&amp;p=176">176</a> <a href="viewtopic.php?id=162768&amp;p=177">177</a> <strong>178</strong> <a href="viewtopic.php?id=162768&amp;p=179">179</a> <a href="viewtopic.php?id=162768&amp;p=180">180</a> <span class="spacer">…</span> <a href="viewtopic.php?id=162768&amp;p=234">234</a> <a rel="next" href="viewtopic.php?id=162768&amp;p=179">Next</a></p> <p class="postlink conr">Topic closed</p> </div> <ul class="crumbs"> <li><a href="index.php">Index</a></li> <li><span>»&#160;</span><a href="viewforum.php?id=48">Topics Going Nowhere</a></li> <li><span>»&#160;</span><strong><a href="viewtopic.php?id=162768">KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</a></strong></li> </ul> <p class="subscribelink clearb"><a href="misc.php?action=subscribe&amp;tid=162768">Subscribe to this topic</a></p> <div class="clearer"></div> </div> </div> </div> <div id="brdfooter" class="block"> <h2><span>Board footer</span></h2> <div class="box"> <div id="brdfooternav" class="inbox"> <div class="conl"> <form id="qjump" method="get" action="viewforum.php"> <div><label><span>Jump to<br /></span> <select name="id" onchange="window.location=('viewforum.php?id='+this.options[this.selectedIndex].value)"> <optgroup label="Technical Issues and Assistance"> <option value="23">Newbie Corner</option> <option value="17">Installation</option> <option value="22">Kernel &amp; Hardware</option> <option value="18">Applications &amp; Desktop Environments</option> <option value="31">Laptop Issues</option> <option value="8">Networking, Server, and Protection</option> <option value="32">Multimedia and Games</option> <option value="50">System Administration</option> <option value="35">Other Architectures</option> </optgroup> <optgroup label="Arch-centric"> <option value="24">Announcements, Package &amp; Security Advisories</option> <option value="1">Arch Discussion</option> <option value="13">Forum &amp; Wiki discussion</option> </optgroup> <optgroup label="Pacman Upgrades, Packaging &amp; AUR"> <option value="44">Pacman &amp; Package Upgrade Issues</option> <option value="49">[testing] Repo Forum</option> <option value="4">Creating &amp; Modifying Packages</option> <option value="38">AUR Issues, Discussion &amp; PKGBUILD Requests</option> </optgroup> <optgroup label="Contributions &amp; Discussion"> <option value="20">GNU/Linux Discussion</option> <option value="27">Community Contributions</option> <option value="33">Programming &amp; Scripting</option> <option value="30">Other Languages</option> <option value="47">Artwork and Screenshots</option> <option value="42">Try This</option> </optgroup> <optgroup label="/dev/null"> <option value="29">Off-Topic</option> <option value="48" selected="selected">Topics Going Nowhere</option> <option value="36">Dustbin</option> </optgroup> </select></label> <input type="submit" value=" Go " accesskey="g" /> </div> </form> </div> <div class="conr"> <p id="feedlinks"><span class="atom"><a href="extern.php?action=feed&amp;tid=162768&amp;type=atom">Atom topic feed</a></span></p> <p id="poweredby">Powered by <a href="http://fluxbb.org/">FluxBB</a></p> </div> <div class="clearer"></div> </div> </div> </div> </div> <div class="end-box"></div> </div> </body> </html>
