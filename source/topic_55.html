<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"> <html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en" dir="ltr"> <head> <meta http-equiv="Content-Type" content="text/html; charset=utf-8" /> <title>KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9 (Page 55) / Topics Going Nowhere / Arch Linux Forums</title> <link rel="stylesheet" type="text/css" href="style/ArchLinux.css" /> <link rel="canonical" href="viewtopic.php?id=162768&amp;p=55" title="Page 55" /> <link rel="prev" href="viewtopic.php?id=162768&amp;p=54" title="Page 54" /> <link rel="next" href="viewtopic.php?id=162768&amp;p=56" title="Page 56" /> <link rel="alternate" type="application/atom+xml" href="extern.php?action=feed&amp;tid=162768&amp;type=atom" title="Atom topic feed" /> <link rel="stylesheet" media="screen" href="style/ArchLinux/arch.css?v=3" /> <link rel="stylesheet" media="screen" href="style/ArchLinux/archnavbar.css?v=2" /> <link rel="shortcut icon" href="style/ArchLinux/favicon.ico" /> </head> <body> <div id="archnavbar" class="anb-forum"> <div id="archnavbarlogo"><h1><a href="http://www.archlinux.org/">Arch Linux</a></h1></div> <div id="archnavbarmenu"> <ul id="archnavbarlist"> <li id="anb-home"><a href="http://www.archlinux.org/">Home</a></li><li id="anb-packages"><a href="http://www.archlinux.org/packages/">Packages</a></li><li id="anb-forums" class="anb-selected"><a href="https://bbs.archlinux.org/">Forums</a></li><li id="anb-wiki"><a href="https://wiki.archlinux.org/">Wiki</a></li><li id="anb-bugs"><a href="https://bugs.archlinux.org/">Bugs</a></li><li id="anb-aur"><a href="https://aur.archlinux.org/">AUR</a></li><li id="anb-download"><a href="http://www.archlinux.org/download/">Download</a></li> </ul> </div> </div> <div id="punviewtopic" class="pun"> <div class="top-box"></div> <div class="punwrap"> <div id="brdheader" class="block"> <div class="box"> <div id="brdmenu" class="inbox"> <ul> <li id="navindex" class="isactive"><a href="index.php">Index</a></li> <li id="navuserlist"><a href="userlist.php">User list</a></li> <li id="navsearch"><a href="search.php">Search</a></li> <li id="navprofile"><a href="profile.php?id=80749">Profile</a></li> <li id="navlogout"><a href="login.php?action=out&amp;id=80749&amp;csrf_token=5c20501ec397bb45ef8ee8c84db232c8d8e421c6">Logout</a></li> </ul> </div> <div id="brdwelcome" class="inbox"> <ul class="conl"> <li><span>Logged in as <strong>SXX</strong></span></li> <li><span>Last visit: 2015-08-16 12:20:09</span></li> </ul> <ul class="conr"> <li><span>Topics: <a href="search.php?action=show_replies" title="Find topics you have posted to.">Posted</a> | <a href="search.php?action=show_new" title="Find topics with new posts since your last visit.">New</a> | <a href="search.php?action=show_recent" title="Find topics with recent posts.">Active</a> | <a href="search.php?action=show_unanswered" title="Find topics with no replies.">Unanswered</a></span></li> </ul> <div class="clearer"></div> </div> </div> </div> <div id="brdmain"> <div class="linkst"> <div class="inbox crumbsplus"> <ul class="crumbs"> <li><a href="index.php">Index</a></li> <li><span>»&#160;</span><a href="viewforum.php?id=48">Topics Going Nowhere</a></li> <li><span>»&#160;</span><strong><a href="viewtopic.php?id=162768">KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</a></strong></li> </ul> <div class="pagepost"> <p class="pagelink conl"><span class="pages-label">Pages: </span><a rel="prev" class="item1" href="viewtopic.php?id=162768&amp;p=54">Previous</a> <a href="viewtopic.php?id=162768">1</a> <span class="spacer">…</span> <a href="viewtopic.php?id=162768&amp;p=53">53</a> <a href="viewtopic.php?id=162768&amp;p=54">54</a> <strong>55</strong> <a href="viewtopic.php?id=162768&amp;p=56">56</a> <a href="viewtopic.php?id=162768&amp;p=57">57</a> <span class="spacer">…</span> <a href="viewtopic.php?id=162768&amp;p=234">234</a> <a rel="next" href="viewtopic.php?id=162768&amp;p=56">Next</a></p> <p class="postlink conr">Topic closed</p> </div> <div class="clearer"></div> </div> </div> <div id="p1392775" class="blockpost rowodd blockpost1"> <h2><span><span class="conr">#1351</span> <a href="viewtopic.php?pid=1392775#p1392775">2014-03-15 18:45:17</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=48315">TripleSpeeder</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2011-05-02</span></dd> <dd><span>Posts: 43</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=48315">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <p>On my end the VGA passthrough is working quite fine for some time now. I am thinking how to integrate this with libvirt and virtmanager instead of configuring/running quemu manually. So i&#039;d like to use libvirtd and virtmanager to setup, configure, start, stop etc. my VMs with VGA passthrough using vfio. Anyone here have experience? Is this already possible?</p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1392775">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1392780" class="blockpost roweven"> <h2><span><span class="conr">#1352</span> <a href="viewtopic.php?pid=1392780#p1392780">2014-03-15 18:52:00</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=78143">Blind Tree Frog</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2013-12-31</span></dd> <dd><span>Posts: 27</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=78143">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <p>Should be possible already.&#160; There might be a custom line you need to add to the XML (or two) but I don&#039;t remember where in the thread it was discussed.&#160; I know that people are doing what you ask though.</p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1392780">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1392821" class="blockpost rowodd"> <h2><span><span class="conr">#1353</span> <a href="viewtopic.php?pid=1392821#p1392821">2014-03-15 20:12:29</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=70922">nbhs</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd class="postavatar"><img src="https://bbs.archlinux.org/img/avatars/70922.jpg?m=1367773811" width="80" height="80" alt="" /></dd> <dd><span>From: Montevideo, Uruguay</span></dd> <dd><span>Registered: 2013-05-02</span></dd> <dd><span>Posts: 402</span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>novist wrote:</cite><blockquote><div><p>One more success story here. This is all done on mint 16 by the way.<br />Hardware: Sabertooth FX990 R2.0 motherboard, AMD FX(tm)-8350 CPU, host GPU geforce gtx 550ti, VM GPU Radeon R9 270X.<br />qemu: from git<br />kernel: <a href="http://kernel.ubuntu.com/~kernel-ppa/mainline/v3.13.6-trusty/" rel="nofollow">3.13.6</a></p><div class="codebox"><pre><code>00:13.0 USB controller: Advanced Micro Devices, Inc. [AMD/ATI] SB7x0/SB8x0/SB9x0 USB OHCI0 Controller 00:13.2 USB controller: Advanced Micro Devices, Inc. [AMD/ATI] SB7x0/SB8x0/SB9x0 USB EHCI Controller 06:00.0 VGA compatible controller: Advanced Micro Devices, Inc. [AMD/ATI] Curacao XT [Radeon R9 270X] 06:00.1 Audio device: Advanced Micro Devices, Inc. [AMD/ATI] Cape Verde/Pitcairn HDMI Audio [Radeon HD 7700/7800 Series]</code></pre></div><div class="codebox"><pre><code>~/VM/src/qemu/build/release/x86_64-softmmu/qemu-system-x86_64 \ -enable-kvm -m 4096 -cpu host -machine q35,accel=kvm \ -smp 8,sockets=1,cores=8,threads=1 \ -bios /usr/share/qemu/bios.bin \ -drive file=/dev/disk/by-id/ata-WDC_WD3200BEVT-22ZCT0_WD-WXE708J50240,if=none,id=virtio-disk0,format=raw,cache=none,aio$ -device virtio-blk-pci,scsi=off,drive=virtio-disk0,id=disk0 \ -drive file=/dev/disk/by-id/ata-WDC_WD7502AAEX-00Y9A0_WD-WCAW31075836,if=none,id=virtio-disk1,format=raw,cache=none,aio$ -device virtio-blk-pci,scsi=off,drive=virtio-disk1,id=disk1 \ -device e1000,netdev=vnet0,mac=20:64:32:c1:f9:22 -netdev tap,id=vnet0 \ -smb user,smbserver=10.0.2.4 \ -device ioh3420,bus=pcie.0,addr=1c.0,multifunction=on,port=1,chassis=1,id=root.1 \ -device vfio-pci,host=06:00.0,bus=root.1,addr=00.0,multifunction=on,x-vga=on \ -device vfio-pci,host=06:00.1,bus=root.1,addr=00.1 \ -device vfio-pci,host=00:13.0,bus=pcie.0 \ -device vfio-pci,host=00:13.2,bus=pcie.0 \ -vga none</code></pre></div><p>Some observations i made:<br />To correctly pass-through USB controller i had to include both 00:13.0 and 00:13.2, othervise qemu threw an error about failing to bind vfio or something.<br />To find correct address of USB ports i wanted i used stupid method: plugged in mouse to target port and then go through pci addresses and vfio-bind them. When mouse lights went out i knew usb port was no longer working so that was last one i bound. Then had to reboot to make them come back. There probably is better way..<br />I could use -vga sdl along with passed-through GPU. Using stock 1.5 qemu from repos did not quite work. Device manager reported radeon had some kind of malfunction. Compiling qemu from git made it work. Both emulated vga and passed-through one side by side. 3d apps did not run on radeon vga in that mode though and i did not care to find out how to make that happen.<br />Everything else went pretty much as described in original guide.<br />Well and bit offtopic - to use virtio for disk i had to boot OS while disk with windows was attached with -hda and then i had to attach dummy few meg image in virtio mode. That way windows picked up new device and i could install drivers. After that all disks can be attached in virtio.</p><p>Now this brings me to problems.. I am too having this issue where after reboot vga will not reset and VM with passed-through vga can not be started again. As far as i read this thread did not see a solution. Correct me if im blind and i missed it.<br />Also performance issue led me to believe i should use these patches:</p><div class="quotebox"><cite>aw wrote:</cite><blockquote><div><p>Paolo has posted new patches to fix performance when debug registers are used in the guest.&#160; Performance should be the same as previous set on Intel, but this series also adds support for AMD.&#160; Patches:</p><p><a href="http://marc.info/?l=linux-kernel&amp;m=139419276204556&amp;q=raw" rel="nofollow">http://marc.info/?l=linux-kernel&amp;m=1394 … 4556&amp;q=raw</a><br /><a href="http://marc.info/?l=linux-kernel&amp;m=139419268004517&amp;q=raw" rel="nofollow">http://marc.info/?l=linux-kernel&amp;m=1394 … 4517&amp;q=raw</a><br /><a href="http://marc.info/?l=linux-kernel&amp;m=139419270004527&amp;q=raw" rel="nofollow">http://marc.info/?l=linux-kernel&amp;m=1394 … 4527&amp;q=raw</a><br /><a href="http://marc.info/?l=linux-kernel&amp;m=139419260404488&amp;q=raw" rel="nofollow">http://marc.info/?l=linux-kernel&amp;m=1394 … 4488&amp;q=raw</a><br /><a href="http://marc.info/?l=linux-kernel&amp;m=139419265404502&amp;q=raw" rel="nofollow">http://marc.info/?l=linux-kernel&amp;m=1394 … 4502&amp;q=raw</a><br /><a href="http://marc.info/?l=linux-kernel&amp;m=139419261204492&amp;q=raw" rel="nofollow">http://marc.info/?l=linux-kernel&amp;m=1394 … 4492&amp;q=raw</a><br /><a href="http://marc.info/?l=linux-kernel&amp;m=139419263204499&amp;q=raw" rel="nofollow">http://marc.info/?l=linux-kernel&amp;m=1394 … 4499&amp;q=raw</a></p></div></blockquote></div><p>For what kernel version are they? I fail to apply them because latest <a href="https://git.kernel.org/cgit/linux/kernel/git/torvalds/linux.git/tree" rel="nofollow">tree</a> does not quite match code in these patches. Not entirely sure if its a good idea to apply these patches in this case.</p><br /><p>EDIT:<br />After some more digging i figured out patches are for latest 3.14-rc6 kernel. Thing is after kernel update i still can not see reasonable speed improvement. I used passmarkt to test and only dx11 test seems to run at ~80% of speed compared to other users. dx9 is especially slow. Basically all other 3d tests are somewhere around 20-30% of other people&#039;s results. Really slow.. If anyone knows possible cure - hint me please!</p><p>Also i forgot to mention that if i run VM then host will not shut down properly. It hangs after bunch of &quot;synchronizing SCISI cache&quot; messages.<br />Also had to flib-back to nouveau driver for host as latest nvidia beta driver (which is supposed to work with rc6) wont install (hangs without displaying anything upon start). Anyone happen to install that beast?</p></div></blockquote></div><p>Have you tried this?</p><div class="codebox"><pre><code>echo &quot;options kvm-amd npt=0&quot; &gt; /etc/modprobe.d/kvm-amd.conf</code></pre></div> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1392821">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1392919" class="blockpost roweven"> <h2><span><span class="conr">#1354</span> <a href="viewtopic.php?pid=1392919#p1392919">2014-03-16 09:17:41</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=80279">novist</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2014-03-14</span></dd> <dd><span>Posts: 34</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=80279">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <p>Yes it is there already. Maybe i will make summary of my modprobe.d configs and grub params:<br />kvm-amd.conf</p><div class="codebox"><pre><code>options kvm-amd npt=0</code></pre></div><p>kvm.conf</p><div class="codebox"><pre><code>#options kvm ignore_msrs=1 options kvm allow_unsafe_assigned_interrupts=1</code></pre></div><p>qemu-system-x86.conf</p><div class="codebox"><pre><code>options kvm_intel nested=1</code></pre></div><p>vfio_iommu_type1.conf</p><div class="codebox"><pre><code>options vfio_iommu_type1 allow_unsafe_interrupts=1</code></pre></div><p>GRUB:</p><div class="codebox"><pre><code>GRUB_CMDLINE_LINUX_DEFAULT=&quot;radeon.blacklist=1 radeonhd.blacklist=1 nouveau.blacklist=0 nouveau.modeset=1 nvidia.blacklist=1 nvidia.modeset=0 iommu=pt iommu=1 pci-stub.ids=1002:6810,1002:aab0 vfio_iommu_type1.allow_unsafe_interrupts=1&quot;</code></pre></div><p>blacklist.conf</p><div class="codebox"><pre><code>blacklist radeon blacklist radeonhd #blacklist nouveau blacklist nvidia</code></pre></div><p>I probably overstretched it a bit. Some double-configs probably are not really needed but im not sure. Not an expert on linux kernel things here. I maybe even would want to move all modprobe configs related to kvm to same file but again idk if its good idea.</p><p>EDIT:<br />Im adding benchmark that does not make any sense. As you notice DirectCompute and especially DirectX 11 are more than one could wish for. However complex directx9 is right down the toilet. My brain cant figure out any scenario where this would make sense. It is sad because most of the games nowdays are still directx9 <img src="https://bbs.archlinux.org/img/smilies/neutral.png" width="15" height="15" alt="neutral" /><br /><span class="postimg"><img src="http://i61.tinypic.com/ictrgo.png" alt="ictrgo.png" /></span></p> <p class="postedit"><em>Last edited by novist (2014-03-16 10:04:57)</em></p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1392919">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1392947" class="blockpost rowodd"> <h2><span><span class="conr">#1355</span> <a href="viewtopic.php?pid=1392947#p1392947">2014-03-16 11:54:20</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=80333">ahl</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2014-03-16</span></dd> <dd><span>Posts: 20</span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <p>Thank you for this great guide. I immediatelly got VGA passthrough working perfectly with Debian Jessie guest.</p><p>Setup:<br />AMD A10-5700 APU<br />Asus F2A85-M PRO, BIOS 6204<br />Host: Radeon HD 7660D IGP (Gallium, Northern Islands)<br />Guest: Radeon HD 3870 (Gallium, R600)<br />Linux 3.12.14-gentoo<br />Qemu 1.7.0 (Gentoo portage)<br />Seabios 1.7.3.2 (Gentoo portage)</p><p>I did not apply patches of any kind.</p><p>These are needed for running as non-root (numbers may vary and I choose that 3GiB arbitrarily):<br />chgrp kvm /dev/vfio/2<br />chmod g+rw /dev/vfio/2<br />echo &quot;@kvm - memlock 3145728&quot; &gt;&gt; /etc/security/limits.conf</p><br /><p>Unfortunately I ran into a problem unrelated to passthrough: I can&#039;t get WinXP 32-bit (SP3) to boot or install with &quot;-M q35&quot; no matter what I do! Is everyone else using newer Windows? Or what am I doing wrong?</p><p>Here is one example how to reproduce the problem:<br />1. qemu-system-x86_64 -machine accel=kvm -m 1024 -M q35 -drive file=/path/to/winxp_sp3.iso,if=none,id=dr0,media=cdrom -device ide-cd,bus=ide.0,drive=dr0 -net none -daemonize -vga cirrus<br />2. Wait ~10 seconds<br />3. BSOD with STOP 0xA5 appears</p><p>Above works fine without &quot;-M q35&quot;.</p><p>Identical looking problems:<br /><a href="https://bugzilla.redhat.com/show_bug.cgi?id=902662" rel="nofollow">https://bugzilla.redhat.com/show_bug.cgi?id=902662</a><br /><a href="https://bugzilla.redhat.com/show_bug.cgi?id=959815" rel="nofollow">https://bugzilla.redhat.com/show_bug.cgi?id=959815</a></p><p>To solve the problem I have tried:<br />- Qemu 1.4.2, 1.5.3, 1.7.0 and git<br />- Seabios 1.7.2.1, 1.7.2.2, 1.7.3.2, 1.7.4, git and also the bios that came with qemu-git and also 1.7.4 with something resempling commit 2114f50148c42e374586359d23b522483ca10e8d reverted<br />- qemu-system-i386 and qemu-system-x86_64<br />- Quite a lot of different qemu options including: with and without kvm, -no-hpet, -no-acpi, various -cpu and -smp, various -vga, various memory sizes, various emulated SATA, IDE and AHCI controllers, some random -acpitables</p><p><strong>UPDATE:</strong> I managed to get past this one ordeal. The trick is to use this virtual hd controller: -device piix4-ide,bus=pcie.0,id=piix4-ide<br />AND then press F7 during Windows install to disable ACPI. Any other combo won&#039;t work. So now I have WinXP working just fine with &quot;-M q35&quot;.</p><p>Unfortunately attempts to actually boot the same WinXP with Radeon card enabled seem to lead to horrible host crashes of data corruption. Interestingly, Debian guest still works just fine.</p><p><strong>UPDATE 2:</strong> Now using Asus BIOS 6308 and git kernel + fix_memleak.patch and qit qemu.</p><p>Still no luck with either Win7 or WinXP. Win7 works without AMD drivers but once the drivers have been installed, it crashes right after &quot;Starting Windows&quot;. Host usually also crashes. If I start qemu from console without any graphics drivers, host seems not to crash(?), but it won&#039;t make the guest work any better. And if I accidentally do modprobe radeon after guest crash the whole system crashes? I used to get ATA-errors on host crashes, but now after some changes I don&#039;t get any error messages.</p><p>(I also found out there was no need for allow_unsafe_interrupts=1. I simply didn&#039;t have Interrupt Mapping compiled in kernel.)</p> <p class="postedit"><em>Last edited by ahl (2014-03-18 05:34:27)</em></p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1392947">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1393008" class="blockpost roweven"> <h2><span><span class="conr">#1356</span> <a href="viewtopic.php?pid=1393008#p1393008">2014-03-16 15:38:34</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=80279">novist</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2014-03-14</span></dd> <dd><span>Posts: 34</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=80279">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>ahl wrote:</cite><blockquote><div><p>Thank you for this great guide. I immediatelly got VGA passthrough working perfectly with Debian Jessie guest.</p><p>Setup:<br />AMD A10-5700 APU<br />Asus F2A85-M PRO, BIOS 6204<br />Host: Radeon HD 7660D IGP (Gallium, Northern Islands)<br />Guest: Radeon HD 3870 (Gallium, R600)<br />Linux 3.12.14-gentoo<br />Qemu 1.7.0 (Gentoo portage)<br />Seabios 1.7.3.2 (Gentoo portage)</p><p>I did not apply patches of any kind.</p><p>Required hacks:<br />vfio_iommu_type1.allow_unsafe_interrupts=1<br />chgrp kvm /dev/vfio/2<br />chmod g+rw /dev/vfio/2<br />echo &quot;@kvm - memlock 3145728&quot; &gt;&gt; /etc/security/limits.conf</p><p>I wonder what are the implications of that interrupt hack? &quot;unsafe&quot; doesn&#039;t sound good.</p><br /><p>Unfortunately I ran into a problem unrelated to passthrough: I can&#039;t get WinXP 32-bit (SP3) to boot or install with &quot;-M q35&quot; no matter what I do! Is everyone else using newer Windows? Or what am I doing wrong?</p><p>Here is one example how to reproduce the problem:<br />1. qemu-system-x86_64 -machine accel=kvm -m 1024 -M q35 -drive file=/path/to/winxp_sp3.iso,if=none,id=dr0,media=cdrom -device ide-cd,bus=ide.0,drive=dr0 -net none -daemonize -vga cirrus<br />2. Wait ~10 seconds<br />3. BSOD with STOP 0xA5 appears</p><p>Above works fine without &quot;-M q35&quot;.</p><p>Identical looking problems:<br /><a href="https://bugzilla.redhat.com/show_bug.cgi?id=902662" rel="nofollow">https://bugzilla.redhat.com/show_bug.cgi?id=902662</a><br /><a href="https://bugzilla.redhat.com/show_bug.cgi?id=959815" rel="nofollow">https://bugzilla.redhat.com/show_bug.cgi?id=959815</a></p><p>To solve the problem I have tried:<br />- Qemu 1.5.3, 1.7.0 and git<br />- Seabios 1.7.1, 1.7.2, 1.7.2.2, 1.7.3.2, 1.7.4 and also the bios that came with qemu-git and also 1.7.4 with something resempling commit 2114f50148c42e374586359d23b522483ca10e8d reverted<br />- qemu-system-i386 and qemu-system-x86_64<br />- Quite a lot of different qemu options including: with and without kvm, -no-hpet, -no-acpi, various -cpu and -smp, various -vga, various memory sizes, various emulated SATA, IDE and AHCI controllers, some random -acpitables</p><p>Any ideas?</p></div></blockquote></div><p>but why would you want that old OS? i mean seriously.. its done. move on.. also q35 is still in development and kind of experimental. i suppose noone cared to test obsolete OS with it.. i suggest picking up windows7. its fastest way to get you up and running.</p><br /><p>Also anyone having stability issues with windows VMs?&#160; Mine for some reason restarts some time after boot. Still no idea what could be causing it. Not even BSOD, just reboots instantly. I compiled qemu with --enable-debug but it does not output any more error messages. there is lots of following spam:</p><div class="codebox"><pre><code>qemu-system-x86_64: vfio: Cannot reset device 0000:00:13.0, no available reset mechanism.</code></pre></div><p>but i suppose its fine since 0000:00:13.0 is passed-through usb port and im switching between host and guest with kvm switch. this is real bummer..</p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1393008">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1393010" class="blockpost rowodd"> <h2><span><span class="conr">#1357</span> <a href="viewtopic.php?pid=1393010#p1393010">2014-03-16 15:43:50</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=80088">pereczes</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2014-03-08</span></dd> <dd><span>Posts: 14</span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <p>this thread is getting really long... would take pb weeks for someone to resume the most valuable info <img src="https://bbs.archlinux.org/img/smilies/wink.png" width="15" height="15" alt="wink" /></p><p>IMPORTANT: there were to things that were making freezing my host:<br />-&gt; if i wast trying to run CCC<br />-&gt; but also the fact that I had the HDMI cable attached</p><p>details about the second:<br />I was booting windows 7.1 guest on primary monitor attached to ATI/RADEN DIV connector. <br />Once I was attaching the HDMI, the guest was causing the host to freeze. Crazy...</p><p>Now tried to boot with DIV removed, but HDMI attached. Though there was no boot screen, <br />probably the card was sending the signal only to DIV, the guest booted and worked no crash.<br />Now re-installed CCC, and indeed once started CCC it crashed. At high level I can conclude that<br />the crash is related to manipulation of VIDEO output. <br />So there is a huge progress for me, but I still cannot live with the situation as the hdmi signal <br />someway does not show full screen. I had the same problem on linux as well and only CCC could <br />stretch the screen to the full size (though windows reports it is at max resolution)</p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1393010">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1393042" class="blockpost roweven"> <h2><span><span class="conr">#1358</span> <a href="viewtopic.php?pid=1393042#p1393042">2014-03-16 17:20:58</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=80333">ahl</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2014-03-16</span></dd> <dd><span>Posts: 20</span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>novist wrote:</cite><blockquote><div><p>but why would you want that old OS? i mean seriously.. its done. move on.. also q35 is still in development and kind of experimental. i suppose noone cared to test obsolete OS with it.. i suggest picking up windows7. its fastest way to get you up and running.</p></div></blockquote></div><p>Thanks but I have &quot;moved on&quot; to Linux. Giving more money to Microsoft for them to harass me more just doesn&#039;t feel right. And more importantly, there is nothing wrong with running old software in restricted environment. It&#039;s not like I&#039;d be surfing the net with it.</p><p>I also tried Windows 2000 Pro now. Different looking BSoD but exact same error and message.</p><p>More luck with Windows 98 SE, perhaps? (Honestly, I&#039;m out of ideas now...)</p><div class="quotebox"><cite>pereczes wrote:</cite><blockquote><div><p>So there is a huge progress for me, but I still cannot live with the situation as the hdmi signal <br />someway does not show full screen. I had the same problem on linux as well and only CCC could <br />stretch the screen to the full size (though windows reports it is at max resolution)</p></div></blockquote></div><p>I believe that&#039;s called underscanning and overscanning of video -- a ridiculous legacy feature of the HDMI protocol. A most reliable way to get rid of it, is to use good old VGA when possible.</p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1393042">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1393051" class="blockpost rowodd"> <h2><span><span class="conr">#1359</span> <a href="viewtopic.php?pid=1393051#p1393051">2014-03-16 17:53:05</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=80279">novist</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2014-03-14</span></dd> <dd><span>Posts: 34</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=80279">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>ahl wrote:</cite><blockquote><div><p>Thanks but I have &quot;moved on&quot; to Linux. Giving more money to Microsoft for them to harass me more just doesn&#039;t feel right. And more importantly, there is nothing wrong with running old software in restricted environment. It&#039;s not like I&#039;d be surfing the net with it.</p></div></blockquote></div><p>Poor support is exactly what is wrong with running old software. Suppose you survive pains of getting XP to run. It wont be long until you need software &lt;insert name here&gt; but it does not run on that legacy OS so upgrade is inevitable. You might try XP x64, it has rather different kernel from 32 bit counterpart (newer one). Maybe that would do the trick. By the way you can rearm Windows7 few times to extend trial to 120 days. Or you can do some other things. Im not even sure what happens when trial expires. I use one VM with expired 2008 r2 server trial and all i get is nag screen and no updates.</p><br /><br /><p>Now my update: i made interesting observation. I played FEAR3 for a period of time. GPU was working really loud and there was no lag whatsoever. I had no FPS counter visible so i dont know numbers but it was totally smooth on highest settings. Right after i started arma3 which lags quite a lot. Now GPU worked rather silently. Not sure what to make of it. Also this entire session lasted longer than what it took for system to go down earlier. Interesting fact is that when i had stability issues i was also running vmware with powered on VM. this time i had no VM on. So i suspect vmware might make qemu VM unstable. Will test this hypothesis in following days.</p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1393051">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1393096" class="blockpost roweven"> <h2><span><span class="conr">#1360</span> <a href="viewtopic.php?pid=1393096#p1393096">2014-03-16 19:21:53</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=80088">pereczes</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2014-03-08</span></dd> <dd><span>Posts: 14</span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <p>everything has a cost <img src="https://bbs.archlinux.org/img/smilies/wink.png" width="15" height="15" alt="wink" /> ... removed the NVIDIA card, and left only powercolor 6950</p><p>not behaving anymore as used to be:<br />-&gt; HDMI no signal (though not 100% sure if cable is not broken... next thing to check)<br />-&gt; on HDMI port both on BIOS setup strange characters, more precisely roughly 30%<br />of the text is displayed with wrong characters. &quot;Loading operating system&quot; is displayed<br />correctly, though the linux grub menu is the same messed up... Radeon driver would <br />just freeze the system (host!!), without driver managed to log in and write this...</p><p>as I was not sure if the latest gigabyte bios would have caused this (never used booting with<br />the radeon since I started the experiment), I reverted it to earlier version, but no changes.</p><p>Question: as I suspect that I might have corrupted the bios with all the experiments,<br />is there a way to reflash the bios from linux?</p><p>thanks</p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1393096">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1393256" class="blockpost rowodd"> <h2><span><span class="conr">#1361</span> <a href="viewtopic.php?pid=1393256#p1393256">2014-03-17 02:15:59</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=79757">fukhda</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2014-02-24</span></dd> <dd><span>Posts: 2</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=79757">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <p>Hi all,</p><p>I have been working on VGA passthrough for a while but no success yet. The prbolem I got is code12 for VGA card assigned to Win7 VM. Please check my work here and any comments are welcome. Thanks in advance, guys.</p><p><strong>[Somethings to be noted first]</strong><br />I am a newbie to linux and kvm. So please correct me if anything wrong.<br />I am working on Fedora 20, not archlinux.<br />The ingredients nbhs provided in post1. I do not know how to apply them properly in Fedora. (Will explain how I did it later)</p><p><strong>[Env. setup]</strong><br />CPU: Intel(R) Core(TM) i5-4430 CPU @ 3.00GHz<br />Motherboard: ASUS B85M-E<br />RAM: 4GB DDR3 1600 MHz<br />DISK: <br />VGA1: Intel Corporation Xeon E3-1200 v3/4th Gen Core Processor Integrated Graphics Controller (rev 06)<br />VGA2: AMD Radeon HD 7700</p><br /><p><strong>[Patches]</strong><br />Following is my way to apply tngredients (nbhs provided in post1) in Fedora.</p><p>1. linux-mainline.tar.gz <br />The base is kernel linux-3.13.3 (<a href="https://www.kernel.org/pub/linux/kernel/v3.x/linux-3.13.3.tar.gz" rel="nofollow">https://www.kernel.org/pub/linux/kernel … 3.3.tar.gz</a>)<br />I manually merge the diff code (six *.patch files, such as override_for_missing_acs_capabilities.patch) into linux-3.13.3. And add CONFIG_VIFO*=y in menuconfig. Then rebuild the kernel and install.</p><p>2. qemu-git.tar.gz<br />The base is qemu-1.7.0 (<a href="http://wiki.qemu-project.org/download/qemu-1.7.0.tar.bz2" rel="nofollow">http://wiki.qemu-project.org/download/q … .0.tar.bz2</a>)<br />Just follow the configure switch according to PKGBUILD</p><div class="codebox"><pre><code> ./configure --prefix=/usr --sysconfdir=/etc --audio-drv-list=&#039;pa alsa sdl oss&#039; \ --python=/usr/bin/python2 --smbd=/usr/bin/smbd \ --enable-docs --libexecdir=/usr/lib/qemu \ --disable-gtk --enable-linux-aio --enable-seccomp \ --enable-spice --localstatedir=/var make make install</code></pre></div><p>3. seabios-git.tar.gz<br />I am not doing any change here. Just run make in qemu-1.7.0/roms/seabios</p><p><strong>[Grub.cfg]</strong><br />Add below switches in /boot/grub2/grub.cfg<br />pcie_acs_override=downstream intel_iommu=on vfio_iommu_type1.allow_unsafe_interrupts=1</p><p>So, cat /proc/cmdline<br />BOOT_IMAGE=/vmlinuz-3.13.3 root=/dev/mapper/fedora-root ro rd.lvm.lv=fedora/swap vconsole.font=latarcyrheb-sun16 rd.lvm.lv=fedora/root pcie_acs_override=downstream intel_iommu=on vfio_iommu_type1.allow_unsafe_interrupts=1 rhgb quiet LANG=en_US.UTF-8</p><p><strong>[Before launching VM]</strong><br />1. blacklist radeon in /etc/modprobe.d/blacklist.conf</p><p>2. make vfio-bind.service according from 1st post into /etc/systemd/system<br />&#160; &#160;add DEVICES=&quot;0000:04:00.0 0000:04:00.1&quot; in /etc/vfio-pci.cfg<br />&#160; &#160;/* <br />&#160; &#160;|| This service is not launched automatically while machine reboots. <br />&#160; &#160;|| Instead, I manually run vfio-bind 0000:04:00.0 0000:04:00.1 before launching VM<br />&#160; &#160;*/</p><p>3. </p><div class="codebox"><pre><code>modprobe -r kvm_intel modprobe kvm_intel emulate_invalid_guest_state=0</code></pre></div><p>4. <br />/* vfio-bind is from 1st post */</p><div class="codebox"><pre><code>vfio-bind 0000:04:00.0 0000:04:00.1</code></pre></div><p>&#160; </p><p><strong>[Launch VM]</strong><br />I did a clean installation using the Win7x32.iso downloaded from MSDN. Once installation completed, &quot;-drive file=/home/test/fuhsiao/win7.iso,id=isocd -device ide-cd,bus=ahci.1,drive=isocd&quot; is removed from the below script.</p><div class="codebox"><pre><code>qemu-kvm --enable-kvm -M q35 -m 2048 \ -cpu host -smp 1,sockets=1,cores=1,threads=1 \ -bios /usr/local/src/qemu-1.7.0/roms/seabios/out/bios.bin \ -device ioh3420,bus=pcie.0,addr=1c.0,multifunction=on,port=1,chassis=1,id=root.1 \ -device vfio-pci,host=04:00.0,bus=root.1,addr=00.0,multifunction=on,x-vga=on \ -device vfio-pci,host=04:00.1,bus=root.1,addr=00.1 \ -device ahci,bus=pcie.0,id=ahci \ -drive file=/home/test/fuhsiao/test.img,id=disk,format=raw \ -drive file=/home/test/fuhsiao/win7.iso,id=isocd -device ide-cd,bus=ahci.1,drive=isocd \ -device ide-hd,bus=ahci.0,drive=disk \ -boot c \</code></pre></div><p><strong>[The problem is?]</strong><br />In win7 device manager, it showed that passed AMD card has got code 12 &quot;The device can not find enough free resources that it can use&quot;</p><p><strong>[What I have tried to solve the problem]</strong><br />1. Instead of passing through AMD Radeon HD 7700, I also tried NVIDIA EGVA GTX650. Still code12.</p><p>2. Diable iGPU <br />VGA1: iGPU is disabled from BIOS<br />VGA2: AMD Radeon HD 7700<br />VGA3: NVIDIA EGVA GTX650<br />Either passing AMD or NVIDIA, still code12.</p><p>3. Use the different qemu source<br />git://github.com/awilliam/qemu-vfio.git tags/vfio-pci-for-qemu-20131003.0<br />NOT the earlier <a href="http://wiki.qemu-project.org/download/qemu-1.7.0.tar.bz2" rel="nofollow">http://wiki.qemu-project.org/download/q … .0.tar.bz2</a>. Still code12.</p><br /><p><strong>[FYI]</strong></p><div class="codebox"><pre class="vscroll"><code>lspci 00:00.0 Host bridge: Intel Corporation 4th Gen Core Processor DRAM Controller (rev 06) 00:01.0 PCI bridge: Intel Corporation Xeon E3-1200 v3/4th Gen Core Processor PCI Express x16 Controller (rev 06) 00:02.0 VGA compatible controller: Intel Corporation Xeon E3-1200 v3/4th Gen Core Processor Integrated Graphics Controller (rev 06) 00:03.0 Audio device: Intel Corporation Xeon E3-1200 v3/4th Gen Core Processor HD Audio Controller (rev 06) 00:14.0 USB controller: Intel Corporation 8 Series/C220 Series Chipset Family USB xHCI (rev 04) 00:16.0 Communication controller: Intel Corporation 8 Series/C220 Series Chipset Family MEI Controller #1 (rev 04) 00:1a.0 USB controller: Intel Corporation 8 Series/C220 Series Chipset Family USB EHCI #2 (rev 04) 00:1b.0 Audio device: Intel Corporation 8 Series/C220 Series Chipset High Definition Audio Controller (rev 04) 00:1c.0 PCI bridge: Intel Corporation 8 Series/C220 Series Chipset Family PCI Express Root Port #1 (rev d4) 00:1c.2 PCI bridge: Intel Corporation 8 Series/C220 Series Chipset Family PCI Express Root Port #3 (rev d4) 00:1c.4 PCI bridge: Intel Corporation 8 Series/C220 Series Chipset Family PCI Express Root Port #5 (rev d4) 00:1d.0 USB controller: Intel Corporation 8 Series/C220 Series Chipset Family USB EHCI #1 (rev 04) 00:1f.0 ISA bridge: Intel Corporation B85 Express LPC Controller (rev 04) 00:1f.2 SATA controller: Intel Corporation 8 Series/C220 Series Chipset Family 6-port SATA Controller 1 [AHCI mode] (rev 04) 00:1f.3 SMBus: Intel Corporation 8 Series/C220 Series Chipset Family SMBus Controller (rev 04) 03:00.0 Ethernet controller: Realtek Semiconductor Co., Ltd. RTL8111/8168/8411 PCI Express Gigabit Ethernet Controller (rev 09) 04:00.0 VGA compatible controller: Advanced Micro Devices, Inc. [AMD/ATI] Cape Verde LE [Radeon HD 7730/8730] 04:00.1 Audio device: Advanced Micro Devices, Inc. [AMD/ATI] Cape Verde/Pitcairn HDMI Audio [Radeon HD 7700/7800 Series] lsgroup ### Group 0 ### 00:00.0 Host bridge: Intel Corporation 4th Gen Core Processor DRAM Controller (rev 06) ### Group 1 ### 00:01.0 PCI bridge: Intel Corporation Xeon E3-1200 v3/4th Gen Core Processor PCI Express x16 Controller (rev 06) ### Group 2 ### 00:02.0 VGA compatible controller: Intel Corporation Xeon E3-1200 v3/4th Gen Core Processor Integrated Graphics Controller (rev 06) ### Group 3 ### 00:03.0 Audio device: Intel Corporation Xeon E3-1200 v3/4th Gen Core Processor HD Audio Controller (rev 06) ### Group 4 ### 00:14.0 USB controller: Intel Corporation 8 Series/C220 Series Chipset Family USB xHCI (rev 04) ### Group 5 ### 00:16.0 Communication controller: Intel Corporation 8 Series/C220 Series Chipset Family MEI Controller #1 (rev 04) ### Group 6 ### 00:1a.0 USB controller: Intel Corporation 8 Series/C220 Series Chipset Family USB EHCI #2 (rev 04) ### Group 7 ### 00:1b.0 Audio device: Intel Corporation 8 Series/C220 Series Chipset High Definition Audio Controller (rev 04) ### Group 8 ### 00:1c.0 PCI bridge: Intel Corporation 8 Series/C220 Series Chipset Family PCI Express Root Port #1 (rev d4) ### Group 9 ### 00:1c.2 PCI bridge: Intel Corporation 8 Series/C220 Series Chipset Family PCI Express Root Port #3 (rev d4) ### Group 10 ### 00:1c.4 PCI bridge: Intel Corporation 8 Series/C220 Series Chipset Family PCI Express Root Port #5 (rev d4) ### Group 11 ### 00:1d.0 USB controller: Intel Corporation 8 Series/C220 Series Chipset Family USB EHCI #1 (rev 04) ### Group 12 ### 00:1f.0 ISA bridge: Intel Corporation B85 Express LPC Controller (rev 04) 00:1f.2 SATA controller: Intel Corporation 8 Series/C220 Series Chipset Family 6-port SATA Controller 1 [AHCI mode] (rev 04) 00:1f.3 SMBus: Intel Corporation 8 Series/C220 Series Chipset Family SMBus Controller (rev 04) ### Group 13 ### 03:00.0 Ethernet controller: Realtek Semiconductor Co., Ltd. RTL8111/8168/8411 PCI Express Gigabit Ethernet Controller (rev 09) ### Group 14 ### 04:00.0 VGA compatible controller: Advanced Micro Devices, Inc. [AMD/ATI] Cape Verde LE [Radeon HD 7730/8730] 04:00.1 Audio device: Advanced Micro Devices, Inc. [AMD/ATI] Cape Verde/Pitcairn HDMI Audio [Radeon HD 7700/7800 Series]</code></pre></div> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1393256">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1393355" class="blockpost roweven"> <h2><span><span class="conr">#1362</span> <a href="viewtopic.php?pid=1393355#p1393355">2014-03-17 12:08:25</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=79578">AKSN74</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd class="postavatar"><img src="https://bbs.archlinux.org/img/avatars/79578.jpg?m=1423108340" width="80" height="80" alt="" /></dd> <dd><span>From: Taichung, Taiwan</span></dd> <dd><span>Registered: 2014-02-18</span></dd> <dd><span>Posts: 52</span></dd> <dd class="usercontacts"><span class="email"><a href="mailto:missile0407@gmail.com">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <p>Hello, guys.<br />Now I got a another problem.</p><p>I&#039;m not sure it&#039;s GTX480 problem or KVM problem.</p><p>When I entered code, KVM can start normally and it can pass my GTX480 into VM.<br />But when I plug DVI cable to GTX480, it got nothing but no signal. Even tried another DVI, same result.</p><p>I know KVM is working because I&#039;m already installed TeamViewer in guest OS and it can connect, also I can see OS screen.<br />Does someone tried before?</p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1393355">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1393358" class="blockpost rowodd"> <h2><span><span class="conr">#1363</span> <a href="viewtopic.php?pid=1393358#p1393358">2014-03-17 12:14:45</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=80279">novist</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2014-03-14</span></dd> <dd><span>Posts: 34</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=80279">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>AKSN74 wrote:</cite><blockquote><div><p>Hello, guys.<br />Now I got a another problem.</p><p>I&#039;m not sure it&#039;s GTX480 problem or KVM problem.</p><p>When I entered code, KVM can start normally and it can pass my GTX480 into VM.<br />But when I plug DVI cable to GTX480, it got nothing but no signal. Even tried another DVI, same result.</p><p>I know KVM is working because I&#039;m already installed TeamViewer in guest OS and it can connect, also I can see OS screen.<br />Does someone tried before?</p></div></blockquote></div><p>no signal sounds like your card is not passed through.</p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1393358">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1393373" class="blockpost roweven"> <h2><span><span class="conr">#1364</span> <a href="viewtopic.php?pid=1393373#p1393373">2014-03-17 13:17:50</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=79578">AKSN74</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd class="postavatar"><img src="https://bbs.archlinux.org/img/avatars/79578.jpg?m=1423108340" width="80" height="80" alt="" /></dd> <dd><span>From: Taichung, Taiwan</span></dd> <dd><span>Registered: 2014-02-18</span></dd> <dd><span>Posts: 52</span></dd> <dd class="usercontacts"><span class="email"><a href="mailto:missile0407@gmail.com">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>novist wrote:</cite><blockquote><div><div class="quotebox"><cite>AKSN74 wrote:</cite><blockquote><div><p>Hello, guys.<br />Now I got a another problem.</p><p>I&#039;m not sure it&#039;s GTX480 problem or KVM problem.</p><p>When I entered code, KVM can start normally and it can pass my GTX480 into VM.<br />But when I plug DVI cable to GTX480, it got nothing but no signal. Even tried another DVI, same result.</p><p>I know KVM is working because I&#039;m already installed TeamViewer in guest OS and it can connect, also I can see OS screen.<br />Does someone tried before?</p></div></blockquote></div><p>no signal sounds like your card is not passed through.</p></div></blockquote></div><p>But it pass-through I&#039;m sure, because Windows 7 detected and driver installation is successful.</p> <p class="postedit"><em>Last edited by AKSN74 (2014-03-17 13:18:24)</em></p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1393373">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1393384" class="blockpost rowodd"> <h2><span><span class="conr">#1365</span> <a href="viewtopic.php?pid=1393384#p1393384">2014-03-17 13:57:52</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=48315">TripleSpeeder</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2011-05-02</span></dd> <dd><span>Posts: 43</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=48315">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <p>Okay, I am out of ideas now. I got everything running perfectly when starting qemu manual. Now i want to move to a libvirt xml file, so i can start/stop/manage my VMs with virtmanager. But no matter what I do, i don&#039;t get the card passed through.<br />Here is a minimal xml config to reproduce:</p><div class="codebox"><pre class="vscroll"><code>&lt;domain type=&#039;kvm&#039; xmlns:qemu=&#039;http://libvirt.org/schemas/domain/qemu/1.0&#039;&gt; &lt;name&gt;win7&lt;/name&gt; &lt;uuid&gt;87e41de8-b3a5-4d76-a048-5d8d206aacc2&lt;/uuid&gt; &lt;memory unit=&#039;KiB&#039;&gt;6144000&lt;/memory&gt; &lt;currentMemory unit=&#039;KiB&#039;&gt;6144000&lt;/currentMemory&gt; &lt;vcpu placement=&#039;static&#039; current=&#039;2&#039;&gt;4&lt;/vcpu&gt; &lt;os&gt; &lt;type arch=&#039;x86_64&#039; machine=&#039;pc-q35-1.5&#039;&gt;hvm&lt;/type&gt; &lt;boot dev=&#039;hd&#039;/&gt; &lt;bootmenu enable=&#039;yes&#039;/&gt; &lt;/os&gt; &lt;features&gt; &lt;acpi/&gt; &lt;apic/&gt; &lt;pae/&gt; &lt;/features&gt; &lt;cpu mode=&#039;custom&#039; match=&#039;exact&#039;&gt; &lt;model fallback=&#039;allow&#039;&gt;SandyBridge&lt;/model&gt; &lt;vendor&gt;Intel&lt;/vendor&gt; &lt;feature policy=&#039;require&#039; name=&#039;vme&#039;/&gt; &lt;feature policy=&#039;require&#039; name=&#039;dtes64&#039;/&gt; &lt;feature policy=&#039;require&#039; name=&#039;vmx&#039;/&gt; &lt;feature policy=&#039;require&#039; name=&#039;erms&#039;/&gt; &lt;feature policy=&#039;require&#039; name=&#039;xtpr&#039;/&gt; &lt;feature policy=&#039;require&#039; name=&#039;smep&#039;/&gt; &lt;feature policy=&#039;require&#039; name=&#039;pcid&#039;/&gt; &lt;feature policy=&#039;require&#039; name=&#039;est&#039;/&gt; &lt;feature policy=&#039;require&#039; name=&#039;monitor&#039;/&gt; &lt;feature policy=&#039;require&#039; name=&#039;smx&#039;/&gt; &lt;feature policy=&#039;require&#039; name=&#039;tm&#039;/&gt; &lt;feature policy=&#039;require&#039; name=&#039;acpi&#039;/&gt; &lt;feature policy=&#039;require&#039; name=&#039;osxsave&#039;/&gt; &lt;feature policy=&#039;require&#039; name=&#039;ht&#039;/&gt; &lt;feature policy=&#039;require&#039; name=&#039;pdcm&#039;/&gt; &lt;feature policy=&#039;require&#039; name=&#039;fsgsbase&#039;/&gt; &lt;feature policy=&#039;require&#039; name=&#039;f16c&#039;/&gt; &lt;feature policy=&#039;require&#039; name=&#039;ds&#039;/&gt; &lt;feature policy=&#039;require&#039; name=&#039;tm2&#039;/&gt; &lt;feature policy=&#039;require&#039; name=&#039;ss&#039;/&gt; &lt;feature policy=&#039;require&#039; name=&#039;pbe&#039;/&gt; &lt;feature policy=&#039;require&#039; name=&#039;ds_cpl&#039;/&gt; &lt;feature policy=&#039;require&#039; name=&#039;rdrand&#039;/&gt; &lt;/cpu&gt; &lt;clock offset=&#039;localtime&#039;&gt; &lt;timer name=&#039;rtc&#039; tickpolicy=&#039;catchup&#039;/&gt; &lt;timer name=&#039;pit&#039; tickpolicy=&#039;delay&#039;/&gt; &lt;timer name=&#039;hpet&#039; present=&#039;no&#039;/&gt; &lt;/clock&gt; &lt;on_poweroff&gt;destroy&lt;/on_poweroff&gt; &lt;on_reboot&gt;restart&lt;/on_reboot&gt; &lt;on_crash&gt;restart&lt;/on_crash&gt; &lt;pm&gt; &lt;suspend-to-mem enabled=&#039;no&#039;/&gt; &lt;suspend-to-disk enabled=&#039;no&#039;/&gt; &lt;/pm&gt; &lt;devices&gt; &lt;emulator&gt;/usr/sbin/qemu-system-x86_64&lt;/emulator&gt; &lt;controller type=&#039;pci&#039; index=&#039;0&#039; model=&#039;pcie-root&#039;/&gt; &lt;controller type=&#039;pci&#039; index=&#039;1&#039; model=&#039;dmi-to-pci-bridge&#039;&gt; &lt;address type=&#039;pci&#039; domain=&#039;0x0000&#039; bus=&#039;0x00&#039; slot=&#039;0x02&#039; function=&#039;0x0&#039;/&gt; &lt;/controller&gt; &lt;controller type=&#039;pci&#039; index=&#039;2&#039; model=&#039;pci-bridge&#039;&gt; &lt;address type=&#039;pci&#039; domain=&#039;0x0000&#039; bus=&#039;0x01&#039; slot=&#039;0x01&#039; function=&#039;0x0&#039;/&gt; &lt;/controller&gt; &lt;controller type=&#039;usb&#039; index=&#039;0&#039;&gt; &lt;address type=&#039;pci&#039; domain=&#039;0x0000&#039; bus=&#039;0x02&#039; slot=&#039;0x01&#039; function=&#039;0x2&#039;/&gt; &lt;/controller&gt; &lt;controller type=&#039;sata&#039; index=&#039;0&#039;&gt; &lt;address type=&#039;pci&#039; domain=&#039;0x0000&#039; bus=&#039;0x00&#039; slot=&#039;0x1f&#039; function=&#039;0x2&#039;/&gt; &lt;/controller&gt; &lt;memballoon model=&#039;none&#039;/&gt; &lt;/devices&gt; &lt;seclabel type=&#039;none&#039;/&gt; &lt;qemu:commandline&gt; &lt;qemu:arg value=&#039;-device&#039;/&gt; &lt;qemu:arg value=&#039;ioh3420,bus=pcie.0,addr=1c.0,multifunction=on,port=1,chassis=1,id=root.1&#039;/&gt; &lt;qemu:arg value=&#039;-device&#039;/&gt; &lt;qemu:arg value=&#039;vfio-pci,host=01:00.0,bus=root.1,addr=00.0,multifunction=on,x-vga=on&#039;/&gt; &lt;qemu:arg value=&#039;-bios&#039;/&gt; &lt;qemu:arg value=&#039;/usr/share/qemu/bios.bin&#039;/&gt; &lt;/qemu:commandline&gt; &lt;/domain&gt;</code></pre></div><p>When starting this instance e.g. through &quot;virsh start win7&quot; i get the following error:</p><div class="quotebox"><blockquote><div><p># virsh start win7<br />error: Failed to start domain win7<br />error: internal error: early end of file from monitor: possible problem:<br />qemu-system-x86_64: -device vfio-pci,host=01:00.0,bus=root.1,addr=00.0,multifunction=on,x-vga=on: vfio: error opening /dev/vfio/13: Operation not permitted<br />qemu-system-x86_64: -device vfio-pci,host=01:00.0,bus=root.1,addr=00.0,multifunction=on,x-vga=on: vfio: failed to get group 13<br />qemu-system-x86_64: -device vfio-pci,host=01:00.0,bus=root.1,addr=00.0,multifunction=on,x-vga=on: Device initialization failed.<br />qemu-system-x86_64: -device vfio-pci,host=01:00.0,bus=root.1,addr=00.0,multifunction=on,x-vga=on: Device &#039;vfio-pci&#039; could not be initialized</p></div></blockquote></div><p>What I did:</p><ul><li><p>Make sure that AMD-card is assigned to vfio</p></li><li><p>Edit /etc/libvirt/qemu.conf and set user/group qemu runs as to &quot;root&quot;</p></li><li><p>Getting desperate: chmod a+rw /dev/vfio/13</p></li></ul><p>But no luck. Everytime the same error :-(</p><p>Does anyone have a clue what I am missing? As I said, when I launch qemu manually (as root) everything works fine...</p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1393384">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1393387" class="blockpost roweven"> <h2><span><span class="conr">#1366</span> <a href="viewtopic.php?pid=1393387#p1393387">2014-03-17 14:12:20</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=78143">Blind Tree Frog</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2013-12-31</span></dd> <dd><span>Posts: 27</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=78143">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>Blind Tree Frog wrote:</cite><blockquote><div><div class="quotebox"><cite>Bronek wrote:</cite><blockquote><div><div class="quotebox"><cite>Blind Tree Frog wrote:</cite><blockquote><div><p>1) Do I need multiple video cards or can this be done with just one? ...</p><p>2) Any source I should look at to set this up from a fresh install? ...</p></div></blockquote></div><p>I also plan to build such a machine, with essentially headless host and Windows running on selected cores with VGA passthrough. For the time being my plan is to use the newest stable kernel and rely on top post in this thread, since it seems to be kept up-to date (thanks <strong>nbhs</strong> !)</p></div></blockquote></div><p>I&#039;ve been swamped lately and I&#039;m only now getting back to this thread, but I noticed that it looks like my first question might be doable.&#160; So &#039;yay!&#039; for that.&#160; Skimming also seems to suggest that powering through the first post is going to be my best option for the second.</p><p>I&#039;m planning on reinstalling my machine this week and give this another go.&#160; Hopefully I&#039;ll get it working and be able to report back with great success.&#160; I&#039;ll be sure to take notes.</p></div></blockquote></div><p>I got portions of this to work last night without trouble, but proceeding much further ran into difficulty.</p><p>Using the mainline, bios, and qemu code from the first post everything looked to build correctly.&#160; I switched kernels and passed &quot;quiet iommu video=efifb:off pci-stub.ids=....&quot; as the cmd line (where &#039;....&#039; would be the id&#039;s for my one video card and my USB devices).&#160; I also blacklisted &#039;radeon&#039; as well as enabling the service described in post one.&#160; Reboot.&#160; I then SSH&#039;d in for the rest of the steps.</p><p>The good news is that I was able to boot the seagate BIOS and see the output on my screen.&#160; &#160;It came up and said that it couldn&#039;t find any boot devices.</p><p>The bad news is that I got no further than that even if I passed a LiveCD ISO in with the &#039;-cdrom&#039; option; The BIOS still claimed that it couldn&#039;t find a bootable device.&#160; Also, I had to dial back some of the USB ID&#039;s I was passing to PCI stub as they didn&#039;t seem to work when passed to qemu.&#160; And if I didn&#039;t blacklist the radeon driver qemu wouldn&#039;t pick it up regardless of if it was in the pci_stub.ids list or not. And the vfio-bind service does seem to properly bind the USB devices, but fails to bind the video card so it needs to be run twice (Once by the system as per enabling, and once by the user after boot.&#160; The first time might not be required honestly but the second time is).</p><p>Hopefully I&#039;ll be able to investigate some more sometime this week and get meaningful questions.</p><p>Hardware:<br />ASUS Sabertooth 990FX/Gen3 R2<br />Asus Radeon HD7770 GHz Ed.</p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1393387">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1393400" class="blockpost rowodd"> <h2><span><span class="conr">#1367</span> <a href="viewtopic.php?pid=1393400#p1393400">2014-03-17 14:45:01</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=75590">aw</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2013-10-04</span></dd> <dd><span>Posts: 921</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=75590">Email</a></span> <span class="website"><a href="http://vfio.blogspot.com/" rel="nofollow">Website</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>novist wrote:</cite><blockquote><div><p>EDIT:<br />Im adding benchmark that does not make any sense. As you notice DirectCompute and especially DirectX 11 are more than one could wish for. However complex directx9 is right down the toilet. My brain cant figure out any scenario where this would make sense. It is sad because most of the games nowdays are still directx9 <img src="https://bbs.archlinux.org/img/smilies/neutral.png" width="15" height="15" alt="neutral" /><br /><a href="http://i61.tinypic.com/ictrgo.png" rel="nofollow">http://i61.tinypic.com/ictrgo.png</a></p></div></blockquote></div><p>What is this benchmark?</p> </div> <div class="postsignature postmsg"><hr /><p><a href="http://vfio.blogspot.com" rel="nofollow">http://vfio.blogspot.com</a><br />Looking for a more open forum to discuss vfio related uses?&#160; Try <a href="https://www.redhat.com/mailman/listinfo/vfio-users" rel="nofollow">https://www.redhat.com/mailman/listinfo/vfio-users</a></p></div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1393400">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1393417" class="blockpost roweven"> <h2><span><span class="conr">#1368</span> <a href="viewtopic.php?pid=1393417#p1393417">2014-03-17 15:20:46</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=80279">novist</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2014-03-14</span></dd> <dd><span>Posts: 34</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=80279">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>aw wrote:</cite><blockquote><div><div class="quotebox"><cite>novist wrote:</cite><blockquote><div><p>EDIT:<br />Im adding benchmark that does not make any sense. As you notice DirectCompute and especially DirectX 11 are more than one could wish for. However complex directx9 is right down the toilet. My brain cant figure out any scenario where this would make sense. It is sad because most of the games nowdays are still directx9 <img src="https://bbs.archlinux.org/img/smilies/neutral.png" width="15" height="15" alt="neutral" /><br /><a href="http://i61.tinypic.com/ictrgo.png" rel="nofollow">http://i61.tinypic.com/ictrgo.png</a></p></div></blockquote></div><p>What is this benchmark?</p></div></blockquote></div><p>passmark performance test ( <a href="https://www.passmark.com/products/pt.htm" rel="nofollow">https://www.passmark.com/products/pt.htm</a> )</p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1393417">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1393426" class="blockpost rowodd"> <h2><span><span class="conr">#1369</span> <a href="viewtopic.php?pid=1393426#p1393426">2014-03-17 15:46:58</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=75590">aw</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2013-10-04</span></dd> <dd><span>Posts: 921</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=75590">Email</a></span> <span class="website"><a href="http://vfio.blogspot.com/" rel="nofollow">Website</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>novist wrote:</cite><blockquote><div><div class="quotebox"><cite>aw wrote:</cite><blockquote><div><div class="quotebox"><cite>novist wrote:</cite><blockquote><div><p>EDIT:<br />Im adding benchmark that does not make any sense. As you notice DirectCompute and especially DirectX 11 are more than one could wish for. However complex directx9 is right down the toilet. My brain cant figure out any scenario where this would make sense. It is sad because most of the games nowdays are still directx9 <img src="https://bbs.archlinux.org/img/smilies/neutral.png" width="15" height="15" alt="neutral" /><br /><a href="http://i61.tinypic.com/ictrgo.png" rel="nofollow">http://i61.tinypic.com/ictrgo.png</a></p></div></blockquote></div><p>What is this benchmark?</p></div></blockquote></div><p>passmark performance test ( <a href="https://www.passmark.com/products/pt.htm" rel="nofollow">https://www.passmark.com/products/pt.htm</a> )</p></div></blockquote></div><p>Ok, last time I tried passmark the VM blue screened regardless of having an assigned GPU.&#160; I&#039;ll try it again.</p> </div> <div class="postsignature postmsg"><hr /><p><a href="http://vfio.blogspot.com" rel="nofollow">http://vfio.blogspot.com</a><br />Looking for a more open forum to discuss vfio related uses?&#160; Try <a href="https://www.redhat.com/mailman/listinfo/vfio-users" rel="nofollow">https://www.redhat.com/mailman/listinfo/vfio-users</a></p></div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1393426">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1393538" class="blockpost roweven"> <h2><span><span class="conr">#1370</span> <a href="viewtopic.php?pid=1393538#p1393538">2014-03-17 18:59:02</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=80028">trimm</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2014-03-06</span></dd> <dd><span>Posts: 31</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=80028">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <p>Hello again guys.</p><p>I wanted to give you an quick update on my setup.<br />I had a 1TB raw image partitioned on a BTRFS drive and it was unbearable slow. It took ages loading stuff (however, writing did not seem that bad).</p><p>I fixed it by following Arch guide(disabling CoW): <a href="https://wiki.archlinux.org/index.php/Btrfs" rel="nofollow">https://wiki.archlinux.org/index.php/Btrfs</a></p><div class="codebox"><pre><code>$ mv /path/to/dir /path/to/dir_old $ mkdir /path/to/dir $ chattr +C /path/to/dir $ cp /path/to/dir_old/* /path/to/dir $ rm -rf /path/to/dir_old</code></pre></div><p>Now its as fast as it can be and games load much, much faster.</p><p>Another thing though, and its my sound. I gave up on passing through my USB headset(crackling noise) and sharing sound between my host and guest. (I tried following the first post without success)<br />Im thinking I can passthrough my integrated sound on the motherboard, and I tried doing it like this:</p><p>Binding the sound:</p><div class="codebox"><pre><code>vfio-pci 0000:00:1b.0</code></pre></div><p>In my dmesg I get the following: </p><div class="codebox"><pre><code>vfio-pci 0000:00:1b.0: kvm assign device</code></pre></div><p>And in my script I have this:</p><div class="codebox"><pre><code>-device vfio-pci,host=00:1b.0</code></pre></div><p>No errors in Linux, but I get a red mark over my audio icon in Windows. Going into &quot;sound&quot; tab inside audio properties and the whole VM totally freezes.</p><p>I passthroughed with vfio-pci, a drive and my secondary network card without any issues, however I have not had any success with audio.<br />I have also passthroughed my Xbox Controller and Rocksmith USB adapter.</p><p>Any help is appreciated!</p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1393538">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1393589" class="blockpost rowodd"> <h2><span><span class="conr">#1371</span> <a href="viewtopic.php?pid=1393589#p1393589">2014-03-17 20:48:31</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=80088">pereczes</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2014-03-08</span></dd> <dd><span>Posts: 14</span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <p>anybody tried and succeeded with ATIWinflash to reflash radeon card under qemu?</p><p>I tried ... but completely corrupted bios. Now booted with qxl, TechPowerUp GPU-Z can see the card but BIos Version is just a messy string.</p><p>Another strange thing is that my 6950 was showing 768 Shaders, though everybody is reporting double the ammount. It is like I would have only one core.</p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1393589">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1393597" class="blockpost roweven"> <h2><span><span class="conr">#1372</span> <a href="viewtopic.php?pid=1393597#p1393597">2014-03-17 20:54:59</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=75590">aw</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2013-10-04</span></dd> <dd><span>Posts: 921</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=75590">Email</a></span> <span class="website"><a href="http://vfio.blogspot.com/" rel="nofollow">Website</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>pereczes wrote:</cite><blockquote><div><p>anybody tried and succeeded with ATIWinflash to reflash radeon card under qemu?</p></div></blockquote></div><p>I would <strong>strongly</strong> discourage this.&#160; The ROM BAR is entirely emulated to the guest, we enable and read the ROM on the first guest access, from then on the guest only reads from the cached copy.&#160; Any sort of ROM update utility is likely to get very, very confused by this.</p> </div> <div class="postsignature postmsg"><hr /><p><a href="http://vfio.blogspot.com" rel="nofollow">http://vfio.blogspot.com</a><br />Looking for a more open forum to discuss vfio related uses?&#160; Try <a href="https://www.redhat.com/mailman/listinfo/vfio-users" rel="nofollow">https://www.redhat.com/mailman/listinfo/vfio-users</a></p></div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1393597">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1393601" class="blockpost rowodd"> <h2><span><span class="conr">#1373</span> <a href="viewtopic.php?pid=1393601#p1393601">2014-03-17 20:59:30</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=75590">aw</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2013-10-04</span></dd> <dd><span>Posts: 921</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=75590">Email</a></span> <span class="website"><a href="http://vfio.blogspot.com/" rel="nofollow">Website</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>trimm wrote:</cite><blockquote><div><p>Another thing though, and its my sound. I gave up on passing through my USB headset(crackling noise) and sharing sound between my host and guest. (I tried following the first post without success)<br />Im thinking I can passthrough my integrated sound on the motherboard, and I tried doing it like this:</p><p>Binding the sound:</p><div class="codebox"><pre><code>vfio-pci 0000:00:1b.0</code></pre></div><p>In my dmesg I get the following: </p><div class="codebox"><pre><code>vfio-pci 0000:00:1b.0: kvm assign device</code></pre></div><p>And in my script I have this:</p><div class="codebox"><pre><code>-device vfio-pci,host=00:1b.0</code></pre></div><p>No errors in Linux, but I get a red mark over my audio icon in Windows. Going into &quot;sound&quot; tab inside audio properties and the whole VM totally freezes.</p><p>I passthroughed with vfio-pci, a drive and my secondary network card without any issues, however I have not had any success with audio.<br />I have also passthroughed my Xbox Controller and Rocksmith USB adapter.</p><p>Any help is appreciated!</p></div></blockquote></div><p>I haven&#039;t had any trouble passing HDA audio from the chipset through to the guest.&#160; I notice a discrepancy in your process though, the string &quot;kvm assign device&quot; is only printed out by virt/kvm/iommu.c:kvm_assign_device() which is only called if using pci-assign instead of vfio-pci.&#160; AFAIK either will work, but I don&#039;t know what to trust in your report...</p> </div> <div class="postsignature postmsg"><hr /><p><a href="http://vfio.blogspot.com" rel="nofollow">http://vfio.blogspot.com</a><br />Looking for a more open forum to discuss vfio related uses?&#160; Try <a href="https://www.redhat.com/mailman/listinfo/vfio-users" rel="nofollow">https://www.redhat.com/mailman/listinfo/vfio-users</a></p></div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1393601">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1393614" class="blockpost roweven"> <h2><span><span class="conr">#1374</span> <a href="viewtopic.php?pid=1393614#p1393614">2014-03-17 21:18:10</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=80378">stefan_vgapass</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2014-03-17</span></dd> <dd><span>Posts: 2</span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <p>Hi KVM vga passthrough enthusiasts,</p><p>&#160; &#160;Thank you so much for your posts, they were invaluable for a KVM vga passthrough beginner like myself to be able to find my way through this unknown teritory.<br />&#160; &#160;<br />&#160; &#160;I can confirm that I&#039;ve finally got KVM vga passthrough working with an windows 7 x64 guest.<br />&#160; &#160;What finally helped is something from FruitieX&#039;s post that made me realize I was still trying to get vga passthrough to work with a 3 month old qemu, so I tried qemu git which worked.<br />&#160; &#160;</p><div class="quotebox"><cite>FruitieX wrote:</cite><blockquote><div><p>1. Compiled latest qemu and seabios from git, used these.</p></div></blockquote></div><p>&#160; &#160;FruitieX&#039;s post - <a href="https://bbs.archlinux.org/viewtopic.php?pid=1390326#p1390326" rel="nofollow">https://bbs.archlinux.org/viewtopic.php … 6#p1390326</a><br />&#160; &#160;<br /><strong>Specs:</strong></p><div class="quotebox"><blockquote><div><p>Mainboard: intel DX79TO <a href="http://ark.intel.com/products/55800/Intel-Desktop-Board-DX79TO" rel="nofollow">http://ark.intel.com/products/55800/Int … ard-DX79TO</a><br />CPU: Intel(R) Core(TM) i7-3820 CPU @ 3.60GHz<br />Host graphics card: Asus Nvidia GeForce GT 620 2GB mem<br />Guest graphics card ( passed to the windows guest ): XFX Radeon HD 7850 2GB mem<br />Host OS: headless Ubuntu 12.04.3 LTS x64<br />Host kernel: Linux engine 3.14.0-031400rc5-generic #201403022235 SMP Mon Mar 3 03:36:27 UTC 2014 x86_64 x86_64 x86_64 GNU/Linux<br />Guest OS: windows 7 ultimate x64<br />Guest OS disk: virtio ( running 2 virtual HDDs - win7 is a hog after installation ~ 20GB of diskspace used so I&#039;ve added a second disk )<br />Guest Network: virtio bridged network</p></div></blockquote></div><p>I&#039;m passing to the windows guest the ATI VGA ( without HDMI ), an usb port, and the onboard Intel HDA sound card therefore getting video, usb and audio inside my windows guest.</p><br /><p>&#160; &#160;Initially I thought that I need to compile all VFIO kernel module in the kernel ( not as modules ) so I spent time compiling 3.14.0 with .*VFIO=y .<br />&#160; &#160;Then I booted accidentally back into the original ubuntu built 3.14 and KVM vga passthrough works fine, with these <strong>kernel modules</strong></p><div class="codebox"><pre><code># grep VFIO /boot/config-3.14.0-031400rc5-generic CONFIG_VFIO_IOMMU_TYPE1=m CONFIG_VFIO=m CONFIG_VFIO_PCI=m CONFIG_VFIO_PCI_VGA=y CONFIG_KVM_VFIO=y</code></pre></div><p>&#160; &#160;I used latest qemu-git and seabios from git.<br />&#160; &#160;I&#039;ve configured pci_stub to bind to the 3 components that I&#039;m passing to the VM by re-building initramfs like this:</p><div class="codebox"><pre><code>vim /etc/initramfs-tools/modules pci_stub ids=1002:6819,1002:aab0,8086:1d20 sudo update-initramfs -u</code></pre></div><p>&#160; &#160;This is how I boot the windows guest ( using vfio-pci to bind before this qemu command - see original post #1 for vfio-pci ) :</p><div class="codebox"><pre><code>/opt/qemu-git/bin/qemu-system-x86_64 -enable-kvm -M q35 \ -m 8196 -mem-prealloc -mem-path /mnt/hugepages \ -cpu SandyBridge \ -smp 4,sockets=1,cores=2,threads=2 \ -bios /root/kvm-vga-passthrough/vfio-post3.13/seabios/seabios/out/bios.bin -vga none \ -boot order=cd,menu=on \ -device ioh3420,bus=pcie.0,addr=1c.0,multifunction=on,port=1,chassis=1,id=root.1 \ -device vfio-pci,host=04:00.0,bus=root.1,addr=00.0,multifunction=on,x-vga=on \ -device vfio-pci,host=00:1d.0,bus=root.1,addr=00.1 \ -device vfio-pci,host=00:1b.0,bus=root.1,addr=00.2 \ -device ahci,bus=pcie.0,id=ahci \ -netdev bridge,br=br0,id=hostnet0 \ -device virtio-net-pci,netdev=hostnet0,id=net0 \ -drive file=/var/lib/libvirt/images/wind764test02.img,id=disk,format=raw -device ide-hd,bus=ahci.0,drive=disk \ -drive file=/var/lib/libvirt/images/wind764test02-disk02.img,id=disk02,format=raw -device ide-hd,bus=ahci.1,drive=disk02 \ -drive file=/var/lib/libvirt/images/Windows.7.SP1.ENG.x86-x64.iso,id=isocd -device ide-cd,bus=ahci.2,drive=isocd</code></pre></div><p><strong>Tip:</strong><br />In order to be able to use bridged network I had to tell qemu-git to allow it in:</p><div class="codebox"><pre><code># cat /opt/qemu-git/conf/bridge.conf allow br0</code></pre></div><p><strong>Tests:</strong><br />I&#039;ve ran unigine heaven and valley tests ( don&#039;t know how they compare with running with windows 7 as host os )<br /><strong>Unigine valley</strong> <a href="https://unigine.com/products/valley/" rel="nofollow">https://unigine.com/products/valley/</a></p><div class="codebox"><pre><code>Unigine Valley Benchmark 1.0 FPS: 33.4 Score: 1396 Min FPS: 18.3 Max FPS: 60.9 System Platform: Windows 7 (build 7601, Service Pack 1) 64bit CPU model: Intel Xeon E312xx (Sandy Bridge) (3599MHz) x2 GPU model: AMD Radeon HD 7800 Series 13.251.0.0 (2048MB) x1 Settings Render: Direct3D11 Mode: 1920x1200 2xAA fullscreen Preset Custom Quality High</code></pre></div><p><strong>Unigine heaven</strong> <a href="https://unigine.com/products/heaven/" rel="nofollow">https://unigine.com/products/heaven/</a></p><div class="codebox"><pre><code>Unigine Heaven Benchmark 4.0 FPS: 31.7 Score: 798 Min FPS: 7.3 Max FPS: 62.7 System Platform: Windows 7 (build 7601, Service Pack 1) 64bit CPU model: Intel Xeon E312xx (Sandy Bridge) (3599MHz) x2 GPU model: AMD Radeon HD 7800 Series 13.251.0.0 (2048MB) x1 Settings Render: Direct3D11 Mode: 1920x1200 2xAA fullscreen Preset Custom Quality High Tessellation: Moderate</code></pre></div><p>I&#039;ve ran crysis 3 demo with 1920x1200 antialiasing 2x smooth no issues.<br />I&#039;ve ran starcraft 2 max settings 1920x1200 no issues.</p><p>Next things to try: KVM vga passthrough with a linux guest and Steam client running on the ATI HD7850 !</p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1393614">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1393618" class="blockpost rowodd"> <h2><span><span class="conr">#1375</span> <a href="viewtopic.php?pid=1393618#p1393618">2014-03-17 21:27:15</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=80088">pereczes</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2014-03-08</span></dd> <dd><span>Posts: 14</span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>aw wrote:</cite><blockquote><div><div class="quotebox"><cite>pereczes wrote:</cite><blockquote><div><p>anybody tried and succeeded with ATIWinflash to reflash radeon card under qemu?</p></div></blockquote></div><p>I would <strong>strongly</strong> discourage this.&#160; The ROM BAR is entirely emulated to the guest, we enable and read the ROM on the first guest access, from then on the guest only reads from the cached copy.&#160; Any sort of ROM update utility is likely to get very, very confused by this.</p></div></blockquote></div><p>tried it already... probably could not damage.. saw afterwards following output on my terminal</p><div class="codebox"><pre><code>Device option ROM contents are probably invalid (check dmesg). Skip option ROM probe with rombar=0, or load from file with romfile= qemu-system-x86_64: vfio-pci: Cannot read device rom at 0000:04:00.0</code></pre></div><p>added though </p><div class="codebox"><pre><code>-device vfio-pci,host=04:00.0,bus=root.1,multifunction=on,x-vga=on,addr=0.0,romfile=$ROMBIOSPATH/Powercolor.HD6970.2048.110221.rom</code></pre></div><p>but strange enough GPU-Z, reports the increase of shaders (6950 versus 6970) and increase of freq 800 versus 880, but <br />the number of shaders is half, as one of the cores would not be able...</p><p>-&gt; is there any other way to check if both cores are active or GPU-Z is right?<br />-&gt; is there any way from linux to reload the ROM?</p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1393618">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div class="postlinksb"> <div class="inbox crumbsplus"> <div class="pagepost"> <p class="pagelink conl"><span class="pages-label">Pages: </span><a rel="prev" class="item1" href="viewtopic.php?id=162768&amp;p=54">Previous</a> <a href="viewtopic.php?id=162768">1</a> <span class="spacer">…</span> <a href="viewtopic.php?id=162768&amp;p=53">53</a> <a href="viewtopic.php?id=162768&amp;p=54">54</a> <strong>55</strong> <a href="viewtopic.php?id=162768&amp;p=56">56</a> <a href="viewtopic.php?id=162768&amp;p=57">57</a> <span class="spacer">…</span> <a href="viewtopic.php?id=162768&amp;p=234">234</a> <a rel="next" href="viewtopic.php?id=162768&amp;p=56">Next</a></p> <p class="postlink conr">Topic closed</p> </div> <ul class="crumbs"> <li><a href="index.php">Index</a></li> <li><span>»&#160;</span><a href="viewforum.php?id=48">Topics Going Nowhere</a></li> <li><span>»&#160;</span><strong><a href="viewtopic.php?id=162768">KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</a></strong></li> </ul> <p class="subscribelink clearb"><a href="misc.php?action=subscribe&amp;tid=162768">Subscribe to this topic</a></p> <div class="clearer"></div> </div> </div> </div> <div id="brdfooter" class="block"> <h2><span>Board footer</span></h2> <div class="box"> <div id="brdfooternav" class="inbox"> <div class="conl"> <form id="qjump" method="get" action="viewforum.php"> <div><label><span>Jump to<br /></span> <select name="id" onchange="window.location=('viewforum.php?id='+this.options[this.selectedIndex].value)"> <optgroup label="Technical Issues and Assistance"> <option value="23">Newbie Corner</option> <option value="17">Installation</option> <option value="22">Kernel &amp; Hardware</option> <option value="18">Applications &amp; Desktop Environments</option> <option value="31">Laptop Issues</option> <option value="8">Networking, Server, and Protection</option> <option value="32">Multimedia and Games</option> <option value="50">System Administration</option> <option value="35">Other Architectures</option> </optgroup> <optgroup label="Arch-centric"> <option value="24">Announcements, Package &amp; Security Advisories</option> <option value="1">Arch Discussion</option> <option value="13">Forum &amp; Wiki discussion</option> </optgroup> <optgroup label="Pacman Upgrades, Packaging &amp; AUR"> <option value="44">Pacman &amp; Package Upgrade Issues</option> <option value="49">[testing] Repo Forum</option> <option value="4">Creating &amp; Modifying Packages</option> <option value="38">AUR Issues, Discussion &amp; PKGBUILD Requests</option> </optgroup> <optgroup label="Contributions &amp; Discussion"> <option value="20">GNU/Linux Discussion</option> <option value="27">Community Contributions</option> <option value="33">Programming &amp; Scripting</option> <option value="30">Other Languages</option> <option value="47">Artwork and Screenshots</option> <option value="42">Try This</option> </optgroup> <optgroup label="/dev/null"> <option value="29">Off-Topic</option> <option value="48" selected="selected">Topics Going Nowhere</option> <option value="36">Dustbin</option> </optgroup> </select></label> <input type="submit" value=" Go " accesskey="g" /> </div> </form> </div> <div class="conr"> <p id="feedlinks"><span class="atom"><a href="extern.php?action=feed&amp;tid=162768&amp;type=atom">Atom topic feed</a></span></p> <p id="poweredby">Powered by <a href="http://fluxbb.org/">FluxBB</a></p> </div> <div class="clearer"></div> </div> </div> </div> </div> <div class="end-box"></div> </div> </body> </html>
