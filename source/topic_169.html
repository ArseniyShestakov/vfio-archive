<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"> <html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en" dir="ltr"> <head> <meta http-equiv="Content-Type" content="text/html; charset=utf-8" /> <title>KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9 (Page 169) / Topics Going Nowhere / Arch Linux Forums</title> <link rel="stylesheet" type="text/css" href="style/ArchLinux.css" /> <link rel="canonical" href="viewtopic.php?id=162768&amp;p=169" title="Page 169" /> <link rel="prev" href="viewtopic.php?id=162768&amp;p=168" title="Page 168" /> <link rel="next" href="viewtopic.php?id=162768&amp;p=170" title="Page 170" /> <link rel="alternate" type="application/atom+xml" href="extern.php?action=feed&amp;tid=162768&amp;type=atom" title="Atom topic feed" /> <link rel="stylesheet" media="screen" href="style/ArchLinux/arch.css?v=3" /> <link rel="stylesheet" media="screen" href="style/ArchLinux/archnavbar.css?v=2" /> <link rel="shortcut icon" href="style/ArchLinux/favicon.ico" /> </head> <body> <div id="archnavbar" class="anb-forum"> <div id="archnavbarlogo"><h1><a href="http://www.archlinux.org/">Arch Linux</a></h1></div> <div id="archnavbarmenu"> <ul id="archnavbarlist"> <li id="anb-home"><a href="http://www.archlinux.org/">Home</a></li><li id="anb-packages"><a href="http://www.archlinux.org/packages/">Packages</a></li><li id="anb-forums" class="anb-selected"><a href="https://bbs.archlinux.org/">Forums</a></li><li id="anb-wiki"><a href="https://wiki.archlinux.org/">Wiki</a></li><li id="anb-bugs"><a href="https://bugs.archlinux.org/">Bugs</a></li><li id="anb-aur"><a href="https://aur.archlinux.org/">AUR</a></li><li id="anb-download"><a href="http://www.archlinux.org/download/">Download</a></li> </ul> </div> </div> <div id="punviewtopic" class="pun"> <div class="top-box"></div> <div class="punwrap"> <div id="brdheader" class="block"> <div class="box"> <div id="brdmenu" class="inbox"> <ul> <li id="navindex" class="isactive"><a href="index.php">Index</a></li> <li id="navuserlist"><a href="userlist.php">User list</a></li> <li id="navsearch"><a href="search.php">Search</a></li> <li id="navprofile"><a href="profile.php?id=80749">Profile</a></li> <li id="navlogout"><a href="login.php?action=out&amp;id=80749&amp;csrf_token=5c20501ec397bb45ef8ee8c84db232c8d8e421c6">Logout</a></li> </ul> </div> <div id="brdwelcome" class="inbox"> <ul class="conl"> <li><span>Logged in as <strong>SXX</strong></span></li> <li><span>Last visit: 2015-08-16 12:20:09</span></li> </ul> <ul class="conr"> <li><span>Topics: <a href="search.php?action=show_replies" title="Find topics you have posted to.">Posted</a> | <a href="search.php?action=show_new" title="Find topics with new posts since your last visit.">New</a> | <a href="search.php?action=show_recent" title="Find topics with recent posts.">Active</a> | <a href="search.php?action=show_unanswered" title="Find topics with no replies.">Unanswered</a></span></li> </ul> <div class="clearer"></div> </div> </div> </div> <div id="brdmain"> <div class="linkst"> <div class="inbox crumbsplus"> <ul class="crumbs"> <li><a href="index.php">Index</a></li> <li><span>»&#160;</span><a href="viewforum.php?id=48">Topics Going Nowhere</a></li> <li><span>»&#160;</span><strong><a href="viewtopic.php?id=162768">KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</a></strong></li> </ul> <div class="pagepost"> <p class="pagelink conl"><span class="pages-label">Pages: </span><a rel="prev" class="item1" href="viewtopic.php?id=162768&amp;p=168">Previous</a> <a href="viewtopic.php?id=162768">1</a> <span class="spacer">…</span> <a href="viewtopic.php?id=162768&amp;p=167">167</a> <a href="viewtopic.php?id=162768&amp;p=168">168</a> <strong>169</strong> <a href="viewtopic.php?id=162768&amp;p=170">170</a> <a href="viewtopic.php?id=162768&amp;p=171">171</a> <span class="spacer">…</span> <a href="viewtopic.php?id=162768&amp;p=234">234</a> <a rel="next" href="viewtopic.php?id=162768&amp;p=170">Next</a></p> <p class="postlink conr">Topic closed</p> </div> <div class="clearer"></div> </div> </div> <div id="p1503490" class="blockpost rowodd blockpost1"> <h2><span><span class="conr">#4201</span> <a href="viewtopic.php?pid=1503490#p1503490">2015-02-16 14:47:39</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=82382">avengerf12</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2014-05-30</span></dd> <dd><span>Posts: 2</span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <p>Hello everyone, first of all thanks to everyone who contributed to this great forum post, it has been immensely useful to configure my setup.</p><p>Second, I&#039;m having a bit of a problem with the CPU configuration in a Windows 8.1 VM. <br />I&#039;m currently assigning 6 vcpus to my real cpu using libvirt and when i start the VM for the first time everything works flawlessly, but if I shutdown the VM and start it again without rebooting the computer it freezes the whole host. Searching through the thread about this issue only results in a few posts suggesting to use the &quot;isolcpus&quot; argument in the kernel commandline to avoid any conflict. Unfortunately it didn&#039;t work and so I was hoping if someone here had any idea of what the problem could be.</p><p>This is my current config</p><div class="codebox"><pre class="vscroll"><code>&lt;domain type=&#039;kvm&#039;&gt; &lt;name&gt;win8.1&lt;/name&gt; &lt;uuid&gt;f3aa271e-8184-4a56-9bf5-ffbacc2f1511&lt;/uuid&gt; &lt;memory unit=&#039;KiB&#039;&gt;6291456&lt;/memory&gt; &lt;currentMemory unit=&#039;KiB&#039;&gt;6291456&lt;/currentMemory&gt; &lt;vcpu placement=&#039;static&#039; cpuset=&#039;6-11&#039;&gt;6&lt;/vcpu&gt; &lt;cputune&gt; &lt;vcpupin vcpu=&#039;0&#039; cpuset=&#039;6&#039;/&gt; &lt;vcpupin vcpu=&#039;1&#039; cpuset=&#039;7&#039;/&gt; &lt;vcpupin vcpu=&#039;2&#039; cpuset=&#039;8&#039;/&gt; &lt;vcpupin vcpu=&#039;3&#039; cpuset=&#039;9&#039;/&gt; &lt;vcpupin vcpu=&#039;4&#039; cpuset=&#039;10&#039;/&gt; &lt;vcpupin vcpu=&#039;5&#039; cpuset=&#039;11&#039;/&gt; &lt;emulatorpin cpuset=&#039;6-11&#039;/&gt; &lt;/cputune&gt; &lt;os&gt; &lt;type arch=&#039;x86_64&#039; machine=&#039;pc-i440fx-2.2&#039;&gt;hvm&lt;/type&gt; &lt;loader type=&#039;pflash&#039;&gt;/usr/share/ovmf/ovmf_x64.bin&lt;/loader&gt; &lt;bootmenu enable=&#039;yes&#039;/&gt; &lt;/os&gt; &lt;features&gt; &lt;acpi/&gt; &lt;apic/&gt; &lt;pae/&gt; &lt;hyperv&gt; &lt;relaxed state=&#039;on&#039;/&gt; &lt;vapic state=&#039;on&#039;/&gt; &lt;spinlocks state=&#039;on&#039; retries=&#039;8191&#039;/&gt; &lt;/hyperv&gt; &lt;kvm&gt; &lt;hidden state=&#039;on&#039;/&gt; &lt;/kvm&gt; &lt;/features&gt; &lt;cpu mode=&#039;host-passthrough&#039;&gt; &lt;feature policy=&#039;require&#039; name=&#039;pbe&#039;/&gt; &lt;feature policy=&#039;require&#039; name=&#039;tm2&#039;/&gt; &lt;feature policy=&#039;require&#039; name=&#039;est&#039;/&gt; &lt;feature policy=&#039;require&#039; name=&#039;vmx&#039;/&gt; &lt;feature policy=&#039;require&#039; name=&#039;osxsave&#039;/&gt; &lt;feature policy=&#039;require&#039; name=&#039;ss&#039;/&gt; &lt;feature policy=&#039;require&#039; name=&#039;ds&#039;/&gt; &lt;feature policy=&#039;require&#039; name=&#039;vme&#039;/&gt; &lt;feature policy=&#039;require&#039; name=&#039;dtes64&#039;/&gt; &lt;feature policy=&#039;require&#039; name=&#039;monitor&#039;/&gt; &lt;feature policy=&#039;require&#039; name=&#039;ht&#039;/&gt; &lt;feature policy=&#039;require&#039; name=&#039;dca&#039;/&gt; &lt;feature policy=&#039;require&#039; name=&#039;pcid&#039;/&gt; &lt;feature policy=&#039;require&#039; name=&#039;tm&#039;/&gt; &lt;feature policy=&#039;require&#039; name=&#039;pdcm&#039;/&gt; &lt;feature policy=&#039;require&#039; name=&#039;pdpe1gb&#039;/&gt; &lt;feature policy=&#039;require&#039; name=&#039;ds_cpl&#039;/&gt; &lt;feature policy=&#039;require&#039; name=&#039;xtpr&#039;/&gt; &lt;feature policy=&#039;require&#039; name=&#039;acpi&#039;/&gt; &lt;feature policy=&#039;require&#039; name=&#039;invtsc&#039;/&gt; &lt;/cpu&gt; &lt;clock offset=&#039;localtime&#039;&gt; &lt;timer name=&#039;rtc&#039; tickpolicy=&#039;catchup&#039;/&gt; &lt;timer name=&#039;pit&#039; tickpolicy=&#039;delay&#039;/&gt; &lt;timer name=&#039;hpet&#039; present=&#039;no&#039;/&gt; &lt;timer name=&#039;hypervclock&#039; present=&#039;yes&#039;/&gt; &lt;/clock&gt; &lt;on_poweroff&gt;destroy&lt;/on_poweroff&gt; &lt;on_reboot&gt;restart&lt;/on_reboot&gt; &lt;on_crash&gt;restart&lt;/on_crash&gt; &lt;pm&gt; &lt;suspend-to-mem enabled=&#039;no&#039;/&gt; &lt;suspend-to-disk enabled=&#039;no&#039;/&gt; &lt;/pm&gt; &lt;devices&gt; &lt;emulator&gt;/usr/sbin/qemu-system-x86_64&lt;/emulator&gt; &lt;disk type=&#039;file&#039; device=&#039;cdrom&#039;&gt; &lt;driver name=&#039;qemu&#039; type=&#039;raw&#039;/&gt; &lt;source file=&#039;/media/Linux-Drive/VM/Windows/Windows8Pro.iso&#039;/&gt; &lt;target dev=&#039;hda&#039; bus=&#039;ide&#039;/&gt; &lt;readonly/&gt; &lt;boot order=&#039;2&#039;/&gt; &lt;address type=&#039;drive&#039; controller=&#039;0&#039; bus=&#039;0&#039; target=&#039;0&#039; unit=&#039;0&#039;/&gt; &lt;/disk&gt; &lt;disk type=&#039;file&#039; device=&#039;cdrom&#039;&gt; &lt;driver name=&#039;qemu&#039; type=&#039;raw&#039;/&gt; &lt;source file=&#039;/media/Linux-Drive/VM/Windows/virtio.iso&#039;/&gt; &lt;target dev=&#039;hdb&#039; bus=&#039;ide&#039;/&gt; &lt;readonly/&gt; &lt;address type=&#039;drive&#039; controller=&#039;0&#039; bus=&#039;0&#039; target=&#039;0&#039; unit=&#039;1&#039;/&gt; &lt;/disk&gt; &lt;disk type=&#039;file&#039; device=&#039;cdrom&#039;&gt; &lt;driver name=&#039;qemu&#039; type=&#039;raw&#039;/&gt; &lt;source file=&#039;/media/Linux-Drive/VM/Windows/Windows8Pro.iso&#039;/&gt; &lt;target dev=&#039;hdc&#039; bus=&#039;ide&#039;/&gt; &lt;readonly/&gt; &lt;address type=&#039;drive&#039; controller=&#039;0&#039; bus=&#039;1&#039; target=&#039;0&#039; unit=&#039;0&#039;/&gt; &lt;/disk&gt; &lt;disk type=&#039;file&#039; device=&#039;disk&#039;&gt; &lt;driver name=&#039;qemu&#039; type=&#039;raw&#039;/&gt; &lt;source file=&#039;/media/vm-drives/WBoot.img&#039;/&gt; &lt;target dev=&#039;sda&#039; bus=&#039;scsi&#039;/&gt; &lt;boot order=&#039;1&#039;/&gt; &lt;address type=&#039;drive&#039; controller=&#039;0&#039; bus=&#039;0&#039; target=&#039;0&#039; unit=&#039;0&#039;/&gt; &lt;/disk&gt; &lt;disk type=&#039;block&#039; device=&#039;disk&#039;&gt; &lt;driver name=&#039;qemu&#039; type=&#039;raw&#039; cache=&#039;none&#039; io=&#039;native&#039;/&gt; &lt;source dev=&#039;/dev/sda1&#039;/&gt; &lt;target dev=&#039;sdb&#039; bus=&#039;scsi&#039;/&gt; &lt;address type=&#039;drive&#039; controller=&#039;0&#039; bus=&#039;0&#039; target=&#039;0&#039; unit=&#039;1&#039;/&gt; &lt;/disk&gt; &lt;controller type=&#039;usb&#039; index=&#039;0&#039; model=&#039;ich9-ehci1&#039;&gt; &lt;address type=&#039;pci&#039; domain=&#039;0x0000&#039; bus=&#039;0x00&#039; slot=&#039;0x06&#039; function=&#039;0x7&#039;/&gt; &lt;/controller&gt; &lt;controller type=&#039;usb&#039; index=&#039;0&#039; model=&#039;ich9-uhci1&#039;&gt; &lt;master startport=&#039;0&#039;/&gt; &lt;address type=&#039;pci&#039; domain=&#039;0x0000&#039; bus=&#039;0x00&#039; slot=&#039;0x06&#039; function=&#039;0x0&#039; multifunction=&#039;on&#039;/&gt; &lt;/controller&gt; &lt;controller type=&#039;usb&#039; index=&#039;0&#039; model=&#039;ich9-uhci2&#039;&gt; &lt;master startport=&#039;2&#039;/&gt; &lt;address type=&#039;pci&#039; domain=&#039;0x0000&#039; bus=&#039;0x00&#039; slot=&#039;0x06&#039; function=&#039;0x1&#039;/&gt; &lt;/controller&gt; &lt;controller type=&#039;usb&#039; index=&#039;0&#039; model=&#039;ich9-uhci3&#039;&gt; &lt;master startport=&#039;4&#039;/&gt; &lt;address type=&#039;pci&#039; domain=&#039;0x0000&#039; bus=&#039;0x00&#039; slot=&#039;0x06&#039; function=&#039;0x2&#039;/&gt; &lt;/controller&gt; &lt;controller type=&#039;scsi&#039; index=&#039;0&#039; model=&#039;virtio-scsi&#039;&gt; &lt;address type=&#039;pci&#039; domain=&#039;0x0000&#039; bus=&#039;0x00&#039; slot=&#039;0x05&#039; function=&#039;0x0&#039;/&gt; &lt;/controller&gt; &lt;controller type=&#039;pci&#039; index=&#039;0&#039; model=&#039;pci-root&#039;/&gt; &lt;controller type=&#039;ide&#039; index=&#039;0&#039;&gt; &lt;address type=&#039;pci&#039; domain=&#039;0x0000&#039; bus=&#039;0x00&#039; slot=&#039;0x01&#039; function=&#039;0x1&#039;/&gt; &lt;/controller&gt; &lt;controller type=&#039;virtio-serial&#039; index=&#039;0&#039;&gt; &lt;address type=&#039;pci&#039; domain=&#039;0x0000&#039; bus=&#039;0x00&#039; slot=&#039;0x07&#039; function=&#039;0x0&#039;/&gt; &lt;/controller&gt; &lt;interface type=&#039;network&#039;&gt; &lt;mac address=&#039;52:54:00:fb:c5:e7&#039;/&gt; &lt;source network=&#039;default&#039;/&gt; &lt;model type=&#039;rtl8139&#039;/&gt; &lt;address type=&#039;pci&#039; domain=&#039;0x0000&#039; bus=&#039;0x00&#039; slot=&#039;0x03&#039; function=&#039;0x0&#039;/&gt; &lt;/interface&gt; &lt;serial type=&#039;pty&#039;&gt; &lt;target port=&#039;0&#039;/&gt; &lt;/serial&gt; &lt;console type=&#039;pty&#039;&gt; &lt;target type=&#039;serial&#039; port=&#039;0&#039;/&gt; &lt;/console&gt; &lt;channel type=&#039;spicevmc&#039;&gt; &lt;target type=&#039;virtio&#039; name=&#039;com.redhat.spice.0&#039;/&gt; &lt;address type=&#039;virtio-serial&#039; controller=&#039;0&#039; bus=&#039;0&#039; port=&#039;1&#039;/&gt; &lt;/channel&gt; &lt;input type=&#039;tablet&#039; bus=&#039;usb&#039;/&gt; &lt;hostdev mode=&#039;subsystem&#039; type=&#039;pci&#039; managed=&#039;yes&#039;&gt; &lt;source&gt; &lt;address domain=&#039;0x0000&#039; bus=&#039;0x02&#039; slot=&#039;0x00&#039; function=&#039;0x0&#039;/&gt; &lt;/source&gt; &lt;address type=&#039;pci&#039; domain=&#039;0x0000&#039; bus=&#039;0x00&#039; slot=&#039;0x08&#039; function=&#039;0x0&#039;/&gt; &lt;/hostdev&gt; &lt;hostdev mode=&#039;subsystem&#039; type=&#039;pci&#039; managed=&#039;yes&#039;&gt; &lt;source&gt; &lt;address domain=&#039;0x0000&#039; bus=&#039;0x02&#039; slot=&#039;0x00&#039; function=&#039;0x1&#039;/&gt; &lt;/source&gt; &lt;address type=&#039;pci&#039; domain=&#039;0x0000&#039; bus=&#039;0x00&#039; slot=&#039;0x09&#039; function=&#039;0x0&#039;/&gt; &lt;/hostdev&gt; &lt;hostdev mode=&#039;subsystem&#039; type=&#039;pci&#039; managed=&#039;yes&#039;&gt; &lt;source&gt; &lt;address domain=&#039;0x0000&#039; bus=&#039;0x09&#039; slot=&#039;0x00&#039; function=&#039;0x0&#039;/&gt; &lt;/source&gt; &lt;address type=&#039;pci&#039; domain=&#039;0x0000&#039; bus=&#039;0x00&#039; slot=&#039;0x04&#039; function=&#039;0x0&#039;/&gt; &lt;/hostdev&gt; &lt;hostdev mode=&#039;subsystem&#039; type=&#039;pci&#039; managed=&#039;yes&#039;&gt; &lt;source&gt; &lt;address domain=&#039;0x0000&#039; bus=&#039;0x0a&#039; slot=&#039;0x00&#039; function=&#039;0x0&#039;/&gt; &lt;/source&gt; &lt;address type=&#039;pci&#039; domain=&#039;0x0000&#039; bus=&#039;0x00&#039; slot=&#039;0x0b&#039; function=&#039;0x0&#039;/&gt; &lt;/hostdev&gt; &lt;memballoon model=&#039;virtio&#039;&gt; &lt;address type=&#039;pci&#039; domain=&#039;0x0000&#039; bus=&#039;0x00&#039; slot=&#039;0x0a&#039; function=&#039;0x0&#039;/&gt; &lt;/memballoon&gt; &lt;/devices&gt; &lt;/domain&gt;</code></pre></div><p>I&#039;m using a Gigabyte X79 UD3 with an i7 3930k, a r7 270x on an Arch Linux host and a gtx 680 on a Windows 8.1 VM.</p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1503490">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1503500" class="blockpost roweven"> <h2><span><span class="conr">#4202</span> <a href="viewtopic.php?pid=1503500#p1503500">2015-02-16 15:23:52</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=79471">Bronek</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>From: London</span></dd> <dd><span>Registered: 2014-02-14</span></dd> <dd><span>Posts: 90</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=79471">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>avengerf12 wrote:</cite><blockquote><div><p>Hello everyone, first of all thanks to everyone who contributed to this great forum post, it has been immensely useful to configure my setup.</p><p>Second, I&#039;m having a bit of a problem with the CPU configuration in a Windows 8.1 VM. <br />I&#039;m currently assigning 6 vcpus to my real cpu using libvirt and when i start the VM for the first time everything works flawlessly, but if I shutdown the VM and start it again without rebooting the computer it freezes the whole host. Searching through the thread about this issue only results in a few posts suggesting to use the &quot;isolcpus&quot; argument in the kernel commandline to avoid any conflict. Unfortunately it didn&#039;t work and so I was hoping if someone here had any idea of what the problem could be.</p><p>This is my current config</p><div class="codebox"><pre class="vscroll"><code>&lt;domain type=&#039;kvm&#039;&gt; &lt;name&gt;win8.1&lt;/name&gt; &lt;uuid&gt;f3aa271e-8184-4a56-9bf5-ffbacc2f1511&lt;/uuid&gt; &lt;memory unit=&#039;KiB&#039;&gt;6291456&lt;/memory&gt; &lt;currentMemory unit=&#039;KiB&#039;&gt;6291456&lt;/currentMemory&gt; &lt;vcpu placement=&#039;static&#039; cpuset=&#039;6-11&#039;&gt;6&lt;/vcpu&gt; &lt;cputune&gt; &lt;vcpupin vcpu=&#039;0&#039; cpuset=&#039;6&#039;/&gt; &lt;vcpupin vcpu=&#039;1&#039; cpuset=&#039;7&#039;/&gt; &lt;vcpupin vcpu=&#039;2&#039; cpuset=&#039;8&#039;/&gt; &lt;vcpupin vcpu=&#039;3&#039; cpuset=&#039;9&#039;/&gt; &lt;vcpupin vcpu=&#039;4&#039; cpuset=&#039;10&#039;/&gt; &lt;vcpupin vcpu=&#039;5&#039; cpuset=&#039;11&#039;/&gt; &lt;emulatorpin cpuset=&#039;6-11&#039;/&gt; &lt;/cputune&gt; &lt;os&gt; &lt;type arch=&#039;x86_64&#039; machine=&#039;pc-i440fx-2.2&#039;&gt;hvm&lt;/type&gt; &lt;loader type=&#039;pflash&#039;&gt;/usr/share/ovmf/ovmf_x64.bin&lt;/loader&gt; &lt;bootmenu enable=&#039;yes&#039;/&gt; &lt;/os&gt; &lt;features&gt; &lt;acpi/&gt; &lt;apic/&gt; &lt;pae/&gt; &lt;hyperv&gt; &lt;relaxed state=&#039;on&#039;/&gt; &lt;vapic state=&#039;on&#039;/&gt; &lt;spinlocks state=&#039;on&#039; retries=&#039;8191&#039;/&gt; &lt;/hyperv&gt; &lt;kvm&gt; &lt;hidden state=&#039;on&#039;/&gt; &lt;/kvm&gt; &lt;/features&gt; &lt;cpu mode=&#039;host-passthrough&#039;&gt; &lt;feature policy=&#039;require&#039; name=&#039;pbe&#039;/&gt; &lt;feature policy=&#039;require&#039; name=&#039;tm2&#039;/&gt; &lt;feature policy=&#039;require&#039; name=&#039;est&#039;/&gt; &lt;feature policy=&#039;require&#039; name=&#039;vmx&#039;/&gt; &lt;feature policy=&#039;require&#039; name=&#039;osxsave&#039;/&gt; &lt;feature policy=&#039;require&#039; name=&#039;ss&#039;/&gt; &lt;feature policy=&#039;require&#039; name=&#039;ds&#039;/&gt; &lt;feature policy=&#039;require&#039; name=&#039;vme&#039;/&gt; &lt;feature policy=&#039;require&#039; name=&#039;dtes64&#039;/&gt; &lt;feature policy=&#039;require&#039; name=&#039;monitor&#039;/&gt; &lt;feature policy=&#039;require&#039; name=&#039;ht&#039;/&gt; &lt;feature policy=&#039;require&#039; name=&#039;dca&#039;/&gt; &lt;feature policy=&#039;require&#039; name=&#039;pcid&#039;/&gt; &lt;feature policy=&#039;require&#039; name=&#039;tm&#039;/&gt; &lt;feature policy=&#039;require&#039; name=&#039;pdcm&#039;/&gt; &lt;feature policy=&#039;require&#039; name=&#039;pdpe1gb&#039;/&gt; &lt;feature policy=&#039;require&#039; name=&#039;ds_cpl&#039;/&gt; &lt;feature policy=&#039;require&#039; name=&#039;xtpr&#039;/&gt; &lt;feature policy=&#039;require&#039; name=&#039;acpi&#039;/&gt; &lt;feature policy=&#039;require&#039; name=&#039;invtsc&#039;/&gt; &lt;/cpu&gt; &lt;clock offset=&#039;localtime&#039;&gt; &lt;timer name=&#039;rtc&#039; tickpolicy=&#039;catchup&#039;/&gt; &lt;timer name=&#039;pit&#039; tickpolicy=&#039;delay&#039;/&gt; &lt;timer name=&#039;hpet&#039; present=&#039;no&#039;/&gt; &lt;timer name=&#039;hypervclock&#039; present=&#039;yes&#039;/&gt; &lt;/clock&gt; &lt;on_poweroff&gt;destroy&lt;/on_poweroff&gt; &lt;on_reboot&gt;restart&lt;/on_reboot&gt; &lt;on_crash&gt;restart&lt;/on_crash&gt; &lt;pm&gt; &lt;suspend-to-mem enabled=&#039;no&#039;/&gt; &lt;suspend-to-disk enabled=&#039;no&#039;/&gt; &lt;/pm&gt; &lt;devices&gt; &lt;emulator&gt;/usr/sbin/qemu-system-x86_64&lt;/emulator&gt; &lt;disk type=&#039;file&#039; device=&#039;cdrom&#039;&gt; &lt;driver name=&#039;qemu&#039; type=&#039;raw&#039;/&gt; &lt;source file=&#039;/media/Linux-Drive/VM/Windows/Windows8Pro.iso&#039;/&gt; &lt;target dev=&#039;hda&#039; bus=&#039;ide&#039;/&gt; &lt;readonly/&gt; &lt;boot order=&#039;2&#039;/&gt; &lt;address type=&#039;drive&#039; controller=&#039;0&#039; bus=&#039;0&#039; target=&#039;0&#039; unit=&#039;0&#039;/&gt; &lt;/disk&gt; &lt;disk type=&#039;file&#039; device=&#039;cdrom&#039;&gt; &lt;driver name=&#039;qemu&#039; type=&#039;raw&#039;/&gt; &lt;source file=&#039;/media/Linux-Drive/VM/Windows/virtio.iso&#039;/&gt; &lt;target dev=&#039;hdb&#039; bus=&#039;ide&#039;/&gt; &lt;readonly/&gt; &lt;address type=&#039;drive&#039; controller=&#039;0&#039; bus=&#039;0&#039; target=&#039;0&#039; unit=&#039;1&#039;/&gt; &lt;/disk&gt; &lt;disk type=&#039;file&#039; device=&#039;cdrom&#039;&gt; &lt;driver name=&#039;qemu&#039; type=&#039;raw&#039;/&gt; &lt;source file=&#039;/media/Linux-Drive/VM/Windows/Windows8Pro.iso&#039;/&gt; &lt;target dev=&#039;hdc&#039; bus=&#039;ide&#039;/&gt; &lt;readonly/&gt; &lt;address type=&#039;drive&#039; controller=&#039;0&#039; bus=&#039;1&#039; target=&#039;0&#039; unit=&#039;0&#039;/&gt; &lt;/disk&gt; &lt;disk type=&#039;file&#039; device=&#039;disk&#039;&gt; &lt;driver name=&#039;qemu&#039; type=&#039;raw&#039;/&gt; &lt;source file=&#039;/media/vm-drives/WBoot.img&#039;/&gt; &lt;target dev=&#039;sda&#039; bus=&#039;scsi&#039;/&gt; &lt;boot order=&#039;1&#039;/&gt; &lt;address type=&#039;drive&#039; controller=&#039;0&#039; bus=&#039;0&#039; target=&#039;0&#039; unit=&#039;0&#039;/&gt; &lt;/disk&gt; &lt;disk type=&#039;block&#039; device=&#039;disk&#039;&gt; &lt;driver name=&#039;qemu&#039; type=&#039;raw&#039; cache=&#039;none&#039; io=&#039;native&#039;/&gt; &lt;source dev=&#039;/dev/sda1&#039;/&gt; &lt;target dev=&#039;sdb&#039; bus=&#039;scsi&#039;/&gt; &lt;address type=&#039;drive&#039; controller=&#039;0&#039; bus=&#039;0&#039; target=&#039;0&#039; unit=&#039;1&#039;/&gt; &lt;/disk&gt; &lt;controller type=&#039;usb&#039; index=&#039;0&#039; model=&#039;ich9-ehci1&#039;&gt; &lt;address type=&#039;pci&#039; domain=&#039;0x0000&#039; bus=&#039;0x00&#039; slot=&#039;0x06&#039; function=&#039;0x7&#039;/&gt; &lt;/controller&gt; &lt;controller type=&#039;usb&#039; index=&#039;0&#039; model=&#039;ich9-uhci1&#039;&gt; &lt;master startport=&#039;0&#039;/&gt; &lt;address type=&#039;pci&#039; domain=&#039;0x0000&#039; bus=&#039;0x00&#039; slot=&#039;0x06&#039; function=&#039;0x0&#039; multifunction=&#039;on&#039;/&gt; &lt;/controller&gt; &lt;controller type=&#039;usb&#039; index=&#039;0&#039; model=&#039;ich9-uhci2&#039;&gt; &lt;master startport=&#039;2&#039;/&gt; &lt;address type=&#039;pci&#039; domain=&#039;0x0000&#039; bus=&#039;0x00&#039; slot=&#039;0x06&#039; function=&#039;0x1&#039;/&gt; &lt;/controller&gt; &lt;controller type=&#039;usb&#039; index=&#039;0&#039; model=&#039;ich9-uhci3&#039;&gt; &lt;master startport=&#039;4&#039;/&gt; &lt;address type=&#039;pci&#039; domain=&#039;0x0000&#039; bus=&#039;0x00&#039; slot=&#039;0x06&#039; function=&#039;0x2&#039;/&gt; &lt;/controller&gt; &lt;controller type=&#039;scsi&#039; index=&#039;0&#039; model=&#039;virtio-scsi&#039;&gt; &lt;address type=&#039;pci&#039; domain=&#039;0x0000&#039; bus=&#039;0x00&#039; slot=&#039;0x05&#039; function=&#039;0x0&#039;/&gt; &lt;/controller&gt; &lt;controller type=&#039;pci&#039; index=&#039;0&#039; model=&#039;pci-root&#039;/&gt; &lt;controller type=&#039;ide&#039; index=&#039;0&#039;&gt; &lt;address type=&#039;pci&#039; domain=&#039;0x0000&#039; bus=&#039;0x00&#039; slot=&#039;0x01&#039; function=&#039;0x1&#039;/&gt; &lt;/controller&gt; &lt;controller type=&#039;virtio-serial&#039; index=&#039;0&#039;&gt; &lt;address type=&#039;pci&#039; domain=&#039;0x0000&#039; bus=&#039;0x00&#039; slot=&#039;0x07&#039; function=&#039;0x0&#039;/&gt; &lt;/controller&gt; &lt;interface type=&#039;network&#039;&gt; &lt;mac address=&#039;52:54:00:fb:c5:e7&#039;/&gt; &lt;source network=&#039;default&#039;/&gt; &lt;model type=&#039;rtl8139&#039;/&gt; &lt;address type=&#039;pci&#039; domain=&#039;0x0000&#039; bus=&#039;0x00&#039; slot=&#039;0x03&#039; function=&#039;0x0&#039;/&gt; &lt;/interface&gt; &lt;serial type=&#039;pty&#039;&gt; &lt;target port=&#039;0&#039;/&gt; &lt;/serial&gt; &lt;console type=&#039;pty&#039;&gt; &lt;target type=&#039;serial&#039; port=&#039;0&#039;/&gt; &lt;/console&gt; &lt;channel type=&#039;spicevmc&#039;&gt; &lt;target type=&#039;virtio&#039; name=&#039;com.redhat.spice.0&#039;/&gt; &lt;address type=&#039;virtio-serial&#039; controller=&#039;0&#039; bus=&#039;0&#039; port=&#039;1&#039;/&gt; &lt;/channel&gt; &lt;input type=&#039;tablet&#039; bus=&#039;usb&#039;/&gt; &lt;hostdev mode=&#039;subsystem&#039; type=&#039;pci&#039; managed=&#039;yes&#039;&gt; &lt;source&gt; &lt;address domain=&#039;0x0000&#039; bus=&#039;0x02&#039; slot=&#039;0x00&#039; function=&#039;0x0&#039;/&gt; &lt;/source&gt; &lt;address type=&#039;pci&#039; domain=&#039;0x0000&#039; bus=&#039;0x00&#039; slot=&#039;0x08&#039; function=&#039;0x0&#039;/&gt; &lt;/hostdev&gt; &lt;hostdev mode=&#039;subsystem&#039; type=&#039;pci&#039; managed=&#039;yes&#039;&gt; &lt;source&gt; &lt;address domain=&#039;0x0000&#039; bus=&#039;0x02&#039; slot=&#039;0x00&#039; function=&#039;0x1&#039;/&gt; &lt;/source&gt; &lt;address type=&#039;pci&#039; domain=&#039;0x0000&#039; bus=&#039;0x00&#039; slot=&#039;0x09&#039; function=&#039;0x0&#039;/&gt; &lt;/hostdev&gt; &lt;hostdev mode=&#039;subsystem&#039; type=&#039;pci&#039; managed=&#039;yes&#039;&gt; &lt;source&gt; &lt;address domain=&#039;0x0000&#039; bus=&#039;0x09&#039; slot=&#039;0x00&#039; function=&#039;0x0&#039;/&gt; &lt;/source&gt; &lt;address type=&#039;pci&#039; domain=&#039;0x0000&#039; bus=&#039;0x00&#039; slot=&#039;0x04&#039; function=&#039;0x0&#039;/&gt; &lt;/hostdev&gt; &lt;hostdev mode=&#039;subsystem&#039; type=&#039;pci&#039; managed=&#039;yes&#039;&gt; &lt;source&gt; &lt;address domain=&#039;0x0000&#039; bus=&#039;0x0a&#039; slot=&#039;0x00&#039; function=&#039;0x0&#039;/&gt; &lt;/source&gt; &lt;address type=&#039;pci&#039; domain=&#039;0x0000&#039; bus=&#039;0x00&#039; slot=&#039;0x0b&#039; function=&#039;0x0&#039;/&gt; &lt;/hostdev&gt; &lt;memballoon model=&#039;virtio&#039;&gt; &lt;address type=&#039;pci&#039; domain=&#039;0x0000&#039; bus=&#039;0x00&#039; slot=&#039;0x0a&#039; function=&#039;0x0&#039;/&gt; &lt;/memballoon&gt; &lt;/devices&gt; &lt;/domain&gt;</code></pre></div><p>I&#039;m using a Gigabyte X79 UD3 with an i7 3930k, a r7 270x on an Arch Linux host and a gtx 680 on a Windows 8.1 VM.</p></div></blockquote></div><br /><p>You probably do not need &quot;&lt;emulatorpin cpuset=&#039;6-11&#039;/&gt;&quot;, that will keep all IO for guest to the same CPUs which are used as well. It&#039;s probably better (for guest performance) to allow this IO to spread over all available CPUs - just remove the line. However, I do not expect this to fix your immediate problem since it seems something deeper than just performance issue. It is possible that selected CPU type is causing problems , see if replacing &quot;&#160; &lt;cpu mode=&#039;host-passthrough&#039;&gt; ... &lt;/cpu&gt;&quot; with specific model helps. FWIW I had to downgrade my guests CPU to Penryn for stable Windows 7 guest, and it still occasionally drops to &quot;paused&quot; state when booting it up (no problem shutting down, though). My host CPUs are IvyBridge E5-2630v2 .</p> </div> <div class="postsignature postmsg"><hr /><p>Sorry about&#160; &quot;KVM VGA-Passthrough ...&quot; thread <img src="https://bbs.archlinux.org/img/smilies/sad.png" width="15" height="15" alt="sad" /> Anyone interested in continuing this discussion elsewhere, please contact me privately. I might be able to find it a new home.</p></div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1503500">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1503513" class="blockpost rowodd"> <h2><span><span class="conr">#4203</span> <a href="viewtopic.php?pid=1503513#p1503513">2015-02-16 16:14:32</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=82382">avengerf12</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2014-05-30</span></dd> <dd><span>Posts: 2</span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>Bronek wrote:</cite><blockquote><div><p>You probably do not need &quot;&lt;emulatorpin cpuset=&#039;6-11&#039;/&gt;&quot;, that will keep all IO for guest to the same CPUs which are used as well. It&#039;s probably better (for guest performance) to allow this IO to spread over all available CPUs - just remove the line. However, I do not expect this to fix your immediate problem since it seems something deeper than just performance issue. It is possible that selected CPU type is causing problems , see if replacing &quot;&#160; &lt;cpu mode=&#039;host-passthrough&#039;&gt; ... &lt;/cpu&gt;&quot; with specific model helps. FWIW I had to downgrade my guests CPU to Penryn for stable Windows 7 guest, and it still occasionally drops to &quot;paused&quot; state when booting it up (no problem shutting down, though). My host CPUs are IvyBridge E5-2630v2 .</p></div></blockquote></div><p>Thanks for your reply. I removed the emulatorpin line (even though I thought it was only an override for the cpuset variable) and changed my cpu mode to &lt;cpu mode=&#039;custom&#039; match=&#039;exact&#039;&gt;. It still hasn&#039;t crashed and has a bonus it even improved performance as far as I can tell so your suggestions were definitely helpful, thanks again.<br />Now I&#039;ll just to wait and see, even though I think it was &quot;cpu-passthrough&quot;&#039;s fault.</p><p>Edit: In the exact moment I inserted again cpu-passthrough the whole machine froze. I think my problem is solved.</p><p>Edit2: Can someone tell me if the isolcpus option is necessary in my case?</p> <p class="postedit"><em>Last edited by avengerf12 (2015-02-16 16:59:04)</em></p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1503513">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1503596" class="blockpost roweven"> <h2><span><span class="conr">#4204</span> <a href="viewtopic.php?pid=1503596#p1503596">2015-02-16 22:30:08</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=88886">jaeger</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2015-02-16</span></dd> <dd><span>Posts: 9</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=88886">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <p>Greetings, all. Is it currently possible to get VGA passthrough working with a haswell onboard Intel HD host GPU and a discrete nvidia 900-series guest GPU or is this a unicorn at the moment?</p><p>I&#039;ve pieced together various bits of info from posts in this thread and other places online but no matter what I try I always run into the code 43 error after installing the nvidia drivers in the windows guest. For reference, the hardware is:</p><p>ASRock H97m-Pro4<br />Intel i7-4790K (onboard GPU is Intel HD 4600)<br />MSI GeForce GTX 970</p><p>I&#039;m running a CRUX host with kernel 3.18.7 (also tried 3.14.x) and qemu 2.2.0 (also tried straight from git). The guest is Windows 8.1 Enterprise 64-bit. I&#039;m using OVMF to avoid the VGA arbitration issues with Intel onboard graphics.</p><p>I&#039;m using qemu on the command line rather than libvirt and disabling the kvm CPU flag. I&#039;m able to successfully install and boot the windows VM as well as see its display on the monitor connected directly to the discrete nvidia GPU, but I still can&#039;t get past the code 43 error. I see quite often that kvm and various hyper-v flags should be disabled, and as mentioned I disable the kvm flag already. When using qemu&#039;s command line rather than libvirt is it necessary to explicitly hide/disable the hyper-v flags? Is it documented somewhere how to do that? Plenty of examples out there for libvirt but none that I&#039;ve seen for command line. If I&#039;ve simply missed it and someone has a link, please do tell.</p><p>Thanks in advance, hope someone&#039;s got a similar setup working so I can compare.</p><p>edit: Forgot to add that the iommu groups containing the onboard and discrete GPUs do NOT overlap.</p> <p class="postedit"><em>Last edited by jaeger (2015-02-16 22:37:40)</em></p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1503596">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1503604" class="blockpost rowodd"> <h2><span><span class="conr">#4205</span> <a href="viewtopic.php?pid=1503604#p1503604">2015-02-16 23:26:26</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=87826">The_Moves</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2015-01-06</span></dd> <dd><span>Posts: 58</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=87826">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>jaeger wrote:</cite><blockquote><div><p>Greetings, all. Is it currently possible to get VGA passthrough working with a haswell onboard Intel HD host GPU and a discrete nvidia 900-series guest GPU or is this a unicorn at the moment?</p><p>I&#039;ve pieced together various bits of info from posts in this thread and other places online but no matter what I try I always run into the code 43 error after installing the nvidia drivers in the windows guest. For reference, the hardware is:</p><p>ASRock H97m-Pro4<br />Intel i7-4790K (onboard GPU is Intel HD 4600)<br />MSI GeForce GTX 970</p><p>I&#039;m running a CRUX host with kernel 3.18.7 (also tried 3.14.x) and qemu 2.2.0 (also tried straight from git). The guest is Windows 8.1 Enterprise 64-bit. I&#039;m using OVMF to avoid the VGA arbitration issues with Intel onboard graphics.</p><p>I&#039;m using qemu on the command line rather than libvirt and disabling the kvm CPU flag. I&#039;m able to successfully install and boot the windows VM as well as see its display on the monitor connected directly to the discrete nvidia GPU, but I still can&#039;t get past the code 43 error. I see quite often that kvm and various hyper-v flags should be disabled, and as mentioned I disable the kvm flag already. When using qemu&#039;s command line rather than libvirt is it necessary to explicitly hide/disable the hyper-v flags? Is it documented somewhere how to do that? Plenty of examples out there for libvirt but none that I&#039;ve seen for command line. If I&#039;ve simply missed it and someone has a link, please do tell.</p><p>Thanks in advance, hope someone&#039;s got a similar setup working so I can compare.</p><p>edit: Forgot to add that the iommu groups containing the onboard and discrete GPUs do NOT overlap.</p></div></blockquote></div><p>I believe the HyperV part is particular to libvirt and KVM, not qemu. What emulator are you using? Please paste your qemu command.</p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1503604">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1503611" class="blockpost roweven"> <h2><span><span class="conr">#4206</span> <a href="viewtopic.php?pid=1503611#p1503611">2015-02-17 00:07:29</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=80387">dwe11er</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2014-03-18</span></dd> <dd><span>Posts: 73</span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>jaeger wrote:</cite><blockquote><div><p>Greetings, all. Is it currently possible to get VGA passthrough working with a haswell onboard Intel HD host GPU and a discrete nvidia 900-series guest GPU or is this a unicorn at the moment?</p><p>I&#039;ve pieced together various bits of info from posts in this thread and other places online but no matter what I try I always run into the code 43 error after installing the nvidia drivers in the windows guest. For reference, the hardware is:</p><p>ASRock H97m-Pro4<br />Intel i7-4790K (onboard GPU is Intel HD 4600)<br />MSI GeForce GTX 970</p><p>I&#039;m running a CRUX host with kernel 3.18.7 (also tried 3.14.x) and qemu 2.2.0 (also tried straight from git). The guest is Windows 8.1 Enterprise 64-bit. I&#039;m using OVMF to avoid the VGA arbitration issues with Intel onboard graphics.</p><p>I&#039;m using qemu on the command line rather than libvirt and disabling the kvm CPU flag. I&#039;m able to successfully install and boot the windows VM as well as see its display on the monitor connected directly to the discrete nvidia GPU, but I still can&#039;t get past the code 43 error. I see quite often that kvm and various hyper-v flags should be disabled, and as mentioned I disable the kvm flag already. When using qemu&#039;s command line rather than libvirt is it necessary to explicitly hide/disable the hyper-v flags? Is it documented somewhere how to do that? Plenty of examples out there for libvirt but none that I&#039;ve seen for command line. If I&#039;ve simply missed it and someone has a link, please do tell.</p><p>Thanks in advance, hope someone&#039;s got a similar setup working so I can compare.</p><p>edit: Forgot to add that the iommu groups containing the onboard and discrete GPUs do NOT overlap.</p></div></blockquote></div><p>They shouldn&#039;t be enabled by default, so problem is somewhere else. Still, you can try and disable/remove <strong>hv_time</strong>, <strong>hv_relaxed</strong>, <strong>hv_vapic</strong> and <strong>hv_spinlocks</strong> on your -cpu section.</p> <p class="postedit"><em>Last edited by dwe11er (2015-02-17 01:04:48)</em></p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1503611">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1503624" class="blockpost rowodd"> <h2><span><span class="conr">#4207</span> <a href="viewtopic.php?pid=1503624#p1503624">2015-02-17 01:11:25</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=84538">mauorrizze</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2014-08-22</span></dd> <dd><span>Posts: 17</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=84538">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <p>@jaeger:<br />There must be no video device defined (vga/qxl etc.) to ensure that the nvidia is the primary display device.<br />In <strong>-cpu</strong> <strong>kvm=off</strong> should be explecitly set and the <strong>hv_</strong> items should be missing/removed as already said. If this doesn&#039;t help you can try to enforce <strong>hv_time=off</strong>.<br />That&#039;s all I can think of.</p><p>And yes, please paste your existing qemu command.</p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1503624">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1503625" class="blockpost roweven"> <h2><span><span class="conr">#4208</span> <a href="viewtopic.php?pid=1503625#p1503625">2015-02-17 01:11:34</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=88886">jaeger</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2015-02-16</span></dd> <dd><span>Posts: 9</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=88886">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>The_Moves wrote:</cite><blockquote><div><p>I believe the HyperV part is particular to libvirt and KVM, not qemu. What emulator are you using? Please paste your qemu command.</p></div></blockquote></div><p>Not sure what you mean by &quot;what emulator&quot;, can you clarify?</p><p>The qemu command is this:</p><div class="codebox"><pre><code>sudo /usr/bin/qemu-system-x86_64 \ -name &quot;Windows 8.1&quot; \ -nographic \ -enable-kvm \ -cpu host,kvm=off \ -m 8192 \ -smp cores=4,threads=1,sockets=1 \ -vga none -nodefconfig \ -drive if=pflash,format=raw,readonly,file=/home/jaeger/ovmf-x64/OVMF_CODE-pure-efi.fd \ -drive if=pflash,format=raw,file=/home/jaeger/ovmf-x64/OVMF_VARS-pure-efi.fd \ -device vfio-pci,host=01:00.0,multifunction=on \ -device vfio-pci,host=01:00.1 \ -drive file=&quot;/home/jaeger/VMs/win81/win81.img&quot;,format=raw,if=virtio,id=disk0 \ -drive file=&quot;/home/jaeger/VMs/win81/win81ent.iso&quot;,format=raw,id=cd0,if=none -device ide-cd,bus=ide.1,drive=cd0 \ -netdev bridge,id=net0 \ -device virtio-net-pci,netdev=net0 \ -usbdevice host:04d9:0183 \ -usbdevice host:1038:1369</code></pre></div><p>01:00.0 and 01:00.1 are:</p><p>01:00.0 VGA compatible controller [0300]: NVIDIA Corporation GM204 [GeForce GTX 970] [10de:13c2] (rev a1)<br />01:00.1 Audio device [0403]: NVIDIA Corporation GM204 High Definition Audio Controller [10de:0fbb] (rev a1)</p><div class="quotebox"><cite>dwe11er wrote:</cite><blockquote><div><p>They shouldn&#039;t be enabled by default, so problem is somewhere else. Still, you can try and disable/remove hv_time, hv_relaxed, hv_vapic and hv_spinlocks on your -cpu section.</p></div></blockquote></div><p>OK, I sorta wondered if that were the case. When using the command line and not libvirt/virt-manager, though, how do you disable them? Adding hv_time=off to the cpu line seems ok but the others it complains about no matter what I pass.</p><p>edit: I was a bit premature in saying it complained &quot;no matter what I pass&quot;, sorry for that. Passing hv_time=off,hv_relaxed=off causes no problems but doesn&#039;t fix the issue. Passing hv_spinlocks wants a numeric value so I wasn&#039;t sure what to try there, and hv_apic is unrecognized.</p><p>edit 2: I looked in the qemu source for the hv* options, I was mistyping hv-vapic as hv-apic. Still have a code 43, though.</p> <p class="postedit"><em>Last edited by jaeger (2015-02-17 03:16:03)</em></p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1503625">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1503633" class="blockpost rowodd"> <h2><span><span class="conr">#4209</span> <a href="viewtopic.php?pid=1503633#p1503633">2015-02-17 01:57:17</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=88886">jaeger</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2015-02-16</span></dd> <dd><span>Posts: 9</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=88886">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <p>Playing with the various hv_options on the command line hasn&#039;t fixed my code 43 yet but I did get some new output in the qemu window when attempting to install the nvidia drivers. Lots of this sort of thing:</p><div class="codebox"><pre><code>qemu-system-x86_64: vfio_pci_read_config(0000:01:00.0, 0xa60, 0x4) failed: Bad address qemu-system-x86_64: vfio_pci_read_config(0000:01:00.0, 0xa64, 0x4) failed: Bad address qemu-system-x86_64: vfio_pci_read_config(0000:01:00.0, 0xa68, 0x4) failed: Bad address qemu-system-x86_64: vfio_pci_read_config(0000:01:00.0, 0x488, 0x4) failed: Bad address qemu-system-x86_64: vfio_pci_read_config(0000:01:00.0, 0x144, 0x4) failed: Bad address qemu-system-x86_64: vfio_pci_write_config(0000:01:00.0, 0x144, 0xffffff30, 0x4) failed: Bad address qemu-system-x86_64: vfio_pci_read_config(0000:01:00.0, 0x658, 0x4) failed: Bad address qemu-system-x86_64: vfio_pci_write_config(0000:01:00.0, 0x658, 0xfffffff2, 0x4) failed: Bad address qemu-system-x86_64: vfio_pci_write_config(0000:01:00.0, 0x624, 0x1c94e307, 0x4) failed: Bad address qemu-system-x86_64: vfio_pci_write_config(0000:01:00.0, 0x62c, 0x4ce8f40f, 0x4) failed: Bad address qemu-system-x86_64: vfio_pci_write_config(0000:01:00.0, 0x634, 0x35b4f7ca, 0x4) failed: Bad address qemu-system-x86_64: vfio_pci_write_config(0000:01:00.0, 0x63c, 0xa33431b5, 0x4) failed: Bad address qemu-system-x86_64: vfio_pci_read_config(0000:01:00.0, 0x41c, 0x4) failed: Bad address qemu-system-x86_64: vfio_pci_write_config(0000:01:00.0, 0x624, 0x0, 0x4) failed: Bad address qemu-system-x86_64: vfio_pci_write_config(0000:01:00.0, 0x62c, 0x0, 0x4) failed: Bad address qemu-system-x86_64: vfio_pci_write_config(0000:01:00.0, 0x634, 0x0, 0x4) failed: Bad address qemu-system-x86_64: vfio_pci_write_config(0000:01:00.0, 0x63c, 0x0, 0x4) failed: Bad address qemu-system-x86_64: vfio_pci_read_config(0000:01:00.0, 0x41c, 0x4) failed: Bad address qemu-system-x86_64: vfio_pci_write_config(0000:01:00.0, 0x484, 0x0, 0x4) failed: Bad address</code></pre></div><p>Have I missed something obvious here?</p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1503633">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1503640" class="blockpost roweven"> <h2><span><span class="conr">#4210</span> <a href="viewtopic.php?pid=1503640#p1503640">2015-02-17 02:26:42</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=87813">Len</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd class="postavatar"><img src="https://bbs.archlinux.org/img/avatars/87813.png?m=1420509844" width="80" height="80" alt="" /></dd> <dd><span>Registered: 2015-01-06</span></dd> <dd><span>Posts: 23</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=87813">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <p>I managed to get <span class="bbu">some</span> things working, thanks guys!<br />But right now I&#039;m facing other problems:</p><p>This is my running script </p><div class="codebox"><pre><code>qemu-system-x86_64 \ -enable-kvm -vga none -display none \ -cpu host -m 2048 -smp 4,cores=4,threads=1,sockets=1 \ -drive if=pflash,format=raw,readonly,file=/home/len/win/bios/ovmf_code_x64.bin \ -drive if=pflash,format=raw,file=/home/len/win/bios/ovmf_vars_x64.bin \ -device vfio-pci,host=01:00.0,multifunction=on,x-vga=on \ -device vfio-pci,host=01:00.1 \ -drive if=none,file=&quot;/dev/sdc&quot;,format=raw,id=disk0 -device ide-hd,bus=ide.0,drive=disk0 \ -drive if=none,file=&quot;/home/len/win/win7.iso&quot;,format=raw,id=cd0 -device ide-cd,bus=ide.1,drive=cd0 \ -usbdevice host:046d:c317</code></pre></div><p>It works, well in some way.. OVMF starts, then I can boot from CD, but installer freeze on: &quot;Starting Windows&quot; (~15min still nothing).<br />I wanted mount it using AHCI (or I should?), but OVMF is not finding it, dunno why.</p><p>Second problem is, how can I make possible mounting /dev/sdc for normal user?<br />I managed to allow non-root user, take care of vfio-pci devices using chown (-__-) and some limits.conf edits.</p><p>Btw, is that normal that sometimes after running qemu, host graphic gots glithes? (fixed by switching tty).</p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1503640">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1503669" class="blockpost rowodd"> <h2><span><span class="conr">#4211</span> <a href="viewtopic.php?pid=1503669#p1503669">2015-02-17 06:16:07</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=79893">jonascj</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2014-02-28</span></dd> <dd><span>Posts: 13</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=79893">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <p>Is there still (as of 2015-02-17) a problem with the i915 patch disabling DRI in XORG?</p><p>Is the i915 patch still needed for Intel iGPU as host gpu, or are have the patches made it upstream?</p><p>Will things still work without any patches if you use AMD/Radeon GPU&#039;s only (host and guest)?</p><p>Thanks, JonasCJ</p><div class="quotebox"><cite>jonascj wrote:</cite><blockquote><div><p>Thank you, aw, for that very insightful reply.</p><p>I have a couple of follow-up questions and/or need a few clarifications.</p><div class="quotebox"><cite>aw wrote:</cite><blockquote><div><p>The first patch above fixes this, making i915 play correctly with VGA arbitration and the second patch cleans up some ordering to avoid a big white box drawn on the screen.&#160; It works and makes everyone happy... except Xorg on the host.&#160; The DRI code in Xorg, so I&#039;m told, wants to mmap(2) VGA MMIO space.&#160; Doing so is incompatible with the VGA arbiter because Xorg would need to hold the VGA arbitration lock for the life of that mmap, effectively a permanent lock.&#160; At that point VGA arbitration is deadlocked.&#160; Rather than do that, Xorg detects that there are multiple VGA devices and disables DRI. <span style="color: #ff0000">The result is that making i915 not lie about its VGA usage kills desktop performance for anyone with multiple graphics cards.&#160; This is the reason the two patches were reverted.</span></p><p><span style="color: #0000ff">Solutions to this are:<br /> a) don&#039;t use VGA space in the guest (DanaGoyette attempted to do this using UEFI/OVMF in place of Seabios, also accomplished on some cards using assigned graphics as a secondary device)<br /> b) create a VGA arbiter interface that would allow mmaps (I have some prototype code to do this, but I don&#039;t have time to figure out how to make Xorg use it)<br /> c) figure out why DRI wants to mmap VGA space and avoid it<br /> d) your idea here</span></p></div></blockquote></div><p>Regarding what is marked in <span style="color: #ff0000">red</span>:</p><p>So applying the the first patch (which makes i915 work correctly with VGA arbitration) kills overall performance (because it makes Xorg&#160; disable DRI which forces everyone to make indirect rendering) and because of that that patch was removed / reverted upstream?</p><p>Does this mean that kernels with this patch reapplied (OP&#039;s kernel for example, or etcet&#039;s core repo kernel with i915 patch) suffer from this problem (i.e. bad overall performance)?</p><p>Regarding the text marked in <span style="color: #0000ff">blue</span>:<br />Solutions to which problem? Solutions to the i915 arbiter problem - i.e. an alternative to the current patch?</p></div></blockquote></div><div class="quotebox"><cite>aw wrote:</cite><blockquote><div><div class="quotebox"><cite>jonascj wrote:</cite><blockquote><div><div class="quotebox"><cite>aw wrote:</cite><blockquote><div><p>In both cases yes, when multiple VGA devices are present (and possibly only on the i915 devices - radeon and nouveau appear to participate in VGA arbitration just fine).</p></div></blockquote></div><p>Sorry for being so thick, but this means that everyone using the i915 module/driver suffer from disabled DRI while they use kernels patched with this patch? I.e. everyone using Intel IGPU for their host while having a dedicated gfx passed through to a KVM guest have DRI disabled on their host.</p></div></blockquote></div><p>Yes</p></div></blockquote></div> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1503669">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1503671" class="blockpost roweven"> <h2><span><span class="conr">#4212</span> <a href="viewtopic.php?pid=1503671#p1503671">2015-02-17 06:30:02</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=84538">mauorrizze</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2014-08-22</span></dd> <dd><span>Posts: 17</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=84538">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <p>@Len: are you trying to install Windows 7 or Windows 8+?</p><p>@jonascj: AFAIK the i915 arbitration patch can&#039;t be improved without breaking things in Xorg or elsewhere. So there&#039;d be no way that this became mainstream.<br />On the other hand if you install Windows 8 or newer, use OVMF, no need for VGA arbitration. AMD drivers don&#039;t need any patches, work with both VGA and OVMF.</p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1503671">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1503673" class="blockpost rowodd"> <h2><span><span class="conr">#4213</span> <a href="viewtopic.php?pid=1503673#p1503673">2015-02-17 06:38:36</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=79893">jonascj</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2014-02-28</span></dd> <dd><span>Posts: 13</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=79893">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>mauorrizze wrote:</cite><blockquote><div><p>@jonascj: AFAIK the i915 arbitration patch can&#039;t be improved without breaking things in Xorg or elsewhere. So there&#039;d be no way that this became mainstream.<br />On the other hand if you install Windows 8 or newer, use OVMF, no need for VGA arbitration. AMD drivers don&#039;t need any patches, work with both VGA and OVMF.</p></div></blockquote></div><p>So with AMD R9 270X as the intended guest card, and an Intel iGPU (from an i7-whatever) I would go with a unpatched kernel if I go the OVMF route?</p><p>I found this by rereading post #1: <a href="http://vfio.blogspot.dk/2014/08/primary-graphics-assignment-without-vga.html" rel="nofollow">http://vfio.blogspot.dk/2014/08/primary … t-vga.html</a></p><p>Do you know of any other good starting points for diving into this.</p><p>Thanks, a lot!</p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1503673">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1503692" class="blockpost roweven"> <h2><span><span class="conr">#4214</span> <a href="viewtopic.php?pid=1503692#p1503692">2015-02-17 09:04:25</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=79471">Bronek</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>From: London</span></dd> <dd><span>Registered: 2014-02-14</span></dd> <dd><span>Posts: 90</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=79471">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>Len wrote:</cite><blockquote><div><p>I managed to get <span class="bbu">some</span> things working, thanks guys!<br />But right now I&#039;m facing other problems:</p><p>This is my running script </p><div class="codebox"><pre><code>qemu-system-x86_64 \ -enable-kvm -vga none -display none \ -cpu host -m 2048 -smp 4,cores=4,threads=1,sockets=1 \ -drive if=pflash,format=raw,readonly,file=/home/len/win/bios/ovmf_code_x64.bin \ -drive if=pflash,format=raw,file=/home/len/win/bios/ovmf_vars_x64.bin \ -device vfio-pci,host=01:00.0,multifunction=on,x-vga=on \ -device vfio-pci,host=01:00.1 \ -drive if=none,file=&quot;/dev/sdc&quot;,format=raw,id=disk0 -device ide-hd,bus=ide.0,drive=disk0 \ -drive if=none,file=&quot;/home/len/win/win7.iso&quot;,format=raw,id=cd0 -device ide-cd,bus=ide.1,drive=cd0 \ -usbdevice host:046d:c317</code></pre></div><p>It works, well in some way.. OVMF starts, then I can boot from CD, but installer freeze on: &quot;Starting Windows&quot; (~15min still nothing).<br />I wanted mount it using AHCI (or I should?), but OVMF is not finding it, dunno why.</p></div></blockquote></div><p>both AHCI and IDE are incredibly slow, I found that the best way to install Windows on kvm is to attach second CD with iso downloaded from <a href="http://www.linux-kvm.org/page/WindowsGuestDrivers/Download_Drivers" rel="nofollow">http://www.linux-kvm.org/page/WindowsGu … ad_Drivers</a>, define your C drive as virtio one. During system installation you will select virtio drivers from the attached 2nd CDROM (i.e. iso you downloaded from above URL) and then carry on with installation which will be much faster</p> </div> <div class="postsignature postmsg"><hr /><p>Sorry about&#160; &quot;KVM VGA-Passthrough ...&quot; thread <img src="https://bbs.archlinux.org/img/smilies/sad.png" width="15" height="15" alt="sad" /> Anyone interested in continuing this discussion elsewhere, please contact me privately. I might be able to find it a new home.</p></div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1503692">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1503710" class="blockpost rowodd"> <h2><span><span class="conr">#4215</span> <a href="viewtopic.php?pid=1503710#p1503710">2015-02-17 11:30:58</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=87813">Len</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd class="postavatar"><img src="https://bbs.archlinux.org/img/avatars/87813.png?m=1420509844" width="80" height="80" alt="" /></dd> <dd><span>Registered: 2015-01-06</span></dd> <dd><span>Posts: 23</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=87813">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>Bronek wrote:</cite><blockquote><div><div class="quotebox"><cite>Len wrote:</cite><blockquote><div><p>I managed to get <span class="bbu">some</span> things working, thanks guys!<br />But right now I&#039;m facing other problems:</p><p>This is my running script </p><div class="codebox"><pre><code>qemu-system-x86_64 \ -enable-kvm -vga none -display none \ -cpu host -m 2048 -smp 4,cores=4,threads=1,sockets=1 \ -drive if=pflash,format=raw,readonly,file=/home/len/win/bios/ovmf_code_x64.bin \ -drive if=pflash,format=raw,file=/home/len/win/bios/ovmf_vars_x64.bin \ -device vfio-pci,host=01:00.0,multifunction=on,x-vga=on \ -device vfio-pci,host=01:00.1 \ -drive if=none,file=&quot;/dev/sdc&quot;,format=raw,id=disk0 -device ide-hd,bus=ide.0,drive=disk0 \ -drive if=none,file=&quot;/home/len/win/win7.iso&quot;,format=raw,id=cd0 -device ide-cd,bus=ide.1,drive=cd0 \ -usbdevice host:046d:c317</code></pre></div><p>It works, well in some way.. OVMF starts, then I can boot from CD, but installer freeze on: &quot;Starting Windows&quot; (~15min still nothing).<br />I wanted mount it using AHCI (or I should?), but OVMF is not finding it, dunno why.</p></div></blockquote></div><p>both AHCI and IDE are incredibly slow, I found that the best way to install Windows on kvm is to attach second CD with iso downloaded from <a href="http://www.linux-kvm.org/page/WindowsGuestDrivers/Download_Drivers" rel="nofollow">http://www.linux-kvm.org/page/WindowsGu … ad_Drivers</a>, define your C drive as virtio one. During system installation you will select virtio drivers from the attached 2nd CDROM (i.e. iso you downloaded from above URL) and then carry on with installation which will be much faster</p></div></blockquote></div><p>Thanks for reply, I&#039;ll try it right now.</p><p>So I&#039;m assuming that after installation, I should still use &#039;virtio&#039; drivers for my drives?<br />I&#039;m looking for ones with best performance for SSD drive, (have both SSD, for linux and windows).</p><p>@mauorrizze Windows 7</p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1503710">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1503719" class="blockpost roweven"> <h2><span><span class="conr">#4216</span> <a href="viewtopic.php?pid=1503719#p1503719">2015-02-17 11:59:52</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=84760">Denso</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd class="postavatar"><img src="https://bbs.archlinux.org/img/avatars/84760.png?m=1412533733" width="71" height="80" alt="" /></dd> <dd><span>Registered: 2014-08-30</span></dd> <dd><span>Posts: 179</span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>Len wrote:</cite><blockquote><div><p>@mauorrizze Windows 7</p></div></blockquote></div><p>It won&#039;t work with OVMF without some hacking , you can search for some posts about installing it from FAT32 USB drive .</p><p>Also , I think its better to use SCSI rather than AHCI . My drives defined as follows :</p><div class="codebox"><pre><code>-drive file=/VMs/Win_Main.img,cache=writeback,format=raw,if=none,id=drive0,aio=threads \ -device virtio-blk-pci,drive=drive0,ioeventfd=on,bootindex=1 \ -device virtio-scsi-pci,id=scsi \ -drive file=/VMs/Win8.iso,id=iso_install,if=none \ -device scsi-cd,drive=iso_install \ -cdrom /VMs/virtio.iso \</code></pre></div><p>Good luck !</p> <p class="postedit"><em>Last edited by Denso (2015-02-17 12:00:37)</em></p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1503719">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1503766" class="blockpost rowodd"> <h2><span><span class="conr">#4217</span> <a href="viewtopic.php?pid=1503766#p1503766">2015-02-17 15:33:23</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=79471">Bronek</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>From: London</span></dd> <dd><span>Registered: 2014-02-14</span></dd> <dd><span>Posts: 90</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=79471">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>Len wrote:</cite><blockquote><div><p>Thanks for reply, I&#039;ll try it right now.</p><p>So I&#039;m assuming that after installation, I should still use &#039;virtio&#039; drivers for my drives?</p></div></blockquote></div><p>that&#039;s right</p> </div> <div class="postsignature postmsg"><hr /><p>Sorry about&#160; &quot;KVM VGA-Passthrough ...&quot; thread <img src="https://bbs.archlinux.org/img/smilies/sad.png" width="15" height="15" alt="sad" /> Anyone interested in continuing this discussion elsewhere, please contact me privately. I might be able to find it a new home.</p></div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1503766">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1503811" class="blockpost roweven"> <h2><span><span class="conr">#4218</span> <a href="viewtopic.php?pid=1503811#p1503811">2015-02-17 18:03:27</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=87813">Len</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd class="postavatar"><img src="https://bbs.archlinux.org/img/avatars/87813.png?m=1420509844" width="80" height="80" alt="" /></dd> <dd><span>Registered: 2015-01-06</span></dd> <dd><span>Posts: 23</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=87813">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>Denso wrote:</cite><blockquote><div><div class="quotebox"><cite>Len wrote:</cite><blockquote><div><p>@mauorrizze Windows 7</p></div></blockquote></div><p>It won&#039;t work with OVMF without some hacking , you can search for some posts about installing it from FAT32 USB drive .</p><p>Also , I think its better to use SCSI rather than AHCI . My drives defined as follows :</p><div class="codebox"><pre><code>-drive file=/VMs/Win_Main.img,cache=writeback,format=raw,if=none,id=drive0,aio=threads \ -device virtio-blk-pci,drive=drive0,ioeventfd=on,bootindex=1 \ -device virtio-scsi-pci,id=scsi \ -drive file=/VMs/Win8.iso,id=iso_install,if=none \ -device scsi-cd,drive=iso_install \ -cdrom /VMs/virtio.iso \</code></pre></div><p>Good luck !</p></div></blockquote></div><p>No luck even with scsi device, still stuck at installing stage,<br />I was trying to boot in OVMF with usb device too (pendrive created using dd), but no luck yet.</p> <p class="postedit"><em>Last edited by Len (2015-02-17 18:04:06)</em></p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1503811">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1503818" class="blockpost rowodd"> <h2><span><span class="conr">#4219</span> <a href="viewtopic.php?pid=1503818#p1503818">2015-02-17 18:46:35</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=88915">sl44x</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2015-02-17</span></dd> <dd><span>Posts: 3</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=88915">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <p>Hello everbody. Just leaving my personal tests with my desktop hardware, from the last couple of days. This maybe can save some time for someone with similar hardware:</p><p>Gigabyte GA-H61M-D2-B3<br />Intel i5 2500 @ 3300 Mhz<br />Intel IGP<br />NVidia GeForce 9600GT (to passthrough)</p><p>I tryed with default Arch Kernel (latest) with no success and then try with custom patches from topic author, also, with no success.<br />In last, tryed with some other kernel parameters posted here like ACS override and vfio_iommu_type1.allow_unsafe_interrupts, but no success.</p><p><strong>Working:</strong></p><p>- Only can enable the Intel IOMMU on Kernel and get only this one message on dmesg: ([0.000000] Intel-IOMMU: enabled)</p><p><strong>Issues:</strong></p><p>- No mapping DMAR or others IOMMU related messages on dmesg. Just the above.<br />- The &quot;/sys/kernel/iommu_groups&quot; is always empty.<br />- The device to passthrough dont have a iommu_group link in &quot;/sys/bus/pci/devices/$dev&quot;<br />- In case to ignore all these &quot;issues&quot; and continue with vfio-bind command and open the qemu receive a already waited &quot;vfio: error no iommu_group for device&quot;.</p><p><strong>P.S:</strong></p><p>- All tests done with NVidia driver on blacklist at &quot;/etc/modprobe.d/blacklist.conf&quot;<br />- The MOBA has no IOMMU/VT-d related configs on BIOS, but a generic &quot;Enable Virtualization Features&quot; (obviously made all tests with this enabled).<br />- I have seen some people reporting successuly VGA passthrough with H61 chipset from Intel, but with other MOBOs with same chipset (all reports I read are from non-Gigabyte). But with this from Gigabyte, I can&#039;t.</p><p><strong>Final consideration:</strong></p><p>- I assume that this MOBO (Gigabyte GA-H61M-D2-B3) don&#039;t support the VT-d (IOMMU) feature.</p><p>Someone else have any suggestion to try something more? Thanks.</p> <p class="postedit"><em>Last edited by sl44x (2015-02-17 18:50:27)</em></p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1503818">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1503828" class="blockpost roweven"> <h2><span><span class="conr">#4220</span> <a href="viewtopic.php?pid=1503828#p1503828">2015-02-17 19:26:27</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=85314">Duelist</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2014-09-22</span></dd> <dd><span>Posts: 358</span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>sl44x wrote:</cite><blockquote><div><p><strong>Final consideration:</strong></p><p>- I assume that this MOBO (Gigabyte GA-H61M-D2-B3) don&#039;t support the VT-d (IOMMU) feature.</p><p>Someone else have any suggestion to try something more? Thanks.</p></div></blockquote></div><p>Check for BIOS updates, my ASUS mobo didn&#039;t support IOMMU from two revisions ago, and there was a release with broken IOMMU support.</p> <p class="postedit"><em>Last edited by Duelist (2015-02-17 19:26:37)</em></p> </div> <div class="postsignature postmsg"><hr /><p><span class="bbs">The forum rules prohibit requesting support for distributions other than arch.</span><br /><a href="https://bbs.archlinux.org/viewtopic.php?pid=1551460#p1551460" rel="nofollow">I gave up.</a><a href="https://bbs.archlinux.org/viewtopic.php?id=162768" rel="nofollow"> It was too late.</a><br /><a href="http://pastebin.com/B3fL84bq" rel="nofollow">What I was trying to do</a>.<br /><a href="http://vfio.blogspot.com/" rel="nofollow">The reference about VFIO and KVM VGA passthrough.</a></p></div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1503828">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1503853" class="blockpost rowodd"> <h2><span><span class="conr">#4221</span> <a href="viewtopic.php?pid=1503853#p1503853">2015-02-17 20:14:29</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=88915">sl44x</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2015-02-17</span></dd> <dd><span>Posts: 3</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=88915">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>Duelist wrote:</cite><blockquote><div><div class="quotebox"><cite>sl44x wrote:</cite><blockquote><div><p><strong>Final consideration:</strong></p><p>- I assume that this MOBO (Gigabyte GA-H61M-D2-B3) don&#039;t support the VT-d (IOMMU) feature.</p><p>Someone else have any suggestion to try something more? Thanks.</p></div></blockquote></div><p>Check for BIOS updates, my ASUS mobo didn&#039;t support IOMMU from two revisions ago, and there was a release with broken IOMMU support.</p></div></blockquote></div><p>Yes, sadly forgot to say that update the BIOS was one of the first things that I tryed. My BIOS already is in the latest version available. Thanks anyways.</p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1503853">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1503881" class="blockpost roweven"> <h2><span><span class="conr">#4222</span> <a href="viewtopic.php?pid=1503881#p1503881">2015-02-17 21:38:43</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=84538">mauorrizze</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2014-08-22</span></dd> <dd><span>Posts: 17</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=84538">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <p>@Len: you can try to drop -smp and use only one core and/or force -cpu hv_time=off<br />According to <a href="https://bugzilla.redhat.com/show_bug.cgi?id=1185253" rel="nofollow">https://bugzilla.redhat.com/show_bug.cgi?id=1185253</a> it&#039;s a interference bug between ovmf, smp and hyperv-timer but in my experience it&#039;s sadly a more general problem with ovmf and window 7 at the moment. Maybe try different versions of qemu and ovmf.</p><p>@All:<br />If both graphic cards are in the same IOMMU group, then I can only pass one or both of them to a common guest VM, not each to different guests, is that correct?</p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1503881">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1503882" class="blockpost rowodd"> <h2><span><span class="conr">#4223</span> <a href="viewtopic.php?pid=1503882#p1503882">2015-02-17 21:49:01</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=75968">deniv</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2013-10-16</span></dd> <dd><span>Posts: 27</span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <p>Recently I bought a sound card because I was fed up with laggy sound in VMs. The card works. I can pass it through... but only by soft-removing my main usb2.0 controller. All because the controller and the card share the same IRQ. I can live without that controller (already swapped my keyboard, mouse, etc to available usb3.0 ports), but it still sucks when you can&#039;t use 4 out of 6 available ports on a motherboard. I don&#039;t mind losing the controller while the VM is online. Therefore I&#039;ve been using soft-remove (echo 1 &gt; /sys/bus/pci/devices/***/remove) . But the biggest issue is that I have to reboot every time to get the controller back online. I also tried assigning both the controller and the sound card to the VM, but it doesn&#039;t work. What else I can do?</p><p>This is the error in dmesg when I try to assign the sound card alone or both the controller and the card:</p><div class="codebox"><pre><code>genirq: Flags mismatch irq 16. 00000080 (vfio-intx(0000:00:1a.0)) vs. 00000000 (vfio-intx(0000:08:04.0))</code></pre></div><p>And here is the relevant lspci output (the sound card is behind a bridge, which I don&#039;t assign): </p><div class="codebox"><pre class="vscroll"><code>00:1a.0 USB controller: Intel Corporation 7 Series/C210 Series Chipset Family USB Enhanced Host Controller #2 (rev 04) (prog-if 20 [EHCI]) Subsystem: Gigabyte Technology Co., Ltd 7 Series/C210 Series Chipset Family USB Enhanced Host Controller Control: I/O- Mem+ BusMaster+ SpecCycle- MemWINV- VGASnoop- ParErr- Stepping- SERR- FastB2B- DisINTx- Status: Cap+ 66MHz- UDF- FastB2B+ ParErr- DEVSEL=medium &gt;TAbort- &lt;TAbort- &lt;MAbort- &gt;SERR- &lt;PERR- INTx- Latency: 0 Interrupt: pin A routed to IRQ 16 Region 0: Memory at f7a18000 (32-bit, non-prefetchable) [size=1K] Capabilities: [50] Power Management version 2 Flags: PMEClk- DSI- D1- D2- AuxCurrent=375mA PME(D0+,D1-,D2-,D3hot+,D3cold+) Status: D0 NoSoftRst- PME-Enable- DSel=0 DScale=0 PME- Capabilities: [58] Debug port: BAR=1 offset=00a0 Capabilities: [98] PCI Advanced Features AFCap: TP+ FLR+ AFCtrl: FLR- AFStatus: TP- Kernel driver in use: ehci-pci 07:00.0 PCI bridge: ASMedia Technology Inc. ASM1083/1085 PCIe to PCI Bridge (rev 04) (prog-if 00 [Normal decode]) Control: I/O+ Mem+ BusMaster+ SpecCycle- MemWINV- VGASnoop- ParErr- Stepping- SERR+ FastB2B- DisINTx- Status: Cap+ 66MHz- UDF- FastB2B- ParErr- DEVSEL=fast &gt;TAbort- &lt;TAbort- &lt;MAbort- &gt;SERR- &lt;PERR- INTx- Latency: 0, Cache Line Size: 32 bytes Interrupt: pin A routed to IRQ 16 Bus: primary=07, secondary=08, subordinate=08, sec-latency=64 I/O behind bridge: 0000c000-0000cfff Memory behind bridge: fff00000-000fffff Prefetchable memory behind bridge: 00000000fff00000-00000000000fffff Secondary status: 66MHz+ FastB2B- ParErr- DEVSEL=fast &gt;TAbort- &lt;TAbort- &lt;MAbort+ &lt;SERR- &lt;PERR- BridgeCtl: Parity- SERR+ NoISA- VGA- MAbort- &gt;Reset- FastB2B- PriDiscTmr- SecDiscTmr- DiscTmrStat- DiscTmrSERREn- Capabilities: [50] MSI: Enable- Count=1/1 Maskable- 64bit+ Address: 0000000000000000 Data: 0000 Capabilities: [78] Power Management version 3 Flags: PMEClk- DSI+ D1+ D2+ AuxCurrent=0mA PME(D0+,D1+,D2+,D3hot+,D3cold+) Status: D0 NoSoftRst+ PME-Enable- DSel=0 DScale=0 PME- Capabilities: [80] Express (v1) PCI-Express to PCI/PCI-X Bridge, MSI 00 DevCap: MaxPayload 128 bytes, PhantFunc 0 ExtTag- AttnBtn- AttnInd- PwrInd- RBE+ DevCtl: Report errors: Correctable- Non-Fatal- Fatal- Unsupported- RlxdOrd- ExtTag- PhantFunc- AuxPwr- NoSnoop+ BrConfRtry- MaxPayload 128 bytes, MaxReadReq 512 bytes DevSta: CorrErr- UncorrErr+ FatalErr- UnsuppReq- AuxPwr- TransPend- LnkCap: Port #1, Speed 2.5GT/s, Width x1, ASPM L0s L1, Exit Latency L0s &lt;2us, L1 &lt;2us ClockPM- Surprise- LLActRep- BwNot- ASPMOptComp- LnkCtl: ASPM Disabled; RCB 64 bytes Disabled- CommClk- ExtSynch- ClockPM- AutWidDis- BWInt- AutBWInt- LnkSta: Speed 2.5GT/s, Width x1, TrErr- Train- SlotClk- DLActive- BWMgmt- ABWMgmt- Capabilities: [c0] Subsystem: Device 0000:0000 Capabilities: [100 v1] Virtual Channel Caps: LPEVC=0 RefClk=100ns PATEntryBits=1 Arb: Fixed- WRR32- WRR64- WRR128- Ctrl: ArbSelect=Fixed Status: InProgress- VC0: Caps: PATOffset=00 MaxTimeSlots=1 RejSnoopTrans- Arb: Fixed- WRR32- WRR64- WRR128- TWRR128- WRR256- Ctrl: Enable+ ID=0 ArbSelect=Fixed TC/VC=01 Status: NegoPending- InProgress- 08:04.0 Multimedia audio controller: C-Media Electronics Inc CMI8788 [Oxygen HD Audio] Subsystem: ASUSTeK Computer Inc. CMI8788 [Oxygen HD Audio] Control: I/O- Mem- BusMaster- SpecCycle- MemWINV- VGASnoop- ParErr- Stepping- SERR- FastB2B- DisINTx- Status: Cap+ 66MHz- UDF- FastB2B- ParErr- DEVSEL=medium &gt;TAbort- &lt;TAbort- &lt;MAbort- &gt;SERR- &lt;PERR- INTx- Interrupt: pin A routed to IRQ 16 Region 0: I/O ports at c000 [disabled] [size=256] Capabilities: [c0] Power Management version 2 Flags: PMEClk- DSI- D1+ D2+ AuxCurrent=0mA PME(D0-,D1-,D2-,D3hot-,D3cold-) Status: D0 NoSoftRst- PME-Enable- DSel=0 DScale=0 PME-</code></pre></div> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1503882">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1503888" class="blockpost roweven"> <h2><span><span class="conr">#4224</span> <a href="viewtopic.php?pid=1503888#p1503888">2015-02-17 22:00:42</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=75968">deniv</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2013-10-16</span></dd> <dd><span>Posts: 27</span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>Duelist wrote:</cite><blockquote><div><p>P.S. if anyone needs UEFI-combatible VBIOS file for ASUS HD7750(silent, 800mhz one, but i think it&#039;s possible to edit it for any card) - send me an e-mail, because i seem to be unable to get it officially from support anymore.</p></div></blockquote></div><p>Sorry, can I request that vbios file here (i.e. without sending you an email)? Also, sorry if you&#039;ve already answered such a question. I haven&#039;t read all the posts after that message.</p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1503888">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1503890" class="blockpost rowodd"> <h2><span><span class="conr">#4225</span> <a href="viewtopic.php?pid=1503890#p1503890">2015-02-17 22:06:13</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=85314">Duelist</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2014-09-22</span></dd> <dd><span>Posts: 358</span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <p>Alright, something is very broken here.</p><div class="codebox"><pre><code>sudo qemu-system-x86_64 \ -d out_asm,in_asm,op,op_opt,int,exec,cpu,pcall,cpu_reset,ioport,unimp,guest_errors \ -D /mnt/hdd/qemu/log-`date +%d-%m-%y-%T`.log \ -enable-kvm \ -M pc \ -m 4096 \ -cpu host,hv_relaxed,hv_spinlocks=0x1fff,hv_vapic,hv_time \ -smp 4,sockets=1,cores=4,threads=1 \ -vga none \ -usb \ -boot menu=on \ -soundhw hda \ -device vfio-pci,host=01:00.0,x-vga=off,multifunction=on \ -device vfio-pci,host=01:00.1 \ ...various stuff... -device qxl \ -drive if=pflash,format=raw,readonly,file=/mnt/hdd/qemu/OVMF_CODE.fd \ -drive if=pflash,format=raw,file=/mnt/hdd/qemu/OVMF_VARS.fd</code></pre></div><p>And...<br /><a href="http://pastebin.com/MVaMNp7K" rel="nofollow">http://pastebin.com/MVaMNp7K</a><br />100% cpu load, nothing on any output.<br />Pure nothing!<br />WTF?</p><p>When booting bare metal, i can see the setup menu and even attempt to boot into windows7. But windows7 fails to output video signal after the starting logo.</p><p>UPD:<br />Alright, i&#039;ve connected to qemu via gdb(had to set the mode manually), and..<br />I&#039;m no low-level specialist, but something hints me that this won&#039;t work:</p><div class="codebox"><pre class="vscroll"><code>(gdb) info reg rax 0x0 0 rbx 0x810248 8454728 rcx 0x402 1026 rdx 0x402 1026 rsi 0x10 16 rdi 0xbfed1060 3219984480 rbp 0xbff62ad0 0xbff62ad0 rsp 0xbff62ac0 0xbff62ac0 r8 0x1 1 r9 0x0 0 r10 0x36 54 r11 0xd7 215 r12 0x0 0 r13 0x0 0 r14 0x0 0 r15 0x0 0 rip 0xbed9d9df 0xbed9d9df eflags 0x246 [ PF ZF IF ] cs 0x28 40 ss 0x8 8 ds 0x8 8 es 0x8 8 fs 0x8 8 gs 0x8 8 (gdb) x/10i $rip =&gt; 0xbed9d9df: mov -0x8(%rbp),%rax 0xbed9d9e3: test %rax,%rax 0xbed9d9e6: je 0xbed9d9df 0xbed9d9e8: leaveq 0xbed9d9e9: retq 0xbed9d9ea: push %rbp 0xbed9d9eb: mov %rsp,%rbp 0xbed9d9ee: sti 0xbed9d9ef: pop %rbp 0xbed9d9f0: retq</code></pre></div><p><span class="bbs">I don&#039;t recall mov being able to do stuff with MINUS, but let it be.<br />So it seems like we&#039;re trying to set RBP(Stack Base pointer register Holds the base address of the stack) to zero(RAX) MINUS 0x8. </span></p><p><span class="bbs">I&#039;m not familiar with GDB at all, but this looks strange as hell.<br />I guess i&#039;ll have to start qemu with -S and run the VM step-by-step.<br />Something hints me that the ROM on the device is broken, since this kind of stuff happens only after i add the ROM(currently it&#039;s flashed on the hardware).</span><br />Damn, forgot that it&#039;s AT&amp;T syntax, so we&#039;re writing RBP-0x8 to RAX, and previously(at 0xbed9d9d7, not shown in the post) we did &quot; movl $0x0,-0x8(%rbp)&quot; and we have our zero in RAX. Why did it stop..<br />UPD2:<br />topkek. It moves zero to RAX, compares RAX with RAX, sets ZF to 1 and does JE(if ZF=1 then jump) back to that MOV. Alright, now i know that something is deeply borked here. Now i must determine where did this come from..</p> <p class="postedit"><em>Last edited by Duelist (2015-02-18 00:25:16)</em></p> </div> <div class="postsignature postmsg"><hr /><p><span class="bbs">The forum rules prohibit requesting support for distributions other than arch.</span><br /><a href="https://bbs.archlinux.org/viewtopic.php?pid=1551460#p1551460" rel="nofollow">I gave up.</a><a href="https://bbs.archlinux.org/viewtopic.php?id=162768" rel="nofollow"> It was too late.</a><br /><a href="http://pastebin.com/B3fL84bq" rel="nofollow">What I was trying to do</a>.<br /><a href="http://vfio.blogspot.com/" rel="nofollow">The reference about VFIO and KVM VGA passthrough.</a></p></div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1503890">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div class="postlinksb"> <div class="inbox crumbsplus"> <div class="pagepost"> <p class="pagelink conl"><span class="pages-label">Pages: </span><a rel="prev" class="item1" href="viewtopic.php?id=162768&amp;p=168">Previous</a> <a href="viewtopic.php?id=162768">1</a> <span class="spacer">…</span> <a href="viewtopic.php?id=162768&amp;p=167">167</a> <a href="viewtopic.php?id=162768&amp;p=168">168</a> <strong>169</strong> <a href="viewtopic.php?id=162768&amp;p=170">170</a> <a href="viewtopic.php?id=162768&amp;p=171">171</a> <span class="spacer">…</span> <a href="viewtopic.php?id=162768&amp;p=234">234</a> <a rel="next" href="viewtopic.php?id=162768&amp;p=170">Next</a></p> <p class="postlink conr">Topic closed</p> </div> <ul class="crumbs"> <li><a href="index.php">Index</a></li> <li><span>»&#160;</span><a href="viewforum.php?id=48">Topics Going Nowhere</a></li> <li><span>»&#160;</span><strong><a href="viewtopic.php?id=162768">KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</a></strong></li> </ul> <p class="subscribelink clearb"><a href="misc.php?action=subscribe&amp;tid=162768">Subscribe to this topic</a></p> <div class="clearer"></div> </div> </div> </div> <div id="brdfooter" class="block"> <h2><span>Board footer</span></h2> <div class="box"> <div id="brdfooternav" class="inbox"> <div class="conl"> <form id="qjump" method="get" action="viewforum.php"> <div><label><span>Jump to<br /></span> <select name="id" onchange="window.location=('viewforum.php?id='+this.options[this.selectedIndex].value)"> <optgroup label="Technical Issues and Assistance"> <option value="23">Newbie Corner</option> <option value="17">Installation</option> <option value="22">Kernel &amp; Hardware</option> <option value="18">Applications &amp; Desktop Environments</option> <option value="31">Laptop Issues</option> <option value="8">Networking, Server, and Protection</option> <option value="32">Multimedia and Games</option> <option value="50">System Administration</option> <option value="35">Other Architectures</option> </optgroup> <optgroup label="Arch-centric"> <option value="24">Announcements, Package &amp; Security Advisories</option> <option value="1">Arch Discussion</option> <option value="13">Forum &amp; Wiki discussion</option> </optgroup> <optgroup label="Pacman Upgrades, Packaging &amp; AUR"> <option value="44">Pacman &amp; Package Upgrade Issues</option> <option value="49">[testing] Repo Forum</option> <option value="4">Creating &amp; Modifying Packages</option> <option value="38">AUR Issues, Discussion &amp; PKGBUILD Requests</option> </optgroup> <optgroup label="Contributions &amp; Discussion"> <option value="20">GNU/Linux Discussion</option> <option value="27">Community Contributions</option> <option value="33">Programming &amp; Scripting</option> <option value="30">Other Languages</option> <option value="47">Artwork and Screenshots</option> <option value="42">Try This</option> </optgroup> <optgroup label="/dev/null"> <option value="29">Off-Topic</option> <option value="48" selected="selected">Topics Going Nowhere</option> <option value="36">Dustbin</option> </optgroup> </select></label> <input type="submit" value=" Go " accesskey="g" /> </div> </form> </div> <div class="conr"> <p id="feedlinks"><span class="atom"><a href="extern.php?action=feed&amp;tid=162768&amp;type=atom">Atom topic feed</a></span></p> <p id="poweredby">Powered by <a href="http://fluxbb.org/">FluxBB</a></p> </div> <div class="clearer"></div> </div> </div> </div> </div> <div class="end-box"></div> </div> </body> </html>
