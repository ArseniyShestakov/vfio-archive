<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"> <html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en" dir="ltr"> <head> <meta http-equiv="Content-Type" content="text/html; charset=utf-8" /> <title>KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9 (Page 26) / Topics Going Nowhere / Arch Linux Forums</title> <link rel="stylesheet" type="text/css" href="style/ArchLinux.css" /> <link rel="canonical" href="viewtopic.php?id=162768&amp;p=26" title="Page 26" /> <link rel="prev" href="viewtopic.php?id=162768&amp;p=25" title="Page 25" /> <link rel="next" href="viewtopic.php?id=162768&amp;p=27" title="Page 27" /> <link rel="alternate" type="application/atom+xml" href="extern.php?action=feed&amp;tid=162768&amp;type=atom" title="Atom topic feed" /> <link rel="stylesheet" media="screen" href="style/ArchLinux/arch.css?v=3" /> <link rel="stylesheet" media="screen" href="style/ArchLinux/archnavbar.css?v=2" /> <link rel="shortcut icon" href="style/ArchLinux/favicon.ico" /> </head> <body> <div id="archnavbar" class="anb-forum"> <div id="archnavbarlogo"><h1><a href="http://www.archlinux.org/">Arch Linux</a></h1></div> <div id="archnavbarmenu"> <ul id="archnavbarlist"> <li id="anb-home"><a href="http://www.archlinux.org/">Home</a></li><li id="anb-packages"><a href="http://www.archlinux.org/packages/">Packages</a></li><li id="anb-forums" class="anb-selected"><a href="https://bbs.archlinux.org/">Forums</a></li><li id="anb-wiki"><a href="https://wiki.archlinux.org/">Wiki</a></li><li id="anb-bugs"><a href="https://bugs.archlinux.org/">Bugs</a></li><li id="anb-aur"><a href="https://aur.archlinux.org/">AUR</a></li><li id="anb-download"><a href="http://www.archlinux.org/download/">Download</a></li> </ul> </div> </div> <div id="punviewtopic" class="pun"> <div class="top-box"></div> <div class="punwrap"> <div id="brdheader" class="block"> <div class="box"> <div id="brdmenu" class="inbox"> <ul> <li id="navindex" class="isactive"><a href="index.php">Index</a></li> <li id="navuserlist"><a href="userlist.php">User list</a></li> <li id="navsearch"><a href="search.php">Search</a></li> <li id="navprofile"><a href="profile.php?id=80749">Profile</a></li> <li id="navlogout"><a href="login.php?action=out&amp;id=80749&amp;csrf_token=5c20501ec397bb45ef8ee8c84db232c8d8e421c6">Logout</a></li> </ul> </div> <div id="brdwelcome" class="inbox"> <ul class="conl"> <li><span>Logged in as <strong>SXX</strong></span></li> <li><span>Last visit: 2015-08-16 12:20:09</span></li> </ul> <ul class="conr"> <li><span>Topics: <a href="search.php?action=show_replies" title="Find topics you have posted to.">Posted</a> | <a href="search.php?action=show_new" title="Find topics with new posts since your last visit.">New</a> | <a href="search.php?action=show_recent" title="Find topics with recent posts.">Active</a> | <a href="search.php?action=show_unanswered" title="Find topics with no replies.">Unanswered</a></span></li> </ul> <div class="clearer"></div> </div> </div> </div> <div id="brdmain"> <div class="linkst"> <div class="inbox crumbsplus"> <ul class="crumbs"> <li><a href="index.php">Index</a></li> <li><span>»&#160;</span><a href="viewforum.php?id=48">Topics Going Nowhere</a></li> <li><span>»&#160;</span><strong><a href="viewtopic.php?id=162768">KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</a></strong></li> </ul> <div class="pagepost"> <p class="pagelink conl"><span class="pages-label">Pages: </span><a rel="prev" class="item1" href="viewtopic.php?id=162768&amp;p=25">Previous</a> <a href="viewtopic.php?id=162768">1</a> <span class="spacer">…</span> <a href="viewtopic.php?id=162768&amp;p=24">24</a> <a href="viewtopic.php?id=162768&amp;p=25">25</a> <strong>26</strong> <a href="viewtopic.php?id=162768&amp;p=27">27</a> <a href="viewtopic.php?id=162768&amp;p=28">28</a> <span class="spacer">…</span> <a href="viewtopic.php?id=162768&amp;p=234">234</a> <a rel="next" href="viewtopic.php?id=162768&amp;p=27">Next</a></p> <p class="postlink conr">Topic closed</p> </div> <div class="clearer"></div> </div> </div> <div id="p1342830" class="blockpost rowodd blockpost1"> <h2><span><span class="conr">#626</span> <a href="viewtopic.php?pid=1342830#p1342830">2013-10-29 13:07:14</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=73162">myweb</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2013-07-13</span></dd> <dd><span>Posts: 68</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=73162">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>aw wrote:</cite><blockquote><div><p>And how did the 7750 work?</p></div></blockquote></div><p>Windows 8 performance test shows: Graphics performance is 7.3 for 3d/2d.<br />But I noticed mouse hanging (not smooth moving) when Windows asks Administrator privileges (all screen covered with gray and just one dialog, that asks about administrator privileges, is active)</p><div class="quotebox"><cite>aw wrote:</cite><blockquote><div><p>Did you happen to be using a pre-rc5 kernel that already included these?</p></div></blockquote></div><p>No</p><p>I need help one more time ... I get no success to boot already installed Windows 7 to real drive.<br />Partition table looks like:<br />sda1 EFI<br />sda2 Linux Swap<br />sda3 GPT system<br />sda4 Arch Linux (KVM qemu host)<br />sda5 Windows 7</p><p>I specified:<br />-drive file=/dev/sda,id=disk,format=raw -device ide-hd,bus=ahci.0,drive=disk</p><p>But I got black screen, not windows booting.<br />Could you please help to boot from real hard drive?</p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1342830">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1342855" class="blockpost roweven"> <h2><span><span class="conr">#627</span> <a href="viewtopic.php?pid=1342855#p1342855">2013-10-29 14:17:23</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=75590">aw</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2013-10-04</span></dd> <dd><span>Posts: 921</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=75590">Email</a></span> <span class="website"><a href="http://vfio.blogspot.com/" rel="nofollow">Website</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>myweb wrote:</cite><blockquote><div><div class="quotebox"><cite>aw wrote:</cite><blockquote><div><p>And how did the 7750 work?</p></div></blockquote></div><p>Windows 8 performance test shows: Graphics performance is 7.3 for 3d/2d.<br />But I noticed mouse hanging (not smooth moving) when Windows asks Administrator privileges (all screen covered with gray and just one dialog, that asks about administrator privileges, is active)</p><div class="quotebox"><cite>aw wrote:</cite><blockquote><div><p>Did you happen to be using a pre-rc5 kernel that already included these?</p></div></blockquote></div><p>No</p><p>I need help one more time ... I get no success to boot already installed Windows 7 to real drive.<br />Partition table looks like:<br />sda1 EFI<br />sda2 Linux Swap<br />sda3 GPT system<br />sda4 Arch Linux (KVM qemu host)<br />sda5 Windows 7</p><p>I specified:<br />-drive file=/dev/sda,id=disk,format=raw -device ide-hd,bus=ahci.0,drive=disk</p><p>But I got black screen, not windows booting.<br />Could you please help to boot from real hard drive?</p></div></blockquote></div><p>This is effectively the same as moving a disk with a windows install from one physical system to another.&#160; Windows does not do well with this.&#160; There are those that can hack it to work, but for best results, it&#039;s recommended to use a separate install.</p> <p class="postedit"><em>Last edited by aw (2013-10-29 14:17:41)</em></p> </div> <div class="postsignature postmsg"><hr /><p><a href="http://vfio.blogspot.com" rel="nofollow">http://vfio.blogspot.com</a><br />Looking for a more open forum to discuss vfio related uses?&#160; Try <a href="https://www.redhat.com/mailman/listinfo/vfio-users" rel="nofollow">https://www.redhat.com/mailman/listinfo/vfio-users</a></p></div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1342855">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1342914" class="blockpost rowodd"> <h2><span><span class="conr">#628</span> <a href="viewtopic.php?pid=1342914#p1342914">2013-10-29 17:16:20</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=75590">aw</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2013-10-04</span></dd> <dd><span>Posts: 921</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=75590">Email</a></span> <span class="website"><a href="http://vfio.blogspot.com/" rel="nofollow">Website</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <p>I gave a talk about VFIO-VGA support at KVM Forum last week.&#160; Unfortunately due to technology malfunction there&#039;s no video, but the slides are linked here:</p><p><a href="https://plus.google.com/107691536544094955898/posts/9y8EHhJ6PWz" rel="nofollow">https://plus.google.com/107691536544094 … y8EHhJ6PWz</a></p> </div> <div class="postsignature postmsg"><hr /><p><a href="http://vfio.blogspot.com" rel="nofollow">http://vfio.blogspot.com</a><br />Looking for a more open forum to discuss vfio related uses?&#160; Try <a href="https://www.redhat.com/mailman/listinfo/vfio-users" rel="nofollow">https://www.redhat.com/mailman/listinfo/vfio-users</a></p></div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1342914">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1342917" class="blockpost roweven"> <h2><span><span class="conr">#629</span> <a href="viewtopic.php?pid=1342917#p1342917">2013-10-29 17:21:39</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=75590">aw</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2013-10-04</span></dd> <dd><span>Posts: 921</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=75590">Email</a></span> <span class="website"><a href="http://vfio.blogspot.com/" rel="nofollow">Website</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>empie wrote:</cite><blockquote><div><p>Is the pcie_acs_override useful? Haven&#039;t used it up till now.</p></div></blockquote></div><p>It&#039;s useful if you have an IOMMU group that includes too many devices.&#160; Intel didn&#039;t include ACS support for the root ports in many of their chipsets and processors, without it we can&#039;t guarantee isolation between devices.&#160; We&#039;re working with Intel to get a whitelist of root ports to resolve this.&#160; In the meantime, yes the pcie_acs_override patch can be used as a workaround.&#160; Note that it only changes IOMMU group topology.&#160; It doesn&#039;t specifically fix or enabling anything new wrt VGA.</p> </div> <div class="postsignature postmsg"><hr /><p><a href="http://vfio.blogspot.com" rel="nofollow">http://vfio.blogspot.com</a><br />Looking for a more open forum to discuss vfio related uses?&#160; Try <a href="https://www.redhat.com/mailman/listinfo/vfio-users" rel="nofollow">https://www.redhat.com/mailman/listinfo/vfio-users</a></p></div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1342917">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1342939" class="blockpost rowodd"> <h2><span><span class="conr">#630</span> <a href="viewtopic.php?pid=1342939#p1342939">2013-10-29 18:38:50</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=72338">empie</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>From: The Netherlands</span></dd> <dd><span>Registered: 2013-06-15</span></dd> <dd><span>Posts: 9</span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>aw wrote:</cite><blockquote><div><p>It&#039;s useful if you have an IOMMU group that includes too many devices.&#160; Intel didn&#039;t include ACS support for the root ports in many of their chipsets and processors, without it we can&#039;t guarantee isolation between devices.&#160; We&#039;re working with Intel to get a whitelist of root ports to resolve this.&#160; In the meantime, yes the pcie_acs_override patch can be used as a workaround.&#160; Note that it only changes IOMMU group topology.&#160; It doesn&#039;t specifically fix or enabling anything new wrt VGA.</p></div></blockquote></div><p>Ok, thanks. Will give it a go in the next couple of days.</p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1342939">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1342995" class="blockpost roweven"> <h2><span><span class="conr">#631</span> <a href="viewtopic.php?pid=1342995#p1342995">2013-10-29 20:33:49</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=73162">myweb</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2013-07-13</span></dd> <dd><span>Posts: 68</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=73162">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <p>I use the following script to bind devices:</p><div class="codebox"><pre><code>#!/bin/bash modprobe vfio-pci for dev in &quot;$@&quot;; do vendor=$(cat /sys/bus/pci/devices/$dev/vendor) device=$(cat /sys/bus/pci/devices/$dev/device) if [ -e /sys/bus/pci/devices/$dev/driver ]; then echo $dev &gt; /sys/bus/pci/devices/$dev/driver/unbind fi echo $vendor $device &gt; /sys/bus/pci/drivers/vfio-pci/new_id done</code></pre></div><p>without &quot;pcie_acs_override=downstream&quot; &quot;ls /sys/bus/pci/devices/0000\:02\:00.0/iommu_group/devices/&quot; shows:</p><div class="codebox"><pre><code>0000:00:1c.0 0000:00:1c.4 0000:00:1c.5 0000:00:1c.7 0000:02:00.0 0000:02:00.1 0000:03:00.0 0000:04:01.0 0000:05:00.0 0000:06:00.0</code></pre></div><p>with:</p><div class="codebox"><pre><code>0000:02:00.0 0000:02:00.1</code></pre></div> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1342995">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1342998" class="blockpost rowodd"> <h2><span><span class="conr">#632</span> <a href="viewtopic.php?pid=1342998#p1342998">2013-10-29 20:38:46</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=73162">myweb</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2013-07-13</span></dd> <dd><span>Posts: 68</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=73162">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <p><strong>@nbhs, @aw</strong><br />I think it would be great to create some kind of Wiki page with summary/list of successful configuration (CPU, Motherboard, VideoCard) and short note of specific settings for particular configuration fo example.<br />Do we have that page?</p><p>Is it correct that in order to use real partition along with virtual drive I need to specify:</p><div class="codebox"><pre><code>-drive file=/home/nbhs/windows.img,id=bootDisk,format=raw -device ide-hd,bus=ahci.0,drive=bootDisk -drive file=/dev/sdb,id=dataDisk,format=raw -device ide-hd,bus=ahci.1,drive=dataDisk</code></pre></div><p>Could you please clarify how to specify boot order for seabios: what drive to boot?</p> <p class="postedit"><em>Last edited by myweb (2013-10-30 11:09:15)</em></p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1342998">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1343361" class="blockpost roweven"> <h2><span><span class="conr">#633</span> <a href="viewtopic.php?pid=1343361#p1343361">2013-10-30 15:00:47</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=76389">blitzschlag</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2013-10-30</span></dd> <dd><span>Posts: 7</span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <p>hey </p><p>just wanted to chime in to report success on VGA passthrough with inspiration found in this Thread.</p><p>my Hardware<br />Gigabyte GA970A-UD3 (BIOS F8 beta with fixed ACPI-IVRS Table)<br />AMD Phenom II x6 1090T<br />EVGA Geforce GTX 285 <br />Sapphire Radeon HD 5670</p><p>My Software<br />Debian Jessie<br />Kernel 3.12rc6 (Jessie Stock 3.10-3 got no vfio-pci-vga enabled anyway)<br />qemu-kvm 1.6.0+dfsg-2 (debian unstable)<br />Windows7 x64 in VM with latest Nvidia Driver</p><p>Only downside is that i have the reboot issue. e.g. i can&#039;t reboot the Windows VM without rebooting the Host aswell.</p><p>Cheers for the Inspiration and Hints</p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1343361">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1343363" class="blockpost rowodd"> <h2><span><span class="conr">#634</span> <a href="viewtopic.php?pid=1343363#p1343363">2013-10-30 15:04:28</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=75590">aw</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2013-10-04</span></dd> <dd><span>Posts: 921</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=75590">Email</a></span> <span class="website"><a href="http://vfio.blogspot.com/" rel="nofollow">Website</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>blitzschlag wrote:</cite><blockquote><div><p>hey </p><p>just wanted to chime in to report success on VGA passthrough with inspiration found in this Thread.</p><p>my Hardware<br />Gigabyte GA970A-UD3 (BIOS F8 beta with fixed ACPI-IVRS Table)<br />AMD Phenom II x6 1090T<br />EVGA Geforce GTX 285 <br />Sapphire Radeon HD 5670</p><p>My Software<br />Debian Jessie<br />Kernel 3.12rc6 (Jessie Stock 3.10-3 got no vfio-pci-vga enabled anyway)<br />qemu-kvm 1.6.0+dfsg-2 (debian unstable)<br />Windows7 x64 in VM with latest Nvidia Driver</p><p>Only downside is that i have the reboot issue. e.g. i can&#039;t reboot the Windows VM without rebooting the Host aswell.</p><p>Cheers for the Inspiration and Hints</p></div></blockquote></div><p>Reboot should be fixed with current qemu.git or wait for 1.7 when it comes out.&#160; Just to be clear, you&#039;re assigning the GTX285 and the HD5670 is your host display, right?</p> </div> <div class="postsignature postmsg"><hr /><p><a href="http://vfio.blogspot.com" rel="nofollow">http://vfio.blogspot.com</a><br />Looking for a more open forum to discuss vfio related uses?&#160; Try <a href="https://www.redhat.com/mailman/listinfo/vfio-users" rel="nofollow">https://www.redhat.com/mailman/listinfo/vfio-users</a></p></div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1343363">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1343366" class="blockpost roweven"> <h2><span><span class="conr">#635</span> <a href="viewtopic.php?pid=1343366#p1343366">2013-10-30 15:10:33</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=76389">blitzschlag</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2013-10-30</span></dd> <dd><span>Posts: 7</span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>aw wrote:</cite><blockquote><div><p>Reboot should be fixed with current qemu.git or wait for 1.7 when it comes out.&#160; Just to be clear, you&#039;re assigning the GTX285 and the HD5670 is your host display, right?</p></div></blockquote></div><p>ah, cool</p><p>Yes, the GTX 285 is passed through to the Windows VM</p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1343366">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1343400" class="blockpost rowodd"> <h2><span><span class="conr">#636</span> <a href="viewtopic.php?pid=1343400#p1343400">2013-10-30 17:16:09</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=74748">kaeptnb</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2013-09-04</span></dd> <dd><span>Posts: 30</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=74748">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <p>Hi,</p><p>thanks for this thread! Using this setup for a couple of years under XEN - but with KVM and VFIO its easier and - the most important part - more stable (with xen the Guest-Reboot was not always successful - with KVM it is!).</p><p>Anyways i converted most of the manual qemu options into libvirt-xml - main reason was that libvirt handles vCPU pinning and i couln&#039;t find a way to do it manually.<br />Another positive effect is Host Startup/Shutdown handling due to the libvirt init script - they stop/start your Guest on Host startup/shutdown.</p><div class="codebox"><pre class="vscroll"><code>&lt;domain type=&#039;kvm&#039; id=&#039;26&#039; xmlns:qemu=&#039;http://libvirt.org/schemas/domain/qemu/1.0&#039;&gt; &lt;name&gt;windows7&lt;/name&gt; &lt;uuid&gt;xxxxxxx-xxxxx-xxxxx-xxxx-xxxxxxxxx&lt;/uuid&gt; &lt;memory unit=&#039;KiB&#039;&gt;8388608&lt;/memory&gt; &lt;currentMemory unit=&#039;KiB&#039;&gt;8388608&lt;/currentMemory&gt; &lt;memoryBacking&gt; &lt;nosharepages/&gt; &lt;locked/&gt; &lt;/memoryBacking&gt; &lt;vcpu placement=&#039;static&#039;&gt;4&lt;/vcpu&gt; &lt;cputune&gt; &lt;vcpupin vcpu=&#039;0&#039; cpuset=&#039;2&#039;/&gt; &lt;vcpupin vcpu=&#039;1&#039; cpuset=&#039;6&#039;/&gt; &lt;vcpupin vcpu=&#039;2&#039; cpuset=&#039;3&#039;/&gt; &lt;vcpupin vcpu=&#039;3&#039; cpuset=&#039;7&#039;/&gt; &lt;emulatorpin cpuset=&#039;0-1,4-5&#039;/&gt; &lt;/cputune&gt; &lt;resource&gt; &lt;partition&gt;/machine&lt;/partition&gt; &lt;/resource&gt; &lt;os&gt; &lt;type arch=&#039;x86_64&#039; machine=&#039;pc-q35-1.5&#039;&gt;hvm&lt;/type&gt; &lt;boot dev=&#039;hd&#039;/&gt; &lt;smbios mode=&#039;host&#039;/&gt; &lt;/os&gt; &lt;cpu mode=&#039;host-passthrough&#039;&gt; &lt;topology sockets=&#039;1&#039; cores=&#039;2&#039; threads=&#039;2&#039;/&gt; &lt;/cpu&gt; &lt;clock offset=&#039;localtime&#039;/&gt; &lt;on_poweroff&gt;destroy&lt;/on_poweroff&gt; &lt;on_reboot&gt;restart&lt;/on_reboot&gt; &lt;on_crash&gt;destroy&lt;/on_crash&gt; &lt;devices&gt; &lt;emulator&gt;/usr/local/kvm/bin/qemu-system-x86_64&lt;/emulator&gt; &lt;disk type=&#039;block&#039; device=&#039;disk&#039;&gt; &lt;driver name=&#039;qemu&#039; type=&#039;raw&#039; cache=&#039;none&#039; discard=&#039;unmap&#039;/&gt; &lt;source dev=&#039;/dev/ssd/win7system&#039;/&gt; &lt;target dev=&#039;vda&#039; bus=&#039;virtio&#039;/&gt; &lt;alias name=&#039;virtio-disk0&#039;/&gt; &lt;address type=&#039;pci&#039; domain=&#039;0x0000&#039; bus=&#039;0x02&#039; slot=&#039;0x03&#039; function=&#039;0x0&#039;/&gt; &lt;/disk&gt; &lt;disk type=&#039;block&#039; device=&#039;disk&#039;&gt; &lt;driver name=&#039;qemu&#039; type=&#039;raw&#039; cache=&#039;none&#039; discard=&#039;unmap&#039;/&gt; &lt;source dev=&#039;/dev/mapper/win7games_cached&#039;/&gt; &lt;target dev=&#039;vdb&#039; bus=&#039;virtio&#039;/&gt; &lt;alias name=&#039;virtio-disk1&#039;/&gt; &lt;address type=&#039;pci&#039; domain=&#039;0x0000&#039; bus=&#039;0x02&#039; slot=&#039;0x04&#039; function=&#039;0x0&#039;/&gt; &lt;/disk&gt; &lt;controller type=&#039;sata&#039; index=&#039;0&#039;&gt; &lt;alias name=&#039;sata0&#039;/&gt; &lt;address type=&#039;pci&#039; domain=&#039;0x0000&#039; bus=&#039;0x00&#039; slot=&#039;0x1f&#039; function=&#039;0x2&#039;/&gt; &lt;/controller&gt; &lt;controller type=&#039;pci&#039; index=&#039;0&#039; model=&#039;pcie-root&#039;&gt; &lt;alias name=&#039;pcie.0&#039;/&gt; &lt;/controller&gt; &lt;controller type=&#039;pci&#039; index=&#039;1&#039; model=&#039;dmi-to-pci-bridge&#039;&gt; &lt;alias name=&#039;pci.1&#039;/&gt; &lt;address type=&#039;pci&#039; domain=&#039;0x0000&#039; bus=&#039;0x00&#039; slot=&#039;0x02&#039; function=&#039;0x0&#039;/&gt; &lt;/controller&gt; &lt;controller type=&#039;pci&#039; index=&#039;2&#039; model=&#039;pci-bridge&#039;&gt; &lt;alias name=&#039;pci.2&#039;/&gt; &lt;address type=&#039;pci&#039; domain=&#039;0x0000&#039; bus=&#039;0x01&#039; slot=&#039;0x01&#039; function=&#039;0x0&#039;/&gt; &lt;/controller&gt; &lt;controller type=&#039;usb&#039; index=&#039;0&#039; model=&#039;none&#039;&gt; &lt;alias name=&#039;usb0&#039;/&gt; &lt;address type=&#039;pci&#039; domain=&#039;0x0000&#039; bus=&#039;0x02&#039; slot=&#039;0x01&#039; function=&#039;0x0&#039;/&gt; &lt;/controller&gt; &lt;interface type=&#039;bridge&#039;&gt; &lt;mac address=&#039;00:xx:xx:xx:xx:xx&#039;/&gt; &lt;source bridge=&#039;br0&#039;/&gt; &lt;target dev=&#039;vnet0&#039;/&gt; &lt;model type=&#039;virtio&#039;/&gt; &lt;alias name=&#039;net0&#039;/&gt; &lt;rom bar=&#039;off&#039;/&gt; &lt;address type=&#039;pci&#039; domain=&#039;0x0000&#039; bus=&#039;0x02&#039; slot=&#039;0x02&#039; function=&#039;0x0&#039;/&gt; &lt;/interface&gt; &lt;memballoon model=&#039;none&#039;&gt; &lt;alias name=&#039;balloon0&#039;/&gt; &lt;/memballoon&gt; &lt;/devices&gt; &lt;seclabel type=&#039;none&#039;/&gt; &lt;qemu:commandline&gt; &lt;qemu:arg value=&#039;-device&#039;/&gt; &lt;qemu:arg value=&#039;ioh3420,bus=pcie.0,addr=1c.0,multifunction=on,port=1,chassis=1,id=root.1&#039;/&gt; &lt;qemu:arg value=&#039;-device&#039;/&gt; &lt;qemu:arg value=&#039;vfio-pci,host=08:00.0,bus=root.1,addr=00.0,multifunction=on,x-vga=on&#039;/&gt; &lt;qemu:arg value=&#039;-device&#039;/&gt; &lt;qemu:arg value=&#039;vfio-pci,host=08:00.1,bus=root.1,addr=00.1&#039;/&gt; &lt;qemu:arg value=&#039;-device&#039;/&gt; &lt;qemu:arg value=&#039;vfio-pci,host=00:1d.0,bus=pcie.0&#039;/&gt; &lt;qemu:arg value=&#039;-device&#039;/&gt; &lt;qemu:arg value=&#039;vfio-pci,host=00:1d.1,bus=pcie.0&#039;/&gt; &lt;qemu:arg value=&#039;-device&#039;/&gt; &lt;qemu:arg value=&#039;vfio-pci,host=00:1d.2,bus=pcie.0&#039;/&gt; &lt;qemu:arg value=&#039;-device&#039;/&gt; &lt;qemu:arg value=&#039;vfio-pci,host=00:1d.7,bus=pcie.0&#039;/&gt; &lt;qemu:arg value=&#039;-bios&#039;/&gt; &lt;qemu:arg value=&#039;/usr/src/kvm/seabios-1.7.2-patched/seabios/out/bios.bin&#039;/&gt; &lt;qemu:env name=&#039;DISPLAY&#039; value=&#039;:0&#039;/&gt; &lt;qemu:env name=&#039;QEMU_PA_SAMPLES&#039; value=&#039;128&#039;/&gt; &lt;qemu:env name=&#039;QEMU_AUDIO_DRV&#039; value=&#039;pa&#039;/&gt; &lt;/qemu:commandline&gt; &lt;/domain&gt;</code></pre></div><p>Adapt UUID and MAC adress - and of course your PCI-IDs...</p><p>Greetings<br />K.</p> <p class="postedit"><em>Last edited by kaeptnb (2013-10-30 20:54:40)</em></p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1343400">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1343405" class="blockpost roweven"> <h2><span><span class="conr">#637</span> <a href="viewtopic.php?pid=1343405#p1343405">2013-10-30 17:39:25</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=75590">aw</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2013-10-04</span></dd> <dd><span>Posts: 921</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=75590">Email</a></span> <span class="website"><a href="http://vfio.blogspot.com/" rel="nofollow">Website</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <p>Great tip!&#160; I&#039;ve parsed it down to what I think are the important parts if anyone wants to try to adapt their own guest xml.&#160; libvirt does have vfio support now, but it doesn&#039;t (and shouldn&#039;t) know about the x-vga=on option.&#160; If you just want to add &quot;,x-vga=on&quot; to a libvirt managed guest you can follow the instructions <a href="https://access.redhat.com/site/documentation/en-US/Red_Hat_Enterprise_Linux/6/html/Technical_Notes/virt.html" rel="nofollow">here</a> to make a wrapper around the emulator. (a different bios shouldn&#039;t be necessary on qemu.git)</p><div class="quotebox"><cite>kaeptnb wrote:</cite><blockquote><div><p>&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;<br />&#160; &lt;os&gt;&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; <br />&#160; &#160; &lt;type arch=&#039;x86_64&#039; machine=&#039;pc-q35-1.5&#039;&gt;hvm&lt;/type&gt;&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;<br />&#160; &#160; ...<br />&#160; &lt;/os&gt;&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;<br />&#160; ...<br />&#160; &lt;devices&gt;&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;<br />&#160; &#160; &lt;emulator&gt;/usr/local/kvm/bin/qemu-system-x86_64&lt;/emulator&gt;&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; <br />&#160; &#160; ...<br />&#160; &lt;/devices&gt;<br />&#160; ...<br />&#160; &lt;qemu:commandline&gt;<br />&#160; &#160; &lt;qemu:arg value=&#039;-device&#039;/&gt;<br />&#160; &#160; &lt;qemu:arg value=&#039;ioh3420,bus=pcie.0,addr=1c.0,multifunction=on,port=1,chassis=1,id=root.1&#039;/&gt;<br />&#160; &#160; &lt;qemu:arg value=&#039;-device&#039;/&gt;<br />&#160; &#160; &lt;qemu:arg value=&#039;vfio-pci,host=08:00.0,bus=root.1,addr=00.0,multifunction=on,x-vga=on&#039;/&gt;<br />&#160; &#160; &lt;qemu:arg value=&#039;-device&#039;/&gt;<br />&#160; &#160; &lt;qemu:arg value=&#039;vfio-pci,host=08:00.1,bus=root.1,addr=00.1&#039;/&gt;<br />&#160; &#160; ...<br />&#160; &#160; &lt;qemu:arg value=&#039;-bios&#039;/&gt;<br />&#160; &#160; &lt;qemu:arg value=&#039;/usr/src/kvm/seabios-1.7.2-patched/seabios/out/bios.bin&#039;/&gt;<br />&#160; &#160; ...<br />&#160; &lt;/qemu:commandline&gt;</p></div></blockquote></div> </div> <div class="postsignature postmsg"><hr /><p><a href="http://vfio.blogspot.com" rel="nofollow">http://vfio.blogspot.com</a><br />Looking for a more open forum to discuss vfio related uses?&#160; Try <a href="https://www.redhat.com/mailman/listinfo/vfio-users" rel="nofollow">https://www.redhat.com/mailman/listinfo/vfio-users</a></p></div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1343405">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1343407" class="blockpost rowodd"> <h2><span><span class="conr">#638</span> <a href="viewtopic.php?pid=1343407#p1343407">2013-10-30 17:49:40</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=74748">kaeptnb</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2013-09-04</span></dd> <dd><span>Posts: 30</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=74748">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <p>iirc if you pass through qemu args, you need the xmlns so that libvirt can validate the xml:</p><p>xmlns:qemu=&#039;http://libvirt.org/schemas/domain/qemu/1.0&#039;</p><p>(1st line)</p><p>And regarding the CPU Pinning/Isolation: the &quot;isolcpu&quot; Kernel Parameter gets very handy - in my case : &quot;isolcpus=2,3,6,7&quot;</p><p>BTW it REALLY makes a difference (i went through great lenghts to benchmark it) to keep in mind cache trashing - so try to pass through the corresponding CPUs when you have a HT CPU like me (i7-920).</p><p>IRQ Balance is another hint - i have bad experience with the irqbalance daemon, so i made myself a ugly startup-script which puts the most intense interrupts to non-guest CPUs:</p><p>for i in $(grep -i ahci&#160; &#160; &#160;/proc/interrupts | awk -F: &#039;{print $1}&#039;) ; do echo 2 &gt;/proc/irq/$i/smp_affinity ; done<br />...</p><p>Greetings!<br />K.</p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1343407">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1343413" class="blockpost roweven"> <h2><span><span class="conr">#639</span> <a href="viewtopic.php?pid=1343413#p1343413">2013-10-30 18:15:16</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=72338">empie</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>From: The Netherlands</span></dd> <dd><span>Registered: 2013-06-15</span></dd> <dd><span>Posts: 9</span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>myweb wrote:</cite><blockquote><div><p>Is it correct that in order to use real partition along with virtual drive I need to specify:</p><div class="codebox"><pre><code>-drive file=/home/nbhs/windows.img,id=bootDisk,format=raw -device ide-hd,bus=ahci.0,drive=bootDisk -drive file=/dev/sdb,id=dataDisk,format=raw -device ide-hd,bus=ahci.1,drive=dataDisk</code></pre></div><p>Could you please clarify how to specify boot order for seabios: what drive to boot?</p></div></blockquote></div><p>I use this to first boot from a slipstreamed iso, then the snapshot of the vm-disk on a logical volume:</p><div class="quotebox"><blockquote><div><p>-drive file=/dev/vg01/win7gtx560ti-slip4.1-snap01,cache=none,id=disk,format=raw -device ide-hd,bus=ahci.0,drive=disk \<br />-drive file=/data/win7hp-sp1-x64-ss20131008-rt7-4.iso,id=isocd -device ide-cd,bus=ahci.1,drive=isocd \<br />-boot dc</p></div></blockquote></div><p>And thanks for the info regarding the binding of devices.</p> <p class="postedit"><em>Last edited by empie (2013-10-30 18:17:18)</em></p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1343413">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1343414" class="blockpost rowodd"> <h2><span><span class="conr">#640</span> <a href="viewtopic.php?pid=1343414#p1343414">2013-10-30 18:23:56</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=70922">nbhs</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd class="postavatar"><img src="https://bbs.archlinux.org/img/avatars/70922.jpg?m=1367773811" width="80" height="80" alt="" /></dd> <dd><span>From: Montevideo, Uruguay</span></dd> <dd><span>Registered: 2013-05-02</span></dd> <dd><span>Posts: 402</span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>kaeptnb wrote:</cite><blockquote><div><p>...<br /> main reason was that libvirt handles vCPU pinning and i couln&#039;t find a way to do it manually<br />...</p></div></blockquote></div><p>Have you tried using cset and taskset? <a href="https://code.google.com/p/cpuset/" rel="nofollow">https://code.google.com/p/cpuset/</a>, thats what i use on my script (on the front page) to pin my vm vcpus (6) to my cpu cores (2-7)</p> <p class="postedit"><em>Last edited by nbhs (2013-10-30 18:27:09)</em></p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1343414">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1343462" class="blockpost roweven"> <h2><span><span class="conr">#641</span> <a href="viewtopic.php?pid=1343462#p1343462">2013-10-30 20:26:24</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=74748">kaeptnb</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2013-09-04</span></dd> <dd><span>Posts: 30</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=74748">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <p>Yes, that works (taskset or cgroups) - but doesnt ensure 1:1 pinning;<br />i.e. i can say qemu with its 4 vcpus should run on cpus 2,3,6,7 - but nothing ensures the qemu threads aren&#039;t hopping between these 4 real cpus.<br />libvirt ensures that - it stops qemu after initialization, pins each thread, and continues qemu... </p><p>sad qemu doesn&#039;t support this directly - but OTOH its not bad to have libvirt and with all its benefits running, so...</p><p>Greetings</p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1343462">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1343466" class="blockpost rowodd"> <h2><span><span class="conr">#642</span> <a href="viewtopic.php?pid=1343466#p1343466">2013-10-30 20:30:16</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=70922">nbhs</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd class="postavatar"><img src="https://bbs.archlinux.org/img/avatars/70922.jpg?m=1367773811" width="80" height="80" alt="" /></dd> <dd><span>From: Montevideo, Uruguay</span></dd> <dd><span>Registered: 2013-05-02</span></dd> <dd><span>Posts: 402</span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>kaeptnb wrote:</cite><blockquote><div><p>Yes, that works (taskset or cgroups) - but doesnt ensure 1:1 pinning;<br />i.e. i can say qemu with its 4 vcpus should run on cpus 2,3,6,7 - but nothing ensures the qemu threads aren&#039;t hopping between these 4 real cpus.<br />libvirt ensures that - it stops qemu after initialization, pins each thread, and continues qemu... </p><p>sad qemu doesn&#039;t support this directly - but OTOH its not bad to have libvirt and with all its benefits running, so...</p><p>Greetings</p></div></blockquote></div><p>I believe qemu creates a thread per vcpu, so you can pin each thread to a core using taskset</p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1343466">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1343469" class="blockpost roweven"> <h2><span><span class="conr">#643</span> <a href="viewtopic.php?pid=1343469#p1343469">2013-10-30 20:33:10</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=74748">kaeptnb</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2013-09-04</span></dd> <dd><span>Posts: 30</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=74748">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <p>Yes, each vcpu is a thread.<br />but which thread is which vcpu (important regarding cache-trashing)?<br />and (thats maybe just my incompetence) - how can you work with threads and taskset (afaik it only nows -p - the PID) ?</p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1343469">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1343473" class="blockpost rowodd"> <h2><span><span class="conr">#644</span> <a href="viewtopic.php?pid=1343473#p1343473">2013-10-30 20:35:50</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=75590">aw</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2013-10-04</span></dd> <dd><span>Posts: 921</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=75590">Email</a></span> <span class="website"><a href="http://vfio.blogspot.com/" rel="nofollow">Website</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <p>&#039;info cpus&#039; from the monitor gives the TID for each vcpu</p> </div> <div class="postsignature postmsg"><hr /><p><a href="http://vfio.blogspot.com" rel="nofollow">http://vfio.blogspot.com</a><br />Looking for a more open forum to discuss vfio related uses?&#160; Try <a href="https://www.redhat.com/mailman/listinfo/vfio-users" rel="nofollow">https://www.redhat.com/mailman/listinfo/vfio-users</a></p></div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1343473">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1343475" class="blockpost roweven"> <h2><span><span class="conr">#645</span> <a href="viewtopic.php?pid=1343475#p1343475">2013-10-30 20:40:33</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=74748">kaeptnb</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2013-09-04</span></dd> <dd><span>Posts: 30</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=74748">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <p>ah nice. and taskset can handle TID also with -p i guess?</p><p>but the shell magic to automise this is probably more hassle than to adapt to libvirt <img src="https://bbs.archlinux.org/img/smilies/wink.png" width="15" height="15" alt="wink" /></p><p>anyways - its worth the hassle either way - fewer microlags - i never tried it (i just use it for starting game.exe) but i bet you could even use it as a DAW station <img src="https://bbs.archlinux.org/img/smilies/wink.png" width="15" height="15" alt="wink" /></p><p>Greetings<br />K.</p><p>Edit: &quot;it&quot; - being the windows7 kvm guest</p> <p class="postedit"><em>Last edited by kaeptnb (2013-10-30 20:41:51)</em></p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1343475">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1343477" class="blockpost rowodd"> <h2><span><span class="conr">#646</span> <a href="viewtopic.php?pid=1343477#p1343477">2013-10-30 20:46:26</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=74748">kaeptnb</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2013-09-04</span></dd> <dd><span>Posts: 30</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=74748">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <p>regarding latency:<br />i noticed a huge latency penalty with &quot;-usbdevice tablet &quot; and &quot;-vnc 0.0.0.0:10&quot; - oddly?!</p><p>meassurable with DPC Latency Checker ( <a href="http://www.thesycon.de/deu/latency_check.shtml" rel="nofollow">http://www.thesycon.de/deu/latency_check.shtml</a> )</p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1343477">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1343553" class="blockpost roweven"> <h2><span><span class="conr">#647</span> <a href="viewtopic.php?pid=1343553#p1343553">2013-10-30 23:32:52</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=69685">Chetyre</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2013-03-27</span></dd> <dd><span>Posts: 34</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=69685">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>kaeptnb wrote:</cite><blockquote><div><p>Hi,</p><p>thanks for this thread! Using this setup for a couple of years under XEN - but with KVM and VFIO its easier and - the most important part - more stable (with xen the Guest-Reboot was not always successful - with KVM it is!).</p><p>Anyways i converted most of the manual qemu options into libvirt-xml - main reason was that libvirt handles vCPU pinning and i couln&#039;t find a way to do it manually.<br />Another positive effect is Host Startup/Shutdown handling due to the libvirt init script - they stop/start your Guest on Host startup/shutdown.</p><div class="codebox"><pre class="vscroll"><code>&lt;domain type=&#039;kvm&#039; id=&#039;26&#039; xmlns:qemu=&#039;http://libvirt.org/schemas/domain/qemu/1.0&#039;&gt; &lt;name&gt;windows7&lt;/name&gt; &lt;uuid&gt;xxxxxxx-xxxxx-xxxxx-xxxx-xxxxxxxxx&lt;/uuid&gt; &lt;memory unit=&#039;KiB&#039;&gt;8388608&lt;/memory&gt; &lt;currentMemory unit=&#039;KiB&#039;&gt;8388608&lt;/currentMemory&gt; &lt;memoryBacking&gt; &lt;nosharepages/&gt; &lt;locked/&gt; &lt;/memoryBacking&gt; &lt;vcpu placement=&#039;static&#039;&gt;4&lt;/vcpu&gt; &lt;cputune&gt; &lt;vcpupin vcpu=&#039;0&#039; cpuset=&#039;2&#039;/&gt; &lt;vcpupin vcpu=&#039;1&#039; cpuset=&#039;6&#039;/&gt; &lt;vcpupin vcpu=&#039;2&#039; cpuset=&#039;3&#039;/&gt; &lt;vcpupin vcpu=&#039;3&#039; cpuset=&#039;7&#039;/&gt; &lt;emulatorpin cpuset=&#039;0-1,4-5&#039;/&gt; &lt;/cputune&gt; &lt;resource&gt; &lt;partition&gt;/machine&lt;/partition&gt; &lt;/resource&gt; &lt;os&gt; &lt;type arch=&#039;x86_64&#039; machine=&#039;pc-q35-1.5&#039;&gt;hvm&lt;/type&gt; &lt;boot dev=&#039;hd&#039;/&gt; &lt;smbios mode=&#039;host&#039;/&gt; &lt;/os&gt; &lt;cpu mode=&#039;host-passthrough&#039;&gt; &lt;topology sockets=&#039;1&#039; cores=&#039;2&#039; threads=&#039;2&#039;/&gt; &lt;/cpu&gt; &lt;clock offset=&#039;localtime&#039;/&gt; &lt;on_poweroff&gt;destroy&lt;/on_poweroff&gt; &lt;on_reboot&gt;restart&lt;/on_reboot&gt; &lt;on_crash&gt;destroy&lt;/on_crash&gt; &lt;devices&gt; &lt;emulator&gt;/usr/local/kvm/bin/qemu-system-x86_64&lt;/emulator&gt; &lt;disk type=&#039;block&#039; device=&#039;disk&#039;&gt; &lt;driver name=&#039;qemu&#039; type=&#039;raw&#039; cache=&#039;none&#039; discard=&#039;unmap&#039;/&gt; &lt;source dev=&#039;/dev/ssd/win7system&#039;/&gt; &lt;target dev=&#039;vda&#039; bus=&#039;virtio&#039;/&gt; &lt;alias name=&#039;virtio-disk0&#039;/&gt; &lt;address type=&#039;pci&#039; domain=&#039;0x0000&#039; bus=&#039;0x02&#039; slot=&#039;0x03&#039; function=&#039;0x0&#039;/&gt; &lt;/disk&gt; &lt;disk type=&#039;block&#039; device=&#039;disk&#039;&gt; &lt;driver name=&#039;qemu&#039; type=&#039;raw&#039; cache=&#039;none&#039; discard=&#039;unmap&#039;/&gt; &lt;source dev=&#039;/dev/mapper/win7games_cached&#039;/&gt; &lt;target dev=&#039;vdb&#039; bus=&#039;virtio&#039;/&gt; &lt;alias name=&#039;virtio-disk1&#039;/&gt; &lt;address type=&#039;pci&#039; domain=&#039;0x0000&#039; bus=&#039;0x02&#039; slot=&#039;0x04&#039; function=&#039;0x0&#039;/&gt; &lt;/disk&gt; &lt;controller type=&#039;sata&#039; index=&#039;0&#039;&gt; &lt;alias name=&#039;sata0&#039;/&gt; &lt;address type=&#039;pci&#039; domain=&#039;0x0000&#039; bus=&#039;0x00&#039; slot=&#039;0x1f&#039; function=&#039;0x2&#039;/&gt; &lt;/controller&gt; &lt;controller type=&#039;pci&#039; index=&#039;0&#039; model=&#039;pcie-root&#039;&gt; &lt;alias name=&#039;pcie.0&#039;/&gt; &lt;/controller&gt; &lt;controller type=&#039;pci&#039; index=&#039;1&#039; model=&#039;dmi-to-pci-bridge&#039;&gt; &lt;alias name=&#039;pci.1&#039;/&gt; &lt;address type=&#039;pci&#039; domain=&#039;0x0000&#039; bus=&#039;0x00&#039; slot=&#039;0x02&#039; function=&#039;0x0&#039;/&gt; &lt;/controller&gt; &lt;controller type=&#039;pci&#039; index=&#039;2&#039; model=&#039;pci-bridge&#039;&gt; &lt;alias name=&#039;pci.2&#039;/&gt; &lt;address type=&#039;pci&#039; domain=&#039;0x0000&#039; bus=&#039;0x01&#039; slot=&#039;0x01&#039; function=&#039;0x0&#039;/&gt; &lt;/controller&gt; &lt;controller type=&#039;usb&#039; index=&#039;0&#039; model=&#039;none&#039;&gt; &lt;alias name=&#039;usb0&#039;/&gt; &lt;address type=&#039;pci&#039; domain=&#039;0x0000&#039; bus=&#039;0x02&#039; slot=&#039;0x01&#039; function=&#039;0x0&#039;/&gt; &lt;/controller&gt; &lt;interface type=&#039;bridge&#039;&gt; &lt;mac address=&#039;00:xx:xx:xx:xx:xx&#039;/&gt; &lt;source bridge=&#039;br0&#039;/&gt; &lt;target dev=&#039;vnet0&#039;/&gt; &lt;model type=&#039;virtio&#039;/&gt; &lt;alias name=&#039;net0&#039;/&gt; &lt;rom bar=&#039;off&#039;/&gt; &lt;address type=&#039;pci&#039; domain=&#039;0x0000&#039; bus=&#039;0x02&#039; slot=&#039;0x02&#039; function=&#039;0x0&#039;/&gt; &lt;/interface&gt; &lt;memballoon model=&#039;none&#039;&gt; &lt;alias name=&#039;balloon0&#039;/&gt; &lt;/memballoon&gt; &lt;/devices&gt; &lt;seclabel type=&#039;none&#039;/&gt; &lt;qemu:commandline&gt; &lt;qemu:arg value=&#039;-device&#039;/&gt; &lt;qemu:arg value=&#039;ioh3420,bus=pcie.0,addr=1c.0,multifunction=on,port=1,chassis=1,id=root.1&#039;/&gt; &lt;qemu:arg value=&#039;-device&#039;/&gt; &lt;qemu:arg value=&#039;vfio-pci,host=08:00.0,bus=root.1,addr=00.0,multifunction=on,x-vga=on&#039;/&gt; &lt;qemu:arg value=&#039;-device&#039;/&gt; &lt;qemu:arg value=&#039;vfio-pci,host=08:00.1,bus=root.1,addr=00.1&#039;/&gt; &lt;qemu:arg value=&#039;-device&#039;/&gt; &lt;qemu:arg value=&#039;vfio-pci,host=00:1d.0,bus=pcie.0&#039;/&gt; &lt;qemu:arg value=&#039;-device&#039;/&gt; &lt;qemu:arg value=&#039;vfio-pci,host=00:1d.1,bus=pcie.0&#039;/&gt; &lt;qemu:arg value=&#039;-device&#039;/&gt; &lt;qemu:arg value=&#039;vfio-pci,host=00:1d.2,bus=pcie.0&#039;/&gt; &lt;qemu:arg value=&#039;-device&#039;/&gt; &lt;qemu:arg value=&#039;vfio-pci,host=00:1d.7,bus=pcie.0&#039;/&gt; &lt;qemu:arg value=&#039;-bios&#039;/&gt; &lt;qemu:arg value=&#039;/usr/src/kvm/seabios-1.7.2-patched/seabios/out/bios.bin&#039;/&gt; &lt;qemu:env name=&#039;DISPLAY&#039; value=&#039;:0&#039;/&gt; &lt;qemu:env name=&#039;QEMU_PA_SAMPLES&#039; value=&#039;128&#039;/&gt; &lt;qemu:env name=&#039;QEMU_AUDIO_DRV&#039; value=&#039;pa&#039;/&gt; &lt;/qemu:commandline&gt; &lt;/domain&gt;</code></pre></div><p>Adapt UUID and MAC adress - and of course your PCI-IDs...</p><p>Greetings<br />K.</p></div></blockquote></div><br /><p>I tried creating my own xml based on yours, but virsh fails with:</p><div class="codebox"><pre><code>error: Failed to start domain windows7 error: internal error: early end of file from monitor: possible problem: qemu-system-x86_64: -device vfio-pci,host=02:00.0,bus=root.1,addr=00.0,multifunction=on,x-vga=on: vfio: error opening /dev/vfio/15: Permission denied qemu-system-x86_64: -device vfio-pci,host=02:00.0,bus=root.1,addr=00.0,multifunction=on,x-vga=on: vfio: failed to get group 15 qemu-system-x86_64: -device vfio-pci,host=02:00.0,bus=root.1,addr=00.0,multifunction=on,x-vga=on: Device initialization failed. qemu-system-x86_64: -device vfio-pci,host=02:00.0,bus=root.1,addr=00.0,multifunction=on,x-vga=on: Device &#039;vfio-pci&#039; could not be initialized</code></pre></div><br /><p>What could be wrong?</p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1343553">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1343555" class="blockpost rowodd"> <h2><span><span class="conr">#648</span> <a href="viewtopic.php?pid=1343555#p1343555">2013-10-30 23:37:25</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=75590">aw</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2013-10-04</span></dd> <dd><span>Posts: 921</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=75590">Email</a></span> <span class="website"><a href="http://vfio.blogspot.com/" rel="nofollow">Website</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>Chetyre wrote:</cite><blockquote><div><p>I tried creating my own xml based on yours, but virsh fails with:</p><div class="codebox"><pre><code>error: Failed to start domain windows7 error: internal error: early end of file from monitor: possible problem: qemu-system-x86_64: -device vfio-pci,host=02:00.0,bus=root.1,addr=00.0,multifunction=on,x-vga=on: vfio: error opening /dev/vfio/15: Permission denied qemu-system-x86_64: -device vfio-pci,host=02:00.0,bus=root.1,addr=00.0,multifunction=on,x-vga=on: vfio: failed to get group 15 qemu-system-x86_64: -device vfio-pci,host=02:00.0,bus=root.1,addr=00.0,multifunction=on,x-vga=on: Device initialization failed. qemu-system-x86_64: -device vfio-pci,host=02:00.0,bus=root.1,addr=00.0,multifunction=on,x-vga=on: Device &#039;vfio-pci&#039; could not be initialized</code></pre></div><br /><p>What could be wrong?</p></div></blockquote></div><p>I&#039;d guess you need to change a few things in /etc/libvirt/qemu.conf</p><p>user &amp; group should probably be root<br />clear_emulator_capabilities should probably be 0</p><p>You&#039;ll still need to setup the devices with vfio prior to starting the guest.</p> </div> <div class="postsignature postmsg"><hr /><p><a href="http://vfio.blogspot.com" rel="nofollow">http://vfio.blogspot.com</a><br />Looking for a more open forum to discuss vfio related uses?&#160; Try <a href="https://www.redhat.com/mailman/listinfo/vfio-users" rel="nofollow">https://www.redhat.com/mailman/listinfo/vfio-users</a></p></div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1343555">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1343559" class="blockpost roweven"> <h2><span><span class="conr">#649</span> <a href="viewtopic.php?pid=1343559#p1343559">2013-10-30 23:51:01</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=69685">Chetyre</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2013-03-27</span></dd> <dd><span>Posts: 34</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=69685">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>aw wrote:</cite><blockquote><div><div class="quotebox"><cite>Chetyre wrote:</cite><blockquote><div><p>I tried creating my own xml based on yours, but virsh fails with:</p><div class="codebox"><pre><code>error: Failed to start domain windows7 error: internal error: early end of file from monitor: possible problem: qemu-system-x86_64: -device vfio-pci,host=02:00.0,bus=root.1,addr=00.0,multifunction=on,x-vga=on: vfio: error opening /dev/vfio/15: Permission denied qemu-system-x86_64: -device vfio-pci,host=02:00.0,bus=root.1,addr=00.0,multifunction=on,x-vga=on: vfio: failed to get group 15 qemu-system-x86_64: -device vfio-pci,host=02:00.0,bus=root.1,addr=00.0,multifunction=on,x-vga=on: Device initialization failed. qemu-system-x86_64: -device vfio-pci,host=02:00.0,bus=root.1,addr=00.0,multifunction=on,x-vga=on: Device &#039;vfio-pci&#039; could not be initialized</code></pre></div><br /><p>What could be wrong?</p></div></blockquote></div><p>I&#039;d guess you need to change a few things in /etc/libvirt/qemu.conf</p><p>user &amp; group should probably be root<br />clear_emulator_capabilities should probably be 0</p><p>You&#039;ll still need to setup the devices with vfio prior to starting the guest.</p></div></blockquote></div><p>Now it gives me a different error</p><div class="codebox"><pre><code>error: Failed to start domain windows7 error: internal error: early end of file from monitor: possible problem: qemu-system-x86_64: -device vfio-pci,host=02:00.0,bus=root.1,addr=00.0,multifunction=on,x-vga=on: vfio: error opening /dev/vfio/15: Operation not permitted qemu-system-x86_64: -device vfio-pci,host=02:00.0,bus=root.1,addr=00.0,multifunction=on,x-vga=on: vfio: failed to get group 15 qemu-system-x86_64: -device vfio-pci,host=02:00.0,bus=root.1,addr=00.0,multifunction=on,x-vga=on: Device initialization failed. qemu-system-x86_64: -device vfio-pci,host=02:00.0,bus=root.1,addr=00.0,multifunction=on,x-vga=on: Device &#039;vfio-pci&#039; could not be initialized</code></pre></div><br /><p>The devices are bound to vfio already.</p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1343559">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1343560" class="blockpost rowodd"> <h2><span><span class="conr">#650</span> <a href="viewtopic.php?pid=1343560#p1343560">2013-10-30 23:58:23</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=75590">aw</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2013-10-04</span></dd> <dd><span>Posts: 921</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=75590">Email</a></span> <span class="website"><a href="http://vfio.blogspot.com/" rel="nofollow">Website</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>Chetyre wrote:</cite><blockquote><div><p>Now it gives me a different error</p><div class="codebox"><pre><code>error: Failed to start domain windows7 error: internal error: early end of file from monitor: possible problem: qemu-system-x86_64: -device vfio-pci,host=02:00.0,bus=root.1,addr=00.0,multifunction=on,x-vga=on: vfio: error opening /dev/vfio/15: Operation not permitted qemu-system-x86_64: -device vfio-pci,host=02:00.0,bus=root.1,addr=00.0,multifunction=on,x-vga=on: vfio: failed to get group 15 qemu-system-x86_64: -device vfio-pci,host=02:00.0,bus=root.1,addr=00.0,multifunction=on,x-vga=on: Device initialization failed. qemu-system-x86_64: -device vfio-pci,host=02:00.0,bus=root.1,addr=00.0,multifunction=on,x-vga=on: Device &#039;vfio-pci&#039; could not be initialized</code></pre></div><br /><p>The devices are bound to vfio already.</p></div></blockquote></div><p>vfio operates on iommu groups so you may need to attach more than just the devices being assigned to vfio-pci.&#160; Look in /sys/bus/pci/devices/0000:02:00.0/iommu_group/devices/ and verify all the devices in there other than root ports are attached to vfio-pci.</p> </div> <div class="postsignature postmsg"><hr /><p><a href="http://vfio.blogspot.com" rel="nofollow">http://vfio.blogspot.com</a><br />Looking for a more open forum to discuss vfio related uses?&#160; Try <a href="https://www.redhat.com/mailman/listinfo/vfio-users" rel="nofollow">https://www.redhat.com/mailman/listinfo/vfio-users</a></p></div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1343560">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div class="postlinksb"> <div class="inbox crumbsplus"> <div class="pagepost"> <p class="pagelink conl"><span class="pages-label">Pages: </span><a rel="prev" class="item1" href="viewtopic.php?id=162768&amp;p=25">Previous</a> <a href="viewtopic.php?id=162768">1</a> <span class="spacer">…</span> <a href="viewtopic.php?id=162768&amp;p=24">24</a> <a href="viewtopic.php?id=162768&amp;p=25">25</a> <strong>26</strong> <a href="viewtopic.php?id=162768&amp;p=27">27</a> <a href="viewtopic.php?id=162768&amp;p=28">28</a> <span class="spacer">…</span> <a href="viewtopic.php?id=162768&amp;p=234">234</a> <a rel="next" href="viewtopic.php?id=162768&amp;p=27">Next</a></p> <p class="postlink conr">Topic closed</p> </div> <ul class="crumbs"> <li><a href="index.php">Index</a></li> <li><span>»&#160;</span><a href="viewforum.php?id=48">Topics Going Nowhere</a></li> <li><span>»&#160;</span><strong><a href="viewtopic.php?id=162768">KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</a></strong></li> </ul> <p class="subscribelink clearb"><a href="misc.php?action=subscribe&amp;tid=162768">Subscribe to this topic</a></p> <div class="clearer"></div> </div> </div> </div> <div id="brdfooter" class="block"> <h2><span>Board footer</span></h2> <div class="box"> <div id="brdfooternav" class="inbox"> <div class="conl"> <form id="qjump" method="get" action="viewforum.php"> <div><label><span>Jump to<br /></span> <select name="id" onchange="window.location=('viewforum.php?id='+this.options[this.selectedIndex].value)"> <optgroup label="Technical Issues and Assistance"> <option value="23">Newbie Corner</option> <option value="17">Installation</option> <option value="22">Kernel &amp; Hardware</option> <option value="18">Applications &amp; Desktop Environments</option> <option value="31">Laptop Issues</option> <option value="8">Networking, Server, and Protection</option> <option value="32">Multimedia and Games</option> <option value="50">System Administration</option> <option value="35">Other Architectures</option> </optgroup> <optgroup label="Arch-centric"> <option value="24">Announcements, Package &amp; Security Advisories</option> <option value="1">Arch Discussion</option> <option value="13">Forum &amp; Wiki discussion</option> </optgroup> <optgroup label="Pacman Upgrades, Packaging &amp; AUR"> <option value="44">Pacman &amp; Package Upgrade Issues</option> <option value="49">[testing] Repo Forum</option> <option value="4">Creating &amp; Modifying Packages</option> <option value="38">AUR Issues, Discussion &amp; PKGBUILD Requests</option> </optgroup> <optgroup label="Contributions &amp; Discussion"> <option value="20">GNU/Linux Discussion</option> <option value="27">Community Contributions</option> <option value="33">Programming &amp; Scripting</option> <option value="30">Other Languages</option> <option value="47">Artwork and Screenshots</option> <option value="42">Try This</option> </optgroup> <optgroup label="/dev/null"> <option value="29">Off-Topic</option> <option value="48" selected="selected">Topics Going Nowhere</option> <option value="36">Dustbin</option> </optgroup> </select></label> <input type="submit" value=" Go " accesskey="g" /> </div> </form> </div> <div class="conr"> <p id="feedlinks"><span class="atom"><a href="extern.php?action=feed&amp;tid=162768&amp;type=atom">Atom topic feed</a></span></p> <p id="poweredby">Powered by <a href="http://fluxbb.org/">FluxBB</a></p> </div> <div class="clearer"></div> </div> </div> </div> </div> <div class="end-box"></div> </div> </body> </html>
