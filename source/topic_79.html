<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"> <html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en" dir="ltr"> <head> <meta http-equiv="Content-Type" content="text/html; charset=utf-8" /> <title>KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9 (Page 79) / Topics Going Nowhere / Arch Linux Forums</title> <link rel="stylesheet" type="text/css" href="style/ArchLinux.css" /> <link rel="canonical" href="viewtopic.php?id=162768&amp;p=79" title="Page 79" /> <link rel="prev" href="viewtopic.php?id=162768&amp;p=78" title="Page 78" /> <link rel="next" href="viewtopic.php?id=162768&amp;p=80" title="Page 80" /> <link rel="alternate" type="application/atom+xml" href="extern.php?action=feed&amp;tid=162768&amp;type=atom" title="Atom topic feed" /> <link rel="stylesheet" media="screen" href="style/ArchLinux/arch.css?v=3" /> <link rel="stylesheet" media="screen" href="style/ArchLinux/archnavbar.css?v=2" /> <link rel="shortcut icon" href="style/ArchLinux/favicon.ico" /> </head> <body> <div id="archnavbar" class="anb-forum"> <div id="archnavbarlogo"><h1><a href="http://www.archlinux.org/">Arch Linux</a></h1></div> <div id="archnavbarmenu"> <ul id="archnavbarlist"> <li id="anb-home"><a href="http://www.archlinux.org/">Home</a></li><li id="anb-packages"><a href="http://www.archlinux.org/packages/">Packages</a></li><li id="anb-forums" class="anb-selected"><a href="https://bbs.archlinux.org/">Forums</a></li><li id="anb-wiki"><a href="https://wiki.archlinux.org/">Wiki</a></li><li id="anb-bugs"><a href="https://bugs.archlinux.org/">Bugs</a></li><li id="anb-aur"><a href="https://aur.archlinux.org/">AUR</a></li><li id="anb-download"><a href="http://www.archlinux.org/download/">Download</a></li> </ul> </div> </div> <div id="punviewtopic" class="pun"> <div class="top-box"></div> <div class="punwrap"> <div id="brdheader" class="block"> <div class="box"> <div id="brdmenu" class="inbox"> <ul> <li id="navindex" class="isactive"><a href="index.php">Index</a></li> <li id="navuserlist"><a href="userlist.php">User list</a></li> <li id="navsearch"><a href="search.php">Search</a></li> <li id="navprofile"><a href="profile.php?id=80749">Profile</a></li> <li id="navlogout"><a href="login.php?action=out&amp;id=80749&amp;csrf_token=5c20501ec397bb45ef8ee8c84db232c8d8e421c6">Logout</a></li> </ul> </div> <div id="brdwelcome" class="inbox"> <ul class="conl"> <li><span>Logged in as <strong>SXX</strong></span></li> <li><span>Last visit: 2015-08-16 12:20:09</span></li> </ul> <ul class="conr"> <li><span>Topics: <a href="search.php?action=show_replies" title="Find topics you have posted to.">Posted</a> | <a href="search.php?action=show_new" title="Find topics with new posts since your last visit.">New</a> | <a href="search.php?action=show_recent" title="Find topics with recent posts.">Active</a> | <a href="search.php?action=show_unanswered" title="Find topics with no replies.">Unanswered</a></span></li> </ul> <div class="clearer"></div> </div> </div> </div> <div id="brdmain"> <div class="linkst"> <div class="inbox crumbsplus"> <ul class="crumbs"> <li><a href="index.php">Index</a></li> <li><span>»&#160;</span><a href="viewforum.php?id=48">Topics Going Nowhere</a></li> <li><span>»&#160;</span><strong><a href="viewtopic.php?id=162768">KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</a></strong></li> </ul> <div class="pagepost"> <p class="pagelink conl"><span class="pages-label">Pages: </span><a rel="prev" class="item1" href="viewtopic.php?id=162768&amp;p=78">Previous</a> <a href="viewtopic.php?id=162768">1</a> <span class="spacer">…</span> <a href="viewtopic.php?id=162768&amp;p=77">77</a> <a href="viewtopic.php?id=162768&amp;p=78">78</a> <strong>79</strong> <a href="viewtopic.php?id=162768&amp;p=80">80</a> <a href="viewtopic.php?id=162768&amp;p=81">81</a> <span class="spacer">…</span> <a href="viewtopic.php?id=162768&amp;p=234">234</a> <a rel="next" href="viewtopic.php?id=162768&amp;p=80">Next</a></p> <p class="postlink conr">Topic closed</p> </div> <div class="clearer"></div> </div> </div> <div id="p1422037" class="blockpost rowodd blockpost1"> <h2><span><span class="conr">#1951</span> <a href="viewtopic.php?pid=1422037#p1422037">2014-06-04 01:30:24</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=68201">rabcor</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2013-02-09</span></dd> <dd><span>Posts: 457</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=68201">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>slis wrote:</cite><blockquote><div><p>hello there</p><p>amazin and long topic <img src="https://bbs.archlinux.org/img/smilies/smile.png" width="15" height="15" alt="smile" /></p><p>hope someone can help me...</p><p>i got some problems... yesterday i managed to get passthrough running but performance was low... (DOTA2 native 120fps, in kvm 40-50fps, drops to 20fps sometimes jumps to 90fps</p><p>my config<br />i72600<br />Z77X-UD3H<br />host igpu<br />guest 560ti <br />jessie 13.4.4 + i915patch, acs and debug register</p><br /><p>i am also interested in getting SLI running since i have 2 same cards, and is it possible to pass IGPU? so i can have hw video (quicksync) encode since 5xx series lack that and i can&#039;t stream 60fps </p><br /><br /><p>P.S. <br />what are proper patches,grub commands and kernel needed for my system? <br />do i need pci-stub, and vfio-bind, both?<br />can i pass it with pci-assign?</p><p>i can only reboot vm, after shutdown i must reboot host? is that normal?&#160; <br />Thank you</p></div></blockquote></div><p>Strange no one replied sooner <img src="https://bbs.archlinux.org/img/smilies/tongue.png" width="15" height="15" alt="tongue" /></p><p>Your setup is nearly identical to mine, same processor, different motherboard, but I have 550-Ti running on host (670 on guest). I don&#039;t know about SLI, but in theory if you have two GTX 560s and pass them both through then in theory you should be able to make them work in SLI but you need to leave one card for your host... Also you are most definitely going to need <a href="https://bbs.archlinux.org/viewtopic.php?pid=1421204#p1421204" rel="nofollow">this</a> patch for SLI to have a chance to work (makes nvidia drivers think you&#039;re not running a virtual machine) there&#039;s a different version of it if you scroll down further but I think yuo should use this one as it&#039;s a more surefire way than the other. (You need this if you&#039;re using the latest nvidia drivers anyways)</p><p>40-50 FPS in dota 2 is bad.&#160; Sounds like you need the debug register patch but you said you have it. Why would you passthrough the igpu? I never managed to get good recordings in windows with any software, but on linux ffmpeg recording and encoding simultaneously was perfect and ffmpeg works in windows too. Learn to use that and you should be good without the igpu (use x264 or x265 format, alternatively vp9) I don&#039;t know if iGPU can be passthroughed, but I think even if it is possible it is a bad idea. If you don&#039;t see it as &quot;VGA&quot; in lspci don&#039;t even bother trying. But iGPUs work very differently from dedicated ones as they rely on your processor (i.e. they need direct access to your physical processor, this not only creates a lot of vulnerabilities but also might not be possible depending on how the system is structured)</p><p>Just download the linux-mainline.tar.gz from the OP and apply all the damned patches. You will also need tha VGA_ARB patch for the nvidia proprietary drivers if you have an nvidia card on your host. and don&#039;t forget the qemu patch I linked you earlier. Unless you have a card from the same manufacturer as your guest on your host you do not need pci-stub.</p><div class="quotebox"><cite>aw wrote:</cite><blockquote><div><div class="quotebox"><cite>rabcor wrote:</cite><blockquote><div><p>Thanks, but still not working</p><div class="codebox"><pre><code>chown rabcor /dev/vfio/13 chmod 660 /dev/vfio/vfio chown rabcor /dev/vfio/vfio ulimit -l 8409088</code></pre></div><p>Note: I had to do chown user on vfio because it denied me permission after running chmod 660 on it.</p><p>Ran ulimit -l 8409088 for 8gigs ((8192 + 20) 1.sh topic_10.html topic_11.html topic_12.html topic_13.html topic_14.html topic_15.html topic_16.html topic_17.html topic_18.html topic_19.html topic_1.html topic_20.html topic_21.html topic_22.html topic_23.html topic_24.html topic_25.html topic_26.html topic_27.html topic_28.html topic_29.html topic_2.html topic_30.html topic_31.html topic_32.html topic_33.html topic_34.html topic_35.html topic_36.html topic_37.html topic_38.html topic_39.html topic_3.html topic_40.html topic_41.html topic_42.html topic_43.html topic_44.html topic_45.html topic_46.html topic_47.html topic_48.html topic_49.html topic_4.html topic_50.html topic_51.html topic_52.html topic_53.html topic_54.html topic_55.html topic_56.html topic_57.html topic_58.html topic_59.html topic_5.html topic_60.html topic_61.html topic_62.html topic_63.html topic_64.html topic_65.html topic_66.html topic_67.html topic_68.html topic_69.html topic_6.html topic_70.html topic_71.html topic_72.html topic_73.html topic_74.html topic_75.html topic_76.html topic_77.html topic_78.html topic_7.html topic_8.html topic_9.html 1024 as the pdf you linked suggested)</p><p>Still get </p><div class="codebox"><pre><code>qemu-system-x86_64: -device vfio-pci,host=02:00.0,bus=root.1,addr=00.0,multifunction=on,x-vga=on: vfio_dma_map(0x7fe886977d80, 0x0, 0x80000000, 0x7fe750000000) = -12 (Cannot allocate memory) qemu-system-x86_64: -device vfio-pci,host=02:00.0,bus=root.1,addr=00.0,multifunction=on,x-vga=on: vfio_dma_map(0x7fe886977d80, 0x100000000, 0x80000000, 0x7fe7d0000000) = -12 (Cannot allocate memory) qemu-system-x86_64: -device vfio-pci,host=02:00.0,bus=root.1,addr=00.0,multifunction=on,x-vga=on: vfio: memory listener initialization failed for container qemu-system-x86_64: -device vfio-pci,host=02:00.0,bus=root.1,addr=00.0,multifunction=on,x-vga=on: vfio: failed to setup container for group 13 qemu-system-x86_64: -device vfio-pci,host=02:00.0,bus=root.1,addr=00.0,multifunction=on,x-vga=on: vfio: failed to get group 13 qemu-system-x86_64: -device vfio-pci,host=02:00.0,bus=root.1,addr=00.0,multifunction=on,x-vga=on: Device initialization failed. qemu-system-x86_64: -device vfio-pci,host=02:00.0,bus=root.1,addr=00.0,multifunction=on,x-vga=on: Device &#039;vfio-pci&#039; could not be initialized</code></pre></div></div></blockquote></div><p>As noted in the slides, an additional 20MB was sufficient for that example config, with an assigned NIC that has much, much less MMIO space.&#160; If you want to make sure things are covered, add an extra 1G.&#160; Also make sure you&#039;re setting ulimit in a way that transfers to the user process, &#039;sudo ulimit ...&#039; is not sufficient.</p></div></blockquote></div><p>Thanks! This worked, I think the problem may have been that I needed to use su, run the ulimit command then run su again to go back into my own terminal rather than just type exit. The problem now would be that I will want to use this with the -runas function in qemu, how can I combine them?</p><p>Edit: Oh this was fairly easy, just use the <strong>/etc/security/limits.conf</strong> and do</p><div class="codebox"><pre><code>@kvm soft memlock 8650752 @kvm hard memlock 9437184</code></pre></div><p>soft lock on (8192+256)*1024, hard lock(roof) on (8192+1024)*1024 <img src="https://bbs.archlinux.org/img/smilies/smile.png" width="15" height="15" alt="smile" /> now it&#039;s set upon boot and I can use the asroot function (I hope)</p> <p class="postedit"><em>Last edited by rabcor (2014-06-12 01:12:38)</em></p> </div> <div class="postsignature postmsg"><hr /><p><a href="https://bbs.archlinux.org/viewtopic.php?pid=1421825" rel="nofollow">Making Logitech G510 Work on Linux!</a></p></div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1422037">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1422073" class="blockpost roweven"> <h2><span><span class="conr">#1952</span> <a href="viewtopic.php?pid=1422073#p1422073">2014-06-04 04:47:04</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=75590">aw</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2013-10-04</span></dd> <dd><span>Posts: 921</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=75590">Email</a></span> <span class="website"><a href="http://vfio.blogspot.com/" rel="nofollow">Website</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>sonnet wrote:</cite><blockquote><div><p>Thanks guys for your advices!<br />Does anybody have an idea about the overhead (in partiular % of cpu resources, considering I have a quadcore haswell) caused by this method with vnc?</p></div></blockquote></div><p>Lots</p> </div> <div class="postsignature postmsg"><hr /><p><a href="http://vfio.blogspot.com" rel="nofollow">http://vfio.blogspot.com</a><br />Looking for a more open forum to discuss vfio related uses?&#160; Try <a href="https://www.redhat.com/mailman/listinfo/vfio-users" rel="nofollow">https://www.redhat.com/mailman/listinfo/vfio-users</a></p></div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1422073">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1422078" class="blockpost rowodd"> <h2><span><span class="conr">#1953</span> <a href="viewtopic.php?pid=1422078#p1422078">2014-06-04 05:37:49</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=79578">AKSN74</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd class="postavatar"><img src="https://bbs.archlinux.org/img/avatars/79578.jpg?m=1423108340" width="80" height="80" alt="" /></dd> <dd><span>From: Taichung, Taiwan</span></dd> <dd><span>Registered: 2014-02-18</span></dd> <dd><span>Posts: 52</span></dd> <dd class="usercontacts"><span class="email"><a href="mailto:missile0407@gmail.com">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>aw wrote:</cite><blockquote><div><div class="quotebox"><cite>aw wrote:</cite><blockquote><div><div class="quotebox"><cite>syndtr wrote:</cite><blockquote><div><p>I think I found ultimate fix for code 43 on windows and RmInitAdapter failed on linux with nvidia devices with newer driver.<br />What I did was masking hypervisor cpuid signature and voala!!! </p><p>Apparently the driver checking for hypervisor cpuid signature and bail if detecting presence of those signature unless the gpu is nvidia GRID.<br />After 2 frustrating weeks at last.<br />F*ck you nvidia!!!</p></div></blockquote></div><p>Wow, I was suspicious, but didn&#039;t actually think nvidia would sink this low to try it.&#160; I suppose there&#039;s still a chance that it was an oversight and not an attempt to be malicious.&#160; Maybe we can make a runtime option for qemu to hide the hypervisor.</p></div></blockquote></div><p>It&#039;s also sufficient to just change the signature, for instance:</p><div class="codebox"><pre><code>--- a/target-i386/kvm.c +++ b/target-i386/kvm.c @@ -528,7 +528,7 @@ int kvm_arch_init_vcpu(CPUState *cs) has_msr_hv_hypercall = true; } - memcpy(signature, &quot;KVMKVMKVM\0\0\0&quot;, 12); + memcpy(signature, &quot;kvmkvmkvm\0\0\0&quot;, 12); c = &amp;cpuid_data.entries[cpuid_i++]; c-&gt;function = KVM_CPUID_SIGNATURE | kvm_base; c-&gt;eax = 0;</code></pre></div></div></blockquote></div><p>Wow! I can&#039;t believe that NVIDIA do this force limitation.</p><p>Maybe it can solve the problem that I can&#039;t use CUDA in Ubuntu guest OS.<br />(My guess is, because GRID is earlier product, so Linux driver may earlier get this limitation.)</p><p>But... I&#039;m trying to edit kvm.c, I don&#039;t know which change is useful? syndtr&#039;s or Alex&#039;s?<br />And does any other codes need to fix?</p><br /><p>EDIT: After this changes, FINALLY!!!!!!!<br />Now Linux Guest OS can RUN CUDA WITH GTX480!!!!!!!<br />My guess is correct! NVIDIA also do this limitation on Linux Driver!</p><br /><p>EDIT2: With code changes, now some CUDA samples can run very well (Like deviceQuery)<br />But some samples can&#039;t run (Like matrixMul)</p><p>And... VM still gets panic when reboot Ubuntu.<br />So, still have some problems need to solve.</p><br /><p>EDIT3: When runs sample that get error, dmesg got this message</p><div class="codebox"><pre><code>[784.918638] nvidia 0000:01:00.0: irq 45 for MSI/MSI-X [785.394236] NVRM: os_pci_init_handle: invalid context! [785.394362] NVRM: GPU at 0000:01:00: GPU-3222d28c-c7c6-ad1a-67ce-f0e84bed1fe0 [785.394364] NVRM: Xid (0000:01:00): 13, 0001 00000000 000090c0 00002390 00000000 00000000</code></pre></div><p>And CUDA application got this error message (Example for matrixMul):</p><div class="codebox"><pre><code>Failed to create start event (error code unknown error)!</code></pre></div><p>Looks like Linux driver not only have this problem.<br />Here is some guest OS information</p><p>OS: Ubuntu 12.04-4 LTS (Kernel 3.11.0-15-generic x86_64)<br />NVIDIA Driver: 331.67<br />CUDA SDK version: 5.5.22</p> <p class="postedit"><em>Last edited by AKSN74 (2014-06-04 07:16:38)</em></p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1422078">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1422223" class="blockpost roweven"> <h2><span><span class="conr">#1954</span> <a href="viewtopic.php?pid=1422223#p1422223">2014-06-04 14:57:51</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=82246">shawly</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2014-05-24</span></dd> <dd><span>Posts: 22</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=82246">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <p>Ok, vga-passthrough on my machine is almost fully working (with OP patches and 3.14.4), BUT I got the same problem as slis, my fps drop from time to time.<br />Rabcor already described how to fix this, but which patches are now really needed and which patches are old?</p><p>The OP pkg has many patches, but for example, I can&#039;t apply all the patches (e.g. the i915 patch) from the OP pkg on the actual mainline (3.15).</p><p>Like I said, it&#039;s working but my question is which patches do I (really) need for 3.14.5-stable and which do I need for 3.15.*-mainline?<br />I would prefer the stable.<br />An up to date list with links to the patches with the corresponding kernel versions would be great.</p><p>My hardware:</p><p>CPU: Xeon E3-1245v3<br />MB: MSI Z97 Gaming 7<br />iGPU used by Host<br />NVidia GeForce GTX 770 passed to Windows Guest<br />AMD Radeon HD5450 passed to another Linux Guest</p><p>Edit: Can I use the code 43 fix to get the latest nvidia driver to work?</p> <p class="postedit"><em>Last edited by shawly (2014-06-04 15:03:25)</em></p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1422223">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1422276" class="blockpost rowodd"> <h2><span><span class="conr">#1955</span> <a href="viewtopic.php?pid=1422276#p1422276">2014-06-04 18:08:46</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=82238">sinny</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2014-05-24</span></dd> <dd><span>Posts: 75</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=82238">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>shawly wrote:</cite><blockquote><div><p>Ok, vga-passthrough on my machine is almost fully working (with OP patches and 3.14.4), BUT I got the same problem as slis, my fps drop from time to time.<br />Rabcor already described how to fix this, but which patches are now really needed and which patches are old?</p><p>The OP pkg has many patches, but for example, I can&#039;t apply all the patches (e.g. the i915 patch) from the OP pkg on the actual mainline (3.15).</p><p>Like I said, it&#039;s working but my question is which patches do I (really) need for 3.14.5-stable and which do I need for 3.15.*-mainline?<br />I would prefer the stable.<br />An up to date list with links to the patches with the corresponding kernel versions would be great.</p><p>My hardware:</p><p>CPU: Xeon E3-1245v3<br />MB: MSI Z97 Gaming 7<br />iGPU used by Host<br />NVidia GeForce GTX 770 passed to Windows Guest<br />AMD Radeon HD5450 passed to another Linux Guest</p><p>Edit: Can I use the code 43 fix to get the latest nvidia driver to work?</p></div></blockquote></div><p>have you tried disabling sound in application you experience fps drops in?</p><p>i was having varied fps rates in win 7 (league of legends) between reboots. and one time, when fps was hard to bear i tried disabling sounds - it helped. after playing around with audio parameters, i tried the following:</p><div class="codebox"><pre><code>export QEMU_PA_SAMPLES=8192 export QEMU_AUDIO_DRV=pa</code></pre></div><p>so far problems with performance/sound quality are pretty much gone for the last 3 days after i switched to those settings.</p><p>p.s. i have only first core (both hyper threads) enabled for my host (isolcpus kernel parameter), win 7 guest is given 3 &quot;dedicated&quot; hyper threads (one from each core unused-by-host)</p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1422276">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1422289" class="blockpost roweven"> <h2><span><span class="conr">#1956</span> <a href="viewtopic.php?pid=1422289#p1422289">2014-06-04 18:45:56</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=82246">shawly</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2014-05-24</span></dd> <dd><span>Posts: 22</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=82246">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>sinny wrote:</cite><blockquote><div><p>have you tried disabling sound in application you experience fps drops in?</p><p>i was having varied fps rates in win 7 (league of legends) between reboots. and one time, when fps was hard to bear i tried disabling sounds - it helped. after playing around with audio parameters, i tried the following:</p><div class="codebox"><pre><code>export QEMU_PA_SAMPLES=8192 export QEMU_AUDIO_DRV=pa</code></pre></div><p>so far problems with performance/sound quality are pretty much gone for the last 3 days after i switched to those settings.</p><p>p.s. i have only first core (both hyper threads) enabled for my host (isolcpus kernel parameter), win 7 guest is given 3 &quot;dedicated&quot; hyper threads (one from each core unused-by-host)</p></div></blockquote></div><p>I don&#039;t even have a soundcard in my vm at the moment, so it&#039;s not the sound. <br />But like I said the fps drops are not the problem, I wanna know which patches I need and which I don&#039;t.</p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1422289">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1422293" class="blockpost rowodd"> <h2><span><span class="conr">#1957</span> <a href="viewtopic.php?pid=1422293#p1422293">2014-06-04 18:52:11</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=75590">aw</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2013-10-04</span></dd> <dd><span>Posts: 921</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=75590">Email</a></span> <span class="website"><a href="http://vfio.blogspot.com/" rel="nofollow">Website</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>shawly wrote:</cite><blockquote><div><p>CPU: Xeon E3-1245v3<br />MB: MSI Z97 Gaming 7<br />iGPU used by Host<br />NVidia GeForce GTX 770 passed to Windows Guest<br />AMD Radeon HD5450 passed to another Linux Guest</p></div></blockquote></div><p>For this hardware running the latest 3.15-rc, you need the i915 patch, possibly the ACS override patch and matching cmdline option (depending on where the cards are attached), and the qemu patch to hide the hypervisor if you want to run the nvidia 337.88 driver.</p> </div> <div class="postsignature postmsg"><hr /><p><a href="http://vfio.blogspot.com" rel="nofollow">http://vfio.blogspot.com</a><br />Looking for a more open forum to discuss vfio related uses?&#160; Try <a href="https://www.redhat.com/mailman/listinfo/vfio-users" rel="nofollow">https://www.redhat.com/mailman/listinfo/vfio-users</a></p></div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1422293">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1422296" class="blockpost roweven"> <h2><span><span class="conr">#1958</span> <a href="viewtopic.php?pid=1422296#p1422296">2014-06-04 19:05:15</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=82246">shawly</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2014-05-24</span></dd> <dd><span>Posts: 22</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=82246">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>aw wrote:</cite><blockquote><div><p>For this hardware running the latest 3.15-rc, you need the i915 patch, possibly the ACS override patch and matching cmdline option (depending on where the cards are attached), and the qemu patch to hide the hypervisor if you want to run the nvidia 337.88 driver.</p></div></blockquote></div><p>Yeah well, like I said, the i915 in the OP package won&#039;t apply to 3.15-rc and since I&#039;m pretty new to this, I have no idea where I get the latest working patches. Sorry if I&#039;m to blind...</p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1422296">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1422297" class="blockpost rowodd"> <h2><span><span class="conr">#1959</span> <a href="viewtopic.php?pid=1422297#p1422297">2014-06-04 19:08:51</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=75590">aw</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2013-10-04</span></dd> <dd><span>Posts: 921</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=75590">Email</a></span> <span class="website"><a href="http://vfio.blogspot.com/" rel="nofollow">Website</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>shawly wrote:</cite><blockquote><div><div class="quotebox"><cite>aw wrote:</cite><blockquote><div><p>For this hardware running the latest 3.15-rc, you need the i915 patch, possibly the ACS override patch and matching cmdline option (depending on where the cards are attached), and the qemu patch to hide the hypervisor if you want to run the nvidia 337.88 driver.</p></div></blockquote></div><p>Yeah well, like I said, the i915 in the OP package won&#039;t apply to 3.15-rc and since I&#039;m pretty new to this, I have no idea where I get the latest working patches. Sorry if I&#039;m to blind...</p></div></blockquote></div><p><a href="https://lkml.org/lkml/2014/5/9/517" rel="nofollow">https://lkml.org/lkml/2014/5/9/517</a></p><p>Be sure to boot with i915.enable_hd_vgaarb=1 with this version.</p> </div> <div class="postsignature postmsg"><hr /><p><a href="http://vfio.blogspot.com" rel="nofollow">http://vfio.blogspot.com</a><br />Looking for a more open forum to discuss vfio related uses?&#160; Try <a href="https://www.redhat.com/mailman/listinfo/vfio-users" rel="nofollow">https://www.redhat.com/mailman/listinfo/vfio-users</a></p></div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1422297">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1422299" class="blockpost roweven"> <h2><span><span class="conr">#1960</span> <a href="viewtopic.php?pid=1422299#p1422299">2014-06-04 19:16:14</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=82246">shawly</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2014-05-24</span></dd> <dd><span>Posts: 22</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=82246">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>aw wrote:</cite><blockquote><div><div class="quotebox"><cite>shawly wrote:</cite><blockquote><div><p>Yeah well, like I said, the i915 in the OP package won&#039;t apply to 3.15-rc and since I&#039;m pretty new to this, I have no idea where I get the latest working patches. Sorry if I&#039;m to blind...</p></div></blockquote></div><p><a href="https://lkml.org/lkml/2014/5/9/517" rel="nofollow">https://lkml.org/lkml/2014/5/9/517</a></p><p>Be sure to boot with i915.enable_hd_vgaarb=1 with this version.</p></div></blockquote></div><p>Many thanks &lt;3 will try that tomorrow, does the acs_override patch in the OP pkg apply to 3.15?</p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1422299">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1422300" class="blockpost rowodd"> <h2><span><span class="conr">#1961</span> <a href="viewtopic.php?pid=1422300#p1422300">2014-06-04 19:17:00</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=75590">aw</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2013-10-04</span></dd> <dd><span>Posts: 921</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=75590">Email</a></span> <span class="website"><a href="http://vfio.blogspot.com/" rel="nofollow">Website</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>shawly wrote:</cite><blockquote><div><div class="quotebox"><cite>aw wrote:</cite><blockquote><div><div class="quotebox"><cite>shawly wrote:</cite><blockquote><div><p>Yeah well, like I said, the i915 in the OP package won&#039;t apply to 3.15-rc and since I&#039;m pretty new to this, I have no idea where I get the latest working patches. Sorry if I&#039;m to blind...</p></div></blockquote></div><p><a href="https://lkml.org/lkml/2014/5/9/517" rel="nofollow">https://lkml.org/lkml/2014/5/9/517</a></p><p>Be sure to boot with i915.enable_hd_vgaarb=1 with this version.</p></div></blockquote></div><p>Many thanks &lt;3 will try that tomorrow, does the acs_override patch in the OP pkg apply to 3.15?</p></div></blockquote></div><p>Dunno, I don&#039;t use it</p> </div> <div class="postsignature postmsg"><hr /><p><a href="http://vfio.blogspot.com" rel="nofollow">http://vfio.blogspot.com</a><br />Looking for a more open forum to discuss vfio related uses?&#160; Try <a href="https://www.redhat.com/mailman/listinfo/vfio-users" rel="nofollow">https://www.redhat.com/mailman/listinfo/vfio-users</a></p></div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1422300">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1422364" class="blockpost roweven"> <h2><span><span class="conr">#1962</span> <a href="viewtopic.php?pid=1422364#p1422364">2014-06-04 22:33:02</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=82442">slis</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2014-06-02</span></dd> <dd><span>Posts: 125</span></dd> <dd class="usercontacts"><span class="email"><a href="mailto:xslisx@gmail.com">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><blockquote><div><p>Strange no one replied sooner <img src="https://bbs.archlinux.org/img/smilies/tongue.png" width="15" height="15" alt="tongue" /></p></div></blockquote></div><p>haha thank you!</p><p>anyway i got it almost all working.... except SLI...<br />my specs and setup are in that google doc</p><p>Problem with performace was in CPU config... <br />i did= -cpu host 4 1 4 2&#160; for i7 2600 = DOTA 2 (40-50fps instead 110-120 native)</p><p>after 2 days i managed (haha) to change it to <br />-cpu host 8 1 8 1 = DOTA 2 (90-110fps)<br />and its pretty much same with qemu cpu...</p><p>with 770gtx it reaches 220fps, but drops to 30fps for no reason, i guess its driver 335 or cache in dota <img src="https://bbs.archlinux.org/img/smilies/smile.png" width="15" height="15" alt="smile" /></p><p>Any suggestions on cpu config maybe to get that 5-10% more? <img src="https://bbs.archlinux.org/img/smilies/smile.png" width="15" height="15" alt="smile" /> it seems like cpu is lowering speed with throttling or something like that , will hugepages help or another model? and what about hv-time (what is that for)? </p><p>and about SLI... i didnt try that qemu patch but wiill do... <br />now: with downstream option, one card won&#039;t start either with error code 10 or 12, however after changing countless configs, audio device was reported working on second gpu but gpu itself still had error 12... not enough resources<br />i did try to define 2nd port root pci bridge in config but with no luck...</p><br /><p>also did try 2 VM-s with 560ti each, dota 2 about 80fps each at same time... impressive... and i think that performace hit was due pcie x8 when there are 2 cards on my mbo. cpu usage 40%.</p><p>and about encoding... i dont think that u can do 1080p 60fps with software encode... i mean i can... 1 dota2 1080p 60fps stream ... i7 cpu about 70% usage and it cant hold 60 it falls to 40fps... not smooth... <br />but on windows with igpu everything is smooth constant&#160; 60fps... and i bet twice lower cpu usage but i didnt check.... steam doesnt support nvidia encode right now... only intel quick sync....</p><br /><p>PS.<br />after further dota testing it seems like when it reaches 100% gpu usage to take it back to 90% for a half a second then take it back to 100%, and fps varies from 80-110fps for no reason, (it may be happening on windows at faster rate so its not that noticable).... but overall its working great, not a single BUG/CRASH in vm when i got nvidia driver up.... restart and shutdown is working with dumped bios.</p> <p class="postedit"><em>Last edited by slis (2014-06-05 08:00:08)</em></p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1422364">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1422416" class="blockpost rowodd"> <h2><span><span class="conr">#1963</span> <a href="viewtopic.php?pid=1422416#p1422416">2014-06-05 03:47:49</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=72881">alexis_evo</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2013-07-04</span></dd> <dd><span>Posts: 33</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=72881">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <p>Using linux-mainline from OP and qemu-git from AUR... getting segfaults when I try to start the VM.</p><div class="codebox"><pre><code>modprobe vfio-pci echo 0000:03:00.0 &gt; /sys/bus/pci/devices/0000\:03\:00.0/driver/unbind echo 1002 6738 &gt; /sys/bus/pci/drivers/vfio-pci/new_id echo 0000:03:00.1 &gt; /sys/bus/pci/devices/0000\:03\:00.1/driver/unbind echo 1002 aa88 &gt; /sys/bus/pci/drivers/vfio-pci/new_id echo 2660 &gt; /proc/sys/vm/nr_hugepages /usr/bin/qemu-system-x86_64 -bios /usr/share/qemu/bios.bin -cpu host,hv-time,hv_relaxed,hv_vapic,hv_spinlocks=0x1000 \ -smp 8,sockets=1,cores=8,threads=1 -m 4G -mem-prealloc -mem-path /dev/hugepages -M q35 -enable-kvm \ -device ioh3420,bus=pcie.0,addr=1c.0,multifunction=on,port=1,chassis=1,id=root.1 \ -device vfio-pci,host=03:00.0,x-vga=on,addr=00.0,multifunction=on,bus=root.1 \ -device vfio-pci,host=03:00.1,addr=00.1,bus=root.1 \ -usb -usbdevice host:04d9:0167 -usbdevice host:0461:4d0f -usbdevice host:045e:028e \ -net nic,model=virtio -net bridge,br=br0 -device ich9-intel-hda,bus=pcie.0,addr=1b.0,id=sound0 -device hda-duplex,id=sound0-codec0,bus=sound0.0,cad=0 \ -drive file=/dev/sdc,id=disk,format=raw -device virtio-blk-pci,drive=disk -drive file=/home/alexis/Downloads/virtio-win-0.1-74.iso,id=isocd -device ide-cd,bus=ide.1,drive=isocd \ -boot menu=on -vga none</code></pre></div><div class="codebox"><pre><code>2021 Segmentation fault (core dumped) [root@snuggles alexis]# dmesg [...] [ 878.248063] device tap0 entered promiscuous mode [ 878.248420] br0: port 2(tap0) entered forwarding state [ 878.248446] br0: port 2(tap0) entered forwarding state [ 879.850979] vfio-pci 0000:03:00.1: enabling device (0400 -&gt; 0402) [ 879.969089] qemu-system-x86[2021]: segfault at 28 ip 00007fe527d78a10 sp 00007fffc6564c88 error 4 in qemu-system-x86_64[7fe527b88000+42e000] [ 881.162161] br0: port 2(tap0) entered disabled state [ 881.162429] device tap0 left promiscuous mode [ 881.162460] br0: port 2(tap0) entered disabled state</code></pre></div><p>Hadn&#039;t updated qemu or linux-mainline in a couple months since everything was working. When I installed qemu-git, pacman made me uninstall seabios-git and libacard-git.</p><div class="codebox"><pre><code>[2014-06-04 21:32] [PACMAN] Running &#039;pacman -U qemu-git-2.1.r33116.ge00fcfe-1-x86_64.pkg.tar.xz&#039; [2014-06-04 21:32] [PACMAN] removed libcacard-git (2.0.r31260.g4c288ac-1) [2014-06-04 21:32] [PACMAN] removed seabios-git (1.7.3.r1736.g5f2d17d-1) [2014-06-04 21:32] [PACMAN] upgraded qemu-git (2.0.r31260.g4c288ac-1 -&gt; 2.1.r33116.ge00fcfe-1)</code></pre></div><p>I can&#039;t downgrade qemu as I no longer have libcacard/seabios packages...</p> <p class="postedit"><em>Last edited by alexis_evo (2014-06-05 03:49:36)</em></p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1422416">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1422439" class="blockpost roweven"> <h2><span><span class="conr">#1964</span> <a href="viewtopic.php?pid=1422439#p1422439">2014-06-05 05:20:17</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=82442">slis</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2014-06-02</span></dd> <dd><span>Posts: 125</span></dd> <dd class="usercontacts"><span class="email"><a href="mailto:xslisx@gmail.com">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <p>edit: solved</p> <p class="postedit"><em>Last edited by slis (2014-06-10 03:58:42)</em></p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1422439">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1422442" class="blockpost rowodd"> <h2><span><span class="conr">#1965</span> <a href="viewtopic.php?pid=1422442#p1422442">2014-06-05 05:51:27</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=79578">AKSN74</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd class="postavatar"><img src="https://bbs.archlinux.org/img/avatars/79578.jpg?m=1423108340" width="80" height="80" alt="" /></dd> <dd><span>From: Taichung, Taiwan</span></dd> <dd><span>Registered: 2014-02-18</span></dd> <dd><span>Posts: 52</span></dd> <dd class="usercontacts"><span class="email"><a href="mailto:missile0407@gmail.com">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <p>After some tests in #1953, I found that CUDA can&#039;t run some application with GPU Memory using.<br />Seems like the memory is full and can&#039;t be clean up automatically.<br />And maybe memory size has been limited with unknown forces.</p><p>Only can running well is some information applications (Like deviceQuery in NVIDIA CUDA Samples).<br />And I think driver still a big problem in Ubuntu. Even hide the hypervisor information.</p><p>Can someone test CUDA in VM that OS is Linux? I want to know it is OS issue or driver.</p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1422442">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1422485" class="blockpost roweven"> <h2><span><span class="conr">#1966</span> <a href="viewtopic.php?pid=1422485#p1422485">2014-06-05 09:49:27</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=79237">mbroemme</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>From: Cologne</span></dd> <dd><span>Registered: 2014-02-05</span></dd> <dd><span>Posts: 39</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=79237">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>slis wrote:</cite><blockquote><div><p>Any suggestions on cpu config maybe to get that 5-10% more? <img src="https://bbs.archlinux.org/img/smilies/smile.png" width="15" height="15" alt="smile" /> it seems like cpu is lowering speed with throttling or something like that , will hugepages help or another model? and what about hv-time (what is that for)?</p></div></blockquote></div><p>To reduce throttling under load I do the following:</p><div class="codebox"><pre><code>echo 100 &gt; /sys/devices/system/cpu/cpufreq/ondemand/sampling_down_factor echo 75 &gt; /sys/devices/system/cpu/cpufreq/ondemand/up_threshold</code></pre></div><p>This helped to stabilize framerates in almost every game and CPU is still throttled when idle. I&#039;ve automated this on boot using tmpfiles.d from systemd and added in /etc/tmpfiles.d/99-custom.conf the following:</p><div class="codebox"><pre><code>w /sys/devices/system/cpu/cpufreq/ondemand/sampling_down_factor - - - - 100 w /sys/devices/system/cpu/cpufreq/ondemand/up_threshold - - - - 75</code></pre></div> <p class="postedit"><em>Last edited by mbroemme (2014-06-05 17:56:37)</em></p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1422485">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1422611" class="blockpost rowodd"> <h2><span><span class="conr">#1967</span> <a href="viewtopic.php?pid=1422611#p1422611">2014-06-05 15:06:53</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=82442">slis</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2014-06-02</span></dd> <dd><span>Posts: 125</span></dd> <dd class="usercontacts"><span class="email"><a href="mailto:xslisx@gmail.com">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>alexis_evo wrote:</cite><blockquote><div><p>Using linux-mainline from OP and qemu-git from AUR... getting segfaults when I try to start the VM.</p></div></blockquote></div><br /><p>same here, clean install jessie, linux-vifio kernel and qemu-git, with config that worked with arch/debian qemu and aw qemu</p><div class="codebox"><pre><code>[ 2902.040594] qemu-system-x86[2588]: segfault at 28 ip 00007fc0b7321fe4 sp 00007fff707ed3f0 error 4 in qemu-system-x86_64[7fc0b7132000+48a000]</code></pre></div><p>it works with debian default qemu-kvm .... </p><p>jessie + linux vfio + default qemu-kvm</p> <p class="postedit"><em>Last edited by slis (2014-06-05 15:33:50)</em></p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1422611">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1422627" class="blockpost roweven"> <h2><span><span class="conr">#1968</span> <a href="viewtopic.php?pid=1422627#p1422627">2014-06-05 15:42:46</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=58169">aldum</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd class="postavatar"><img src="https://bbs.archlinux.org/img/avatars/58169.jpg?m=1401983659" width="80" height="80" alt="" /></dd> <dd><span>Registered: 2012-03-14</span></dd> <dd><span>Posts: 7</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=58169">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>aw wrote:</cite><blockquote><div><div class="quotebox"><cite>aw wrote:</cite><blockquote><div><div class="quotebox"><cite>syndtr wrote:</cite><blockquote><div><p>I think I found ultimate fix for code 43 on windows and RmInitAdapter failed on linux with nvidia devices with newer driver.<br />What I did was masking hypervisor cpuid signature and voala!!! </p><p>Apparently the driver checking for hypervisor cpuid signature and bail if detecting presence of those signature unless the gpu is nvidia GRID.<br />After 2 frustrating weeks at last.<br />F*ck you nvidia!!!</p></div></blockquote></div><p>Wow, I was suspicious, but didn&#039;t actually think nvidia would sink this low to try it.&#160; I suppose there&#039;s still a chance that it was an oversight and not an attempt to be malicious.&#160; Maybe we can make a runtime option for qemu to hide the hypervisor.</p></div></blockquote></div><p>It&#039;s also sufficient to just change the signature, for instance:</p><div class="codebox"><pre><code>- memcpy(signature, &quot;KVMKVMKVM\0\0\0&quot;, 12); + memcpy(signature, &quot;kvmkvmkvm\0\0\0&quot;, 12);</code></pre></div></div></blockquote></div><p>You sir, are a genius. Thanks to both of you!</p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1422627">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1422710" class="blockpost rowodd"> <h2><span><span class="conr">#1969</span> <a href="viewtopic.php?pid=1422710#p1422710">2014-06-05 18:49:25</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=75590">aw</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2013-10-04</span></dd> <dd><span>Posts: 921</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=75590">Email</a></span> <span class="website"><a href="http://vfio.blogspot.com/" rel="nofollow">Website</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>aldum wrote:</cite><blockquote><div><div class="quotebox"><cite>aw wrote:</cite><blockquote><div><div class="quotebox"><cite>aw wrote:</cite><blockquote><div><p>Wow, I was suspicious, but didn&#039;t actually think nvidia would sink this low to try it.&#160; I suppose there&#039;s still a chance that it was an oversight and not an attempt to be malicious.&#160; Maybe we can make a runtime option for qemu to hide the hypervisor.</p></div></blockquote></div><p>It&#039;s also sufficient to just change the signature, for instance:</p><div class="codebox"><pre><code>- memcpy(signature, &quot;KVMKVMKVM\0\0\0&quot;, 12); + memcpy(signature, &quot;kvmkvmkvm\0\0\0&quot;, 12);</code></pre></div></div></blockquote></div><p>You sir, are a genius. Thanks to both of you!</p></div></blockquote></div><p>Current qemu.git now has an option to hide the hypervisor.&#160; You can add &quot;kvm=off&quot; to your list of -cpu option, ex:</p><div class="codebox"><pre><code>-cpu host,hv-time,kvm=off</code></pre></div> </div> <div class="postsignature postmsg"><hr /><p><a href="http://vfio.blogspot.com" rel="nofollow">http://vfio.blogspot.com</a><br />Looking for a more open forum to discuss vfio related uses?&#160; Try <a href="https://www.redhat.com/mailman/listinfo/vfio-users" rel="nofollow">https://www.redhat.com/mailman/listinfo/vfio-users</a></p></div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1422710">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1422736" class="blockpost roweven"> <h2><span><span class="conr">#1970</span> <a href="viewtopic.php?pid=1422736#p1422736">2014-06-05 19:51:50</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=58169">aldum</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd class="postavatar"><img src="https://bbs.archlinux.org/img/avatars/58169.jpg?m=1401983659" width="80" height="80" alt="" /></dd> <dd><span>Registered: 2012-03-14</span></dd> <dd><span>Posts: 7</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=58169">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>aw wrote:</cite><blockquote><div><p>Current qemu.git now has an option to hide the hypervisor.&#160; You can add &quot;kvm=off&quot; to your list of -cpu option, ex:</p><div class="codebox"><pre><code>-cpu host,hv-time,kvm=off</code></pre></div></div></blockquote></div><p>I already compiled a custom QEMU with ABS, but that would have made it a lot easier :3</p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1422736">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1422828" class="blockpost rowodd"> <h2><span><span class="conr">#1971</span> <a href="viewtopic.php?pid=1422828#p1422828">2014-06-06 00:58:07</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=72881">alexis_evo</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2013-07-04</span></dd> <dd><span>Posts: 33</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=72881">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <p>So I managed to get it booting again by downgrading qemu-git AUR package. I grabbed the last PKGBUILD from some mirror website that hosts old PKGBUILDs, and added a git reset --hard into it to downgrade to some commit in April. Here&#039;s the PKGBUILD:</p><div class="codebox"><pre class="vscroll"><code># Maintainer: Devin Cofer &lt;ranguvar{AT]archlinux[DOT}us&gt; # Contributor: Tobias Powalowski &lt;tpowa@archlinux.org&gt; # Maintainer: Frederic Bezies &lt;fredbezies@gmail.com&gt; pkgname=qemu-git _gitname=qemu pkgver=2.1.r32209.g2d03b49 pkgrel=1 pkgdesc=&quot;A generic and open source processor emulator which achieves a good emulation speed by using dynamic translation. Git version.&quot; arch=(&#039;i686&#039; &#039;x86_64&#039;) license=(&#039;GPL2&#039; &#039;LGPL2&#039;) url=&quot;http://wiki.qemu.org/Index.html&quot; depends=(&#039;pixman&#039; &#039;libjpeg&#039; &#039;libpng&#039; &#039;sdl&#039; &#039;alsa-lib&#039; &#039;nss&#039; &#039;glib2&#039; &#039;gnutls&gt;=2.4.1&#039; &#039;bluez-libs&#039; &#039;vde2&#039; &#039;util-linux&#039; &#039;curl&#039; &#039;libsasl&#039; &#039;libgl&#039; &#039;libpulse&#039; &#039;libcap-ng&#039; &#039;libaio&#039; &#039;libseccomp&#039; &#039;libiscsi&#039; &#039;spice&#039; &#039;seabios-git&#039; &#039;usbredir&#039;) makedepends=(&#039;git&#039; &#039;texi2html&#039; &#039;perl&#039; &#039;python2&#039; &#039;dtc&#039; &#039;spice-protocol&#039;) optdepends=(&#039;ovmf-bin: UEFI Firmware (OVMF) with Secure Boot Support - for Virtual Machines (QEMU)&#039;) conflicts=(&#039;qemu&#039; &#039;kvm&#039; &#039;kvm-git&#039; &#039;qemu-spice&#039; &#039;libcacard&#039;) provides=(&#039;qemu&#039; &#039;qemu-kvm&#039; &#039;qemu-spice&#039; &#039;libcacard&#039;) backup=(&#039;etc/qemu/target-x86_64.conf&#039;) source=(&#039;git://git.qemu.org/qemu.git&#039; &#039;65-kvm.rules&#039; &#039;qemu.install&#039;) sha256sums=(&#039;SKIP&#039; &#039;9c8a15c34461a9481a34ca9e0ab4ae3825eabe8fd863227f2445325413cd755c&#039; &#039;9970c3050e8dc6153c5955d018d114f9fcbc091843b85f9e7b247eb28f09ba10&#039;) install=&#039;qemu.install&#039; options=(!strip) pkgver() { cd &quot;${srcdir}/$_gitname&quot; git reset --hard 2d03b49c3f225994c4b0b46146437d8c887d6774 echo &quot;2.1.r$(git rev-list --count master).g$(git log -1 --format=&quot;%h&quot;)&quot; } build() { cd $_gitname git reset --hard 2d03b49c3f225994c4b0b46146437d8c887d6774 # qemu vs. make 4 == bad export ARFLAGS=&quot;rv&quot; # http://permalink.gmane.org/gmane.comp.emulators.qemu/238740 # gtk gui breaks keymappings at the moment ./configure --prefix=/usr --sysconfdir=/etc --audio-drv-list=&#039;pa alsa sdl&#039; \ --python=/usr/bin/python2 --smbd=/usr/bin/smbd \ --enable-docs --libexecdir=/usr/lib/qemu \ --disable-gtk --enable-linux-aio --enable-seccomp \ --enable-spice --localstatedir=/var --disable-werror \ --enable-tpm make V=99 } package() { cd $_gitname git reset --hard 2d03b49c3f225994c4b0b46146437d8c887d6774 make DESTDIR=&quot;${pkgdir}&quot; libexecdir=&quot;/usr/lib/qemu&quot; install # provided by seabios package rm &quot;${pkgdir}/usr/share/qemu/bios.bin&quot; rm &quot;${pkgdir}/usr/share/qemu/acpi-dsdt.aml&quot; rm &quot;${pkgdir}/usr/share/qemu/q35-acpi-dsdt.aml&quot; # remove conflicting /var/run directory rm -r &quot;${pkgdir}/var&quot; install -D -m644 &quot;${srcdir}/65-kvm.rules&quot; \ &quot;${pkgdir}/usr/lib/udev/rules.d/65-kvm.rules&quot; # bridge_helper needs suid # https://bugs.archlinux.org/task/32565 chmod u+s &quot;${pkgdir}/usr/lib/qemu/qemu-bridge-helper&quot; # add sample config echo &quot;allow br0&quot; &gt; ${pkgdir}/etc/qemu/bridge.conf.sample # strip scripts directory find &quot;${pkgdir}/usr/src/linux-${_kernver}/scripts&quot; -type f -perm -u+w 2&gt;/dev/null | while read binary ; do case &quot;$(file -bi &quot;$binary&quot;)&quot; in *application/x-executable*) # Binaries /usr/bin/strip $STRIP_BINARIES &quot;$binary&quot;;; esac done # remove libcacard files # rm -rf ${pkgdir}/usr/include/cacard # rm -rf ${pkgdir}/usr/lib/libcacard* # rm -rf ${pkgdir}/usr/lib/pkgconfig/libcacard.pc # rm -rf ${pkgdir}/usr/bin/vscclient }</code></pre></div><p>This is still using a rather old qemu build though, so I would greatly appreciate any help getting the latest qemu-git to work.</p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1422828">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1422831" class="blockpost roweven"> <h2><span><span class="conr">#1972</span> <a href="viewtopic.php?pid=1422831#p1422831">2014-06-06 01:14:06</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=53953">andy123</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2011-11-04</span></dd> <dd><span>Posts: 169</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=53953">Email</a></span> <span class="website"><a href="http://ajs124.de" rel="nofollow">Website</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>alexis_evo wrote:</cite><blockquote><div><p>So I managed to get it booting again by downgrading qemu-git AUR package.<br />[…]<br />This is still using a rather old qemu build though, so I would greatly appreciate any help getting the latest qemu-git to work.</p></div></blockquote></div><p>Interesting, I actually maintain the qemu-git aur package now and the upgrade removed seabios-git and libcacard-git, because its using qemu&#039;s internal versions now.</p><p>Since it works for me, I&#039;m going to try to blame upstream here, but this isn&#039;t really helpful, so maybe try to run it in strace or gdb or something and see if you can get some usage output/error messages.</p> </div> <div class="postsignature postmsg"><hr /><p>i&#039;m sorry for my poor english wirting skills…</p></div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1422831">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1422838" class="blockpost rowodd"> <h2><span><span class="conr">#1973</span> <a href="viewtopic.php?pid=1422838#p1422838">2014-06-06 01:39:39</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=82536">Rusky</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2014-06-06</span></dd> <dd><span>Posts: 1</span></dd> <dd class="usercontacts"><span class="email"><a href="mailto:rpjohnst@gmail.com">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>thehighhat wrote:</cite><blockquote><div><p>So I had a working vga passthrough of nvidia gtx470 with a windows 8 guest.&#160; I let the windows store upgrade to windows 8.1 update.&#160; now, the guest will not start correct.&#160; it always goes into automatic system repair and fails.&#160; the refresh pc, reset pc options ask for windwos cd, but cannot detect it.&#160; if i just let windows try to start, it shows nohing but a black screen.&#160; then i have reboot the host becaues i cannot shutdown the guest cleanly.</p><p>any ideas why the 8.1 update breaks everything?</p></div></blockquote></div><p>I have this exact same problem with a Radeon R9 270X, starting with a working Windows 8.1 install and just doing a normal update. Automatic system repair always fails, all the bootrec tricks fail, building a new BCD from scratch fails, refreshing the install fails. The host is Arch with the linux-mainline kernel from the first post, using Qemu 2.0.0 from the repositories.</p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1422838">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1422876" class="blockpost roweven"> <h2><span><span class="conr">#1974</span> <a href="viewtopic.php?pid=1422876#p1422876">2014-06-06 05:06:28</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=82442">slis</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2014-06-02</span></dd> <dd><span>Posts: 125</span></dd> <dd class="usercontacts"><span class="email"><a href="mailto:xslisx@gmail.com">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <p>here is strace form segmentation fault with qemu-git, it crashes with vga none option....<br />i can give more logs and info if u instruct me how to <img src="https://bbs.archlinux.org/img/smilies/smile.png" width="15" height="15" alt="smile" /><br />btw this is debian ... linux-vfio 3.15 with acs patch only</p><br /><div class="codebox"><pre class="vscroll"><code>root@TEST:~# strace sh q execve(&quot;/bin/sh&quot;, [&quot;sh&quot;, &quot;q&quot;], [/* 15 vars */]) = 0 brk(0) = 0x7fac63b8c000 access(&quot;/etc/ld.so.nohwcap&quot;, F_OK) = -1 ENOENT (No such file or directory) mmap(NULL, 8192, PROT_READ|PROT_WRITE, MAP_PRIVATE|MAP_ANONYMOUS, -1, 0) = 0x7fac61bc3000 access(&quot;/etc/ld.so.preload&quot;, R_OK) = -1 ENOENT (No such file or directory) open(&quot;/etc/ld.so.cache&quot;, O_RDONLY|O_CLOEXEC) = 3 fstat(3, {st_mode=S_IFREG|0644, st_size=35337, ...}) = 0 mmap(NULL, 35337, PROT_READ, MAP_PRIVATE, 3, 0) = 0x7fac61bba000 close(3) = 0 access(&quot;/etc/ld.so.nohwcap&quot;, F_OK) = -1 ENOENT (No such file or directory) open(&quot;/lib/x86_64-linux-gnu/libc.so.6&quot;, O_RDONLY|O_CLOEXEC) = 3 read(3, &quot;\177ELF\2\1\1\3\0\0\0\0\0\0\0\0\3\0&gt;\0\1\0\0\0P\34\2\0\0\0\0\0&quot;..., 832) = 832 fstat(3, {st_mode=S_IFREG|0755, st_size=1734080, ...}) = 0 mmap(NULL, 3840576, PROT_READ|PROT_EXEC, MAP_PRIVATE|MAP_DENYWRITE, 3, 0) = 0x7fac615fc000 mprotect(0x7fac6179c000, 2097152, PROT_NONE) = 0 mmap(0x7fac6199c000, 24576, PROT_READ|PROT_WRITE, MAP_PRIVATE|MAP_FIXED|MAP_DENYWRITE, 3, 0x1a0000) = 0x7fac6199c000 mmap(0x7fac619a2000, 14912, PROT_READ|PROT_WRITE, MAP_PRIVATE|MAP_FIXED|MAP_ANONYMOUS, -1, 0) = 0x7fac619a2000 close(3) = 0 mmap(NULL, 4096, PROT_READ|PROT_WRITE, MAP_PRIVATE|MAP_ANONYMOUS, -1, 0) = 0x7fac61bb9000 mmap(NULL, 4096, PROT_READ|PROT_WRITE, MAP_PRIVATE|MAP_ANONYMOUS, -1, 0) = 0x7fac61bb8000 mmap(NULL, 4096, PROT_READ|PROT_WRITE, MAP_PRIVATE|MAP_ANONYMOUS, -1, 0) = 0x7fac61bb7000 arch_prctl(ARCH_SET_FS, 0x7fac61bb8700) = 0 mprotect(0x7fac6199c000, 16384, PROT_READ) = 0 mprotect(0x7fac61de2000, 8192, PROT_READ) = 0 mprotect(0x7fac61bc5000, 4096, PROT_READ) = 0 munmap(0x7fac61bba000, 35337) = 0 getpid() = 2982 rt_sigaction(SIGCHLD, {0x7fac61bd9620, ~[RTMIN RT_1], SA_RESTORER, 0x7fac61631420}, NULL, 8) = 0 geteuid() = 0 brk(0) = 0x7fac63b8c000 brk(0x7fac63bad000) = 0x7fac63bad000 getppid() = 2981 stat(&quot;/root&quot;, {st_mode=S_IFDIR|0700, st_size=4096, ...}) = 0 stat(&quot;.&quot;, {st_mode=S_IFDIR|0700, st_size=4096, ...}) = 0 open(&quot;q&quot;, O_RDONLY) = 3 fcntl(3, F_DUPFD, 10) = 10 close(3) = 0 fcntl(10, F_SETFD, FD_CLOEXEC) = 0 rt_sigaction(SIGINT, NULL, {SIG_DFL, [], 0}, 8) = 0 rt_sigaction(SIGINT, {0x7fac61bd9620, ~[RTMIN RT_1], SA_RESTORER, 0x7fac61631420}, NULL, 8) = 0 rt_sigaction(SIGQUIT, NULL, {SIG_DFL, [], 0}, 8) = 0 rt_sigaction(SIGQUIT, {SIG_DFL, ~[RTMIN RT_1], SA_RESTORER, 0x7fac61631420}, NULL, 8) = 0 rt_sigaction(SIGTERM, NULL, {SIG_DFL, [], 0}, 8) = 0 rt_sigaction(SIGTERM, {SIG_DFL, ~[RTMIN RT_1], SA_RESTORER, 0x7fac61631420}, NULL, 8) = 0 read(10, &quot;#!/bin/bash\nqemu-system-x86_64 -&quot;..., 8192) = 613 stat(&quot;/usr/local/sbin/qemu-system-x86_64&quot;, 0x7fff18e9d8d0) = -1 ENOENT (No such file or directory) stat(&quot;/usr/local/bin/qemu-system-x86_64&quot;, {st_mode=S_IFREG|0755, st_size=5998584, ...}) = 0 clone(child_stack=0, flags=CLONE_CHILD_CLEARTID|CLONE_CHILD_SETTID|SIGCHLD, child_tidptr=0x7fac61bb89d0) = 2983 wait4(-1, [{WIFSIGNALED(s) &amp;&amp; WTERMSIG(s) == SIGSEGV}], 0, NULL) = 2983 --- SIGCHLD (Child exited) @ 0 (0) --- rt_sigreturn(0x11) = 2983 write(2, &quot;Segmentation fault\n&quot;, 19Segmentation fault ) = 19 read(10, &quot;&quot;, 8192) = 0 exit_group(139) = ? root@TEST:~#</code></pre></div><p>config</p><div class="codebox"><pre><code>#!/bin/bash qemu-system-x86_64 -enable-kvm -M q35 -m 3072 -cpu Haswell,hv-time -smp 4,sockets=1,cores=4,threads=1 \ -boot menu=on \ -vga none \ -device ioh3420,bus=pcie.0,addr=1c.0,multifunction=on,port=1,chassis=1,id=root.1 \ -device vfio-pci,host=01:00.0,bus=root.1,addr=00.0,multifunction=on,x-vga=on,romfile=/root/GF114.rom \ -device vfio-pci,host=01:00.1,bus=root.1,addr=00.1 \ -drive file=/root/win.img,id=disk,format=raw -device ide-hd,bus=ide.0,drive=disk \ -usb -usbdevice host:413c:2003 -usbdevice host:046d:c042 \ -netdev tap,id=guest0,vhost=on,script=no \ -net nic,model=e1000,netdev=guest0 \ -vnc :1</code></pre></div> <p class="postedit"><em>Last edited by slis (2014-06-06 06:29:29)</em></p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1422876">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1422892" class="blockpost rowodd"> <h2><span><span class="conr">#1975</span> <a href="viewtopic.php?pid=1422892#p1422892">2014-06-06 06:31:39</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=73933">rman</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>From: United States</span></dd> <dd><span>Registered: 2013-08-08</span></dd> <dd><span>Posts: 14</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=73933">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <p>Just wanted to chime in with another success story. It took me an entire weekend plus the following Monday, but I got my VGA passthrough setup fully functional! <img src="https://bbs.archlinux.org/img/smilies/big_smile.png" width="15" height="15" alt="big_smile" /></p><p>Specs:<br />CPU: Core i5-4690<br />MB: ASRock H97m Pro 4<br />GPU 1: HD Graphics 4600 (used by Arch host)<br />GPU 2: AMD Radeon R7 265 (passed through to Windows 7)</p><p>The only patch I needed was the i915 arbiter patch. At first I used the 3.14 kernel from the OP, but I had some suspend to RAM issues, so I applied the patch against 3.15rc8 and it built and ran fine.</p><p>I cannot passthrough the Radeon&#039;s HDMI audio controller, or I get the dreaded atikmpag.sys BSOD. The VM is otherwise flawless though - I can even reboot it with absolutely no problems.</p><p>I had some issues with Qemu&#039;s emulated audio - Intel HDA was basically unusable with pops and static. I tried ac97, which worked much better, but I still had stuttering, noise, and choppiness. At that point I gave up and bought a USB sound card, which of course is working perfectly.</p><p>Anyway, thanks to everyone who contributed to this thread! It&#039;s good to know that this is still working with the latest GPU&#039;s. <img src="https://bbs.archlinux.org/img/smilies/smile.png" width="15" height="15" alt="smile" /></p> <p class="postedit"><em>Last edited by rman (2014-06-06 06:34:28)</em></p> </div> <div class="postsignature postmsg"><hr /><p><strong>Laptop:</strong> Lenovo L440, Intel Core i3-4000M, HD Graphics 4600<br /><strong>Desktop:</strong> Intel Core i5-4690, HD Graphics 4600, AMD Radeon R7 265 <em>(KVM VGA passthrough)</em></p></div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1422892">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div class="postlinksb"> <div class="inbox crumbsplus"> <div class="pagepost"> <p class="pagelink conl"><span class="pages-label">Pages: </span><a rel="prev" class="item1" href="viewtopic.php?id=162768&amp;p=78">Previous</a> <a href="viewtopic.php?id=162768">1</a> <span class="spacer">…</span> <a href="viewtopic.php?id=162768&amp;p=77">77</a> <a href="viewtopic.php?id=162768&amp;p=78">78</a> <strong>79</strong> <a href="viewtopic.php?id=162768&amp;p=80">80</a> <a href="viewtopic.php?id=162768&amp;p=81">81</a> <span class="spacer">…</span> <a href="viewtopic.php?id=162768&amp;p=234">234</a> <a rel="next" href="viewtopic.php?id=162768&amp;p=80">Next</a></p> <p class="postlink conr">Topic closed</p> </div> <ul class="crumbs"> <li><a href="index.php">Index</a></li> <li><span>»&#160;</span><a href="viewforum.php?id=48">Topics Going Nowhere</a></li> <li><span>»&#160;</span><strong><a href="viewtopic.php?id=162768">KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</a></strong></li> </ul> <p class="subscribelink clearb"><a href="misc.php?action=subscribe&amp;tid=162768">Subscribe to this topic</a></p> <div class="clearer"></div> </div> </div> </div> <div id="brdfooter" class="block"> <h2><span>Board footer</span></h2> <div class="box"> <div id="brdfooternav" class="inbox"> <div class="conl"> <form id="qjump" method="get" action="viewforum.php"> <div><label><span>Jump to<br /></span> <select name="id" onchange="window.location=('viewforum.php?id='+this.options[this.selectedIndex].value)"> <optgroup label="Technical Issues and Assistance"> <option value="23">Newbie Corner</option> <option value="17">Installation</option> <option value="22">Kernel &amp; Hardware</option> <option value="18">Applications &amp; Desktop Environments</option> <option value="31">Laptop Issues</option> <option value="8">Networking, Server, and Protection</option> <option value="32">Multimedia and Games</option> <option value="50">System Administration</option> <option value="35">Other Architectures</option> </optgroup> <optgroup label="Arch-centric"> <option value="24">Announcements, Package &amp; Security Advisories</option> <option value="1">Arch Discussion</option> <option value="13">Forum &amp; Wiki discussion</option> </optgroup> <optgroup label="Pacman Upgrades, Packaging &amp; AUR"> <option value="44">Pacman &amp; Package Upgrade Issues</option> <option value="49">[testing] Repo Forum</option> <option value="4">Creating &amp; Modifying Packages</option> <option value="38">AUR Issues, Discussion &amp; PKGBUILD Requests</option> </optgroup> <optgroup label="Contributions &amp; Discussion"> <option value="20">GNU/Linux Discussion</option> <option value="27">Community Contributions</option> <option value="33">Programming &amp; Scripting</option> <option value="30">Other Languages</option> <option value="47">Artwork and Screenshots</option> <option value="42">Try This</option> </optgroup> <optgroup label="/dev/null"> <option value="29">Off-Topic</option> <option value="48" selected="selected">Topics Going Nowhere</option> <option value="36">Dustbin</option> </optgroup> </select></label> <input type="submit" value=" Go " accesskey="g" /> </div> </form> </div> <div class="conr"> <p id="feedlinks"><span class="atom"><a href="extern.php?action=feed&amp;tid=162768&amp;type=atom">Atom topic feed</a></span></p> <p id="poweredby">Powered by <a href="http://fluxbb.org/">FluxBB</a></p> </div> <div class="clearer"></div> </div> </div> </div> </div> <div class="end-box"></div> </div> </body> </html>
