<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"> <html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en" dir="ltr"> <head> <meta http-equiv="Content-Type" content="text/html; charset=utf-8" /> <title>KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9 (Page 159) / Topics Going Nowhere / Arch Linux Forums</title> <link rel="stylesheet" type="text/css" href="style/ArchLinux.css" /> <link rel="canonical" href="viewtopic.php?id=162768&amp;p=159" title="Page 159" /> <link rel="prev" href="viewtopic.php?id=162768&amp;p=158" title="Page 158" /> <link rel="next" href="viewtopic.php?id=162768&amp;p=160" title="Page 160" /> <link rel="alternate" type="application/atom+xml" href="extern.php?action=feed&amp;tid=162768&amp;type=atom" title="Atom topic feed" /> <link rel="stylesheet" media="screen" href="style/ArchLinux/arch.css?v=3" /> <link rel="stylesheet" media="screen" href="style/ArchLinux/archnavbar.css?v=2" /> <link rel="shortcut icon" href="style/ArchLinux/favicon.ico" /> </head> <body> <div id="archnavbar" class="anb-forum"> <div id="archnavbarlogo"><h1><a href="http://www.archlinux.org/">Arch Linux</a></h1></div> <div id="archnavbarmenu"> <ul id="archnavbarlist"> <li id="anb-home"><a href="http://www.archlinux.org/">Home</a></li><li id="anb-packages"><a href="http://www.archlinux.org/packages/">Packages</a></li><li id="anb-forums" class="anb-selected"><a href="https://bbs.archlinux.org/">Forums</a></li><li id="anb-wiki"><a href="https://wiki.archlinux.org/">Wiki</a></li><li id="anb-bugs"><a href="https://bugs.archlinux.org/">Bugs</a></li><li id="anb-aur"><a href="https://aur.archlinux.org/">AUR</a></li><li id="anb-download"><a href="http://www.archlinux.org/download/">Download</a></li> </ul> </div> </div> <div id="punviewtopic" class="pun"> <div class="top-box"></div> <div class="punwrap"> <div id="brdheader" class="block"> <div class="box"> <div id="brdmenu" class="inbox"> <ul> <li id="navindex" class="isactive"><a href="index.php">Index</a></li> <li id="navuserlist"><a href="userlist.php">User list</a></li> <li id="navsearch"><a href="search.php">Search</a></li> <li id="navprofile"><a href="profile.php?id=80749">Profile</a></li> <li id="navlogout"><a href="login.php?action=out&amp;id=80749&amp;csrf_token=5c20501ec397bb45ef8ee8c84db232c8d8e421c6">Logout</a></li> </ul> </div> <div id="brdwelcome" class="inbox"> <ul class="conl"> <li><span>Logged in as <strong>SXX</strong></span></li> <li><span>Last visit: 2015-08-16 12:20:09</span></li> </ul> <ul class="conr"> <li><span>Topics: <a href="search.php?action=show_replies" title="Find topics you have posted to.">Posted</a> | <a href="search.php?action=show_new" title="Find topics with new posts since your last visit.">New</a> | <a href="search.php?action=show_recent" title="Find topics with recent posts.">Active</a> | <a href="search.php?action=show_unanswered" title="Find topics with no replies.">Unanswered</a></span></li> </ul> <div class="clearer"></div> </div> </div> </div> <div id="brdmain"> <div class="linkst"> <div class="inbox crumbsplus"> <ul class="crumbs"> <li><a href="index.php">Index</a></li> <li><span>»&#160;</span><a href="viewforum.php?id=48">Topics Going Nowhere</a></li> <li><span>»&#160;</span><strong><a href="viewtopic.php?id=162768">KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</a></strong></li> </ul> <div class="pagepost"> <p class="pagelink conl"><span class="pages-label">Pages: </span><a rel="prev" class="item1" href="viewtopic.php?id=162768&amp;p=158">Previous</a> <a href="viewtopic.php?id=162768">1</a> <span class="spacer">…</span> <a href="viewtopic.php?id=162768&amp;p=157">157</a> <a href="viewtopic.php?id=162768&amp;p=158">158</a> <strong>159</strong> <a href="viewtopic.php?id=162768&amp;p=160">160</a> <a href="viewtopic.php?id=162768&amp;p=161">161</a> <span class="spacer">…</span> <a href="viewtopic.php?id=162768&amp;p=234">234</a> <a rel="next" href="viewtopic.php?id=162768&amp;p=160">Next</a></p> <p class="postlink conr">Topic closed</p> </div> <div class="clearer"></div> </div> </div> <div id="p1495530" class="blockpost rowodd blockpost1"> <h2><span><span class="conr">#3951</span> <a href="viewtopic.php?pid=1495530#p1495530">2015-01-23 01:00:37</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=88206">SEPIPES</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2015-01-23</span></dd> <dd><span>Posts: 2</span></dd> <dd class="usercontacts"><span class="email"><a href="mailto:soko.splat@gmail.com">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <p>setup:</p><div class="codebox"><pre><code>Distro: Ubuntu, 14.10 kernel: 3.18.0, patched ACS+VGA qemu: 2.1.0 libvirt: 1.2.8 Platform: Laptop, clevo p370SM proc: i7-4810MQ (VTX, VTD) GPU1 (host): NVIDIA 870m (geforce) GPU2 (guest): NVIDIA 980m (geforce) - aftermarket from clevo GuestOSE: Win 8.1|Server 2012R2, Fresh installs, can reinstall if necessary. QEMU startup params of test VM currently loaded with 8.1: qemu-system-x86_64 -enable-kvm -name Windows81DevWorkstation -S -machine pc-i440fx-utopic,accel=kvm,usb=off -m 8192 -realtime mlock=off -smp 4,sockets=4,cores=1,threads=1 -uuid 074a3dbe-51d7-4a55-85f9-9330516fba1b -nographic -no-user-config -nodefaults -chardev socket,id=charmonitor,path=/var/lib/libvirt/qemu/Windows81DevWorkstation.monitor,server,nowait -mon chardev=charmonitor,id=monitor,mode=control -rtc base=localtime,driftfix=slew -global kvm-pit.lost_tick_policy=discard -no-hpet -no-shutdown -global PIIX4_PM.disable_s3=1 -global PIIX4_PM.disable_s4=1 -boot strict=on -device ich9-usb-ehci1,id=usb,bus=pci.0,addr=0x5.0x7 -device ich9-usb-uhci1,masterbus=usb.0,firstport=0,bus=pci.0,multifunction=on,addr=0x5 -device ich9-usb-uhci2,masterbus=usb.0,firstport=2,bus=pci.0,addr=0x5.0x1 -device ich9-usb-uhci3,masterbus=usb.0,firstport=4,bus=pci.0,addr=0x5.0x2 -device virtio-serial-pci,id=virtio-serial0,bus=pci.0,addr=0x6 -drive file=/var/CG4REPO/VirtualMachines/WindowsWork_New.qcow2,if=none,id=drive-ide0-0-0,format=qcow2 -device ide-hd,bus=ide.0,unit=0,drive=drive-ide0-0-0,id=ide0-0-0,bootindex=1 -drive file=/var/CG4REPO/ISO/Microsoft/win81.iso,if=none,id=drive-ide0-0-1,readonly=on,format=raw -device ide-cd,bus=ide.0,unit=1,drive=drive-ide0-0-1,id=ide0-0-1 -netdev tap,fd=24,id=hostnet0 -device rtl8139,netdev=hostnet0,id=net0,mac=52:54:00:73:07:3c,bus=pci.0,addr=0x3 -chardev pty,id=charserial0 -device isa-serial,chardev=charserial0,id=serial0 -chardev spicevmc,id=charchannel0,name=vdagent -device virtserialport,bus=virtio-serial0.0,nr=1,chardev=charchannel0,id=channel0,name=com.redhat.spice.0 -device usb-tablet,id=input0 -device intel-hda,id=sound0,bus=pci.0,addr=0x4 -device hda-duplex,id=sound0-codec0,bus=sound0.0,cad=0 -chardev spicevmc,id=charredir0,name=usbredir -device usb-redir,chardev=charredir0,id=redir0 -chardev spicevmc,id=charredir1,name=usbredir -device usb-redir,chardev=charredir1,id=redir1 -chardev spicevmc,id=charredir2,name=usbredir -device usb-redir,chardev=charredir2,id=redir2 -chardev spicevmc,id=charredir3,name=usbredir -device usb-redir,chardev=charredir3,id=redir3 -device virtio-balloon-pci,id=balloon0,bus=pci.0,addr=0x7 -device vfio-pci,host=02:00.0,x-vga=on -cpu Haswell,kvm=off -msg timestamp=on (virsh generated, will post if necessary)</code></pre></div><p>-side note-<br />Been reading this post for awhile going through the various issues in my setup (been fun getting this to work without direct access to a head on the secondary GPU <img src="https://bbs.archlinux.org/img/smilies/wink.png" width="15" height="15" alt="wink" />. Thanks for the awesome tutorials / troubleshooting, it&#039;s gotten me almost to the end! and I do apologize if this was covered in the past, I&#039;ve been reading / searching and haven&#039;t found a direct reference to this yet. My brain is pretty squishy right now, though. While this is an arch forum [and I do apologize for posting regarding ubuntu], this is the most active thread, so I was hoping someone could help me out <img src="https://bbs.archlinux.org/img/smilies/smile.png" width="15" height="15" alt="smile" />.</p><p>Issue: Incorrect device ID on host passed to guest prevents secondary GPU from installing.</p><p>WITIR:<br />The device is passed through, however, the device hardware ID inside the guest is short compared to the current 980Ms [If you compare this to what a quadro reports as in their drivers it is more along those lines in terms of pc hardware IDs], I believe this stems from the host [host hardware ID: 10de:13d7] so when attempting driver installation it fails.</p><div class="codebox"><pre><code>hardware ID: PCI\VEN_10DE&amp;DEV_13D7&amp;SUBSYS_110B10DE&amp;REV_A1 PCI\VEN_10DE&amp;DEV_13D7&amp;SUBSYS_110B10DE PCI\VEN_10DE&amp;DEV_13D7&amp;CC_030000 PCI\VEN_10DE&amp;DEV_13D7&amp;CC_0300 Device Instance Path: PCI\VEN_10DE&amp;DEV_13D7&amp;SUBSYS_110B10DE&amp;REV_A1\3&amp;13C0B0C5&amp;0&amp;10 Would look like: %NVIDIA_DEV.13D7% = Section232, PCI\VEN_10DE&amp;DEV_13D7&amp;SUBSYS_110B10DE compared to NVIDIA INF output (1 example of a 980M): %NVIDIA_DEV.13D7.19FD.1043% = Section228, PCI\VEN_10DE&amp;DEV_13D7&amp;SUBSYS_19FD1043 </code></pre></div><p>If you mod the INF for the driver with the line first line mentioned above you can get the installer to work [and the driver to load], however, with 8.1 there is no permanent driver signing disable - and modding an INF (I used nvami.inf) breaks the hash check on a normal boot and fails out the driver. Without direct access to the head on the GPU, this can be... problematic <img src="https://bbs.archlinux.org/img/smilies/wink.png" width="15" height="15" alt="wink" />. With a stripped down version of the libvirt xml to qemu args (only adding disk, network adapter) the same issue occurs.</p><p>So I guess the question is, does anyone have any suggestions on a quick workaround for this [a way to manipulate the hardware ID when passed from host to guest]? Or is there something obvious I&#039;m missing in the setup that is causing this issue to begin with? I imagine it&#039;s the latter, hopefully <img src="https://bbs.archlinux.org/img/smilies/smile.png" width="15" height="15" alt="smile" />.</p><p>Any thoughts or suggestions would be welcome - if you need more data just let me know what you&#039;d like. I am probably overthinking this way too much at this point.</p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1495530">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1495531" class="blockpost roweven"> <h2><span><span class="conr">#3952</span> <a href="viewtopic.php?pid=1495531#p1495531">2015-01-23 01:19:29</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=75590">aw</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2013-10-04</span></dd> <dd><span>Posts: 921</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=75590">Email</a></span> <span class="website"><a href="http://vfio.blogspot.com/" rel="nofollow">Website</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>SEPIPES wrote:</cite><blockquote><div><p>So I guess the question is, does anyone have any suggestions on a quick workaround for this [a way to manipulate the hardware ID when passed from host to guest]? Or is there something obvious I&#039;m missing in the setup that is causing this issue to begin with? I imagine it&#039;s the latter, hopefully <img src="https://bbs.archlinux.org/img/smilies/smile.png" width="15" height="15" alt="smile" />.</p></div></blockquote></div><p><a href="https://bbs.archlinux.org/viewtopic.php?pid=1474497#p1474497" rel="nofollow">https://bbs.archlinux.org/viewtopic.php … 7#p1474497</a></p> </div> <div class="postsignature postmsg"><hr /><p><a href="http://vfio.blogspot.com" rel="nofollow">http://vfio.blogspot.com</a><br />Looking for a more open forum to discuss vfio related uses?&#160; Try <a href="https://www.redhat.com/mailman/listinfo/vfio-users" rel="nofollow">https://www.redhat.com/mailman/listinfo/vfio-users</a></p></div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1495531">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1495556" class="blockpost rowodd"> <h2><span><span class="conr">#3953</span> <a href="viewtopic.php?pid=1495556#p1495556">2015-01-23 05:23:56</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=75590">aw</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2013-10-04</span></dd> <dd><span>Posts: 921</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=75590">Email</a></span> <span class="website"><a href="http://vfio.blogspot.com/" rel="nofollow">Website</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>Denso wrote:</cite><blockquote><div><p>@aw :</p><p>Started recieving these after I upgraded to 3.19-rc1 and still reciving them on 3.19-rc5 :</p></div></blockquote></div><p>Running 3.19-rc5 here, no issues.&#160; There were relatively few VT-d changes between 3.18 and 3.19 and effectively no vfio changes.</p> </div> <div class="postsignature postmsg"><hr /><p><a href="http://vfio.blogspot.com" rel="nofollow">http://vfio.blogspot.com</a><br />Looking for a more open forum to discuss vfio related uses?&#160; Try <a href="https://www.redhat.com/mailman/listinfo/vfio-users" rel="nofollow">https://www.redhat.com/mailman/listinfo/vfio-users</a></p></div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1495556">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1495603" class="blockpost roweven"> <h2><span><span class="conr">#3954</span> <a href="viewtopic.php?pid=1495603#p1495603">2015-01-23 12:08:06</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=86675">lordleto</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2014-11-14</span></dd> <dd><span>Posts: 6</span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>aw wrote:</cite><blockquote><div><div class="quotebox"><cite>KKF wrote:</cite><blockquote><div><p>Hey guys,</p><p>I am new to all this and have wanted to try it out for a while as a learning experience for myself.&#160; I have the budget to build a PC just for this.&#160; For starters I would like to have one Windows 8 VM and Elementary OS as host; if possible.&#160; Eventually I would like to have an OSX VM and a Windows VM, though I understand how difficult that can be.</p><p>With anything of this magnitude I want to make sure I buy the right components for the job.&#160; The only components I own at this point are a 660 ti gpu and a R4 case.&#160; I will probably buy a 970 gpu at some point in the future but no rush at this point.&#160; Any advise on what to buy for MOBO, CPU, and Ram?&#160; Should I buy two separate SSD for each VM?&#160; I have a server that hosts all my documents and files so don&#039;t need to much space on those SSD&#039;s.&#160; </p><p>The OSX VM would mainly be used for Photoshop as my girlfriend prefers the layout of Photoshop in OSX to Windows. The Windows VM would be used for gaming.&#160; I play Heroes of the Storm and SC2.&#160; So nothing to intensive. </p><p>While I really do not have a budget for this I don&#039;t want to spend 2000 dollars either as it really is for learning and the challenge of putting this together.&#160; So what would be my best options for a MOBO, CPU, and Ram?&#160; </p><p>After I buy everything I plan to do an extensive how to on cost and time it took me, a novice, to do this.</p><p>Thanks!</p></div></blockquote></div><p>Use a Xeon E5 or better and non-Intel graphics for the host if you don&#039;t want to deal with patching your kernel for ACS or VGA arbitration (BTW, X99 PCH root port patch just posted).&#160; Gigabyte motherboards seem to be the most configurable when it comes selecting a primary graphics device, which may be important if you end up with 3 graphics cards.&#160; If you blow all your money on an over-spec&#039;d GPU for your needs and skimp a &quot;client&quot; processor, you&#039;ll pay for it patching your kernel forever.&#160; Also, make sure you scale your core count and memory for the intended usage.&#160; If you want to game at the same time as your gf is photoshop&#039;ing, then you need to be able to dedicate some cores to each VM.&#160; Also, OSX w/ GPU assignment is not something a lot of people are doing, so be sure to do your research on whether it&#039;s really an option.&#160; There are parts of getting OSX to work that cannot be discussed on forums like this.</p></div></blockquote></div><br /><p>Hi just wanted to give a short overview over my system that i am really content with. Essentially I started with an typical workstation build and done dualboot over 2 years. But when building the ws i was already looking at functional vt-d and enough pcie slots. So after a lot of success stories in this thread i finally bought a used 2 gpu and tried kvm and was more then pleased with the result.</p><p>My build is as follows</p><p>MB&#160; ASUS P9X79WS<br />CPU Xeon E5 1650 (Xeon E5 16xx are a much better choice then similar i7, for same money you get ECC support and v1 and v2 still have an open multi, so totally easy to OC. Essentially this is the only Xeon line that you can OC, just make sure your MB supports it. Dont know whether v3 (Haswell) is still open multi, but i dont plan to update soon. My CPU is running on 4GHz (didnt bother to go higher, stability is king) which is still plenty.)<br />32GB ECC Ram<br />Geforce GTX 750 Ti Primary<br />Geforce GTX Titan Passthrough<br />2 SSD (1 Boot, 1 VM) <br />Mirrored HD for Data (ZFS, with actually a third ssd for l2arc)<br />Usb audiocard<br />Aten switch</p><p>All is running on Ubuntu 12.04 with Mainline 3.17.1 Kernel and no patches.<br />Selfcompiled qemu 2.1.2<br />libvirt 1.2 from ubuntu cloud ppa<br />I know ubuntu is not latest, but i am to lazy to update and important stuff (kernel, driver, qemu) is uptodate</p><p>pci-stub is done by module, this way i can disable blacklisting the titan during boot if i want. (key is to add softdep drm pre: pci-stub somewehre in modprobe.d)<br />i patched nvidia dkms module with the patch linked here somewhere</p><p>Windows is running on 4 HT Core pinned to them. Rest of the system is moved to remaining 2 cores when vm is spun up by cset, called from a script in libvirt hooks folder. Windows gets 12gb in hugepages.<br />For cpu i have kvm=off so i can run 340 driver in vm. All is working, even game streaming to raspberrypi through geforce experience <br />Performance is near bare metal (Firestrike 9100 and Firestrike Extreme 4800)</p><p>Windows VM gets also a passed through nic (MB has 2) and the asmedia USB 3.0 onboard controller<br />Audio is done by usb sound card hooked to the passed through usb 3.0 controller.<br />Windows VM is actually the image of the bare metal installation, didnt want to reinstall <img src="https://bbs.archlinux.org/img/smilies/smile.png" width="15" height="15" alt="smile" /></p><p>Input and Output is switched by aten switch (got it used)</p><p>At the moment the VM is running on q35 machine and seabios. I tried also 440fx (with qemu wrapper script), it worked but for some reason some things in geforce experience were disabled, didnt look to closely into that.<br />Only issue is 1 out of 20 times the whole system freezes on VM start, and really on start only, even before any output on second card is to be seen. Cant really point to why. But its so seldom and only occuring during vm boot that i didnt know how to debug this.<br />Now i am sorting out what gives me best io performace and whether i can get trim working for sparse raw files on zfs datasets. (Virtio blk now, trim not working)<br />Also Windows 7 virtio net seems to be bottlenecked at 500Mbyte/s for incoming tcp connections. Outgoing and bothways with linux vm is at 2GByte/s and more. That is important metric for internal shares on ssd, but even 500Mbyte/s is not bad.</p><p>Endresult:<br />I dont need to double boot to play games or use lightroom with color calibration on monitor. <br />All important stuff (Dokuments, Pictures) is finally on zfs storage (zfs send recieve, checksums, snapshots, clones, way better than ntfs or ext4 for important data)</p><p>I can go into configuration detail (xmls, scripts) if someone is interested.<br />I want to say many thanks to all who write here for invaluable information and hard programming work.<br />And finally i can only vouch for the Xeon route.</p> <p class="postedit"><em>Last edited by lordleto (2015-01-23 13:09:34)</em></p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1495603">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1495644" class="blockpost rowodd"> <h2><span><span class="conr">#3955</span> <a href="viewtopic.php?pid=1495644#p1495644">2015-01-23 15:05:36</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=84760">Denso</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd class="postavatar"><img src="https://bbs.archlinux.org/img/avatars/84760.png?m=1412533733" width="71" height="80" alt="" /></dd> <dd><span>Registered: 2014-08-30</span></dd> <dd><span>Posts: 179</span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>aw wrote:</cite><blockquote><div><p>Running 3.19-rc5 here, no issues.&#160; There were relatively few VT-d changes between 3.18 and 3.19 and effectively no vfio changes.</p></div></blockquote></div><p>That&#039;s weird . I just downgraded to 3.18.2 and I no longer have any issues , the VM works correctly . No code 43 and no DMAR errors in host&#039;s dmesg output .</p><p>It surely is related to 3.19 + X99 .</p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1495644">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1495648" class="blockpost roweven"> <h2><span><span class="conr">#3956</span> <a href="viewtopic.php?pid=1495648#p1495648">2015-01-23 15:27:24</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=75590">aw</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2013-10-04</span></dd> <dd><span>Posts: 921</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=75590">Email</a></span> <span class="website"><a href="http://vfio.blogspot.com/" rel="nofollow">Website</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>Denso wrote:</cite><blockquote><div><div class="quotebox"><cite>aw wrote:</cite><blockquote><div><p>Running 3.19-rc5 here, no issues.&#160; There were relatively few VT-d changes between 3.18 and 3.19 and effectively no vfio changes.</p></div></blockquote></div><p>That&#039;s weird . I just downgraded to 3.18.2 and I no longer have any issues , the VM works correctly . No code 43 and no DMAR errors in host&#039;s dmesg output .</p><p>It surely is related to 3.19 + X99 .</p></div></blockquote></div><div class="codebox"><pre class="vscroll"><code>$ git log --oneline --no-merges v3.18..v3.19-rc1 drivers/iommu | grep -v omap | grep -v amd | grep -v smmu | grep -v rockchip | grep -v msm | grep -v vmsa | grep -v exynos 91411da iommu/vt-d: Use helpers to access irq_cfg data structure associated with IRQ b71a3b2 x86: irq_remapping: Use helpers to access irq_cfg data structure associated with IRQ a42a7a1 iommu: store DT-probed IOMMU data privately 8918465 memory: Add NVIDIA Tegra memory controller support 18f2340 iommu: Decouple iommu_map_sg from CPU page size cc4f14a iommu/vt-d: Fix an off-by-one bug in __domain_mapping() 461bfb3f iommu: fix initialization without &#039;add_device&#039; callback 7eba1d5 iommu: provide helper function to configure an IOMMU for an of master 1cd076bf iommu: provide early initialisation hook for IOMMU drivers 63a7b17 PCI/MSI: Simplify PCI MSI code by initializing msi_desc.nvec_used earlier ffebeb4 iommu/vt-d: Enhance intel-iommu driver to support DMAR unit hotplug 51acce3 iommu/vt-d: Enhance error recovery in function intel_enable_irq_remapping() a7a3dad iommu/vt-d: Enhance intel_irq_remapping driver to support DMAR unit hotplug d35165a iommu/vt-d: Search for ACPI _DSM method for DMAR hotplug 6b19724 iommu/vt-d: Implement DMAR unit hotplug framework 78d8e70 iommu/vt-d: Dynamically allocate and free seq_id for DMAR units c2a0b53 iommu/vt-d: Introduce helper function dmar_walk_resources() 1a2262f x86/vt-d: Fix incorrect bit operations in setting values d7da6bd iommu: Improve error handling when setting bus iommu 38ec010 iommu: Do more input validation in iommu_map_sg() 315786e iommu: Add iommu_map_sg() function 98b773c iommu: drop owner assignment from platform_drivers $ git log --oneline --no-merges v3.18..v3.19-rc1 drivers/vfio 83a1891 PCI/MSI: Rename write_msi_msg() to pci_write_msi_msg() 5e9f36c drivers/vfio: allow type-1 IOMMU instantiation on top of an ARM SMMU 1d53a3a vfio: make vfio run on s390</code></pre></div> </div> <div class="postsignature postmsg"><hr /><p><a href="http://vfio.blogspot.com" rel="nofollow">http://vfio.blogspot.com</a><br />Looking for a more open forum to discuss vfio related uses?&#160; Try <a href="https://www.redhat.com/mailman/listinfo/vfio-users" rel="nofollow">https://www.redhat.com/mailman/listinfo/vfio-users</a></p></div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1495648">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1495670" class="blockpost rowodd"> <h2><span><span class="conr">#3957</span> <a href="viewtopic.php?pid=1495670#p1495670">2015-01-23 17:19:10</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=88206">SEPIPES</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2015-01-23</span></dd> <dd><span>Posts: 2</span></dd> <dd class="usercontacts"><span class="email"><a href="mailto:soko.splat@gmail.com">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>aw wrote:</cite><blockquote><div><div class="quotebox"><cite>SEPIPES wrote:</cite><blockquote><div><p>So I guess the question is, does anyone have any suggestions on a quick workaround for this [a way to manipulate the hardware ID when passed from host to guest]? Or is there something obvious I&#039;m missing in the setup that is causing this issue to begin with? I imagine it&#039;s the latter, hopefully <img src="https://bbs.archlinux.org/img/smilies/smile.png" width="15" height="15" alt="smile" />.</p></div></blockquote></div><p><a href="https://bbs.archlinux.org/viewtopic.php?pid=1474497#p1474497" rel="nofollow">https://bbs.archlinux.org/viewtopic.php … 7#p1474497</a></p></div></blockquote></div><p>Thanks for the link.<br />It reminded me that I could get a signed driver by manipulating the compat list rather than the hardware dev_ID itself [inside the guest]. I was kind of surprised that worked (well, worked enough that I could get past the hardware ID check). This gave me the latest driver that matches against a win booted host but gets me the notorious code 43 from the 980m post driver install.</p><p>Ah well, if it was easy it wouldn&#039;t be fun. Time to go reread some posts, thanks again <img src="https://bbs.archlinux.org/img/smilies/smile.png" width="15" height="15" alt="smile" />.</p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1495670">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1495671" class="blockpost roweven"> <h2><span><span class="conr">#3958</span> <a href="viewtopic.php?pid=1495671#p1495671">2015-01-23 17:26:08</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=84760">Denso</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd class="postavatar"><img src="https://bbs.archlinux.org/img/avatars/84760.png?m=1412533733" width="71" height="80" alt="" /></dd> <dd><span>Registered: 2014-08-30</span></dd> <dd><span>Posts: 179</span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <p>@aw :</p><p>I got it that changes are only happening in the IOMMU driver for 3.19 and not VFIO . What I&#039;m certain of , is that these issues do not exist with 3.18.2 . They only happen with 3.19-rc1~rc5 .</p><p>Thank you for posting these commit diffs , I can see that some changes list DMAR . Those errors I had were DMAR related .</p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1495671">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1495840" class="blockpost rowodd"> <h2><span><span class="conr">#3959</span> <a href="viewtopic.php?pid=1495840#p1495840">2015-01-24 07:17:38</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=88238">AdamM</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2015-01-24</span></dd> <dd><span>Posts: 3</span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>Denso wrote:</cite><blockquote><div><p>@aw :</p><p>Started recieving these after I upgraded to 3.19-rc1 and still reciving them on 3.19-rc5 :</p><div class="codebox"><pre><code>[Thu Jan 22 23:13:54 2015] dmar: DRHD: handling fault status reg 2 [Thu Jan 22 23:13:54 2015] dmar: DMAR:[DMA Read] Request device [02:00.1] fault addr 10af25000 DMAR:[fault reason 06] PTE Read access is not set ...</code></pre></div></div></blockquote></div><p>I&#039;ve been having the same issues after the update.</p><p>The errors first appeared when booting, complaining about the integrated graphics card. I tried intel_iommu=on,igfx_off which resolved the boot time errors, but caused qemu to crash.</p><p>I should point out that I&#039;ve been running both Window 7 and Mac OS X Mavericks for months without a single problem on previous kernels.</p><p>Specs:</p><p>Motherboard: Asus Maximus VII Ranger<br />CPU: Intel i7-4790K<br />GPU: Radeon R9 270X</p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1495840">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1495922" class="blockpost roweven"> <h2><span><span class="conr">#3960</span> <a href="viewtopic.php?pid=1495922#p1495922">2015-01-24 14:37:37</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=75590">aw</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2013-10-04</span></dd> <dd><span>Posts: 921</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=75590">Email</a></span> <span class="website"><a href="http://vfio.blogspot.com/" rel="nofollow">Website</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>AdamM wrote:</cite><blockquote><div><div class="quotebox"><cite>Denso wrote:</cite><blockquote><div><p>@aw :</p><p>Started recieving these after I upgraded to 3.19-rc1 and still reciving them on 3.19-rc5 :</p><div class="codebox"><pre><code>[Thu Jan 22 23:13:54 2015] dmar: DRHD: handling fault status reg 2 [Thu Jan 22 23:13:54 2015] dmar: DMAR:[DMA Read] Request device [02:00.1] fault addr 10af25000 DMAR:[fault reason 06] PTE Read access is not set ...</code></pre></div></div></blockquote></div><p>I&#039;ve been having the same issues after the update.</p></div></blockquote></div><p>Does anything change adding <em>sp_off</em> to the intel_iommu options?</p> </div> <div class="postsignature postmsg"><hr /><p><a href="http://vfio.blogspot.com" rel="nofollow">http://vfio.blogspot.com</a><br />Looking for a more open forum to discuss vfio related uses?&#160; Try <a href="https://www.redhat.com/mailman/listinfo/vfio-users" rel="nofollow">https://www.redhat.com/mailman/listinfo/vfio-users</a></p></div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1495922">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1496193" class="blockpost rowodd"> <h2><span><span class="conr">#3961</span> <a href="viewtopic.php?pid=1496193#p1496193">2015-01-25 09:48:13</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=88238">AdamM</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2015-01-24</span></dd> <dd><span>Posts: 3</span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>aw wrote:</cite><blockquote><div><p>Does anything change adding <em>sp_off</em> to the intel_iommu options?</p></div></blockquote></div><p>I&#039;ve tried all the available options (igfx_off, forcedac, strict, and sp_off) but the results are the same.</p><p>I&#039;ve been religiously checking the <a href="https://git.kernel.org/cgit/linux/kernel/git/joro/iommu.git/log/drivers/iommu?h=next" rel="nofollow">log</a> for the past week hoping for a magical fix to appear. No such luck unfortunately.</p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1496193">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1496306" class="blockpost roweven"> <h2><span><span class="conr">#3962</span> <a href="viewtopic.php?pid=1496306#p1496306">2015-01-25 16:58:25</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=75590">aw</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2013-10-04</span></dd> <dd><span>Posts: 921</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=75590">Email</a></span> <span class="website"><a href="http://vfio.blogspot.com/" rel="nofollow">Website</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>AdamM wrote:</cite><blockquote><div><div class="quotebox"><cite>aw wrote:</cite><blockquote><div><p>Does anything change adding <em>sp_off</em> to the intel_iommu options?</p></div></blockquote></div><p>I&#039;ve tried all the available options (igfx_off, forcedac, strict, and sp_off) but the results are the same.</p><p>I&#039;ve been religiously checking the <a href="https://git.kernel.org/cgit/linux/kernel/git/joro/iommu.git/log/drivers/iommu?h=next" rel="nofollow">log</a> for the past week hoping for a magical fix to appear. No such luck unfortunately.</p></div></blockquote></div><p>It would probably be more useful to hunt down the change that broke it rather than blindly hope for a fix.</p> </div> <div class="postsignature postmsg"><hr /><p><a href="http://vfio.blogspot.com" rel="nofollow">http://vfio.blogspot.com</a><br />Looking for a more open forum to discuss vfio related uses?&#160; Try <a href="https://www.redhat.com/mailman/listinfo/vfio-users" rel="nofollow">https://www.redhat.com/mailman/listinfo/vfio-users</a></p></div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1496306">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1496361" class="blockpost rowodd"> <h2><span><span class="conr">#3963</span> <a href="viewtopic.php?pid=1496361#p1496361">2015-01-25 19:30:45</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=88238">AdamM</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2015-01-24</span></dd> <dd><span>Posts: 3</span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>aw wrote:</cite><blockquote><div><p>It would probably be more useful to hunt down the change that broke it rather than blindly hope for a fix.</p></div></blockquote></div><p>I have been tempted to compile the kernel for each commit, but at the moment my system needs to stay on, so I&#039;d have no way of testing them. Hence the waiting for a magical fix to appear.</p><p>I should also point out that unlike Denso, my problems started when I upgraded from 3.17.6 to 3.18.2. I&#039;ve looked at all the changes to the iommu code between those releases but nothing stands out.</p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1496361">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1496520" class="blockpost roweven"> <h2><span><span class="conr">#3964</span> <a href="viewtopic.php?pid=1496520#p1496520">2015-01-26 09:52:50</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=79471">Bronek</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>From: London</span></dd> <dd><span>Registered: 2014-02-14</span></dd> <dd><span>Posts: 90</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=79471">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <p>I tried a new workstation card, AMD W7100 (Tonga family) and it&#039;s causing me problems, although it&#039;s also possible that my setup (see below) or, less likely, kernel upgrade from 3.17.7 to 3.17.8 could be also to blame. Everything works fine until I shutdown VM machine win171 &amp; and start it again. Then I receive following dmesg on the console (it fills the screen very very quickly - below was retyped by me from screen photo, I am yet to attach serial console cable):</p><div class="codebox"><pre><code>dmar: DRHD: handling fault status reg 40 dmar: DRHD: handling fault status reg 40 dmar: DRHD: handling fault status reg 40 . . . </code></pre></div><p>which is next followed by </p><div class="codebox"><pre><code>NMI watchdog: BUG: soft lockup - CPU#3 stuck for 23s! [qemu:win171:4568] NMI watchdog: BUG: soft lockup - CPU#9 stuck for 23s! [qemu:win249:4259] NMI watchdog: BUG: soft lockup - CPU#3 stuck for 23s! [qemu:win171:4568] NMI watchdog: BUG: soft lockup - CPU#9 stuck for 23s! [qemu:win249:4259] INFO: rcu_preempt_detected stalls on CPUs/tasks: { 2} (detected by 9, t=18002 jiffies, g=56726, c=56725, q=11821) mpt2sas0: mpt2sas_scsih_issue_tm: timeout NMI watchdog: BUG: soft lockup - CPU#3 stuck for 23s! [qemu:win171:4568] NMI watchdog: BUG: soft lockup - CPU#9 stuck for 23s! [qemu:win249:4259] . . . </code></pre></div><p>When this happens the computer becomes totally unresponsive and has to be powered down. Normal reset is not enough, I get dmar errors as soon as kernel is loaded again.</p><p>I&#039;m running 2 different VMs, win171 and win249 . Both are Windows 7, each has its own GPU (and small number of PCI passed-thru devices) and both perform well and are stable - that is, until I restart win171 (which is attached to W7100).</p><p>Another factor which might be causing problems here is that card W7100 is used by system as primary VGA, i.e. first it shows BIOS startup screen, next SYSLINUX and then kernel messages on startup. Also, kernel is actually writing to it (as VGA framebuffer) <strong>after</strong> win171 has been started, as I see some low priority dmesg (warnings related to my USB devices setup) on the screen overwriting SEABIOS messages. One way I could try to prevent this is to disable ROM of this card in BIOS thus rendering my machine entirely headless, but this is a bit drastic.</p><p>Ideally I&#039;d rather find the right combination of kernel parameters to prevent kernel from using VGA after after its been loaded to memory (while still allowing both BIOS and SYSLINUX to use it). I will try &quot;console=ttyS0 nomodeset&quot;, any better ideas? The hypervisor is meant to run headless, but I&#039;d rather see initial startup sequence until the kernel has loaded.</p> <p class="postedit"><em>Last edited by Bronek (2015-01-26 10:01:40)</em></p> </div> <div class="postsignature postmsg"><hr /><p>Sorry about&#160; &quot;KVM VGA-Passthrough ...&quot; thread <img src="https://bbs.archlinux.org/img/smilies/sad.png" width="15" height="15" alt="sad" /> Anyone interested in continuing this discussion elsewhere, please contact me privately. I might be able to find it a new home.</p></div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1496520">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1496846" class="blockpost rowodd"> <h2><span><span class="conr">#3965</span> <a href="viewtopic.php?pid=1496846#p1496846">2015-01-27 07:47:26</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=84760">Denso</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd class="postavatar"><img src="https://bbs.archlinux.org/img/avatars/84760.png?m=1412533733" width="71" height="80" alt="" /></dd> <dd><span>Registered: 2014-08-30</span></dd> <dd><span>Posts: 179</span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <p><strong>10Gbps Pipe :</strong></p><p>Hi , I just got around setting an effective 10Gbps networking between the host and Windows 8.1 guest (For Samba shares) and I got a very good performance . Here is a SMB share on the host&#039;s RAM Disk result :</p><p><a href="http://i.imgur.com/Ro6Jj5y.png" rel="nofollow">http://i.imgur.com/Ro6Jj5y.png</a></p><p>Execute this script BEFORE booting your VM to set up the host&#039;s interface :</p><div class="codebox"><pre><code>ip tuntap add tap_s mode tap multi_queue ip link set tap_s mtu 65500 ip link set tap_s txqueuelen 5000 ip link set dev tap_s up ip addr add 195.165.1.2/24 broadcast 195.165.1.255 dev tap_s</code></pre></div><p>Of course , change the IP address to whatever you like .</p><p>Then add this interface as a device to your QEMU command line :</p><div class="codebox"><pre><code>-netdev type=tap,ifname=tap_s,id=net1,vhost=on,vhostforce=on,queues=4,script= \ -device virtio-net-pci,netdev=net1,mq=on,vectors=9 \</code></pre></div><p>Now on your Windows VM , set the new interface , give it an IP address in the same space as the host&#039;s interface like : 195.165.1.3 with a netmask of 255.255.255.0 , and no gateway or DNS .</p><p>Done !</p><p>You can now ping your host and connect to your SMB shares at 10Gbps .</p><p>You can also raise the MTU value in the interface&#039;s configuration dialog in Windows Device Manager from 1500 to 65500 . I got only 5Gbps with 1500 MTU , so you should change it to 65500 .</p><p>Please note that this is going to be from host to guest and vice versa only , you still need another interface for internet / bridge networking .</p><p>Hope this helps <img src="https://bbs.archlinux.org/img/smilies/smile.png" width="15" height="15" alt="smile" /></p> <p class="postedit"><em>Last edited by Denso (2015-01-27 08:01:05)</em></p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1496846">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1496899" class="blockpost roweven"> <h2><span><span class="conr">#3966</span> <a href="viewtopic.php?pid=1496899#p1496899">2015-01-27 11:59:00</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=86321">thearcherblog</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2014-10-30</span></dd> <dd><span>Posts: 165</span></dd> <dd class="usercontacts"><span class="email"><a href="mailto:jjgarcianorway@gmail.com">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <p>Hello all,</p><p>My system is running perfect normally, thanks to all of you but, sometimes, after shutting down my virtual guest and turn it on again, I had a segmentation fault:</p><div class="codebox"><pre class="vscroll"><code>Jan 27 07:26:26 mycolonialone kernel: general protection fault: 0000 [#1] PREEMPT SMP Jan 27 07:26:26 mycolonialone kernel: Modules linked in: vfio_pci vfio_iommu_type1 vfio ecb joydev mousedev btusb uvcvideo videobuf2_vmalloc bluetooth videobuf2_memops s Jan 27 07:26:26 mycolonialone kernel: 8250_dw dw_dmac_core i2c_designware_platform i2c_designware_core gpio_lynxpoint spi_pxa2xx_platform acpi_pad nouveau mxm_wmi wmi t Jan 27 07:26:26 mycolonialone kernel: CPU: 2 PID: 2176 Comm: vfio-bind Not tainted 3.18.2-2-ARCH #1 Jan 27 07:26:26 mycolonialone kernel: Hardware name: To Be Filled By O.E.M. To Be Filled By O.E.M./Z97 Extreme6, BIOS P1.60 12/09/2014 Jan 27 07:26:26 mycolonialone kernel: task: ffff88028c42da90 ti: ffff88002c97c000 task.ti: ffff88002c97c000 Jan 27 07:26:26 mycolonialone kernel: RIP: 0010:[&lt;ffffffff813c3bf3&gt;] [&lt;ffffffff813c3bf3&gt;] __rpm_callback+0x33/0x90 Jan 27 07:26:26 mycolonialone kernel: RSP: 0018:ffff88002c97fd38 EFLAGS: 00010286 Jan 27 07:26:26 mycolonialone kernel: RAX: 0000000000000008 RBX: ffff880458dad098 RCX: 0000000000000000 Jan 27 07:26:26 mycolonialone kernel: RDX: ffff8804541e8b88 RSI: ffff880458dad098 RDI: ffff880458dad098 Jan 27 07:26:26 mycolonialone kernel: RBP: ffff88002c97fd58 R08: 0000000000000246 R09: ffffea0001a8b800 Jan 27 07:26:26 mycolonialone kernel: R10: ffffffffa096a1c8 R11: ffffea001138da40 R12: ffff880458dad146 Jan 27 07:26:26 mycolonialone kernel: R13: 1b48313b30315b1b R14: 0000000000000000 R15: fffffffffffffff2 Jan 27 07:26:26 mycolonialone kernel: FS: 00007f2964cef700(0000) GS:ffff88046fa80000(0000) knlGS:0000000000000000 Jan 27 07:26:26 mycolonialone kernel: CS: 0010 DS: 0000 ES: 0000 CR0: 0000000080050033 Jan 27 07:26:26 mycolonialone kernel: CR2: 00007f2964d1b000 CR3: 00000000109ff000 CR4: 00000000001407e0 Jan 27 07:26:26 mycolonialone kernel: Stack: Jan 27 07:26:26 mycolonialone kernel: 00000000ffffffff ffff880458dad098 ffff880458dad098 0000000000000004 Jan 27 07:26:26 mycolonialone kernel: ffff88002c97fd88 ffffffff813c4a89 ffff880458dad098 0000000000000004 Jan 27 07:26:26 mycolonialone kernel: ffff880458dad146 0000000000000246 ffff88002c97fdb8 ffffffff813c4bc3 Jan 27 07:26:26 mycolonialone kernel: Call Trace: Jan 27 07:26:26 mycolonialone kernel: [&lt;ffffffff813c4a89&gt;] rpm_idle+0x259/0x340 Jan 27 07:26:26 mycolonialone kernel: [&lt;ffffffff813c4bc3&gt;] __pm_runtime_idle+0x53/0x70 Jan 27 07:26:26 mycolonialone kernel: [&lt;ffffffff812f3208&gt;] pci_device_remove+0x78/0xc0 Jan 27 07:26:26 mycolonialone kernel: [&lt;ffffffff813bab7f&gt;] __device_release_driver+0x7f/0xf0 Jan 27 07:26:26 mycolonialone kernel: [&lt;ffffffff813bac13&gt;] device_release_driver+0x23/0x30 Jan 27 07:26:26 mycolonialone kernel: [&lt;ffffffff813b98ed&gt;] unbind_store+0xed/0x150 Jan 27 07:26:26 mycolonialone kernel: [&lt;ffffffff813b8b45&gt;] drv_attr_store+0x25/0x40 Jan 27 07:26:26 mycolonialone kernel: [&lt;ffffffff8124747a&gt;] sysfs_kf_write+0x3a/0x50 Jan 27 07:26:26 mycolonialone kernel: [&lt;ffffffff812469be&gt;] kernfs_fop_write+0xee/0x180 Jan 27 07:26:26 mycolonialone kernel: [&lt;ffffffff811cf1d7&gt;] vfs_write+0xb7/0x200 Jan 27 07:26:26 mycolonialone kernel: [&lt;ffffffff811cfd29&gt;] SyS_write+0x59/0xd0 Jan 27 07:26:26 mycolonialone kernel: [&lt;ffffffff81554ca9&gt;] system_call_fastpath+0x12/0x17 Jan 27 07:26:26 mycolonialone kernel: Code: e5 41 55 41 54 53 4c 8d a6 ae 00 00 00 49 89 fd 48 89 f3 48 83 ec 08 f6 86 89 01 00 00 02 4c 89 e7 74 35 e8 50 06 19 00 48 89 Jan 27 07:26:26 mycolonialone kernel: RIP [&lt;ffffffff813c3bf3&gt;] __rpm_callback+0x33/0x90 Jan 27 07:26:26 mycolonialone kernel: RSP &lt;ffff88002c97fd38&gt; Jan 27 07:26:26 mycolonialone kernel: ---[ end trace 449fe5da686b88a6 ]---</code></pre></div><p>Please, let me know all the files, logs or whatever you need and I will provide them with pleasure.</p><p>Is not anything urgent because only happens sometimes but is annoying <img src="https://bbs.archlinux.org/img/smilies/smile.png" width="15" height="15" alt="smile" /></p><p>Thanks a lot in advance <img src="https://bbs.archlinux.org/img/smilies/smile.png" width="15" height="15" alt="smile" /></p><br /><p>Regards,</p><br /><p>TheArcher</p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1496899">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1497114" class="blockpost rowodd"> <h2><span><span class="conr">#3967</span> <a href="viewtopic.php?pid=1497114#p1497114">2015-01-27 21:38:20</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=88179">KKF</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2015-01-21</span></dd> <dd><span>Posts: 3</span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>aw wrote:</cite><blockquote><div><div class="quotebox"><cite>KKF wrote:</cite><blockquote><div><p>Hey guys,</p><p>I am new to all this and have wanted to try it out for a while as a learning experience for myself.&#160; I have the budget to build a PC just for this.&#160; For starters I would like to have one Windows 8 VM and Elementary OS as host; if possible.&#160; Eventually I would like to have an OSX VM and a Windows VM, though I understand how difficult that can be.</p><p>With anything of this magnitude I want to make sure I buy the right components for the job.&#160; The only components I own at this point are a 660 ti gpu and a R4 case.&#160; I will probably buy a 970 gpu at some point in the future but no rush at this point.&#160; Any advise on what to buy for MOBO, CPU, and Ram?&#160; Should I buy two separate SSD for each VM?&#160; I have a server that hosts all my documents and files so don&#039;t need to much space on those SSD&#039;s.&#160; </p><p>The OSX VM would mainly be used for Photoshop as my girlfriend prefers the layout of Photoshop in OSX to Windows. The Windows VM would be used for gaming.&#160; I play Heroes of the Storm and SC2.&#160; So nothing to intensive. </p><p>While I really do not have a budget for this I don&#039;t want to spend 2000 dollars either as it really is for learning and the challenge of putting this together.&#160; So what would be my best options for a MOBO, CPU, and Ram?&#160; </p><p>After I buy everything I plan to do an extensive how to on cost and time it took me, a novice, to do this.</p><p>Thanks!</p></div></blockquote></div><p>Use a Xeon E5 or better and non-Intel graphics for the host if you don&#039;t want to deal with patching your kernel for ACS or VGA arbitration (BTW, X99 PCH root port patch just posted).&#160; Gigabyte motherboards seem to be the most configurable when it comes selecting a primary graphics device, which may be important if you end up with 3 graphics cards.&#160; If you blow all your money on an over-spec&#039;d GPU for your needs and skimp a &quot;client&quot; processor, you&#039;ll pay for it patching your kernel forever.&#160; Also, make sure you scale your core count and memory for the intended usage.&#160; If you want to game at the same time as your gf is photoshop&#039;ing, then you need to be able to dedicate some cores to each VM.&#160; Also, OSX w/ GPU assignment is not something a lot of people are doing, so be sure to do your research on whether it&#039;s really an option.&#160; There are parts of getting OSX to work that cannot be discussed on forums like this.</p></div></blockquote></div><br /><p>So I take it that the cores are not dynamically shared as a hyper-v?&#160; Wouldn&#039;t an AMD chip be a better fit then?&#160; (More cores cheaper... AMD FX-9590?)&#160; Thank you for your insight I am sure I will have more questions.&#160; <img src="https://bbs.archlinux.org/img/smilies/smile.png" width="15" height="15" alt="smile" /></p> <p class="postedit"><em>Last edited by KKF (2015-01-27 21:51:55)</em></p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1497114">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1497122" class="blockpost roweven"> <h2><span><span class="conr">#3968</span> <a href="viewtopic.php?pid=1497122#p1497122">2015-01-27 21:50:44</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=88179">KKF</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2015-01-21</span></dd> <dd><span>Posts: 3</span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>lordleto wrote:</cite><blockquote><div><div class="quotebox"><cite>aw wrote:</cite><blockquote><div><div class="quotebox"><cite>KKF wrote:</cite><blockquote><div><p>Hey guys,</p><p>I am new to all this and have wanted to try it out for a while as a learning experience for myself.&#160; I have the budget to build a PC just for this.&#160; For starters I would like to have one Windows 8 VM and Elementary OS as host; if possible.&#160; Eventually I would like to have an OSX VM and a Windows VM, though I understand how difficult that can be.</p><p>With anything of this magnitude I want to make sure I buy the right components for the job.&#160; The only components I own at this point are a 660 ti gpu and a R4 case.&#160; I will probably buy a 970 gpu at some point in the future but no rush at this point.&#160; Any advise on what to buy for MOBO, CPU, and Ram?&#160; Should I buy two separate SSD for each VM?&#160; I have a server that hosts all my documents and files so don&#039;t need to much space on those SSD&#039;s.&#160; </p><p>The OSX VM would mainly be used for Photoshop as my girlfriend prefers the layout of Photoshop in OSX to Windows. The Windows VM would be used for gaming.&#160; I play Heroes of the Storm and SC2.&#160; So nothing to intensive. </p><p>While I really do not have a budget for this I don&#039;t want to spend 2000 dollars either as it really is for learning and the challenge of putting this together.&#160; So what would be my best options for a MOBO, CPU, and Ram?&#160; </p><p>After I buy everything I plan to do an extensive how to on cost and time it took me, a novice, to do this.</p><p>Thanks!</p></div></blockquote></div><p>Use a Xeon E5 or better and non-Intel graphics for the host if you don&#039;t want to deal with patching your kernel for ACS or VGA arbitration (BTW, X99 PCH root port patch just posted).&#160; Gigabyte motherboards seem to be the most configurable when it comes selecting a primary graphics device, which may be important if you end up with 3 graphics cards.&#160; If you blow all your money on an over-spec&#039;d GPU for your needs and skimp a &quot;client&quot; processor, you&#039;ll pay for it patching your kernel forever.&#160; Also, make sure you scale your core count and memory for the intended usage.&#160; If you want to game at the same time as your gf is photoshop&#039;ing, then you need to be able to dedicate some cores to each VM.&#160; Also, OSX w/ GPU assignment is not something a lot of people are doing, so be sure to do your research on whether it&#039;s really an option.&#160; There are parts of getting OSX to work that cannot be discussed on forums like this.</p></div></blockquote></div><br /><p>Hi just wanted to give a short overview over my system that i am really content with. Essentially I started with an typical workstation build and done dualboot over 2 years. But when building the ws i was already looking at functional vt-d and enough pcie slots. So after a lot of success stories in this thread i finally bought a used 2 gpu and tried kvm and was more then pleased with the result.</p><p>My build is as follows</p><p>MB&#160; ASUS P9X79WS<br />CPU Xeon E5 1650 (Xeon E5 16xx are a much better choice then similar i7, for same money you get ECC support and v1 and v2 still have an open multi, so totally easy to OC. Essentially this is the only Xeon line that you can OC, just make sure your MB supports it. Dont know whether v3 (Haswell) is still open multi, but i dont plan to update soon. My CPU is running on 4GHz (didnt bother to go higher, stability is king) which is still plenty.)<br />32GB ECC Ram<br />Geforce GTX 750 Ti Primary<br />Geforce GTX Titan Passthrough<br />2 SSD (1 Boot, 1 VM) <br />Mirrored HD for Data (ZFS, with actually a third ssd for l2arc)<br />Usb audiocard<br />Aten switch</p><p>All is running on Ubuntu 12.04 with Mainline 3.17.1 Kernel and no patches.<br />Selfcompiled qemu 2.1.2<br />libvirt 1.2 from ubuntu cloud ppa<br />I know ubuntu is not latest, but i am to lazy to update and important stuff (kernel, driver, qemu) is uptodate</p><p>pci-stub is done by module, this way i can disable blacklisting the titan during boot if i want. (key is to add softdep drm pre: pci-stub somewehre in modprobe.d)<br />i patched nvidia dkms module with the patch linked here somewhere</p><p>Windows is running on 4 HT Core pinned to them. Rest of the system is moved to remaining 2 cores when vm is spun up by cset, called from a script in libvirt hooks folder. Windows gets 12gb in hugepages.<br />For cpu i have kvm=off so i can run 340 driver in vm. All is working, even game streaming to raspberrypi through geforce experience <br />Performance is near bare metal (Firestrike 9100 and Firestrike Extreme 4800)</p><p>Windows VM gets also a passed through nic (MB has 2) and the asmedia USB 3.0 onboard controller<br />Audio is done by usb sound card hooked to the passed through usb 3.0 controller.<br />Windows VM is actually the image of the bare metal installation, didnt want to reinstall <img src="https://bbs.archlinux.org/img/smilies/smile.png" width="15" height="15" alt="smile" /></p><p>Input and Output is switched by aten switch (got it used)</p><p>At the moment the VM is running on q35 machine and seabios. I tried also 440fx (with qemu wrapper script), it worked but for some reason some things in geforce experience were disabled, didnt look to closely into that.<br />Only issue is 1 out of 20 times the whole system freezes on VM start, and really on start only, even before any output on second card is to be seen. Cant really point to why. But its so seldom and only occuring during vm boot that i didnt know how to debug this.<br />Now i am sorting out what gives me best io performace and whether i can get trim working for sparse raw files on zfs datasets. (Virtio blk now, trim not working)<br />Also Windows 7 virtio net seems to be bottlenecked at 500Mbyte/s for incoming tcp connections. Outgoing and bothways with linux vm is at 2GByte/s and more. That is important metric for internal shares on ssd, but even 500Mbyte/s is not bad.</p><p>Endresult:<br />I dont need to double boot to play games or use lightroom with color calibration on monitor. <br />All important stuff (Dokuments, Pictures) is finally on zfs storage (zfs send recieve, checksums, snapshots, clones, way better than ntfs or ext4 for important data)</p><p>I can go into configuration detail (xmls, scripts) if someone is interested.<br />I want to say many thanks to all who write here for invaluable information and hard programming work.<br />And finally i can only vouch for the Xeon route.</p></div></blockquote></div><p>Wow, thanks this was very helpful!&#160; I will post more questions as time progresses.</p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1497122">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1497123" class="blockpost rowodd"> <h2><span><span class="conr">#3969</span> <a href="viewtopic.php?pid=1497123#p1497123">2015-01-27 21:51:37</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=75590">aw</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2013-10-04</span></dd> <dd><span>Posts: 921</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=75590">Email</a></span> <span class="website"><a href="http://vfio.blogspot.com/" rel="nofollow">Website</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>KKF wrote:</cite><blockquote><div><p>So I take it that the cores are not dynamically shared as a hyper-v?&#160; Wouldn&#039;t an AMD chip be a better fit then?&#160; (More cores cheaper...)&#160; Thank you for your insight I am sure I will have more questions.&#160; <img src="https://bbs.archlinux.org/img/smilies/smile.png" width="15" height="15" alt="smile" /></p></div></blockquote></div><p>Cores are share-able, what I&#039;m suggesting and what many people here have confirmed is that if you intend to use one of the VMs for gaming, then you don&#039;t want the variable performance associated with sharing cores.&#160; Do you really want to get fragged in your game because your girlfriend applied a complex transform to an image and your frame rate bottomed out?&#160; If you were only running desktop applications in each VM, then by all means oversubscribe the cores between VMs.&#160; As for AMD, I just don&#039;t see them being all that competitive and they certainly don&#039;t have the enterprise related testing that Intel does.</p> </div> <div class="postsignature postmsg"><hr /><p><a href="http://vfio.blogspot.com" rel="nofollow">http://vfio.blogspot.com</a><br />Looking for a more open forum to discuss vfio related uses?&#160; Try <a href="https://www.redhat.com/mailman/listinfo/vfio-users" rel="nofollow">https://www.redhat.com/mailman/listinfo/vfio-users</a></p></div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1497123">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1497164" class="blockpost roweven"> <h2><span><span class="conr">#3970</span> <a href="viewtopic.php?pid=1497164#p1497164">2015-01-28 01:03:16</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=88345">nikitoss</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2015-01-28</span></dd> <dd><span>Posts: 1</span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <p>Dear friends,<br />After one of the kernel update, as i think, I have a strange problem.<br />Everything works fine, until the drivers are installed (latest version I tried was Catalyst Beta 14.11.2 Beta) after installing the display driver i has reboot loop.</p><p>Windows 8.1 Enterprice<br />Radeon 7970</p><p>supermicro ~ # uname -a<br />Linux supermicro 3.19.0-1-mainline #1 SMP PREEMPT Mon Jan 26 00:18:49 MSK 2015 x86_64 GNU/Linux</p><p>supermicro ~ # lspci |grep -i vga<br />03:00.0 VGA compatible controller: Advanced Micro Devices, Inc. [AMD/ATI] Tahiti XT [Radeon HD 7970/8970 OEM / R9 280X]<br />82:00.0 VGA compatible controller: NVIDIA Corporation GF108 [GeForce GT 620] (rev a1)</p><p>supermicro ~ # cat /proc/cmdline <br />BOOT_IMAGE=/vmlinuz-linux-mainline root=UUID=89c5cccc-bc84-4e48-aa7a-4c2da2c3c0ff rw rootflags=subvol=root_subvolume intel_iommu=on pci-stub.ids=1002:6798,1002:aaa0</p><p>supermicro ~ # cat /etc/modprobe.d/kvm.conf&#160; <br />options kvm ignore_msrs=1<br />options vfio_iommu_type1 allow_unsafe_interrupts=1</p><p>supermicro ~ # zcat /proc/config | grep VFIO<br />CONFIG_VFIO_IOMMU_TYPE1=m<br />CONFIG_VFIO=m<br />CONFIG_VFIO_PCI=m<br />CONFIG_VFIO_PCI_VGA=y<br />CONFIG_VFIO_PCI_MMAP=y<br />CONFIG_VFIO_PCI_INTX=y<br />CONFIG_KVM_VFIO=y</p><p>supermicro ~ # lsmod | grep vfio<br />vfio_iommu_type1&#160; &#160; &#160; &#160;17118&#160; 1 <br />vfio_pci&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;35525&#160; 2 <br />vfio&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;18477&#160; 6 vfio_iommu_type1,vfio_pci</p><p>supermicro ~ # cat /home/nikitos/vm_sources/w8q35/w8.sh <br />/usr/sbin/qemu-system-x86_64 \<br />--enable-kvm -M q35 -cpu host -balloon none \<br />-monitor none -display none -vga none -nographic \<br />-m 4096 -smp 6,sockets=1,cores=6,threads=1 \<br />-bios /usr/share/qemu/bios.bin \<br />-boot menu=on \<br />-device ioh3420,bus=pcie.0,addr=1c.0,multifunction=on,port=1,chassis=1,id=root.1 \<br />-device vfio-pci,host=03:00.0,bus=root.1,addr=00.0,multifunction=on,x-vga=on,rombar=0,romfile=MSI.HD7970.3072.130104.rom \<br />-device vfio-pci,host=03:00.1,bus=root.1,addr=00.1 \<br />-device vfio-pci,host=09:00.0,bus=pcie.0 \<br />-device vfio-pci,host=06:00.1,bus=pcie.0 \<br />-drive file=/images/vdi/w8system0.qcow2,if=virtio,format=qcow2 \<br />-rtc base=localtime</p><p>P.S. Sory for my English</p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1497164">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1497173" class="blockpost rowodd"> <h2><span><span class="conr">#3971</span> <a href="viewtopic.php?pid=1497173#p1497173">2015-01-28 02:20:59</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=75590">aw</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2013-10-04</span></dd> <dd><span>Posts: 921</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=75590">Email</a></span> <span class="website"><a href="http://vfio.blogspot.com/" rel="nofollow">Website</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <p>I&#039;ve seen this more than once now, <em>rombar=0,romfile=/path/to/rom</em> is a bad idea.&#160; What this does is to disable the PCI ROM BAR, but specify via the device a ROM to load.&#160; Sound strange?&#160; It is.&#160; QEMU will then place the ROM into the &quot;genroms&quot; section, which disassociates it from the device.&#160; The ROM then has to go find the device itself, which may be a pretty common thing for it to do, but is really just a pointless exercise imposed by the user.&#160; The <strong>only</strong> time to use rombar=0 with vfio-pci is to disable the device from having a ROM BAR at all.&#160; If you simply pass <em>romfile=/path/to/rom</em> it will override the physical ROM.&#160; There is absolutely no need to both disable the ROM BAR and still provide a ROM.&#160; &lt;/psa&gt;</p> </div> <div class="postsignature postmsg"><hr /><p><a href="http://vfio.blogspot.com" rel="nofollow">http://vfio.blogspot.com</a><br />Looking for a more open forum to discuss vfio related uses?&#160; Try <a href="https://www.redhat.com/mailman/listinfo/vfio-users" rel="nofollow">https://www.redhat.com/mailman/listinfo/vfio-users</a></p></div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1497173">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1497176" class="blockpost roweven"> <h2><span><span class="conr">#3972</span> <a href="viewtopic.php?pid=1497176#p1497176">2015-01-28 02:37:29</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=73933">rman</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>From: United States</span></dd> <dd><span>Registered: 2013-08-08</span></dd> <dd><span>Posts: 14</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=73933">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <p>Just wanted to report an OVMF success story. For awhile, I had been running with a standard VGA passthrough setup, but this weekend I decided to experiment with OVMF following <a href="http://vfio.blogspot.com/2014/08/primary-graphics-assignment-without-vga.html" rel="nofollow">the instructions</a>.</p><p>Works perfectly. Windows 8.1 runs flawlessly in EFI mode with TianoCore. I can now use the stock Arch kernel and I have DRI on the host iGPU. <img src="https://bbs.archlinux.org/img/smilies/smile.png" width="15" height="15" alt="smile" /></p><p>Kernel: 3.18.2-2-ARCH<br />CPU: Intel Core i5-4690<br />Host GPU: Intel HD Graphics 4600<br />Guest GPU: AMD Radeon R7 265 (rebranded HD 7850)</p><p>I will say that this bit,</p><div class="quotebox"><cite>http://vfio.blogspot.com/2014/08/primary-graphics-assignment-without-vga.html wrote:</cite><blockquote><div><p>If you remove the &quot;Graphics&quot; (ie. VNC/Spice) and &quot;Video&quot; (ie. VGA/QXL/Cirrus) devices from the VM, the assigned GPU will be the primary display.</p></div></blockquote></div><p>didn&#039;t work for me; with emulated graphics disabled, the VM ran headless and did not use the attached GPU.</p> </div> <div class="postsignature postmsg"><hr /><p><strong>Laptop:</strong> Lenovo L440, Intel Core i3-4000M, HD Graphics 4600<br /><strong>Desktop:</strong> Intel Core i5-4690, HD Graphics 4600, AMD Radeon R7 265 <em>(KVM VGA passthrough)</em></p></div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1497176">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1497178" class="blockpost rowodd"> <h2><span><span class="conr">#3973</span> <a href="viewtopic.php?pid=1497178#p1497178">2015-01-28 02:41:38</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=75590">aw</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2013-10-04</span></dd> <dd><span>Posts: 921</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=75590">Email</a></span> <span class="website"><a href="http://vfio.blogspot.com/" rel="nofollow">Website</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>rman wrote:</cite><blockquote><div><p>I will say that this bit,</p><div class="quotebox"><cite>http://vfio.blogspot.com/2014/08/primary-graphics-assignment-without-vga.html wrote:</cite><blockquote><div><p>If you remove the &quot;Graphics&quot; (ie. VNC/Spice) and &quot;Video&quot; (ie. VGA/QXL/Cirrus) devices from the VM, the assigned GPU will be the primary display.</p></div></blockquote></div><p>didn&#039;t work for me; with emulated graphics disabled, the VM ran headless and did not use the attached GPU.</p></div></blockquote></div><p>How sure are you that your GPU has a UEFI ROM?&#160; AIUI, AMD GPUs often work as a secondary device regardless of <em>VGA</em> support.&#160; If it&#039;s not running as a primary, it&#039;s possible you might simply have been able to drop x-vga=off and let the driver initialize it w/o VGA.</p> </div> <div class="postsignature postmsg"><hr /><p><a href="http://vfio.blogspot.com" rel="nofollow">http://vfio.blogspot.com</a><br />Looking for a more open forum to discuss vfio related uses?&#160; Try <a href="https://www.redhat.com/mailman/listinfo/vfio-users" rel="nofollow">https://www.redhat.com/mailman/listinfo/vfio-users</a></p></div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1497178">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1497180" class="blockpost roweven"> <h2><span><span class="conr">#3974</span> <a href="viewtopic.php?pid=1497180#p1497180">2015-01-28 02:55:24</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=73933">rman</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>From: United States</span></dd> <dd><span>Registered: 2013-08-08</span></dd> <dd><span>Posts: 14</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=73933">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>aw wrote:</cite><blockquote><div><p>How sure are you that your GPU has a UEFI ROM?</p></div></blockquote></div><p>I just ran your <a href="http://vfio.blogspot.com/2014/08/does-my-graphics-card-rom-support-efi.html" rel="nofollow">rom-parser</a> program and indeed it seems to lack an UEFI ROM, despite being a relatively recent card.</p><div class="codebox"><pre><code>Valid ROM signature found @0h, PCIR offset 22ch PCIR: type 0, vendor: 1002, device: 6819, class: 030000 PCIR: revision 0, vendor revision: f2c Last image</code></pre></div><p>So I&#039;m guessing that the setup works because the card doesn&#039;t need VGA initialization.</p><p><strong>EDIT:</strong> The Radeon card is definitely being used as a secondary graphics card.</p> <p class="postedit"><em>Last edited by rman (2015-01-28 03:06:57)</em></p> </div> <div class="postsignature postmsg"><hr /><p><strong>Laptop:</strong> Lenovo L440, Intel Core i3-4000M, HD Graphics 4600<br /><strong>Desktop:</strong> Intel Core i5-4690, HD Graphics 4600, AMD Radeon R7 265 <em>(KVM VGA passthrough)</em></p></div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1497180">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1497323" class="blockpost rowodd"> <h2><span><span class="conr">#3975</span> <a href="viewtopic.php?pid=1497323#p1497323">2015-01-28 15:01:15</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=84760">Denso</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd class="postavatar"><img src="https://bbs.archlinux.org/img/avatars/84760.png?m=1412533733" width="71" height="80" alt="" /></dd> <dd><span>Registered: 2014-08-30</span></dd> <dd><span>Posts: 179</span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <p>@aw :</p><p>It seems that DMAR issues made it into 3.18.3 too .</p><p>3.18.3 contains 2 IOMMU commits :</p><p>iommu/vt-d: Fix dmar_domain leak in iommu_attach_device<br />iommu/vt-d: Fix an off-by-one bug in __domain_mapping()</p><p>Which one do you think is to blame ?</p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1497323">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div class="postlinksb"> <div class="inbox crumbsplus"> <div class="pagepost"> <p class="pagelink conl"><span class="pages-label">Pages: </span><a rel="prev" class="item1" href="viewtopic.php?id=162768&amp;p=158">Previous</a> <a href="viewtopic.php?id=162768">1</a> <span class="spacer">…</span> <a href="viewtopic.php?id=162768&amp;p=157">157</a> <a href="viewtopic.php?id=162768&amp;p=158">158</a> <strong>159</strong> <a href="viewtopic.php?id=162768&amp;p=160">160</a> <a href="viewtopic.php?id=162768&amp;p=161">161</a> <span class="spacer">…</span> <a href="viewtopic.php?id=162768&amp;p=234">234</a> <a rel="next" href="viewtopic.php?id=162768&amp;p=160">Next</a></p> <p class="postlink conr">Topic closed</p> </div> <ul class="crumbs"> <li><a href="index.php">Index</a></li> <li><span>»&#160;</span><a href="viewforum.php?id=48">Topics Going Nowhere</a></li> <li><span>»&#160;</span><strong><a href="viewtopic.php?id=162768">KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</a></strong></li> </ul> <p class="subscribelink clearb"><a href="misc.php?action=subscribe&amp;tid=162768">Subscribe to this topic</a></p> <div class="clearer"></div> </div> </div> </div> <div id="brdfooter" class="block"> <h2><span>Board footer</span></h2> <div class="box"> <div id="brdfooternav" class="inbox"> <div class="conl"> <form id="qjump" method="get" action="viewforum.php"> <div><label><span>Jump to<br /></span> <select name="id" onchange="window.location=('viewforum.php?id='+this.options[this.selectedIndex].value)"> <optgroup label="Technical Issues and Assistance"> <option value="23">Newbie Corner</option> <option value="17">Installation</option> <option value="22">Kernel &amp; Hardware</option> <option value="18">Applications &amp; Desktop Environments</option> <option value="31">Laptop Issues</option> <option value="8">Networking, Server, and Protection</option> <option value="32">Multimedia and Games</option> <option value="50">System Administration</option> <option value="35">Other Architectures</option> </optgroup> <optgroup label="Arch-centric"> <option value="24">Announcements, Package &amp; Security Advisories</option> <option value="1">Arch Discussion</option> <option value="13">Forum &amp; Wiki discussion</option> </optgroup> <optgroup label="Pacman Upgrades, Packaging &amp; AUR"> <option value="44">Pacman &amp; Package Upgrade Issues</option> <option value="49">[testing] Repo Forum</option> <option value="4">Creating &amp; Modifying Packages</option> <option value="38">AUR Issues, Discussion &amp; PKGBUILD Requests</option> </optgroup> <optgroup label="Contributions &amp; Discussion"> <option value="20">GNU/Linux Discussion</option> <option value="27">Community Contributions</option> <option value="33">Programming &amp; Scripting</option> <option value="30">Other Languages</option> <option value="47">Artwork and Screenshots</option> <option value="42">Try This</option> </optgroup> <optgroup label="/dev/null"> <option value="29">Off-Topic</option> <option value="48" selected="selected">Topics Going Nowhere</option> <option value="36">Dustbin</option> </optgroup> </select></label> <input type="submit" value=" Go " accesskey="g" /> </div> </form> </div> <div class="conr"> <p id="feedlinks"><span class="atom"><a href="extern.php?action=feed&amp;tid=162768&amp;type=atom">Atom topic feed</a></span></p> <p id="poweredby">Powered by <a href="http://fluxbb.org/">FluxBB</a></p> </div> <div class="clearer"></div> </div> </div> </div> </div> <div class="end-box"></div> </div> </body> </html>
