<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"> <html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en" dir="ltr"> <head> <meta http-equiv="Content-Type" content="text/html; charset=utf-8" /> <title>KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9 (Page 30) / Topics Going Nowhere / Arch Linux Forums</title> <link rel="stylesheet" type="text/css" href="style/ArchLinux.css" /> <link rel="canonical" href="viewtopic.php?id=162768&amp;p=30" title="Page 30" /> <link rel="prev" href="viewtopic.php?id=162768&amp;p=29" title="Page 29" /> <link rel="next" href="viewtopic.php?id=162768&amp;p=31" title="Page 31" /> <link rel="alternate" type="application/atom+xml" href="extern.php?action=feed&amp;tid=162768&amp;type=atom" title="Atom topic feed" /> <link rel="stylesheet" media="screen" href="style/ArchLinux/arch.css?v=3" /> <link rel="stylesheet" media="screen" href="style/ArchLinux/archnavbar.css?v=2" /> <link rel="shortcut icon" href="style/ArchLinux/favicon.ico" /> </head> <body> <div id="archnavbar" class="anb-forum"> <div id="archnavbarlogo"><h1><a href="http://www.archlinux.org/">Arch Linux</a></h1></div> <div id="archnavbarmenu"> <ul id="archnavbarlist"> <li id="anb-home"><a href="http://www.archlinux.org/">Home</a></li><li id="anb-packages"><a href="http://www.archlinux.org/packages/">Packages</a></li><li id="anb-forums" class="anb-selected"><a href="https://bbs.archlinux.org/">Forums</a></li><li id="anb-wiki"><a href="https://wiki.archlinux.org/">Wiki</a></li><li id="anb-bugs"><a href="https://bugs.archlinux.org/">Bugs</a></li><li id="anb-aur"><a href="https://aur.archlinux.org/">AUR</a></li><li id="anb-download"><a href="http://www.archlinux.org/download/">Download</a></li> </ul> </div> </div> <div id="punviewtopic" class="pun"> <div class="top-box"></div> <div class="punwrap"> <div id="brdheader" class="block"> <div class="box"> <div id="brdmenu" class="inbox"> <ul> <li id="navindex" class="isactive"><a href="index.php">Index</a></li> <li id="navuserlist"><a href="userlist.php">User list</a></li> <li id="navsearch"><a href="search.php">Search</a></li> <li id="navprofile"><a href="profile.php?id=80749">Profile</a></li> <li id="navlogout"><a href="login.php?action=out&amp;id=80749&amp;csrf_token=5c20501ec397bb45ef8ee8c84db232c8d8e421c6">Logout</a></li> </ul> </div> <div id="brdwelcome" class="inbox"> <ul class="conl"> <li><span>Logged in as <strong>SXX</strong></span></li> <li><span>Last visit: 2015-08-16 12:20:09</span></li> </ul> <ul class="conr"> <li><span>Topics: <a href="search.php?action=show_replies" title="Find topics you have posted to.">Posted</a> | <a href="search.php?action=show_new" title="Find topics with new posts since your last visit.">New</a> | <a href="search.php?action=show_recent" title="Find topics with recent posts.">Active</a> | <a href="search.php?action=show_unanswered" title="Find topics with no replies.">Unanswered</a></span></li> </ul> <div class="clearer"></div> </div> </div> </div> <div id="brdmain"> <div class="linkst"> <div class="inbox crumbsplus"> <ul class="crumbs"> <li><a href="index.php">Index</a></li> <li><span>»&#160;</span><a href="viewforum.php?id=48">Topics Going Nowhere</a></li> <li><span>»&#160;</span><strong><a href="viewtopic.php?id=162768">KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</a></strong></li> </ul> <div class="pagepost"> <p class="pagelink conl"><span class="pages-label">Pages: </span><a rel="prev" class="item1" href="viewtopic.php?id=162768&amp;p=29">Previous</a> <a href="viewtopic.php?id=162768">1</a> <span class="spacer">…</span> <a href="viewtopic.php?id=162768&amp;p=28">28</a> <a href="viewtopic.php?id=162768&amp;p=29">29</a> <strong>30</strong> <a href="viewtopic.php?id=162768&amp;p=31">31</a> <a href="viewtopic.php?id=162768&amp;p=32">32</a> <span class="spacer">…</span> <a href="viewtopic.php?id=162768&amp;p=234">234</a> <a rel="next" href="viewtopic.php?id=162768&amp;p=31">Next</a></p> <p class="postlink conr">Topic closed</p> </div> <div class="clearer"></div> </div> </div> <div id="p1349263" class="blockpost rowodd blockpost1"> <h2><span><span class="conr">#726</span> <a href="viewtopic.php?pid=1349263#p1349263">2013-11-13 21:45:29</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=70922">nbhs</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd class="postavatar"><img src="https://bbs.archlinux.org/img/avatars/70922.jpg?m=1367773811" width="80" height="80" alt="" /></dd> <dd><span>From: Montevideo, Uruguay</span></dd> <dd><span>Registered: 2013-05-02</span></dd> <dd><span>Posts: 402</span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>Val532 wrote:</cite><blockquote><div><p>So i made some test with this methode but no luck. Virt Manager say to me a lot of difrente error.<br />Sometime AppArmor error, sometime connection reset by peer.</p><p>My Hardware is:</p><p>Corei5 4670S so HD4600 for the host<br />24Go ram (3*8Go)<br />Asrock Z87 Extrem 6<br />AMD HD7770 for the first VM<br />AMD HD5570 for the second VM<br />AMD HD5570 fot the third Vm</p><p>All of the graphic card work.</p><p>For the moment i&#039;ve only Windows 7 on the first VM, the seconde and third come later.</p></div></blockquote></div><p>Well try disabling apparmor, you could also use the qemu monitor for your vm&#039;s, launch qemu with -monitor stdio</p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1349263">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1349278" class="blockpost roweven"> <h2><span><span class="conr">#727</span> <a href="viewtopic.php?pid=1349278#p1349278">2013-11-13 22:21:17</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=76566">cryptonymous</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2013-11-05</span></dd> <dd><span>Posts: 6</span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>aw wrote:</cite><blockquote><div><div class="quotebox"><cite>aw wrote:</cite><blockquote><div><p>Testing a Linux guest w/ a GTX660, I can confirm that things go bad when using the NV_RegEnableMSI=1 option.&#160; This worked fine for me with a Quadro card.&#160; I see a single interrupt and the monitor goes out of sync and never comes back after OS bootup.&#160; I&#039;ll try to find some time to dig into it.&#160; I also note that the audio driver specifically checks for nvidia devices and blacklists MSI on snd-hda-intel, so at some point nvidia hasn&#039;t played nicely with Linux MSI support.&#160; Perhaps there&#039;s a reason why the Linux nvidia driver defaults to INTx as well.</p></div></blockquote></div><p>Good news/bad news...</p><p>Good news: I figured out the problem and posted a patch that solves it on my GTX660: <a href="http://lists.nongnu.org/archive/html/qemu-devel/2013-11/msg01390.html" rel="nofollow">http://lists.nongnu.org/archive/html/qe … 01390.html</a></p><p>Bad news: This means that for every MSI interrupt, the Nvidia driver does a write to MMIO space at an offset that QEMU needs to trap in order to &quot;virtualize&quot; the device.&#160; That may negate any performance benefit of MSI vs INTx.&#160; As noted in the patch we might be able to use an ioeventfd to make handling more asynchronous, but the overhead is probably still more than INTx, which we can handle without exiting to QEMU userspace.</p></div></blockquote></div><p>Thanks, &quot;3950205 vfio-pci: Fix Nvidia MSI ACK through 0x88000 quirk&quot; has fixed the interrupt issue on my GTX 650 in OS X guest.</p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1349278">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1349283" class="blockpost rowodd"> <h2><span><span class="conr">#728</span> <a href="viewtopic.php?pid=1349283#p1349283">2013-11-13 22:37:37</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=76834">Val532</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2013-11-13</span></dd> <dd><span>Posts: 35</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=76834">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>nbhs wrote:</cite><blockquote><div><p>Well try disabling apparmor, you could also use the qemu monitor for your vm&#039;s, launch qemu with -monitor stdio</p></div></blockquote></div><p>So i&#039;ve disabled apparmor but it does not slove my problem.</p><p>I&#039;ve tried a lot of differente .xml but some time it does not show in virt manager, sometime it&#039;s say Connection reset by peer (when i put pc-q35-1.7 instead of 440).</p><p>I&#039;m completly lost ^^.</p><p>ps: my .xml</p><div class="quotebox"><blockquote><div><p>&lt;!--<br />WARNING: THIS IS AN AUTO-GENERATED FILE. CHANGES TO IT ARE LIKELY TO BE<br />OVERWRITTEN AND LOST. Changes to this xml configuration should be made using:<br />&#160; virsh edit windows7test<br />or other application using the libvirt API.<br />--&gt;</p><p>&lt;domain type=&#039;kvm&#039; xmlns:qemu=&#039;http://libvirt.org/schemas/domain/qemu/1.0&#039;&gt;<br />&#160; &lt;name&gt;windows7test&lt;/name&gt;<br />&#160; &lt;uuid&gt;79afd66a-f479-8c9c-c66f-2ac53f1c110c&lt;/uuid&gt;<br />&#160; &lt;memory unit=&#039;KiB&#039;&gt;8388608&lt;/memory&gt;<br />&#160; &lt;currentMemory unit=&#039;KiB&#039;&gt;8388608&lt;/currentMemory&gt;<br />&#160; &lt;vcpu placement=&#039;static&#039;&gt;4&lt;/vcpu&gt;<br />&#160; &lt;os&gt;<br />&#160; &#160; &lt;type arch=&#039;x86_64&#039; machine=&#039;pc-q35-1.7&#039;&gt;hvm&lt;/type&gt;<br />&#160; &#160; &lt;boot dev=&#039;hd&#039;/&gt;<br />&#160; &#160; &lt;smbios mode=&#039;host&#039;/&gt;<br />&#160; &lt;/os&gt;<br />&#160; &lt;features&gt;<br />&#160; &#160; &lt;acpi/&gt;<br />&#160; &#160; &lt;apic/&gt;<br />&#160; &#160; &lt;pae/&gt;<br />&#160; &lt;/features&gt;<br />&#160; &lt;cpu mode=&#039;custom&#039; match=&#039;exact&#039;&gt;<br />&#160; &#160; &lt;model fallback=&#039;allow&#039;&gt;Haswell&lt;/model&gt;<br />&#160; &#160; &lt;vendor&gt;Intel&lt;/vendor&gt;<br />&#160; &#160; &lt;feature policy=&#039;require&#039; name=&#039;tm2&#039;/&gt;<br />&#160; &#160; &lt;feature policy=&#039;require&#039; name=&#039;est&#039;/&gt;<br />&#160; &#160; &lt;feature policy=&#039;require&#039; name=&#039;vmx&#039;/&gt;<br />&#160; &#160; &lt;feature policy=&#039;require&#039; name=&#039;osxsave&#039;/&gt;<br />&#160; &#160; &lt;feature policy=&#039;require&#039; name=&#039;smx&#039;/&gt;<br />&#160; &#160; &lt;feature policy=&#039;require&#039; name=&#039;ss&#039;/&gt;<br />&#160; &#160; &lt;feature policy=&#039;require&#039; name=&#039;ds&#039;/&gt;<br />&#160; &#160; &lt;feature policy=&#039;require&#039; name=&#039;vme&#039;/&gt;<br />&#160; &#160; &lt;feature policy=&#039;require&#039; name=&#039;dtes64&#039;/&gt;<br />&#160; &#160; &lt;feature policy=&#039;require&#039; name=&#039;abm&#039;/&gt;<br />&#160; &#160; &lt;feature policy=&#039;require&#039; name=&#039;ht&#039;/&gt;<br />&#160; &#160; &lt;feature policy=&#039;require&#039; name=&#039;acpi&#039;/&gt;<br />&#160; &#160; &lt;feature policy=&#039;require&#039; name=&#039;pbe&#039;/&gt;<br />&#160; &#160; &lt;feature policy=&#039;require&#039; name=&#039;tm&#039;/&gt;<br />&#160; &#160; &lt;feature policy=&#039;require&#039; name=&#039;pdcm&#039;/&gt;<br />&#160; &#160; &lt;feature policy=&#039;require&#039; name=&#039;pdpe1gb&#039;/&gt;<br />&#160; &#160; &lt;feature policy=&#039;require&#039; name=&#039;ds_cpl&#039;/&gt;<br />&#160; &#160; &lt;feature policy=&#039;require&#039; name=&#039;rdrand&#039;/&gt;<br />&#160; &#160; &lt;feature policy=&#039;require&#039; name=&#039;f16c&#039;/&gt;<br />&#160; &#160; &lt;feature policy=&#039;require&#039; name=&#039;xtpr&#039;/&gt;<br />&#160; &#160; &lt;feature policy=&#039;require&#039; name=&#039;monitor&#039;/&gt;<br />&#160; &lt;/cpu&gt;<br />&#160; &lt;clock offset=&#039;localtime&#039;/&gt;<br />&#160; &lt;on_poweroff&gt;destroy&lt;/on_poweroff&gt;<br />&#160; &lt;on_reboot&gt;restart&lt;/on_reboot&gt;<br />&#160; &lt;on_crash&gt;restart&lt;/on_crash&gt;<br />&#160; &lt;devices&gt;<br />&#160; &#160; &lt;emulator&gt;/usr/bin/qemu-system-x86_64&lt;/emulator&gt;<br />&#160; &#160; &lt;disk type=&#039;file&#039; device=&#039;disk&#039;&gt;<br />&#160; &#160; &#160; &lt;driver name=&#039;qemu&#039; type=&#039;qcow2&#039; cache=&#039;writethrough&#039; io=&#039;native&#039;/&gt;<br />&#160; &#160; &#160; &lt;source file=&#039;/home/val/windows2&#039;/&gt;<br />&#160; &#160; &#160; &lt;target dev=&#039;sda&#039; bus=&#039;sata&#039;/&gt;<br />&#160; &#160; &#160; &lt;address type=&#039;drive&#039; controller=&#039;0&#039; bus=&#039;0&#039; target=&#039;0&#039; unit=&#039;0&#039;/&gt;<br />&#160; &#160; &lt;/disk&gt;<br />&#160; &#160; &lt;controller type=&#039;usb&#039; index=&#039;0&#039;&gt;<br />&#160; &#160; &#160; &lt;address type=&#039;pci&#039; domain=&#039;0x0000&#039; bus=&#039;0x00&#039; slot=&#039;0x01&#039; function=&#039;0x2&#039;/&gt;<br />&#160; &#160; &lt;/controller&gt;<br />&#160; &#160; &lt;controller type=&#039;pci&#039; index=&#039;0&#039; model=&#039;pci-root&#039;/&gt;<br />&#160; &#160; &lt;controller type=&#039;sata&#039; index=&#039;0&#039;&gt;<br />&#160; &#160; &#160; &lt;address type=&#039;pci&#039; domain=&#039;0x0000&#039; bus=&#039;0x00&#039; slot=&#039;0x01&#039; function=&#039;0x0&#039;/&gt;<br />&#160; &#160; &lt;/controller&gt;<br />&#160; &#160; &lt;interface type=&#039;bridge&#039;&gt;<br />&#160; &#160; &#160; &lt;mac address=&#039;52:54:00:4c:d9:7a&#039;/&gt;<br />&#160; &#160; &#160; &lt;source bridge=&#039;br0&#039;/&gt;<br />&#160; &#160; &#160; &lt;model type=&#039;e1000&#039;/&gt;<br />&#160; &#160; &#160; &lt;address type=&#039;pci&#039; domain=&#039;0x0000&#039; bus=&#039;0x00&#039; slot=&#039;0x03&#039; function=&#039;0x0&#039;/&gt;<br />&#160; &#160; &lt;/interface&gt;<br />&#160; &#160; &lt;memballoon model=&#039;virtio&#039;&gt;<br />&#160; &#160; &#160; &lt;address type=&#039;pci&#039; domain=&#039;0x0000&#039; bus=&#039;0x00&#039; slot=&#039;0x04&#039; function=&#039;0x0&#039;/&gt;<br />&#160; &#160; &lt;/memballoon&gt;<br />&#160; &lt;/devices&gt;<br />&#160; &lt;qemu:commandline&gt;<br />&#160; &#160; &lt;qemu:arg value=&#039;-device&#039;/&gt;<br />&#160; &#160; &lt;qemu:arg value=&#039;ioh3420,bus=pcie.0,addr=1c.0,multifunction=on,port=1,chassis=1,id=root.1&#039;/&gt;<br />&#160; &#160; &lt;qemu:arg value=&#039;-device&#039;/&gt;<br />&#160; &#160; &lt;qemu:arg value=&#039;vfio-pci,host=03:00.0,bus=root.1,addr=00.0,multifunction=on,x-vga=on&#039;/&gt;<br />&#160; &#160; &lt;qemu:arg value=&#039;-device&#039;/&gt;<br />&#160; &#160; &lt;qemu:arg value=&#039;vfio-pci,host=03:00.1,bus=root.1,addr=00.1&#039;/&gt;<br />&#160; &#160; &lt;qemu:arg value=&#039;-bios&#039;/&gt;<br />&#160; &#160; &lt;qemu:arg value=&#039;/usr/share/qemu/bios.bin&#039;/&gt;<br />&#160; &lt;/qemu:commandline&gt;<br />&lt;/domain&gt;</p></div></blockquote></div> <p class="postedit"><em>Last edited by Val532 (2013-11-13 23:03:54)</em></p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1349283">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1349294" class="blockpost roweven"> <h2><span><span class="conr">#729</span> <a href="viewtopic.php?pid=1349294#p1349294">2013-11-13 23:25:13</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=76479">Norcoen</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>From: Norway</span></dd> <dd><span>Registered: 2013-11-02</span></dd> <dd><span>Posts: 23</span></dd> <dd class="usercontacts"><span class="email"><a href="mailto:frankmoll@gmx.net">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <p>I&#039;m using everything provided in post#1, including startup script, but as soon as I try to pass pci/pcie devices I get this error:</p><div class="codebox"><pre><code>qemu-system-x86_64: -device vfio-pci,host=04:00.0: vfio: error opening /dev/vfio/9: No such file or directory qemu-system-x86_64: -device vfio-pci,host=04:00.0: vfio: failed to get group 9 qemu-system-x86_64: -device vfio-pci,host=04:00.0: Device initialization failed. qemu-system-x86_64: -device vfio-pci,host=04:00.0: Device &#039;vfio-pci&#039; could not be initialized cset: --&gt; deactivating/reseting shielding cset: **&gt; shielding not active on system All Done!!</code></pre></div><p>What does it mean, why does /dev/vfio/9 not exist?<br />What did I do wrong?</p><p>My versions of your scripts:<br />Assign PCI devices to pci-stub</p><div class="codebox"><pre class="vscroll"><code>modprobe pci_stub # 2. onboard Ethernetcontroller/Lankarte echo &quot;8086 1539&quot; &gt; /sys/bus/pci/drivers/pci-stub/new_id echo 0000:04:00.0 &gt; /sys/bus/pci/devices/0000:04:00.0/driver/unbind echo 0000:04:00.0 &gt; /sys/bus/pci/drivers/pci-stub/bind # PCI bridge der PCIe Karte: echo &quot;10b5 8603&quot; &gt; /sys/bus/pci/drivers/pci-stub/new_id echo 0000:06:00.0 &gt; /sys/bus/pci/devices/0000:06:00.0/driver/unbind echo 0000:06:00.0 &gt; /sys/bus/pci/drivers/pci-stub/bind echo 0000:07:01.0 &gt; /sys/bus/pci/devices/0000:07:01.0/driver/unbind echo 0000:07:01.0 &gt; /sys/bus/pci/drivers/pci-stub/bind echo 0000:07:02.0 &gt; /sys/bus/pci/devices/0000:07:02.0/driver/unbind echo 0000:07:02.0 &gt; /sys/bus/pci/drivers/pci-stub/bind # S-ATA Controller PCIe: echo &quot;1b21 0612&quot; &gt; /sys/bus/pci/drivers/pci-stub/new_id echo &quot;1b21 1060&quot; &gt; /sys/bus/pci/drivers/pci-stub/new_id echo 0000:08:00.0 &gt; /sys/bus/pci/devices/0000:08:00.0/driver/unbind echo 0000:08:00.0 &gt; /sys/bus/pci/drivers/pci-stub/bind # USB3 Controller der PCIe Karte: echo &quot;1912 0015&quot; &gt; /sys/bus/pci/drivers/pci-stub/new_id echo 0000:09:00.0 &gt; /sys/bus/pci/devices/0000:09:00.0/driver/unbind echo 0000:09:00.0 &gt; /sys/bus/pci/drivers/pci-stub/bind</code></pre></div><p>Startup Script</p><div class="codebox"><pre class="vscroll"><code>#!/bin/sh CPU_CORE_NR=$(cat /proc/cpuinfo | egrep &quot;core id|physical id&quot; | tr -d &quot;\n&quot; | sed s/physical/\\nphysical/g | grep -v ^$ | sort | uniq | wc -l) QEMU=/home/neocron/qemu-1.6.50/bin/qemu-system-x86_64 CSET=/home/neocron/qemu-git/cpuset-1.5.6/usr/bin/cset VCPUS=&quot;8&quot; #must be &gt; 0 &lt; cpu core number CPU=&quot;Haswell&quot; MEM=&quot;8192&quot; MEM_PATH=&quot;&quot; BIOS=&quot;/home/neocron/qemu-1.6.50/share/qemu/bios.bin&quot; #NET=&quot;-netdev bridge,br=br0,id=hostnet0 -device virtio-net-pci,netdev=hostnet0,id=net0&quot; NET=&quot;&quot; USB_DEVICES=&quot;&quot; #PCI_DEVICES=&quot;00:11.0 04:00.0 05:00.0 06:00.0&quot; PCI_DEVICES=&quot;04:00.0 06:00.0 07:01.0 07:02.0 08:00.0 09:00.0&quot; #PCI_DEVICES=&quot;&quot; GPU=&quot;01:00.0&quot; GPU_SND=&quot;01:00.1&quot; #SND=true SND=false SND_DRIVER_OPTS=&quot;QEMU_AUDIO_DRV=alsa QEMU_ALSA_DAC_BUFFER_SIZE=512 QEMU_ALSA_DAC_PERIOD_SIZE=170&quot; #VBIOS=&quot;/home/neocron/qemu-1.6.50/share/qemu/vgabios-6950.bin&quot; VBIOS=&quot;&quot; CDROM=&quot;/home/neocron/Dokumente/KVM/Win7.SP1.AiO.PreActivated.Multilanguage/Win_7_AiO_Ar-En-Fr-Ge_Pre-Activated.iso&quot; #HDD=&quot;/dev/mapper/vgRaidHDDs-win7ult&quot; HDD=&quot;/media/BigStorage/Temp/windowskvm.img&quot; #HDD=&quot;&quot; QEMU_ARGS=&quot; -M q35 -enable-kvm -monitor stdio&quot; EXTRA_ARGS=&quot;-boot menu=on&quot; if [ -n &quot;$GPU&quot; ]; then EXTRA_ARGS+=&quot; -vga none -nographic&quot; DEV+=&quot; -device ioh3420,bus=pcie.0,addr=1c.0,multifunction=on,port=1,chassis=1,id=root.1&quot; if [ -n &quot;$VBIOS&quot; ]; then DEV+=&quot; -device vfio-pci,host=$GPU,x-vga=on,addr=0.0,multifunction=on,bus=root.1,rombar=0,romfile=$VBIOS&quot; else DEV+=&quot; -device vfio-pci,host=$GPU,x-vga=on,addr=0.0,multifunction=on,bus=root.1&quot; fi if [ -n &quot;$GPU_SND&quot; ]; then DEV+=&quot; -device vfio-pci,host=$GPU_SND,addr=0.1,bus=root.1&quot; fi fi if [ -n &quot;$PCI_DEVICES&quot; ]; then for d in $PCI_DEVICES; do DEV+=&quot; -device vfio-pci,host=$d&quot; done fi if [ -n &quot;$HDD&quot; ] || [ -n &quot;$CDROM&quot; ]; then DEV+=&quot; -device ahci,bus=pcie.0,id=ahci&quot; if [ -n &quot;$HDD&quot; ]; then STORAGE+=&quot; -drive file=$HDD,id=disk,format=raw -device ide-hd,bus=ahci.0,drive=disk&quot; fi if [ -n &quot;$CDROM&quot; ]; then STORAGE+=&quot; -drive file=$CDROM,id=isocd -device ide-cd,bus=ahci.1,drive=isocd&quot; fi fi if [ -n &quot;$CPU&quot; ]; then CPU=&quot;-cpu $CPU -smp $VCPUS,sockets=1,cores=$VCPUS,threads=1&quot; else CPU=&quot;-smp $VCPUS,sockets=1,cores=$VCPUS,threads=1&quot; fi if [ -n &quot;$BIOS&quot; ]; then BIOS=&quot; -bios $BIOS&quot; fi if $SND ; then SND=&quot;-device ich9-intel-hda,bus=pcie.0,addr=1b.0,id=sound0 -device hda-duplex,cad=0&quot; export $SND_DRIVER_OPTS else SND=&quot;&quot; fi if [ -n &quot;$MEM&quot; ]; then MEMORY+=&quot;-m $MEM&quot; if [ -n &quot;$MEM_PATH&quot; ]; then MEMORY+=&quot; -mem-path $MEM_PATH&quot; fi fi if [ -n &quot;$USB_DEVICES&quot; ]; then for u in $USB_DEVICES; do USB_DEV+=&quot; -usbdevice $u&quot; done fi $CSET shield -c $((CPU_CORE_NR-VCPUS))-$((CPU_CORE_NR-1)) set -m $QEMU $BIOS $CPU $MEMORY $QEMU_ARGS $DEV $USB_DEV $NET $SND $STORAGE $EXTRA_ARGS &amp; PID=$! ( while ( (kill -s 0 $PID &gt; /dev/null 2&gt;&amp;1) ); do if [ &quot;$(grep Threads /proc/$PID/status | awk &#039;{print $2}&#039; )&quot; -ge &quot;$((VCPUS+1))&quot; &gt; /dev/null 2&gt;&amp;1 ]; then i=$((CPU_CORE_NR-VCPUS)) for t in `ls /proc/$PID/task/`; do if [ $i -ne $((CPU_CORE_NR)) ]; then if [ $t -ne $PID ];then $CSET shield --shield --pid $t taskset -pc $i $t let i++ fi fi done break fi done ) &amp; fg %1 wait $CSET shield --reset echo &quot;All Done!!&quot;</code></pre></div><p>lspci:</p><div class="codebox"><pre class="vscroll"><code>$ sudo lspci -vnn 00:00.0 Host bridge [0600]: Intel Corporation Xeon E3-1200 v3 Processor DRAM Controller [8086:0c08] (rev 06) Subsystem: ASRock Incorporation Device [1849:0c08] Flags: bus master, fast devsel, latency 0 Capabilities: [e0] Vendor Specific Information: Len=0c &lt;?&gt; 00:01.0 PCI bridge [0604]: Intel Corporation Xeon E3-1200 v3/4th Gen Core Processor PCI Express x16 Controller [8086:0c01] (rev 06) (prog-if 00 [Normal decode]) Flags: bus master, fast devsel, latency 0 Bus: primary=00, secondary=01, subordinate=01, sec-latency=0 I/O behind bridge: 0000e000-0000efff Memory behind bridge: e0000000-f00fffff Capabilities: [88] Subsystem: ASRock Incorporation Device [1849:0c01] Capabilities: [80] Power Management version 3 Capabilities: [90] MSI: Enable+ Count=1/1 Maskable- 64bit- Capabilities: [a0] Express Root Port (Slot+), MSI 00 Capabilities: [100] Virtual Channel Capabilities: [140] Root Complex Link Capabilities: [d94] #19 Kernel driver in use: pcieport 00:02.0 VGA compatible controller [0300]: Intel Corporation Xeon E3-1200 v3 Processor Integrated Graphics Controller [8086:041a] (rev 06) (prog-if 00 [VGA controller]) Subsystem: ASRock Incorporation Device [1849:041a] Flags: bus master, fast devsel, latency 0, IRQ 59 Memory at f0400000 (64-bit, non-prefetchable) [size=4M] Memory at d0000000 (64-bit, prefetchable) [size=256M] I/O ports at f000 [size=64] Expansion ROM at &lt;unassigned&gt; [disabled] Capabilities: [90] MSI: Enable+ Count=1/1 Maskable- 64bit- Capabilities: [d0] Power Management version 2 Capabilities: [a4] PCI Advanced Features Kernel driver in use: i915 00:03.0 Audio device [0403]: Intel Corporation Xeon E3-1200 v3/4th Gen Core Processor HD Audio Controller [8086:0c0c] (rev 06) Subsystem: ASRock Incorporation Device [1849:0c0c] Flags: bus master, fast devsel, latency 0, IRQ 67 Memory at f0e34000 (64-bit, non-prefetchable) [size=16K] Capabilities: [50] Power Management version 2 Capabilities: [60] MSI: Enable+ Count=1/1 Maskable- 64bit- Capabilities: [70] Express Root Complex Integrated Endpoint, MSI 00 Kernel driver in use: snd_hda_intel 00:14.0 USB controller [0c03]: Intel Corporation 8 Series/C220 Series Chipset Family USB xHCI [8086:8c31] (rev 05) (prog-if 30 [XHCI]) Subsystem: ASRock Incorporation Device [1849:8c31] Flags: bus master, medium devsel, latency 0, IRQ 50 Memory at f0e20000 (64-bit, non-prefetchable) [size=64K] Capabilities: [70] Power Management version 2 Capabilities: [80] MSI: Enable+ Count=1/8 Maskable- 64bit+ Kernel driver in use: xhci_hcd 00:16.0 Communication controller [0780]: Intel Corporation 8 Series/C220 Series Chipset Family MEI Controller #1 [8086:8c3a] (rev 04) Subsystem: ASRock Incorporation Device [1849:8c3a] Flags: bus master, fast devsel, latency 0, IRQ 60 Memory at f0e3f000 (64-bit, non-prefetchable) [size=16] Capabilities: [50] Power Management version 3 Capabilities: [8c] MSI: Enable+ Count=1/1 Maskable- 64bit+ Kernel driver in use: mei_me 00:19.0 Ethernet controller [0200]: Intel Corporation Ethernet Connection I217-V [8086:153b] (rev 05) Subsystem: ASRock Incorporation Device [1849:153b] Flags: bus master, fast devsel, latency 0, IRQ 66 Memory at f0e00000 (32-bit, non-prefetchable) [size=128K] Memory at f0e3d000 (32-bit, non-prefetchable) [size=4K] I/O ports at f080 [disabled] [size=32] Capabilities: [c8] Power Management version 2 Capabilities: [d0] MSI: Enable+ Count=1/1 Maskable- 64bit+ Capabilities: [e0] PCI Advanced Features Kernel driver in use: e1000e 00:1a.0 USB controller [0c03]: Intel Corporation 8 Series/C220 Series Chipset Family USB EHCI #2 [8086:8c2d] (rev 05) (prog-if 20 [EHCI]) Subsystem: ASRock Incorporation Device [1849:8c2d] Flags: bus master, medium devsel, latency 0, IRQ 16 Memory at f0e3c000 (32-bit, non-prefetchable) [size=1K] Capabilities: [50] Power Management version 2 Capabilities: [58] Debug port: BAR=1 offset=00a0 Capabilities: [98] PCI Advanced Features Kernel driver in use: ehci-pci 00:1b.0 Audio device [0403]: Intel Corporation 8 Series/C220 Series Chipset High Definition Audio Controller [8086:8c20] (rev 05) Subsystem: ASRock Incorporation Device [1849:1151] Flags: bus master, fast devsel, latency 0, IRQ 68 Memory at f0e30000 (64-bit, non-prefetchable) [size=16K] Capabilities: [50] Power Management version 2 Capabilities: [60] MSI: Enable+ Count=1/1 Maskable- 64bit+ Capabilities: [70] Express Root Complex Integrated Endpoint, MSI 00 Capabilities: [100] Virtual Channel Kernel driver in use: snd_hda_intel 00:1c.0 PCI bridge [0604]: Intel Corporation 8 Series/C220 Series Chipset Family PCI Express Root Port #1 [8086:8c10] (rev d5) (prog-if 00 [Normal decode]) Flags: bus master, fast devsel, latency 0 Bus: primary=00, secondary=02, subordinate=02, sec-latency=0 Capabilities: [40] Express Root Port (Slot-), MSI 00 Capabilities: [80] MSI: Enable- Count=1/1 Maskable- 64bit- Capabilities: [90] Subsystem: ASRock Incorporation Device [1849:8c10] Capabilities: [a0] Power Management version 3 Kernel driver in use: pcieport 00:1c.2 PCI bridge [0604]: Intel Corporation 8 Series/C220 Series Chipset Family PCI Express Root Port #3 [8086:8c14] (rev d5) (prog-if 00 [Normal decode]) Flags: bus master, fast devsel, latency 0 Bus: primary=00, secondary=03, subordinate=03, sec-latency=0 I/O behind bridge: 0000d000-0000dfff Memory behind bridge: f0d00000-f0dfffff Capabilities: [40] Express Root Port (Slot+), MSI 00 Capabilities: [80] MSI: Enable- Count=1/1 Maskable- 64bit- Capabilities: [90] Subsystem: ASRock Incorporation Device [1849:8c14] Capabilities: [a0] Power Management version 3 Kernel driver in use: pcieport 00:1c.3 PCI bridge [0604]: Intel Corporation 8 Series/C220 Series Chipset Family PCI Express Root Port #4 [8086:8c16] (rev d5) (prog-if 00 [Normal decode]) Flags: bus master, fast devsel, latency 0 Bus: primary=00, secondary=04, subordinate=04, sec-latency=0 I/O behind bridge: 0000c000-0000cfff Memory behind bridge: f0c00000-f0cfffff Capabilities: [40] Express Root Port (Slot+), MSI 00 Capabilities: [80] MSI: Enable- Count=1/1 Maskable- 64bit- Capabilities: [90] Subsystem: ASRock Incorporation Device [1849:8c16] Capabilities: [a0] Power Management version 3 Kernel driver in use: pcieport 00:1c.4 PCI bridge [0604]: Intel Corporation 8 Series/C220 Series Chipset Family PCI Express Root Port #5 [8086:8c18] (rev d5) (prog-if 00 [Normal decode]) Flags: bus master, fast devsel, latency 0 Bus: primary=00, secondary=05, subordinate=05, sec-latency=0 I/O behind bridge: 0000b000-0000bfff Memory behind bridge: f0b00000-f0bfffff Capabilities: [40] Express Root Port (Slot+), MSI 00 Capabilities: [80] MSI: Enable- Count=1/1 Maskable- 64bit- Capabilities: [90] Subsystem: ASRock Incorporation Device [1849:8c18] Capabilities: [a0] Power Management version 3 Kernel driver in use: pcieport 00:1c.5 PCI bridge [0604]: Intel Corporation 8 Series/C220 Series Chipset Family PCI Express Root Port #6 [8086:8c1a] (rev d5) (prog-if 00 [Normal decode]) Flags: bus master, fast devsel, latency 0 Bus: primary=00, secondary=06, subordinate=09, sec-latency=0 I/O behind bridge: 0000a000-0000afff Memory behind bridge: f0800000-f0afffff Prefetchable memory behind bridge: 00000000cfa00000-00000000cfbfffff Capabilities: [40] Express Root Port (Slot+), MSI 00 Capabilities: [80] MSI: Enable- Count=1/1 Maskable- 64bit- Capabilities: [90] Subsystem: ASRock Incorporation Device [1849:8c1a] Capabilities: [a0] Power Management version 3 Kernel driver in use: pcieport 00:1d.0 USB controller [0c03]: Intel Corporation 8 Series/C220 Series Chipset Family USB EHCI #1 [8086:8c26] (rev 05) (prog-if 20 [EHCI]) Subsystem: ASRock Incorporation Device [1849:8c26] Flags: bus master, medium devsel, latency 0, IRQ 23 Memory at f0e3b000 (32-bit, non-prefetchable) [size=1K] Capabilities: [50] Power Management version 2 Capabilities: [58] Debug port: BAR=1 offset=00a0 Capabilities: [98] PCI Advanced Features Kernel driver in use: ehci-pci 00:1f.0 ISA bridge [0601]: Intel Corporation Z87 Express LPC Controller [8086:8c44] (rev 05) Subsystem: ASRock Incorporation Device [1849:8c44] Flags: bus master, medium devsel, latency 0 Capabilities: [e0] Vendor Specific Information: Len=0c &lt;?&gt; Kernel driver in use: lpc_ich 00:1f.2 SATA controller [0106]: Intel Corporation 8 Series/C220 Series Chipset Family 6-port SATA Controller 1 [AHCI mode] [8086:8c02] (rev 05) (prog-if 01 [AHCI 1.0]) Subsystem: ASRock Incorporation Device [1849:8c02] Flags: bus master, 66MHz, medium devsel, latency 0, IRQ 46 I/O ports at f0d0 [size=8] I/O ports at f0c0 [size=4] I/O ports at f0b0 [size=8] I/O ports at f0a0 [size=4] I/O ports at f060 [size=32] Memory at f0e3a000 (32-bit, non-prefetchable) [size=2K] Capabilities: [80] MSI: Enable+ Count=1/1 Maskable- 64bit- Capabilities: [70] Power Management version 3 Capabilities: [a8] SATA HBA v1.0 Kernel driver in use: ahci 00:1f.3 SMBus [0c05]: Intel Corporation 8 Series/C220 Series Chipset Family SMBus Controller [8086:8c22] (rev 05) Subsystem: ASRock Incorporation Device [1849:8c22] Flags: medium devsel, IRQ 18 Memory at f0e39000 (64-bit, non-prefetchable) [size=256] I/O ports at f040 [size=32] 01:00.0 VGA compatible controller [0300]: Advanced Micro Devices, Inc. [AMD/ATI] Pitcairn PRO [Radeon HD 7850] [1002:6819] (prog-if 00 [VGA controller]) Subsystem: Gigabyte Technology Co., Ltd Device [1458:2553] Flags: fast devsel, IRQ 16 Memory at e0000000 (64-bit, prefetchable) [size=256M] Memory at f0000000 (64-bit, non-prefetchable) [size=256K] I/O ports at e000 [size=256] Expansion ROM at f0040000 [disabled] [size=128K] Capabilities: [48] Vendor Specific Information: Len=08 &lt;?&gt; Capabilities: [50] Power Management version 3 Capabilities: [58] Express Legacy Endpoint, MSI 00 Capabilities: [a0] MSI: Enable- Count=1/1 Maskable- 64bit+ Capabilities: [100] Vendor Specific Information: ID=0001 Rev=1 Len=010 &lt;?&gt; Capabilities: [150] Advanced Error Reporting Capabilities: [270] #19 Capabilities: [2b0] Address Translation Service (ATS) Capabilities: [2c0] #13 Capabilities: [2d0] #1b Kernel driver in use: vfio-pci 01:00.1 Audio device [0403]: Advanced Micro Devices, Inc. [AMD/ATI] Cape Verde/Pitcairn HDMI Audio [Radeon HD 7700/7800 Series] [1002:aab0] Subsystem: Gigabyte Technology Co., Ltd Device [1458:aab0] Flags: fast devsel, IRQ 17 Memory at f0060000 (64-bit, non-prefetchable) [size=16K] Capabilities: [48] Vendor Specific Information: Len=08 &lt;?&gt; Capabilities: [50] Power Management version 3 Capabilities: [58] Express Legacy Endpoint, MSI 00 Capabilities: [a0] MSI: Enable- Count=1/1 Maskable- 64bit+ Capabilities: [100] Vendor Specific Information: ID=0001 Rev=1 Len=010 &lt;?&gt; Capabilities: [150] Advanced Error Reporting Kernel driver in use: vfio-pci 03:00.0 SATA controller [0106]: ASMedia Technology Inc. ASM1062 Serial ATA Controller [1b21:0612] (rev 01) (prog-if 01 [AHCI 1.0]) Subsystem: ASRock Incorporation Motherboard [1849:0612] Flags: bus master, fast devsel, latency 0, IRQ 47 I/O ports at d050 [size=8] I/O ports at d040 [size=4] I/O ports at d030 [size=8] I/O ports at d020 [size=4] I/O ports at d000 [size=32] Memory at f0d00000 (32-bit, non-prefetchable) [size=512] Capabilities: [50] MSI: Enable+ Count=1/1 Maskable- 64bit- Capabilities: [78] Power Management version 3 Capabilities: [80] Express Legacy Endpoint, MSI 00 Capabilities: [100] Virtual Channel Kernel driver in use: ahci 04:00.0 Ethernet controller [0200]: Intel Corporation I211 Gigabit Network Connection [8086:1539] (rev 03) Subsystem: ASRock Incorporation Device [1849:1539] Flags: fast devsel, IRQ 19 Memory at f0c00000 (32-bit, non-prefetchable) [size=128K] I/O ports at c000 [disabled] [size=32] Memory at f0c20000 (32-bit, non-prefetchable) [size=16K] Capabilities: [40] Power Management version 3 Capabilities: [50] MSI: Enable- Count=1/1 Maskable+ 64bit+ Capabilities: [70] MSI-X: Enable- Count=5 Masked- Capabilities: [a0] Express Endpoint, MSI 00 Capabilities: [100] Advanced Error Reporting Capabilities: [140] Device Serial Number bc-5f-f4-ff-ff-cd-17-77 Capabilities: [1a0] Transaction Processing Hints Kernel driver in use: pci-stub 05:00.0 SATA controller [0106]: ASMedia Technology Inc. ASM1062 Serial ATA Controller [1b21:0612] (rev 01) (prog-if 01 [AHCI 1.0]) Subsystem: ASRock Incorporation Motherboard [1849:0612] Flags: bus master, fast devsel, latency 0, IRQ 48 I/O ports at b050 [size=8] I/O ports at b040 [size=4] I/O ports at b030 [size=8] I/O ports at b020 [size=4] I/O ports at b000 [size=32] Memory at f0b00000 (32-bit, non-prefetchable) [size=512] Capabilities: [50] MSI: Enable+ Count=1/1 Maskable- 64bit- Capabilities: [78] Power Management version 3 Capabilities: [80] Express Legacy Endpoint, MSI 00 Capabilities: [100] Virtual Channel Kernel driver in use: ahci 06:00.0 PCI bridge [0604]: PLX Technology, Inc. Device [10b5:8603] (rev aa) (prog-if 00 [Normal decode]) Flags: fast devsel Memory at f0a00000 (32-bit, non-prefetchable) [size=16K] Bus: primary=06, secondary=07, subordinate=09, sec-latency=0 I/O behind bridge: 0000a000-0000afff Memory behind bridge: f0800000-f09fffff Prefetchable memory behind bridge: 00000000cfa00000-00000000cfbfffff Capabilities: [40] Power Management version 3 Capabilities: [48] MSI: Enable- Count=1/4 Maskable+ 64bit+ Capabilities: [68] Express Upstream Port, MSI 00 Capabilities: [a4] Subsystem: PLX Technology, Inc. Device [10b5:8603] Capabilities: [100] Device Serial Number aa-86-02-10-b5-df-0e-00 Capabilities: [fb4] Advanced Error Reporting Capabilities: [138] Power Budgeting &lt;?&gt; Capabilities: [148] Virtual Channel Capabilities: [950] Vendor Specific Information: ID=0001 Rev=0 Len=028 &lt;?&gt; Kernel driver in use: pci-stub 07:01.0 PCI bridge [0604]: PLX Technology, Inc. Device [10b5:8603] (rev aa) (prog-if 00 [Normal decode]) Flags: fast devsel Bus: primary=07, secondary=08, subordinate=08, sec-latency=0 I/O behind bridge: 0000a000-0000afff Memory behind bridge: f0900000-f09fffff Prefetchable memory behind bridge: 00000000cfa00000-00000000cfbfffff Capabilities: [40] Power Management version 3 Capabilities: [48] MSI: Enable- Count=1/4 Maskable+ 64bit+ Capabilities: [68] Express Downstream Port (Slot+), MSI 00 Capabilities: [a4] Subsystem: PLX Technology, Inc. Device [10b5:8603] Capabilities: [100] Device Serial Number aa-86-02-10-b5-df-0e-00 Capabilities: [fb4] Advanced Error Reporting Capabilities: [148] Virtual Channel Capabilities: [520] Access Control Services Capabilities: [950] Vendor Specific Information: ID=0001 Rev=0 Len=028 &lt;?&gt; Kernel driver in use: pci-stub 07:02.0 PCI bridge [0604]: PLX Technology, Inc. Device [10b5:8603] (rev aa) (prog-if 00 [Normal decode]) Flags: fast devsel Bus: primary=07, secondary=09, subordinate=09, sec-latency=0 Memory behind bridge: f0800000-f08fffff Capabilities: [40] Power Management version 3 Capabilities: [48] MSI: Enable- Count=1/4 Maskable+ 64bit+ Capabilities: [68] Express Downstream Port (Slot+), MSI 00 Capabilities: [a4] Subsystem: PLX Technology, Inc. Device [10b5:8603] Capabilities: [100] Device Serial Number aa-86-02-10-b5-df-0e-00 Capabilities: [fb4] Advanced Error Reporting Capabilities: [148] Virtual Channel Capabilities: [520] Access Control Services Capabilities: [950] Vendor Specific Information: ID=0001 Rev=0 Len=028 &lt;?&gt; Kernel driver in use: pci-stub 08:00.0 SATA controller [0106]: ASMedia Technology Inc. ASM1062 Serial ATA Controller [1b21:0612] (rev 01) (prog-if 01 [AHCI 1.0]) Subsystem: ASMedia Technology Inc. Device [1b21:1060] Flags: fast devsel, IRQ 18 I/O ports at a050 [size=8] I/O ports at a040 [size=4] I/O ports at a030 [size=8] I/O ports at a020 [size=4] I/O ports at a000 [size=32] Memory at f0910000 (32-bit, non-prefetchable) [size=512] Expansion ROM at f0900000 [disabled] [size=64K] Capabilities: [50] MSI: Enable- Count=1/1 Maskable- 64bit- Capabilities: [78] Power Management version 3 Capabilities: [80] Express Legacy Endpoint, MSI 00 Capabilities: [100] Virtual Channel Kernel driver in use: pci-stub 09:00.0 USB controller [0c03]: Renesas Technology Corp. uPD720202 USB 3.0 Host Controller [1912:0015] (rev 02) (prog-if 30 [XHCI]) Subsystem: Renesas Technology Corp. uPD720202 USB 3.0 Host Controller [1912:0015] Flags: fast devsel, IRQ 19 Memory at f0800000 (64-bit, non-prefetchable) [size=8K] Capabilities: [50] Power Management version 3 Capabilities: [70] MSI: Enable- Count=1/8 Maskable- 64bit+ Capabilities: [90] MSI-X: Enable- Count=8 Masked- Capabilities: [a0] Express Endpoint, MSI 00 Capabilities: [100] Advanced Error Reporting Capabilities: [150] Latency Tolerance Reporting Kernel driver in use: pci-stub</code></pre></div> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1349294">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1349295" class="blockpost rowodd"> <h2><span><span class="conr">#730</span> <a href="viewtopic.php?pid=1349295#p1349295">2013-11-13 23:29:16</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=70922">nbhs</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd class="postavatar"><img src="https://bbs.archlinux.org/img/avatars/70922.jpg?m=1367773811" width="80" height="80" alt="" /></dd> <dd><span>From: Montevideo, Uruguay</span></dd> <dd><span>Registered: 2013-05-02</span></dd> <dd><span>Posts: 402</span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>Norcoen wrote:</cite><blockquote><div><p>...<br />Assign PCI devices to pci-stub<br />...</p></div></blockquote></div><p>You have to assign your devices to vfio-pci not pci-stub</p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1349295">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1349298" class="blockpost roweven"> <h2><span><span class="conr">#731</span> <a href="viewtopic.php?pid=1349298#p1349298">2013-11-13 23:33:14</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=75590">aw</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2013-10-04</span></dd> <dd><span>Posts: 921</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=75590">Email</a></span> <span class="website"><a href="http://vfio.blogspot.com/" rel="nofollow">Website</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>nbhs wrote:</cite><blockquote><div><div class="quotebox"><cite>Norcoen wrote:</cite><blockquote><div><p>...<br />Assign PCI devices to pci-stub<br />...</p></div></blockquote></div><p>You have to assign your devices to vfio-pci not pci-stub</p></div></blockquote></div><p>And do not bind bridges to anything, leave them attached to pcieport.&#160; Maybe start with something simple, like one device instead of practically everything in the box.</p> </div> <div class="postsignature postmsg"><hr /><p><a href="http://vfio.blogspot.com" rel="nofollow">http://vfio.blogspot.com</a><br />Looking for a more open forum to discuss vfio related uses?&#160; Try <a href="https://www.redhat.com/mailman/listinfo/vfio-users" rel="nofollow">https://www.redhat.com/mailman/listinfo/vfio-users</a></p></div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1349298">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1349300" class="blockpost rowodd"> <h2><span><span class="conr">#732</span> <a href="viewtopic.php?pid=1349300#p1349300">2013-11-13 23:36:17</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=76766">mafferri</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2013-11-11</span></dd> <dd><span>Posts: 7</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=76766">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>aw wrote:</cite><blockquote><div><div class="quotebox"><cite>mafferri wrote:</cite><blockquote><div><p>quoto this because I wish I could do the reverse, for when I shutdown the vm<br />because if I restart the vm I have very bad performance<br />I have to reboot the host because everything works well</p></div></blockquote></div><p>You can do the reverse.&#160; Here are the scripts I use:</p><p>vfio-group &lt;group #&gt;:</p><div class="codebox"><pre class="vscroll"><code>#!/bin/sh if [ ! -e /sys/kernel/iommu_groups/$1 ]; then echo &quot;IOMMU group $1 not found&quot; exit 1 fi if [ ! -e /sys/bus/pci/drivers/vfio-pci ]; then sudo modprobe vfio-pci fi for i in $(ls /sys/kernel/iommu_groups/$1/devices/); do if [ -e /sys/kernel/iommu_groups/$1/devices/$i/driver ]; then if [ &quot;$(basename $(readlink -f \ /sys/kernel/iommu_groups/$1/devices/$i/driver))&quot; != \ &quot;pcieport&quot; ]; then echo $i | sudo tee \ /sys/kernel/iommu_groups/$1/devices/$i/driver/unbind fi fi done for i in $(ls /sys/kernel/iommu_groups/$1/devices/); do if [ ! -e /sys/kernel/iommu_groups/$1/devices/$i/driver ]; then VEN=$(cat /sys/kernel/iommu_groups/$1/devices/$i/vendor) DEV=$(cat /sys/kernel/iommu_groups/$1/devices/$i/device) echo $VEN $DEV | sudo tee \ /sys/bus/pci/drivers/vfio-pci/new_id fi done</code></pre></div><p>vfio-ungroup &lt;group #&gt;</p><div class="codebox"><pre><code>#!/bin/sh if [ ! -e /sys/kernel/iommu_groups/$1 ]; then echo &quot;IOMMU group $1 not found&quot; exit 1 fi for i in $(ls /sys/kernel/iommu_groups/$1/devices/); do VEN=$(cat /sys/kernel/iommu_groups/$1/devices/$i/vendor) DEV=$(cat /sys/kernel/iommu_groups/$1/devices/$i/device) echo $VEN $DEV | sudo tee \ /sys/bus/pci/drivers/vfio-pci/remove_id echo $i | sudo tee \ /sys/kernel/iommu_groups/$1/devices/$i/driver/unbind done for i in $(ls /sys/kernel/iommu_groups/$1/devices/); do echo $i | sudo tee /sys/bus/pci/drivers_probe done</code></pre></div><p>lsgroup</p><div class="codebox"><pre><code>#!/bin/sh BASE=&quot;/sys/kernel/iommu_groups&quot; for i in $(find $BASE -maxdepth 1 -mindepth 1 -type d); do GROUP=$(basename $i) echo &quot;### Group $GROUP ###&quot; for j in $(find $i/devices -type l); do DEV=$(basename $j) echo -n &quot; &quot; lspci -s $DEV done done</code></pre></div><p>I&#039;m not sure how this is going to help your performance though, it&#039;s pretty random whether re-loading the host driver is going to resolve anything that the guest driver can&#039;t.&#160; For graphics devices, if you&#039;re using kernel+qemu that support bus reset, that should provide something nearly as good as a host reboot.</p></div></blockquote></div><p>much more convenient to handle thanks;)</p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1349300">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1349302" class="blockpost roweven"> <h2><span><span class="conr">#733</span> <a href="viewtopic.php?pid=1349302#p1349302">2013-11-13 23:50:53</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=76479">Norcoen</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>From: Norway</span></dd> <dd><span>Registered: 2013-11-02</span></dd> <dd><span>Posts: 23</span></dd> <dd class="usercontacts"><span class="email"><a href="mailto:frankmoll@gmx.net">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <p>Thank you for your insanely fast reply <img src="https://bbs.archlinux.org/img/smilies/smile.png" width="15" height="15" alt="smile" /><br />I didn&#039;t thought about it when I used pci-stub because I always used it with virt-manager before trying vfio...</p><p>I&#039;m getting this error now:</p><div class="codebox"><pre><code>qemu-system-x86_64: -device vfio-pci,host=04:00.0: vfio: error, group 9 is not viable, please ensure all devices within the iommu_group are bound to their vfio bus driver. qemu-system-x86_64: -device vfio-pci,host=04:00.0: vfio: failed to get group 9 qemu-system-x86_64: -device vfio-pci,host=04:00.0: Device initialization failed. qemu-system-x86_64: -device vfio-pci,host=04:00.0: Device &#039;vfio-pci&#039; could not be initialized</code></pre></div><p>Using the lsgroup script you just posted I got this:</p><div class="codebox"><pre class="vscroll"><code>$ ./lsgroup.sh ### Group 0 ### 00:00.0 Host bridge: Intel Corporation Xeon E3-1200 v3 Processor DRAM Controller (rev 06) ### Group 1 ### 00:01.0 PCI bridge: Intel Corporation Xeon E3-1200 v3/4th Gen Core Processor PCI Express x16 Controller (rev 06) 01:00.0 VGA compatible controller: Advanced Micro Devices, Inc. [AMD/ATI] Pitcairn PRO [Radeon HD 7850] 01:00.1 Audio device: Advanced Micro Devices, Inc. [AMD/ATI] Cape Verde/Pitcairn HDMI Audio [Radeon HD 7700/7800 Series] ### Group 2 ### 00:02.0 VGA compatible controller: Intel Corporation Xeon E3-1200 v3 Processor Integrated Graphics Controller (rev 06) ### Group 3 ### 00:03.0 Audio device: Intel Corporation Xeon E3-1200 v3/4th Gen Core Processor HD Audio Controller (rev 06) ### Group 4 ### 00:14.0 USB controller: Intel Corporation 8 Series/C220 Series Chipset Family USB xHCI (rev 05) ### Group 5 ### 00:16.0 Communication controller: Intel Corporation 8 Series/C220 Series Chipset Family MEI Controller #1 (rev 04) ### Group 6 ### 00:19.0 Ethernet controller: Intel Corporation Ethernet Connection I217-V (rev 05) ### Group 7 ### 00:1a.0 USB controller: Intel Corporation 8 Series/C220 Series Chipset Family USB EHCI #2 (rev 05) ### Group 8 ### 00:1b.0 Audio device: Intel Corporation 8 Series/C220 Series Chipset High Definition Audio Controller (rev 05) ### Group 9 ### 00:1c.0 PCI bridge: Intel Corporation 8 Series/C220 Series Chipset Family PCI Express Root Port #1 (rev d5) 00:1c.2 PCI bridge: Intel Corporation 8 Series/C220 Series Chipset Family PCI Express Root Port #3 (rev d5) 00:1c.3 PCI bridge: Intel Corporation 8 Series/C220 Series Chipset Family PCI Express Root Port #4 (rev d5) 00:1c.4 PCI bridge: Intel Corporation 8 Series/C220 Series Chipset Family PCI Express Root Port #5 (rev d5) 00:1c.5 PCI bridge: Intel Corporation 8 Series/C220 Series Chipset Family PCI Express Root Port #6 (rev d5) 03:00.0 SATA controller: ASMedia Technology Inc. ASM1062 Serial ATA Controller (rev 01) 04:00.0 Ethernet controller: Intel Corporation I211 Gigabit Network Connection (rev 03) 05:00.0 SATA controller: ASMedia Technology Inc. ASM1062 Serial ATA Controller (rev 01) 06:00.0 PCI bridge: PLX Technology, Inc. Device 8603 (rev aa) 07:01.0 PCI bridge: PLX Technology, Inc. Device 8603 (rev aa) 07:02.0 PCI bridge: PLX Technology, Inc. Device 8603 (rev aa) 08:00.0 SATA controller: ASMedia Technology Inc. ASM1062 Serial ATA Controller (rev 01) 09:00.0 USB controller: Renesas Technology Corp. uPD720202 USB 3.0 Host Controller (rev 02) ### Group 10 ### 00:1d.0 USB controller: Intel Corporation 8 Series/C220 Series Chipset Family USB EHCI #1 (rev 05) ### Group 11 ### 00:1f.0 ISA bridge: Intel Corporation Z87 Express LPC Controller (rev 05) 00:1f.2 SATA controller: Intel Corporation 8 Series/C220 Series Chipset Family 6-port SATA Controller 1 [AHCI mode] (rev 05) 00:1f.3 SMBus: Intel Corporation 8 Series/C220 Series Chipset Family SMBus Controller (rev 05)</code></pre></div><p>Why is there so much in group 9? From what I know, I can only passthrough complete groups.<br />But why would my PCIe Card be in the same group as a whole lot of onboard stuff?<br />Or is this the same problem as I had some pages back, because the PCIe Card has the same vendor:device ids as the onboard asmedia chip? (I think vfio-bind.sh automaticly gets them)</p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1349302">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1349304" class="blockpost rowodd"> <h2><span><span class="conr">#734</span> <a href="viewtopic.php?pid=1349304#p1349304">2013-11-14 00:05:01</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=70922">nbhs</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd class="postavatar"><img src="https://bbs.archlinux.org/img/avatars/70922.jpg?m=1367773811" width="80" height="80" alt="" /></dd> <dd><span>From: Montevideo, Uruguay</span></dd> <dd><span>Registered: 2013-05-02</span></dd> <dd><span>Posts: 402</span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>Norcoen wrote:</cite><blockquote><div><p>Thank you for your insanely fast reply <img src="https://bbs.archlinux.org/img/smilies/smile.png" width="15" height="15" alt="smile" /><br />I didn&#039;t thought about it when I used pci-stub because I always used it with virt-manager before trying vfio...</p><p>I&#039;m getting this error now:</p><div class="codebox"><pre><code>qemu-system-x86_64: -device vfio-pci,host=04:00.0: vfio: error, group 9 is not viable, please ensure all devices within the iommu_group are bound to their vfio bus driver. qemu-system-x86_64: -device vfio-pci,host=04:00.0: vfio: failed to get group 9 qemu-system-x86_64: -device vfio-pci,host=04:00.0: Device initialization failed. qemu-system-x86_64: -device vfio-pci,host=04:00.0: Device &#039;vfio-pci&#039; could not be initialized</code></pre></div><p>Using the lsgroup script you just posted I got this:</p><div class="codebox"><pre class="vscroll"><code>$ ./lsgroup.sh ### Group 0 ### 00:00.0 Host bridge: Intel Corporation Xeon E3-1200 v3 Processor DRAM Controller (rev 06) ### Group 1 ### 00:01.0 PCI bridge: Intel Corporation Xeon E3-1200 v3/4th Gen Core Processor PCI Express x16 Controller (rev 06) 01:00.0 VGA compatible controller: Advanced Micro Devices, Inc. [AMD/ATI] Pitcairn PRO [Radeon HD 7850] 01:00.1 Audio device: Advanced Micro Devices, Inc. [AMD/ATI] Cape Verde/Pitcairn HDMI Audio [Radeon HD 7700/7800 Series] ### Group 2 ### 00:02.0 VGA compatible controller: Intel Corporation Xeon E3-1200 v3 Processor Integrated Graphics Controller (rev 06) ### Group 3 ### 00:03.0 Audio device: Intel Corporation Xeon E3-1200 v3/4th Gen Core Processor HD Audio Controller (rev 06) ### Group 4 ### 00:14.0 USB controller: Intel Corporation 8 Series/C220 Series Chipset Family USB xHCI (rev 05) ### Group 5 ### 00:16.0 Communication controller: Intel Corporation 8 Series/C220 Series Chipset Family MEI Controller #1 (rev 04) ### Group 6 ### 00:19.0 Ethernet controller: Intel Corporation Ethernet Connection I217-V (rev 05) ### Group 7 ### 00:1a.0 USB controller: Intel Corporation 8 Series/C220 Series Chipset Family USB EHCI #2 (rev 05) ### Group 8 ### 00:1b.0 Audio device: Intel Corporation 8 Series/C220 Series Chipset High Definition Audio Controller (rev 05) ### Group 9 ### 00:1c.0 PCI bridge: Intel Corporation 8 Series/C220 Series Chipset Family PCI Express Root Port #1 (rev d5) 00:1c.2 PCI bridge: Intel Corporation 8 Series/C220 Series Chipset Family PCI Express Root Port #3 (rev d5) 00:1c.3 PCI bridge: Intel Corporation 8 Series/C220 Series Chipset Family PCI Express Root Port #4 (rev d5) 00:1c.4 PCI bridge: Intel Corporation 8 Series/C220 Series Chipset Family PCI Express Root Port #5 (rev d5) 00:1c.5 PCI bridge: Intel Corporation 8 Series/C220 Series Chipset Family PCI Express Root Port #6 (rev d5) 03:00.0 SATA controller: ASMedia Technology Inc. ASM1062 Serial ATA Controller (rev 01) 04:00.0 Ethernet controller: Intel Corporation I211 Gigabit Network Connection (rev 03) 05:00.0 SATA controller: ASMedia Technology Inc. ASM1062 Serial ATA Controller (rev 01) 06:00.0 PCI bridge: PLX Technology, Inc. Device 8603 (rev aa) 07:01.0 PCI bridge: PLX Technology, Inc. Device 8603 (rev aa) 07:02.0 PCI bridge: PLX Technology, Inc. Device 8603 (rev aa) 08:00.0 SATA controller: ASMedia Technology Inc. ASM1062 Serial ATA Controller (rev 01) 09:00.0 USB controller: Renesas Technology Corp. uPD720202 USB 3.0 Host Controller (rev 02) ### Group 10 ### 00:1d.0 USB controller: Intel Corporation 8 Series/C220 Series Chipset Family USB EHCI #1 (rev 05) ### Group 11 ### 00:1f.0 ISA bridge: Intel Corporation Z87 Express LPC Controller (rev 05) 00:1f.2 SATA controller: Intel Corporation 8 Series/C220 Series Chipset Family 6-port SATA Controller 1 [AHCI mode] (rev 05) 00:1f.3 SMBus: Intel Corporation 8 Series/C220 Series Chipset Family SMBus Controller (rev 05)</code></pre></div><p>Why is there so much in group 9? From what I know, I can only passthrough complete groups.<br />But why would my PCIe Card be in the same group as a whole lot of onboard stuff?<br />Or is this the same problem as I had some pages back, because the PCIe Card has the same vendor:device ids as the onboard asmedia chip? (I think vfio-bind.sh automaticly gets them)</p></div></blockquote></div><p>If you built the kernel i provided try this workarround: <a href="https://bbs.archlinux.org/viewtopic.php?pid=1342995#p1342995" rel="nofollow">https://bbs.archlinux.org/viewtopic.php … 5#p1342995</a></p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1349304">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1349309" class="blockpost roweven"> <h2><span><span class="conr">#735</span> <a href="viewtopic.php?pid=1349309#p1349309">2013-11-14 00:40:36</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=76479">Norcoen</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>From: Norway</span></dd> <dd><span>Registered: 2013-11-02</span></dd> <dd><span>Posts: 23</span></dd> <dd class="usercontacts"><span class="email"><a href="mailto:frankmoll@gmx.net">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <p>No, I just built 3.12 from kernel.org with the config changes</p><div class="codebox"><pre><code> CONFIG_VFIO_IOMMU_TYPE1=y CONFIG_VFIO=y CONFIG_VFIO_PCI=y CONFIG_VFIO_PCI_VGA=y</code></pre></div><p>I&#039;ll try building your kernel. Guess that will take some time, since I have to patch it manually. (And built my first kernel a week ago...^^)</p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1349309">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1349311" class="blockpost rowodd"> <h2><span><span class="conr">#736</span> <a href="viewtopic.php?pid=1349311#p1349311">2013-11-14 00:48:55</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=70922">nbhs</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd class="postavatar"><img src="https://bbs.archlinux.org/img/avatars/70922.jpg?m=1367773811" width="80" height="80" alt="" /></dd> <dd><span>From: Montevideo, Uruguay</span></dd> <dd><span>Registered: 2013-05-02</span></dd> <dd><span>Posts: 402</span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>Norcoen wrote:</cite><blockquote><div><p>I&#039;ll try building your kernel. Guess that will take some time, since I have to patch it manually. (And built my first kernel a week ago...^^)</p></div></blockquote></div><p>If you&#039;re using arch,&#160; just unpack it, open a console then build it like this:</p><div class="codebox"><pre><code>makepkg -s</code></pre></div><p>then install it:</p><div class="codebox"><pre><code>sudo pacman -U linux-mainline-*</code></pre></div><p>Same for the qemu and seabios packages i linked.</p> <p class="postedit"><em>Last edited by nbhs (2013-11-14 00:49:27)</em></p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1349311">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1349328" class="blockpost roweven"> <h2><span><span class="conr">#737</span> <a href="viewtopic.php?pid=1349328#p1349328">2013-11-14 02:16:44</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=76766">mafferri</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2013-11-11</span></dd> <dd><span>Posts: 7</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=76766">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>Norcoen wrote:</cite><blockquote><div><p>Thank you for your insanely fast reply <img src="https://bbs.archlinux.org/img/smilies/smile.png" width="15" height="15" alt="smile" /><br />I didn&#039;t thought about it when I used pci-stub because I always used it with virt-manager before trying vfio...</p><p>I&#039;m getting this error now:</p><div class="codebox"><pre><code>qemu-system-x86_64: -device vfio-pci,host=04:00.0: vfio: error, group 9 is not viable, please ensure all devices within the iommu_group are bound to their vfio bus driver. qemu-system-x86_64: -device vfio-pci,host=04:00.0: vfio: failed to get group 9 qemu-system-x86_64: -device vfio-pci,host=04:00.0: Device initialization failed. qemu-system-x86_64: -device vfio-pci,host=04:00.0: Device &#039;vfio-pci&#039; could not be initialized</code></pre></div></div></blockquote></div><p>resolve this , add the group /dev/vfio/9 in the /etc/libvirt/qemu.conf&#160; edit: I thought you were the one who posted the libvirt domain<br />and &quot;chmod 666 /dev/vfio/16 /dev/vfio/17 /dev/vfio/7 /dev/vfio/vfio &quot; only this test</p> <p class="postedit"><em>Last edited by mafferri (2013-11-14 02:18:24)</em></p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1349328">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1349332" class="blockpost rowodd"> <h2><span><span class="conr">#738</span> <a href="viewtopic.php?pid=1349332#p1349332">2013-11-14 02:22:28</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=75590">aw</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2013-10-04</span></dd> <dd><span>Posts: 921</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=75590">Email</a></span> <span class="website"><a href="http://vfio.blogspot.com/" rel="nofollow">Website</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>mafferri wrote:</cite><blockquote><div><div class="quotebox"><cite>Norcoen wrote:</cite><blockquote><div><p>Thank you for your insanely fast reply <img src="https://bbs.archlinux.org/img/smilies/smile.png" width="15" height="15" alt="smile" /><br />I didn&#039;t thought about it when I used pci-stub because I always used it with virt-manager before trying vfio...</p><p>I&#039;m getting this error now:</p><div class="codebox"><pre><code>qemu-system-x86_64: -device vfio-pci,host=04:00.0: vfio: error, group 9 is not viable, please ensure all devices within the iommu_group are bound to their vfio bus driver. qemu-system-x86_64: -device vfio-pci,host=04:00.0: vfio: failed to get group 9 qemu-system-x86_64: -device vfio-pci,host=04:00.0: Device initialization failed. qemu-system-x86_64: -device vfio-pci,host=04:00.0: Device &#039;vfio-pci&#039; could not be initialized</code></pre></div></div></blockquote></div><p>resolve this , add the group /dev/vfio/9 in the /etc/libvirt/qemu.conf&#160; edit: I thought you were the one who posted the libvirt domain<br />and &quot;chmod 666 /dev/vfio/16 /dev/vfio/17 /dev/vfio/7 /dev/vfio/vfio &quot; only this test</p></div></blockquote></div><p>That&#039;s not the problem, the error message indicates how to fix it.&#160; Norcoen needs the ACS override patch and to boot with an option to prune the group down to something manageable.</p> </div> <div class="postsignature postmsg"><hr /><p><a href="http://vfio.blogspot.com" rel="nofollow">http://vfio.blogspot.com</a><br />Looking for a more open forum to discuss vfio related uses?&#160; Try <a href="https://www.redhat.com/mailman/listinfo/vfio-users" rel="nofollow">https://www.redhat.com/mailman/listinfo/vfio-users</a></p></div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1349332">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1349371" class="blockpost roweven"> <h2><span><span class="conr">#739</span> <a href="viewtopic.php?pid=1349371#p1349371">2013-11-14 05:32:33</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=76834">Val532</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2013-11-13</span></dd> <dd><span>Posts: 35</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=76834">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <p>Hi,</p><p>I work this night to make able to use virt-manager with GPU passtrough and it work now !!!</p><p>You need libvirt 1.1.4 and Virt-Manage 0.10.</p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1349371">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1349465" class="blockpost rowodd"> <h2><span><span class="conr">#740</span> <a href="viewtopic.php?pid=1349465#p1349465">2013-11-14 14:16:06</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=76794">ilya80</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2013-11-12</span></dd> <dd><span>Posts: 34</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=76794">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <p>Hi guys!</p><p>Need a bit of help here. My config:</p><p>Asrock Z68 Extreme 3 Gen 3, latest BIOS, Vt-d enabled in bios<br />Intel i5 3470, with HD 2500 as primary adapter, used in host system<br />NVidia GTX 680 as secondary adapter, nouveau blacklisted in host system - intended for passthrough<br />Running fresh Debian sid </p><p>I started on the whole thing, so far I`ve done the following:</p><p>1) Downloaded 3.12 source, applied &quot;i915_fixes.patch&quot; and &quot;override_for_missing_acs_capabilities.patch&quot;, built with VFIO compiled into the kernel and rebooted. Tried both with and without &quot;vfio_iommu_type1.allow_unsafe_interrupts=1&quot; in kernel command line.<br />2) Cloned qemu git, applied &quot;vfio_disallow_device_from_using_nosnoop_transactions.patch&quot;, built and installed via &quot;make install&quot;<br />3) Cloned seabios and built, have no use for it yet though.</p><p>My problem is that when I try to bind the GPU using &quot;sudo vfio-bind 0000:01:00.0 0000:01:00.0&quot;, it fails with the following in /var/log/kern.log:</p><div class="codebox"><pre><code>Nov 14 17:54:18 cave-lin kernel: [ 145.427257] vfio-pci: probe of 0000:01:00.0 failed with error -22 Nov 14 17:54:18 cave-lin kernel: [ 145.472245] vfio-pci: probe of 0000:01:00.0 failed with error -22 Nov 14 17:54:18 cave-lin kernel: [ 145.472252] vfio-pci: probe of 0000:01:00.1 failed with error -22</code></pre></div><p>I`m sure device is not yet claimed by any driver, &quot;sudo lspci -k&quot; gives:</p><div class="codebox"><pre><code>01:00.0 VGA compatible controller: NVIDIA Corporation GK104 [GeForce GTX 680] (rev a1) Subsystem: NVIDIA Corporation Device 0969 01:00.1 Audio device: NVIDIA Corporation GK104 HDMI Audio Controller (rev a1) Subsystem: NVIDIA Corporation Device 0969</code></pre></div><p>Any pointers on what I have missed / where I should look ?</p><p>Thanks!</p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1349465">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1349466" class="blockpost roweven"> <h2><span><span class="conr">#741</span> <a href="viewtopic.php?pid=1349466#p1349466">2013-11-14 14:20:31</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=75590">aw</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2013-10-04</span></dd> <dd><span>Posts: 921</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=75590">Email</a></span> <span class="website"><a href="http://vfio.blogspot.com/" rel="nofollow">Website</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>ilya80 wrote:</cite><blockquote><div><p>Hi guys!</p><p>Need a bit of help here. My config:</p><p>Asrock Z68 Extreme 3 Gen 3, latest BIOS, Vt-d enabled in bios<br />Intel i5 3470, with HD 2500 as primary adapter, used in host system<br />NVidia GTX 680 as secondary adapter, nouveau blacklisted in host system - intended for passthrough<br />Running fresh Debian sid </p><p>I started on the whole thing, so far I`ve done the following:</p><p>1) Downloaded 3.12 source, applied &quot;i915_fixes.patch&quot; and &quot;override_for_missing_acs_capabilities.patch&quot;, built with VFIO compiled into the kernel and rebooted. Tried both with and without &quot;vfio_iommu_type1.allow_unsafe_interrupts=1&quot; in kernel command line.<br />2) Cloned qemu git, applied &quot;vfio_disallow_device_from_using_nosnoop_transactions.patch&quot;, built and installed via &quot;make install&quot;<br />3) Cloned seabios and built, have no use for it yet though.</p><p>My problem is that when I try to bind the GPU using &quot;sudo vfio-bind 0000:01:00.0 0000:01:00.0&quot;, it fails with the following in /var/log/kern.log:</p><div class="codebox"><pre><code>Nov 14 17:54:18 cave-lin kernel: [ 145.427257] vfio-pci: probe of 0000:01:00.0 failed with error -22 Nov 14 17:54:18 cave-lin kernel: [ 145.472245] vfio-pci: probe of 0000:01:00.0 failed with error -22 Nov 14 17:54:18 cave-lin kernel: [ 145.472252] vfio-pci: probe of 0000:01:00.1 failed with error -22</code></pre></div><p>I`m sure device is not yet claimed by any driver, &quot;sudo lspci -k&quot; gives:</p><div class="codebox"><pre><code>01:00.0 VGA compatible controller: NVIDIA Corporation GK104 [GeForce GTX 680] (rev a1) Subsystem: NVIDIA Corporation Device 0969 01:00.1 Audio device: NVIDIA Corporation GK104 HDMI Audio Controller (rev a1) Subsystem: NVIDIA Corporation Device 0969</code></pre></div><p>Any pointers on what I have missed / where I should look ?</p><p>Thanks!</p></div></blockquote></div><p>Boot with intel_iommu=on</p> </div> <div class="postsignature postmsg"><hr /><p><a href="http://vfio.blogspot.com" rel="nofollow">http://vfio.blogspot.com</a><br />Looking for a more open forum to discuss vfio related uses?&#160; Try <a href="https://www.redhat.com/mailman/listinfo/vfio-users" rel="nofollow">https://www.redhat.com/mailman/listinfo/vfio-users</a></p></div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1349466">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1349473" class="blockpost rowodd"> <h2><span><span class="conr">#742</span> <a href="viewtopic.php?pid=1349473#p1349473">2013-11-14 14:36:42</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=76794">ilya80</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2013-11-12</span></dd> <dd><span>Posts: 34</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=76794">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>aw wrote:</cite><blockquote><div><p>Boot with intel_iommu=on</p></div></blockquote></div><p>That did it, thanks! Both devices now successfully managed by vfio-pci. I`ll follow the guide in the first post. Maybe you could provide few clarifications: should I copy seabios binaries produced after building it somewhere into qemu? Or just try firing up qemu?</p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1349473">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1349476" class="blockpost roweven"> <h2><span><span class="conr">#743</span> <a href="viewtopic.php?pid=1349476#p1349476">2013-11-14 14:46:53</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=70922">nbhs</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd class="postavatar"><img src="https://bbs.archlinux.org/img/avatars/70922.jpg?m=1367773811" width="80" height="80" alt="" /></dd> <dd><span>From: Montevideo, Uruguay</span></dd> <dd><span>Registered: 2013-05-02</span></dd> <dd><span>Posts: 402</span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>ilya80 wrote:</cite><blockquote><div><div class="quotebox"><cite>aw wrote:</cite><blockquote><div><p>Boot with intel_iommu=on</p></div></blockquote></div><p>That did it, thanks! Both devices now successfully managed by vfio-pci. I`ll follow the guide in the first post. Maybe you could provide few clarifications: should I copy seabios binaries produced after building it somewhere into qemu? Or just try firing up qemu?</p></div></blockquote></div><p>Build it somewhere then fire qemu with qemu-system-x86_64 -bios /path/to/seabios/out/bios.bin ...</p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1349476">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1349482" class="blockpost rowodd"> <h2><span><span class="conr">#744</span> <a href="viewtopic.php?pid=1349482#p1349482">2013-11-14 15:06:42</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=76794">ilya80</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2013-11-12</span></dd> <dd><span>Posts: 34</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=76794">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>nbhs wrote:</cite><blockquote><div><p>Build it somewhere then fire qemu with qemu-system-x86_64 -bios /path/to/seabios/out/bios.bin ...</p></div></blockquote></div><p>Right, now I read it. Okay this requires me looking at the monitors, so I`ll have to come home first.</p><p>Thanks!</p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1349482">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1349483" class="blockpost roweven"> <h2><span><span class="conr">#745</span> <a href="viewtopic.php?pid=1349483#p1349483">2013-11-14 15:07:02</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=75590">aw</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2013-10-04</span></dd> <dd><span>Posts: 921</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=75590">Email</a></span> <span class="website"><a href="http://vfio.blogspot.com/" rel="nofollow">Website</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <p>The bios provided by qemu should be fine.</p> </div> <div class="postsignature postmsg"><hr /><p><a href="http://vfio.blogspot.com" rel="nofollow">http://vfio.blogspot.com</a><br />Looking for a more open forum to discuss vfio related uses?&#160; Try <a href="https://www.redhat.com/mailman/listinfo/vfio-users" rel="nofollow">https://www.redhat.com/mailman/listinfo/vfio-users</a></p></div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1349483">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1349514" class="blockpost rowodd"> <h2><span><span class="conr">#746</span> <a href="viewtopic.php?pid=1349514#p1349514">2013-11-14 16:49:11</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=76479">Norcoen</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>From: Norway</span></dd> <dd><span>Registered: 2013-11-02</span></dd> <dd><span>Posts: 23</span></dd> <dd class="usercontacts"><span class="email"><a href="mailto:frankmoll@gmx.net">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>nbhs wrote:</cite><blockquote><div><p>If you&#039;re using arch,&#160; just unpack it, open a console then build it like this:</p><div class="codebox"><pre><code>makepkg -s</code></pre></div><p>then install it:</p><div class="codebox"><pre><code>sudo pacman -U linux-mainline-*</code></pre></div><p>Same for the qemu and seabios packages i linked.</p></div></blockquote></div><p>Unfortunately I&#039;m stuck with Fedora and/or CentOS if I don&#039;t want to use Windows here.<br />I already built the qemu and seabios packages you provided (~2 weeks ago, have there been any changes I need in the meantime?)</p><p>Now I just read the code in the PKGBUILD file and did the patching manually. No errors so far. But I&#039;m kinda stuck on the .config file.<br />I copied the oldconfig from /boot/config/3.11.7 and compared it to your config.x86_64.</p><p>I think (hope) it&#039;s save, to leave configs on, that arent specified in your config, for example:<br />Your config: # CONFIG_KALLSYMS_ALL is not set<br />My oldconfig: CONFIG_KALLSYMS_ALL=y<br />Result: CONFIG_KALLSYMS_ALL=y</p><p>I think this also applies the other way around, when you set it, but it&#039;s not specified in my oldconfig yet:<br />Your config: CONFIG_TICK_CPU_ACCOUNTING=y<br />My oldconfig: # CONFIG_TICK_CPU_ACCOUNTING is not set<br />Result: CONFIG_TICK_CPU_ACCOUNTING=y</p><p>I hope I&#039;m right to this point. Now what do I do with differences like this:</p><div class="codebox"><pre><code>Your Config: My oldconfig: # # # RCU Subsystem # RCU Subsystem # # CONFIG_TREE_PREEMPT_RCU=y | CONFIG_TREE_RCU=y CONFIG_PREEMPT_RCU=y | # CONFIG_PREEMPT_RCU is not set CONFIG_RCU_STALL_COMMON=y CONFIG_RCU_STALL_COMMON=y</code></pre></div> <p class="postedit"><em>Last edited by Norcoen (2013-11-14 16:54:44)</em></p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1349514">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1349517" class="blockpost roweven"> <h2><span><span class="conr">#747</span> <a href="viewtopic.php?pid=1349517#p1349517">2013-11-14 16:52:13</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=75590">aw</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2013-10-04</span></dd> <dd><span>Posts: 921</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=75590">Email</a></span> <span class="website"><a href="http://vfio.blogspot.com/" rel="nofollow">Website</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <p>The fedora kernel config is fine to use as a starting point.</p> </div> <div class="postsignature postmsg"><hr /><p><a href="http://vfio.blogspot.com" rel="nofollow">http://vfio.blogspot.com</a><br />Looking for a more open forum to discuss vfio related uses?&#160; Try <a href="https://www.redhat.com/mailman/listinfo/vfio-users" rel="nofollow">https://www.redhat.com/mailman/listinfo/vfio-users</a></p></div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1349517">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1349519" class="blockpost rowodd"> <h2><span><span class="conr">#748</span> <a href="viewtopic.php?pid=1349519#p1349519">2013-11-14 16:58:25</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=76479">Norcoen</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>From: Norway</span></dd> <dd><span>Registered: 2013-11-02</span></dd> <dd><span>Posts: 23</span></dd> <dd class="usercontacts"><span class="email"><a href="mailto:frankmoll@gmx.net">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <p>But why isn&#039;t CONFIG_TREE_PREEMPT_RCU present in the fedora kernel config, while CONFIG_TREE_RCU isn&#039;t present in nbhs&#039; config?<br />Aren&#039;t those related somehow? Or is it complety irrelevant?</p><p>Again, thank you for those insanely fast replies <img src="https://bbs.archlinux.org/img/smilies/smile.png" width="15" height="15" alt="smile" /></p> <p class="postedit"><em>Last edited by Norcoen (2013-11-14 17:04:30)</em></p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1349519">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1349520" class="blockpost roweven"> <h2><span><span class="conr">#749</span> <a href="viewtopic.php?pid=1349520#p1349520">2013-11-14 16:59:58</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=75590">aw</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2013-10-04</span></dd> <dd><span>Posts: 921</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=75590">Email</a></span> <span class="website"><a href="http://vfio.blogspot.com/" rel="nofollow">Website</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>Norcoen wrote:</cite><blockquote><div><p>But why isn&#039;t CONFIG_TREE_PREEMPT_RCU present in the fedora kernel config, while CONFIG_TREE_RCU is present isn&#039;t present in nbhs&#039; config?<br />AreN&#039;t those related somehow? Or is it complety irrelevant?</p><p>Again, thank you for those insanely fast replies <img src="https://bbs.archlinux.org/img/smilies/smile.png" width="15" height="15" alt="smile" /></p></div></blockquote></div><p>Completely irrelevant to vga assignment</p> </div> <div class="postsignature postmsg"><hr /><p><a href="http://vfio.blogspot.com" rel="nofollow">http://vfio.blogspot.com</a><br />Looking for a more open forum to discuss vfio related uses?&#160; Try <a href="https://www.redhat.com/mailman/listinfo/vfio-users" rel="nofollow">https://www.redhat.com/mailman/listinfo/vfio-users</a></p></div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1349520">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1349545" class="blockpost rowodd"> <h2><span><span class="conr">#750</span> <a href="viewtopic.php?pid=1349545#p1349545">2013-11-14 18:41:29</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=76479">Norcoen</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>From: Norway</span></dd> <dd><span>Registered: 2013-11-02</span></dd> <dd><span>Posts: 23</span></dd> <dd class="usercontacts"><span class="email"><a href="mailto:frankmoll@gmx.net">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <p>It&#039;s working!<br />Booting kernel 3.12 with the provided patches and &quot;pcie_acs_override=downstream&quot; as a parameter, lsgroup now gives me this output:</p><div class="codebox"><pre class="vscroll"><code>$ ./lsgroup.sh ### Group 0 ### 00:00.0 Host bridge: Intel Corporation Xeon E3-1200 v3 Processor DRAM Controller (rev 06) ### Group 1 ### 00:01.0 PCI bridge: Intel Corporation Xeon E3-1200 v3/4th Gen Core Processor PCI Express x16 Controller (rev 06) ### Group 2 ### 00:02.0 VGA compatible controller: Intel Corporation Xeon E3-1200 v3 Processor Integrated Graphics Controller (rev 06) ### Group 3 ### 00:03.0 Audio device: Intel Corporation Xeon E3-1200 v3/4th Gen Core Processor HD Audio Controller (rev 06) ### Group 4 ### 00:14.0 USB controller: Intel Corporation 8 Series/C220 Series Chipset Family USB xHCI (rev 05) ### Group 5 ### 00:16.0 Communication controller: Intel Corporation 8 Series/C220 Series Chipset Family MEI Controller #1 (rev 04) ### Group 6 ### 00:19.0 Ethernet controller: Intel Corporation Ethernet Connection I217-V (rev 05) ### Group 7 ### 00:1a.0 USB controller: Intel Corporation 8 Series/C220 Series Chipset Family USB EHCI #2 (rev 05) ### Group 8 ### 00:1b.0 Audio device: Intel Corporation 8 Series/C220 Series Chipset High Definition Audio Controller (rev 05) ### Group 9 ### 00:1c.0 PCI bridge: Intel Corporation 8 Series/C220 Series Chipset Family PCI Express Root Port #1 (rev d5) ### Group 10 ### 00:1c.2 PCI bridge: Intel Corporation 8 Series/C220 Series Chipset Family PCI Express Root Port #3 (rev d5) ### Group 11 ### 00:1c.3 PCI bridge: Intel Corporation 8 Series/C220 Series Chipset Family PCI Express Root Port #4 (rev d5) ### Group 12 ### 00:1c.4 PCI bridge: Intel Corporation 8 Series/C220 Series Chipset Family PCI Express Root Port #5 (rev d5) ### Group 13 ### 00:1c.5 PCI bridge: Intel Corporation 8 Series/C220 Series Chipset Family PCI Express Root Port #6 (rev d5) ### Group 14 ### 00:1d.0 USB controller: Intel Corporation 8 Series/C220 Series Chipset Family USB EHCI #1 (rev 05) ### Group 15 ### 00:1f.0 ISA bridge: Intel Corporation Z87 Express LPC Controller (rev 05) 00:1f.2 SATA controller: Intel Corporation 8 Series/C220 Series Chipset Family 6-port SATA Controller 1 [AHCI mode] (rev 05) 00:1f.3 SMBus: Intel Corporation 8 Series/C220 Series Chipset Family SMBus Controller (rev 05) ### Group 16 ### 01:00.0 VGA compatible controller: Advanced Micro Devices, Inc. [AMD/ATI] Pitcairn PRO [Radeon HD 7850] 01:00.1 Audio device: Advanced Micro Devices, Inc. [AMD/ATI] Cape Verde/Pitcairn HDMI Audio [Radeon HD 7700/7800 Series] ### Group 17 ### 03:00.0 SATA controller: ASMedia Technology Inc. ASM1062 Serial ATA Controller (rev 01) ### Group 18 ### 04:00.0 Ethernet controller: Intel Corporation I211 Gigabit Network Connection (rev 03) ### Group 19 ### 05:00.0 SATA controller: ASMedia Technology Inc. ASM1062 Serial ATA Controller (rev 01) ### Group 20 ### 06:00.0 PCI bridge: PLX Technology, Inc. Device 8603 (rev aa) ### Group 21 ### 07:01.0 PCI bridge: PLX Technology, Inc. Device 8603 (rev aa) ### Group 22 ### 07:02.0 PCI bridge: PLX Technology, Inc. Device 8603 (rev aa) ### Group 23 ### 08:00.0 SATA controller: ASMedia Technology Inc. ASM1062 Serial ATA Controller (rev 01) ### Group 24 ### 09:00.0 USB controller: Renesas Technology Corp. uPD720202 USB 3.0 Host Controller (rev 02)</code></pre></div><p>I can boot the Windows7 image with this. It&#039;s working fine as far as I can tell. Thank you so much <img src="https://bbs.archlinux.org/img/smilies/smile.png" width="15" height="15" alt="smile" /></p><p>I got an other little problem now, because Win7 does not recognize mouse and keyboard on the pcie-controller until I install the drivers for it, I need to passthrough my hosts usb devices.</p><div class="codebox"><pre><code>$ lsusb Bus 002 Device 002: ID 8087:8000 Intel Corp. Bus 002 Device 001: ID 1d6b:0002 Linux Foundation 2.0 root hub Bus 001 Device 002: ID 8087:8008 Intel Corp. Bus 001 Device 001: ID 1d6b:0002 Linux Foundation 2.0 root hub Bus 004 Device 002: ID 174c:3074 ASMedia Technology Inc. Bus 004 Device 001: ID 1d6b:0003 Linux Foundation 3.0 root hub Bus 003 Device 013: ID 046d:c227 Logitech, Inc. G15 Refresh Keyboard Bus 003 Device 011: ID 046d:c226 Logitech, Inc. G15 Refresh Keyboard Bus 003 Device 010: ID 1532:0016 Razer USA, Ltd DeathAdder Mouse Bus 003 Device 009: ID 10d5:1234 Uni Class Technology Co., Ltd Bus 003 Device 008: ID 0424:2524 Standard Microsystems Corp. USB MultiSwitch Hub Bus 003 Device 002: ID 174c:2074 ASMedia Technology Inc. Bus 003 Device 007: ID 046d:c227 Logitech, Inc. G15 Refresh Keyboard Bus 003 Device 006: ID 046d:c226 Logitech, Inc. G15 Refresh Keyboard Bus 003 Device 005: ID 1532:0016 Razer USA, Ltd DeathAdder Mouse Bus 003 Device 004: ID 10d5:1234 Uni Class Technology Co., Ltd Bus 003 Device 003: ID 0424:2524 Standard Microsystems Corp. USB MultiSwitch Hub Bus 003 Device 001: ID 1d6b:0002 Linux Foundation 2.0 root hub</code></pre></div><p>Mouse and keyboard are 2x in this list, because both of the kvm-switch cables are connected to the host.<br />I want to passthrough the secondary ones, so the line in the startscript looks like this:</p><div class="codebox"><pre><code>USB_DEVICES=&quot;host:046d:c226 host:046d:c227 host:1532:0016&quot;</code></pre></div><p>giving me this output+error:</p><div class="codebox"><pre class="vscroll"><code>$ ./startWin7.sh cset: **&gt; CPUSPEC &quot;-4-3&quot; has bad group &quot;-4-3&quot; $QEMU $BIOS $CPU $MEMORY $QEMU_ARGS $DEV $USB_DEV $NET $SND $STORAGE $EXTRA_ARGS QEMU 1.6.50 monitor - type &#039;help&#039; for more information (qemu) cset: **&gt; shielding not active on system taskset: Ungültige Option -- 4 Usage: taskset [options] [mask | cpu-list] [pid|cmd [args...]] Options: -a, --all-tasks operate on all the tasks (threads) for a given pid -p, --pid operate on existing given pid -c, --cpu-list display and specify cpus in list format -h, --help display this help -V, --version output version information The default behavior is to run a new command: taskset 03 sshd -b 1024 You can retrieve the mask of an existing task: taskset -p 700 Or set it: taskset -p 03 700 List format uses a comma-separated list instead of a mask: taskset -pc 0,3,7-11 700 Ranges in list format can take a stride argument: e.g. 0-31:2 is equivalent to mask 0x55555555 For more information see taskset(1). cset: **&gt; shielding not active on system taskset: Ungültige Option -- 3 Usage: taskset [options] [mask | cpu-list] [pid|cmd [args...]] Options: -a, --all-tasks operate on all the tasks (threads) for a given pid -p, --pid operate on existing given pid -c, --cpu-list display and specify cpus in list format -h, --help display this help -V, --version output version information The default behavior is to run a new command: taskset 03 sshd -b 1024 You can retrieve the mask of an existing task: taskset -p 700 Or set it: taskset -p 03 700 List format uses a comma-separated list instead of a mask: taskset -pc 0,3,7-11 700 Ranges in list format can take a stride argument: e.g. 0-31:2 is equivalent to mask 0x55555555 For more information see taskset(1). cset: **&gt; shielding not active on system taskset: Ungültige Option -- 2 Usage: taskset [options] [mask | cpu-list] [pid|cmd [args...]] Options: -a, --all-tasks operate on all the tasks (threads) for a given pid -p, --pid operate on existing given pid -c, --cpu-list display and specify cpus in list format -h, --help display this help -V, --version output version information The default behavior is to run a new command: taskset 03 sshd -b 1024 You can retrieve the mask of an existing task: taskset -p 700 Or set it: taskset -p 03 700 List format uses a comma-separated list instead of a mask: taskset -pc 0,3,7-11 700 Ranges in list format can take a stride argument: e.g. 0-31:2 is equivalent to mask 0x55555555 For more information see taskset(1). cset: **&gt; shielding not active on system taskset: Ungültige Option -- 1 Usage: taskset [options] [mask | cpu-list] [pid|cmd [args...]] Options: -a, --all-tasks operate on all the tasks (threads) for a given pid -p, --pid operate on existing given pid -c, --cpu-list display and specify cpus in list format -h, --help display this help -V, --version output version information The default behavior is to run a new command: taskset 03 sshd -b 1024 You can retrieve the mask of an existing task: taskset -p 700 Or set it: taskset -p 03 700 List format uses a comma-separated list instead of a mask: taskset -pc 0,3,7-11 700 Ranges in list format can take a stride argument: e.g. 0-31:2 is equivalent to mask 0x55555555 For more information see taskset(1). cset: **&gt; shielding not active on system pid 6715&#039;s current affinity list: 0-7 pid 6715&#039;s new affinity list: 0 qemu: could not add USB device &#039;host:046d:c226&#039; cset: **&gt; shielding not active on system taskset: failed to get pid 6755&#039;s affinity: Kein passender Prozess gefunden cset: **&gt; shielding not active on system taskset: failed to get pid 6804&#039;s affinity: Kein passender Prozess gefunden cset: **&gt; shielding not active on system taskset: failed to get pid 6853&#039;s affinity: Kein passender Prozess gefunden cset: --&gt; deactivating/reseting shielding cset: **&gt; shielding not active on system All Done!!</code></pre></div><p>Do I Need to unbind them somehow? Like the PCI devices?<br />Before I just selected them in virt-manager and they&#039;ve been passed through without manually unbinding them.<br />Or is my syntax incorrect?</p><p>//edit:<br />ah, now I see that vendor:device IDs are the same again, like the problem I had with the sata-controller.<br />Is it possible to be more specific, on which device I want to pass?<br />virt-manager defines it in this xml structure:</p><div class="codebox"><pre><code>&lt;hostdev mode=&#039;subsystem&#039; type=&#039;usb&#039; managed=&#039;yes&#039;&gt; &lt;source&gt; &lt;vendor id=&#039;0x1532&#039;/&gt; &lt;product id=&#039;0x0016&#039;/&gt; &lt;address bus=&#039;3&#039; device=&#039;15&#039;/&gt; &lt;/source&gt; &lt;/hostdev&gt;</code></pre></div><p>//edit2:<br />I found this: <a href="http://www.linux-kvm.org/page/USB_Host_Device_Assigned_to_Guest" rel="nofollow">http://www.linux-kvm.org/page/USB_Host_ … d_to_Guest</a><br />I tried changing the startscript from</p><div class="codebox"><pre><code>USB_DEVICES=&quot;host:046d:c226 host:046d:c227 host:1532:0016&quot;</code></pre></div><p>to:</p><div class="codebox"><pre><code>USB_DEVICES=&quot;usb-host,hostbus=3,hostaddr=10 usb-host,hostbus=3,hostaddr=11 usb-host,hostbus=3,hostaddr=13&quot;</code></pre></div><p>but that did not work either.</p> <p class="postedit"><em>Last edited by Norcoen (2013-11-14 19:02:23)</em></p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1349545">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div class="postlinksb"> <div class="inbox crumbsplus"> <div class="pagepost"> <p class="pagelink conl"><span class="pages-label">Pages: </span><a rel="prev" class="item1" href="viewtopic.php?id=162768&amp;p=29">Previous</a> <a href="viewtopic.php?id=162768">1</a> <span class="spacer">…</span> <a href="viewtopic.php?id=162768&amp;p=28">28</a> <a href="viewtopic.php?id=162768&amp;p=29">29</a> <strong>30</strong> <a href="viewtopic.php?id=162768&amp;p=31">31</a> <a href="viewtopic.php?id=162768&amp;p=32">32</a> <span class="spacer">…</span> <a href="viewtopic.php?id=162768&amp;p=234">234</a> <a rel="next" href="viewtopic.php?id=162768&amp;p=31">Next</a></p> <p class="postlink conr">Topic closed</p> </div> <ul class="crumbs"> <li><a href="index.php">Index</a></li> <li><span>»&#160;</span><a href="viewforum.php?id=48">Topics Going Nowhere</a></li> <li><span>»&#160;</span><strong><a href="viewtopic.php?id=162768">KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</a></strong></li> </ul> <p class="subscribelink clearb"><a href="misc.php?action=subscribe&amp;tid=162768">Subscribe to this topic</a></p> <div class="clearer"></div> </div> </div> </div> <div id="brdfooter" class="block"> <h2><span>Board footer</span></h2> <div class="box"> <div id="brdfooternav" class="inbox"> <div class="conl"> <form id="qjump" method="get" action="viewforum.php"> <div><label><span>Jump to<br /></span> <select name="id" onchange="window.location=('viewforum.php?id='+this.options[this.selectedIndex].value)"> <optgroup label="Technical Issues and Assistance"> <option value="23">Newbie Corner</option> <option value="17">Installation</option> <option value="22">Kernel &amp; Hardware</option> <option value="18">Applications &amp; Desktop Environments</option> <option value="31">Laptop Issues</option> <option value="8">Networking, Server, and Protection</option> <option value="32">Multimedia and Games</option> <option value="50">System Administration</option> <option value="35">Other Architectures</option> </optgroup> <optgroup label="Arch-centric"> <option value="24">Announcements, Package &amp; Security Advisories</option> <option value="1">Arch Discussion</option> <option value="13">Forum &amp; Wiki discussion</option> </optgroup> <optgroup label="Pacman Upgrades, Packaging &amp; AUR"> <option value="44">Pacman &amp; Package Upgrade Issues</option> <option value="49">[testing] Repo Forum</option> <option value="4">Creating &amp; Modifying Packages</option> <option value="38">AUR Issues, Discussion &amp; PKGBUILD Requests</option> </optgroup> <optgroup label="Contributions &amp; Discussion"> <option value="20">GNU/Linux Discussion</option> <option value="27">Community Contributions</option> <option value="33">Programming &amp; Scripting</option> <option value="30">Other Languages</option> <option value="47">Artwork and Screenshots</option> <option value="42">Try This</option> </optgroup> <optgroup label="/dev/null"> <option value="29">Off-Topic</option> <option value="48" selected="selected">Topics Going Nowhere</option> <option value="36">Dustbin</option> </optgroup> </select></label> <input type="submit" value=" Go " accesskey="g" /> </div> </form> </div> <div class="conr"> <p id="feedlinks"><span class="atom"><a href="extern.php?action=feed&amp;tid=162768&amp;type=atom">Atom topic feed</a></span></p> <p id="poweredby">Powered by <a href="http://fluxbb.org/">FluxBB</a></p> </div> <div class="clearer"></div> </div> </div> </div> </div> <div class="end-box"></div> </div> </body> </html>
