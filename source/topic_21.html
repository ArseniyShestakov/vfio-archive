<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"> <html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en" dir="ltr"> <head> <meta http-equiv="Content-Type" content="text/html; charset=utf-8" /> <title>KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9 (Page 21) / Topics Going Nowhere / Arch Linux Forums</title> <link rel="stylesheet" type="text/css" href="style/ArchLinux.css" /> <link rel="canonical" href="viewtopic.php?id=162768&amp;p=21" title="Page 21" /> <link rel="prev" href="viewtopic.php?id=162768&amp;p=20" title="Page 20" /> <link rel="next" href="viewtopic.php?id=162768&amp;p=22" title="Page 22" /> <link rel="alternate" type="application/atom+xml" href="extern.php?action=feed&amp;tid=162768&amp;type=atom" title="Atom topic feed" /> <link rel="stylesheet" media="screen" href="style/ArchLinux/arch.css?v=3" /> <link rel="stylesheet" media="screen" href="style/ArchLinux/archnavbar.css?v=2" /> <link rel="shortcut icon" href="style/ArchLinux/favicon.ico" /> </head> <body> <div id="archnavbar" class="anb-forum"> <div id="archnavbarlogo"><h1><a href="http://www.archlinux.org/">Arch Linux</a></h1></div> <div id="archnavbarmenu"> <ul id="archnavbarlist"> <li id="anb-home"><a href="http://www.archlinux.org/">Home</a></li><li id="anb-packages"><a href="http://www.archlinux.org/packages/">Packages</a></li><li id="anb-forums" class="anb-selected"><a href="https://bbs.archlinux.org/">Forums</a></li><li id="anb-wiki"><a href="https://wiki.archlinux.org/">Wiki</a></li><li id="anb-bugs"><a href="https://bugs.archlinux.org/">Bugs</a></li><li id="anb-aur"><a href="https://aur.archlinux.org/">AUR</a></li><li id="anb-download"><a href="http://www.archlinux.org/download/">Download</a></li> </ul> </div> </div> <div id="punviewtopic" class="pun"> <div class="top-box"></div> <div class="punwrap"> <div id="brdheader" class="block"> <div class="box"> <div id="brdmenu" class="inbox"> <ul> <li id="navindex" class="isactive"><a href="index.php">Index</a></li> <li id="navuserlist"><a href="userlist.php">User list</a></li> <li id="navsearch"><a href="search.php">Search</a></li> <li id="navprofile"><a href="profile.php?id=80749">Profile</a></li> <li id="navlogout"><a href="login.php?action=out&amp;id=80749&amp;csrf_token=5c20501ec397bb45ef8ee8c84db232c8d8e421c6">Logout</a></li> </ul> </div> <div id="brdwelcome" class="inbox"> <ul class="conl"> <li><span>Logged in as <strong>SXX</strong></span></li> <li><span>Last visit: 2015-08-16 12:20:09</span></li> </ul> <ul class="conr"> <li><span>Topics: <a href="search.php?action=show_replies" title="Find topics you have posted to.">Posted</a> | <a href="search.php?action=show_new" title="Find topics with new posts since your last visit.">New</a> | <a href="search.php?action=show_recent" title="Find topics with recent posts.">Active</a> | <a href="search.php?action=show_unanswered" title="Find topics with no replies.">Unanswered</a></span></li> </ul> <div class="clearer"></div> </div> </div> </div> <div id="brdmain"> <div class="linkst"> <div class="inbox crumbsplus"> <ul class="crumbs"> <li><a href="index.php">Index</a></li> <li><span>»&#160;</span><a href="viewforum.php?id=48">Topics Going Nowhere</a></li> <li><span>»&#160;</span><strong><a href="viewtopic.php?id=162768">KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</a></strong></li> </ul> <div class="pagepost"> <p class="pagelink conl"><span class="pages-label">Pages: </span><a rel="prev" class="item1" href="viewtopic.php?id=162768&amp;p=20">Previous</a> <a href="viewtopic.php?id=162768">1</a> <span class="spacer">…</span> <a href="viewtopic.php?id=162768&amp;p=19">19</a> <a href="viewtopic.php?id=162768&amp;p=20">20</a> <strong>21</strong> <a href="viewtopic.php?id=162768&amp;p=22">22</a> <a href="viewtopic.php?id=162768&amp;p=23">23</a> <span class="spacer">…</span> <a href="viewtopic.php?id=162768&amp;p=234">234</a> <a rel="next" href="viewtopic.php?id=162768&amp;p=22">Next</a></p> <p class="postlink conr">Topic closed</p> </div> <div class="clearer"></div> </div> </div> <div id="p1327075" class="blockpost rowodd blockpost1"> <h2><span><span class="conr">#501</span> <a href="viewtopic.php?pid=1327075#p1327075">2013-09-20 08:05:55</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=74747">gosheto</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2013-09-04</span></dd> <dd><span>Posts: 7</span></dd> <dd class="usercontacts"><span class="email"><a href="mailto:0xd3ad@gmail.com">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <p>Hi,</p><p>I`m using latest stable kernel 3.11.1 with your linux-mainline.tar.gz (3.11) - all patches and configured with your config.x86_64<br />Qemu version 1.6.0 patched with your qemu.tar.gz (1.6)<br />SeaBIOS v1.7.3 QEMU/KVM image - bios.bin-1.7.3.gz</p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1327075">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1327466" class="blockpost roweven"> <h2><span><span class="conr">#502</span> <a href="viewtopic.php?pid=1327466#p1327466">2013-09-21 03:52:55</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=70922">nbhs</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd class="postavatar"><img src="https://bbs.archlinux.org/img/avatars/70922.jpg?m=1367773811" width="80" height="80" alt="" /></dd> <dd><span>From: Montevideo, Uruguay</span></dd> <dd><span>Registered: 2013-05-02</span></dd> <dd><span>Posts: 402</span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>gosheto wrote:</cite><blockquote><div><p>Hi,</p><p>I`m using latest stable kernel 3.11.1 with your linux-mainline.tar.gz (3.11) - all patches and configured with your config.x86_64<br />Qemu version 1.6.0 patched with your qemu.tar.gz (1.6)<br />SeaBIOS v1.7.3 QEMU/KVM image - bios.bin-1.7.3.gz</p></div></blockquote></div><p>Have you tried the previous qemu version? im having some problems myself using qemu 1.6 ( system crawls and eventually hangs at windows login prompt)</p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1327466">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1328198" class="blockpost rowodd"> <h2><span><span class="conr">#503</span> <a href="viewtopic.php?pid=1328198#p1328198">2013-09-23 02:19:59</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=58181">Smasher816</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd class="postavatar"><img src="https://bbs.archlinux.org/img/avatars/58181.jpg?m=1342488762" width="80" height="80" alt="" /></dd> <dd><span>From: Cyberspace of Missouri</span></dd> <dd><span>Registered: 2012-03-15</span></dd> <dd><span>Posts: 32</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=58181">Email</a></span> <span class="website"><a href="http://irc.freenode.net" rel="nofollow">Website</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <p>Awesome write&#160; nbhs. Unfortunately I am having some strange issues.</p><p>I have an AMD FX processor, a Gigabyte motherboard (with IOMMU support), an Nvidia GTX graphics card (for Linux, primary card in bios, proprietary driver), and an ATI Radeon HD 5770 (for Windows). I successfully got vga passthrough working with Xen in the past, but it made the dom0 graphics acceleration fail. I am now attempting this KVM method which looks promising.</p><p>If I do not have the nvidia module built and boot&#160; into the command line I can successfully see the ati card working. However, once I install the nvidia module and boot into X, all I get is a black screen on the second card.</p><p>I am attempting to test the passthrough with these commands:</p><div class="codebox"><pre><code>$ sudo vfio-bind 0000:01:00.0 0000:01:00.1 $ sudo qemu-system-x86_64 -enable-kvm -M q35 -m 1024 -cpu host \ -smp 6,sockets=1,cores=6,threads=1 \ -bios /usr/share/qemu/bios.bin -vga none -nographic \ -device ioh3420,bus=pcie.0,addr=1c.0,multifunction=on,port=1,chassis=1,id=root.1 \ -device vfio-pci,host=01:00.0,bus=root.1,addr=00.0,multifunction=on,x-vga=on \ -device vfio-pci,host=01:00.1,bus=root.1,addr=00.1</code></pre></div><p>Installed packages (patched versions from first post):</p><div class="codebox"><pre><code>linux-mainline 3.11-1 linux-mainline-headers 3.11-1 qemu 1.6.0-9 seabios 1.7.3-1 nvidia-304xx 304.108-5 (rebuilt for linux-mainline kernel)</code></pre></div><p>lspci output:</p><div class="codebox"><pre><code>01:00.0 VGA compatible controller: Advanced Micro Devices, Inc. [AMD/ATI] Juniper XT [Radeon HD 5770] Subsystem: PC Partner Limited Device e132 Kernel driver in use: vfio-pci Kernel modules: radeon 01:00.1 Audio device: Advanced Micro Devices, Inc. [AMD/ATI] Juniper HDMI Audio [Radeon HD 5700 Series] Subsystem: PC Partner Limited Device aa58 Kernel driver in use: vfio-pci Kernel modules: snd_hda_intel</code></pre></div><p>Edit: Fixed. See this patch <a href="http://lists.gnu.org/archive/html/qemu-devel/2013-05/txtmFIq9_I13p.txt" rel="nofollow">http://lists.gnu.org/archive/html/qemu- … 9_I13p.txt</a></p> <p class="postedit"><em>Last edited by Smasher816 (2013-09-23 02:51:42)</em></p> </div> <div class="postsignature postmsg"><hr /><p>(Arch) Linux is user friendly, its just very selective of its friends</p></div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1328198">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1328204" class="blockpost roweven"> <h2><span><span class="conr">#504</span> <a href="viewtopic.php?pid=1328204#p1328204">2013-09-23 02:47:08</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=70922">nbhs</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd class="postavatar"><img src="https://bbs.archlinux.org/img/avatars/70922.jpg?m=1367773811" width="80" height="80" alt="" /></dd> <dd><span>From: Montevideo, Uruguay</span></dd> <dd><span>Registered: 2013-05-02</span></dd> <dd><span>Posts: 402</span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>Smasher816 wrote:</cite><blockquote><div><p>Awesome write&#160; nbhs. Unfortunately I am having some strange issues.</p><p>I have an AMD FX processor, a Gigabyte motherboard (with IOMMU support), an Nvidia GTX graphics card (for Linux, primary card in bios, proprietary driver), and an ATI Radeon HD 5770 (for Windows). I successfully got vga passthrough working with Xen in the past, but it made the dom0 graphics acceleration fail. I am now attempting this KVM method which looks promising.</p><p>If I do not have the nvidia module built and boot&#160; into the command line I can successfully see the ati card working. However, once I install the nvidia module and boot into X, all I get is a black screen on the second card.</p><p>I am attempting to test the passthrough with these commands:</p><div class="codebox"><pre><code>$ sudo vfio-bind 0000:01:00.0 0000:01:00.1 $ sudo qemu-system-x86_64 -enable-kvm -M q35 -m 1024 -cpu host \ -smp 6,sockets=1,cores=6,threads=1 \ -bios /usr/share/qemu/bios.bin -vga none -nographic \ -device ioh3420,bus=pcie.0,addr=1c.0,multifunction=on,port=1,chassis=1,id=root.1 \ -device vfio-pci,host=01:00.0,bus=root.1,addr=00.0,multifunction=on,x-vga=on \ -device vfio-pci,host=01:00.1,bus=root.1,addr=00.1</code></pre></div><p>Installed packages (patched versions from first post):</p><div class="codebox"><pre><code>linux-mainline 3.11-1 linux-mainline-headers 3.11-1 qemu 1.6.0-9 seabios 1.7.3-1 nvidia-304xx 304.108-5 (rebuilt for linux-mainline kernel)</code></pre></div><p>lspci output:</p><div class="codebox"><pre><code>01:00.0 VGA compatible controller: Advanced Micro Devices, Inc. [AMD/ATI] Juniper XT [Radeon HD 5770] Subsystem: PC Partner Limited Device e132 Kernel driver in use: vfio-pci Kernel modules: radeon 01:00.1 Audio device: Advanced Micro Devices, Inc. [AMD/ATI] Juniper HDMI Audio [Radeon HD 5700 Series] Subsystem: PC Partner Limited Device aa58 Kernel driver in use: vfio-pci Kernel modules: snd_hda_intel</code></pre></div></div></blockquote></div><p>Its on the guide</p><div class="quotebox"><cite>nbhs wrote:</cite><blockquote><div><p>Using NVIDIA proprietary drivers on the requires a patch: see <a href="http://www.mail-archive.com/qemu-devel@nongnu.org/msg174066.html" rel="nofollow">http://www.mail-archive.com/qemu-devel@ … 74066.html</a>&#160; patch (posted by andy123):&#160; <a href="http://bpaste.net/show/109185/" rel="nofollow">http://bpaste.net/show/109185/</a></p></div></blockquote></div><p>Good luck!</p> <p class="postedit"><em>Last edited by nbhs (2013-09-23 02:48:03)</em></p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1328204">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1328206" class="blockpost rowodd"> <h2><span><span class="conr">#505</span> <a href="viewtopic.php?pid=1328206#p1328206">2013-09-23 02:56:14</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=58181">Smasher816</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd class="postavatar"><img src="https://bbs.archlinux.org/img/avatars/58181.jpg?m=1342488762" width="80" height="80" alt="" /></dd> <dd><span>From: Cyberspace of Missouri</span></dd> <dd><span>Registered: 2012-03-15</span></dd> <dd><span>Posts: 32</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=58181">Email</a></span> <span class="website"><a href="http://irc.freenode.net" rel="nofollow">Website</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>nbhs wrote:</cite><blockquote><div><div class="quotebox"><cite>Smasher816 wrote:</cite><blockquote><div><p>&lt;snip&gt;</p></div></blockquote></div><p>Its on the guide</p><div class="quotebox"><cite>nbhs wrote:</cite><blockquote><div><p>Using NVIDIA proprietary drivers on the requires a patch: see <a href="http://www.mail-archive.com/qemu-devel@nongnu.org/msg174066.html" rel="nofollow">http://www.mail-archive.com/qemu-devel@ … 74066.html</a>&#160; patch (posted by andy123):&#160; <a href="http://bpaste.net/show/109185/" rel="nofollow">http://bpaste.net/show/109185/</a></p></div></blockquote></div><p>Good luck!</p></div></blockquote></div><p>Thanks for the quick reply. It works now <img src="https://bbs.archlinux.org/img/smilies/big_smile.png" width="15" height="15" alt="big_smile" /></p><p>I ended up finding a link to the same patch on page 16. I read through the first post once before actually attempting anything. I guess when I skimmed over it a second time I managed to miss that link.</p> </div> <div class="postsignature postmsg"><hr /><p>(Arch) Linux is user friendly, its just very selective of its friends</p></div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1328206">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1328209" class="blockpost roweven"> <h2><span><span class="conr">#506</span> <a href="viewtopic.php?pid=1328209#p1328209">2013-09-23 03:04:56</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=70922">nbhs</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd class="postavatar"><img src="https://bbs.archlinux.org/img/avatars/70922.jpg?m=1367773811" width="80" height="80" alt="" /></dd> <dd><span>From: Montevideo, Uruguay</span></dd> <dd><span>Registered: 2013-05-02</span></dd> <dd><span>Posts: 402</span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>Smasher816 wrote:</cite><blockquote><div><div class="quotebox"><cite>nbhs wrote:</cite><blockquote><div><div class="quotebox"><cite>Smasher816 wrote:</cite><blockquote><div><p>&lt;snip&gt;</p></div></blockquote></div><p>Its on the guide</p><div class="quotebox"><cite>nbhs wrote:</cite><blockquote><div><p>Using NVIDIA proprietary drivers on the requires a patch: see <a href="http://www.mail-archive.com/qemu-devel@nongnu.org/msg174066.html" rel="nofollow">http://www.mail-archive.com/qemu-devel@ … 74066.html</a>&#160; patch (posted by andy123):&#160; <a href="http://bpaste.net/show/109185/" rel="nofollow">http://bpaste.net/show/109185/</a></p></div></blockquote></div><p>Good luck!</p></div></blockquote></div><p>Thanks for the quick reply. It works now <img src="https://bbs.archlinux.org/img/smilies/big_smile.png" width="15" height="15" alt="big_smile" /></p><p>I ended up finding a link to the same patch on page 16. I read through the first post once before actually attempting anything. I guess when I skimmed over it a second time I managed to miss that link.</p></div></blockquote></div><p>Nice, i just realized there was a typo i forgot the word &quot;host&quot;, anyway check out my second post on &quot;performance improvements&quot;, specifically disabling npt.</p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1328209">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1328583" class="blockpost rowodd"> <h2><span><span class="conr">#507</span> <a href="viewtopic.php?pid=1328583#p1328583">2013-09-24 01:23:21</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=58181">Smasher816</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd class="postavatar"><img src="https://bbs.archlinux.org/img/avatars/58181.jpg?m=1342488762" width="80" height="80" alt="" /></dd> <dd><span>From: Cyberspace of Missouri</span></dd> <dd><span>Registered: 2012-03-15</span></dd> <dd><span>Posts: 32</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=58181">Email</a></span> <span class="website"><a href="http://irc.freenode.net" rel="nofollow">Website</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <p>Alright. My windows.img (Windows 7, raw file) used with Xen works under KVM too.</p><p>I am now attempting to virtualize the physical Windows partition I dual-boot into. My Arch Linux install is on an ssd (sda1), and Windows is on a hard drive (sdb3). lspci only shows one SATA controller, therefore I am passing through my whole second hard drive (which has its own bootloader).</p><p>Passing /dev/sdb to Qemu shows the Syslinux bootloader, and then begins booting Windows. Unfortunately it quickly blue screens of death with the error &quot;*** STOP: 0x0000007B (0xFFFFF880009A97E8,0xFFFFFFFFC0000034,0x0000000000000000,0x0000000000000000)&quot;. I believe this means that Windows does not like the Qemu disk controller (piix4-ide). When booting in in ahci mode it will error before Windows starts (bios is in IDE mode if I remember correctly). Is it possible to have qemu use a different device Windows 7 will recognize? Perhaps there is a way to boot into Windows and install some drivers before virtualizing it with qemu?</p><p>I also have an issue with audio. When using the two lines from your original post any sounds made in the Windows vm will stutter badly. With Xen I passed through my onboard audio controller, and used a dedicated sound card for Linux. I then had the speaker port of one plugged into line in of the other. When trying this with KVM I face issues. When I use vfio-bind on 0000:00:14.2 my sound stops working. Note: alsa is configured to use the CMI8768 card and the onboard should be disabled with &quot;pci-stubs.ids=....&quot;.</p><p>The two cards are:</p><div class="codebox"><pre><code>00:14.2 Audio device: Advanced Micro Devices, Inc. [AMD/ATI] SBx00 Azalia (Intel HDA) (rev 40) 05:06.0 Multimedia audio controller: C-Media Electronics Inc CMI8738/CMI8768 PCI Audio (rev 10)</code></pre></div><p>Thanks in advance for any help.</p> <p class="postedit"><em>Last edited by Smasher816 (2013-09-24 01:36:48)</em></p> </div> <div class="postsignature postmsg"><hr /><p>(Arch) Linux is user friendly, its just very selective of its friends</p></div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1328583">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1328611" class="blockpost roweven"> <h2><span><span class="conr">#508</span> <a href="viewtopic.php?pid=1328611#p1328611">2013-09-24 03:16:39</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=70922">nbhs</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd class="postavatar"><img src="https://bbs.archlinux.org/img/avatars/70922.jpg?m=1367773811" width="80" height="80" alt="" /></dd> <dd><span>From: Montevideo, Uruguay</span></dd> <dd><span>Registered: 2013-05-02</span></dd> <dd><span>Posts: 402</span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>Smasher816 wrote:</cite><blockquote><div><p>Alright. My windows.img (Windows 7, raw file) used with Xen works under KVM too.</p><p>I am now attempting to virtualize the physical Windows partition I dual-boot into. My Arch Linux install is on an ssd (sda1), and Windows is on a hard drive (sdb3). lspci only shows one SATA controller, therefore I am passing through my whole second hard drive (which has its own bootloader).</p><p>Passing /dev/sdb to Qemu shows the Syslinux bootloader, and then begins booting Windows. Unfortunately it quickly blue screens of death with the error &quot;*** STOP: 0x0000007B (0xFFFFF880009A97E8,0xFFFFFFFFC0000034,0x0000000000000000,0x0000000000000000)&quot;. I believe this means that Windows does not like the Qemu disk controller (piix4-ide). When booting in in ahci mode it will error before Windows starts (bios is in IDE mode if I remember correctly). Is it possible to have qemu use a different device Windows 7 will recognize? Perhaps there is a way to boot into Windows and install some drivers before virtualizing it with qemu?</p><p>I also have an issue with audio. When using the two lines from your original post any sounds made in the Windows vm will stutter badly. With Xen I passed through my onboard audio controller, and used a dedicated sound card for Linux. I then had the speaker port of one plugged into line in of the other. When trying this with KVM I face issues. When I use vfio-bind on 0000:00:14.2 my sound stops working. Note: alsa is configured to use the CMI8768 card and the onboard should be disabled with &quot;pci-stubs.ids=....&quot;.</p><p>The two cards are:</p><div class="codebox"><pre><code>00:14.2 Audio device: Advanced Micro Devices, Inc. [AMD/ATI] SBx00 Azalia (Intel HDA) (rev 40) 05:06.0 Multimedia audio controller: C-Media Electronics Inc CMI8738/CMI8768 PCI Audio (rev 10)</code></pre></div><p>Thanks in advance for any help.</p></div></blockquote></div><p>you&#039;ll need to modfiy the windows registry i believe some people had this problem some pages back, about the sound you could try another driver instead of pulse, like also or oss</p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1328611">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1329223" class="blockpost rowodd"> <h2><span><span class="conr">#509</span> <a href="viewtopic.php?pid=1329223#p1329223">2013-09-25 13:34:10</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=71361">apoapo</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2013-05-16</span></dd> <dd><span>Posts: 15</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=71361">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <p>Wow. Many pages in here <img src="https://bbs.archlinux.org/img/smilies/big_smile.png" width="15" height="15" alt="big_smile" />.</p><p>Have to do some reading and will probably give the vfio a try again the next days.<br />Unfortunately I didn&#039;t found time/motivation to do more testing/using with the pci-assign in the past.</p><p>Was there some progress with vfio and Intel IGPs (eg in i5) as primary GPU?</p><p>Greetings<br />apo</p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1329223">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1329355" class="blockpost roweven"> <h2><span><span class="conr">#510</span> <a href="viewtopic.php?pid=1329355#p1329355">2013-09-25 18:14:27</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=75076">SpacePirate</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2013-09-16</span></dd> <dd><span>Posts: 55</span></dd> <dd class="usercontacts"><span class="email"><a href="mailto:hiduei@gmx.de">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <p>I just wanted to start trying this on&#160; my new machine. When building the qemu-git package from the AUR it conflicts with some files by seasbios...<br />Do i still need seabios or was its functionality merged into qemu itself?</p><p>EDIT: I just recognized something in the first post. The output of &quot;dmesg | grep pci-stub&quot; contains one line more than one would expect with the posted kernel parameters. I suppose the next pci device is a USB-Controller you added in your configuration (?).</p><p>EDIT2: So i tried to run this on my machine, but it does not seem to work. I installed the linux-mainline (3.11), qemu (1.6) and seabios (1.7.3) from the packagebuilds you posted. IOMMU is enabled, the pci-bind kernel boot parameter is set and i execute the vfio-bind script using your systemctl service.</p><div class="codebox"><pre><code># dmesg | grep -iE &#039;iommu|vfio|pci-bind&#039; [ 0.848089] AMD-Vi: Found IOMMU at 0000:00:00.2 cap 0x40 [ 0.970713] VFIO - User Level meta-driver version: 0.3 [ 229.648012] vfio-pci 0000:06:00.0: enabling device (0000 -&gt; 0003) [ 476.262919] vfio-pci 0000:06:00.1: enabling device (0000 -&gt; 0002) # lspci 06:00.0 VGA compatible controller: Advanced Micro Devices, Inc. [AMD/ATI] Caicos [Radeon HD 6450/7450/8450] 06:00.1 Audio device: Advanced Micro Devices, Inc. [AMD/ATI] Caicos HDMI Audio [Radeon HD 6400 Series] # lspci -n 06:00.0 0300: 1002:6779 06:00.1 0403: 1002:aa98 # cat /etc/vfio-pci.cfg DEVICES=&quot;0000:06:00.1 0000:06:00.1&quot;</code></pre></div><p>This is the script i use to run the VM: (it`s easier to edit the commands in there)</p><div class="codebox"><pre><code>#!/bin/sh qemu-system-x86_64 -enable-kvm -M q35 -m 1024 -cpu host \ -smp 6,sockets=1,cores=6,threads=1 \ -bios /usr/share/qemu/bios.bin -vga none \ -device ioh3420,bus=pcie.0,addr=1c.0,multifunction=on,port=1,chassis=1,id=root.1 \ -device vfio-pci,host=06:00.0,bus=root.1,addr=00.0,multifunction=on,x-vga=on \ -device vfio-pci,host=06:00.1,bus=root.1,addr=00.1</code></pre></div><p>When i run the vm, my main screen goes black after switching to tty2 and back again its normal again (i suppose its a Gnome or X bug). I have an empty qemu window. After plugging my monitor to the second GPU i get no signal from it.<br />Some thoughts i had on what could cause the problem:<br />- maybe the 6450 doesnt support switching? I want to use my 7870 but i cant choose my primary boot device in bios so i need to change the slots (havent done that yet)<br />- do i need to have the monitor plugged in, when the vm starts?</p><p>Any help is greatly appreciated!</p> <p class="postedit"><em>Last edited by SpacePirate (2013-09-26 10:18:46)</em></p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1329355">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1329752" class="blockpost rowodd"> <h2><span><span class="conr">#511</span> <a href="viewtopic.php?pid=1329752#p1329752">2013-09-26 15:54:31</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=75364">Endrik</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2013-09-26</span></dd> <dd><span>Posts: 1</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=75364">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>apoapo wrote:</cite><blockquote><div><p>Wow. Many pages in here <img src="https://bbs.archlinux.org/img/smilies/big_smile.png" width="15" height="15" alt="big_smile" />.</p><p>Have to do some reading and will probably give the vfio a try again the next days.<br />Unfortunately I didn&#039;t found time/motivation to do more testing/using with the pci-assign in the past.</p><p>Was there some progress with vfio and Intel IGPs (eg in i5) as primary GPU?</p><p>Greetings<br />apo</p></div></blockquote></div><p>I don&#039;t know if there has been any progress with the IGP - when i try to passtrough my intel Card qemu complains:</p><p>qemu-system-x86_64: -device vfio-pci,host=00:02.0,bus=root.1,addr=00.0,multifunction=on,x-vga=on: vfio: Device does not support requested feature x-vga<br />qemu-system-x86_64: -device vfio-pci,host=00:02.0,bus=root.1,addr=00.0,multifunction=on,x-vga=on: vfio: failed to get device 0000:00:02.0<br />qemu-system-x86_64: -device vfio-pci,host=00:02.0,bus=root.1,addr=00.0,multifunction=on,x-vga=on: Device initialization failed.<br />qemu-system-x86_64: -device vfio-pci,host=00:02.0,bus=root.1,addr=00.0,multifunction=on,x-vga=on: Device &#039;vfio-pci&#039; could not be initialized</p><br /><p>passing the radeon card works fine - except the &quot;bug&quot; that after a guest reboot only the seabios message is passed, after &quot;grub init&quot; the display stays blank and the guest doesnt boot up <img src="https://bbs.archlinux.org/img/smilies/hmm.png" width="15" height="15" alt="hmm" /></p><p>i am currently using qemu/seabios from git and kernel 3.11.0 (debian) with vga-vfio enabled</p><p>I have no clue why i can&#039;t pass-trough the intel-gpu, the i915 driver ist blacklisted and the radeon is primary GPU. Starting qemu without x-vga=on boots up the guest - but the monitor stays off and the guest kernel complains:<br />[&#160; &#160; 3.883569] [drm] Initialized drm 1.1.0 20060810<br />[&#160; &#160; 3.893808] [drm] Memory usable by graphics device = 2048M<br />[&#160; &#160; 3.895049] i915 0000:01:00.0: setting latency timer to 64<br />[&#160; &#160; 3.897831] [drm:hsw_unclaimed_reg_clear] *ERROR* Unknown unclaimed register before writing to 61208<br />[&#160; &#160; 3.897834] [drm:hsw_unclaimed_reg_check] *ERROR* Unclaimed write to 61208<br />[&#160; &#160; 3.897836] [drm:hsw_unclaimed_reg_check] *ERROR* Unclaimed write to 6120c<br />[&#160; &#160; 3.898233] i915 0000:01:00.0: irq 46 for MSI/MSI-X<br />[&#160; &#160; 3.981291] [drm] Supports vblank timestamp caching Rev 1 (10.10.2010).<br />[&#160; &#160; 3.981301] [drm] Driver supports precise vblank timestamp query.<br />[&#160; &#160; 3.981317] i915 0000:01:00.0: BAR 6: can&#039;t assign [??? 0x00000000 flags 0x0] (bogus alignment)<br />[&#160; &#160; 3.981321] [drm] failed to find VBIOS tables<br />....</p><p>Maybe someone found a workaround?<br />Greetings</p><p>Edit1: When booting the host up with the intel as primary device and running the qemu command to pass-through the intel card with x-vga on: qemu does not complain, but screen turns off (login prompt from the host vanishes and the monitor turns off)</p> <p class="postedit"><em>Last edited by Endrik (2013-09-26 16:33:15)</em></p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1329752">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1329885" class="blockpost roweven"> <h2><span><span class="conr">#512</span> <a href="viewtopic.php?pid=1329885#p1329885">2013-09-26 20:14:33</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=58181">Smasher816</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd class="postavatar"><img src="https://bbs.archlinux.org/img/avatars/58181.jpg?m=1342488762" width="80" height="80" alt="" /></dd> <dd><span>From: Cyberspace of Missouri</span></dd> <dd><span>Registered: 2012-03-15</span></dd> <dd><span>Posts: 32</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=58181">Email</a></span> <span class="website"><a href="http://irc.freenode.net" rel="nofollow">Website</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>nbhs wrote:</cite><blockquote><div><div class="quotebox"><cite>Smasher816 wrote:</cite><blockquote><div><p>Alright. My windows.img (Windows 7, raw file) used with Xen works under KVM too.</p><p>&lt;snip&gt;</p></div></blockquote></div><p>you&#039;ll need to modfiy the windows registry i believe some people had this problem some pages back, about the sound you could try another driver instead of pulse, like also or oss</p></div></blockquote></div><p>Just a quick update. I got a fresh virtual installation to work well, but could not convert my previous install. Sound works great using alsa and &quot;-soundhw ac97&quot; along with the ac97 drivers in Windows 7. Both virtio disk and network (bridged tap) are working well.</p><p>The Windows Experience Index gives me 7.4 for the processor, 7.9 for memory, 7.2 for graphics, and 4.8 for disk (its an old hard drive). Overall the virtual machine runs great <img src="https://bbs.archlinux.org/img/smilies/big_smile.png" width="15" height="15" alt="big_smile" /></p><p>I am still unable to pass through my physical sata controller and sound card because they are part of a ten device iommu_group. I have already tried using pcie_acs_override=... with downstream, mulitplex, and the vendor ids of various controllers to no avail. As it stands it would be nice to get more manageable iommu groups, but it is not a game breaker. Thanks again for the awesome guide nbhs.</p><p>Edit: is it possible to use usb 2.0 with pci passthrough? Windows keeps yelling at me saying &quot;this device can perform better&quot; if it was plugged into a usb 2 port.</p> <p class="postedit"><em>Last edited by Smasher816 (2013-09-27 03:29:15)</em></p> </div> <div class="postsignature postmsg"><hr /><p>(Arch) Linux is user friendly, its just very selective of its friends</p></div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1329885">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1329959" class="blockpost rowodd"> <h2><span><span class="conr">#513</span> <a href="viewtopic.php?pid=1329959#p1329959">2013-09-26 22:56:00</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=69685">Chetyre</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2013-03-27</span></dd> <dd><span>Posts: 34</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=69685">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <p>Hey again.</p><p>I upgraded qemu, seabios and the kernel with the builds on the first page since things weren&#039;t working before anyway, but now when I try to launch the test machine I get this error:</p><p>qemu-system-x86_64: -device vfio-pci,host=02:00.0,bus=root.1,addr=00.0,multifunction=on,x-vga=on: vfio: Error: Failed to setup INTx fd: Device or resource busy<br />qemu-system-x86_64: -device vfio-pci,host=02:00.0,bus=root.1,addr=00.0,multifunction=on,x-vga=on: Device initialization failed.<br />qemu-system-x86_64: -device vfio-pci,host=02:00.0,bus=root.1,addr=00.0,multifunction=on,x-vga=on: Device &#039;vfio-pci&#039; could not be initialized</p><p>Also, the kvm module isn&#039;t loading on boot. I&#039;ve added it to modules-load.d but it doesn&#039;t want to work</p><p>dmesg shows this when I try creating the vm:</p><p>genirq: Flags mismatch irq 17. 00000080 (vfio-intx(0000:02:00.0)) vs. 00002000 (kvm:0000:07:00.0)</p> <p class="postedit"><em>Last edited by Chetyre (2013-09-26 23:12:47)</em></p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1329959">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1330099" class="blockpost roweven"> <h2><span><span class="conr">#514</span> <a href="viewtopic.php?pid=1330099#p1330099">2013-09-27 08:58:57</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=75076">SpacePirate</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2013-09-16</span></dd> <dd><span>Posts: 55</span></dd> <dd class="usercontacts"><span class="email"><a href="mailto:hiduei@gmx.de">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <p>So i swapped the Cards now, to check if maybe passing the 7870 works and now the qemu process crashes...:<br /><a href="http://ideone.com/5fxU8z" rel="nofollow">http://ideone.com/5fxU8z</a><br />Any ideas on that?</p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1330099">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1330963" class="blockpost rowodd"> <h2><span><span class="conr">#515</span> <a href="viewtopic.php?pid=1330963#p1330963">2013-09-29 12:09:02</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=60514">ttouch</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>From: /dev/null</span></dd> <dd><span>Registered: 2012-05-27</span></dd> <dd><span>Posts: 129</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=60514">Email</a></span> <span class="website"><a href="http://dzervas.gr" rel="nofollow">Website</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <p>Hey,</p><p>My problem is that I keep getting &quot;ls: cannot access /sys/bus/pci/devices/0000:02:00.0/iommu_group/devices: No such file or directory&quot;<br />I have an nvidia 9800GT as the system&#039;s GPU and I want to bind my GTX 660 Ti.<br />I had nvidia drivers, but I saw in page 3 that they have a bug and that&#039;s why I don&#039;t have the &quot;iommu_group&quot; directory.<br />Then I changed to nouveau. The problem remains.<br />Then I built your linux-mainline (I was on 3.11.1-1). The problem still remains.<br />I can&#039;t bind my 660... :\</p><p>`dmesg| grep -i pci-`</p><div class="codebox"><pre><code>[ 0.000000] Command line: BOOT_IMAGE=/vmlinuz-linux-mainline root=UUID=e78cde76-376a-4d00-b994-18453659643a quiet add_efi_memmap rw pci-stub.ids=10de:0e0a,10de:1183 [ 0.000000] Kernel command line: BOOT_IMAGE=/vmlinuz-linux-mainline root=UUID=e78cde76-376a-4d00-b994-18453659643a quiet add_efi_memmap rw pci-stub.ids=10de:0e0a,10de:1183 [ 0.792129] PCI-DMA: Using software bounce buffering for IO (SWIOTLB) [ 0.881226] pci-stub: add 10DE:0E0A sub=FFFFFFFF:FFFFFFFF cls=00000000/00000000 [ 0.881234] pci-stub 0000:02:00.1: claimed by stub [ 0.881240] pci-stub: add 10DE:1183 sub=FFFFFFFF:FFFFFFFF cls=00000000/00000000 [ 0.881244] pci-stub 0000:02:00.0: claimed by stub</code></pre></div><p>My mobo and CPU (Asus P9X79 Deluxe and i7-3820) support interrupt remapping (VT-d) and I&#039;ve enabled it, so there is no need for the &quot;vfio_iommu_type1.allow_unsafe_interrupts=1&quot; at my kernel line. Right?</p><p>Thank you in advance</p> </div> <div class="postsignature postmsg"><hr /><p><a href="http://github.com/ttouch" rel="nofollow">GitHub</a> | <a href="http://git.dzervas.gr" rel="nofollow">Git Server</a> | <a href="http://dzervas.gr" rel="nofollow">Blog</a></p></div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1330963">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1330981" class="blockpost roweven"> <h2><span><span class="conr">#516</span> <a href="viewtopic.php?pid=1330981#p1330981">2013-09-29 14:27:50</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=75076">SpacePirate</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2013-09-16</span></dd> <dd><span>Posts: 55</span></dd> <dd class="usercontacts"><span class="email"><a href="mailto:hiduei@gmx.de">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <p>Just a wild guess, did you load the module / compile it into the kernel?</p> <p class="postedit"><em>Last edited by SpacePirate (2013-09-29 14:30:34)</em></p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1330981">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1330982" class="blockpost rowodd"> <h2><span><span class="conr">#517</span> <a href="viewtopic.php?pid=1330982#p1330982">2013-09-29 14:29:19</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=60514">ttouch</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>From: /dev/null</span></dd> <dd><span>Registered: 2012-05-27</span></dd> <dd><span>Posts: 129</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=60514">Email</a></span> <span class="website"><a href="http://dzervas.gr" rel="nofollow">Website</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <p>Yes. I use the patched linux-mainline kernel and I double-checked it.</p> </div> <div class="postsignature postmsg"><hr /><p><a href="http://github.com/ttouch" rel="nofollow">GitHub</a> | <a href="http://git.dzervas.gr" rel="nofollow">Git Server</a> | <a href="http://dzervas.gr" rel="nofollow">Blog</a></p></div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1330982">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1332308" class="blockpost roweven"> <h2><span><span class="conr">#518</span> <a href="viewtopic.php?pid=1332308#p1332308">2013-10-02 13:35:27</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=60514">ttouch</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>From: /dev/null</span></dd> <dd><span>Registered: 2012-05-27</span></dd> <dd><span>Posts: 129</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=60514">Email</a></span> <span class="website"><a href="http://dzervas.gr" rel="nofollow">Website</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <p>Any help please?<br />I would be very glad if I could enjoy bf3 without dual-booting...</p> </div> <div class="postsignature postmsg"><hr /><p><a href="http://github.com/ttouch" rel="nofollow">GitHub</a> | <a href="http://git.dzervas.gr" rel="nofollow">Git Server</a> | <a href="http://dzervas.gr" rel="nofollow">Blog</a></p></div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1332308">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1332322" class="blockpost rowodd"> <h2><span><span class="conr">#519</span> <a href="viewtopic.php?pid=1332322#p1332322">2013-10-02 14:09:35</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=75534">El_Presidente</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2013-10-02</span></dd> <dd><span>Posts: 1</span></dd> <dd class="usercontacts"><span class="email"><a href="mailto:mwolf@adiumentum.com">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>ttouch wrote:</cite><blockquote><div><p>Any help please?<br />I would be very glad if I could enjoy bf3 without dual-booting...</p></div></blockquote></div><p>i think you have not enabled vt-d within the kernel. i dont see &quot;intel_iommu=on&quot; in your kernel command line.</p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1332322">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1332328" class="blockpost roweven"> <h2><span><span class="conr">#520</span> <a href="viewtopic.php?pid=1332328#p1332328">2013-10-02 14:36:19</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=60514">ttouch</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>From: /dev/null</span></dd> <dd><span>Registered: 2012-05-27</span></dd> <dd><span>Posts: 129</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=60514">Email</a></span> <span class="website"><a href="http://dzervas.gr" rel="nofollow">Website</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <p>ooo, thank you very much... it now binds <img src="https://bbs.archlinux.org/img/smilies/smile.png" width="15" height="15" alt="smile" /><br />I&#039;ll edit if I find any other problem...</p><p>EDIT: I get blank screen when I try to run qemu (the patched for mainline one) and in dmesg I get: &quot;vfio-pci 0000:02:00.0: Invalid ROM contents&quot;<br />Googling proved fruitless and I saw the same problem on the first page and there was no solution...<br />Also qemu reports: &quot;qemu-system-x86_64: -device vfio-pci,host=02:00.0,bus=root.1,addr=00.0,multifunction=on,x-vga=on: Warning, device 0000:02:00.0 does not support reset&quot;</p><p>EDIT 2: Long boot cause found, completely irrelevant</p> <p class="postedit"><em>Last edited by ttouch (2013-10-04 19:47:18)</em></p> </div> <div class="postsignature postmsg"><hr /><p><a href="http://github.com/ttouch" rel="nofollow">GitHub</a> | <a href="http://git.dzervas.gr" rel="nofollow">Git Server</a> | <a href="http://dzervas.gr" rel="nofollow">Blog</a></p></div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1332328">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1332829" class="blockpost rowodd"> <h2><span><span class="conr">#521</span> <a href="viewtopic.php?pid=1332829#p1332829">2013-10-03 19:17:58</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=70922">nbhs</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd class="postavatar"><img src="https://bbs.archlinux.org/img/avatars/70922.jpg?m=1367773811" width="80" height="80" alt="" /></dd> <dd><span>From: Montevideo, Uruguay</span></dd> <dd><span>Registered: 2013-05-02</span></dd> <dd><span>Posts: 402</span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>SpacePirate wrote:</cite><blockquote><div><p>I just wanted to start trying this on&#160; my new machine. When building the qemu-git package from the AUR it conflicts with some files by seasbios...<br />Do i still need seabios or was its functionality merged into qemu itself?</p><p>EDIT: I just recognized something in the first post. The output of &quot;dmesg | grep pci-stub&quot; contains one line more than one would expect with the posted kernel parameters. I suppose the next pci device is a USB-Controller you added in your configuration (?).</p><p>EDIT2: So i tried to run this on my machine, but it does not seem to work. I installed the linux-mainline (3.11), qemu (1.6) and seabios (1.7.3) from the packagebuilds you posted. IOMMU is enabled, the pci-bind kernel boot parameter is set and i execute the vfio-bind script using your systemctl service.</p><div class="codebox"><pre><code># dmesg | grep -iE &#039;iommu|vfio|pci-bind&#039; [ 0.848089] AMD-Vi: Found IOMMU at 0000:00:00.2 cap 0x40 [ 0.970713] VFIO - User Level meta-driver version: 0.3 [ 229.648012] vfio-pci 0000:06:00.0: enabling device (0000 -&gt; 0003) [ 476.262919] vfio-pci 0000:06:00.1: enabling device (0000 -&gt; 0002) # lspci 06:00.0 VGA compatible controller: Advanced Micro Devices, Inc. [AMD/ATI] Caicos [Radeon HD 6450/7450/8450] 06:00.1 Audio device: Advanced Micro Devices, Inc. [AMD/ATI] Caicos HDMI Audio [Radeon HD 6400 Series] # lspci -n 06:00.0 0300: 1002:6779 06:00.1 0403: 1002:aa98 # cat /etc/vfio-pci.cfg DEVICES=&quot;0000:06:00.1 0000:06:00.1&quot;</code></pre></div><p>This is the script i use to run the VM: (it`s easier to edit the commands in there)</p><div class="codebox"><pre><code>#!/bin/sh qemu-system-x86_64 -enable-kvm -M q35 -m 1024 -cpu host \ -smp 6,sockets=1,cores=6,threads=1 \ -bios /usr/share/qemu/bios.bin -vga none \ -device ioh3420,bus=pcie.0,addr=1c.0,multifunction=on,port=1,chassis=1,id=root.1 \ -device vfio-pci,host=06:00.0,bus=root.1,addr=00.0,multifunction=on,x-vga=on \ -device vfio-pci,host=06:00.1,bus=root.1,addr=00.1</code></pre></div><p>When i run the vm, my main screen goes black after switching to tty2 and back again its normal again (i suppose its a Gnome or X bug). I have an empty qemu window. After plugging my monitor to the second GPU i get no signal from it.<br />Some thoughts i had on what could cause the problem:<br />- maybe the 6450 doesnt support switching? I want to use my 7870 but i cant choose my primary boot device in bios so i need to change the slots (havent done that yet)<br />- do i need to have the monitor plugged in, when the vm starts?</p><p>Any help is greatly appreciated!</p></div></blockquote></div><p>Could you post your specs?</p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1332829">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1332892" class="blockpost roweven"> <h2><span><span class="conr">#522</span> <a href="viewtopic.php?pid=1332892#p1332892">2013-10-03 21:51:01</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=75076">SpacePirate</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2013-09-16</span></dd> <dd><span>Posts: 55</span></dd> <dd class="usercontacts"><span class="email"><a href="mailto:hiduei@gmx.de">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>nbhs wrote:</cite><blockquote><div><div class="quotebox"><cite>SpacePirate wrote:</cite><blockquote><div><p>...</p></div></blockquote></div><p>Could you post your specs?</p></div></blockquote></div><p>CPU:&#160; &#160;AMD FX-8350<br />MB:&#160; &#160; &#160;Gigabyte 970A-UD3<br />GPU1: Gigabyte HD7870 GHz<br />GPU2: Saphire HD6450</p><p>+ 16GiB RAM</p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1332892">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1332895" class="blockpost rowodd"> <h2><span><span class="conr">#523</span> <a href="viewtopic.php?pid=1332895#p1332895">2013-10-03 21:54:39</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=70922">nbhs</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd class="postavatar"><img src="https://bbs.archlinux.org/img/avatars/70922.jpg?m=1367773811" width="80" height="80" alt="" /></dd> <dd><span>From: Montevideo, Uruguay</span></dd> <dd><span>Registered: 2013-05-02</span></dd> <dd><span>Posts: 402</span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>SpacePirate wrote:</cite><blockquote><div><div class="quotebox"><cite>nbhs wrote:</cite><blockquote><div><div class="quotebox"><cite>SpacePirate wrote:</cite><blockquote><div><p>...</p></div></blockquote></div><p>Could you post your specs?</p></div></blockquote></div><p>CPU:&#160; &#160;AMD FX-8350<br />MB:&#160; &#160; &#160;Gigabyte 970A-UD3<br />GPU1: Gigabyte HD7870 GHz<br />GPU2: Saphire HD6450</p><p>+ 16GiB RAM</p></div></blockquote></div><p>Are you using the catalyst drivers?, are you using pci-stub to &quot;hide&quot; the card?</p> <p class="postedit"><em>Last edited by nbhs (2013-10-03 21:58:13)</em></p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1332895">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1332939" class="blockpost roweven"> <h2><span><span class="conr">#524</span> <a href="viewtopic.php?pid=1332939#p1332939">2013-10-04 00:02:51</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=75076">SpacePirate</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2013-09-16</span></dd> <dd><span>Posts: 55</span></dd> <dd class="usercontacts"><span class="email"><a href="mailto:hiduei@gmx.de">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>nbhs wrote:</cite><blockquote><div><div class="quotebox"><cite>SpacePirate wrote:</cite><blockquote><div><div class="quotebox"><cite>nbhs wrote:</cite><blockquote><div><p>Could you post your specs?</p></div></blockquote></div><p>CPU:&#160; &#160;AMD FX-8350<br />MB:&#160; &#160; &#160;Gigabyte 970A-UD3<br />GPU1: Gigabyte HD7870 GHz<br />GPU2: Saphire HD6450</p><p>+ 16GiB RAM</p></div></blockquote></div><p>Are you using the catalyst drivers?, are you using pci-stub to &quot;hide&quot; the card?</p></div></blockquote></div><p>Yes i use pci-stub, but the open source drivers.</p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1332939">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1333216" class="blockpost rowodd"> <h2><span><span class="conr">#525</span> <a href="viewtopic.php?pid=1333216#p1333216">2013-10-04 20:58:14</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=75590">aw</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2013-10-04</span></dd> <dd><span>Posts: 921</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=75590">Email</a></span> <span class="website"><a href="http://vfio.blogspot.com/" rel="nofollow">Website</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <p>Code status update:</p><p>Linux v3.12 includes support for bus reset and the VFIO interfaces to use it, so you can update to the latest rc release and hopefully throw away any kernel patches you&#039;ve been using.</p><p>On the QEMU front, you&#039;ll need to get this series to match the above:</p><p><a href="http://lists.nongnu.org/archive/html/qemu-devel/2013-10/msg00494.html" rel="nofollow">http://lists.nongnu.org/archive/html/qe … 00494.html</a></p><p>Apply to latest qemu.git or pull my tag.</p><p>In addition to the bus reset, I&#039;ve reworked how and when we read the device option ROM, so if you previously needed to supply a romfile= to make things work, try without it.</p><p>Also, this patch should hopefully solve the Code 43 issues with Nvidia on Intel for many of you:</p><p><a href="http://lists.nongnu.org/archive/html/qemu-devel/2013-10/msg00597.html" rel="nofollow">http://lists.nongnu.org/archive/html/qe … 00597.html</a></p><p>Thanks,<br />Alex</p> </div> <div class="postsignature postmsg"><hr /><p><a href="http://vfio.blogspot.com" rel="nofollow">http://vfio.blogspot.com</a><br />Looking for a more open forum to discuss vfio related uses?&#160; Try <a href="https://www.redhat.com/mailman/listinfo/vfio-users" rel="nofollow">https://www.redhat.com/mailman/listinfo/vfio-users</a></p></div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1333216">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div class="postlinksb"> <div class="inbox crumbsplus"> <div class="pagepost"> <p class="pagelink conl"><span class="pages-label">Pages: </span><a rel="prev" class="item1" href="viewtopic.php?id=162768&amp;p=20">Previous</a> <a href="viewtopic.php?id=162768">1</a> <span class="spacer">…</span> <a href="viewtopic.php?id=162768&amp;p=19">19</a> <a href="viewtopic.php?id=162768&amp;p=20">20</a> <strong>21</strong> <a href="viewtopic.php?id=162768&amp;p=22">22</a> <a href="viewtopic.php?id=162768&amp;p=23">23</a> <span class="spacer">…</span> <a href="viewtopic.php?id=162768&amp;p=234">234</a> <a rel="next" href="viewtopic.php?id=162768&amp;p=22">Next</a></p> <p class="postlink conr">Topic closed</p> </div> <ul class="crumbs"> <li><a href="index.php">Index</a></li> <li><span>»&#160;</span><a href="viewforum.php?id=48">Topics Going Nowhere</a></li> <li><span>»&#160;</span><strong><a href="viewtopic.php?id=162768">KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</a></strong></li> </ul> <p class="subscribelink clearb"><a href="misc.php?action=subscribe&amp;tid=162768">Subscribe to this topic</a></p> <div class="clearer"></div> </div> </div> </div> <div id="brdfooter" class="block"> <h2><span>Board footer</span></h2> <div class="box"> <div id="brdfooternav" class="inbox"> <div class="conl"> <form id="qjump" method="get" action="viewforum.php"> <div><label><span>Jump to<br /></span> <select name="id" onchange="window.location=('viewforum.php?id='+this.options[this.selectedIndex].value)"> <optgroup label="Technical Issues and Assistance"> <option value="23">Newbie Corner</option> <option value="17">Installation</option> <option value="22">Kernel &amp; Hardware</option> <option value="18">Applications &amp; Desktop Environments</option> <option value="31">Laptop Issues</option> <option value="8">Networking, Server, and Protection</option> <option value="32">Multimedia and Games</option> <option value="50">System Administration</option> <option value="35">Other Architectures</option> </optgroup> <optgroup label="Arch-centric"> <option value="24">Announcements, Package &amp; Security Advisories</option> <option value="1">Arch Discussion</option> <option value="13">Forum &amp; Wiki discussion</option> </optgroup> <optgroup label="Pacman Upgrades, Packaging &amp; AUR"> <option value="44">Pacman &amp; Package Upgrade Issues</option> <option value="49">[testing] Repo Forum</option> <option value="4">Creating &amp; Modifying Packages</option> <option value="38">AUR Issues, Discussion &amp; PKGBUILD Requests</option> </optgroup> <optgroup label="Contributions &amp; Discussion"> <option value="20">GNU/Linux Discussion</option> <option value="27">Community Contributions</option> <option value="33">Programming &amp; Scripting</option> <option value="30">Other Languages</option> <option value="47">Artwork and Screenshots</option> <option value="42">Try This</option> </optgroup> <optgroup label="/dev/null"> <option value="29">Off-Topic</option> <option value="48" selected="selected">Topics Going Nowhere</option> <option value="36">Dustbin</option> </optgroup> </select></label> <input type="submit" value=" Go " accesskey="g" /> </div> </form> </div> <div class="conr"> <p id="feedlinks"><span class="atom"><a href="extern.php?action=feed&amp;tid=162768&amp;type=atom">Atom topic feed</a></span></p> <p id="poweredby">Powered by <a href="http://fluxbb.org/">FluxBB</a></p> </div> <div class="clearer"></div> </div> </div> </div> </div> <div class="end-box"></div> </div> </body> </html>
