<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"> <html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en" dir="ltr"> <head> <meta http-equiv="Content-Type" content="text/html; charset=utf-8" /> <title>KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9 (Page 131) / Topics Going Nowhere / Arch Linux Forums</title> <link rel="stylesheet" type="text/css" href="style/ArchLinux.css" /> <link rel="canonical" href="viewtopic.php?id=162768&amp;p=131" title="Page 131" /> <link rel="prev" href="viewtopic.php?id=162768&amp;p=130" title="Page 130" /> <link rel="next" href="viewtopic.php?id=162768&amp;p=132" title="Page 132" /> <link rel="alternate" type="application/atom+xml" href="extern.php?action=feed&amp;tid=162768&amp;type=atom" title="Atom topic feed" /> <link rel="stylesheet" media="screen" href="style/ArchLinux/arch.css?v=3" /> <link rel="stylesheet" media="screen" href="style/ArchLinux/archnavbar.css?v=2" /> <link rel="shortcut icon" href="style/ArchLinux/favicon.ico" /> </head> <body> <div id="archnavbar" class="anb-forum"> <div id="archnavbarlogo"><h1><a href="http://www.archlinux.org/">Arch Linux</a></h1></div> <div id="archnavbarmenu"> <ul id="archnavbarlist"> <li id="anb-home"><a href="http://www.archlinux.org/">Home</a></li><li id="anb-packages"><a href="http://www.archlinux.org/packages/">Packages</a></li><li id="anb-forums" class="anb-selected"><a href="https://bbs.archlinux.org/">Forums</a></li><li id="anb-wiki"><a href="https://wiki.archlinux.org/">Wiki</a></li><li id="anb-bugs"><a href="https://bugs.archlinux.org/">Bugs</a></li><li id="anb-aur"><a href="https://aur.archlinux.org/">AUR</a></li><li id="anb-download"><a href="http://www.archlinux.org/download/">Download</a></li> </ul> </div> </div> <div id="punviewtopic" class="pun"> <div class="top-box"></div> <div class="punwrap"> <div id="brdheader" class="block"> <div class="box"> <div id="brdmenu" class="inbox"> <ul> <li id="navindex" class="isactive"><a href="index.php">Index</a></li> <li id="navuserlist"><a href="userlist.php">User list</a></li> <li id="navsearch"><a href="search.php">Search</a></li> <li id="navprofile"><a href="profile.php?id=80749">Profile</a></li> <li id="navlogout"><a href="login.php?action=out&amp;id=80749&amp;csrf_token=5c20501ec397bb45ef8ee8c84db232c8d8e421c6">Logout</a></li> </ul> </div> <div id="brdwelcome" class="inbox"> <ul class="conl"> <li><span>Logged in as <strong>SXX</strong></span></li> <li><span>Last visit: 2015-08-16 12:20:09</span></li> </ul> <ul class="conr"> <li><span>Topics: <a href="search.php?action=show_replies" title="Find topics you have posted to.">Posted</a> | <a href="search.php?action=show_new" title="Find topics with new posts since your last visit.">New</a> | <a href="search.php?action=show_recent" title="Find topics with recent posts.">Active</a> | <a href="search.php?action=show_unanswered" title="Find topics with no replies.">Unanswered</a></span></li> </ul> <div class="clearer"></div> </div> </div> </div> <div id="brdmain"> <div class="linkst"> <div class="inbox crumbsplus"> <ul class="crumbs"> <li><a href="index.php">Index</a></li> <li><span>»&#160;</span><a href="viewforum.php?id=48">Topics Going Nowhere</a></li> <li><span>»&#160;</span><strong><a href="viewtopic.php?id=162768">KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</a></strong></li> </ul> <div class="pagepost"> <p class="pagelink conl"><span class="pages-label">Pages: </span><a rel="prev" class="item1" href="viewtopic.php?id=162768&amp;p=130">Previous</a> <a href="viewtopic.php?id=162768">1</a> <span class="spacer">…</span> <a href="viewtopic.php?id=162768&amp;p=129">129</a> <a href="viewtopic.php?id=162768&amp;p=130">130</a> <strong>131</strong> <a href="viewtopic.php?id=162768&amp;p=132">132</a> <a href="viewtopic.php?id=162768&amp;p=133">133</a> <span class="spacer">…</span> <a href="viewtopic.php?id=162768&amp;p=234">234</a> <a rel="next" href="viewtopic.php?id=162768&amp;p=132">Next</a></p> <p class="postlink conr">Topic closed</p> </div> <div class="clearer"></div> </div> </div> <div id="p1475170" class="blockpost rowodd blockpost1"> <h2><span><span class="conr">#3251</span> <a href="viewtopic.php?pid=1475170#p1475170">2014-11-13 21:34:08</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=77842">Flyser</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2013-12-19</span></dd> <dd><span>Posts: 29</span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>Denso wrote:</cite><blockquote><div><div class="quotebox"><cite>Flyser wrote:</cite><blockquote><div><p>I set the Quadro k4000 pci ids for my GTX660</p></div></blockquote></div><p>Can you explain how did you achieve that without soldering iron ?</p><p>Thank you .</p></div></blockquote></div><p>I applied the patch aw wrote ( <a href="http://fpaste.org/149722/72280914/" rel="nofollow">http://fpaste.org/149722/72280914/</a> ) and added x-vid=0x10DE,x-did=0x11FA,x-ss-vid=0x10DE,x-ss-did=0x097C,romfile=/path/to/quadro-k4000-bios.rom to the gpu assignment in the qemu cmdline</p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1475170">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1475172" class="blockpost roweven"> <h2><span><span class="conr">#3252</span> <a href="viewtopic.php?pid=1475172#p1475172">2014-11-13 21:38:32</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=86302">4kGamer</a></strong></dt> <dd class="usertitle"><strong>Banned</strong></dd> <dd><span>Registered: 2014-10-29</span></dd> <dd><span>Posts: 82</span></dd> <dd class="usercontacts"><span class="email"><a href="mailto:oktayaslantas@gmx.de">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <p>hi Alex, thank you, I got every command from your blog. That&#039;s what I did and at first it worked. After some reboot it doesn&#039;t. I reinstalled Windows 4-5 times today, but I couldn&#039;t replicate the success I initially had. I assume it must be something I did, I just don&#039;t know what ...</p><br /><p>Does it matter WHEN I remove those lines? Or when I add the </p><p>&#160; &#160; &lt;kvm&gt;<br />&#160; &#160; &#160; &lt;hidden state=&#039;on&#039;/&gt;<br />&#160; &#160; &lt;/kvm&gt;</p><p>line?</p> <p class="postedit"><em>Last edited by 4kGamer (2014-11-13 21:39:17)</em></p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1475172">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1475174" class="blockpost rowodd"> <h2><span><span class="conr">#3253</span> <a href="viewtopic.php?pid=1475174#p1475174">2014-11-13 21:45:24</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=75590">aw</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2013-10-04</span></dd> <dd><span>Posts: 921</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=75590">Email</a></span> <span class="website"><a href="http://vfio.blogspot.com/" rel="nofollow">Website</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>4kGamer wrote:</cite><blockquote><div><p>hi Alex, thank you, I got every command from your blog. That&#039;s what I did and at first it worked. After some reboot it doesn&#039;t. I reinstalled Windows 4-5 times today, but I couldn&#039;t replicate the success I initially had. I assume it must be something I did, I just don&#039;t know what ...</p><br /><p>Does it matter WHEN I remove those lines? Or when I add the </p><p>&#160; &#160; &lt;kvm&gt;<br />&#160; &#160; &#160; &lt;hidden state=&#039;on&#039;/&gt;<br />&#160; &#160; &lt;/kvm&gt;</p><p>line?</p></div></blockquote></div><p>Not that I&#039;m aware of.&#160; I just updated my 440FX/OVMF/8.1/GTX750 VM to 344.65 and it still works, so apparently no new subversion.</p> </div> <div class="postsignature postmsg"><hr /><p><a href="http://vfio.blogspot.com" rel="nofollow">http://vfio.blogspot.com</a><br />Looking for a more open forum to discuss vfio related uses?&#160; Try <a href="https://www.redhat.com/mailman/listinfo/vfio-users" rel="nofollow">https://www.redhat.com/mailman/listinfo/vfio-users</a></p></div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1475174">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1475177" class="blockpost roweven"> <h2><span><span class="conr">#3254</span> <a href="viewtopic.php?pid=1475177#p1475177">2014-11-13 21:56:51</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=86302">4kGamer</a></strong></dt> <dd class="usertitle"><strong>Banned</strong></dd> <dd><span>Registered: 2014-10-29</span></dd> <dd><span>Posts: 82</span></dd> <dd class="usercontacts"><span class="email"><a href="mailto:oktayaslantas@gmx.de">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <p>ok, thank you. I&#039;ll keep on trying. Will post as soon as it (hopefully) works.</p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1475177">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1475246" class="blockpost rowodd"> <h2><span><span class="conr">#3255</span> <a href="viewtopic.php?pid=1475246#p1475246">2014-11-14 04:39:46</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=84760">Denso</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd class="postavatar"><img src="https://bbs.archlinux.org/img/avatars/84760.png?m=1412533733" width="71" height="80" alt="" /></dd> <dd><span>Registered: 2014-08-30</span></dd> <dd><span>Posts: 179</span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>Flyser wrote:</cite><blockquote><div><p>I applied the patch aw wrote ( <a href="http://fpaste.org/149722/72280914/" rel="nofollow">http://fpaste.org/149722/72280914/</a> ) and added x-vid=0x10DE,x-did=0x11FA,x-ss-vid=0x10DE,x-ss-did=0x097C,romfile=/path/to/quadro-k4000-bios.rom to the gpu assignment in the qemu cmdline</p></div></blockquote></div><p>Thanks for sharing ! As I said , I saw no real life difference with Hv enhancements on or off (Maybe those who encode videos alot would) . I&#039;ll keep my stable configuration for now <img src="https://bbs.archlinux.org/img/smilies/smile.png" width="15" height="15" alt="smile" /></p><p>EDIT :</p><p>@aw </p><p>I recieved this error two times uptil now :</p><div class="codebox"><pre><code>[Thu Nov 13 03:13:21 2014] pcieport 0000:00:03.0: AER: Multiple Corrected error received: id=0018 [Thu Nov 13 03:13:21 2014] pcieport 0000:00:03.0: PCIe Bus Error: severity=Corrected, type=Data Link Layer, id=0018(Receiver ID) [Thu Nov 13 03:13:21 2014] pcieport 0000:00:03.0: device [8086:2f08] error status/mask=00000040/00002000 [Thu Nov 13 03:13:21 2014] pcieport 0000:00:03.0: [ 6] Bad TLP</code></pre></div><br /><br /><p>I didn&#039;t notice anything while using the VM or the host though . I&#039;m using 3.18-rc4 + ACS patch .</p> <p class="postedit"><em>Last edited by Denso (2014-11-14 05:23:22)</em></p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1475246">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1475315" class="blockpost roweven"> <h2><span><span class="conr">#3256</span> <a href="viewtopic.php?pid=1475315#p1475315">2014-11-14 10:16:48</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=85314">Duelist</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2014-09-22</span></dd> <dd><span>Posts: 358</span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>Denso wrote:</cite><blockquote><div><div class="codebox"><pre><code>[Thu Nov 13 03:13:21 2014] pcieport 0000:00:03.0: AER: Multiple Corrected error received: id=0018 [Thu Nov 13 03:13:21 2014] pcieport 0000:00:03.0: PCIe Bus Error: severity=Corrected, type=Data Link Layer, id=0018(Receiver ID) [Thu Nov 13 03:13:21 2014] pcieport 0000:00:03.0: device [8086:2f08] error status/mask=00000040/00002000 [Thu Nov 13 03:13:21 2014] pcieport 0000:00:03.0: [ 6] Bad TLP</code></pre></div><p>I didn&#039;t notice anything while using the VM or the host though . I&#039;m using 3.18-rc4 + ACS patch .</p></div></blockquote></div><p>No surprise you didn&#039;t notice anything.<br />There happened an error on the pci-e bus that was corrected. The error was noted by the device ID 0018(00:18.0?), as far as i understood, and it is your cpu&#039;s root port.<br />That maay be related to ACS.<br />Don&#039;t you have the new X99 chipset, where aw haven&#039;t got the letter confirming device isolation from intel?</p> </div> <div class="postsignature postmsg"><hr /><p><span class="bbs">The forum rules prohibit requesting support for distributions other than arch.</span><br /><a href="https://bbs.archlinux.org/viewtopic.php?pid=1551460#p1551460" rel="nofollow">I gave up.</a><a href="https://bbs.archlinux.org/viewtopic.php?id=162768" rel="nofollow"> It was too late.</a><br /><a href="http://pastebin.com/B3fL84bq" rel="nofollow">What I was trying to do</a>.<br /><a href="http://vfio.blogspot.com/" rel="nofollow">The reference about VFIO and KVM VGA passthrough.</a></p></div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1475315">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1475316" class="blockpost rowodd"> <h2><span><span class="conr">#3257</span> <a href="viewtopic.php?pid=1475316#p1475316">2014-11-14 10:27:59</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=84760">Denso</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd class="postavatar"><img src="https://bbs.archlinux.org/img/avatars/84760.png?m=1412533733" width="71" height="80" alt="" /></dd> <dd><span>Registered: 2014-08-30</span></dd> <dd><span>Posts: 179</span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>Duelist wrote:</cite><blockquote><div><p>No surprise you didn&#039;t notice anything.<br />There happened an error on the pci-e bus that was corrected. The error was noted by the device ID 0018(00:18.0?), as far as i understood, and it is your cpu&#039;s root port.<br />That maay be related to ACS.<br />Don&#039;t you have the new X99 chipset, where aw haven&#039;t got the letter confirming device isolation from intel?</p></div></blockquote></div><p>Well , there is no 00:18.0 device reported by lspci , but the error shows &quot;00:03.0&quot; which is :</p><div class="codebox"><pre><code>00:03.0 PCI bridge: Intel Corporation Xeon E5 v3/Core i7 PCI Express Root Port 3 (rev 02) 00:03.2 PCI bridge: Intel Corporation Xeon E5 v3/Core i7 PCI Express Root Port 3 (rev 02)</code></pre></div><p>And yes , I have the X99 platform , and I&#039;m by no means a coder or a kernel hacker , I just applied the ACS patch and -to me as an end user- it just &quot;works&quot; . lol . Host + VMs are very stable (for around 2 days uptil this moment) .</p><p>Also editing the quirks.c file and inserting the X99 device IDs manually does the same thing .</p> <p class="postedit"><em>Last edited by Denso (2014-11-14 10:29:16)</em></p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1475316">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1475346" class="blockpost roweven"> <h2><span><span class="conr">#3258</span> <a href="viewtopic.php?pid=1475346#p1475346">2014-11-14 12:53:10</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=86669">cshark</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2014-11-14</span></dd> <dd><span>Posts: 1</span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <p>I have done the basic steps described in the article and qemu works as espected when invoked with the test setup. Now I want to use virt-manager with libvirt, so I created the important xml part with </p><div class="codebox"><pre><code># virsh native-to-domxml qemu-args &lt;file with args&gt;</code></pre></div><p>which gave me some xml file with the device args as qemu args. I was wondering, why the devices were &quot;only&quot; arguments and had no proper xml tag, but I guess it&#039;s okay. So I created a new vm with virt-manager and added the important parts to the xml file. My final xml looks like this:</p><div class="codebox"><pre class="vscroll"><code>&lt;domain type=&#039;kvm&#039; xmlns:qemu=&#039;http://libvirt.org/schemas/domain/qemu/1.0&#039;&gt; &lt;name&gt;win7&lt;/name&gt; &lt;uuid&gt;c344a358-33bc-4398-b223-4054d6e61680&lt;/uuid&gt; &lt;memory unit=&#039;KiB&#039;&gt;4194304&lt;/memory&gt; &lt;currentMemory unit=&#039;KiB&#039;&gt;4194304&lt;/currentMemory&gt; &lt;vcpu placement=&#039;static&#039;&gt;3&lt;/vcpu&gt; &lt;os&gt; &lt;type arch=&#039;x86_64&#039; machine=&#039;pc-q35-2.1&#039;&gt;hvm&lt;/type&gt; &lt;bootmenu enable=&#039;yes&#039;/&gt; &lt;/os&gt; &lt;features&gt; &lt;acpi/&gt; &lt;apic/&gt; &lt;pae/&gt; &lt;hyperv&gt; &lt;relaxed state=&#039;on&#039;/&gt; &lt;vapic state=&#039;on&#039;/&gt; &lt;spinlocks state=&#039;on&#039; retries=&#039;8191&#039;/&gt; &lt;/hyperv&gt; &lt;/features&gt; &lt;cpu mode=&#039;host-model&#039;&gt; &lt;model fallback=&#039;allow&#039;/&gt; &lt;/cpu&gt; &lt;clock offset=&#039;localtime&#039;&gt; &lt;timer name=&#039;rtc&#039; tickpolicy=&#039;catchup&#039;/&gt; &lt;timer name=&#039;pit&#039; tickpolicy=&#039;delay&#039;/&gt; &lt;timer name=&#039;hpet&#039; present=&#039;no&#039;/&gt; &lt;timer name=&#039;hypervclock&#039; present=&#039;yes&#039;/&gt; &lt;/clock&gt; &lt;on_poweroff&gt;destroy&lt;/on_poweroff&gt; &lt;on_reboot&gt;destroy&lt;/on_reboot&gt; &lt;on_crash&gt;destroy&lt;/on_crash&gt; &lt;pm&gt; &lt;suspend-to-mem enabled=&#039;no&#039;/&gt; &lt;suspend-to-disk enabled=&#039;no&#039;/&gt; &lt;/pm&gt; &lt;devices&gt; &lt;emulator&gt;/usr/local/bin/kvm&lt;/emulator&gt; &lt;disk type=&#039;block&#039; device=&#039;disk&#039;&gt; &lt;driver name=&#039;qemu&#039; type=&#039;raw&#039; cache=&#039;none&#039; io=&#039;native&#039;/&gt; &lt;source dev=&#039;/dev/sdb2&#039;/&gt; &lt;target dev=&#039;vda&#039; bus=&#039;virtio&#039;/&gt; &lt;boot order=&#039;2&#039;/&gt; &lt;address type=&#039;pci&#039; domain=&#039;0x0000&#039; bus=&#039;0x02&#039; slot=&#039;0x03&#039; function=&#039;0x0&#039;/&gt; &lt;/disk&gt; &lt;disk type=&#039;block&#039; device=&#039;cdrom&#039;&gt; &lt;driver name=&#039;qemu&#039; type=&#039;raw&#039;/&gt; &lt;source dev=&#039;/dev/sr0&#039;/&gt; &lt;target dev=&#039;hda&#039; bus=&#039;ide&#039;/&gt; &lt;readonly/&gt; &lt;boot order=&#039;1&#039;/&gt; &lt;address type=&#039;drive&#039; controller=&#039;0&#039; bus=&#039;0&#039; target=&#039;0&#039; unit=&#039;0&#039;/&gt; &lt;/disk&gt; &lt;controller type=&#039;usb&#039; index=&#039;0&#039; model=&#039;ich9-ehci1&#039;&gt; &lt;address type=&#039;pci&#039; domain=&#039;0x0000&#039; bus=&#039;0x02&#039; slot=&#039;0x02&#039; function=&#039;0x7&#039;/&gt; &lt;/controller&gt; &lt;controller type=&#039;usb&#039; index=&#039;0&#039; model=&#039;ich9-uhci1&#039;&gt; &lt;master startport=&#039;0&#039;/&gt; &lt;address type=&#039;pci&#039; domain=&#039;0x0000&#039; bus=&#039;0x02&#039; slot=&#039;0x02&#039; function=&#039;0x0&#039; multifunction=&#039;on&#039;/&gt; &lt;/controller&gt; &lt;controller type=&#039;usb&#039; index=&#039;0&#039; model=&#039;ich9-uhci2&#039;&gt; &lt;master startport=&#039;2&#039;/&gt; &lt;address type=&#039;pci&#039; domain=&#039;0x0000&#039; bus=&#039;0x02&#039; slot=&#039;0x02&#039; function=&#039;0x1&#039;/&gt; &lt;/controller&gt; &lt;controller type=&#039;usb&#039; index=&#039;0&#039; model=&#039;ich9-uhci3&#039;&gt; &lt;master startport=&#039;4&#039;/&gt; &lt;address type=&#039;pci&#039; domain=&#039;0x0000&#039; bus=&#039;0x02&#039; slot=&#039;0x02&#039; function=&#039;0x2&#039;/&gt; &lt;/controller&gt; &lt;controller type=&#039;sata&#039; index=&#039;0&#039;&gt; &lt;address type=&#039;pci&#039; domain=&#039;0x0000&#039; bus=&#039;0x00&#039; slot=&#039;0x1f&#039; function=&#039;0x2&#039;/&gt; &lt;/controller&gt; &lt;controller type=&#039;pci&#039; index=&#039;0&#039; model=&#039;pcie-root&#039;/&gt; &lt;controller type=&#039;pci&#039; index=&#039;1&#039; model=&#039;dmi-to-pci-bridge&#039;&gt; &lt;address type=&#039;pci&#039; domain=&#039;0x0000&#039; bus=&#039;0x00&#039; slot=&#039;0x1e&#039; function=&#039;0x0&#039;/&gt; &lt;/controller&gt; &lt;controller type=&#039;pci&#039; index=&#039;2&#039; model=&#039;pci-bridge&#039;&gt; &lt;address type=&#039;pci&#039; domain=&#039;0x0000&#039; bus=&#039;0x01&#039; slot=&#039;0x01&#039; function=&#039;0x0&#039;/&gt; &lt;/controller&gt; &lt;controller type=&#039;ide&#039; index=&#039;0&#039;/&gt; &lt;interface type=&#039;network&#039;&gt; &lt;mac address=&#039;52:54:00:36:e7:5a&#039;/&gt; &lt;source network=&#039;virtnetwork&#039;/&gt; &lt;model type=&#039;rtl8139&#039;/&gt; &lt;address type=&#039;pci&#039; domain=&#039;0x0000&#039; bus=&#039;0x02&#039; slot=&#039;0x01&#039; function=&#039;0x0&#039;/&gt; &lt;/interface&gt; &lt;serial type=&#039;pty&#039;&gt; &lt;target port=&#039;0&#039;/&gt; &lt;/serial&gt; &lt;console type=&#039;pty&#039;&gt; &lt;target type=&#039;serial&#039; port=&#039;0&#039;/&gt; &lt;/console&gt; &lt;input type=&#039;tablet&#039; bus=&#039;usb&#039;/&gt; &lt;memballoon model=&#039;virtio&#039;&gt; &lt;address type=&#039;pci&#039; domain=&#039;0x0000&#039; bus=&#039;0x02&#039; slot=&#039;0x06&#039; function=&#039;0x0&#039;/&gt; &lt;/memballoon&gt; &lt;/devices&gt; &lt;qemu:commandline&gt; &lt;qemu:arg value=&#039;-enable-kvm&#039;/&gt; &lt;qemu:arg value=&#039;-device ioh3420,bus=pcie.0,addr=1c.0,multifunction=on,port=1,chassis=1,id=root.1&#039;/&gt; &lt;qemu:arg value=&#039;-device vfio-pci,host=02:00.0,bus=root.1,addr=00.0,multifunction=on,x-vga=on&#039;/&gt; &lt;qemu:arg value=&#039;-device vfio-pci,host=02:00.1,bus=root.1,addr=00.1&#039;/&gt; &lt;/qemu:commandline&gt; &lt;/domain&gt;</code></pre></div><p>But when I try to start the vm, I get the following error (even as root):</p><div class="codebox"><pre><code>Internal error: early end of file from monitor: possible problem: 2014-11-14T12:25:20.491803Z qemu-system-x86_64: -device vfio-pci,host=02:00.0,bus=root.1,addr=00.0,multifunction=on,x-vga=on: vfio_dma_map(0x7f3e0dbf0c70, 0x0, 0x80000000, 0x7f3ce8000000) = -12 (Cannot allocate memory) 2014-11-14T12:25:20.492686Z qemu-system-x86_64: -device vfio-pci,host=02:00.0,bus=root.1,addr=00.0,multifunction=on,x-vga=on: vfio_dma_map(0x7f3e0dbf0c70, 0x100000000, 0x80000000, 0x7f3d68000000) = -12 (Cannot allocate memory) 2014-11-14T12:25:20.492767Z qemu-system-x86_64: -device vfio-pci,host=02:00.0,bus=root.1,addr=00.0,multifunction=on,x-vga=on: vfio: memory listener initialization failed for container 2014-11-14T12:25:20.492835Z qemu-system-x86_64: -device vfio-pci,host=02:00.0,bus=root.1,addr=00.0,multifunction=on,x-vga=on: vfio: failed to setup container for group 16 2014-11-14T12:25:20.492939Z qemu-system-x86_64: -device vfio-pci,host=02:00.0,bus=root.1,addr=00.0,multifunction=on,x-vga=on: vfio: failed to get group 16 2014-11-14T12:25</code></pre></div><p>I searched a bit, but found nothing about this error... any ideas? Since it has to be either something with libvirt or the config, because the qemu test setup just works fine.</p> <p class="postedit"><em>Last edited by cshark (2014-11-14 12:55:04)</em></p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1475346">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1475400" class="blockpost rowodd"> <h2><span><span class="conr">#3259</span> <a href="viewtopic.php?pid=1475400#p1475400">2014-11-14 16:20:33</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=85963">Rommy</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2014-10-17</span></dd> <dd><span>Posts: 22</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=85963">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <p>Will the two patches (acs override patch + i915 vga arbiter fixes) go into the main linux packages soon? I do not want to build one myself.</p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1475400">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1475461" class="blockpost roweven"> <h2><span><span class="conr">#3260</span> <a href="viewtopic.php?pid=1475461#p1475461">2014-11-14 19:22:29</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=82442">slis</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2014-06-02</span></dd> <dd><span>Posts: 125</span></dd> <dd class="usercontacts"><span class="email"><a href="mailto:xslisx@gmail.com">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <p>&lt;qemu:arg value=&#039;vfio-pci,host=01:00.0,addr=07.0,multifunction=on,x-vga=on,x-vid=0x10DE,x-did=0x11BA,x-ss-vid=0x10DE,x-ss-did=0x0965,romfile=/root/k5000.rom&#039;/&gt;</p><p>I can also confirm it&#039;s working, 680gtx as quadro k5000/or GRIDK2 (0x11BF) with 341.05 drivers with hyperv on windows7.</p><p>edit: as grid k2 also works with geforce driver 344,65 with hyperv on.</p> <p class="postedit"><em>Last edited by slis (2014-11-14 19:46:44)</em></p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1475461">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1475463" class="blockpost rowodd"> <h2><span><span class="conr">#3261</span> <a href="viewtopic.php?pid=1475463#p1475463">2014-11-14 19:26:40</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=75590">aw</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2013-10-04</span></dd> <dd><span>Posts: 921</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=75590">Email</a></span> <span class="website"><a href="http://vfio.blogspot.com/" rel="nofollow">Website</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>Rommy wrote:</cite><blockquote><div><p>Will the two patches (acs override patch + i915 vga arbiter fixes) go into the main linux packages soon? I do not want to build one myself.</p></div></blockquote></div><p>You&#039;ll need to use the OVMF approach and switch hardware then, neither of those are headed upstream.</p> </div> <div class="postsignature postmsg"><hr /><p><a href="http://vfio.blogspot.com" rel="nofollow">http://vfio.blogspot.com</a><br />Looking for a more open forum to discuss vfio related uses?&#160; Try <a href="https://www.redhat.com/mailman/listinfo/vfio-users" rel="nofollow">https://www.redhat.com/mailman/listinfo/vfio-users</a></p></div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1475463">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1475541" class="blockpost roweven"> <h2><span><span class="conr">#3262</span> <a href="viewtopic.php?pid=1475541#p1475541">2014-11-14 23:32:50</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=75590">aw</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2013-10-04</span></dd> <dd><span>Posts: 921</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=75590">Email</a></span> <span class="website"><a href="http://vfio.blogspot.com/" rel="nofollow">Website</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>cshark wrote:</cite><blockquote><div><p>I have done the basic steps described in the article and qemu works as espected when invoked with the test setup. Now I want to use virt-manager with libvirt, so I created the important xml part with </p><div class="codebox"><pre><code># virsh native-to-domxml qemu-args &lt;file with args&gt;</code></pre></div><p>which gave me some xml file with the device args as qemu args. I was wondering, why the devices were &quot;only&quot; arguments and had no proper xml tag, but I guess it&#039;s okay. So I created a new vm with virt-manager and added the important parts to the xml file. My final xml looks like this:</p><div class="codebox"><pre><code> &lt;qemu:commandline&gt; &lt;qemu:arg value=&#039;-enable-kvm&#039;/&gt; &lt;qemu:arg value=&#039;-device ioh3420,bus=pcie.0,addr=1c.0,multifunction=on,port=1,chassis=1,id=root.1&#039;/&gt; &lt;qemu:arg value=&#039;-device vfio-pci,host=02:00.0,bus=root.1,addr=00.0,multifunction=on,x-vga=on&#039;/&gt; &lt;qemu:arg value=&#039;-device vfio-pci,host=02:00.1,bus=root.1,addr=00.1&#039;/&gt; &lt;/qemu:commandline&gt;</code></pre></div><p>But when I try to start the vm, I get the following error (even as root):</p><div class="codebox"><pre><code>Internal error: early end of file from monitor: possible problem: 2014-11-14T12:25:20.491803Z qemu-system-x86_64: -device vfio-pci,host=02:00.0,bus=root.1,addr=00.0,multifunction=on,x-vga=on: vfio_dma_map(0x7f3e0dbf0c70, 0x0, 0x80000000, 0x7f3ce8000000) = -12 (Cannot allocate memory) 2014-11-14T12:25:20.492686Z qemu-system-x86_64: -device vfio-pci,host=02:00.0,bus=root.1,addr=00.0,multifunction=on,x-vga=on: vfio_dma_map(0x7f3e0dbf0c70, 0x100000000, 0x80000000, 0x7f3d68000000) = -12 (Cannot allocate memory) 2014-11-14T12:25:20.492767Z qemu-system-x86_64: -device vfio-pci,host=02:00.0,bus=root.1,addr=00.0,multifunction=on,x-vga=on: vfio: memory listener initialization failed for container 2014-11-14T12:25:20.492835Z qemu-system-x86_64: -device vfio-pci,host=02:00.0,bus=root.1,addr=00.0,multifunction=on,x-vga=on: vfio: failed to setup container for group 16 2014-11-14T12:25:20.492939Z qemu-system-x86_64: -device vfio-pci,host=02:00.0,bus=root.1,addr=00.0,multifunction=on,x-vga=on: vfio: failed to get group 16 2014-11-14T12:25</code></pre></div><p>I searched a bit, but found nothing about this error... any ideas? Since it has to be either something with libvirt or the config, because the qemu test setup just works fine.</p></div></blockquote></div><p>By using &lt;qemu:arg&gt; you&#039;re effectively hiding the assigned device from libvirt and not allowing it setup device access or configure locked memory limits.&#160; My suggestion would be to not use q35 and to use a wrapper script around qemu-system-x86_64 to add the x-vga option, something like:</p><div class="codebox"><pre><code>#!/bin/sh exec qemu-system-x86_64 `echo &quot;\$@&quot; | sed &#039;s|02:00.0|02:00.0,x-vga=on|g&#039;`</code></pre></div><p>Better yet, if the GPU supports UEFI, use OVMF instead and avoid all the hassles of VGA.&#160; Some here claim this works for Windows 7 guests.&#160; See the link in my sig for details.</p> </div> <div class="postsignature postmsg"><hr /><p><a href="http://vfio.blogspot.com" rel="nofollow">http://vfio.blogspot.com</a><br />Looking for a more open forum to discuss vfio related uses?&#160; Try <a href="https://www.redhat.com/mailman/listinfo/vfio-users" rel="nofollow">https://www.redhat.com/mailman/listinfo/vfio-users</a></p></div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1475541">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1475692" class="blockpost rowodd"> <h2><span><span class="conr">#3263</span> <a href="viewtopic.php?pid=1475692#p1475692">2014-11-15 10:03:00</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=58583">Nesousx</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2012-03-27</span></dd> <dd><span>Posts: 46</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=58583">Email</a></span> <span class="website"><a href="https://www.kodi-xbmc.com/" rel="nofollow">Website</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <p>Hi all,</p><p>Just for information, I successfully passed through an Asus GTX 970 Strix from Arch (configured as mentioned in first post). Guest is running Win 7 Pro 64 bits, and here is my command line:</p><div class="codebox"><pre><code>qemu-system-x86_64 -M q35 -enable-kvm \ -m 16384 \ -cpu host,kvm=off -smp 4,sockets=1,cores=4,threads=1 \ -bios /usr/share/qemu/bios.bin -realtime mlock=on -vga none \ -D /var/log/qemu-out.log \ -device ioh3420,bus=pcie.0,addr=1c.0,multifunction=on,port=1,chassis=1,id=root.1 \ -device vfio-pci,host=01:00.0,bus=root.1,addr=00.0,multifunction=on,x-vga=on \ -device vfio-pci,host=01:00.1,bus=pcie.0 \ -device virtio-scsi-pci,id=scsi \ -drive file=/dev/guest/Windaube_7,id=sys,format=raw -device scsi-hd,drive=sys \ -drive file=/dev/guest/win7,id=data,format=raw -device scsi-hd,drive=data \ -device vfio-pci,host=00:1d.0,bus=pcie.0 \ -device virtio-scsi-pci,id=scsi2 \ -net nic,model=virtio -net bridge,br=virbr0 \ -device ich9-intel-hda,bus=pcie.0,addr=1b.0,id=sound0 \ -device hda-duplex,id=sound0-codec0,bus=sound0.0,cad=0</code></pre></div><p>I only had to disable hv-time from CPU flag in order to get rid of Code 43 error (thanks Nvidia...).</p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1475692">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1475830" class="blockpost roweven"> <h2><span><span class="conr">#3264</span> <a href="viewtopic.php?pid=1475830#p1475830">2014-11-15 17:41:54</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=86302">4kGamer</a></strong></dt> <dd class="usertitle"><strong>Banned</strong></dd> <dd><span>Registered: 2014-10-29</span></dd> <dd><span>Posts: 82</span></dd> <dd class="usercontacts"><span class="email"><a href="mailto:oktayaslantas@gmx.de">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <p>I got rid of the <strong>Error Code 43</strong>&#160; </p><p>I am not quite sure what it was, but I started from scratch, built the kernel provided by nbhs (linux-mainline-3.17.2.tar.gz)<br />and threw every command I could find into grub. This is what my command line looks like.</p><div class="quotebox"><blockquote><div><p>GRUB_CMDLINE_LINUX_DEFAULT=&quot;i915.enable_hd_vgaarb=1 intel_iommu=on pcie_acs_override=downstream vfio_iommu_type1.allow_unsafe_interrupts=1 quiet&quot;</p></div></blockquote></div><p><strong>BUT (there always seems to be a but...)</strong></p><p>I have weird audio issues: There is some scratching in the audio. And performance suffers big time. </p><p>I am really relying on you guys to help me, cause I don&#039;t know how to fix this.</p><p>Btw.: I am not sure if it&#039;s relevant, but lspci -v gives me this output:</p><div class="quotebox"><blockquote><div><p>01:00.0 VGA compatible controller: NVIDIA Corporation GM204 [GeForce GTX 980] (rev a1) (prog-if 00 [VGA controller])<br />&#160; &#160; &#160; &#160; Subsystem: Micro-Star International Co., Ltd. [MSI] Device 3170<br />&#160; &#160; &#160; &#160; Flags: fast devsel, IRQ 16<br />&#160; &#160; &#160; &#160; Memory at f6000000 (32-bit, non-prefetchable) [size=16M]<br />&#160; &#160; &#160; &#160; Memory at e0000000 (64-bit, prefetchable) [size=256M]<br />&#160; &#160; &#160; &#160; Memory at f0000000 (64-bit, prefetchable) [size=32M]<br />&#160; &#160; &#160; &#160; I/O ports at e000 [size=128]<br />&#160; &#160; &#160; &#160; Expansion ROM at f7000000 [disabled] [size=512K]<br />&#160; &#160; &#160; &#160; Capabilities: [60] Power Management version 3<br />&#160; &#160; &#160; &#160; Capabilities: [68] MSI: Enable- Count=1/1 Maskable- 64bit+<br />&#160; &#160; &#160; &#160; Capabilities: [78] Express Legacy Endpoint, MSI 00<br />&#160; &#160; &#160; &#160; Capabilities: [100] Virtual Channel<br />&#160; &#160; &#160; &#160; Capabilities: [250] Latency Tolerance Reporting<br />&#160; &#160; &#160; &#160; Capabilities: [258] L1 PM Substates<br />&#160; &#160; &#160; &#160; Capabilities: [128] Power Budgeting &lt;?&gt;<br />&#160; &#160; &#160; &#160; Capabilities: [600] Vendor Specific Information: ID=0001 Rev=1 Len=024 &lt;?&gt;<br />&#160; &#160; &#160; &#160; Capabilities: [900] #19<br />&#160; &#160; &#160; &#160; Kernel driver in use: vfio-pci<br />&#160; &#160; &#160; &#160; Kernel modules: nouveau</p><p>01:00.1 Audio device: NVIDIA Corporation GM204 High Definition Audio Controller (rev a1)<br />&#160; &#160; &#160; &#160; Subsystem: Micro-Star International Co., Ltd. [MSI] Device 3170<br />&#160; &#160; &#160; &#160; Flags: fast devsel, IRQ 17<br />&#160; &#160; &#160; &#160; Memory at f7080000 (32-bit, non-prefetchable) [size=16K]<br />&#160; &#160; &#160; &#160; Capabilities: [60] Power Management version 3<br />&#160; &#160; &#160; &#160; Capabilities: [68] MSI: Enable- Count=1/1 Maskable- 64bit+<br />&#160; &#160; &#160; &#160; Capabilities: [78] Express Endpoint, MSI 00<br />&#160; &#160; &#160; &#160; Kernel driver in use: vfio-pci<br />&#160; &#160; &#160; &#160; <strong>Kernel modules: snd_hda_intel</strong></p></div></blockquote></div><p>I can&#039;t remember if the last line looked always like that but it&#039;s an Nvidia Card and it says Intel, maybe that&#039;s the culprit??</p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1475830">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1475833" class="blockpost rowodd"> <h2><span><span class="conr">#3265</span> <a href="viewtopic.php?pid=1475833#p1475833">2014-11-15 17:57:47</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=75590">aw</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2013-10-04</span></dd> <dd><span>Posts: 921</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=75590">Email</a></span> <span class="website"><a href="http://vfio.blogspot.com/" rel="nofollow">Website</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>4kGamer wrote:</cite><blockquote><div><p>I got rid of the <strong>Error Code 43</strong>&#160; </p><p>I am not quite sure what it was, but I started from scratch, built the kernel provided by nbhs (linux-mainline-3.17.2.tar.gz)<br />and threw every command I could find into grub. This is what my command line looks like.</p><div class="quotebox"><blockquote><div><p>GRUB_CMDLINE_LINUX_DEFAULT=&quot;i915.enable_hd_vgaarb=1 intel_iommu=on pcie_acs_override=downstream vfio_iommu_type1.allow_unsafe_interrupts=1 quiet&quot;</p></div></blockquote></div><p><strong>BUT (there always seems to be a but...)</strong></p><p>I have weird audio issues: There is some scratching in the audio. And performance suffers big time. </p><p>I am really relying on you guys to help me, cause I don&#039;t know how to fix this.</p><p>Btw.: I am not sure if it&#039;s relevant, but lspci -v gives me this output:</p></div></blockquote></div><p>snd_hda_intel supports audio from various vendors, that&#039;s not a problem.</p><p>Nvidia&#039;s implementation of the audio device is fairly flaky, but it usually works better if you configure the device to use MSI interrupts in the guest.&#160; See my blog for how to do that.</p> </div> <div class="postsignature postmsg"><hr /><p><a href="http://vfio.blogspot.com" rel="nofollow">http://vfio.blogspot.com</a><br />Looking for a more open forum to discuss vfio related uses?&#160; Try <a href="https://www.redhat.com/mailman/listinfo/vfio-users" rel="nofollow">https://www.redhat.com/mailman/listinfo/vfio-users</a></p></div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1475833">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1475835" class="blockpost roweven"> <h2><span><span class="conr">#3266</span> <a href="viewtopic.php?pid=1475835#p1475835">2014-11-15 18:00:41</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=86302">4kGamer</a></strong></dt> <dd class="usertitle"><strong>Banned</strong></dd> <dd><span>Registered: 2014-10-29</span></dd> <dd><span>Posts: 82</span></dd> <dd class="usercontacts"><span class="email"><a href="mailto:oktayaslantas@gmx.de">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <p>ok, will do, thank you very much. I&#039;ll try that right away</p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1475835">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1475865" class="blockpost rowodd"> <h2><span><span class="conr">#3267</span> <a href="viewtopic.php?pid=1475865#p1475865">2014-11-15 19:53:19</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=78217">DanaGoyette</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2014-01-03</span></dd> <dd><span>Posts: 46</span></dd> <dd class="usercontacts"><span class="email"><a href="mailto:danagoyette@gmail.com">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>dakabali wrote:</cite><blockquote><div><p>EDIT: Solved! The above described BIOS setting change did the trick. I had to remove the card bios from the configuration and everything works just fine. Summary: it has to explicitly be set in the BIOS which video card is the primary, &quot;auto&quot; might not be enough. Thanks for your kind help!</p></div></blockquote></div><p>That reminds me: My SuperMicro board has settings both for &quot;primary display&quot; and for which ROM to load for each slot.</p><p>If I have the Intel graphics explicitly set to primary, but also allow loading the Radeon&#039;s EFI ROM, I get really weird behavior:</p><p>* The Radeon hijacks the EFI framebuffer (completely ignoring the &quot;primary display&quot; option).&#160; I seem to recall the Intel DisplayPort lighting up but being black.<br />* The Radeon ends up with its framebuffer address screwed up, and I get the Radeon EFI framebuffer as /dev/fb0 and the Intel KMS driver as /dev/fb1.<br />* Neither the Windows nor Linux Radeon drivers (native boot, even) will load.</p><p>If I switch the PCIe slot ROM options to &quot;Legacy&quot; or &quot;Disabled&quot;, no such problems occur, and I can still use EFI for both host and guest.</p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1475865">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1475874" class="blockpost roweven"> <h2><span><span class="conr">#3268</span> <a href="viewtopic.php?pid=1475874#p1475874">2014-11-15 20:30:55</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=80387">dwe11er</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2014-03-18</span></dd> <dd><span>Posts: 73</span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>DanaGoyette wrote:</cite><blockquote><div><div class="quotebox"><cite>dakabali wrote:</cite><blockquote><div><p>EDIT: Solved! The above described BIOS setting change did the trick. I had to remove the card bios from the configuration and everything works just fine. Summary: it has to explicitly be set in the BIOS which video card is the primary, &quot;auto&quot; might not be enough. Thanks for your kind help!</p></div></blockquote></div><p>That reminds me: My SuperMicro board has settings both for &quot;primary display&quot; and for which ROM to load for each slot.</p><p>If I have the Intel graphics explicitly set to primary, but also allow loading the Radeon&#039;s EFI ROM, I get really weird behavior:</p><p>* The Radeon hijacks the EFI framebuffer (completely ignoring the &quot;primary display&quot; option).&#160; I seem to recall the Intel DisplayPort lighting up but being black.<br />* The Radeon ends up with its framebuffer address screwed up, and I get the Radeon EFI framebuffer as /dev/fb0 and the Intel KMS driver as /dev/fb1.<br />* Neither the Windows nor Linux Radeon drivers (native boot, even) will load.</p><p>If I switch the PCIe slot ROM options to &quot;Legacy&quot; or &quot;Disabled&quot;, no such problems occur, and I can still use EFI for both host and guest.</p></div></blockquote></div><p>Have you tried claiming Radeon with pci-stub?</p><p>Pasting the code somewhere inside /etc/modprobe.d, and rebuilding initrd should do the job:</p><div class="codebox"><pre><code>softdep drm pre: pci-stub softdep snd_hda_intel pre: pci-stub options pci-stub ids=1002:6818,1002:aab0 # replace vid:devid accordingly</code></pre></div> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1475874">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1475913" class="blockpost rowodd"> <h2><span><span class="conr">#3269</span> <a href="viewtopic.php?pid=1475913#p1475913">2014-11-15 23:38:38</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=86701">orcephrye</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2014-11-15</span></dd> <dd><span>Posts: 9</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=86701">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <p>Hello Peps,</p><p>I got my setup working thanks to this forum post. However I found two issues and hope to find even more help here if possible. </p><p>1. Audio emulation seams to sometimes cut out while gaming. Or the audio sounds weird and phased. </p><p>2. I noticed a roughly 30% decrease in performance and sometimes the FPS rate can go very lower. As in 1 to 5 FPS before returning to its normal ~30ish% reduce from where it would be if I was bare metal. </p><p>Here is my hardware:<br />Host Card: Nvidia GTX 750 (Nvidia drivers)<br />Windows Card: Nvidia GTX 670<br />CPU: AMD FX 9590<br />MotherBoard: MSI 990FXA-GD80 v2</p><p>I start qemu via the command line like so:</p><div class="codebox"><pre><code># QEMU_ALSA_DAC_BUFFER_SIZE=512 QEMU_ALSA_DAC_PERIOD_SIZE=170 QEMU_AUDIO_DRV=alsa \ &gt; qemu-system-x86_64 -enable-kvm -M q35 -m 16384 -cpu host,kvm=off \ &gt; -smp cpus=8,sockets=1,cores=8,threads=1 \ &gt; -bios /usr/share/qemu/bios.bin -vga none \ &gt; -device vfio-pci,host=06:00.0,multifunction=on,x-vga=on \ &gt; -device vfio-pci,host=06:00.1 \ &gt; -device virtio-scsi-pci,id=scsi \ &gt; -drive file=/dev/sdb,id=disk0,format=raw -device scsi-hd,drive=disk0 \ &gt; -drive file=/dev/sdc,id=disk1,format=raw -device scsi-hd,drive=disk1 \ &gt; -usb -usbdevice host:1532:0109 -usbdevice host:046d:c52b \ &gt; -net nic,macaddr=00:16:35:AF:94:4B -net user \ &gt; -device ich9-intel-hda,bus=pcie.0,addr=1b.0,id=sound0 \ &gt; -device hda-duplex,id=sound0-codec0,bus=sound0.0,cad=0</code></pre></div><p>I also followed this post: <a href="http://forums.guru3d.com/showthread.php?t=378044" rel="nofollow">http://forums.guru3d.com/showthread.php?t=378044</a> and made sure my card was using MSI. I also took the liberty of making the emulated ich9 HD audio use MSI. However that seamed to have no real effect.</p><p>I also this:</p><div class="codebox"><pre><code># cat /etc/modprobe.d/60-kvm-amd.conf options kvm-amd npt=0</code></pre></div><p>I guess my real question is: Is this normal? Does most people using KVM/Nvidia have a ~30ish % reduction in rendering performance? And/Or times when there are large drops in performance? If not what else am I missing to help this out? </p><p>Thanks in advance. :-)</p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1475913">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1475944" class="blockpost roweven"> <h2><span><span class="conr">#3270</span> <a href="viewtopic.php?pid=1475944#p1475944">2014-11-16 03:08:57</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=84760">Denso</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd class="postavatar"><img src="https://bbs.archlinux.org/img/avatars/84760.png?m=1412533733" width="71" height="80" alt="" /></dd> <dd><span>Registered: 2014-08-30</span></dd> <dd><span>Posts: 179</span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>orcephrye wrote:</cite><blockquote><div><p>CPU: AMD FX 9590<br />MotherBoard: MSI 990FXA-GD80 v2</p></div></blockquote></div><p>Hi . I used to have an AMD 8350 + Gigabyte 990FXA-UD5 (If I remember correctly) and it was SO SLOW in gaming and the sound was playing in SlowMo .</p><p>When I switched to an i5-3570 (Again if I remember correctly) , it was butter smooth , yes it wasn&#039;t like bare-metal but it was pretty darn close .</p><p>Now I switched to an X99 platform + GTX770 and I can play games at 2560x1440 60fps (CoD Advanced Warfare for example) no problem .</p><p>Here is my Gaming VM script if you&#039;re curious :</p><div class="codebox"><pre><code>qemu-system-x86_64 -name gaming -nographic -mem-path /dev/hugepages \ -enable-kvm -m 8192 -cpu host,kvm=off -smp 4,sockets=1,cores=4,threads=1 \ -vga none \ -drive if=pflash,format=raw,readonly,file=/usr/share/ovmf/x64/ovmf_code_x64.bin \ -drive if=pflash,format=raw,file=/VMs/ovmf_gaming.bin \ -device vfio-pci,host=02:00.0,multifunction=on \ -device vfio-pci,host=02:00.1 \ -device vfio-pci,host=10:00.0 \ -drive file=/VMs/Win_Gaming.qed,cache=writeback,if=none,id=drive0,aio=native \ -device virtio-blk-pci,drive=drive0,ioeventfd=on,bootindex=1 \ -drive file=/VMs/Gaming_External.qed,cache=none,if=none,id=drive1,aio=native \ -device virtio-blk-pci,drive=drive1,ioeventfd=on \ -device virtio-scsi-pci,id=scsi \ -drive file=/VMs/Win8.iso,id=iso_install,if=none \ -device scsi-cd,drive=iso_install \ -cdrom /VMs/virtio.iso \ -net nic,model=virtio,macaddr=64:25:5E:87:0E:5C -net bridge,br=br0 \ -localtime \ -monitor unix:/tmp/vm_gaming,server,nowait &amp;</code></pre></div><p>Note that I&#039;m using OVMF + 440FX + HDMI Audio .</p><p>Hope this helps ! <img src="https://bbs.archlinux.org/img/smilies/smile.png" width="15" height="15" alt="smile" /></p> <p class="postedit"><em>Last edited by Denso (2014-11-16 03:10:29)</em></p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1475944">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1475951" class="blockpost rowodd"> <h2><span><span class="conr">#3271</span> <a href="viewtopic.php?pid=1475951#p1475951">2014-11-16 03:55:23</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=78217">DanaGoyette</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2014-01-03</span></dd> <dd><span>Posts: 46</span></dd> <dd class="usercontacts"><span class="email"><a href="mailto:danagoyette@gmail.com">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>dwe11er wrote:</cite><blockquote><div><p>Have you tried claiming Radeon with pci-stub?</p><p>Pasting the code somewhere inside /etc/modprobe.d, and rebuilding initrd should do the job:</p><div class="codebox"><pre><code>softdep drm pre: pci-stub softdep snd_hda_intel pre: pci-stub options pci-stub ids=1002:6818,1002:aab0 # replace vid:devid accordingly</code></pre></div></div></blockquote></div><p>In my EFI-Intel + EFI-Radeon case, the Radeon was claimed by the EFI firmware, preventing both radeon and vfio-pci from accessing it properly.&#160; So, blocking the radeon driver changes nothing.<br />I already figured out my issue; I was just mentioning it for reference, in case somebody else sees similar behavior.</p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1475951">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1475986" class="blockpost roweven"> <h2><span><span class="conr">#3272</span> <a href="viewtopic.php?pid=1475986#p1475986">2014-11-16 07:18:12</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=86701">orcephrye</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2014-11-15</span></dd> <dd><span>Posts: 9</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=86701">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <p>Hello Denso! Thanks for your reply!</p><p>Sadly I am not sure how useful that info is. Basically it sounds like I would need to buy new hardware. Sadly I just got this AMD setup and spent a pretty penny. Instead of a whole new set of hardware I could possibly buy a new Radeon card and either set how KVM handles that or switch to using Xen. </p><p>It appears that switching to OVMF would not help gaming performance at all.. correct?</p><p>Also.. &quot;-monitor unix:/tmp/vm_gaming,server,nowait&quot; !? If you dont mind me asking whats going on there? It looks like your are redirecting the output too a file? Is that an socket that redirects to something?</p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1475986">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1475991" class="blockpost rowodd"> <h2><span><span class="conr">#3273</span> <a href="viewtopic.php?pid=1475991#p1475991">2014-11-16 08:02:40</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=84760">Denso</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd class="postavatar"><img src="https://bbs.archlinux.org/img/avatars/84760.png?m=1412533733" width="71" height="80" alt="" /></dd> <dd><span>Registered: 2014-08-30</span></dd> <dd><span>Posts: 179</span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>orcephrye wrote:</cite><blockquote><div><p>Hello Denso! Thanks for your reply!</p><p>Sadly I am not sure how useful that info is. Basically it sounds like I would need to buy new hardware. Sadly I just got this AMD setup and spent a pretty penny. Instead of a whole new set of hardware I could possibly buy a new Radeon card and either set how KVM handles that or switch to using Xen. </p><p>It appears that switching to OVMF would not help gaming performance at all.. correct?</p><p>Also.. &quot;-monitor unix:/tmp/vm_gaming,server,nowait&quot; !? If you dont mind me asking whats going on there? It looks like your are redirecting the output too a file? Is that an socket that redirects to something?</p></div></blockquote></div><p>Hi <img src="https://bbs.archlinux.org/img/smilies/smile.png" width="15" height="15" alt="smile" /></p><p>I&#039;m sure that you can tune your setup to gain more performance . For my case , switching to an Intel platform was night and day difference (I remember Metro 2033 game , the i5 just blew FX-8350 out of water) .</p><p>umm , I&#039;m directing the monitor output to a file , so that I can send a shutdown command to the VM prior to the host&#039;s shutdown/reboot like this :</p><div class="codebox"><pre><code>#!/bin/bash # This code will send an ACPI Shutdown request to our VMs then wait 10 seconds , then kill all remaining &quot;qemu&quot; processes # echo &quot;system_powerdown&quot; | socat - UNIX-CONNECT:/tmp/vm_winsrv echo &quot;system_powerdown&quot; | socat - UNIX-CONNECT:/tmp/vm_gaming echo &quot;system_powerdown&quot; | socat - UNIX-CONNECT:/tmp/vm_main sleep 10s killall -9 qemu-system-x86_64</code></pre></div><p>Works like a charm ! <img src="https://bbs.archlinux.org/img/smilies/smile.png" width="15" height="15" alt="smile" /></p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1475991">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1475994" class="blockpost roweven"> <h2><span><span class="conr">#3274</span> <a href="viewtopic.php?pid=1475994#p1475994">2014-11-16 08:33:27</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=82238">sinny</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2014-05-24</span></dd> <dd><span>Posts: 75</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=82238">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>orcephrye wrote:</cite><blockquote><div><p>Hello Peps,</p><p>I got my setup working thanks to this forum post. However I found two issues and hope to find even more help here if possible. </p><p>1. Audio emulation seams to sometimes cut out while gaming. Or the audio sounds weird and phased. </p><p>2. I noticed a roughly 30% decrease in performance and sometimes the FPS rate can go very lower. As in 1 to 5 FPS before returning to its normal ~30ish% reduce from where it would be if I was bare metal. </p><p>Here is my hardware:<br />Host Card: Nvidia GTX 750 (Nvidia drivers)<br />Windows Card: Nvidia GTX 670<br />CPU: AMD FX 9590<br />MotherBoard: MSI 990FXA-GD80 v2</p><p>I start qemu via the command line like so:</p><div class="codebox"><pre><code># QEMU_ALSA_DAC_BUFFER_SIZE=512 QEMU_ALSA_DAC_PERIOD_SIZE=170 QEMU_AUDIO_DRV=alsa \ &gt; qemu-system-x86_64 -enable-kvm -M q35 -m 16384 -cpu host,kvm=off \ &gt; -smp cpus=8,sockets=1,cores=8,threads=1 \ &gt; -bios /usr/share/qemu/bios.bin -vga none \ &gt; -device vfio-pci,host=06:00.0,multifunction=on,x-vga=on \ &gt; -device vfio-pci,host=06:00.1 \ &gt; -device virtio-scsi-pci,id=scsi \ &gt; -drive file=/dev/sdb,id=disk0,format=raw -device scsi-hd,drive=disk0 \ &gt; -drive file=/dev/sdc,id=disk1,format=raw -device scsi-hd,drive=disk1 \ &gt; -usb -usbdevice host:1532:0109 -usbdevice host:046d:c52b \ &gt; -net nic,macaddr=00:16:35:AF:94:4B -net user \ &gt; -device ich9-intel-hda,bus=pcie.0,addr=1b.0,id=sound0 \ &gt; -device hda-duplex,id=sound0-codec0,bus=sound0.0,cad=0</code></pre></div><p>I also followed this post: <a href="http://forums.guru3d.com/showthread.php?t=378044" rel="nofollow">http://forums.guru3d.com/showthread.php?t=378044</a> and made sure my card was using MSI. I also took the liberty of making the emulated ich9 HD audio use MSI. However that seamed to have no real effect.</p><p>I also this:</p><div class="codebox"><pre><code># cat /etc/modprobe.d/60-kvm-amd.conf options kvm-amd npt=0</code></pre></div><p>I guess my real question is: Is this normal? Does most people using KVM/Nvidia have a ~30ish % reduction in rendering performance? And/Or times when there are large drops in performance? If not what else am I missing to help this out? </p><p>Thanks in advance. :-)</p></div></blockquote></div><p>so, basically you did NO basic tuning, but jumped straight to some advanced sutff (e.g. msi)? smart boy, truly. read more of some random forum&#039;s post instead of digging this very thread to get all the info</p><p>no cpu pinning, no emulated sound parameter tuning (or using passed through audio card), no advanced memory mode (hugetlbfs?) - are you really expecting it to work like a charm out of the box on near-native performance level? for god&#039;s sake...</p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1475994">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1476136" class="blockpost rowodd"> <h2><span><span class="conr">#3275</span> <a href="viewtopic.php?pid=1476136#p1476136">2014-11-16 20:25:45</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=85314">Duelist</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2014-09-22</span></dd> <dd><span>Posts: 358</span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>sinny wrote:</cite><blockquote><div><p>no cpu pinning, no emulated sound parameter tuning (or using passed through audio card), no advanced memory mode (hugetlbfs?) - are you really expecting it to work like a charm out of the box on near-native performance level? for god&#039;s sake...</p></div></blockquote></div><p>Aw, come on, don&#039;t be rude, man!</p><p>The only thing about CPU i have is -cpu host and -smp option.<br />The sound is</p><div class="codebox"><pre><code>-device ich9-intel-hda,bus=root.1,addr=00.0,id=sound0 \ -device hda-duplex,id=sound0-codec0,bus=sound0.0,cad=0 \</code></pre></div><p>and i honestly do not know how the hell this works, thanks to nbhs. But it works almost awesome with my host pulse audio setup(fedora, i don&#039;t know how pulse works either) - there&#039;s little stuttering occuring when there is too much sound(like, playing a really weird music from youtube).Appears like i&#039;ve got the sound input working too.<br />The hugepages option just breaks everything apart for me.</p><p>And you know what? Performance decrease is about 10%. The only thing that bottlenecks the whole bunch is the disk image file relying on a 2FAST4U loud WD hard drive with 5 or 7 bad sectors. </p><p>The only problem i am having with the CPU performance - it&#039;s switching it&#039;s frequency too damn often, but that depends on one host UEFI setting and hits the host system too.</p> </div> <div class="postsignature postmsg"><hr /><p><span class="bbs">The forum rules prohibit requesting support for distributions other than arch.</span><br /><a href="https://bbs.archlinux.org/viewtopic.php?pid=1551460#p1551460" rel="nofollow">I gave up.</a><a href="https://bbs.archlinux.org/viewtopic.php?id=162768" rel="nofollow"> It was too late.</a><br /><a href="http://pastebin.com/B3fL84bq" rel="nofollow">What I was trying to do</a>.<br /><a href="http://vfio.blogspot.com/" rel="nofollow">The reference about VFIO and KVM VGA passthrough.</a></p></div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1476136">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div class="postlinksb"> <div class="inbox crumbsplus"> <div class="pagepost"> <p class="pagelink conl"><span class="pages-label">Pages: </span><a rel="prev" class="item1" href="viewtopic.php?id=162768&amp;p=130">Previous</a> <a href="viewtopic.php?id=162768">1</a> <span class="spacer">…</span> <a href="viewtopic.php?id=162768&amp;p=129">129</a> <a href="viewtopic.php?id=162768&amp;p=130">130</a> <strong>131</strong> <a href="viewtopic.php?id=162768&amp;p=132">132</a> <a href="viewtopic.php?id=162768&amp;p=133">133</a> <span class="spacer">…</span> <a href="viewtopic.php?id=162768&amp;p=234">234</a> <a rel="next" href="viewtopic.php?id=162768&amp;p=132">Next</a></p> <p class="postlink conr">Topic closed</p> </div> <ul class="crumbs"> <li><a href="index.php">Index</a></li> <li><span>»&#160;</span><a href="viewforum.php?id=48">Topics Going Nowhere</a></li> <li><span>»&#160;</span><strong><a href="viewtopic.php?id=162768">KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</a></strong></li> </ul> <p class="subscribelink clearb"><a href="misc.php?action=subscribe&amp;tid=162768">Subscribe to this topic</a></p> <div class="clearer"></div> </div> </div> </div> <div id="brdfooter" class="block"> <h2><span>Board footer</span></h2> <div class="box"> <div id="brdfooternav" class="inbox"> <div class="conl"> <form id="qjump" method="get" action="viewforum.php"> <div><label><span>Jump to<br /></span> <select name="id" onchange="window.location=('viewforum.php?id='+this.options[this.selectedIndex].value)"> <optgroup label="Technical Issues and Assistance"> <option value="23">Newbie Corner</option> <option value="17">Installation</option> <option value="22">Kernel &amp; Hardware</option> <option value="18">Applications &amp; Desktop Environments</option> <option value="31">Laptop Issues</option> <option value="8">Networking, Server, and Protection</option> <option value="32">Multimedia and Games</option> <option value="50">System Administration</option> <option value="35">Other Architectures</option> </optgroup> <optgroup label="Arch-centric"> <option value="24">Announcements, Package &amp; Security Advisories</option> <option value="1">Arch Discussion</option> <option value="13">Forum &amp; Wiki discussion</option> </optgroup> <optgroup label="Pacman Upgrades, Packaging &amp; AUR"> <option value="44">Pacman &amp; Package Upgrade Issues</option> <option value="49">[testing] Repo Forum</option> <option value="4">Creating &amp; Modifying Packages</option> <option value="38">AUR Issues, Discussion &amp; PKGBUILD Requests</option> </optgroup> <optgroup label="Contributions &amp; Discussion"> <option value="20">GNU/Linux Discussion</option> <option value="27">Community Contributions</option> <option value="33">Programming &amp; Scripting</option> <option value="30">Other Languages</option> <option value="47">Artwork and Screenshots</option> <option value="42">Try This</option> </optgroup> <optgroup label="/dev/null"> <option value="29">Off-Topic</option> <option value="48" selected="selected">Topics Going Nowhere</option> <option value="36">Dustbin</option> </optgroup> </select></label> <input type="submit" value=" Go " accesskey="g" /> </div> </form> </div> <div class="conr"> <p id="feedlinks"><span class="atom"><a href="extern.php?action=feed&amp;tid=162768&amp;type=atom">Atom topic feed</a></span></p> <p id="poweredby">Powered by <a href="http://fluxbb.org/">FluxBB</a></p> </div> <div class="clearer"></div> </div> </div> </div> </div> <div class="end-box"></div> </div> </body> </html>
