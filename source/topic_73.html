<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"> <html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en" dir="ltr"> <head> <meta http-equiv="Content-Type" content="text/html; charset=utf-8" /> <title>KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9 (Page 73) / Topics Going Nowhere / Arch Linux Forums</title> <link rel="stylesheet" type="text/css" href="style/ArchLinux.css" /> <link rel="canonical" href="viewtopic.php?id=162768&amp;p=73" title="Page 73" /> <link rel="prev" href="viewtopic.php?id=162768&amp;p=72" title="Page 72" /> <link rel="next" href="viewtopic.php?id=162768&amp;p=74" title="Page 74" /> <link rel="alternate" type="application/atom+xml" href="extern.php?action=feed&amp;tid=162768&amp;type=atom" title="Atom topic feed" /> <link rel="stylesheet" media="screen" href="style/ArchLinux/arch.css?v=3" /> <link rel="stylesheet" media="screen" href="style/ArchLinux/archnavbar.css?v=2" /> <link rel="shortcut icon" href="style/ArchLinux/favicon.ico" /> </head> <body> <div id="archnavbar" class="anb-forum"> <div id="archnavbarlogo"><h1><a href="http://www.archlinux.org/">Arch Linux</a></h1></div> <div id="archnavbarmenu"> <ul id="archnavbarlist"> <li id="anb-home"><a href="http://www.archlinux.org/">Home</a></li><li id="anb-packages"><a href="http://www.archlinux.org/packages/">Packages</a></li><li id="anb-forums" class="anb-selected"><a href="https://bbs.archlinux.org/">Forums</a></li><li id="anb-wiki"><a href="https://wiki.archlinux.org/">Wiki</a></li><li id="anb-bugs"><a href="https://bugs.archlinux.org/">Bugs</a></li><li id="anb-aur"><a href="https://aur.archlinux.org/">AUR</a></li><li id="anb-download"><a href="http://www.archlinux.org/download/">Download</a></li> </ul> </div> </div> <div id="punviewtopic" class="pun"> <div class="top-box"></div> <div class="punwrap"> <div id="brdheader" class="block"> <div class="box"> <div id="brdmenu" class="inbox"> <ul> <li id="navindex" class="isactive"><a href="index.php">Index</a></li> <li id="navuserlist"><a href="userlist.php">User list</a></li> <li id="navsearch"><a href="search.php">Search</a></li> <li id="navprofile"><a href="profile.php?id=80749">Profile</a></li> <li id="navlogout"><a href="login.php?action=out&amp;id=80749&amp;csrf_token=5c20501ec397bb45ef8ee8c84db232c8d8e421c6">Logout</a></li> </ul> </div> <div id="brdwelcome" class="inbox"> <ul class="conl"> <li><span>Logged in as <strong>SXX</strong></span></li> <li><span>Last visit: 2015-08-16 12:20:09</span></li> </ul> <ul class="conr"> <li><span>Topics: <a href="search.php?action=show_replies" title="Find topics you have posted to.">Posted</a> | <a href="search.php?action=show_new" title="Find topics with new posts since your last visit.">New</a> | <a href="search.php?action=show_recent" title="Find topics with recent posts.">Active</a> | <a href="search.php?action=show_unanswered" title="Find topics with no replies.">Unanswered</a></span></li> </ul> <div class="clearer"></div> </div> </div> </div> <div id="brdmain"> <div class="linkst"> <div class="inbox crumbsplus"> <ul class="crumbs"> <li><a href="index.php">Index</a></li> <li><span>»&#160;</span><a href="viewforum.php?id=48">Topics Going Nowhere</a></li> <li><span>»&#160;</span><strong><a href="viewtopic.php?id=162768">KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</a></strong></li> </ul> <div class="pagepost"> <p class="pagelink conl"><span class="pages-label">Pages: </span><a rel="prev" class="item1" href="viewtopic.php?id=162768&amp;p=72">Previous</a> <a href="viewtopic.php?id=162768">1</a> <span class="spacer">…</span> <a href="viewtopic.php?id=162768&amp;p=71">71</a> <a href="viewtopic.php?id=162768&amp;p=72">72</a> <strong>73</strong> <a href="viewtopic.php?id=162768&amp;p=74">74</a> <a href="viewtopic.php?id=162768&amp;p=75">75</a> <span class="spacer">…</span> <a href="viewtopic.php?id=162768&amp;p=234">234</a> <a rel="next" href="viewtopic.php?id=162768&amp;p=74">Next</a></p> <p class="postlink conr">Topic closed</p> </div> <div class="clearer"></div> </div> </div> <div id="p1418844" class="blockpost rowodd blockpost1"> <h2><span><span class="conr">#1801</span> <a href="viewtopic.php?pid=1418844#p1418844">2014-05-24 12:49:15</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=79237">mbroemme</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>From: Cologne</span></dd> <dd><span>Registered: 2014-02-05</span></dd> <dd><span>Posts: 39</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=79237">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>aw wrote:</cite><blockquote><div><div class="quotebox"><cite>Slabity wrote:</cite><blockquote><div><p>Wow, that works perfectly with the test script! Thank you so much!</p></div></blockquote></div><p>Does radeon still work ok for the host?</p><p>Anyone using radeon on the host (APU users) may want to try this too.</p></div></blockquote></div><p>Many thanks Alex. This also works for me with 2 discrete Radeon cards (no APU). With the shell scripts I&#039;m able to switch my boot VGA in BIOS to any card and VGA passthrough is always working. The configuration is the following:</p><div class="codebox"><pre><code> +-02.0-[01]--+-00.0 Advanced Micro Devices, Inc. [AMD/ATI] Pitcairn XT [Radeon HD 7870 GHz Edition] | \-00.1 Advanced Micro Devices, Inc. [AMD/ATI] Cape Verde/Pitcairn HDMI Audio [Radeon HD 7700/7800 Series] +-0b.0-[04]--+-00.0 Advanced Micro Devices, Inc. [AMD/ATI] Hawaii XT [Radeon HD 8970] | \-00.1 Advanced Micro Devices, Inc. [AMD/ATI] Device aac8</code></pre></div><p>I will give the patch mentioned here <a href="http://pastebin.com/2ukyQbkG" rel="nofollow">http://pastebin.com/2ukyQbkG</a> a try in the next hours. I&#039;ll hope it will solve the issue permantly for me. <img src="https://bbs.archlinux.org/img/smilies/smile.png" width="15" height="15" alt="smile" /> Many thanks again!</p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1418844">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1418885" class="blockpost roweven"> <h2><span><span class="conr">#1802</span> <a href="viewtopic.php?pid=1418885#p1418885">2014-05-24 15:26:12</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=82246">shawly</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2014-05-24</span></dd> <dd><span>Posts: 22</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=82246">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <p>Hey,</p><p>I switched my hardware to accomplish this, kernel compiled etc. everything went good.<br />Problem now is I can&#039;t get Qemu to start..</p><div class="codebox"><pre><code>sudo qemu-system-x86_64 -enable-kvm -M q35 -m 1024 -cpu host -smp 6,sockets=1,cores=6,threads=1 -bios /usr/share/qemu/bios.bin -vga none \ -device ioh3420,bus=pcie.0,addr=1c.0,multifunction=on,port=1,chassis=1,id=root.1 \ -device vfio-pci,host=01:00.0,bus=root.1,addr=00.0,multifunction=on,x-vga=on \ -device vfio-pci,host=01:00.1,bus=root.1,addr=00.1 qemu-system-x86_64: -device vfio-pci,host=01:00.0,bus=root.1,addr=00.0,multifunction=on,x-vga=on: vfio: error no iommu_group for device qemu-system-x86_64: -device vfio-pci,host=01:00.0,bus=root.1,addr=00.0,multifunction=on,x-vga=on: Device initialization failed. qemu-system-x86_64: -device vfio-pci,host=01:00.0,bus=root.1,addr=00.0,multifunction=on,x-vga=on: Device &#039;vfio-pci&#039; could not be initialized</code></pre></div><p>I can&#039;t anything on the net by searching for &quot;vfio: error no iommu_group for device&quot;.. I have no idea what I should do..<br />BTW I get the same error with both GPUs!</p><p>System:<br />- CPU: Intel Xeon E3-1245v3 (Host uses iGPU)<br />- MB: MSI Z97 Gaming 7 (Supports VT-d)<br />- GPU1: Nvidia GeForce GTX 770 (for Gaming)<br />- GPU2: AMD Radeon HD5450 (for virtual HTPC)<br />- OS: Arch Linux (Kernel 3.14.4-3-mainline with all the patches in the package from the first post, qemu-git (2.1)&#160; and seabios-git (1.7.5))</p><p>I know that the GTX 770 works, since I saw some guys that got it to work.<br />I&#039;m not sure but I don&#039;t think that it&#039;s because of two GPUs..</p><p>/sys/bus/pci/devices/0000\:01\:00.0/ does NOT contain any iommu_group devices. FYI</p> <p class="postedit"><em>Last edited by shawly (2014-05-24 15:29:37)</em></p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1418885">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1418888" class="blockpost rowodd"> <h2><span><span class="conr">#1803</span> <a href="viewtopic.php?pid=1418888#p1418888">2014-05-24 15:35:26</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=82238">sinny</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2014-05-24</span></dd> <dd><span>Posts: 75</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=82238">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>shawly wrote:</cite><blockquote><div><p>Hey,</p><p>I switched my hardware to accomplish this, kernel compiled etc. everything went good.<br />Problem now is I can&#039;t get Qemu to start..</p><div class="codebox"><pre><code>sudo qemu-system-x86_64 -enable-kvm -M q35 -m 1024 -cpu host -smp 6,sockets=1,cores=6,threads=1 -bios /usr/share/qemu/bios.bin -vga none \ -device ioh3420,bus=pcie.0,addr=1c.0,multifunction=on,port=1,chassis=1,id=root.1 \ -device vfio-pci,host=01:00.0,bus=root.1,addr=00.0,multifunction=on,x-vga=on \ -device vfio-pci,host=01:00.1,bus=root.1,addr=00.1 qemu-system-x86_64: -device vfio-pci,host=01:00.0,bus=root.1,addr=00.0,multifunction=on,x-vga=on: vfio: error no iommu_group for device qemu-system-x86_64: -device vfio-pci,host=01:00.0,bus=root.1,addr=00.0,multifunction=on,x-vga=on: Device initialization failed. qemu-system-x86_64: -device vfio-pci,host=01:00.0,bus=root.1,addr=00.0,multifunction=on,x-vga=on: Device &#039;vfio-pci&#039; could not be initialized</code></pre></div><p>I can&#039;t anything on the net by searching for &quot;vfio: error no iommu_group for device&quot;.. I have no idea what I should do..<br />BTW I get the same error with both GPUs!</p><p>System:<br />- CPU: Intel Xeon E3-1245v3 (Host uses iGPU)<br />- MB: MSI Z97 Gaming 7 (Supports VT-d)<br />- GPU1: Nvidia GeForce GTX 770 (for Gaming)<br />- GPU2: AMD Radeon HD5450 (for virtual HTPC)<br />- OS: Arch Linux (Kernel 3.14.4-3-mainline with all the patches in the package from the first post, qemu-git (2.1)&#160; and seabios-git (1.7.5))</p><p>I know that the GTX 770 works, since I saw some guys that got it to work.<br />I&#039;m not sure but I don&#039;t think that it&#039;s because of two GPUs..</p><p>/sys/bus/pci/devices/0000\:01\:00.0/ does NOT contain any iommu_group devices. FYI</p></div></blockquote></div><p>check kernel parameters or bios (seems to me like iommu might be disabled in your case) - see first post for details</p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1418888">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1418889" class="blockpost roweven"> <h2><span><span class="conr">#1804</span> <a href="viewtopic.php?pid=1418889#p1418889">2014-05-24 15:43:14</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=82246">shawly</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2014-05-24</span></dd> <dd><span>Posts: 22</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=82246">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>sinny wrote:</cite><blockquote><div><p>check kernel parameters or bios (seems to me like iommu might be disabled in your case) - see first post for details</p></div></blockquote></div><p>Oh my god, I just needed to set intel_iommu=on to the kernel parameters.. I feel really stupid now..<br />Thanks &lt;3</p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1418889">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1418894" class="blockpost rowodd"> <h2><span><span class="conr">#1805</span> <a href="viewtopic.php?pid=1418894#p1418894">2014-05-24 16:14:57</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=75590">aw</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2013-10-04</span></dd> <dd><span>Posts: 921</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=75590">Email</a></span> <span class="website"><a href="http://vfio.blogspot.com/" rel="nofollow">Website</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>mbroemme wrote:</cite><blockquote><div><div class="quotebox"><cite>aw wrote:</cite><blockquote><div><div class="quotebox"><cite>Slabity wrote:</cite><blockquote><div><p>Wow, that works perfectly with the test script! Thank you so much!</p></div></blockquote></div><p>Does radeon still work ok for the host?</p><p>Anyone using radeon on the host (APU users) may want to try this too.</p></div></blockquote></div><p>Many thanks Alex. This also works for me with 2 discrete Radeon cards (no APU). With the shell scripts I&#039;m able to switch my boot VGA in BIOS to any card and VGA passthrough is always working. The configuration is the following:</p><div class="codebox"><pre><code> +-02.0-[01]--+-00.0 Advanced Micro Devices, Inc. [AMD/ATI] Pitcairn XT [Radeon HD 7870 GHz Edition] | \-00.1 Advanced Micro Devices, Inc. [AMD/ATI] Cape Verde/Pitcairn HDMI Audio [Radeon HD 7700/7800 Series] +-0b.0-[04]--+-00.0 Advanced Micro Devices, Inc. [AMD/ATI] Hawaii XT [Radeon HD 8970] | \-00.1 Advanced Micro Devices, Inc. [AMD/ATI] Device aac8</code></pre></div><p>I will give the patch mentioned here <a href="http://pastebin.com/2ukyQbkG" rel="nofollow">http://pastebin.com/2ukyQbkG</a> a try in the next hours. I&#039;ll hope it will solve the issue permantly for me. <img src="https://bbs.archlinux.org/img/smilies/smile.png" width="15" height="15" alt="smile" /> Many thanks again!</p></div></blockquote></div><p>That patch isn&#039;t effective, don&#039;t bother with it.&#160; This one seems to work for me, but it&#039;s more heavyweight than I&#039;d like.&#160; The problem sequence is that Xorg tries to lock VGA resources which triggers some first access callbacks.&#160; The callback in the radeon code tells the arbiter that the device no longer decodes VGA resources.&#160; Now, the arbiter still let&#039;s a process lock resources that the device doesn&#039;t decode, but it loses track of them when they&#039;re released.&#160; So vfio comes along and tries to lock VGA resources on the other card and the arbiter skips disabling VGA on the radeon bridge because the device doesn&#039;t decode VGA.&#160; The patch below gratuitously disables VGA on any potentially conflicting bridge on every vga_get, which makes VGA access even slower (not that we care so much since VGA stops being used shortly after the guest OS starts running).&#160; I&#039;ll probably rework the code more for upstream to allow devices to own resources they don&#039;t decode rather than just lock them.&#160; Enjoy.</p><div class="codebox"><pre><code>--- a/drivers/gpu/vga/vgaarb.c +++ b/drivers/gpu/vga/vgaarb.c @@ -244,8 +244,12 @@ static struct vga_device *__vga_tryget(struct vga_device *v */ WARN_ON(conflict-&gt;owns &amp; ~conflict-&gt;decodes); match = lwants &amp; conflict-&gt;owns; - if (!match) + if (!match) { + if (change_bridge) + pci_set_vga_state(conflict-&gt;pdev, false, 0, + PCI_VGA_STATE_CHANGE_BRIDGE); continue; + } /1 /bin /boot /cdrom /dev /etc /home /initrd.img /initrd.img.old /lib /lib32 /lib64 /libx32 /lost+found /media /mnt /opt /proc /root /run /sbin /srv /sys /tmp /ubiquity-apt-clone /usr /var /vmlinuz /vmlinuz.old /win81-base.qcow2 /win81-base.qcow2.md5 /win81-writable-amd.qcow2 /win81-writable-nvidia.qcow2 /win81-writable-nvidia.qcow2.backup looks like he doesn&#039;t have a lock, we can steal 1.sh topic_10.html topic_11.html topic_12.html topic_13.html topic_14.html topic_15.html topic_16.html topic_17.html topic_18.html topic_19.html topic_1.html topic_20.html topic_21.html topic_22.html topic_23.html topic_24.html topic_25.html topic_26.html topic_27.html topic_28.html topic_29.html topic_2.html topic_30.html topic_31.html topic_32.html topic_33.html topic_34.html topic_35.html topic_36.html topic_37.html topic_38.html topic_39.html topic_3.html topic_40.html topic_41.html topic_42.html topic_43.html topic_44.html topic_45.html topic_46.html topic_47.html topic_48.html topic_49.html topic_4.html topic_50.html topic_51.html topic_52.html topic_53.html topic_54.html topic_55.html topic_56.html topic_57.html topic_58.html topic_59.html topic_5.html topic_60.html topic_61.html topic_62.html topic_63.html topic_64.html topic_65.html topic_66.html topic_67.html topic_68.html topic_69.html topic_6.html topic_70.html topic_71.html topic_72.html topic_7.html topic_8.html topic_9.html them from him</code></pre></div><p>dropbox link since the forum will break formatting - <a href="https://dl.dropboxusercontent.com/u/19831938/vgaarb-gratuitous-bridge-vga-disable.patch" rel="nofollow">https://dl.dropboxusercontent.com/u/198 … able.patch</a></p> </div> <div class="postsignature postmsg"><hr /><p><a href="http://vfio.blogspot.com" rel="nofollow">http://vfio.blogspot.com</a><br />Looking for a more open forum to discuss vfio related uses?&#160; Try <a href="https://www.redhat.com/mailman/listinfo/vfio-users" rel="nofollow">https://www.redhat.com/mailman/listinfo/vfio-users</a></p></div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1418894">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1418897" class="blockpost roweven"> <h2><span><span class="conr">#1806</span> <a href="viewtopic.php?pid=1418897#p1418897">2014-05-24 16:27:05</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=75590">aw</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2013-10-04</span></dd> <dd><span>Posts: 921</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=75590">Email</a></span> <span class="website"><a href="http://vfio.blogspot.com/" rel="nofollow">Website</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>sinny wrote:</cite><blockquote><div><p>i know that it is kinda wrong to bring my problems to arch linux boards, but i am pretty desperate at that point )</p></div></blockquote></div><p>I&#039;m not running arch either, don&#039;t feel bad</p><div class="quotebox"><blockquote><div><p>MB: asrock z87 pro4<br />CPU: intel i7 4770<br />OS: fedora 20</p><p>host vga: IGD (details below)</p><p>kernel (with i915 module being recompiled with i915_314.patch from linux-mainline.tar.gz in first post):</p><div class="codebox"><pre><code>[s@localhost ~]$ uname -r 3.14.4-200.fc20.x86_64 [s@localhost ~]$ modinfo i915 | head -n1 filename: /lib/modules/3.14.4-200.fc20.x86_64/updates/i915.ko [s@localhost ~]$ </code></pre></div></div></blockquote></div><p>This doesn&#039;t prove anything, in fact it just looks like you&#039;re running the f20 distro kernel and not one recompiled to include the i915 patch.&#160; Are you trying to rebuild the kernel rpm?</p><div class="quotebox"><blockquote><div><p>couldnt have any success at all for 5 days while trying different variations, completely out of ideas for now on what may be wrong - too much outdated info out there</p><p>target guest os is win7</p><p>when trying to passthrough HD 6450:<br /> - [test command from first post] host screen usually gets screwed (looking like pallete was overwritten randomly, i doubt X is running in indexed mode though) - fixable by switching to tty console and then back to X<br /> - [virt-manager/kvm] Code 10 (device cannot be started) in device manager, latest catalyst drivers setup terminates while trying to detect hardware</p></div></blockquote></div><p>This also sounds like the host kernel doesn&#039;t actually include the i915 patch.&#160; I&#039;d start out with making sure you&#039;re really running a kernel patched the way you think it is.</p> </div> <div class="postsignature postmsg"><hr /><p><a href="http://vfio.blogspot.com" rel="nofollow">http://vfio.blogspot.com</a><br />Looking for a more open forum to discuss vfio related uses?&#160; Try <a href="https://www.redhat.com/mailman/listinfo/vfio-users" rel="nofollow">https://www.redhat.com/mailman/listinfo/vfio-users</a></p></div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1418897">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1418914" class="blockpost rowodd"> <h2><span><span class="conr">#1807</span> <a href="viewtopic.php?pid=1418914#p1418914">2014-05-24 18:18:18</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=82238">sinny</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2014-05-24</span></dd> <dd><span>Posts: 75</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=82238">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>aw wrote:</cite><blockquote><div><p>This doesn&#039;t prove anything, in fact it just looks like you&#039;re running the f20 distro kernel and not one recompiled to include the i915 patch.&#160; Are you trying to rebuild the kernel rpm?</p></div></blockquote></div><p>well, all i wanted to &quot;prove&quot; - is that module currently loaded is the one rebuild by me and manually placed in module updates directory<br />correct me if i&#039;m wrong, but vga arbiter patch only involves i915 module, not the kernel itself.</p><div class="quotebox"><cite>aw wrote:</cite><blockquote><div><p>This also sounds like the host kernel doesn&#039;t actually include the i915 patch.&#160; I&#039;d start out with making sure you&#039;re really running a kernel patched the way you think it is.</p></div></blockquote></div><p>well, i taken the i915_314.patch from linux-mainline.tar.gz in first post - it differs from vga arbiter patch v3 that may be found in internet. but i tried the v3 one as well with no success</p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1418914">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1418915" class="blockpost roweven"> <h2><span><span class="conr">#1808</span> <a href="viewtopic.php?pid=1418915#p1418915">2014-05-24 18:18:55</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=65027">blacky</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2012-10-26</span></dd> <dd><span>Posts: 10</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=65027">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>alphahere wrote:</cite><blockquote><div><p>I had a similar problem. Change this line below<br />&#160; &#160; &#160; &#160; -device vfio-pci,host=01:00.1,bus=root.1,addr=00.1 \<br />TO THIS:<br />&#160; &#160; &#160; &#160; -device vfio-pci,host=01:00.1,bus=pcie.0 \</p></div></blockquote></div><p>Actually this solved one of my more bizarre issues where my new R290X would stop working whenever I <em>physically</em> removed my old, <strong>not</strong> passed through 4850. I always got a BSoD&#160; from atikmdag.sys “PAGE_FAULT_IN_NONPAGED_AREA”. Changing this solved this issue.</p><p>Now the only issue which remains is that my card is not being reset on VM reboots which causes the same BSoD. Sending the host to ACPI S3 (suspend to RAM, results in a D3Cold for the card thus reseting it — if I got this right) does the trick but of course I have to go to standby and back every time I want to (re-)start the VM. </p><p>Powering off the slot is unfortunately not an option:</p><div class="codebox"><pre><code>root@myhost ~ # ls /sys/bus/pci/slots total 0</code></pre></div><p>Let’s see what my card supports:</p><div class="codebox"><pre class="vscroll"><code>root@myhost ~ # lspci -vvv -s 01:00 01:00.0 VGA compatible controller: Advanced Micro Devices, Inc. [AMD/ATI] Hawaii XT [Radeon HD 8970] (prog-if 00 [VGA controller]) Subsystem: PC Partner Limited / Sapphire Technology Device e285 Control: I/O- Mem- BusMaster- SpecCycle- MemWINV- VGASnoop- ParErr- Stepping- SERR- FastB2B- DisINTx- Status: Cap+ 66MHz- UDF- FastB2B- ParErr- DEVSEL=fast &gt;TAbort- &lt;TAbort- &lt;MAbort- &gt;SERR- &lt;PERR- INTx- Interrupt: pin A routed to IRQ 11 Region 0: Memory at e0000000 (64-bit, prefetchable) [disabled] [size=256M] Region 2: Memory at f0000000 (64-bit, prefetchable) [disabled] [size=8M] Region 4: I/O ports at e000 [disabled] [size=256] Region 5: Memory at f0800000 (32-bit, non-prefetchable) [disabled] [size=256K] Expansion ROM at f0840000 [disabled] [size=128K] Capabilities: [48] Vendor Specific Information: Len=08 &lt;?&gt; Capabilities: [50] Power Management version 3 Flags: PMEClk- DSI- D1+ D2+ AuxCurrent=0mA PME(D0-,D1+,D2+,D3hot+,D3cold-) Status: D0 NoSoftRst+ PME-Enable- DSel=0 DScale=0 PME- Capabilities: [58] Express (v2) Legacy Endpoint, MSI 00 DevCap: MaxPayload 256 bytes, PhantFunc 0, Latency L0s &lt;4us, L1 unlimited ExtTag+ AttnBtn- AttnInd- PwrInd- RBE+ FLReset- DevCtl: Report errors: Correctable- Non-Fatal- Fatal- Unsupported- RlxdOrd- ExtTag+ PhantFunc- AuxPwr- NoSnoop+ MaxPayload 256 bytes, MaxReadReq 512 bytes DevSta: CorrErr+ UncorrErr- FatalErr- UnsuppReq+ AuxPwr- TransPend- LnkCap: Port #0, Speed 8GT/s, Width x16, ASPM L0s L1, Exit Latency L0s &lt;64ns, L1 &lt;1us ClockPM- Surprise- LLActRep- BwNot- LnkCtl: ASPM Disabled; RCB 64 bytes Disabled- CommClk+ ExtSynch- ClockPM- AutWidDis- BWInt- AutBWInt- LnkSta: Speed 8GT/s, Width x16, TrErr- Train- SlotClk+ DLActive- BWMgmt- ABWMgmt- DevCap2: Completion Timeout: Not Supported, TimeoutDis-, LTR-, OBFF Not Supported DevCtl2: Completion Timeout: 50us to 50ms, TimeoutDis-, LTR-, OBFF Disabled LnkCtl2: Target Link Speed: 8GT/s, EnterCompliance- SpeedDis- Transmit Margin: Normal Operating Range, EnterModifiedCompliance- ComplianceSOS- Compliance De-emphasis: -6dB LnkSta2: Current De-emphasis Level: -6dB, EqualizationComplete+, EqualizationPhase1+ EqualizationPhase2+, EqualizationPhase3+, LinkEqualizationRequest- Capabilities: [a0] MSI: Enable- Count=1/1 Maskable- 64bit+ Address: 0000000000000000 Data: 0000 Capabilities: [100 v1] Vendor Specific Information: ID=0001 Rev=1 Len=010 &lt;?&gt; Capabilities: [150 v2] Advanced Error Reporting UESta: DLP- SDES- TLP- FCP- CmpltTO- CmpltAbrt- UnxCmplt- RxOF- MalfTLP- ECRC- UnsupReq- ACSViol- UEMsk: DLP- SDES- TLP- FCP- CmpltTO- CmpltAbrt- UnxCmplt- RxOF- MalfTLP- ECRC- UnsupReq- ACSViol- UESvrt: DLP+ SDES+ TLP- FCP+ CmpltTO- CmpltAbrt- UnxCmplt- RxOF+ MalfTLP+ ECRC- UnsupReq- ACSViol- CESta: RxErr- BadTLP- BadDLLP- Rollover- Timeout- NonFatalErr+ CEMsk: RxErr- BadTLP- BadDLLP- Rollover- Timeout- NonFatalErr+ AERCap: First Error Pointer: 00, GenCap+ CGenEn- ChkCap+ ChkEn- Capabilities: [270 v1] #19 Capabilities: [2b0 v1] Address Translation Service (ATS) ATSCap: Invalidate Queue Depth: 00 ATSCtl: Enable-, Smallest Translation Unit: 00 Capabilities: [2c0 v1] #13 Capabilities: [2d0 v1] #1b Kernel driver in use: vfio-pci Kernel modules: radeon 01:00.1 Audio device: Advanced Micro Devices, Inc. [AMD/ATI] Device aac8 Subsystem: PC Partner Limited / Sapphire Technology Device aac8 Control: I/O+ Mem+ BusMaster+ SpecCycle- MemWINV- VGASnoop- ParErr- Stepping- SERR- FastB2B- DisINTx- Status: Cap+ 66MHz- UDF- FastB2B- ParErr- DEVSEL=fast &gt;TAbort- &lt;TAbort- &lt;MAbort- &gt;SERR- &lt;PERR- INTx- Latency: 0, Cache Line Size: 64 bytes Interrupt: pin B routed to IRQ 10 Region 0: Memory at f0860000 (64-bit, non-prefetchable) [size=16K] Capabilities: [48] Vendor Specific Information: Len=08 &lt;?&gt; Capabilities: [50] Power Management version 3 Flags: PMEClk- DSI- D1+ D2+ AuxCurrent=0mA PME(D0-,D1-,D2-,D3hot-,D3cold-) Status: D0 NoSoftRst+ PME-Enable- DSel=0 DScale=0 PME- Capabilities: [58] Express (v2) Legacy Endpoint, MSI 00 DevCap: MaxPayload 256 bytes, PhantFunc 0, Latency L0s &lt;4us, L1 unlimited ExtTag+ AttnBtn- AttnInd- PwrInd- RBE+ FLReset- DevCtl: Report errors: Correctable- Non-Fatal- Fatal- Unsupported- RlxdOrd- ExtTag+ PhantFunc- AuxPwr- NoSnoop+ MaxPayload 256 bytes, MaxReadReq 512 bytes DevSta: CorrErr+ UncorrErr- FatalErr- UnsuppReq+ AuxPwr- TransPend- LnkCap: Port #0, Speed 8GT/s, Width x16, ASPM L0s L1, Exit Latency L0s &lt;64ns, L1 &lt;1us ClockPM- Surprise- LLActRep- BwNot- LnkCtl: ASPM Disabled; RCB 64 bytes Disabled- CommClk+ ExtSynch- ClockPM- AutWidDis- BWInt- AutBWInt- LnkSta: Speed 8GT/s, Width x16, TrErr- Train- SlotClk+ DLActive- BWMgmt- ABWMgmt- DevCap2: Completion Timeout: Not Supported, TimeoutDis-, LTR-, OBFF Not Supported DevCtl2: Completion Timeout: 50us to 50ms, TimeoutDis-, LTR-, OBFF Disabled LnkSta2: Current De-emphasis Level: -6dB, EqualizationComplete-, EqualizationPhase1- EqualizationPhase2-, EqualizationPhase3-, LinkEqualizationRequest- Capabilities: [a0] MSI: Enable- Count=1/1 Maskable- 64bit+ Address: 0000000000000000 Data: 0000 Capabilities: [100 v1] Vendor Specific Information: ID=0001 Rev=1 Len=010 &lt;?&gt; Capabilities: [150 v2] Advanced Error Reporting UESta: DLP- SDES- TLP- FCP- CmpltTO- CmpltAbrt- UnxCmplt- RxOF- MalfTLP- ECRC- UnsupReq- ACSViol- UEMsk: DLP- SDES- TLP- FCP- CmpltTO- CmpltAbrt- UnxCmplt- RxOF- MalfTLP- ECRC- UnsupReq- ACSViol- UESvrt: DLP+ SDES+ TLP- FCP+ CmpltTO- CmpltAbrt- UnxCmplt- RxOF+ MalfTLP+ ECRC- UnsupReq- ACSViol- CESta: RxErr- BadTLP- BadDLLP- Rollover- Timeout- NonFatalErr+ CEMsk: RxErr- BadTLP- BadDLLP- Rollover- Timeout- NonFatalErr+ AERCap: First Error Pointer: 00, GenCap+ CGenEn- ChkCap+ ChkEn- Kernel driver in use: vfio-pci Kernel modules: snd_hda_intel</code></pre></div><p>As you can see, Function Level Reset is not supported (<strong>FLReset-</strong>). I didn’t check this on my old card (which worked perfectly fine including reboots of the virtual machine).</p><p>D3Hot should be supported though but I haven’t found a way yet to convince the kernel to put it in this state but I guess it wouldn’t help anyway since <strong>NoSoftRst+</strong>.</p><p>Setting power control to auto, unbinding and rebinding didn’t help either. Even if I removed the device and rescanned … Maybe I wasn’t patient enough</p><div class="codebox"><pre><code>root@myhost ~ # echo auto &gt; /sys/bus/pci/devices/0000:00:01.0/power/control root@myhost ~ # echo &#039;0000:01:00.0&#039; &gt; /sys/bus/pci/devices/0000:01:00.0/driver/unbind root@myhost ~ # echo &#039;0000:01:00.1&#039; &gt; /sys/bus/pci/devices/0000:01:00.1/driver/unbind root@myhost ~ # echo 1 &gt; /sys/bus/pci/devices/0000:01:00.0/remove root@myhost ~ # echo 1 &gt; /sys/bus/pci/devices/0000:01:00.1/remove root@myhost ~ # echo 1 &gt; /sys/bus/pci/rescan root@myhost ~ # echo &#039;0000:01:00.0&#039; &gt; /sys/bus/pci/devices/0000:01:00.0/driver/unbind root@myhost ~ # echo &#039;0000:01:00.1&#039; &gt; /sys/bus/pci/devices/0000:01:00.1/driver/unbind root@myhost ~ # echo &#039;0000:01:00.1&#039; &gt; /sys/bus/pci/drivers/vfio-pci/bind root@myhost ~ # echo &#039;0000:01:00.0&#039; &gt; /sys/bus/pci/drivers/vfio-pci/bind</code></pre></div><p>See the documentation on <a href="https://www.kernel.org/doc/Documentation/ABI/testing/sysfs-bus-pci" rel="nofollow">sysfs-bus-pci</a> for explanation. </p><p>I also explored other options like setpci and AMD ZeroCore but did not find anything useful I could leverage so far.&#160; </p><p>For today I’m giving up; at least I was able to solve one of my issues and, quite frankly, it was the more important one. The fans of the old card were either dead or close to it resulting in nice “atmospheric sound” and the card itself did not really improve the thermal landscape. Keeping you posted.</p><p>For further reference: <br />Motherboard: ASRock Z87 Extreme6<br />Processor: Intel Core i7-4771<br />Host graphics card: Intel HD Graphics 4600<br />Passthrough device: Sapphire Radeon R9 290X Tri-X OC<br />OS: Arch Linux x86_64<br />Kernel: linux-mainline (3.14.1 includes acs override patch, i935 vga arbiter fixes, debug registers patch — custom config)<br />qemu: default (2.0.0-3)<br />seabios: default (1.7.3.1-2)<br />Status: Working <br />Constraints: Bus reset and CCC <strong>not</strong> working, loading VBIOS.</p> <p class="postedit"><em>Last edited by blacky (2014-05-24 18:19:42)</em></p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1418915">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1418920" class="blockpost rowodd"> <h2><span><span class="conr">#1809</span> <a href="viewtopic.php?pid=1418920#p1418920">2014-05-24 18:43:11</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=75590">aw</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2013-10-04</span></dd> <dd><span>Posts: 921</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=75590">Email</a></span> <span class="website"><a href="http://vfio.blogspot.com/" rel="nofollow">Website</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>sinny wrote:</cite><blockquote><div><div class="quotebox"><cite>aw wrote:</cite><blockquote><div><p>This doesn&#039;t prove anything, in fact it just looks like you&#039;re running the f20 distro kernel and not one recompiled to include the i915 patch.&#160; Are you trying to rebuild the kernel rpm?</p></div></blockquote></div><p>well, all i wanted to &quot;prove&quot; - is that module currently loaded is the one rebuild by me and manually placed in module updates directory<br />correct me if i&#039;m wrong, but vga arbiter patch only involves i915 module, not the kernel itself.</p></div></blockquote></div><p>But it doesn&#039;t do that either.&#160; I think all it shows is that modinfo thinks that&#039;s the module that would load, but that&#039;s after you&#039;ve already booted, there may be a different i915.ko in your initramfs.</p><div class="quotebox"><blockquote><div><div class="quotebox"><cite>aw wrote:</cite><blockquote><div><p>This also sounds like the host kernel doesn&#039;t actually include the i915 patch.&#160; I&#039;d start out with making sure you&#039;re really running a kernel patched the way you think it is.</p></div></blockquote></div><p>well, i taken the i915_314.patch from linux-mainline.tar.gz in first post - it differs from vga arbiter patch v3 that may be found in internet. but i tried the v3 one as well with no success</p></div></blockquote></div><p>I&#039;ve tried to get something upstream again recently, so this is the latest patch - <a href="https://lkml.org/lkml/2014/5/9/517" rel="nofollow">https://lkml.org/lkml/2014/5/9/517</a></p><p>The maintainer won&#039;t have it because he thinks that adding a module option is admitting defeat and will prevent anyone from solving the problem (while at the same time not coming up with any workable solution himself).&#160; The nice thing about this patch in your situation is that we can tell if you&#039;re running the right module by whether /sys/modules/i915/parameters/enable_hd_vgaarb is present (the one in the currently running module, not the one on disk somewhere).&#160; You will need to set this with a module option in your /etc/modprobe.d/ (and rebuild the initramfs) to make it work.</p> </div> <div class="postsignature postmsg"><hr /><p><a href="http://vfio.blogspot.com" rel="nofollow">http://vfio.blogspot.com</a><br />Looking for a more open forum to discuss vfio related uses?&#160; Try <a href="https://www.redhat.com/mailman/listinfo/vfio-users" rel="nofollow">https://www.redhat.com/mailman/listinfo/vfio-users</a></p></div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1418920">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1418930" class="blockpost roweven"> <h2><span><span class="conr">#1810</span> <a href="viewtopic.php?pid=1418930#p1418930">2014-05-24 19:45:31</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=82238">sinny</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2014-05-24</span></dd> <dd><span>Posts: 75</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=82238">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>aw wrote:</cite><blockquote><div><div class="quotebox"><cite>sinny wrote:</cite><blockquote><div><div class="quotebox"><cite>aw wrote:</cite><blockquote><div><p>This doesn&#039;t prove anything, in fact it just looks like you&#039;re running the f20 distro kernel and not one recompiled to include the i915 patch.&#160; Are you trying to rebuild the kernel rpm?</p></div></blockquote></div><p>well, all i wanted to &quot;prove&quot; - is that module currently loaded is the one rebuild by me and manually placed in module updates directory<br />correct me if i&#039;m wrong, but vga arbiter patch only involves i915 module, not the kernel itself.</p></div></blockquote></div><p>But it doesn&#039;t do that either.&#160; I think all it shows is that modinfo thinks that&#039;s the module that would load, but that&#039;s after you&#039;ve already booted, there may be a different i915.ko in your initramfs.</p><div class="quotebox"><blockquote><div><div class="quotebox"><cite>aw wrote:</cite><blockquote><div><p>This also sounds like the host kernel doesn&#039;t actually include the i915 patch.&#160; I&#039;d start out with making sure you&#039;re really running a kernel patched the way you think it is.</p></div></blockquote></div><p>well, i taken the i915_314.patch from linux-mainline.tar.gz in first post - it differs from vga arbiter patch v3 that may be found in internet. but i tried the v3 one as well with no success</p></div></blockquote></div><p>I&#039;ve tried to get something upstream again recently, so this is the latest patch - <a href="https://lkml.org/lkml/2014/5/9/517" rel="nofollow">https://lkml.org/lkml/2014/5/9/517</a></p><p>The maintainer won&#039;t have it because he thinks that adding a module option is admitting defeat and will prevent anyone from solving the problem (while at the same time not coming up with any workable solution himself).&#160; The nice thing about this patch in your situation is that we can tell if you&#039;re running the right module by whether /sys/modules/i915/parameters/enable_hd_vgaarb is present (the one in the currently running module, not the one on disk somewhere).&#160; You will need to set this with a module option in your /etc/modprobe.d/ (and rebuild the initramfs) to make it work.</p></div></blockquote></div><p>ok, you were right on the initramfs point - i completely forgot about it</p><p>tried applying your latest patch with no luck to my stock kernel sources - seems like entire drm code branch received quite a bit of work.<br />after that tried rebuilding i915 module with i915_314.patch from linux-mainline.tar.gz in first post, but now rebuilding initramfs as well - got corrupted graphics on boot as a result. could not even see tty consoles. the good point is that now i can be sure that rebuilt module was loaded )</p><p>will try to figure out next course of actions to take</p><p>for now thank you very much for pointing out my lack of understanding of what am i doing at all</p> <p class="postedit"><em>Last edited by sinny (2014-05-24 19:46:58)</em></p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1418930">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1418938" class="blockpost rowodd"> <h2><span><span class="conr">#1811</span> <a href="viewtopic.php?pid=1418938#p1418938">2014-05-24 20:42:14</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=82136">Chrissi</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2014-05-20</span></dd> <dd><span>Posts: 5</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=82136">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>aw wrote:</cite><blockquote><div><p>Google for &quot;ACS override&quot;, apply the patch you find and enable it via kernel options.&#160; If one of the cards can be attached to a PCH root port (00:1c.*), the v3.15 kernel may help.</p></div></blockquote></div><div class="quotebox"><cite>Chrissi wrote:</cite><blockquote><div><p>I just installed the new 3.15-rc6 kernel which in my understanding contains the acs override patch.</p></div></blockquote></div><div class="quotebox"><cite>aw wrote:</cite><blockquote><div><p>Nope, 3.15 includes quirks approved by Intel to advertise the ACS-like isolation capabilities of PCH-based root ports and make sure they&#039;re enabled.&#160; This means that the hardware is actually providing the isolation required.&#160; The ACS override patch is a way for the user to override the hardware isolation requirement and is not going upstream.</p></div></blockquote></div><p>With 3.14 and the ACS patch I got 3 vfio groups, one for every card and I am able to pass them to any vm in any combination I want while running them parallel.(I didnt know I had to enable acs in the grub cmdline)<br />Just for others, my setup is an i7 4770 with an asrock z87 extreme 6 and 3x 290x running arch with 3.14-1 mainline provided by OP. Looks like I got 4 PCH root ports. Everything is now running fine and smooth. <br />Thank you very much !</p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1418938">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1419020" class="blockpost roweven"> <h2><span><span class="conr">#1812</span> <a href="viewtopic.php?pid=1419020#p1419020">2014-05-25 02:53:37</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=82203">shelladept</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2014-05-22</span></dd> <dd><span>Posts: 4</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=82203">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <p>Hello,</p><p>Thanks again for the help so far.&#160; I patched in &#039;i915_314.patch&#039; and recompiled my kernel.&#160; I used 3.15-rc6 since the page 1 <a href="https://aur.archlinux.org/packages/linux-mainline/" rel="nofollow">linux-mainline link</a> appears to direct to 3.15-rc6 anyway (though other posts seem to refute what I&#039;m seeing).&#160; This cleared up the graphical issues on my host.&#160; Now everything appears to be mostly working.&#160; I haven&#039;t encountered any issues with my Debian test guest (so far).&#160; </p><p>There are Windows issues though.&#160; I am able to successfully install Window 7 SP1 but hit a snag as soon as I attempt to update said guest.&#160; I&#039;ve tried a few different update strategies and noted different behaviors.&#160; When I tried updating all 150 or so updates at once everything appears fine until Windows attempts to reboot.&#160; Post-reboot I am greeted with the Windows repair utilities which are unable to fix the now-broken install.&#160; This problem seems to stem from cumulative security updates and other major system updates.&#160; Some updates are okay alone (for example, Windows Explorer 11).&#160; </p><p>When I try applying just the Radeon driver for my 4770 (via Windows Update), my host system freezes.&#160; After restarting my host I am able to reboot the Windows guest *once* with the device software having installed &quot;successfully&quot;.&#160; Subsequent Windows guest restarts lead to BSODs, however.</p><p>Does this sound like a previously discussed issue that I&#039;ve missed? Maybe an issue related to another .patch from the page 1 download?&#160; Or might I have introduced odd behavior by applying the i915_3.14 patch to a kernel higher than 3.14.1?</p><p>I found an issue that was possibly related on page 62/66:</p><div class="quotebox"><cite>Nex7 wrote:</cite><blockquote><div><p>&quot;EDIT: Of course, starting over with a fresh Win7 x64 install using ide instead of virtio, it works fine up until I try to install Windows updates, even only a few of them, at which point after reboot it dies with a different BSOD, code c000021a. -sigh-&quot;</p></div></blockquote></div><p>Except I do not get a blue screen in all my tests.&#160; Fruitless restarts with the repair utilities are more common.&#160; I am using ide-hd for my disk though.</p><p>I&#039;m not sure what logs might provide useful information related to this issue.&#160; I noted some logs in /var/log/libvirt/qemu which seem to be restricted to VMs created with virt-manager.&#160; /var/log/libvirt/libvirtd.log doesn&#039;t appear to have related information either.&#160; &#160;Please let me know if anybody has any suggestions.&#160; I can&#039;t thank the contributors to this thread enough!</p><p>shelladept</p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1419020">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1419025" class="blockpost rowodd"> <h2><span><span class="conr">#1813</span> <a href="viewtopic.php?pid=1419025#p1419025">2014-05-25 03:18:52</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=82238">sinny</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2014-05-24</span></dd> <dd><span>Posts: 75</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=82238">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>sinny wrote:</cite><blockquote><div><div class="quotebox"><cite>aw wrote:</cite><blockquote><div><div class="quotebox"><cite>sinny wrote:</cite><blockquote><div><p>well, all i wanted to &quot;prove&quot; - is that module currently loaded is the one rebuild by me and manually placed in module updates directory<br />correct me if i&#039;m wrong, but vga arbiter patch only involves i915 module, not the kernel itself.</p></div></blockquote></div><p>But it doesn&#039;t do that either.&#160; I think all it shows is that modinfo thinks that&#039;s the module that would load, but that&#039;s after you&#039;ve already booted, there may be a different i915.ko in your initramfs.</p><div class="quotebox"><blockquote><div><p>well, i taken the i915_314.patch from linux-mainline.tar.gz in first post - it differs from vga arbiter patch v3 that may be found in internet. but i tried the v3 one as well with no success</p></div></blockquote></div><p>I&#039;ve tried to get something upstream again recently, so this is the latest patch - <a href="https://lkml.org/lkml/2014/5/9/517" rel="nofollow">https://lkml.org/lkml/2014/5/9/517</a></p><p>The maintainer won&#039;t have it because he thinks that adding a module option is admitting defeat and will prevent anyone from solving the problem (while at the same time not coming up with any workable solution himself).&#160; The nice thing about this patch in your situation is that we can tell if you&#039;re running the right module by whether /sys/modules/i915/parameters/enable_hd_vgaarb is present (the one in the currently running module, not the one on disk somewhere).&#160; You will need to set this with a module option in your /etc/modprobe.d/ (and rebuild the initramfs) to make it work.</p></div></blockquote></div><p>ok, you were right on the initramfs point - i completely forgot about it</p><p>tried applying your latest patch with no luck to my stock kernel sources - seems like entire drm code branch received quite a bit of work.<br />after that tried rebuilding i915 module with i915_314.patch from linux-mainline.tar.gz in first post, but now rebuilding initramfs as well - got corrupted graphics on boot as a result. could not even see tty consoles. the good point is that now i can be sure that rebuilt module was loaded )</p><p>will try to figure out next course of actions to take</p><p>for now thank you very much for pointing out my lack of understanding of what am i doing at all</p></div></blockquote></div><p>switched to fedora mainline kernel (3.15-rc5), applied your latest vga arbiter patch to i915 module, rebuilt i915 module - resulted in the same behavior i got in my previous attempt (3.14 with i915_314.patch). screen gets corrupted when X login manager starts ( i use slim, but dont think it actually matters). switching to ttys resets screen to black and stays this way whatever i try to do.</p><p>what can i do to further investigate this? maybe some X settings are needed as well?</p> <p class="postedit"><em>Last edited by sinny (2014-05-25 03:19:52)</em></p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1419025">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1419026" class="blockpost roweven"> <h2><span><span class="conr">#1814</span> <a href="viewtopic.php?pid=1419026#p1419026">2014-05-25 03:24:12</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=75590">aw</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2013-10-04</span></dd> <dd><span>Posts: 921</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=75590">Email</a></span> <span class="website"><a href="http://vfio.blogspot.com/" rel="nofollow">Website</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <p>Did you set the enable_hd_vgaarb i915 option?</p> </div> <div class="postsignature postmsg"><hr /><p><a href="http://vfio.blogspot.com" rel="nofollow">http://vfio.blogspot.com</a><br />Looking for a more open forum to discuss vfio related uses?&#160; Try <a href="https://www.redhat.com/mailman/listinfo/vfio-users" rel="nofollow">https://www.redhat.com/mailman/listinfo/vfio-users</a></p></div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1419026">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1419033" class="blockpost rowodd"> <h2><span><span class="conr">#1815</span> <a href="viewtopic.php?pid=1419033#p1419033">2014-05-25 04:28:23</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=81948">thehighhat</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2014-05-12</span></dd> <dd><span>Posts: 5</span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>thehighhat wrote:</cite><blockquote><div><div class="quotebox"><cite>AKSN74 wrote:</cite><blockquote><div><div class="quotebox"><cite>aw wrote:</cite><blockquote><div><p>Upgrade to 3.15 and you won&#039;t need the ACS override patch.&#160; That doesn&#039;t mean that the Marvell card is going to work, because it&#039;s terribly broken (remember those DMA patches you&#039;ve applied?)</p></div></blockquote></div><p>Hi, aw.</p><p>I found that not only VM hangs when reboot with 2 VMs working together, but also only 1 VM working.</p><p>And I tried to shutdown, not reboot, it can back to tty successfully.<br />But when I try to start again with same command, it got another error message.</p><div class="codebox"><pre><code>qemu-system-x86_64: vfio-pci: Cannot read device rom at 0000:03:00.0 Device option ROM contents are probably invalid (check dmesg). Skip option ROM probe with rombar=0, or load from file with romfile=</code></pre></div><p>It&#039;s may a reason why it hangs when reboot.<br />But I found that when&#160; I reboot VM while guest OS is Windows 7, it can reboot successfully some times.<br />So it is very strange for this problem.......</p><p>I&#039;ll try to use 3.14.4 kernel and see it still a same problem or not.</p></div></blockquote></div><br /><p>Same problem here.&#160; I cannot reboot or reissue the qemu command without this error.&#160; Do I need to undo the vfio-bind stuffs?</p></div></blockquote></div><br /><p>Fixed.&#160; I needed to download the rom file from <a href="http://www.techpowerup.com/vgabios/" rel="nofollow">http://www.techpowerup.com/vgabios/</a> .&#160; &#160;Then add romfile=/path/to/romfile.rom to the -device line for the GPU.</p><p>Also changed the -cpu from type &quot;host&quot; to &quot;qemu64&quot;</p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1419033">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1419034" class="blockpost roweven"> <h2><span><span class="conr">#1816</span> <a href="viewtopic.php?pid=1419034#p1419034">2014-05-25 04:31:04</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=82238">sinny</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2014-05-24</span></dd> <dd><span>Posts: 75</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=82238">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>aw wrote:</cite><blockquote><div><p>Did you set the enable_hd_vgaarb i915 option?</p></div></blockquote></div><p>previously - no<br />just tried setting in with no change in behavior - corrupted display on X start. on the other hand, just to see whether its just gpu die or the whole system - successfully ssh&#039;ed to system.<br />journal is full of lines like that:</p><div class="codebox"><pre class="vscroll"><code>... May 25 08:19:35 localhost.localdomain kernel: dmar: DRHD: handling fault status reg 2 May 25 08:19:35 localhost.localdomain systemd-journal[477]: Missed 43 kernel messages May 25 08:19:35 localhost.localdomain kernel: dmar: DRHD: handling fault status reg 3 May 25 08:19:35 localhost.localdomain systemd-journal[477]: Missed 44 kernel messages May 25 08:19:35 localhost.localdomain kernel: dmar: DRHD: handling fault status reg 3 May 25 08:19:35 localhost.localdomain systemd-journal[477]: Missed 44 kernel messages May 25 08:19:35 localhost.localdomain kernel: dmar: DRHD: handling fault status reg 2 May 25 08:19:35 localhost.localdomain systemd-journal[477]: Missed 44 kernel messages May 25 08:19:35 localhost.localdomain kernel: dmar: DMAR:[DMA Read] Request device [00:02.0] fault addr 7fcd0000 DMAR:[fault reason 06] PTE Read access is not set May 25 08:19:35 localhost.localdomain systemd-journal[477]: Missed 59 kernel messages May 25 08:19:35 localhost.localdomain kernel: dmar: DMAR:[DMA Read] Request device [00:02.0] fault addr 7fce4000 DMAR:[fault reason 06] PTE Read access is not set May 25 08:19:35 localhost.localdomain systemd-journal[477]: Missed 44 kernel messages May 25 08:19:35 localhost.localdomain kernel: dmar: DMAR:[DMA Read] Request device [00:02.0] fault addr 7fcf4000 DMAR:[fault reason 06] PTE Read access is not set May 25 08:19:35 localhost.localdomain systemd-journal[477]: Missed 45 kernel messages May 25 08:19:35 localhost.localdomain kernel: dmar: DMAR:[DMA Read] Request device [00:02.0] fault addr 7fd03000 DMAR:[fault reason 06] PTE Read access is not set May 25 08:19:35 localhost.localdomain systemd-journal[477]: Missed 43 kernel messages May 25 08:19:35 localhost.localdomain kernel: dmar: DRHD: handling fault status reg 2 May 25 08:19:35 localhost.localdomain systemd-journal[477]: Missed 45 kernel messages May 25 08:19:35 localhost.localdomain kernel: dmar: DRHD: handling fault status reg 3 May 25 08:19:35 localhost.localdomain systemd-journal[477]: Missed 46 kernel messages May 25 08:19:35 localhost.localdomain kernel: dmar: DMAR:[DMA Read] Request device [00:02.0] fault addr 7fd32000 DMAR:[fault reason 06] PTE Read access is not set ...</code></pre></div><p>seems like on screen corruption it just keeps spamming these. i doubt they are meaningful though, useful errors were probably at the very beginning</p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1419034">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1419102" class="blockpost rowodd"> <h2><span><span class="conr">#1817</span> <a href="viewtopic.php?pid=1419102#p1419102">2014-05-25 13:12:08</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=79471">Bronek</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>From: London</span></dd> <dd><span>Registered: 2014-02-14</span></dd> <dd><span>Posts: 90</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=79471">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>aw wrote:</cite><blockquote><div><p> So vfio comes along and tries to lock VGA resources on the other card and the arbiter skips disabling VGA on the radeon bridge because the device doesn&#039;t decode VGA.&#160; The patch below gratuitously disables VGA on any potentially conflicting bridge on every vga_get, which makes VGA access even slower (not that we care so much since VGA stops being used shortly after the guest OS starts running).&#160; I&#039;ll probably rework the code more for upstream to allow devices to own resources they don&#039;t decode rather than just lock them.&#160; Enjoy.</p></div></blockquote></div><p>This seems like something a headless host (like mine) would benefit from, do you plan to push this/similar behaviour to official kernel with kernel option to switch it on? Ideally I would like to be able to use two GPUs each assigned to one VMs (I have enough resources to run 2 VMs concurrently, just not enough slots for more GPUs) while the host runs headless.</p><p>Thanks for your work on passthrough and please let us known when this gets into official RH release (I will probably use Fedora until then) <img src="https://bbs.archlinux.org/img/smilies/smile.png" width="15" height="15" alt="smile" /></p> </div> <div class="postsignature postmsg"><hr /><p>Sorry about&#160; &quot;KVM VGA-Passthrough ...&quot; thread <img src="https://bbs.archlinux.org/img/smilies/sad.png" width="15" height="15" alt="sad" /> Anyone interested in continuing this discussion elsewhere, please contact me privately. I might be able to find it a new home.</p></div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1419102">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1419146" class="blockpost roweven"> <h2><span><span class="conr">#1818</span> <a href="viewtopic.php?pid=1419146#p1419146">2014-05-25 17:09:20</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=79237">mbroemme</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>From: Cologne</span></dd> <dd><span>Registered: 2014-02-05</span></dd> <dd><span>Posts: 39</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=79237">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>blacky wrote:</cite><blockquote><div><p>As you can see, Function Level Reset is not supported (<strong>FLReset-</strong>). I didn’t check this on my old card (which worked perfectly fine including reboots of the virtual machine).</p><p>D3Hot should be supported though but I haven’t found a way yet to convince the kernel to put it in this state but I guess it wouldn’t help anyway since <strong>NoSoftRst+</strong>.</p></div></blockquote></div><p>It looks like no AMD Radeon R9 290X supports any kind of reset anymore. <img src="https://bbs.archlinux.org/img/smilies/sad.png" width="15" height="15" alt="sad" /> You are not alone as I have the same problem.</p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1419146">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1419159" class="blockpost rowodd"> <h2><span><span class="conr">#1819</span> <a href="viewtopic.php?pid=1419159#p1419159">2014-05-25 18:12:29</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=79237">mbroemme</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>From: Cologne</span></dd> <dd><span>Registered: 2014-02-05</span></dd> <dd><span>Posts: 39</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=79237">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>aw wrote:</cite><blockquote><div><p>That patch isn&#039;t effective, don&#039;t bother with it.&#160; This one seems to work for me, but it&#039;s more heavyweight than I&#039;d like.&#160; The problem sequence is that Xorg tries to lock VGA resources which triggers some first access callbacks.&#160; The callback in the radeon code tells the arbiter that the device no longer decodes VGA resources.&#160; Now, the arbiter still let&#039;s a process lock resources that the device doesn&#039;t decode, but it loses track of them when they&#039;re released.&#160; So vfio comes along and tries to lock VGA resources on the other card and the arbiter skips disabling VGA on the radeon bridge because the device doesn&#039;t decode VGA.&#160; The patch below gratuitously disables VGA on any potentially conflicting bridge on every vga_get, which makes VGA access even slower (not that we care so much since VGA stops being used shortly after the guest OS starts running).&#160; I&#039;ll probably rework the code more for upstream to allow devices to own resources they don&#039;t decode rather than just lock them.&#160; Enjoy.</p><div class="codebox"><pre><code>--- a/drivers/gpu/vga/vgaarb.c +++ b/drivers/gpu/vga/vgaarb.c @@ -244,8 +244,12 @@ static struct vga_device *__vga_tryget(struct vga_device *v */ WARN_ON(conflict-&gt;owns &amp; ~conflict-&gt;decodes); match = lwants &amp; conflict-&gt;owns; - if (!match) + if (!match) { + if (change_bridge) + pci_set_vga_state(conflict-&gt;pdev, false, 0, + PCI_VGA_STATE_CHANGE_BRIDGE); continue; + } /1 /bin /boot /cdrom /dev /etc /home /initrd.img /initrd.img.old /lib /lib32 /lib64 /libx32 /lost+found /media /mnt /opt /proc /root /run /sbin /srv /sys /tmp /ubiquity-apt-clone /usr /var /vmlinuz /vmlinuz.old /win81-base.qcow2 /win81-base.qcow2.md5 /win81-writable-amd.qcow2 /win81-writable-nvidia.qcow2 /win81-writable-nvidia.qcow2.backup looks like he doesn&#039;t have a lock, we can steal 1.sh topic_10.html topic_11.html topic_12.html topic_13.html topic_14.html topic_15.html topic_16.html topic_17.html topic_18.html topic_19.html topic_1.html topic_20.html topic_21.html topic_22.html topic_23.html topic_24.html topic_25.html topic_26.html topic_27.html topic_28.html topic_29.html topic_2.html topic_30.html topic_31.html topic_32.html topic_33.html topic_34.html topic_35.html topic_36.html topic_37.html topic_38.html topic_39.html topic_3.html topic_40.html topic_41.html topic_42.html topic_43.html topic_44.html topic_45.html topic_46.html topic_47.html topic_48.html topic_49.html topic_4.html topic_50.html topic_51.html topic_52.html topic_53.html topic_54.html topic_55.html topic_56.html topic_57.html topic_58.html topic_59.html topic_5.html topic_60.html topic_61.html topic_62.html topic_63.html topic_64.html topic_65.html topic_66.html topic_67.html topic_68.html topic_69.html topic_6.html topic_70.html topic_71.html topic_72.html topic_7.html topic_8.html topic_9.html them from him</code></pre></div><p>dropbox link since the forum will break formatting - <a href="https://dl.dropboxusercontent.com/u/19831938/vgaarb-gratuitous-bridge-vga-disable.patch" rel="nofollow">https://dl.dropboxusercontent.com/u/198 … able.patch</a></p></div></blockquote></div><p>Alex, this patch works fine. I will apply until a better solution is upstream. <img src="https://bbs.archlinux.org/img/smilies/smile.png" width="15" height="15" alt="smile" /> So only problem left is reset - well known for not reliable working on AMD GPUs.</p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1419159">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1419161" class="blockpost roweven"> <h2><span><span class="conr">#1820</span> <a href="viewtopic.php?pid=1419161#p1419161">2014-05-25 18:17:34</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=75590">aw</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2013-10-04</span></dd> <dd><span>Posts: 921</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=75590">Email</a></span> <span class="website"><a href="http://vfio.blogspot.com/" rel="nofollow">Website</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>mbroemme wrote:</cite><blockquote><div><div class="quotebox"><cite>aw wrote:</cite><blockquote><div><p>That patch isn&#039;t effective, don&#039;t bother with it.&#160; This one seems to work for me, but it&#039;s more heavyweight than I&#039;d like.&#160; The problem sequence is that Xorg tries to lock VGA resources which triggers some first access callbacks.&#160; The callback in the radeon code tells the arbiter that the device no longer decodes VGA resources.&#160; Now, the arbiter still let&#039;s a process lock resources that the device doesn&#039;t decode, but it loses track of them when they&#039;re released.&#160; So vfio comes along and tries to lock VGA resources on the other card and the arbiter skips disabling VGA on the radeon bridge because the device doesn&#039;t decode VGA.&#160; The patch below gratuitously disables VGA on any potentially conflicting bridge on every vga_get, which makes VGA access even slower (not that we care so much since VGA stops being used shortly after the guest OS starts running).&#160; I&#039;ll probably rework the code more for upstream to allow devices to own resources they don&#039;t decode rather than just lock them.&#160; Enjoy.</p><div class="codebox"><pre><code>--- a/drivers/gpu/vga/vgaarb.c +++ b/drivers/gpu/vga/vgaarb.c @@ -244,8 +244,12 @@ static struct vga_device *__vga_tryget(struct vga_device *v */ WARN_ON(conflict-&gt;owns &amp; ~conflict-&gt;decodes); match = lwants &amp; conflict-&gt;owns; - if (!match) + if (!match) { + if (change_bridge) + pci_set_vga_state(conflict-&gt;pdev, false, 0, + PCI_VGA_STATE_CHANGE_BRIDGE); continue; + } /1 /bin /boot /cdrom /dev /etc /home /initrd.img /initrd.img.old /lib /lib32 /lib64 /libx32 /lost+found /media /mnt /opt /proc /root /run /sbin /srv /sys /tmp /ubiquity-apt-clone /usr /var /vmlinuz /vmlinuz.old /win81-base.qcow2 /win81-base.qcow2.md5 /win81-writable-amd.qcow2 /win81-writable-nvidia.qcow2 /win81-writable-nvidia.qcow2.backup looks like he doesn&#039;t have a lock, we can steal 1.sh topic_10.html topic_11.html topic_12.html topic_13.html topic_14.html topic_15.html topic_16.html topic_17.html topic_18.html topic_19.html topic_1.html topic_20.html topic_21.html topic_22.html topic_23.html topic_24.html topic_25.html topic_26.html topic_27.html topic_28.html topic_29.html topic_2.html topic_30.html topic_31.html topic_32.html topic_33.html topic_34.html topic_35.html topic_36.html topic_37.html topic_38.html topic_39.html topic_3.html topic_40.html topic_41.html topic_42.html topic_43.html topic_44.html topic_45.html topic_46.html topic_47.html topic_48.html topic_49.html topic_4.html topic_50.html topic_51.html topic_52.html topic_53.html topic_54.html topic_55.html topic_56.html topic_57.html topic_58.html topic_59.html topic_5.html topic_60.html topic_61.html topic_62.html topic_63.html topic_64.html topic_65.html topic_66.html topic_67.html topic_68.html topic_69.html topic_6.html topic_70.html topic_71.html topic_72.html topic_7.html topic_8.html topic_9.html them from him</code></pre></div><p>dropbox link since the forum will break formatting - <a href="https://dl.dropboxusercontent.com/u/19831938/vgaarb-gratuitous-bridge-vga-disable.patch" rel="nofollow">https://dl.dropboxusercontent.com/u/198 … able.patch</a></p></div></blockquote></div><p>Alex, this patch works fine. I will apply until a better solution is upstream. <img src="https://bbs.archlinux.org/img/smilies/smile.png" width="15" height="15" alt="smile" /> So only problem left is reset - well known for not reliable working on AMD GPUs.</p></div></blockquote></div><div class="codebox"><pre><code>diff --git a/hw/misc/vfio.c b/hw/misc/vfio.c index 76715cc..bdb6126 100644 --- a/hw/misc/vfio.c +++ b/hw/misc/vfio.c @@ -3350,7 +3350,7 @@ static void vfio_pci_reset_handler(void *opaque) QLIST_FOREACH(group, &amp;group_list, next) { QLIST_FOREACH(vdev, &amp;group-&gt;device_list, next) { - if (!vdev-&gt;reset_works || (!vdev-&gt;has_flr &amp;&amp; vdev-&gt;has_pm_reset)) { + if (!vdev-&gt;reset_works || !vdev-&gt;has_flr) { vdev-&gt;needs_reset = true; } }</code></pre></div> </div> <div class="postsignature postmsg"><hr /><p><a href="http://vfio.blogspot.com" rel="nofollow">http://vfio.blogspot.com</a><br />Looking for a more open forum to discuss vfio related uses?&#160; Try <a href="https://www.redhat.com/mailman/listinfo/vfio-users" rel="nofollow">https://www.redhat.com/mailman/listinfo/vfio-users</a></p></div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1419161">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1419164" class="blockpost rowodd"> <h2><span><span class="conr">#1821</span> <a href="viewtopic.php?pid=1419164#p1419164">2014-05-25 18:40:13</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=79237">mbroemme</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>From: Cologne</span></dd> <dd><span>Registered: 2014-02-05</span></dd> <dd><span>Posts: 39</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=79237">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>aw wrote:</cite><blockquote><div><div class="codebox"><pre><code>diff --git a/hw/misc/vfio.c b/hw/misc/vfio.c index 76715cc..bdb6126 100644 --- a/hw/misc/vfio.c +++ b/hw/misc/vfio.c @@ -3350,7 +3350,7 @@ static void vfio_pci_reset_handler(void *opaque) QLIST_FOREACH(group, &amp;group_list, next) { QLIST_FOREACH(vdev, &amp;group-&gt;device_list, next) { - if (!vdev-&gt;reset_works || (!vdev-&gt;has_flr &amp;&amp; vdev-&gt;has_pm_reset)) { + if (!vdev-&gt;reset_works || !vdev-&gt;has_flr) { vdev-&gt;needs_reset = true; } }</code></pre></div></div></blockquote></div><p>Alex I tried it already as you posted it a couple of weeks ago on qemu-devel <img src="https://bbs.archlinux.org/img/smilies/smile.png" width="15" height="15" alt="smile" /> but this doesn&#039;t help on my R9 290X. Windows VM still got BSOD on reboot. Linux VM with fglrx got kernel oops once X is started. Only thing which works is Linux VM with radeon driver but this is still more or less useless test as HAWAII XT is unaccelerated in X at all for now due to stability concerns.</p> <p class="postedit"><em>Last edited by mbroemme (2014-05-25 18:41:18)</em></p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1419164">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1419167" class="blockpost roweven"> <h2><span><span class="conr">#1822</span> <a href="viewtopic.php?pid=1419167#p1419167">2014-05-25 18:57:38</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=75590">aw</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2013-10-04</span></dd> <dd><span>Posts: 921</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=75590">Email</a></span> <span class="website"><a href="http://vfio.blogspot.com/" rel="nofollow">Website</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>mbroemme wrote:</cite><blockquote><div><div class="quotebox"><cite>aw wrote:</cite><blockquote><div><div class="codebox"><pre><code>diff --git a/hw/misc/vfio.c b/hw/misc/vfio.c index 76715cc..bdb6126 100644 --- a/hw/misc/vfio.c +++ b/hw/misc/vfio.c @@ -3350,7 +3350,7 @@ static void vfio_pci_reset_handler(void *opaque) QLIST_FOREACH(group, &amp;group_list, next) { QLIST_FOREACH(vdev, &amp;group-&gt;device_list, next) { - if (!vdev-&gt;reset_works || (!vdev-&gt;has_flr &amp;&amp; vdev-&gt;has_pm_reset)) { + if (!vdev-&gt;reset_works || !vdev-&gt;has_flr) { vdev-&gt;needs_reset = true; } }</code></pre></div></div></blockquote></div><p>Alex I tried it already as you posted it a couple of weeks ago on qemu-devel <img src="https://bbs.archlinux.org/img/smilies/smile.png" width="15" height="15" alt="smile" /> but this doesn&#039;t help on my R9 290X. Windows VM still got BSOD on reboot. Linux VM with fglrx got kernel oops once X is started. Only thing which works is Linux VM with radeon driver but this is still more or less useless test as HAWAII XT is unaccelerated in X at all for now due to stability concerns.</p></div></blockquote></div><p>I guess I keep posting it because I don&#039;t know why it doesn&#039;t work.&#160; I added an HD8570 to my collection, since it seems to be based on the same generation of chips as the latest, but it works well.&#160; Can you manually test whether the card is affected by a bus reset?&#160; Try getting the device with something on the screen, ex. quit QEMU while the device is at seabios.&#160; Find the bridge upstream from the device, ex</p><div class="codebox"><pre><code>$ lspci -tv | grep AMD +-01.0-[01]--+-00.0 Advanced Micro Devices, Inc. [AMD/ATI] Oland [Radeon HD 8570 / R7 240 OEM] | \-00.1 Advanced Micro Devices, Inc. [AMD/ATI] Cape Verde/Pitcairn HDMI Audio [Radeon HD 7700/7800 Series]</code></pre></div><p>00:01.0 is the upstream bridge.</p><p>Read the bridge control register</p><div class="codebox"><pre><code>$ sudo setpci -s 00:01.0 3e.w 0018</code></pre></div><p>OR 0x40 into the result</p><div class="codebox"><pre><code>$ printf %04x $(( 0x0018 | 0x40 )) 0058</code></pre></div><p>Write this to the same register:</p><div class="codebox"><pre><code>$ sudo sudo setpci -s 00:01.0 3e.w=0058</code></pre></div><p>Then restore the original value:</p><div class="codebox"><pre><code>$ sudo sudo setpci -s 00:01.0 3e.w=0018</code></pre></div><p>If the bus reset works, then the screen should have cleared and the monitor gone out of sync.&#160; If nothing happened, then I don&#039;t know how we can reset the device.&#160; I think one of my old GeForce cards is also impervious to bus resets.</p> <p class="postedit"><em>Last edited by aw (2014-05-25 18:58:50)</em></p> </div> <div class="postsignature postmsg"><hr /><p><a href="http://vfio.blogspot.com" rel="nofollow">http://vfio.blogspot.com</a><br />Looking for a more open forum to discuss vfio related uses?&#160; Try <a href="https://www.redhat.com/mailman/listinfo/vfio-users" rel="nofollow">https://www.redhat.com/mailman/listinfo/vfio-users</a></p></div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1419167">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1419187" class="blockpost rowodd"> <h2><span><span class="conr">#1823</span> <a href="viewtopic.php?pid=1419187#p1419187">2014-05-25 20:15:08</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=82280">thelamer</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2014-05-25</span></dd> <dd><span>Posts: 4</span></dd> <dd class="usercontacts"><span class="email"><a href="mailto:ryankuba@gmail.com">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>aw wrote:</cite><blockquote><div><p>Did you set the enable_hd_vgaarb i915 option?</p></div></blockquote></div><p>How do you achieve this ? I have applied the i915 patch to the 3.15r6 branch here: (needed it for my marvell controller)</p><p><a href="https://github.com/awilliam/linux-vfio" rel="nofollow">https://github.com/awilliam/linux-vfio</a> release dma-alias-v4</p><p>And on my system I have: </p><div class="codebox"><pre><code>for i in /sys/module/i915/parameters/*; do echo $i=$(cat $i); done /sys/module/i915/parameters/disable_display=N /sys/module/i915/parameters/disable_power_well=1 /sys/module/i915/parameters/enable_cmd_parser=0 /sys/module/i915/parameters/enable_fbc=-1 /sys/module/i915/parameters/enable_hangcheck=Y /sys/module/i915/parameters/enable_hd_vgaarb=N /sys/module/i915/parameters/enable_ips=1 /sys/module/i915/parameters/enable_ppgtt=1 /sys/module/i915/parameters/enable_psr=0 /sys/module/i915/parameters/enable_rc6=-1 /sys/module/i915/parameters/fastboot=N /sys/module/i915/parameters/invert_brightness=0 /sys/module/i915/parameters/lvds_channel_mode=0 /sys/module/i915/parameters/lvds_downclock=0 /sys/module/i915/parameters/lvds_use_ssc=-1 /sys/module/i915/parameters/modeset=-1 /sys/module/i915/parameters/panel_ignore_lid=1 /sys/module/i915/parameters/powersave=1 /sys/module/i915/parameters/prefault_disable=N /sys/module/i915/parameters/preliminary_hw_support=0 /sys/module/i915/parameters/reset=Y /sys/module/i915/parameters/semaphores=-1 /sys/module/i915/parameters/vbt_sdvo_panel_type=-1</code></pre></div><p>Also I am reading about FLR which I am sure my R9 270x will not support: </p><div class="codebox"><pre><code>ExtTag+ AttnBtn- AttnInd- PwrInd- RBE+ FLReset-</code></pre></div><p>Is this a dead end for me? Want to know If I should swap cards to one of my nvidias before trying anymore troubleshooting. </p><p>Right now when running : </p><div class="codebox"><pre><code>qemu-system-x86_64 -enable-kvm -M q35 -m 1024 -cpu qemu64 -smp 6,sockets=1,cores=6,threads=1 -bios /usr/share/qemu/bios.bin -vga none -device ioh3420,bus=pcie.0,addr=1c.0,multifunction=on,port=1,chassis=1,id=root.1 -device vfio-pci,host=01:00.0,bus=root.1,addr=00.0,multifunction=on,x-vga=on -device vfio-pci,host=01:00.1,bus=root.1,addr=00.1 -vnc :1</code></pre></div><p>I get an output on my monitor but it is just a black screen. </p><p>Thanks in advance!</p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1419187">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1419190" class="blockpost roweven"> <h2><span><span class="conr">#1824</span> <a href="viewtopic.php?pid=1419190#p1419190">2014-05-25 20:21:34</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=75590">aw</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2013-10-04</span></dd> <dd><span>Posts: 921</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=75590">Email</a></span> <span class="website"><a href="http://vfio.blogspot.com/" rel="nofollow">Website</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>thelamer wrote:</cite><blockquote><div><div class="quotebox"><cite>aw wrote:</cite><blockquote><div><p>Did you set the enable_hd_vgaarb i915 option?</p></div></blockquote></div><p>How do you achieve this ? I have applied the i915 patch to the 3.15r6 branch here: (needed it for my marvell controller)</p><p><a href="https://github.com/awilliam/linux-vfio" rel="nofollow">https://github.com/awilliam/linux-vfio</a> release dma-alias-v4</p><p>And on my system I have: </p><div class="codebox"><pre><code>for i in /sys/module/i915/parameters/*; do echo $i=$(cat $i); done ... /sys/module/i915/parameters/enable_hd_vgaarb=N ...</code></pre></div></div></blockquote></div><p>Boot with i915.enable_hd_vgaarb=1 or add &quot;options i915 enable_hd_vgaarb=1&quot; to modprobe.d and rebuild your initramfs</p><div class="quotebox"><blockquote><div><p>Also I am reading about FLR which I am sure my R9 270x will not support: </p><div class="codebox"><pre><code>ExtTag+ AttnBtn- AttnInd- PwrInd- RBE+ FLReset-</code></pre></div><p>Is this a dead end for me? Want to know If I should swap cards to one of my nvidias before trying anymore troubleshooting.</p></div></blockquote></div><p>No graphics cards support FLR.&#160; The question is whether the newer AMD cards respond to bus reset or not.&#160; See previous post to test.</p><div class="quotebox"><blockquote><div><p>Right now when running : </p><div class="codebox"><pre><code>qemu-system-x86_64 -enable-kvm -M q35 -m 1024 -cpu qemu64 -smp 6,sockets=1,cores=6,threads=1 -bios /usr/share/qemu/bios.bin -vga none -device ioh3420,bus=pcie.0,addr=1c.0,multifunction=on,port=1,chassis=1,id=root.1 -device vfio-pci,host=01:00.0,bus=root.1,addr=00.0,multifunction=on,x-vga=on -device vfio-pci,host=01:00.1,bus=root.1,addr=00.1 -vnc :1</code></pre></div><p>I get an output on my monitor but it is just a black screen.</p></div></blockquote></div><p>You won&#039;t get any output until i915 VGA arbiter support is enabled.</p> </div> <div class="postsignature postmsg"><hr /><p><a href="http://vfio.blogspot.com" rel="nofollow">http://vfio.blogspot.com</a><br />Looking for a more open forum to discuss vfio related uses?&#160; Try <a href="https://www.redhat.com/mailman/listinfo/vfio-users" rel="nofollow">https://www.redhat.com/mailman/listinfo/vfio-users</a></p></div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1419190">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1419195" class="blockpost rowodd"> <h2><span><span class="conr">#1825</span> <a href="viewtopic.php?pid=1419195#p1419195">2014-05-25 20:36:54</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=75590">aw</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2013-10-04</span></dd> <dd><span>Posts: 921</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=75590">Email</a></span> <span class="website"><a href="http://vfio.blogspot.com/" rel="nofollow">Website</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>aw wrote:</cite><blockquote><div><div class="codebox"><pre><code>--- a/drivers/gpu/vga/vgaarb.c +++ b/drivers/gpu/vga/vgaarb.c @@ -244,8 +244,12 @@ static struct vga_device *__vga_tryget(struct vga_device *v */ WARN_ON(conflict-&gt;owns &amp; ~conflict-&gt;decodes); match = lwants &amp; conflict-&gt;owns; - if (!match) + if (!match) { + if (change_bridge) + pci_set_vga_state(conflict-&gt;pdev, false, 0, + PCI_VGA_STATE_CHANGE_BRIDGE); continue; + } /1 /bin /boot /cdrom /dev /etc /home /initrd.img /initrd.img.old /lib /lib32 /lib64 /libx32 /lost+found /media /mnt /opt /proc /root /run /sbin /srv /sys /tmp /ubiquity-apt-clone /usr /var /vmlinuz /vmlinuz.old /win81-base.qcow2 /win81-base.qcow2.md5 /win81-writable-amd.qcow2 /win81-writable-nvidia.qcow2 /win81-writable-nvidia.qcow2.backup looks like he doesn&#039;t have a lock, we can steal 1.sh topic_10.html topic_11.html topic_12.html topic_13.html topic_14.html topic_15.html topic_16.html topic_17.html topic_18.html topic_19.html topic_1.html topic_20.html topic_21.html topic_22.html topic_23.html topic_24.html topic_25.html topic_26.html topic_27.html topic_28.html topic_29.html topic_2.html topic_30.html topic_31.html topic_32.html topic_33.html topic_34.html topic_35.html topic_36.html topic_37.html topic_38.html topic_39.html topic_3.html topic_40.html topic_41.html topic_42.html topic_43.html topic_44.html topic_45.html topic_46.html topic_47.html topic_48.html topic_49.html topic_4.html topic_50.html topic_51.html topic_52.html topic_53.html topic_54.html topic_55.html topic_56.html topic_57.html topic_58.html topic_59.html topic_5.html topic_60.html topic_61.html topic_62.html topic_63.html topic_64.html topic_65.html topic_66.html topic_67.html topic_68.html topic_69.html topic_6.html topic_70.html topic_71.html topic_72.html topic_7.html topic_8.html topic_9.html them from him</code></pre></div><p>dropbox link since the forum will break formatting - <a href="https://dl.dropboxusercontent.com/u/19831938/vgaarb-gratuitous-bridge-vga-disable.patch" rel="nofollow">https://dl.dropboxusercontent.com/u/198 … able.patch</a></p></div></blockquote></div><br /><p>Here&#039;s the version proposed upstream <a href="https://lkml.org/lkml/2014/5/25/94" rel="nofollow">https://lkml.org/lkml/2014/5/25/94</a></p> </div> <div class="postsignature postmsg"><hr /><p><a href="http://vfio.blogspot.com" rel="nofollow">http://vfio.blogspot.com</a><br />Looking for a more open forum to discuss vfio related uses?&#160; Try <a href="https://www.redhat.com/mailman/listinfo/vfio-users" rel="nofollow">https://www.redhat.com/mailman/listinfo/vfio-users</a></p></div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1419195">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div class="postlinksb"> <div class="inbox crumbsplus"> <div class="pagepost"> <p class="pagelink conl"><span class="pages-label">Pages: </span><a rel="prev" class="item1" href="viewtopic.php?id=162768&amp;p=72">Previous</a> <a href="viewtopic.php?id=162768">1</a> <span class="spacer">…</span> <a href="viewtopic.php?id=162768&amp;p=71">71</a> <a href="viewtopic.php?id=162768&amp;p=72">72</a> <strong>73</strong> <a href="viewtopic.php?id=162768&amp;p=74">74</a> <a href="viewtopic.php?id=162768&amp;p=75">75</a> <span class="spacer">…</span> <a href="viewtopic.php?id=162768&amp;p=234">234</a> <a rel="next" href="viewtopic.php?id=162768&amp;p=74">Next</a></p> <p class="postlink conr">Topic closed</p> </div> <ul class="crumbs"> <li><a href="index.php">Index</a></li> <li><span>»&#160;</span><a href="viewforum.php?id=48">Topics Going Nowhere</a></li> <li><span>»&#160;</span><strong><a href="viewtopic.php?id=162768">KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</a></strong></li> </ul> <p class="subscribelink clearb"><a href="misc.php?action=subscribe&amp;tid=162768">Subscribe to this topic</a></p> <div class="clearer"></div> </div> </div> </div> <div id="brdfooter" class="block"> <h2><span>Board footer</span></h2> <div class="box"> <div id="brdfooternav" class="inbox"> <div class="conl"> <form id="qjump" method="get" action="viewforum.php"> <div><label><span>Jump to<br /></span> <select name="id" onchange="window.location=('viewforum.php?id='+this.options[this.selectedIndex].value)"> <optgroup label="Technical Issues and Assistance"> <option value="23">Newbie Corner</option> <option value="17">Installation</option> <option value="22">Kernel &amp; Hardware</option> <option value="18">Applications &amp; Desktop Environments</option> <option value="31">Laptop Issues</option> <option value="8">Networking, Server, and Protection</option> <option value="32">Multimedia and Games</option> <option value="50">System Administration</option> <option value="35">Other Architectures</option> </optgroup> <optgroup label="Arch-centric"> <option value="24">Announcements, Package &amp; Security Advisories</option> <option value="1">Arch Discussion</option> <option value="13">Forum &amp; Wiki discussion</option> </optgroup> <optgroup label="Pacman Upgrades, Packaging &amp; AUR"> <option value="44">Pacman &amp; Package Upgrade Issues</option> <option value="49">[testing] Repo Forum</option> <option value="4">Creating &amp; Modifying Packages</option> <option value="38">AUR Issues, Discussion &amp; PKGBUILD Requests</option> </optgroup> <optgroup label="Contributions &amp; Discussion"> <option value="20">GNU/Linux Discussion</option> <option value="27">Community Contributions</option> <option value="33">Programming &amp; Scripting</option> <option value="30">Other Languages</option> <option value="47">Artwork and Screenshots</option> <option value="42">Try This</option> </optgroup> <optgroup label="/dev/null"> <option value="29">Off-Topic</option> <option value="48" selected="selected">Topics Going Nowhere</option> <option value="36">Dustbin</option> </optgroup> </select></label> <input type="submit" value=" Go " accesskey="g" /> </div> </form> </div> <div class="conr"> <p id="feedlinks"><span class="atom"><a href="extern.php?action=feed&amp;tid=162768&amp;type=atom">Atom topic feed</a></span></p> <p id="poweredby">Powered by <a href="http://fluxbb.org/">FluxBB</a></p> </div> <div class="clearer"></div> </div> </div> </div> </div> <div class="end-box"></div> </div> </body> </html>
