<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"> <html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en" dir="ltr"> <head> <meta http-equiv="Content-Type" content="text/html; charset=utf-8" /> <title>KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9 (Page 92) / Topics Going Nowhere / Arch Linux Forums</title> <link rel="stylesheet" type="text/css" href="style/ArchLinux.css" /> <link rel="canonical" href="viewtopic.php?id=162768&amp;p=92" title="Page 92" /> <link rel="prev" href="viewtopic.php?id=162768&amp;p=91" title="Page 91" /> <link rel="next" href="viewtopic.php?id=162768&amp;p=93" title="Page 93" /> <link rel="alternate" type="application/atom+xml" href="extern.php?action=feed&amp;tid=162768&amp;type=atom" title="Atom topic feed" /> <link rel="stylesheet" media="screen" href="style/ArchLinux/arch.css?v=3" /> <link rel="stylesheet" media="screen" href="style/ArchLinux/archnavbar.css?v=2" /> <link rel="shortcut icon" href="style/ArchLinux/favicon.ico" /> </head> <body> <div id="archnavbar" class="anb-forum"> <div id="archnavbarlogo"><h1><a href="http://www.archlinux.org/">Arch Linux</a></h1></div> <div id="archnavbarmenu"> <ul id="archnavbarlist"> <li id="anb-home"><a href="http://www.archlinux.org/">Home</a></li><li id="anb-packages"><a href="http://www.archlinux.org/packages/">Packages</a></li><li id="anb-forums" class="anb-selected"><a href="https://bbs.archlinux.org/">Forums</a></li><li id="anb-wiki"><a href="https://wiki.archlinux.org/">Wiki</a></li><li id="anb-bugs"><a href="https://bugs.archlinux.org/">Bugs</a></li><li id="anb-aur"><a href="https://aur.archlinux.org/">AUR</a></li><li id="anb-download"><a href="http://www.archlinux.org/download/">Download</a></li> </ul> </div> </div> <div id="punviewtopic" class="pun"> <div class="top-box"></div> <div class="punwrap"> <div id="brdheader" class="block"> <div class="box"> <div id="brdmenu" class="inbox"> <ul> <li id="navindex" class="isactive"><a href="index.php">Index</a></li> <li id="navuserlist"><a href="userlist.php">User list</a></li> <li id="navsearch"><a href="search.php">Search</a></li> <li id="navprofile"><a href="profile.php?id=80749">Profile</a></li> <li id="navlogout"><a href="login.php?action=out&amp;id=80749&amp;csrf_token=5c20501ec397bb45ef8ee8c84db232c8d8e421c6">Logout</a></li> </ul> </div> <div id="brdwelcome" class="inbox"> <ul class="conl"> <li><span>Logged in as <strong>SXX</strong></span></li> <li><span>Last visit: 2015-08-16 12:20:09</span></li> </ul> <ul class="conr"> <li><span>Topics: <a href="search.php?action=show_replies" title="Find topics you have posted to.">Posted</a> | <a href="search.php?action=show_new" title="Find topics with new posts since your last visit.">New</a> | <a href="search.php?action=show_recent" title="Find topics with recent posts.">Active</a> | <a href="search.php?action=show_unanswered" title="Find topics with no replies.">Unanswered</a></span></li> </ul> <div class="clearer"></div> </div> </div> </div> <div id="brdmain"> <div class="linkst"> <div class="inbox crumbsplus"> <ul class="crumbs"> <li><a href="index.php">Index</a></li> <li><span>»&#160;</span><a href="viewforum.php?id=48">Topics Going Nowhere</a></li> <li><span>»&#160;</span><strong><a href="viewtopic.php?id=162768">KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</a></strong></li> </ul> <div class="pagepost"> <p class="pagelink conl"><span class="pages-label">Pages: </span><a rel="prev" class="item1" href="viewtopic.php?id=162768&amp;p=91">Previous</a> <a href="viewtopic.php?id=162768">1</a> <span class="spacer">…</span> <a href="viewtopic.php?id=162768&amp;p=90">90</a> <a href="viewtopic.php?id=162768&amp;p=91">91</a> <strong>92</strong> <a href="viewtopic.php?id=162768&amp;p=93">93</a> <a href="viewtopic.php?id=162768&amp;p=94">94</a> <span class="spacer">…</span> <a href="viewtopic.php?id=162768&amp;p=234">234</a> <a rel="next" href="viewtopic.php?id=162768&amp;p=93">Next</a></p> <p class="postlink conr">Topic closed</p> </div> <div class="clearer"></div> </div> </div> <div id="p1432842" class="blockpost rowodd blockpost1"> <h2><span><span class="conr">#2276</span> <a href="viewtopic.php?pid=1432842#p1432842">2014-07-04 22:02:33</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=80333">ahl</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2014-03-16</span></dd> <dd><span>Posts: 20</span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>rafalcieslak wrote:</cite><blockquote><div><p>nvidia xorg module complained that &quot;The NVIDIA device on PCI:1:0:0 is not supported by this driver&quot;</p></div></blockquote></div><p>I have no experience with NVIDIA cards but if I understand correctly, it is working exactly as intended by NVIDIA. They desperately want you to buy a NVIDIA Quadro card. You might want the read the last few pages of this thread. Keywords: &quot;qemu-git&quot; and &quot;kvm=off&quot;.</p><p>...</p><p>On the other hand, I&#039;m searching for a new AMD card capable of working perfectly. Any problem that might require rebooting the host is not acceptable.</p><p>Any chance that either of these two would meet above criteria?<br />Asus Radeon <strong>R7 260</strong> 1GiB (90YV05I0-M0NA00) (<strong>UPDATE</strong>: NOT GOOD. See below.)<br />MSI Radeon <strong>R9 270</strong> 2GiB (R9-270-GAMING-2G)<br />(Note: Not the &quot;X&quot; versions)</p><p>I recently bought a Sapphire <strong>HD 5450</strong> 512MiB (11166-01-20R), but very surprisingly, it turned out to be trash! It indeed works, but If qemu is terminated without properly shutdowning the guest, the card stops working until next reboot.</p><p>So now I&#039;m afraid of buying anything...</p><p>For the record, my old Sapphire <strong>HD 6670</strong> 1GiB (11192-06-20G) works absolutely perfectly. I&#039;m still at 0 host AND 0 guest* crashes after months of use and any game I throw at it Just Works(TM).</p><p>(* Actually 2 guest crashes, but it was unrelated.)</p> <p class="postedit"><em>Last edited by ahl (2014-07-09 21:29:55)</em></p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1432842">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1433083" class="blockpost roweven"> <h2><span><span class="conr">#2277</span> <a href="viewtopic.php?pid=1433083#p1433083">2014-07-05 22:57:30</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=80387">dwe11er</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2014-03-18</span></dd> <dd><span>Posts: 73</span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>ahl wrote:</cite><blockquote><div><p>I recently bought a Sapphire <strong>HD 5450</strong> 512MiB (11166-01-20R), but very surprisingly, it turned out to be trash! It indeed works, but If qemu is terminated without properly shutdowning the guest, the card stops working until next reboot.</p></div></blockquote></div><p>I had similar problem with NVIDIA GTS450. Now I&#039;ve got HD7870 (Pitcarin; same core as R9 270) and it&#039;s working flawlessly; unclean shutdowns aren&#039;t problems.</p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1433083">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1433252" class="blockpost rowodd"> <h2><span><span class="conr">#2278</span> <a href="viewtopic.php?pid=1433252#p1433252">2014-07-06 15:08:00</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=83336">heavymetal</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2014-07-06</span></dd> <dd><span>Posts: 1</span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <p>Hi, I&#039;ve been trying this with my ASUS P8Z77-V LK and Intel Core i5-3550. Both allegedly support VT-d. I have both the IGP bundled with the processor and a Gigabyte NVIDIA GeForce GT 630.</p><p>I&#039;ve installed the kernel proposed in #1 and set the following options in grub.cfg:</p><div class="codebox"><pre><code>intel_iommu=on pci-stub.ids=10de:0f00,10de:0bea i915.enable_hd_vgaarb=1 pcie_acs_override=downstream vfio_iommu_type1.allow_unsafe_interrupts=1</code></pre></div><p>I&#039;ve noticed lots of DMA-related problems when booting this kernel with IOMMU on. The first is this kerneloops shown in dmesg, which was already reported here:</p><div class="codebox"><pre class="vscroll"><code>[ 0.375724] IOMMU: Setting RMRR: [ 0.375732] IOMMU: Setting identity map for device 0000:00:02.0 [0xbf000000 - 0xcf1fffff] [ 0.376833] IOMMU: Setting identity map for device 0000:00:14.0 [0xbd08e000 - 0xbd09ffff] [ 0.376849] IOMMU: Setting identity map for device 0000:00:1a.0 [0xbd08e000 - 0xbd09ffff] [ 0.376861] IOMMU: Setting identity map for device 0000:00:1d.0 [0xbd08e000 - 0xbd09ffff] [ 0.376870] IOMMU: Prepare 0-16MiB unity mapping for LPC [ 0.376875] IOMMU: Setting identity map for device 0000:00:1f.0 [0x0 - 0xffffff] [ 0.377267] PCI-DMA: Intel(R) Virtualization Technology for Directed I/O [ 0.377340] ------------[ cut here ]------------ [ 0.377344] WARNING: CPU: 0 PID: 1 at drivers/pci/search.c:46 pci_find_upstream_pcie_bridge+0x65/0x90() [ 0.377345] Modules linked in: [ 0.377348] CPU: 0 PID: 1 Comm: swapper/0 Not tainted 3.15.1-1-mainline #1 [ 0.377349] Hardware name: System manufacturer System Product Name/P8Z77-V LK, BIOS 0908 11/16/2012 [ 0.377350] 0000000000000000 0000000081968345 ffff880224453d10 ffffffff81507d91 [ 0.377351] 0000000000000000 ffff880224453d48 ffffffff81069acd ffff880224217098 [ 0.377353] ffff880224217000 ffff880224217098 0000000000000000 0000000000000000 [ 0.377354] Call Trace: [ 0.377358] [&lt;ffffffff81507d91&gt;] dump_stack+0x4d/0x6f [ 0.377361] [&lt;ffffffff81069acd&gt;] warn_slowpath_common+0x7d/0xa0 [ 0.377362] [&lt;ffffffff81069bfa&gt;] warn_slowpath_null+0x1a/0x20 [ 0.377364] [&lt;ffffffff812cfde5&gt;] pci_find_upstream_pcie_bridge+0x65/0x90 [ 0.377367] [&lt;ffffffff813ea07d&gt;] intel_iommu_add_device+0x4d/0x240 [ 0.377369] [&lt;ffffffff813df370&gt;] ? bus_set_iommu+0x50/0x50 [ 0.377370] [&lt;ffffffff813df39a&gt;] add_iommu_group+0x2a/0x60 [ 0.377373] [&lt;ffffffff8138f633&gt;] bus_for_each_dev+0x73/0xc0 [ 0.377374] [&lt;ffffffff813df368&gt;] bus_set_iommu+0x48/0x50 [ 0.377377] [&lt;ffffffff8193d94b&gt;] intel_iommu_init+0x1bf/0x5d2 [ 0.377379] [&lt;ffffffff81900297&gt;] ? memblock_find_dma_reserve+0x143/0x143 [ 0.377380] [&lt;ffffffff819002a9&gt;] pci_iommu_init+0x12/0x3c [ 0.377383] [&lt;ffffffff81002162&gt;] do_one_initcall+0xf2/0x1b0 [ 0.377385] [&lt;ffffffff8108b47d&gt;] ? parse_args+0x21d/0x490 [ 0.377387] [&lt;ffffffff818f6067&gt;] kernel_init_freeable+0x1a0/0x23c [ 0.377390] [&lt;ffffffff814fccd0&gt;] ? rest_init+0x90/0x90 [ 0.377391] [&lt;ffffffff814fccde&gt;] kernel_init+0xe/0xf0 [ 0.377394] [&lt;ffffffff815159fc&gt;] ret_from_fork+0x7c/0xb0 [ 0.377396] [&lt;ffffffff814fccd0&gt;] ? rest_init+0x90/0x90 [ 0.377399] ---[ end trace 9e3a2ac08a3dd373 ]--- [ 0.378939] RAPL PMU detected, hw unit 2^-16 Joules, API unit is 2^-32 Joules, 3 fixed counters 163840 ms ovfl timer</code></pre></div><p>Once my system has booted, I have no wifi. My wireless card is a PCI one, sat on 05:01.0 according to lspci. I get these in dmesg every time:</p><div class="codebox"><pre><code>[ 1855.821855] dmar: DMAR:[DMA Write] Request device [05:00.0] fault addr 0 DMAR:[fault reason 02] Present bit in context entry is clear [ 1855.822005] dmar: DRHD: handling fault status reg 3 [ 1855.822012] dmar: DMAR:[DMA Write] Request device [05:00.0] fault addr 0 DMAR:[fault reason 02] Present bit in context entry is clear [ 1855.854514] dmar: DRHD: handling fault status reg 3 [ 1855.854521] dmar: DMAR:[DMA Read] Request device [05:00.0] fault addr ffffa000 DMAR:[fault reason 02] Present bit in context entry is clear [ 1855.886652] ath: phy0: Failed to stop TX DMA, queues=0x001! [ 1855.897505] dmar: DRHD: handling fault status reg 3 [ 1855.897511] dmar: DMAR:[DMA Read] Request device [05:00.0] fault addr fffd0000 DMAR:[fault reason 02] Present bit in context entry is clear</code></pre></div><p>The wireless card is the only PCI (not PCI-E) card in my system.</p><p>Not being able to reach the Internet through my PCI card, I use a USB one. It works for few minutes, but after a while it stops working, again with DMA problems reported by dmesg.</p><div class="codebox"><pre><code>[ 529.166591] ieee80211 phy1: rt2x00queue_flush_queue: Warning - Queue 2 failed to flush [ 529.306393] ieee80211 phy1: rt2x00queue_flush_queue: Warning - Queue 2 failed to flush [ 529.725885] ieee80211 phy1: rt2x00queue_flush_queue: Warning - Queue 2 failed to flush [ 529.865689] ieee80211 phy1: rt2x00queue_flush_queue: Warning - Queue 2 failed to flush [ 529.879235] ieee80211 phy1: rt2x00usb_watchdog_tx_dma: Warning - TX queue 2 DMA timed out, invoke forced forced reset [ 579.875625] ieee80211 phy1: rt2x00usb_vendor_request: Error - Vendor Request 0x07 failed for offset 0x3040 with error -110</code></pre></div><p>Disconnecting the wireless PCI card does not help.</p><p>I don&#039;t know if all these DMA problems are hardware or software fault.</p><p>Even with all of these, I&#039;m able to boot seabios through the nVidia card with QEMU. I use the following commands:</p><div class="codebox"><pre><code>sudo vfio-bind 0000:01:00.0 0000:01:00.1 sudo chgrp $USER /dev/vfio/13 sudo chmod g+rw /dev/vfio/13 qemu-system-x86_64 -enable-kvm -M q35 -m 1024 -cpu host -smp 4,sockets=1,cores=4,threads=1 -vga none -device ioh3420,bus=pcie.0,addr=1c.0,multifunction=on,port=1,chassis=1,id=root.1 -device vfio-pci,host=01:00.0,bus=root.1,addr=00.0,multifunction=on,x-vga=on -device vfio-pci,host=01:00.1,bus=root.1,addr=00.1</code></pre></div><p>And it works...! The first time. If I press ^C, the Seabios screen persists on my monitor, and running the above command again fails with &quot;Invalid ROM&quot;. If I want to run QEMU again I have to reboot the host system.</p><p>Adding rombar=0 only yields a blank screen and an emulation error after a while.</p><p>I tried searching for my VGA BIOS file at <a href="http://www.techpowerup.com/vgabios/" rel="nofollow">http://www.techpowerup.com/vgabios/</a>, finding 4 possible ROMs for my video card. Three of them made the screen spark characters here and there. None of them made the card work for a second time without rebooting, and usually made my computer hang indefinitely on the second run, needing to hard reset it.</p><p>What could be the cause of these problems, specially the DMA ones? Maybe a bug in the BIOS like commented in <a href="https://bbs.archlinux.org/viewtopic.php?pid=1270712#p1270712" rel="nofollow">#4</a>?</p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1433252">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1433353" class="blockpost roweven"> <h2><span><span class="conr">#2279</span> <a href="viewtopic.php?pid=1433353#p1433353">2014-07-06 20:57:28</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=80333">ahl</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2014-03-16</span></dd> <dd><span>Posts: 20</span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>dwe11er wrote:</cite><blockquote><div><p>I had similar problem with NVIDIA GTS450. Now I&#039;ve got HD7870 (Pitcarin; same core as R9 270) and it&#039;s working flawlessly; unclean shutdowns aren&#039;t problems.</p></div></blockquote></div><p>Thanks for the info. I hope you are right because the above mentioned R7 260 turned out to be yet another paperweight.</p><p>A quick search for PAGE_FAULT_IN_NONPAGED_AREA in this thread revealed that people have already reported this new problem of mine numerous times.</p><p><strong>Are all of the new Sea Islands cards bad?</strong> (BONAIRE, KABINI, KAVERI, HAWAII, HD7790, R7 260(X), R9 290(X))</p><p>This is my new problem:</p><div class="codebox"><pre class="vscroll"><code>CPU: AMD Guest GPU: Radeon R7 260 Qemu: git or 2.0.0 Linux: 3.15.4, 3.15.3 or 3.14.10 (all with vga_arbitrer.patch) Steps to reproduce problem, works 100%: 1. Enter high resolution graphic mode in Win 7 (it works initially) 2. Shutdown guest and start qemu again (OR just soft-reboot the guest) 3. Upon entering high resolution mode again, these errors appear: Guest: PAGE_FAULT_IN_NONPAGED_AREA STOP: 0x50 Host: Mostly unresponsive, but still working. Qemu won&#039;t die even with kill -9. Unlimited number of these flooding very fast: AMD-Vi: Completion-Wait loop timed out ------------[ cut here ]------------ WARNING: CPU: 6 PID: 3841 at drivers/iommu/amd_iommu.c:1248 __domain_flush_pages+0x1b2/0x1c0() Modules linked in: radeon cfbfillrect cfbimgblt cfbcopyarea i2c_algo_bit fbcon bitblit softcursor font backlight drm_kms_helper ttm drm fb fbdev pci_stub bridge stp llc loop jc42 it87 hwmon_vid xt_physdev ebt_log ebtable_filter ebtables snd_usb_audio snd_usbmidi_lib snd_hwdep snd_pcm snd_rawmidi snd_seq_device snd_timer snd uas kvm_amd joydev soundcore evdev kvm wmi k10temp i2c_piix4 fam15h_power crct10dif_pclmul xhci_hcd CPU: 6 PID: 3841 Comm: qemu-system-x86 Not tainted 3.15.3-arbiter #2 Hardware name: To be filled by O.E.M. To be filled by O.E.M./SABERTOOTH 990FX R2.0, BIOS 2501 04/08/2014 0000000000000009 ffff8802f664bba8 ffffffff815b03fb 0000000000000007 0000000000000000 ffff8802f664bbe8 ffffffff810c0322 000000000000136b ffff880310605810 00000000fffffffb 8000000000000ffe 0000000000000000 Call Trace: [&lt;ffffffff815b03fb&gt;] dump_stack+0x46/0x58 [&lt;ffffffff810c0322&gt;] warn_slowpath_common+0x82/0xb0 [&lt;ffffffff810c0365&gt;] warn_slowpath_null+0x15/0x20 [&lt;ffffffff81491e92&gt;] __domain_flush_pages+0x1b2/0x1c0 [&lt;ffffffff81491eba&gt;] domain_flush_tlb_pde+0x1a/0x20 [&lt;ffffffff81492036&gt;] amd_iommu_unmap+0x176/0x190 [&lt;ffffffff81491ec0&gt;] ? domain_flush_tlb_pde+0x20/0x20 [&lt;ffffffff8148f650&gt;] iommu_unmap+0x90/0xe0 [&lt;ffffffff813efdbb&gt;] vfio_remove_dma+0xbb/0x1a0 [&lt;ffffffff813f0526&gt;] vfio_iommu_type1_ioctl+0x3f6/0xa70 [&lt;ffffffffa0064bcc&gt;] ? kvm_set_memory_region+0x3c/0x50 [kvm] [&lt;ffffffffa0064ef2&gt;] ? kvm_vm_ioctl+0x312/0x770 [kvm] [&lt;ffffffff813ee1af&gt;] vfio_fops_unl_ioctl+0x7f/0x2b0 [&lt;ffffffff810cee24&gt;] ? do_sigtimedwait+0xb4/0x1e0 [&lt;ffffffff81192a8e&gt;] do_vfs_ioctl+0x7e/0x500 [&lt;ffffffff8111a463&gt;] ? SyS_futex+0x93/0x1a0 [&lt;ffffffff81192f57&gt;] SyS_ioctl+0x47/0x90 [&lt;ffffffff815b6b62&gt;] system_call_fastpath+0x16/0x1b ---[ end trace 4f4b82e9c04d544c ]--- Also these: AMD-Vi: Event logged [IOTLB_INV_TIMEOUT device=04:00.0 address=0x00000004485334f0] It seems there is no problem when running Win 7 in low resolution mode without amd drivers installed.</code></pre></div> <p class="postedit"><em>Last edited by ahl (2014-07-09 21:32:22)</em></p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1433353">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1433599" class="blockpost rowodd"> <h2><span><span class="conr">#2280</span> <a href="viewtopic.php?pid=1433599#p1433599">2014-07-07 17:19:05</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=78180">pascal257</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2014-01-02</span></dd> <dd><span>Posts: 3</span></dd> <dd class="usercontacts"><span class="email"><a href="mailto:p@pkne.de">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <p>VGA-Passthrough running perfectly here. Having ArchLinux host with several headless guests, a windows 7 guest and a linux mint guest. Ejecting the graphics gard on windows 7 works flawlessly and I can reboot the guest without having issues. But sometimes nouveau on the linux guest crashes and while I can still access the system via ssh, I&#039;m unable to eject the gfx, so I have to reboot the whole system.</p><p>Is there any way to eject the graphics card in linux like with the windows guest?</p><p>btw this is the crash on the linux guest, maybe somehow knows how to fix this:</p><div class="codebox"><pre><code>[15398.752221] nouveau E[ PFIFO][0000:01:00.0] read fault at 0x0000039000 [PAGE_NOT_PRESENT] from PCOPY0/PCOPY0 on channel 0x001fdb2000 [DRM] [15475.985061] nouveau E[ DRM] GPU lockup - switching to software fbcon [15491.028017] nouveau E[Xorg[1418]] failed to idle channel 0xcccc0001 [Xorg[1418]] [15506.028007] nouveau E[Xorg[1418]] failed to idle channel 0xcccc0001 [Xorg[1418]] [15508.028221] nouveau E[ PFIFO][0000:01:00.0] playlist update failed [15523.028018] nouveau E[Xorg[1418]] failed to idle channel 0xcccc0000 [Xorg[1418]] [15538.028019] nouveau E[Xorg[1418]] failed to idle channel 0xcccc0000 [Xorg[1418]] [15540.028130] nouveau E[ PFIFO][0000:01:00.0] channel 2 [Xorg[1418]] kick timeout [15540.028448] nouveau W[ PFIFO][0000:01:00.0] INTR 0x00000100: 0x0000000d [15542.028332] nouveau E[ PFIFO][0000:01:00.0] playlist update failed [15557.104010] nouveau E[chrome[3057]] failed to idle channel 0xcccc0000 [chrome[3057]] [15572.104007] nouveau E[chrome[3057]] failed to idle channel 0xcccc0000 [chrome[3057]] [15574.104188] nouveau E[ PFIFO][0000:01:00.0] channel 5 [chrome[3057]] kick timeout [15574.104445] nouveau W[ PFIFO][0000:01:00.0] INTR 0x00000100: 0x0000000d [15576.104311] nouveau E[ PFIFO][0000:01:00.0] playlist update failed [15591.104009] nouveau E[cinnamon[2055]] failed to idle channel 0xcccc0000 [cinnamon[2055]] [15606.104010] nouveau E[cinnamon[2055]] failed to idle channel 0xcccc0000 [cinnamon[2055]] [15608.104091] nouveau E[ PFIFO][0000:01:00.0] channel 4 [cinnamon[2055]] kick timeout [15608.104343] nouveau W[ PFIFO][0000:01:00.0] INTR 0x00000100: 0x0000000d [15610.104224] nouveau E[ PFIFO][0000:01:00.0] playlist update failed [15610.295781] nouveau W[ PFIFO][0000:01:00.0] INTR 0x00000100: 0x0000000d [15612.295660] nouveau E[ PFIFO][0000:01:00.0] playlist update failed [15612.310667] nouveau W[ PFIFO][0000:01:00.0] INTR 0x00000100: 0x0000000d [15614.310542] nouveau E[ PFIFO][0000:01:00.0] playlist update failed</code></pre></div> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1433599">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1433656" class="blockpost roweven"> <h2><span><span class="conr">#2281</span> <a href="viewtopic.php?pid=1433656#p1433656">2014-07-07 19:13:19</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=83383">switchphase</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2014-07-07</span></dd> <dd><span>Posts: 7</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=83383">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <p>Hello Guys,<br /> I couldl need some help. My setup worked fine but i had to rip it appart because i needed my HD 6970 for a Triple-Head Setup.<br />At the time i had the HD6970 and a Nvidia GT 630.<br />Blacklisted the radeon module and pass it through to the VM. All worked fine.</p><p>Now i had a HD6970 and a R9 270x</p><p>When i try to start the VM i get </p><div class="codebox"><pre><code>virsh # start GamingVM error: Failed to start domain GamingVM error: internal error: early end of file from monitor: possible problem: 2014-07-07T18:55:28.773551Z qemu-kvm: -device vfio-pci,host=06:00.0,bus=root.1,addr=00.1,multifunction=on,x-vga=on: vfio: No available IOMMU models 2014-07-07T18:55:28.773590Z qemu-kvm: -device vfio-pci,host=06:00.0,bus=root.1,addr=00.1,multifunction=on,x-vga=on: vfio: failed to setup container for group 23 2014-07-07T18:55:28.773607Z qemu-kvm: -device vfio-pci,host=06:00.0,bus=root.1,addr=00.1,multifunction=on,x-vga=on: vfio: failed to get group 23 2014-07-07T18:55:28.773627Z qemu-kvm: -device vfio-pci,host=06:00.0,bus=root.1,addr=00.1,multifunction=on,x-vga=on: Device initialization failed. 2014-07-07T18:55:28.773647Z qemu-kvm: -device vfio-pci,host=06:00.0,bus=root.1,addr=00.1,multifunction=on,x-vga=on: Device &#039;vfio-pci&#039; could not be initialized</code></pre></div><p>IOMMU is enabled in UEFI, Device is bound to pci-stub. </p><div class="codebox"><pre><code>#dmesg | grep pci-stub [ 0.000000] Command line: BOOT_IMAGE=/vmlinuz-linux root=UUID=10714a4e-bd0b-4f6a-8aa4-e349e7cd4c13 rw pci-stub.ids=1002:6810,1002:aab0 iommu=pt iommu=1 vfio_iommu_type quiet [ 0.000000] Kernel command line: BOOT_IMAGE=/vmlinuz-linux root=UUID=10714a4e-bd0b-4f6a-8aa4-e349e7cd4c13 rw pci-stub.ids=1002:6810,1002:aab0 iommu=pt iommu=1 vfio_iommu_type quiet [ 0.971279] pci-stub: add 1002:6810 sub=FFFFFFFF:FFFFFFFF cls=00000000/00000000 [ 0.971291] pci-stub 0000:06:00.0: claimed by stub [ 0.971296] pci-stub: add 1002:AAB0 sub=FFFFFFFF:FFFFFFFF cls=00000000/00000000 [ 0.971303] pci-stub 0000:06:00.1: claimed by stub #dmesg | grep AMD-Vi [ 0.843061] AMD-Vi: Found IOMMU at 0000:00:00.2 cap 0x40 [ 0.843062] AMD-Vi: Interrupt remapping enabled [ 0.843201] AMD-Vi: Initialized for Passthrough Mode</code></pre></div><p>Also qemu is set to run as root and allowed to access to /dev/vfio/{vfio,23} . So what could be the Problem here?</p><div class="codebox"><pre><code># grep &quot;^[^#]&quot; /etc/libvirt/qemu.conf user = &quot;root&quot; group=&quot;root&quot; cgroup_device_acl = [ &quot;/dev/null&quot;, &quot;/dev/full&quot;, &quot;/dev/zero&quot;, &quot;/dev/random&quot;, &quot;/dev/urandom&quot;, &quot;/dev/ptmx&quot;, &quot;/dev/kvm&quot;, &quot;/dev/kqemu&quot;, &quot;/dev/rtc&quot;,&quot;/dev/hpet&quot;, &quot;/dev/vfio/vfio&quot;, &quot;/dev/vfio/23&quot; ] clear_emulator_capabilities = 0</code></pre></div><p>Could this be a Problem? As driver is listed the pci-stub but also the radeon module</p><div class="codebox"><pre class="vscroll"><code>06:00.0 VGA compatible controller: Advanced Micro Devices, Inc. [AMD/ATI] Curacao XT [Radeon R9 270X] (prog-if 00 [VGA controller]) Subsystem: ASUSTeK Computer Inc. Device 04a3 Control: I/O- Mem- BusMaster- SpecCycle- MemWINV- VGASnoop- ParErr- Stepping- SERR- FastB2B- DisINTx- Status: Cap+ 66MHz- UDF- FastB2B- ParErr- DEVSEL=fast &gt;TAbort- &lt;TAbort- &lt;MAbort- &gt;SERR- &lt;PERR- INTx- Interrupt: pin A routed to IRQ 10 Region 0: Memory at c0000000 (64-bit, prefetchable) [disabled] [size=256M] Region 2: Memory at fe500000 (64-bit, non-prefetchable) [disabled] [size=256K] Region 4: I/O ports at b000 [disabled] [size=256] Expansion ROM at fe540000 [disabled] [size=128K] Capabilities: [48] Vendor Specific Information: Len=08 &lt;?&gt; Capabilities: [50] Power Management version 3 Flags: PMEClk- DSI- D1+ D2+ AuxCurrent=0mA PME(D0-,D1+,D2+,D3hot+,D3cold-) Status: D0 NoSoftRst- PME-Enable- DSel=0 DScale=0 PME- Capabilities: [58] Express (v2) Legacy Endpoint, MSI 00 DevCap: MaxPayload 256 bytes, PhantFunc 0, Latency L0s &lt;4us, L1 unlimited ExtTag+ AttnBtn- AttnInd- PwrInd- RBE+ FLReset- DevCtl: Report errors: Correctable- Non-Fatal- Fatal- Unsupported- RlxdOrd- ExtTag- PhantFunc- AuxPwr- NoSnoop+ MaxPayload 128 bytes, MaxReadReq 512 bytes DevSta: CorrErr+ UncorrErr- FatalErr- UnsuppReq+ AuxPwr- TransPend- LnkCap: Port #0, Speed 8GT/s, Width x16, ASPM L0s L1, Exit Latency L0s &lt;64ns, L1 &lt;1us ClockPM- Surprise- LLActRep- BwNot- LnkCtl: ASPM Disabled; RCB 64 bytes Disabled- CommClk+ ExtSynch- ClockPM- AutWidDis- BWInt- AutBWInt- LnkSta: Speed 5GT/s, Width x4, TrErr- Train- SlotClk+ DLActive- BWMgmt- ABWMgmt- DevCap2: Completion Timeout: Not Supported, TimeoutDis-, LTR-, OBFF Not Supported DevCtl2: Completion Timeout: 50us to 50ms, TimeoutDis-, LTR-, OBFF Disabled LnkCtl2: Target Link Speed: 8GT/s, EnterCompliance- SpeedDis- Transmit Margin: Normal Operating Range, EnterModifiedCompliance- ComplianceSOS- Compliance De-emphasis: -6dB LnkSta2: Current De-emphasis Level: -3.5dB, EqualizationComplete-, EqualizationPhase1- EqualizationPhase2-, EqualizationPhase3-, LinkEqualizationRequest- Capabilities: [a0] MSI: Enable- Count=1/1 Maskable- 64bit+ Address: 0000000000000000 Data: 0000 Capabilities: [100 v1] Vendor Specific Information: ID=0001 Rev=1 Len=010 &lt;?&gt; Capabilities: [150 v2] Advanced Error Reporting UESta: DLP- SDES- TLP- FCP- CmpltTO- CmpltAbrt- UnxCmplt- RxOF- MalfTLP- ECRC- UnsupReq- ACSViol- UEMsk: DLP- SDES- TLP- FCP- CmpltTO- CmpltAbrt- UnxCmplt- RxOF- MalfTLP- ECRC- UnsupReq- ACSViol- UESvrt: DLP+ SDES+ TLP- FCP+ CmpltTO- CmpltAbrt- UnxCmplt- RxOF+ MalfTLP+ ECRC- UnsupReq- ACSViol- CESta: RxErr- BadTLP- BadDLLP- Rollover- Timeout- NonFatalErr+ CEMsk: RxErr- BadTLP- BadDLLP- Rollover- Timeout- NonFatalErr+ AERCap: First Error Pointer: 00, GenCap+ CGenEn- ChkCap+ ChkEn- Capabilities: [200 v1] #15 Capabilities: [270 v1] #19 Capabilities: [2b0 v1] Address Translation Service (ATS) ATSCap: Invalidate Queue Depth: 00 ATSCtl: Enable+, Smallest Translation Unit: 00 Capabilities: [2c0 v1] #13 Capabilities: [2d0 v1] #1b Kernel driver in use: vfio-pci Kernel modules: radeon 06:00.1 Audio device: Advanced Micro Devices, Inc. [AMD/ATI] Cape Verde/Pitcairn HDMI Audio [Radeon HD 7700/7800 Series] Subsystem: ASUSTeK Computer Inc. Device aab0 Control: I/O- Mem- BusMaster- SpecCycle- MemWINV- VGASnoop- ParErr- Stepping- SERR- FastB2B- DisINTx- Status: Cap+ 66MHz- UDF- FastB2B- ParErr- DEVSEL=fast &gt;TAbort- &lt;TAbort- &lt;MAbort- &gt;SERR- &lt;PERR- INTx- Interrupt: pin B routed to IRQ 11 Region 0: Memory at fe560000 (64-bit, non-prefetchable) [disabled] [size=16K] Capabilities: [48] Vendor Specific Information: Len=08 &lt;?&gt; Capabilities: [50] Power Management version 3 Flags: PMEClk- DSI- D1+ D2+ AuxCurrent=0mA PME(D0-,D1-,D2-,D3hot-,D3cold-) Status: D0 NoSoftRst- PME-Enable- DSel=0 DScale=0 PME- Capabilities: [58] Express (v2) Legacy Endpoint, MSI 00 DevCap: MaxPayload 256 bytes, PhantFunc 0, Latency L0s &lt;4us, L1 unlimited ExtTag+ AttnBtn- AttnInd- PwrInd- RBE+ FLReset- DevCtl: Report errors: Correctable- Non-Fatal- Fatal- Unsupported- RlxdOrd- ExtTag- PhantFunc- AuxPwr- NoSnoop+ MaxPayload 128 bytes, MaxReadReq 512 bytes DevSta: CorrErr+ UncorrErr- FatalErr- UnsuppReq+ AuxPwr- TransPend- LnkCap: Port #0, Speed 8GT/s, Width x16, ASPM L0s L1, Exit Latency L0s &lt;64ns, L1 &lt;1us ClockPM- Surprise- LLActRep- BwNot- LnkCtl: ASPM Disabled; RCB 64 bytes Disabled- CommClk+ ExtSynch- ClockPM- AutWidDis- BWInt- AutBWInt- LnkSta: Speed 5GT/s, Width x4, TrErr- Train- SlotClk+ DLActive- BWMgmt- ABWMgmt- DevCap2: Completion Timeout: Not Supported, TimeoutDis-, LTR-, OBFF Not Supported DevCtl2: Completion Timeout: 50us to 50ms, TimeoutDis-, LTR-, OBFF Disabled LnkSta2: Current De-emphasis Level: -3.5dB, EqualizationComplete-, EqualizationPhase1- EqualizationPhase2-, EqualizationPhase3-, LinkEqualizationRequest- Capabilities: [a0] MSI: Enable- Count=1/1 Maskable- 64bit+ Address: 0000000000000000 Data: 0000 Capabilities: [100 v1] Vendor Specific Information: ID=0001 Rev=1 Len=010 &lt;?&gt; Capabilities: [150 v2] Advanced Error Reporting UESta: DLP- SDES- TLP- FCP- CmpltTO- CmpltAbrt- UnxCmplt- RxOF- MalfTLP- ECRC- UnsupReq- ACSViol- UEMsk: DLP- SDES- TLP- FCP- CmpltTO- CmpltAbrt- UnxCmplt- RxOF- MalfTLP- ECRC- UnsupReq- ACSViol- UESvrt: DLP+ SDES+ TLP- FCP+ CmpltTO- CmpltAbrt- UnxCmplt- RxOF+ MalfTLP+ ECRC- UnsupReq- ACSViol- CESta: RxErr- BadTLP- BadDLLP- Rollover- Timeout- NonFatalErr+ CEMsk: RxErr- BadTLP- BadDLLP- Rollover- Timeout- NonFatalErr+ AERCap: First Error Pointer: 00, GenCap+ CGenEn- ChkCap+ ChkEn- Kernel driver in use: vfio-pci Kernel modules: snd_hda_intel 06:00.0 0300: 1002:6810 06:00.1 0403: 1002:aab0</code></pre></div> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1433656">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1433664" class="blockpost rowodd"> <h2><span><span class="conr">#2282</span> <a href="viewtopic.php?pid=1433664#p1433664">2014-07-07 19:37:09</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=80333">ahl</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2014-03-16</span></dd> <dd><span>Posts: 20</span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>switchphase wrote:</cite><blockquote><div><p>Could this be a Problem? As driver is listed the pci-stub but also the radeon module</p></div></blockquote></div><p>No, that is normal. It&#039;s the &quot;in use&quot; that matters.</p><p>Perhaps, try this:<br /><a href="https://bbs.archlinux.org/viewtopic.php?pid=1366134#p1366134" rel="nofollow">https://bbs.archlinux.org/viewtopic.php … 4#p1366134</a></p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1433664">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1433666" class="blockpost roweven"> <h2><span><span class="conr">#2283</span> <a href="viewtopic.php?pid=1433666#p1433666">2014-07-07 19:41:26</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=83383">switchphase</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2014-07-07</span></dd> <dd><span>Posts: 7</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=83383">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>ahl wrote:</cite><blockquote><div><p>Perhaps, try this:<br /><a href="https://bbs.archlinux.org/viewtopic.php?pid=1366134#p1366134" rel="nofollow">https://bbs.archlinux.org/viewtopic.php … 4#p1366134</a></p></div></blockquote></div><p>Thanks, thats it!<br />The vfio_iommu_type1 module was missing</p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1433666">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1433783" class="blockpost rowodd"> <h2><span><span class="conr">#2284</span> <a href="viewtopic.php?pid=1433783#p1433783">2014-07-08 03:40:34</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=80333">ahl</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2014-03-16</span></dd> <dd><span>Posts: 20</span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>switchphase wrote:</cite><blockquote><div><p>Now i had a HD6970 and a R9 270x</p></div></blockquote></div><p>Can I ask you, how is your R9 270x working now? Does it work fine even after unclean shutdown of the guest?</p><p>My R7 260 is only usable with the &quot;eject&quot; method. Unclean shutdown is fatal. I now put the card on host, but it doesn&#039;t work that well on host either (with free drivers: glamor, mesa, latest kernel).</p><p>Even worse, when I did this on host:<br />echo high &gt; /sys/class/drm/card0/device/power_profile</p><p>The screen went all funny and locked up the gpu...<br />Perhaps there is something wrong with the power tables?</p><p><strong>UPDATE</strong>: power_method &quot;profile&quot; is broken, but the newer &quot;dpm&quot; method works assuming latest radeon firmware is installed.</p> <p class="postedit"><em>Last edited by ahl (2014-07-09 21:36:34)</em></p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1433783">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1433829" class="blockpost roweven"> <h2><span><span class="conr">#2285</span> <a href="viewtopic.php?pid=1433829#p1433829">2014-07-08 07:53:16</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=83383">switchphase</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2014-07-07</span></dd> <dd><span>Posts: 7</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=83383">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>ahl wrote:</cite><blockquote><div><p>Can I ask you, how is your R9 270x working now?</p></div></blockquote></div><p>I can&#039;t say much about it ATM. <br />With the 440 Chipset it works like a charm, but the performance is bad. (About 20-30FPS)<br />With the q35 Chipset the host crashes in 3-4 sec.</p><p>It maybe a initialization error. I try to dump the BIOS from the card and see if it works.</p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1433829">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1433899" class="blockpost rowodd"> <h2><span><span class="conr">#2286</span> <a href="viewtopic.php?pid=1433899#p1433899">2014-07-08 12:52:23</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=80387">dwe11er</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2014-03-18</span></dd> <dd><span>Posts: 73</span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>switchphase wrote:</cite><blockquote><div><div class="quotebox"><cite>ahl wrote:</cite><blockquote><div><p>Can I ask you, how is your R9 270x working now?</p></div></blockquote></div><p>I can&#039;t say much about it ATM. <br />With the 440 Chipset it works like a charm, but the performance is bad. (About 20-30FPS)<br />With the q35 Chipset the host crashes in 3-4 sec.</p><p>It maybe a initialization error. I try to dump the BIOS from the card and see if it works.</p></div></blockquote></div><p>Maybe its AMD&#039;s IOMMU problem? Both of you have AMD cpu and mobo. I&#039;ve got Intel&#039;s and never encountered such problems.</p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1433899">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1433908" class="blockpost roweven"> <h2><span><span class="conr">#2287</span> <a href="viewtopic.php?pid=1433908#p1433908">2014-07-08 13:54:14</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=83383">switchphase</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2014-07-07</span></dd> <dd><span>Posts: 7</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=83383">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>dwe11er wrote:</cite><blockquote><div><p>Maybe its AMD&#039;s IOMMU problem?</p></div></blockquote></div><p>Dont think so. Isn&#039;t it the same expect the name?<br />Intel calls it VT-d and AMD calls it IOMMU, but the technology should be the same.</p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1433908">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1433911" class="blockpost rowodd"> <h2><span><span class="conr">#2288</span> <a href="viewtopic.php?pid=1433911#p1433911">2014-07-08 13:57:24</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=75590">aw</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2013-10-04</span></dd> <dd><span>Posts: 921</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=75590">Email</a></span> <span class="website"><a href="http://vfio.blogspot.com/" rel="nofollow">Website</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>switchphase wrote:</cite><blockquote><div><div class="quotebox"><cite>dwe11er wrote:</cite><blockquote><div><p>Maybe its AMD&#039;s IOMMU problem?</p></div></blockquote></div><p>Dont think so. Isn&#039;t it the same expect the name?<br />Intel calls it VT-d and AMD calls it IOMMU, but the technology should be the same.</p></div></blockquote></div><p>No, they are completely different IOMMU implementations</p> </div> <div class="postsignature postmsg"><hr /><p><a href="http://vfio.blogspot.com" rel="nofollow">http://vfio.blogspot.com</a><br />Looking for a more open forum to discuss vfio related uses?&#160; Try <a href="https://www.redhat.com/mailman/listinfo/vfio-users" rel="nofollow">https://www.redhat.com/mailman/listinfo/vfio-users</a></p></div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1433911">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1433934" class="blockpost roweven"> <h2><span><span class="conr">#2289</span> <a href="viewtopic.php?pid=1433934#p1433934">2014-07-08 14:57:03</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=82643">abdullah</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2014-06-10</span></dd> <dd><span>Posts: 33</span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <p>Does the VM&#039;s share the CPU cores ? or each VM get it owns core assigned ?</p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1433934">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1434007" class="blockpost rowodd"> <h2><span><span class="conr">#2290</span> <a href="viewtopic.php?pid=1434007#p1434007">2014-07-08 18:38:13</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=83383">switchphase</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2014-07-07</span></dd> <dd><span>Posts: 7</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=83383">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>abdullah wrote:</cite><blockquote><div><p>Does the VM&#039;s share the CPU cores ? or each VM get it owns core assigned ?</p></div></blockquote></div><p>I think they are shared amongst the VM&#039;s as long as no VCPU pinning is configured</p><br /><p>Saved the VBIOS to a file and tried it again. Nothing changed. After a few seconds my screen looks like this<br /><a href="http://imgur.com/G7yT4uZ" rel="nofollow">http://imgur.com/G7yT4uZ</a><br />After a few seconds the host freezes completly. Output on the passed through card is seen.</p><p>I used the modified parameters for tetsting from the first post without disk</p><div class="codebox"><pre><code>qemu-system-x86_64 -enable-kvm -M q35 -m 1024 -cpu host \ -smp 6,sockets=1,cores=6,threads=1 \ -bios /usr/share/qemu/bios.bin -vga none \ -device ioh3420,bus=pcie.0,addr=1c.0,multifunction=on,port=1,chassis=1,id=root.1 \ -device vfio-pci,host=06:00.0,bus=root.1,addr=00.0,multifunction=on,x-vga=on,romfile=/home/tma/VBIOS/r9_270x_vbios.rom \ -device vfio-pci,host=06:00.1,bus=root.1,addr=00.1 \ -nographic</code></pre></div><p>Is this VGA Arbiter related?<br />journalctl tells nothing related to all this.<br />Is patching Kernel / qemu / seabios anymore needed? (As i heard all related patches are already upstream, but not sure about it)</p><br /><div class="quotebox"><cite>dwe11er wrote:</cite><blockquote><div><p>I&#039;ve got Intel&#039;s and never encountered such problems.</p></div></blockquote></div><p>All i can find is that a mainboard with the same chipset as mine are reported to work (990FX)<br />Buying new Hardware is not an option atm. I spent already to much money on that stuff.</p><br /><div class="quotebox"><cite>aw wrote:</cite><blockquote><div><p>No, they are completely different IOMMU implementations</p></div></blockquote></div><p>Didn&#039;t know that. Makes pinning down errors not easier with multiple implementations.<br />Anyone got it working with an ASRock extreme9?</p> <p class="postedit"><em>Last edited by switchphase (2014-07-08 20:16:39)</em></p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1434007">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1434030" class="blockpost roweven"> <h2><span><span class="conr">#2291</span> <a href="viewtopic.php?pid=1434030#p1434030">2014-07-08 20:10:55</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=80333">ahl</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2014-03-16</span></dd> <dd><span>Posts: 20</span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>switchphase wrote:</cite><blockquote><div><div class="quotebox"><cite>ahl wrote:</cite><blockquote><div><p>Can I ask you, how is your R9 270x working now?</p></div></blockquote></div><p>I can&#039;t say much about it ATM. <br />With the 440 Chipset it works like a charm, but the performance is bad. (About 20-30FPS)<br />With the q35 Chipset the host crashes in 3-4 sec.</p></div></blockquote></div><p>Ouch.<br />I&#039;ll keep my R7 260 then and reserve it just for the Windows guest. It works <span class="bbs">mighty fine</span>(UPDATE: see below) there except for that stupid reboot problem. Performance is good.</p><p>I must also mention that it runs VERY cool thanks to the properly sized heatsink. It is truly a rarity. At least Asus did one thing right.</p> <p class="postedit"><em>Last edited by ahl (2014-07-10 09:13:16)</em></p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1434030">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1434034" class="blockpost rowodd"> <h2><span><span class="conr">#2292</span> <a href="viewtopic.php?pid=1434034#p1434034">2014-07-08 20:28:08</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=83383">switchphase</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2014-07-07</span></dd> <dd><span>Posts: 7</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=83383">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>ahl wrote:</cite><blockquote><div><p>I must also mention that it runs VERY cool thanks to the properly sized heatsink. It is truly a rarity. At least Asus did one thing right.</p></div></blockquote></div><p>True</p><p>Had a 9800GTX once.<br />This thing was unusable. With factory settings it runs hot and powered down the pc in less than 30min.<br />With custom colling settings (always on 100%) and underclocking I was able to play about 1-2h without running hot.</p><p>So no more Nvidia for me</p> <p class="postedit"><em>Last edited by switchphase (2014-07-08 20:33:14)</em></p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1434034">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1434050" class="blockpost roweven"> <h2><span><span class="conr">#2293</span> <a href="viewtopic.php?pid=1434050#p1434050">2014-07-08 21:30:04</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=82900">MCMjolnir</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2014-06-19</span></dd> <dd><span>Posts: 9</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=82900">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <p>Woohoo! I finally got it working with qemu.</p><p>I could do with a couple of tips though, since my setup has its own quirks:<br />I&#039;m running it as a headless steam-streaming server, which means I won&#039;t ordinarily have a KB+M or monitor attached and won&#039;t generally interact with the server physically. </p><p>I&#039;m launching qemu through ssh with the <em>-nographic</em> argument (or it won&#039;t work), and when I do so the ssh tab becomes unresponsive (ctrl+c,x,v don&#039;t do anything). I can see the VM boot up fine, but I don&#039;t currently have a way of interacting with it. I can&#039;t even figure out how to close the VM once it&#039;s launched.</p><p>Can anyone explain how I set up VNC with the qemu instance, as well as manage qemu guests from the command line? (google is surprisingly unhelpful) Also, can anyone explain how to use a network bridge? Annoyingly, I had both of these working with virt-manager <img src="https://bbs.archlinux.org/img/smilies/hmm.png" width="15" height="15" alt="hmm" /></p><p>Here&#039;s my qemu profile:</p><div class="codebox"><pre><code>qemu-system-x86_64 -enable-kvm -M q35 -m 8192 -cpu host,kvm=off \ -smp 8,sockets=1,cores=4,threads=8 \ -bios /usr/share/qemu/bios.bin -vga none -nographic \ -device piix4-ide,bus=pcie.0,id=piix4-ide \ -drive file=/var/lib/libvirt/images/Win8Steam-clone.qcow2,id=disk,format=qcow2 \ -device ide-hd,bus=piix4-ide.0,drive=disk \ -device ioh3420,bus=pcie.0,addr=1c.0,multifunction=on,port=1,chassis=1,id=root.1 \ -device vfio-pci,host=03:00.0,bus=root.1,addr=00.0,multifunction=on,x-vga=on \ -device vfio-pci,host=03:00.1,bus=root.1,addr=00.1</code></pre></div><p>I&#039;m really looking forward to getting everything together and am hoping to do a full write up once it&#039;s done <img src="https://bbs.archlinux.org/img/smilies/smile.png" width="15" height="15" alt="smile" /></p> <p class="postedit"><em>Last edited by MCMjolnir (2014-07-08 21:31:12)</em></p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1434050">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1434058" class="blockpost rowodd"> <h2><span><span class="conr">#2294</span> <a href="viewtopic.php?pid=1434058#p1434058">2014-07-08 22:09:32</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=83383">switchphase</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2014-07-07</span></dd> <dd><span>Posts: 7</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=83383">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>MCMjolnir wrote:</cite><blockquote><div><p>Can anyone explain how I set up VNC with the qemu instance, as well as manage qemu guests from the command line?</p></div></blockquote></div><p>When your vm is managed via libvirt you can use virsh. Its pretty the same like virt-manager on the shell. The machine/network settings and so on are done via xml files.<br />If pretty much the same but without VNC/Spice. I did a DHCP reservation and Autologon + Steam Autostart. Firewall rules are set to allow RDP Sessions.</p><p>But I&#039;m far away from testing the RDP / Steam In-Home Streaming.</p><br /><br /><p>Gratz to your success.</p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1434058">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1434062" class="blockpost roweven"> <h2><span><span class="conr">#2295</span> <a href="viewtopic.php?pid=1434062#p1434062">2014-07-08 22:23:05</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=82900">MCMjolnir</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2014-06-19</span></dd> <dd><span>Posts: 9</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=82900">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <p>I was using libvirt/virt-manager before, however to use the <em>kvm=off</em> flag to make my Nvidia card play nice, I *have* to use qemu directly <img src="https://bbs.archlinux.org/img/smilies/hmm.png" width="15" height="15" alt="hmm" /> </p><p>Running list in virsh while the qemu instance is running doesn&#039;t come up with anything, although I could be doing it wrong.</p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1434062">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1434068" class="blockpost rowodd"> <h2><span><span class="conr">#2296</span> <a href="viewtopic.php?pid=1434068#p1434068">2014-07-08 22:59:48</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=80333">ahl</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2014-03-16</span></dd> <dd><span>Posts: 20</span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>dwe11er wrote:</cite><blockquote><div><p>Maybe its AMD&#039;s IOMMU problem? Both of you have AMD cpu and mobo. I&#039;ve got Intel&#039;s and never encountered such problems.</p></div></blockquote></div><p>How likely is that?...</p><p>I will attempt to test all of my newer cards on Intel platform next week just to see if they behave differently. I have the following hardware:</p><p>4 computers: 2x AMD FX, Core i7, AMD A10 APU (HD 7660D)<br />4-6 gpus: HD3870, HD5450, (HD6450), HD6670, R7 260, (R9 270)</p><p>I don&#039;t know what to expect.</p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1434068">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1434094" class="blockpost roweven"> <h2><span><span class="conr">#2297</span> <a href="viewtopic.php?pid=1434094#p1434094">2014-07-09 00:28:10</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=82643">abdullah</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2014-06-10</span></dd> <dd><span>Posts: 33</span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <p>I got it!<br />Now, please add AMD HD 4XXX series to the first post.</p><p>The guest is running Win8, I had a problem when installing the drivers (Beta ones), and I didn&#039;t test the stable driver, Yet, the system works, so.. I think I&#039;m leaving it for now.</p><p>I will be editing the google Doc soon.</p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1434094">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1434112" class="blockpost rowodd"> <h2><span><span class="conr">#2298</span> <a href="viewtopic.php?pid=1434112#p1434112">2014-07-09 02:19:00</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=83411">erganzi</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2014-07-09</span></dd> <dd><span>Posts: 19</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=83411">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <p>Thank you for the guide! It finally work after I tried many times, changed many kernel and qemu versions.</p><p>So I want to share my experience.</p><p>Hardware Info：<br />Gigabyte Z97-D3H<br />i5-4570<br />i915 built-in card for host<br />Sapphire hd7850 for vm</p><p>Software Info:<br />linux-3.12.4 from kernel.org with following patchs.<br /><a href="http://www.spinics.net/lists/linux-pci/msg22136.html" rel="nofollow">pci/iommu: Quirk non-compliant PCIe-to-PCI bridges</a><br /><a href="http://git.kernel.org/cgit/linux/kernel/git/torvalds/linux.git/patch/?id=81b5c7bc8de3e6f63419139c2fc91bf81dea8a7d" rel="nofollow">i915_fixes[1]</a><br /><a href="http://git.kernel.org/cgit/linux/kernel/git/torvalds/linux.git/patch/?id=6e1b4fdad5157bb9e88777d525704aba24389bee" rel="nofollow">i915_fixes[2]</a><br /><a href="http://www.spinics.net/lists/kvm/msg92163.html" rel="nofollow">Enable overrides for missing ACS capabilities</a> </p><p>qemu-2.0.0 with patch<br /><a href="http://lists.nongnu.org/archive/html/qemu-devel/2013-10/msg00597.html" rel="nofollow">vfio-pci: Disallow device from using NoSnoop transactions</a></p><p>Kernel commandline:</p><div class="quotebox"><blockquote><div><p>linux /vmlinuz-3.12.4-VFIOPassthrough root=UUID=6b2e5409-8b73-40db-ad45-f4ec79cdc0cc quiet <br />intel_iommu=on vfio_iommu_type1.allow_unsafe_interrupts=1 pcie_acs_override=downstream <br />pci-stub.ids=1002:6819,1002:aab0</p></div></blockquote></div><p>/etc/modprobe.d/kvm.conf</p><div class="quotebox"><blockquote><div><p>options kvm ignore_msrs=1<br />options kvm allow_unsafe_assigned_interrupts=1<br />options kvm_intel emulate_invalid_guest_state=0</p></div></blockquote></div><p>Qemu commandline:</p><div class="quotebox"><blockquote><div><p>01:00.0 VGA compatible controller: ATI Technologies Inc Device 6819<br />01:00.1 Audio device: ATI Technologies Inc Device aab0</p><p>/root/vfio-bind 0000:01:00.0 0000:01:00.1</p></div></blockquote></div><div class="quotebox"><blockquote><div><p>qemu-system-x86_64 -cpu SandyBridge -smp 2,sockets=2,cores=1,threads=1 \<br />-m 4096 -M q35 -enable-kvm \<br />-device piix4-ide,bus=pcie.0,id=piix4-ide \<br />-drive file=/var/lib/libvirt/images/fwq_win7_vfio.img,id=disk,format=raw \<br />-device ide-hd,bus=piix4-ide.0,drive=disk \<br />-drive file=/var/lib/libvirt/images/LENOVO_WIN7_64.iso,id=isocd \<br />-device ide-cd,bus=piix4-ide.1,drive=isocd \<br />-net nic,model=rtl8139,macaddr=52:54:00:1a:2b:3c \<br />-net tap,ifname=tap0,script=/etc/qemu-ifup,downscript=/etc/qemu-ifdown \<br />-vga none -display none \<br />-device ioh3420,bus=pcie.0,addr=1c.0,multifunction=on,port=1,chassis=1,id=root.1 \<br />-device vfio-pci,host=01:00.0,bus=root.1,addr=00.0,multifunction=on,x-vga=on \<br />-device vfio-pci,host=01:00.1,bus=pcie.0 \&#160; &#160; &#160;/* the audio bus must be pcie.0 or you will be failed. */<br />-usb -usbdevice host:17ef:6018 -usbdevice host:17ef:600e \<br />-boot order=cd -monitor stdio</p></div></blockquote></div><div class="quotebox"><blockquote><div><p>PS: the graphic driver for hd7850 that I use [amd_13_9_win7_win8_64_dd_ccc_whql.exe]</p></div></blockquote></div> <p class="postedit"><em>Last edited by erganzi (2014-07-09 02:24:45)</em></p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1434112">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1434373" class="blockpost roweven"> <h2><span><span class="conr">#2299</span> <a href="viewtopic.php?pid=1434373#p1434373">2014-07-09 21:44:50</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=80333">ahl</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2014-03-16</span></dd> <dd><span>Posts: 20</span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <p>The story of Radeon R7 260 &quot;<em>The Problem</em>&quot; continues</p><p>Just when I had accepted the inconveniences of the eject workaround, I found out that the card can also <strong>freeze the whole system</strong> on Windows startup.</p><p>The freezes started happening when I increased -smp cores to 6. Annoyed by that I did about a hundred manual reboots in order to find out which settings work and which don&#039;t. Unfortunately, the freeze does not happen every time so the results came out inconclusive -- so don&#039;t take this too seriously:</p><div class="codebox"><pre><code>FREEZE OCCURS WITH: -smp sockets=1,cores=6,threads=1 FREEZE DOES NOT OCCUR WITH: cores=2 OR cores=4 OR cores=8 OR without -smp. (-cpu value is irrelevant. Tested to crash with: qemu64, host, Opteron_G4, and Nehalem)</code></pre></div><p>It could all be just a coincidence. Perhaps the settings aren&#039;t relevant at all?</p><p>Since the freeze turned out to be too hard to reproduce, next I did <em>everything</em> in order to get rid of the whole reboot problem (described <a href="https://bbs.archlinux.org/viewtopic.php?pid=1433353#p1433353" rel="nofollow">here</a>). This included: various motherboard bioses, various qemu versions, changing all bios settings, swapping cards, headless host with just one gpu, removing all non-critical devices... nothing helped.</p><p>In one instance I did not get the usual BSoD but just a black frozen screen. It happened when I did &quot;-cpu Opteron_G4,kvm=off&quot;. Quite a coincidence, huh? But I do believe it was a simple coincidence.</p><p>I currently use:<br />Linux 3.15.4 with vga_arbitrer.patch and qemu git (or 2.0.0).</p><p>Host system:<br />AMD FX 8350, Asus Sabertooth 990FX R2.0 BIOS 2501.</p><p>THE GOOD:<br />The card seems to work fine on Linux host with free drivers. While the older power_method=profile is still broken, the newer power_method=dpm works fine assuming kernel can find the latest radeon firmware blobs.</p><p><em>Summary</em>:<br />R7 260 on host: <strong>Should be okay</strong><br />R7 260 on guest: <strong>Unstable. Only for testing</strong></p><p><strong>UPDATE</strong>:<br />After an upgrade to 3.15.5 (which contains kvm and drm fixes) the host freezing problem triggered several times in a row. I was able to refine the above list slightly. Yet my original clue still seems like a strong candidate.</p><p>Why would &quot;-smp sockets=1,cores=6,threads=1&quot; make my computer crash?</p><p><strong>UPDATE 2</strong>:<br />It took a while, but I finally managed to prove that this card is unstable regardless of qemu settings and thus useless for PCI passthrough. I will use it on host.</p><p>The host freeze problem seems to require certain kind of disk and heavy cpu activity or it simply won&#039;t occur. It most often occurs right after reboot when caches are empty.</p><p>By the way above mostly applies to Qemu 2.0.0. The git version of Qemu seemed even more unstable although I did not experience host crashes.</p><p><strong>I will give up for now. Tips and patches are, of course, very welcome.</strong></p> <p class="postedit"><em>Last edited by ahl (2014-07-10 09:25:26)</em></p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1434373">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1434399" class="blockpost rowodd"> <h2><span><span class="conr">#2300</span> <a href="viewtopic.php?pid=1434399#p1434399">2014-07-09 23:30:49</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=82643">abdullah</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2014-06-10</span></dd> <dd><span>Posts: 33</span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <p>so... what does -smp intends to do ?</p><p>And, how I could block internet connection for one guest and let the other enjoy the internet ?</p> <p class="postedit"><em>Last edited by abdullah (2014-07-09 23:32:37)</em></p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1434399">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div class="postlinksb"> <div class="inbox crumbsplus"> <div class="pagepost"> <p class="pagelink conl"><span class="pages-label">Pages: </span><a rel="prev" class="item1" href="viewtopic.php?id=162768&amp;p=91">Previous</a> <a href="viewtopic.php?id=162768">1</a> <span class="spacer">…</span> <a href="viewtopic.php?id=162768&amp;p=90">90</a> <a href="viewtopic.php?id=162768&amp;p=91">91</a> <strong>92</strong> <a href="viewtopic.php?id=162768&amp;p=93">93</a> <a href="viewtopic.php?id=162768&amp;p=94">94</a> <span class="spacer">…</span> <a href="viewtopic.php?id=162768&amp;p=234">234</a> <a rel="next" href="viewtopic.php?id=162768&amp;p=93">Next</a></p> <p class="postlink conr">Topic closed</p> </div> <ul class="crumbs"> <li><a href="index.php">Index</a></li> <li><span>»&#160;</span><a href="viewforum.php?id=48">Topics Going Nowhere</a></li> <li><span>»&#160;</span><strong><a href="viewtopic.php?id=162768">KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</a></strong></li> </ul> <p class="subscribelink clearb"><a href="misc.php?action=subscribe&amp;tid=162768">Subscribe to this topic</a></p> <div class="clearer"></div> </div> </div> </div> <div id="brdfooter" class="block"> <h2><span>Board footer</span></h2> <div class="box"> <div id="brdfooternav" class="inbox"> <div class="conl"> <form id="qjump" method="get" action="viewforum.php"> <div><label><span>Jump to<br /></span> <select name="id" onchange="window.location=('viewforum.php?id='+this.options[this.selectedIndex].value)"> <optgroup label="Technical Issues and Assistance"> <option value="23">Newbie Corner</option> <option value="17">Installation</option> <option value="22">Kernel &amp; Hardware</option> <option value="18">Applications &amp; Desktop Environments</option> <option value="31">Laptop Issues</option> <option value="8">Networking, Server, and Protection</option> <option value="32">Multimedia and Games</option> <option value="50">System Administration</option> <option value="35">Other Architectures</option> </optgroup> <optgroup label="Arch-centric"> <option value="24">Announcements, Package &amp; Security Advisories</option> <option value="1">Arch Discussion</option> <option value="13">Forum &amp; Wiki discussion</option> </optgroup> <optgroup label="Pacman Upgrades, Packaging &amp; AUR"> <option value="44">Pacman &amp; Package Upgrade Issues</option> <option value="49">[testing] Repo Forum</option> <option value="4">Creating &amp; Modifying Packages</option> <option value="38">AUR Issues, Discussion &amp; PKGBUILD Requests</option> </optgroup> <optgroup label="Contributions &amp; Discussion"> <option value="20">GNU/Linux Discussion</option> <option value="27">Community Contributions</option> <option value="33">Programming &amp; Scripting</option> <option value="30">Other Languages</option> <option value="47">Artwork and Screenshots</option> <option value="42">Try This</option> </optgroup> <optgroup label="/dev/null"> <option value="29">Off-Topic</option> <option value="48" selected="selected">Topics Going Nowhere</option> <option value="36">Dustbin</option> </optgroup> </select></label> <input type="submit" value=" Go " accesskey="g" /> </div> </form> </div> <div class="conr"> <p id="feedlinks"><span class="atom"><a href="extern.php?action=feed&amp;tid=162768&amp;type=atom">Atom topic feed</a></span></p> <p id="poweredby">Powered by <a href="http://fluxbb.org/">FluxBB</a></p> </div> <div class="clearer"></div> </div> </div> </div> </div> <div class="end-box"></div> </div> </body> </html>
