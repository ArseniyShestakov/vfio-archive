<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"> <html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en" dir="ltr"> <head> <meta http-equiv="Content-Type" content="text/html; charset=utf-8" /> <title>KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9 / Topics Going Nowhere / Arch Linux Forums</title> <link rel="stylesheet" type="text/css" href="style/ArchLinux.css" /> <link rel="canonical" href="viewtopic.php?id=162768" title="Page 1" /> <link rel="next" href="viewtopic.php?id=162768&amp;p=2" title="Page 2" /> <link rel="alternate" type="application/atom+xml" href="extern.php?action=feed&amp;tid=162768&amp;type=atom" title="Atom topic feed" /> <link rel="stylesheet" media="screen" href="style/ArchLinux/arch.css?v=3" /> <link rel="stylesheet" media="screen" href="style/ArchLinux/archnavbar.css?v=2" /> <link rel="shortcut icon" href="style/ArchLinux/favicon.ico" /> </head> <body> <div id="archnavbar" class="anb-forum"> <div id="archnavbarlogo"><h1><a href="http://www.archlinux.org/">Arch Linux</a></h1></div> <div id="archnavbarmenu"> <ul id="archnavbarlist"> <li id="anb-home"><a href="http://www.archlinux.org/">Home</a></li><li id="anb-packages"><a href="http://www.archlinux.org/packages/">Packages</a></li><li id="anb-forums" class="anb-selected"><a href="https://bbs.archlinux.org/">Forums</a></li><li id="anb-wiki"><a href="https://wiki.archlinux.org/">Wiki</a></li><li id="anb-bugs"><a href="https://bugs.archlinux.org/">Bugs</a></li><li id="anb-aur"><a href="https://aur.archlinux.org/">AUR</a></li><li id="anb-download"><a href="http://www.archlinux.org/download/">Download</a></li> </ul> </div> </div> <div id="punviewtopic" class="pun"> <div class="top-box"></div> <div class="punwrap"> <div id="brdheader" class="block"> <div class="box"> <div id="brdmenu" class="inbox"> <ul> <li id="navindex" class="isactive"><a href="index.php">Index</a></li> <li id="navuserlist"><a href="userlist.php">User list</a></li> <li id="navsearch"><a href="search.php">Search</a></li> <li id="navprofile"><a href="profile.php?id=80749">Profile</a></li> <li id="navlogout"><a href="login.php?action=out&amp;id=80749&amp;csrf_token=5c20501ec397bb45ef8ee8c84db232c8d8e421c6">Logout</a></li> </ul> </div> <div id="brdwelcome" class="inbox"> <ul class="conl"> <li><span>Logged in as <strong>SXX</strong></span></li> <li><span>Last visit: 2015-08-16 12:20:09</span></li> </ul> <ul class="conr"> <li><span>Topics: <a href="search.php?action=show_replies" title="Find topics you have posted to.">Posted</a> | <a href="search.php?action=show_new" title="Find topics with new posts since your last visit.">New</a> | <a href="search.php?action=show_recent" title="Find topics with recent posts.">Active</a> | <a href="search.php?action=show_unanswered" title="Find topics with no replies.">Unanswered</a></span></li> </ul> <div class="clearer"></div> </div> </div> </div> <div id="brdmain"> <div class="linkst"> <div class="inbox crumbsplus"> <ul class="crumbs"> <li><a href="index.php">Index</a></li> <li><span>»&#160;</span><a href="viewforum.php?id=48">Topics Going Nowhere</a></li> <li><span>»&#160;</span><strong><a href="viewtopic.php?id=162768">KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</a></strong></li> </ul> <div class="pagepost"> <p class="pagelink conl"><span class="pages-label">Pages: </span><strong class="item1">1</strong> <a href="viewtopic.php?id=162768&amp;p=2">2</a> <a href="viewtopic.php?id=162768&amp;p=3">3</a> <span class="spacer">…</span> <a href="viewtopic.php?id=162768&amp;p=234">234</a> <a rel="next" href="viewtopic.php?id=162768&amp;p=2">Next</a></p> <p class="postlink conr">Topic closed</p> </div> <div class="clearer"></div> </div> </div> <div id="p1268413" class="blockpost rowodd firstpost blockpost1"> <h2><span><span class="conr">#1</span> <a href="viewtopic.php?pid=1268413#p1268413">2013-05-05 16:13:55</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=70922">nbhs</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd class="postavatar"><img src="https://bbs.archlinux.org/img/avatars/70922.jpg?m=1367773811" width="80" height="80" alt="" /></dd> <dd><span>From: Montevideo, Uruguay</span></dd> <dd><span>Registered: 2013-05-02</span></dd> <dd><span>Posts: 402</span></dd> </dl> </div> <div class="postright"> <h3>KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <p><span style="color: #FF0000">THIS GUIDE IS SLIGHTLY OUTDATED AND I&#039;M NOT MAINTAINING IT ANYMORE</span><br /><span style="color: #FF0000">PLEASE CHECK OUT <a href="http://vfio.blogspot.com/" rel="nofollow">ALEX&#039;S BLOG</a> FOR AN UP TO DATE GUIDE</span></p><p>This is intented for people who wish to pass-through a GPU to a virtual machine using the KVM hypervisor, QEMU and vfio-pci</p><p>NOTE: AMD RADEON 5xxx, 6xxx, 7xxx, 2xx and NVIDIA GEFORCE 7, 8, 4xx, 5xx, 6xx, 7xx 9xx have been reported working with this, passing though an intel IGD is not supported YET</p><p><span style="color: #FF0000">NOTE: THIS IS EXPERIMENTAL SO IT MIGHT NOT WORK ON YOUR SYSTEM</span> </p><p>This is the result on my radeon 6950:</p><p><a href="http://i.imgur.com/PtTM4BD.jpg" rel="nofollow"><span class="postimg"><img src="http://i.imgur.com/qCrwPFP.jpg" alt="qCrwPFP.jpg" /></span></a></p><p>This is the result on my geforce 470 gtx:</p><p><a href="http://i.imgur.com/1RmOcko.jpg" rel="nofollow"><span class="postimg"><img src="http://i.imgur.com/2WrnYi4.jpg" alt="2WrnYi4.jpg" /></span></a></p><p><strong>Recommended reads</strong></p><p>Alex Williamson&#039;s <a href="http://vfio.blogspot.com/" rel="nofollow">blog</a> and <a href="http://vfio.blogspot.com/2014/08/vfiovga-faq.html" rel="nofollow">FAQ</a> for detailed technical information<br /><a href="http://www.linux-kvm.org/page/OVMF" rel="nofollow">OVMF whitepaper</a>.<br /><a href="https://docs.google.com/spreadsheet/ccc?key=0Aryg5nO-kBebdFozaW9tUWdVd2VHM0lvck95TUlpMlE&amp;usp=drive_web#gid=0" rel="nofollow">GPU passthrough database</a> by <a href="https://bbs.archlinux.org/profile.php?id=73114" rel="nofollow">noctavian</a></p><p>At this moment there are two ways to achieve this using KVM: legacy VGA via <a href="http://www.seabios.org/SeaBIOS" rel="nofollow">Seabios</a> or non-VGA (UEFI) via <a href="http://www.tianocore.org/ovmf/" rel="nofollow">OVMF</a></p><p>The main practical advantage of using OVMF is that on intel systems you no longer need the <a href="https://lkml.org/lkml/2014/5/9/517" rel="nofollow">i915 VGA arbiter patch</a> which also disables DRI on the host</p><p><strong>Requirements</strong></p><ul><li><p>AMD-VI/VT-D enabled and working <span style="color: #FF0000">(On intel systems both your MB and you CPU must support it, to find out if you CPU has VT-D support go here: <a href="http://ark.intel.com/" rel="nofollow">http://ark.intel.com/</a>, you also need to boot with intel_iommu=on to enable it)</span></p></li><li><p>At least 2 GPU&#039;s, one primary boot device and the card you wish to pass-through</p></li><li><p>Qemu=&gt;2.0</p></li><li><p>Aditional kernel patches might be required if you&#039;re using an Intel CPU: <a href="https://lkml.org/lkml/2013/5/30/513" rel="nofollow">ACS override patch</a> and <a href="https://lkml.org/lkml/2014/5/9/517" rel="nofollow">i915 VGA arbiter patch</a>, you can find a kernel package with these patches included on AUR: <a href="https://aur.archlinux.org/packages/?O=0&amp;K=linux-vfio" rel="nofollow">linux-vfio</a></p></li></ul><p>Aditional requirements for OVMF:</p><ul><li><p>An UEFI compatible GPU (Most modern gpus support this, SEE: <a href="http://vfio.blogspot.com/2014/08/does-my-graphics-card-rom-support-efi.html" rel="nofollow">Does my graphics card ROM support EFI?</a></p></li><li><p>An UEFI compatible GUEST (ex: Windows 7 and up)</p></li><li><p>OVMF:&#160; <a href="https://www.kraxel.org/repos/jenkins/edk2/" rel="nofollow">Gerd Hoffmann&#039;s rpms</a> or <a href="https://aur.archlinux.org/packages/ovmf-svn/" rel="nofollow">OVMF-svn</a> from AUR</p></li></ul><p>If you&#039;re building your kernel manually this option is required:</p><div class="codebox"><pre><code>CONFIG_VFIO_PCI_VGA=y</code></pre></div><p><strong>Preparing your System</strong></p><p>On intel system the <a href="https://lkml.org/lkml/2014/5/9/517" rel="nofollow">i915 VGA arbiter patch</a> is required if:</p><ol class="decimal"><li><p>You&#039;re using the IGD on your host</p></li><li><p>You&#039;re doing VGA assignment</p></li></ol><p><span style="color: #FF0000">NOTE: Enabling this will <a href="https://lkml.org/lkml/2014/5/9/517" rel="nofollow">disable DRI</a>!</span></p><p>If you wish to avoid this, then then you should try OVMF</p><p>To enable it add this kernel parameter to your bootloader:</p><div class="codebox"><pre><code>i915.enable_hd_vgaarb=1</code></pre></div><p>Next, we need to prepare the GPU for vfio:</p><ol class="decimal"><li><p>Blacklist radeon or nouveau or nvidia or fglrx on /etc/modprobe.d/blacklist.conf </p><p>Example, blacklisting the opensource radeon module:</p><div class="codebox"><pre><code>echo &quot;blacklist radeon&quot; &gt;&gt; /etc/modprobe.d/blacklist.conf </code></pre></div></li><li><p>Use pci-stub</p><p>In my case since i have 2 radeon cards blacklisting the radeon module is not an option, so i use pci-stub</p><p>NOTE: If pci-stub was built as a module, you&#039;ll need to modify /etc/mkinitcpio.conf and add pci-stub in the MODULES section, after that you need to update your initramfs like this</p><div class="codebox"><pre><code>mkinitcpio -p linux-mainline</code></pre></div><p>lspci </p><div class="codebox"><pre><code>07:00.0 VGA compatible controller: Advanced Micro Devices, Inc. [AMD/ATI] Cayman PRO [Radeon HD 6950] &lt;-- radeon 6950 07:00.1 Audio device: Advanced Micro Devices, Inc. [AMD/ATI] Cayman/Antilles HDMI Audio [Radeon HD 6900 Series] &lt;-- radeon 6950 audio</code></pre></div><p>lspci -n</p><div class="codebox"><pre><code>07:00.0 0300: 1002:6719 &lt;-- radeon 6950 07:00.1 0403: 1002:aa80 &lt;-- radeon 6950 audio</code></pre></div><p>Now add this kernel parameter to your bootloader:</p><div class="codebox"><pre><code>pci-stub.ids=1002:6719,1002:aa80</code></pre></div><p>dmesg | grep pci-stub</p><div class="codebox"><pre><code>[ 2.096151] pci-stub: add 1002:6719 sub=FFFFFFFF:FFFFFFFF cls=00000000/00000000 [ 2.096160] pci-stub 0000:07:00.0: claimed by stub [ 2.096165] pci-stub: add 1002:AA80 sub=FFFFFFFF:FFFFFFFF cls=00000000/00000000 [ 2.096174] pci-stub 0000:07:00.1: claimed by stub [ 2.096178] pci-stub: add 1B21:1042 sub=FFFFFFFF:FFFFFFFF cls=00000000/00000000</code></pre></div></li></ol><p><strong>Setting up vfio and kvm modules</strong></p><p><span style="color: #FF0000">*********************************</span></p><p><span style="color: #FF0000">This is only required if you get this message:</span></p><div class="codebox"><pre><code>vfio_iommu_type1_attach_group: No interrupt remapping support. Use the module param &quot;allow_unsafe_interrupts&quot; to enable VFIO IOMMU support on this platform</code></pre></div><p>If your board doesn&#039;t enable interrupt remapping, you need to add this to your bootloader:</p><div class="codebox"><pre><code>vfio_iommu_type1.allow_unsafe_interrupts=1</code></pre></div><p>Or if vfio-pci was built as a module ( default on arch )</p><div class="codebox"><pre><code>echo &quot;options vfio_iommu_type1 allow_unsafe_interrupts=1&quot; &gt; /etc/modprobe.d/vfio_iommu_type1.conf</code></pre></div><p><span style="color: #FF0000">*********************************</span></p><p>Some applications like Passmark Performance Test and SiSoftware Sandra crash the VM without this:</p><div class="codebox"><pre><code>echo &quot;options kvm ignore_msrs=1&quot; &gt;&gt; /etc/modprobe.d/kvm.conf</code></pre></div><p><strong>Binding a device to vfio-pci</strong></p><p>We&#039;ll use this script to make life easier:</p><div class="codebox"><pre><code>#!/bin/bash modprobe vfio-pci for dev in &quot;$@&quot;; do vendor=$(cat /sys/bus/pci/devices/$dev/vendor) device=$(cat /sys/bus/pci/devices/$dev/device) if [ -e /sys/bus/pci/devices/$dev/driver ]; then echo $dev &gt; /sys/bus/pci/devices/$dev/driver/unbind fi echo $vendor $device &gt; /sys/bus/pci/drivers/vfio-pci/new_id done</code></pre></div><p>Save it as /usr/bin/vfio-bind</p><div class="codebox"><pre><code>chmod 755 /usr/bin/vfio-bind</code></pre></div><p>Bind the GPU and GPU audio:</p><div class="codebox"><pre><code>vfio-bind 0000:07:00.0 0000:07:00.1</code></pre></div><p>Systemd service:</p><div class="codebox"><pre><code>[Unit] Description=Binds devices to vfio-pci After=syslog.target [Service] EnvironmentFile=-/etc/vfio-pci.cfg Type=oneshot RemainAfterExit=yes ExecStart=-/usr/bin/vfio-bind $DEVICES [Install] WantedBy=multi-user.target</code></pre></div><p>cat /etc/vfio-pci.cfg</p><div class="codebox"><pre><code>DEVICES=&quot;0000:00:11.0 0000:04:00.0 0000:05:00.0 0000:06:00.0 0000:07:00.0 000:07:00.1&quot;</code></pre></div><p><strong>Testing if its working out</strong></p><p>Seabios:</p><div class="quotebox"><blockquote><div><p>qemu-system-x86_64 -enable-kvm -m 1024 -cpu host,<span style="color: #FF0000">kvm=off</span> \<br />-smp 4,sockets=1,cores=4,threads=1 \<br />-device vfio-pci,host=07:00.0,<span style="color: #FF0000">x-vga=on</span> -device vfio-pci,host=07:00.1 \<br /><span style="color: #FF0000">-vga none</span></p></div></blockquote></div><p>OVMF:</p><div class="quotebox"><blockquote><div><p>qemu-system-x86_64 -enable-kvm -m 1024 -cpu host,<span style="color: #FF0000">kvm=off</span>&#160; \<br />-smp 4,sockets=1,cores=4,threads=1 \<br /><span style="color: #FF0000">-drive if=pflash,format=raw,readonly,file=/usr/share/ovmf/x64/ovmf_code_x64.bin</span> \<br /><span style="color: #FF0000">-drive if=pflash,format=raw,file=/usr/share/ovmf/x64/ovmf_vars_x64.bin</span> \<br />-device vfio-pci,host=07:00.0 -device vfio-pci,host=07:00.1 \<br /><span style="color: #FF0000">-vga none</span></p></div></blockquote></div><p>Note:</p><ul><li><p>kvm=off will hide the kvm hypervisor signature, this is required for NVIDIA cards, since its driver will refuse to work on an hypervisor and result in Code 43 on windows (unless you&#039;re using a QUADRO)</p></li><li><p>x-vga=on is required for vga assignment</p></li><li><p>-vga none disables the default vga device on QEMU, it is also required for vga assignment</p></li></ul><p>You should see a black qemu window on your main display, and seabios/ovmf ouput on your monitor from your passthru&#039;d card saying it cant find anything to boot</p><p>If you&#039;re using an intel cpu and nothing happens try this:</p><div class="codebox"><pre><code>modprobe -r kvm_intel modprobe kvm_intel emulate_invalid_guest_state=0</code></pre></div><p>NOTE: There might be some problems using nvidia/fglrx/nouveau drivers on the host gpu, see the ISSUES section below on how to solve this</p><p>At this point you&#039;re ready to create your vm, you could use <a href="http://libvirt.org/" rel="nofollow">libvirt</a> + <a href="http://virt-manager.org/" rel="nofollow">virt-manager</a> to create your vm using a nice graphical interface, there are<br />also some interesting examples in this thread, otherwise if you prefer to use the command line continue reading</p><p><strong>DISK:</strong> </p><p><strong>Creating a disk image:</strong></p><p>Create a 30Gb raw image:</p><div class="codebox"><pre><code>dd if=/dev/zero of=windows.img bs=1M seek=30000 count=0</code></pre></div><p><strong>Using a VIRTIO controller:</strong></p><p>We create our virtio controller for qemu:</p><div class="codebox"><pre><code> -device virtio-scsi-pci,id=scsi</code></pre></div><p>Attaching our hdd:</p><div class="codebox"><pre><code>-drive file=/home/nbhs/windows.img,id=disk,format=raw,if=none -device scsi-hd,drive=disk</code></pre></div><p>Attaching a cdrom:</p><div class="codebox"><pre><code>-drive file=/home/nbhs/windows.iso,id=isocd,if=none -device scsi-cd,drive=isocd</code></pre></div><p>To install windows, you&#039;ll need to download the virtio drivers iso from <a href="http://alt.fedoraproject.org/pub/alt/virtio-win/latest/images/" rel="nofollow">here</a></p><p>Attaching the virtio iso:</p><div class="codebox"><pre><code>-drive file=/home/nbhs/virtio.iso,id=virtiocd,if=none -device ide-cd,bus=ide.1,drive=virtiocd</code></pre></div><p>Windows will complain it cant find a disk to install to, just click browse, find the folder for your os/arch, select &quot;RED HAT VirtIO pass-through controller&quot; then click next.</p><p>For more info check out the <a href="https://wiki.archlinux.org/index.php/QEMU" rel="nofollow">Archlinux wiki&#039;s QEMU section</a></p><p><strong>Using a physical disk or partition:</strong> </p><div class="codebox"><pre><code>-drive file=/dev/sdb,id=disk,format=raw,if=none -device scsi-hd,drive=disk</code></pre></div><p>You might need to change the bus depending on the controller you use</p><p>If you wish to use a physical partition and be able to read its contents later on, you can follow these guides:</p><p><a href="http://fds-team.de/cms/articles/2013-12/use-a-real-windows-7-partition-in-virtualbox-kvm-vmware-player-u.html" rel="nofollow">http://fds-team.de/cms/articles/2013-12 … yer-u.html</a><br /><a href="https://wiki.archlinux.org/index.php/QEMU#Using_any_real_partition_as_the_single_primary_partition_of_a_hard_disk_image" rel="nofollow">https://wiki.archlinux.org/index.php/QE … disk_image</a></p><br /><p><strong>Passing a sata disk controller to qemu:</strong></p><p>If you dual boot like me you can pass an entire sata controller (in ahci mode) and all the drives attached, and seabios will boot from them.</p><p>lspci</p><div class="codebox"><pre><code>00:11.0 SATA controller: Advanced Micro Devices [AMD] nee ATI SB7x0/SB8x0/SB9x0 SATA Controller [AHCI mode] (rev 40)</code></pre></div><p>Make sure all volumes are unmounted, then bind the controller to vfio:</p><div class="codebox"><pre><code>vfio-bind 0000:00:11.0</code></pre></div><p>Now we pass the controller to the vm:</p><div class="codebox"><pre><code>-device vfio-pci,host=00:11.0</code></pre></div><p><strong> USB:</strong> </p><p>Its also possible to passthrough a usb controller, in my case an ASMEDIA USB3 Controller:</p><p>lspci</p><div class="codebox"><pre><code>04:00.0 USB controller: ASMedia Technology Inc. ASM1042 SuperSpeed USB Host Controller 05:00.0 USB controller: ASMedia Technology Inc. ASM1042 SuperSpeed USB Host Controller 06:00.0 USB controller: ASMedia Technology Inc. ASM1042 SuperSpeed USB Host Controller</code></pre></div><p>Bind them to vfio:</p><div class="codebox"><pre><code>vfio-bind 0000:04:00.0 0000:05:00.0 0000:06:00.0</code></pre></div><p>Pass them to the vm:</p><div class="codebox"><pre><code>-device vfio-pci,host=04:00.0 \ -device vfio-pci,host=05:00.0 \ -device vfio-pci,host=06:00.0</code></pre></div><p>Or a specific device:</p><p>lsusb</p><div class="codebox"><pre><code>... Bus 004 Device 010: ID 045e:00e1 Microsoft Corp. Wireless Laser Mouse 6000 Reciever &lt;-- mouse Bus 004 Device 011: ID 045e:074b Microsoft Corp. &lt;-- keyboard ...</code></pre></div><p>We pass them to the vm:</p><div class="codebox"><pre><code>-usb -usbdevice host:045e:00e1 -usbdevice host:045e:074b</code></pre></div><p><strong> NETWORK:</strong> </p><p>Please see <a href="https://wiki.archlinux.org/index.php/QEMU#Networking" rel="nofollow">https://wiki.archlinux.org/index.php/QEMU#Networking</a></p><p><strong> AUDIO EMULATION:</strong> </p><p>To hear the sound from the vm on your host speakers you&#039;ll need to add this lines:</p><div class="codebox"><pre><code>-soundhw hda</code></pre></div><p>You might need to start qemu like this:</p><div class="codebox"><pre><code>QEMU_PA_SAMPLES=128 QEMU_AUDIO_DRV=pa qemu-system-x86_64...</code></pre></div><p>alsa:</p><div class="codebox"><pre><code>QEMU_ALSA_DAC_BUFFER_SIZE=512 QEMU_ALSA_DAC_PERIOD_SIZE=170 QEMU_AUDIO_DRV=alsa qemu-system-x86_64...</code></pre></div><p>Note: these are the settings i found that work great on my system, if you get crackling/skipping audio you might want to try different settings</p><p>To see the available drivers and audio options:</p><div class="codebox"><pre><code>qemu-system-x86_64 -audio-help</code></pre></div><p><strong>LOADING YOUR CARD ROM FROM A DUMP/FILE:</strong></p><p>modify this line:</p><div class="codebox"><pre><code>-device vfio-pci,host=07:00.0,...... \</code></pre></div><p>change it to this:</p><div class="codebox"><pre><code>-device vfio-pci,host=07:00.0,......,romfile=/path/to/your/gpu/bios.bin \</code></pre></div><p><strong>ISSUES:</strong></p><ul><li><p>Using the latest NVIDIA drivers on the guest will result in code 43, <a href="http://lists.gnu.org/archive/html/qemu-devel/2014-06/msg00319.html" rel="nofollow">but there&#039;s a workarround</a></p></li><li><p>Using the latest NVIDIA drivers on the guest using hv enlightenments will result in code 43, see: <a href="https://forums.geforce.com/default/topic/775950/geforce-drivers/official-nvidia-344-11-whql-display-driver-feedback-thread-9-18-14-/post/4314318/#4314318" rel="nofollow">https://forums.geforce.com/default/topi … 8/#4314318</a></p></li><li><p>Using AMD proprieraty drivers on the host, see: <a href="https://bbs.archlinux.org/viewtopic.php?pid=1273412#p1273412" rel="nofollow">https://bbs.archlinux.org/viewtopic.php … 2#p1273412</a> the only solution atm is using the opensource radeon driver</p></li></ul><p><strong> PERFORMANCE IMPROVEMENTS:</strong> </p><ul><li><p>SEE: <a href="https://bbs.archlinux.org/viewtopic.php?pid=1270311#p1270311" rel="nofollow">https://bbs.archlinux.org/viewtopic.php … 1#p1270311</a></p></li><li><p>Pin vcpu to pcpu, see <a href="http://www.linux-kvm.com/content/tip-running-your-vm-specific-cpus" rel="nofollow">http://www.linux-kvm.com/content/tip-ru … cific-cpus</a></p></li><li><p>Use cgroups, specifically cpuset, see <a href="https://access.redhat.com/site/documentation/en-US/Red_Hat_Enterprise_Linux/6/html/Resource_Management_Guide/sec-cpuset.html" rel="nofollow">https://access.redhat.com/site/document … puset.html</a></p></li><li><p>Use Hugepages, see <a href="http://pic.dhe.ibm.com/infocenter/lnxinfo/v3r0m0/index.jsp?topic=%2Fliaat%2Fliaattunhp.htm" rel="nofollow">http://pic.dhe.ibm.com/infocenter/lnxin … ttunhp.htm</a></p></li><li><p>Use Hyper-V enlightenments, see: <a href="http://blog.wikichoon.com/2014/07/enabling-hyper-v-enlightenments-with-kvm.html" rel="nofollow">http://blog.wikichoon.com/2014/07/enabl … h-kvm.html</a></p></li></ul> <p class="postedit"><em>Last edited by nbhs (2015-07-11 16:23:26)</em></p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1268413">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1268571" class="blockpost roweven"> <h2><span><span class="conr">#2</span> <a href="viewtopic.php?pid=1268571#p1268571">2013-05-06 02:24:16</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=48004">crondog</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2011-04-21</span></dd> <dd><span>Posts: 108</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=48004">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <p>Nice work. I currently use xen to achieve a similar thing since the upstream qemu never worked <img src="https://bbs.archlinux.org/img/smilies/smile.png" width="15" height="15" alt="smile" /></p><p>I hope to give this a try soon so i can get rid of xen since i only ever run 1 vm and its a bit of a waste</p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1268571">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1270311" class="blockpost rowodd"> <h2><span><span class="conr">#3</span> <a href="viewtopic.php?pid=1270311#p1270311">2013-05-10 00:30:06</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=70922">nbhs</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd class="postavatar"><img src="https://bbs.archlinux.org/img/avatars/70922.jpg?m=1367773811" width="80" height="80" alt="" /></dd> <dd><span>From: Montevideo, Uruguay</span></dd> <dd><span>Registered: 2013-05-02</span></dd> <dd><span>Posts: 402</span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <p>EDITED:</p><p>The single most important thing i found to improve the vm performance on my amd board is to disable nested page tables:</p><div class="codebox"><pre><code>echo &quot;options kvm-amd npt=0&quot; &gt; /etc/modprobe.d/kvm-amd.conf</code></pre></div><p>These are some other things i did to improve the performance:</p><ul><li><p>-cpu host</p></li><li><p>Using hugetlbfs instead of transparent huge pages</p></li><li><p>Set Preemption Model to Voluntary on kernel</p></li><li><p>Set Timer frequency&#160; 1000HZ on kernel</p></li></ul><p>Im using -cpu Opteron_G4 instead of -cpu host, this shouldnt affect performance though.</p><p><a href="http://imgur.com/Pqh7TpU" rel="nofollow"><span class="postimg"><img src="http://i.imgur.com/KL5cJaX.jpg" alt="KL5cJaX.jpg" /></span></a></p><p>NOTE: i use 6 cores (2-7) for the vm, 2 (0-1) are reserved for the host using cpuset cgroups<br />NOTE: Most of these settings affect vcpu performance, gpu performance remains about the same.</p> <p class="postedit"><em>Last edited by nbhs (2014-01-20 22:02:03)</em></p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1270311">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1270712" class="blockpost roweven"> <h2><span><span class="conr">#4</span> <a href="viewtopic.php?pid=1270712#p1270712">2013-05-10 19:16:52</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=47675">jgott</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2011-04-10</span></dd> <dd><span>Posts: 21</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=47675">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <p>Thank you for the very detailed post, nbhs! I&#039;ve been struggling to get Xen working in either a primary or secondary passthrough situation over the past week, and I was about to start trying with KVM. This guide will sure come in handy.</p><p>I have a fairly similar configuration to you:<br />ASUS M5A99X EVO (990X/SB950)<br />AMD FX-8350 (4.8 GHz)<br />AMD Radeon HD 5750 (for Linux host)<br />AMD Radeon HD 7870 (for Windows guest)</p><p>Like you, my ASUS motherboard has a broken IVRS table (with precisely the same wrong values as yours, apparently). In addition to overriding it in the kernel, I actually went to all the bother to send ASUS a detailed and helpful support request detailing the AMD IOMMU spec and the chipset documentation, telling them how they could fix their firmware. My mistake, as the support guy continually misunderstands me due to the language barrier (and because he probably just wants me to go away). So I&#039;m almost certainly wasting my time trying to get the actual responsible party to fix their broken firmware.</p><p>I&#039;ll keep you posted on any issues that I run into as I give KVM a try.</p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1270712">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1270895" class="blockpost rowodd"> <h2><span><span class="conr">#5</span> <a href="viewtopic.php?pid=1270895#p1270895">2013-05-11 01:51:58</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=70922">nbhs</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd class="postavatar"><img src="https://bbs.archlinux.org/img/avatars/70922.jpg?m=1367773811" width="80" height="80" alt="" /></dd> <dd><span>From: Montevideo, Uruguay</span></dd> <dd><span>Registered: 2013-05-02</span></dd> <dd><span>Posts: 402</span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>jgott wrote:</cite><blockquote><div><p>Like you, my ASUS motherboard has a broken IVRS table (with precisely the same wrong values as yours, apparently). In addition to overriding it in the kernel, I actually went to all the bother to send ASUS a detailed and helpful support request detailing the AMD IOMMU spec and the chipset documentation, telling them how they could fix their firmware. My mistake, as the support guy continually misunderstands me due to the language barrier (and because he probably just wants me to go away). So I&#039;m almost certainly wasting my time trying to get the actual responsible party to fix their broken firmware.</p><p>I&#039;ll keep you posted on any issues that I run into as I give KVM a try.</p></div></blockquote></div><p>Yeah so did i, unfortunately asus doesnt support linux, and their tech support are bunch of monkeys behind a keyboard, they remind me of this <a href="http://www.youtube.com/watch?v=C2Ph8zwpNyI" rel="nofollow">http://www.youtube.com/watch?v=C2Ph8zwpNyI</a>, ill never buy a product from them ever again.</p> <p class="postedit"><em>Last edited by nbhs (2013-05-11 01:54:31)</em></p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1270895">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1273412" class="blockpost roweven"> <h2><span><span class="conr">#6</span> <a href="viewtopic.php?pid=1273412#p1273412">2013-05-16 00:12:13</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=47675">jgott</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2011-04-10</span></dd> <dd><span>Posts: 21</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=47675">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <p>I&#039;ve run into two problems so far.</p><p>First problem: I had to stop using the proprietary ATI graphics driver on the host, as running the VM and X at the same time would hang the system. Unfortunately, the fglrx module thinks it&#039;s a great idea to grab all the cards in the system and remap their IRQs (as shown by dmesg and /proc/interrupts) despite them actually being assigned to pci-stub. Apparently it just scans the PCI bus looking for ATI cards and then configures all of them, no matter which device the module was actually loaded for. Brilliant.</p><p>I thought I might be able to get around this, as I was able to hack the PCI ID for the 7870 out of the fglrx kernel module by modifying /usr/share/ati/build_mod/fglrxko_pci_ids.h and rebuilding. After I did this, the fglrx kernel module ignored the secondary card like I wanted it to. But the fglrx X driver would then refuse to let X start, since it was doing its own PCI bus scan, in which it recognized the secondary card and realized that the kernel module hadn&#039;t configured it. And to my great disgruntlement, the fglrx X driver ignores useful options like &quot;AutoAddGPU&quot; &quot;false&quot;, plus I can&#039;t just hack their PCI scan to ignore the card because they&#039;ve gone and duplicated a bunch of external code (like the PCI bus scanning). I basically can&#039;t change its behavior because it&#039;s closed source.</p><p>I suppose an older version of fglrx might work (pre-7000 series, so it wouldn&#039;t recognize the card). Hacking the kernel to misreport the PCI ID would probably work too. For now, though, just using the open source radeon driver is an acceptable solution.</p><p>Second problem: despite the new patches to qemu and linux, the card is apparently not being reset between guest runs. If I run the VM twice, the host will hang, gradually getting slower for a few seconds until it freezes, almost like it&#039;s experiencing an interrupt storm or something; eventually even Magic SysRq doesn&#039;t work. Suspending the host appears to be enough to reset the card, so for now, I&#039;ll just suspend/wake between VM runs. I plan to try the eject-before-shutdown method too.</p><p>Everything else seems to be working though. Performance is impressive! Now I need to buy a USB switch for input devices; or maybe I&#039;ll just solder/glue one out of spare parts. Those things are ridiculously overpriced for what amounts to a 4-pole, double-throw switch with USB ports on the ends.</p><p>(I was going to attach some screenshots to this post, but Print Screen made the guest freeze. So maybe I&#039;ll post those later.)</p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1273412">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1273415" class="blockpost rowodd"> <h2><span><span class="conr">#7</span> <a href="viewtopic.php?pid=1273415#p1273415">2013-05-16 00:17:16</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=70922">nbhs</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd class="postavatar"><img src="https://bbs.archlinux.org/img/avatars/70922.jpg?m=1367773811" width="80" height="80" alt="" /></dd> <dd><span>From: Montevideo, Uruguay</span></dd> <dd><span>Registered: 2013-05-02</span></dd> <dd><span>Posts: 402</span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <p>Thanks for the report!, I had no idea about fglrx, i havent used them since i had a Radeon 9800xt <img src="https://bbs.archlinux.org/img/smilies/smile.png" width="15" height="15" alt="smile" />, and opensource is good enough for my 5450. You can try ejecting the card on windows just like you would eject a pendrive, method No3 is about the automatization of this process before shutting down/restarting the guest. You could also fill a bug report on qemu-devel about the card not reseting properly, in my case i can hear the gpu fan speeding up after a reset. I also re-uploaded linux-mainline based on 3.9.2 and qemu-git packages with reset patches, they&#039;re working fine on my pc.</p><p>EDIT: Could you try to load your gpu bios by file and see if it still crash? i remember a couple of times my vm crashed after a reset ( before i accidentally physically destroyed the bios chip <img src="https://bbs.archlinux.org/img/smilies/lol.png" width="15" height="15" alt="lol" />, now it wont work without loading a rom file <img src="https://bbs.archlinux.org/img/smilies/smile.png" width="15" height="15" alt="smile" /> ) and after i manually loaded the rom, didnt happen again, you can do this by appending &#039;,rombar=0, romfile=/path/to/the/rom.bin&#039; </p><p>ex:</p><div class="codebox"><pre><code>-device vfio-pci,host=07:00.0,x-vga=on,addr=0.0,multifunction=on,bus=root.1,rombar=0,romfile=/home/nbhs/vgabios-6950.rom</code></pre></div><p>Or use my script, and modify VBIOS=&quot;&quot; to VBIOS=&quot;/path/to/rom&quot;</p><p>You can find yours here: <a href="http://www.techpowerup.com/vgabios/" rel="nofollow">http://www.techpowerup.com/vgabios/</a></p> <p class="postedit"><em>Last edited by nbhs (2013-05-16 01:43:08)</em></p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1273415">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1273651" class="blockpost roweven"> <h2><span><span class="conr">#8</span> <a href="viewtopic.php?pid=1273651#p1273651">2013-05-16 13:51:55</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=71361">apoapo</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2013-05-16</span></dd> <dd><span>Posts: 15</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=71361">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <p>Tried to get it working for me too, but with no success. <img src="https://bbs.archlinux.org/img/smilies/sad.png" width="15" height="15" alt="sad" /></p><p>My system:<br />Radeon 7950<br />i5 3470 (non-K) incl Intel GPU for Host<br />AsRock Z77 Extreme4<br />8GB Ram</p><p>First thing I was trying was the old way, with pci-assign. I was able to first boot with VNC, installing ATI drivers. After reboot the screen woke up at login promt and the Perfomance was ok/good (I wasn&#039;t trying too much. Windows Performance Index at 7.5, so it should have worked <img src="https://bbs.archlinux.org/img/smilies/wink.png" width="15" height="15" alt="wink" />). But at reboot of VM the host crashed....</p><p>So I was looking around the internet and found this thread. Tried many hours to get it working, but I don&#039;t get any picture to the screen. No Seabios Texts and nothing in Windows after installing ATI drivers with vnc (and removing VNC again) like it was working with pci-assign.</p><p>Have tried Qemu-git from AUR, Qemu-1.5-rc1, seabios from your link, stock kernel (3.9.2-1) and kernel 3.10-rc1.<br />Did not change anything <img src="https://bbs.archlinux.org/img/smilies/wink.png" width="15" height="15" alt="wink" />.</p><p>The only thing I havn&#039;t tried till now is to dump the VGA bios and put it in. Will do this today, when I´m at home.</p><p>IOMMU is enabled. logfiles look good (for me <img src="https://bbs.archlinux.org/img/smilies/big_smile.png" width="15" height="15" alt="big_smile" />). The only thing is &quot;DMAR: No ATSR found&quot;. You have a Idea about this?<br />Full logfiles I can add later.&#160; </p><p>Bind everything to vfio-pci seems to work. Also there isn&#039;t any error message at KVM-Start<br />I also tried all with pci-stub entries at grub and without, same with the interrupt remapping entry.</p><p>Do you have any Idea? <img src="https://bbs.archlinux.org/img/smilies/big_smile.png" width="15" height="15" alt="big_smile" /></p><p>Thanks<br />apo</p> <p class="postedit"><em>Last edited by apoapo (2013-05-16 14:07:21)</em></p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1273651">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1273852" class="blockpost rowodd"> <h2><span><span class="conr">#9</span> <a href="viewtopic.php?pid=1273852#p1273852">2013-05-16 19:32:18</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=70922">nbhs</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd class="postavatar"><img src="https://bbs.archlinux.org/img/avatars/70922.jpg?m=1367773811" width="80" height="80" alt="" /></dd> <dd><span>From: Montevideo, Uruguay</span></dd> <dd><span>Registered: 2013-05-02</span></dd> <dd><span>Posts: 402</span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>apoapo wrote:</cite><blockquote><div><p>Tried to get it working for me too, but with no success. <img src="https://bbs.archlinux.org/img/smilies/sad.png" width="15" height="15" alt="sad" /></p><p>My system:<br />Radeon 7950<br />i5 3470 (non-K) incl Intel GPU for Host<br />AsRock Z77 Extreme4<br />8GB Ram</p><p>First thing I was trying was the old way, with pci-assign. I was able to first boot with VNC, installing ATI drivers. After reboot the screen woke up at login promt and the Perfomance was ok/good (I wasn&#039;t trying too much. Windows Performance Index at 7.5, so it should have worked <img src="https://bbs.archlinux.org/img/smilies/wink.png" width="15" height="15" alt="wink" />). But at reboot of VM the host crashed....</p><p>So I was looking around the internet and found this thread. Tried many hours to get it working, but I don&#039;t get any picture to the screen. No Seabios Texts and nothing in Windows after installing ATI drivers with vnc (and removing VNC again) like it was working with pci-assign.</p><p>Have tried Qemu-git from AUR, Qemu-1.5-rc1, seabios from your link, stock kernel (3.9.2-1) and kernel 3.10-rc1.<br />Did not change anything <img src="https://bbs.archlinux.org/img/smilies/wink.png" width="15" height="15" alt="wink" />.</p><p>The only thing I havn&#039;t tried till now is to dump the VGA bios and put it in. Will do this today, when I´m at home.</p><p>IOMMU is enabled. logfiles look good (for me <img src="https://bbs.archlinux.org/img/smilies/big_smile.png" width="15" height="15" alt="big_smile" />). The only thing is &quot;DMAR: No ATSR found&quot;. You have a Idea about this?<br />Full logfiles I can add later.&#160; </p><p>Bind everything to vfio-pci seems to work. Also there isn&#039;t any error message at KVM-Start<br />I also tried all with pci-stub entries at grub and without, same with the interrupt remapping entry.</p><p>Do you have any Idea? <img src="https://bbs.archlinux.org/img/smilies/big_smile.png" width="15" height="15" alt="big_smile" /></p><p>Thanks<br />apo</p></div></blockquote></div><p>Stock kernel wont work, you need to rebuild it to include:</p><div class="codebox"><pre><code> --- VFIO Non-Privileged userspace driver framework &lt;*&gt; VFIO support for PCI devices [*] VFIO PCI support for VGA devices </code></pre></div><p>Please use the linux-mainline, and qemu-git packages that i posted on &quot;RADEON RELATED PROBLEMS&quot;, it has this enabled by default.</p><p>If nothing appears on screen try:</p><div class="codebox"><pre><code>modprobe -r kvm_intel modprobe kvm_intel emulate_invalid_guest_state=0</code></pre></div><p>Also remember when launching qemu you must use q35 machine mode, vga none,&#160; and &quot;x-vga=on&quot; on your gpu</p><p>ex:</p><div class="codebox"><pre><code>qemu-system-x86_64 --enable-kvm -M q35 -vga none \ -device ioh3420,bus=pcie.0,addr=1c.0,multifunction=on,port=1,chassis=1,id=root.1 \ -device vfio-pci,host=07:00.0,bus=root.1,addr=00.0,multifunction=on,x-vga=on \ -device vfio-pci,host=07:00.1,bus=root.1,addr=00.1</code></pre></div> <p class="postedit"><em>Last edited by nbhs (2013-05-16 19:46:34)</em></p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1273852">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1273942" class="blockpost roweven"> <h2><span><span class="conr">#10</span> <a href="viewtopic.php?pid=1273942#p1273942">2013-05-16 21:35:47</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=71361">apoapo</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2013-05-16</span></dd> <dd><span>Posts: 15</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=71361">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <p>yeah. I forgot to say this.<br />I changed the configuration of the kernel <img src="https://bbs.archlinux.org/img/smilies/wink.png" width="15" height="15" alt="wink" />. I enabled the 4 vfio things in the kernels I used.<br />All things should be like you said. Also tried reloading kvm_intel module ...<br /> I will take a look in the next hours and post some Outputs and try the linux-mainline ....</p><p>Thx for helping <img src="https://bbs.archlinux.org/img/smilies/smile.png" width="15" height="15" alt="smile" /></p><p>EDIT: Some outputs <img src="https://bbs.archlinux.org/img/smilies/wink.png" width="15" height="15" alt="wink" /></p><div class="codebox"><pre><code>$ dmesg | grep -e DMAR -e IOMMU [ 0.000000] ACPI: DMAR 00000000bd969280 000B8 (v01 INTEL SNB 00000001 INTL 00000001) [ 0.000000] Intel-IOMMU: enabled [ 0.144709] dmar: IOMMU 0: reg_base_addr fed90000 ver 1:0 cap c0000020e60262 ecap f0101a [ 0.144714] dmar: IOMMU 1: reg_base_addr fed91000 ver 1:0 cap c9008020660262 ecap f0105a [ 0.144785] IOAPIC id 2 under DRHD base 0xfed91000 IOMMU 1 [ 0.404802] DMAR: No ATSR found [ 0.404822] IOMMU 0 0xfed90000: using Queued invalidation [ 0.404823] IOMMU 1 0xfed91000: using Queued invalidation [ 0.404824] IOMMU: Setting RMRR: [ 0.404832] IOMMU: Setting identity map for device 0000:00:02.0 [0xbf800000 - 0xcf9fffff] [ 0.405981] IOMMU: Setting identity map for device 0000:00:1d.0 [0xbd568000 - 0xbd59afff] [ 0.405997] IOMMU: Setting identity map for device 0000:00:1a.0 [0xbd568000 - 0xbd59afff] [ 0.406011] IOMMU: Setting identity map for device 0000:00:14.0 [0xbd568000 - 0xbd59afff] [ 0.406019] IOMMU: Prepare 0-16MiB unity mapping for LPC [ 0.406025] IOMMU: Setting identity map for device 0000:00:1f.0 [0x0 - 0xffffff]</code></pre></div><div class="codebox"><pre><code>ls -l /sys/bus/pci/drivers/vfio-pci/ insgesamt 0 lrwxrwxrwx 1 root root 0 17. Mai 00:53 0000:00:01.0 -&gt; ../../../../devices/pci0000:00/0000:00:01.0 lrwxrwxrwx 1 root root 0 17. Mai 00:53 0000:01:00.0 -&gt; ../../../../devices/pci0000:00/0000:00:01.0/0000:01:00.0 lrwxrwxrwx 1 root root 0 17. Mai 00:53 0000:01:00.1 -&gt; ../../../../devices/pci0000:00/0000:00:01.0/0000:01:00.1 --w------- 1 root root 4096 17. Mai 00:53 bind lrwxrwxrwx 1 root root 0 17. Mai 00:53 module -&gt; ../../../../module/vfio_pci --w------- 1 root root 4096 17. Mai 00:53 new_id --w------- 1 root root 4096 17. Mai 00:53 remove_id --w------- 1 root root 4096 17. Mai 00:48 uevent --w------- 1 root root 4096 17. Mai 00:53 unbind</code></pre></div><div class="codebox"><pre><code>lspci 00:01.0 PCI bridge: Intel Corporation Xeon E3-1200 v2/3rd Gen Core processor PCI Express Root Port (rev 09) 01:00.0 VGA compatible controller: Advanced Micro Devices [AMD] nee ATI Tahiti PRO [Radeon HD 7950] 01:00.1 Audio device: Advanced Micro Devices [AMD] nee ATI Tahiti XT HDMI Audio [Radeon HD 7970 Series]</code></pre></div><div class="codebox"><pre><code>Starting KVM: dmesg [ 511.383247] vfio_ecap_init: 0000:01:00.0 hiding ecap 0x19@0x270 [ 511.383256] vfio_ecap_init: 0000:01:00.0 hiding ecap 0x1b@0x2d0</code></pre></div><div class="codebox"><pre><code>qemu-system-x86_64 --enable-kvm -M q35 -m 2096 -cpu host \ -smp 4,sockets=1,cores=4,threads=1 \ -bios /usr/share/qemu/bios.bin -vga none \ -device ioh3420,bus=pcie.0,addr=1c.0,multifunction=on,port=1,chassis=1,id=root.1 \ -device vfio-pci,host=01:00.0,bus=root.1,addr=00.0,multifunction=on,x-vga=on \ -device vfio-pci,host=01:00.1,bus=root.1,addr=00.1</code></pre></div> <p class="postedit"><em>Last edited by apoapo (2013-05-16 22:59:45)</em></p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1273942">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1274006" class="blockpost rowodd"> <h2><span><span class="conr">#11</span> <a href="viewtopic.php?pid=1274006#p1274006">2013-05-17 00:32:44</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=71361">apoapo</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2013-05-16</span></dd> <dd><span>Posts: 15</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=71361">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <p>I finally got some progress.</p><p>After trying mainline kernel and with vbios, I went to bios/uefi and turned the Primary VGA card from onboard to pci-express ...<br />Now I see the seabios in passthroughed screen, but with blinking cursor in it, so i will try some things <img src="https://bbs.archlinux.org/img/smilies/smile.png" width="15" height="15" alt="smile" />.</p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1274006">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1274018" class="blockpost roweven"> <h2><span><span class="conr">#12</span> <a href="viewtopic.php?pid=1274018#p1274018">2013-05-17 00:57:17</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=70922">nbhs</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd class="postavatar"><img src="https://bbs.archlinux.org/img/avatars/70922.jpg?m=1367773811" width="80" height="80" alt="" /></dd> <dd><span>From: Montevideo, Uruguay</span></dd> <dd><span>Registered: 2013-05-02</span></dd> <dd><span>Posts: 402</span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>apoapo wrote:</cite><blockquote><div><p>I finally got some progress.</p><p>After trying mainline kernel and with vbios, I went to bios/uefi and turned the Primary VGA card from onboard to pci-express ...<br />Now I see the seabios in passthroughed screen, but with blinking cursor in it, so i will try some things <img src="https://bbs.archlinux.org/img/smilies/smile.png" width="15" height="15" alt="smile" />.</p></div></blockquote></div><p>NIce! have you tried running windows with it yet? does it work if you dont load the rom file by hand?</p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1274018">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1274026" class="blockpost rowodd"> <h2><span><span class="conr">#13</span> <a href="viewtopic.php?pid=1274026#p1274026">2013-05-17 01:45:06</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=71361">apoapo</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2013-05-16</span></dd> <dd><span>Posts: 15</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=71361">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>nbhs wrote:</cite><blockquote><div><div class="quotebox"><cite>apoapo wrote:</cite><blockquote><div><p>I finally got some progress.</p><p>After trying mainline kernel and with vbios, I went to bios/uefi and turned the Primary VGA card from onboard to pci-express ...<br />Now I see the seabios in passthroughed screen, but with blinking cursor in it, so i will try some things <img src="https://bbs.archlinux.org/img/smilies/smile.png" width="15" height="15" alt="smile" />.</p></div></blockquote></div><p>NIce! have you tried running windows with it yet? does it work if you dont load the rom file by hand?</p></div></blockquote></div><p>Hi,</p><p>I tried it again and I captured this error message if I use the PCI-e card es Primary Card:</p><div class="codebox"><pre><code>qemu-system-x86_64: -device vfio-pci,host=01:00.0,bus=root.1,addr=00.0,multifunction=on,x-vga=on: VFIO 0000:01:00.0 BAR 0 mmap unsupported. Performance may be slow</code></pre></div><p>This was, when I got some seabios picture.</p><p>After some reboots I wanted to try it again, I was spammed with errors <img src="https://bbs.archlinux.org/img/smilies/sad.png" width="15" height="15" alt="sad" />. Dont have them to show you now...&#160; will look for it.</p><br /><p>Now I&#039;m With the onboard as primary Card and I found this in dmesg:</p><div class="codebox"><pre class="vscroll"><code>[ 0.401391] DMAR: No ATSR found [ 0.401412] IOMMU 0 0xfed90000: using Queued invalidation [ 0.401413] IOMMU 1 0xfed91000: using Queued invalidation [ 0.401415] IOMMU: Setting RMRR: [ 0.401422] IOMMU: Setting identity map for device 0000:00:02.0 [0xbf800000 - 0xcf9fffff] [ 0.402590] IOMMU: Setting identity map for device 0000:00:1d.0 [0xbd568000 - 0xbd59afff] [ 0.402606] IOMMU: Setting identity map for device 0000:00:1a.0 [0xbd568000 - 0xbd59afff] [ 0.402619] IOMMU: Setting identity map for device 0000:00:14.0 [0xbd568000 - 0xbd59afff] [ 0.402628] IOMMU: Prepare 0-16MiB unity mapping for LPC [ 0.402635] IOMMU: Setting identity map for device 0000:00:1f.0 [0x0 - 0xffffff] [ 0.402717] PCI-DMA: Intel(R) Virtualization Technology for Directed I/O [ 0.402782] ------------[ cut here ]------------ [ 0.402786] WARNING: at drivers/pci/search.c:46 pci_find_upstream_pcie_bridge+0x83/0x90() [ 0.402787] Hardware name: To Be Filled By O.E.M. [ 0.402788] Modules linked in: [ 0.402790] Pid: 1, comm: swapper/0 Not tainted 3.9.2-1-mainline #1 [ 0.402791] Call Trace: [ 0.402796] [&lt;ffffffff81058090&gt;] warn_slowpath_common+0x70/0xa0 [ 0.402797] [&lt;ffffffff8105817a&gt;] warn_slowpath_null+0x1a/0x20 [ 0.402799] [&lt;ffffffff8129ea43&gt;] pci_find_upstream_pcie_bridge+0x83/0x90 [ 0.402802] [&lt;ffffffff813b3c7b&gt;] intel_iommu_add_device+0x4b/0x1f0 [ 0.402805] [&lt;ffffffff813ab630&gt;] ? bus_set_iommu+0x50/0x50 [ 0.402806] [&lt;ffffffff813ab65a&gt;] add_iommu_group+0x2a/0x50 [ 0.402809] [&lt;ffffffff8135bf63&gt;] bus_for_each_dev+0x63/0xa0 [ 0.402811] [&lt;ffffffff813ab622&gt;] bus_set_iommu+0x42/0x50 [ 0.402814] [&lt;ffffffff819130b6&gt;] intel_iommu_init+0xa83/0xb7b [ 0.402816] [&lt;ffffffff818dd10b&gt;] ? memblock_find_dma_reserve+0x124/0x124 [ 0.402818] [&lt;ffffffff818dd11d&gt;] pci_iommu_init+0x12/0x3c [ 0.402820] [&lt;ffffffff8100210a&gt;] do_one_initcall+0x10a/0x160 [ 0.402823] [&lt;ffffffff818d5037&gt;] kernel_init_freeable+0x15b/0x1dc [ 0.402824] [&lt;ffffffff818d4881&gt;] ? do_early_param+0x88/0x88 [ 0.402827] [&lt;ffffffff814b55f0&gt;] ? rest_init+0x90/0x90 [ 0.402828] [&lt;ffffffff814b55fe&gt;] kernel_init+0xe/0x190 [ 0.402830] [&lt;ffffffff814dad6c&gt;] ret_from_fork+0x7c/0xb0 [ 0.402832] [&lt;ffffffff814b55f0&gt;] ? rest_init+0x90/0x9</code></pre></div> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1274026">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1274031" class="blockpost roweven"> <h2><span><span class="conr">#14</span> <a href="viewtopic.php?pid=1274031#p1274031">2013-05-17 01:55:13</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=70922">nbhs</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd class="postavatar"><img src="https://bbs.archlinux.org/img/avatars/70922.jpg?m=1367773811" width="80" height="80" alt="" /></dd> <dd><span>From: Montevideo, Uruguay</span></dd> <dd><span>Registered: 2013-05-02</span></dd> <dd><span>Posts: 402</span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <p>Pease take a look at <a href="http://qemu.11.n7.nabble.com/VFIO-VGA-test-branches-td201483.html" rel="nofollow">http://qemu.11.n7.nabble.com/VFIO-VGA-t … 01483.html</a>, @Knut Omang this guy had it working using 2 discrete cards but he had to disable the integrated intel gpu</p> <p class="postedit"><em>Last edited by nbhs (2013-05-17 01:57:12)</em></p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1274031">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1274033" class="blockpost rowodd"> <h2><span><span class="conr">#15</span> <a href="viewtopic.php?pid=1274033#p1274033">2013-05-17 02:31:22</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=70922">nbhs</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd class="postavatar"><img src="https://bbs.archlinux.org/img/avatars/70922.jpg?m=1367773811" width="80" height="80" alt="" /></dd> <dd><span>From: Montevideo, Uruguay</span></dd> <dd><span>Registered: 2013-05-02</span></dd> <dd><span>Posts: 402</span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <p>You should set you primary boot device as IGP instead of pcie, vfio-vga wont work on you primary vga device.</p><div class="quotebox"><blockquote><div><p>lrwxrwxrwx 1 root root&#160; &#160; 0 17. Mai 00:53 0000:00:01.0 -&gt; ../../../../devices/pci0000:00/0000:00:01.0<br />lrwxrwxrwx 1 root root&#160; &#160; 0 17. Mai 00:53 0000:01:00.0 -&gt; ../../../../devices/pci0000:00/0000:00:01.0/0000:01:00.0<br />lrwxrwxrwx 1 root root&#160; &#160; 0 17. Mai 00:53 0000:01:00.1 -&gt; ../../../../devices/pci0000:00/0000:00:01.0/0000:01:00.1<br />--w------- 1 root root 4096 17. Mai 00:53 bind<br />lrwxrwxrwx 1 root root&#160; &#160; 0 17. Mai 00:53 module -&gt; ../../../../module/vfio_pci<br />--w------- 1 root root 4096 17. Mai 00:53 new_id<br />--w------- 1 root root 4096 17. Mai 00:53 remove_id<br />--w------- 1 root root 4096 17. Mai 00:48 uevent<br />--w------- 1 root root 4096 17. Mai 00:53 unbind</p></div></blockquote></div><p>Looking back at it, i dont think your pcie root port should be owned by vfio, here&#039;s mine:</p><div class="codebox"><pre><code>lrwxrwxrwx 1 root root 0 may 16 23:31 0000:07:00.0 -&gt; ../../../../devices/pci0000:00/0000:00:0b.0/0000:07:00.0 lrwxrwxrwx 1 root root 0 may 16 23:31 0000:07:00.1 -&gt; ../../../../devices/pci0000:00/0000:00:0b.0/0000:07:00.1 --w------- 1 root root 4096 may 16 23:31 bind lrwxrwxrwx 1 root root 0 may 16 23:31 module -&gt; ../../../../module/vfio_pci --w------- 1 root root 4096 may 16 16:58 new_id --w------- 1 root root 4096 may 16 23:31 remove_id --w------- 1 root root 4096 may 16 16:58 uevent --w------- 1 root root 4096 may 16 23:31 unbind</code></pre></div><p>Anyway you could try playing around with intel_iommu kernel options like intel_iommu=on,igfx_off,pass-through, if it doesnt work you should fill a bug report on qemu-devel</p> <p class="postedit"><em>Last edited by nbhs (2013-05-17 02:43:50)</em></p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1274033">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1274034" class="blockpost roweven"> <h2><span><span class="conr">#16</span> <a href="viewtopic.php?pid=1274034#p1274034">2013-05-17 02:38:56</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=71361">apoapo</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2013-05-16</span></dd> <dd><span>Posts: 15</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=71361">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <p>The Root-Port is in the same iommu-group with the graphicscard. I was wondering myself too</p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1274034">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1274035" class="blockpost rowodd"> <h2><span><span class="conr">#17</span> <a href="viewtopic.php?pid=1274035#p1274035">2013-05-17 02:45:21</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=70922">nbhs</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd class="postavatar"><img src="https://bbs.archlinux.org/img/avatars/70922.jpg?m=1367773811" width="80" height="80" alt="" /></dd> <dd><span>From: Montevideo, Uruguay</span></dd> <dd><span>Registered: 2013-05-02</span></dd> <dd><span>Posts: 402</span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <p>Have you tried setting intel_iommu=on,igfx_off or&#160; &#160;intel_iommu=on,igfx_on with igd as primary?</p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1274035">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1274041" class="blockpost roweven"> <h2><span><span class="conr">#18</span> <a href="viewtopic.php?pid=1274041#p1274041">2013-05-17 03:05:29</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=71361">apoapo</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2013-05-16</span></dd> <dd><span>Posts: 15</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=71361">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>nbhs wrote:</cite><blockquote><div><p>Have you tried setting intel_iommu=on,igfx_off or&#160; &#160;intel_iommu=on,igfx_on with igd as primary?</p></div></blockquote></div><p>No change till now. <br />Will go to sleep now... its 5:00 in the morning here <img src="https://bbs.archlinux.org/img/smilies/big_smile.png" width="15" height="15" alt="big_smile" /></p><p>Thx for your help <img src="https://bbs.archlinux.org/img/smilies/smile.png" width="15" height="15" alt="smile" />. Will follow the conversation you linked me + try again with a second graphic card.<br />You will hear from me <img src="https://bbs.archlinux.org/img/smilies/wink.png" width="15" height="15" alt="wink" /></p><br /><p>PS:<br />some logoutput I don&#039;t have all the time at starting kvm (with intel GPU as primary):</p><div class="codebox"><pre><code>[ 109.801109] vfio-pci 0000:01:00.0: enabling device (0000 -&gt; 0003) [ 109.827474] vfio_ecap_init: 0000:01:00.0 hiding ecap 0x19@0x270 [ 109.827481] vfio_ecap_init: 0000:01:00.0 hiding ecap 0x1b@0x2d0 [ 110.087849] vfio-pci 0000:01:00.1: enabling device (0000 -&gt; 0002)</code></pre></div> <p class="postedit"><em>Last edited by apoapo (2013-05-31 13:27:14)</em></p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1274041">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1274066" class="blockpost rowodd"> <h2><span><span class="conr">#19</span> <a href="viewtopic.php?pid=1274066#p1274066">2013-05-17 04:43:26</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=47675">jgott</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2011-04-10</span></dd> <dd><span>Posts: 21</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=47675">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>nbhs wrote:</cite><blockquote><div><p>Could you try to load your gpu bios by file and see if it still crash? i remember a couple of times my vm crashed after a reset ( before i accidentally physically destroyed the bios chip <img src="https://bbs.archlinux.org/img/smilies/lol.png" width="15" height="15" alt="lol" />, now it wont work without loading a rom file <img src="https://bbs.archlinux.org/img/smilies/smile.png" width="15" height="15" alt="smile" /> ) and after i manually loaded the rom, didnt happen again, you can do this by appending &#039;,rombar=0, romfile=/path/to/the/rom.bin&#039;</p></div></blockquote></div><p>I finally had time to give this a try, and it doesn&#039;t seem to make a difference. The VM works fine the first time, but the second time, the host freezes up as the guest boots. I tried a ROM image obtained via sysfs and one from techpowerup.com (different version for the same card); no visible difference.</p><p>What I may try next is swapping the cards. This isn&#039;t the configuration I&#039;ll want to use in the long term, but it will be interesting to see if the 5750 behaves any differently from the 7870 when passed through.</p><p>Incidentally, secondary passthrough (-vga cirrus or -vga std) doesn&#039;t cause any additional problems, which is nice, although it doesn&#039;t fix anything either.</p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1274066">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1274075" class="blockpost roweven"> <h2><span><span class="conr">#20</span> <a href="viewtopic.php?pid=1274075#p1274075">2013-05-17 06:14:26</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=47675">jgott</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2011-04-10</span></dd> <dd><span>Posts: 21</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=47675">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>jgott wrote:</cite><blockquote><div><p>What I may try next is swapping the cards. This isn&#039;t the configuration I&#039;ll want to use in the long term, but it will be interesting to see if the 5750 behaves any differently from the 7870 when passed through.</p></div></blockquote></div><p>So I just gave this a try: 7870 as primary, 5750 as passthru. Started out without the ROM override. First boot, the guest works great. Second boot, the VM won&#039;t start, but I get this line in dmesg:</p><div class="codebox"><pre><code>vfio-pci 0000:02:00.0: Invalid ROM contents</code></pre></div><p>This didn&#039;t happen previously. Overriding the ROM on the second boot seems to get past this problem, but then the host freezes up, just like before.</p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1274075">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1274076" class="blockpost rowodd"> <h2><span><span class="conr">#21</span> <a href="viewtopic.php?pid=1274076#p1274076">2013-05-17 06:18:30</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=70922">nbhs</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd class="postavatar"><img src="https://bbs.archlinux.org/img/avatars/70922.jpg?m=1367773811" width="80" height="80" alt="" /></dd> <dd><span>From: Montevideo, Uruguay</span></dd> <dd><span>Registered: 2013-05-02</span></dd> <dd><span>Posts: 402</span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <p>Have you tried the &quot;eject&quot; method yet?</p><p>I&#039;m still wondering why my particular card doesnt have this issue, i used to get performance degradation without reset patches but my host never crashed.</p><p>Are you sure the kernel and qemu are patched?</p> <p class="postedit"><em>Last edited by nbhs (2013-05-17 06:24:34)</em></p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1274076">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1274078" class="blockpost roweven"> <h2><span><span class="conr">#22</span> <a href="viewtopic.php?pid=1274078#p1274078">2013-05-17 06:30:57</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=47675">jgott</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2011-04-10</span></dd> <dd><span>Posts: 21</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=47675">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>nbhs wrote:</cite><blockquote><div><p>Have you tried the &quot;eject&quot; method yet?</p><p>I&#039;m still wondering why my particular card doesnt have this issue, i used to get performance degradation without reset patches but my host never crashed.</p></div></blockquote></div><p>That&#039;s on my list of things to do, but first I&#039;m going to reply to the qemu-devel mailing list.</p><p>I want to figure out why the pci reset from software isn&#039;t happening (presumably it is not happening, since suspending the host makes everything work properly). I don&#039;t know if it&#039;s possible to divine from the DEBUG_VFIO output why the reset attempt failed, or if the hardware is just silently ignoring the request.</p><div class="quotebox"><cite>nbhs wrote:</cite><blockquote><div><p>Are you sure the kernel and qemu are patched?</p></div></blockquote></div><p>Yes.</p> <p class="postedit"><em>Last edited by jgott (2013-05-17 06:31:22)</em></p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1274078">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1274086" class="blockpost rowodd"> <h2><span><span class="conr">#23</span> <a href="viewtopic.php?pid=1274086#p1274086">2013-05-17 06:53:45</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=47675">jgott</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2011-04-10</span></dd> <dd><span>Posts: 21</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=47675">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <p>Oops. It seems that I forgot to change the pci-stub vendor and device IDs when I swapped cards. X wasn&#039;t running, but the radeon module might have been loaded. So maybe the card-swapping results were invalid. I don&#039;t want to switch everything over again though, what a pain. <img src="https://bbs.archlinux.org/img/smilies/mad.png" width="15" height="15" alt="mad" /></p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1274086">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1274378" class="blockpost roweven"> <h2><span><span class="conr">#24</span> <a href="viewtopic.php?pid=1274378#p1274378">2013-05-17 21:18:58</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=71361">apoapo</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2013-05-16</span></dd> <dd><span>Posts: 15</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=71361">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <p>I put in a second graphicscard and tested it again.<br />The good thing is. I had no problems to pass it to the VM... have seen the bios of the Card + seabios on the screen + Windows was booting (was booting to system repair, but I think that&#039;s because of other storage type)</p><p>The bad thing is, that both graphicscards are in the same iommu-group + 2 PCI-Controller 01.0 and 01.1. Think that is because my 2 PCIe Ports share share the 16 lanes, that are normally used by the first port.<br />So I think I will be abled to pass the card to the VM, but can&#039;t really use the primary card for Linux and I have to wait to get the Intel as Primary working ...</p><p>Any other thoughts about this?</p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1274378">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1274396" class="blockpost rowodd"> <h2><span><span class="conr">#25</span> <a href="viewtopic.php?pid=1274396#p1274396">2013-05-17 21:49:15</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=70922">nbhs</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd class="postavatar"><img src="https://bbs.archlinux.org/img/avatars/70922.jpg?m=1367773811" width="80" height="80" alt="" /></dd> <dd><span>From: Montevideo, Uruguay</span></dd> <dd><span>Registered: 2013-05-02</span></dd> <dd><span>Posts: 402</span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>apoapo wrote:</cite><blockquote><div><p>I put in a second graphicscard and tested it again.<br />The good thing is. I had no problems to pass it to the VM... have seen the bios of the Card + seabios on the screen + Windows was booting (was booting to system repair, but I think that&#039;s because of other storage type)</p><p>The bad thing is, that both graphicscards are in the same iommu-group + 2 PCI-Controller 01.0 and 01.1. Think that is because my 2 PCIe Ports share share the 16 lanes, that are normally used by the first port.<br />So I think I will be abled to pass the card to the VM, but can&#039;t really use the primary card for Linux and I have to wait to get the Intel as Primary working ...</p><p>Any other thoughts about this?</p></div></blockquote></div><p>Unfortunately, no, your best bet at this point is fill a bug @ qemu-devel, if you&#039;re using my script to bind the devices, you could try doing it manually, only binding the gpu and the gpu_snd, but i dont think vfio will work if all the devices of the same group are not binded to it.</p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1274396">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div class="postlinksb"> <div class="inbox crumbsplus"> <div class="pagepost"> <p class="pagelink conl"><span class="pages-label">Pages: </span><strong class="item1">1</strong> <a href="viewtopic.php?id=162768&amp;p=2">2</a> <a href="viewtopic.php?id=162768&amp;p=3">3</a> <span class="spacer">…</span> <a href="viewtopic.php?id=162768&amp;p=234">234</a> <a rel="next" href="viewtopic.php?id=162768&amp;p=2">Next</a></p> <p class="postlink conr">Topic closed</p> </div> <ul class="crumbs"> <li><a href="index.php">Index</a></li> <li><span>»&#160;</span><a href="viewforum.php?id=48">Topics Going Nowhere</a></li> <li><span>»&#160;</span><strong><a href="viewtopic.php?id=162768">KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</a></strong></li> </ul> <p class="subscribelink clearb"><a href="misc.php?action=subscribe&amp;tid=162768">Subscribe to this topic</a></p> <div class="clearer"></div> </div> </div> </div> <div id="brdfooter" class="block"> <h2><span>Board footer</span></h2> <div class="box"> <div id="brdfooternav" class="inbox"> <div class="conl"> <form id="qjump" method="get" action="viewforum.php"> <div><label><span>Jump to<br /></span> <select name="id" onchange="window.location=('viewforum.php?id='+this.options[this.selectedIndex].value)"> <optgroup label="Technical Issues and Assistance"> <option value="23">Newbie Corner</option> <option value="17">Installation</option> <option value="22">Kernel &amp; Hardware</option> <option value="18">Applications &amp; Desktop Environments</option> <option value="31">Laptop Issues</option> <option value="8">Networking, Server, and Protection</option> <option value="32">Multimedia and Games</option> <option value="50">System Administration</option> <option value="35">Other Architectures</option> </optgroup> <optgroup label="Arch-centric"> <option value="24">Announcements, Package &amp; Security Advisories</option> <option value="1">Arch Discussion</option> <option value="13">Forum &amp; Wiki discussion</option> </optgroup> <optgroup label="Pacman Upgrades, Packaging &amp; AUR"> <option value="44">Pacman &amp; Package Upgrade Issues</option> <option value="49">[testing] Repo Forum</option> <option value="4">Creating &amp; Modifying Packages</option> <option value="38">AUR Issues, Discussion &amp; PKGBUILD Requests</option> </optgroup> <optgroup label="Contributions &amp; Discussion"> <option value="20">GNU/Linux Discussion</option> <option value="27">Community Contributions</option> <option value="33">Programming &amp; Scripting</option> <option value="30">Other Languages</option> <option value="47">Artwork and Screenshots</option> <option value="42">Try This</option> </optgroup> <optgroup label="/dev/null"> <option value="29">Off-Topic</option> <option value="48" selected="selected">Topics Going Nowhere</option> <option value="36">Dustbin</option> </optgroup> </select></label> <input type="submit" value=" Go " accesskey="g" /> </div> </form> </div> <div class="conr"> <p id="feedlinks"><span class="atom"><a href="extern.php?action=feed&amp;tid=162768&amp;type=atom">Atom topic feed</a></span></p> <p id="poweredby">Powered by <a href="http://fluxbb.org/">FluxBB</a></p> </div> <div class="clearer"></div> </div> </div> </div> </div> <div class="end-box"></div> </div> </body> </html>
