<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"> <html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en" dir="ltr"> <head> <meta http-equiv="Content-Type" content="text/html; charset=utf-8" /> <title>KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9 (Page 97) / Topics Going Nowhere / Arch Linux Forums</title> <link rel="stylesheet" type="text/css" href="style/ArchLinux.css" /> <link rel="canonical" href="viewtopic.php?id=162768&amp;p=97" title="Page 97" /> <link rel="prev" href="viewtopic.php?id=162768&amp;p=96" title="Page 96" /> <link rel="next" href="viewtopic.php?id=162768&amp;p=98" title="Page 98" /> <link rel="alternate" type="application/atom+xml" href="extern.php?action=feed&amp;tid=162768&amp;type=atom" title="Atom topic feed" /> <link rel="stylesheet" media="screen" href="style/ArchLinux/arch.css?v=3" /> <link rel="stylesheet" media="screen" href="style/ArchLinux/archnavbar.css?v=2" /> <link rel="shortcut icon" href="style/ArchLinux/favicon.ico" /> </head> <body> <div id="archnavbar" class="anb-forum"> <div id="archnavbarlogo"><h1><a href="http://www.archlinux.org/">Arch Linux</a></h1></div> <div id="archnavbarmenu"> <ul id="archnavbarlist"> <li id="anb-home"><a href="http://www.archlinux.org/">Home</a></li><li id="anb-packages"><a href="http://www.archlinux.org/packages/">Packages</a></li><li id="anb-forums" class="anb-selected"><a href="https://bbs.archlinux.org/">Forums</a></li><li id="anb-wiki"><a href="https://wiki.archlinux.org/">Wiki</a></li><li id="anb-bugs"><a href="https://bugs.archlinux.org/">Bugs</a></li><li id="anb-aur"><a href="https://aur.archlinux.org/">AUR</a></li><li id="anb-download"><a href="http://www.archlinux.org/download/">Download</a></li> </ul> </div> </div> <div id="punviewtopic" class="pun"> <div class="top-box"></div> <div class="punwrap"> <div id="brdheader" class="block"> <div class="box"> <div id="brdmenu" class="inbox"> <ul> <li id="navindex" class="isactive"><a href="index.php">Index</a></li> <li id="navuserlist"><a href="userlist.php">User list</a></li> <li id="navsearch"><a href="search.php">Search</a></li> <li id="navprofile"><a href="profile.php?id=80749">Profile</a></li> <li id="navlogout"><a href="login.php?action=out&amp;id=80749&amp;csrf_token=5c20501ec397bb45ef8ee8c84db232c8d8e421c6">Logout</a></li> </ul> </div> <div id="brdwelcome" class="inbox"> <ul class="conl"> <li><span>Logged in as <strong>SXX</strong></span></li> <li><span>Last visit: 2015-08-16 12:20:09</span></li> </ul> <ul class="conr"> <li><span>Topics: <a href="search.php?action=show_replies" title="Find topics you have posted to.">Posted</a> | <a href="search.php?action=show_new" title="Find topics with new posts since your last visit.">New</a> | <a href="search.php?action=show_recent" title="Find topics with recent posts.">Active</a> | <a href="search.php?action=show_unanswered" title="Find topics with no replies.">Unanswered</a></span></li> </ul> <div class="clearer"></div> </div> </div> </div> <div id="brdmain"> <div class="linkst"> <div class="inbox crumbsplus"> <ul class="crumbs"> <li><a href="index.php">Index</a></li> <li><span>»&#160;</span><a href="viewforum.php?id=48">Topics Going Nowhere</a></li> <li><span>»&#160;</span><strong><a href="viewtopic.php?id=162768">KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</a></strong></li> </ul> <div class="pagepost"> <p class="pagelink conl"><span class="pages-label">Pages: </span><a rel="prev" class="item1" href="viewtopic.php?id=162768&amp;p=96">Previous</a> <a href="viewtopic.php?id=162768">1</a> <span class="spacer">…</span> <a href="viewtopic.php?id=162768&amp;p=95">95</a> <a href="viewtopic.php?id=162768&amp;p=96">96</a> <strong>97</strong> <a href="viewtopic.php?id=162768&amp;p=98">98</a> <a href="viewtopic.php?id=162768&amp;p=99">99</a> <span class="spacer">…</span> <a href="viewtopic.php?id=162768&amp;p=234">234</a> <a rel="next" href="viewtopic.php?id=162768&amp;p=98">Next</a></p> <p class="postlink conr">Topic closed</p> </div> <div class="clearer"></div> </div> </div> <div id="p1441040" class="blockpost rowodd blockpost1"> <h2><span><span class="conr">#2401</span> <a href="viewtopic.php?pid=1441040#p1441040">2014-07-29 03:34:55</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=82442">slis</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2014-06-02</span></dd> <dd><span>Posts: 125</span></dd> <dd class="usercontacts"><span class="email"><a href="mailto:xslisx@gmail.com">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>mv0lnicky wrote:</cite><blockquote><div><p>If you are dual booting Windows, just use GPU-Z to dump your GPU BIOS into a file. Then you&#039;ll have VGA reset from QEMU.</p></div></blockquote></div><p>you can dump it aslo from virtual machine <img src="https://bbs.archlinux.org/img/smilies/wink.png" width="15" height="15" alt="wink" /> (sometimes it doesn&#039;t work at first but it does after couple of tries/gpu-z versions...)</p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1441040">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1441070" class="blockpost roweven"> <h2><span><span class="conr">#2402</span> <a href="viewtopic.php?pid=1441070#p1441070">2014-07-29 07:59:54</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=77628">mbirkis</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2013-12-12</span></dd> <dd><span>Posts: 13</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=77628">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <p>Is there still an issue with the nouveau driver on the host, i am currently runnin the patched nvidia driver but i would like to switch for the open source one on my host.</p><p>Anyone running nouveau on host?</p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1441070">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1441082" class="blockpost rowodd"> <h2><span><span class="conr">#2403</span> <a href="viewtopic.php?pid=1441082#p1441082">2014-07-29 09:08:03</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=83924">Chousuke</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2014-07-29</span></dd> <dd><span>Posts: 2</span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <p>I&#039;d like to chime in here with a success report. I&#039;m not an archlinux user, but I have my Radeon R9 270 successfully passed through to a kvm Windows 7 guest on Fedora 20.</p><p>The thing is, I have no idea what actually made it work. I tried all sorts of things, but in the end I reinstalled and created the virtual machine purely with virt-manager (from Fedora virt-preview repos) and just selected the GPU (only) as pass-through from the GUI. My version of virt-manager seems to use vfio by default. I did have to manually modprobe vfio-pci etc. though, and of course ensure that the radeon driver wasn&#039;t being used... X runs using the IGP and I see no graphics corruption or other issues even after repeated reboots of the VM. 3d acceleration also seems to work on the host.</p><p>I have an emulated Cirrus VGA chip on the VM too, but it stops working as soon as the guest boots up properly. I used it to install the Catalyst drivers (for some reason, with QXL the installer crashed)</p><p>The full virt-manager XML is here:<br /><a href="http://pastebin.com/ZX0Kfex5" rel="nofollow">http://pastebin.com/ZX0Kfex5</a></p><br /><p>My software versions are as follows:</p><p>- Kernel 3.15.6-200.fc20.x86_64 custom built with vga arbitration patches (81b5c7bc8de3e6f63419139c2fc91bf81dea8a7d, 6e1b4fdad5157bb9e88777d525704aba24389bee) though I am not sure if they&#039;re actually needed... I see no indication of it. Maybe because I do EFI boot?<br />- virt-manager 1.0.1<br />- qemu 2.0.93</p><p>and hardware:<br />Intel(R) Core(TM) i5-4670 CPU @ 3.40GHz<br />AMD Radeon R9 270<br />ASUS H87 Pro</p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1441082">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1441130" class="blockpost roweven"> <h2><span><span class="conr">#2404</span> <a href="viewtopic.php?pid=1441130#p1441130">2014-07-29 12:40:48</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=80387">dwe11er</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2014-03-18</span></dd> <dd><span>Posts: 73</span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>Chousuke wrote:</cite><blockquote><div><p>I&#039;d like to chime in here with a success report. I&#039;m not an archlinux user, but I have my Radeon R9 270 successfully passed through to a kvm Windows 7 guest on Fedora 20.</p><p>The thing is, I have no idea what actually made it work. I tried all sorts of things, but in the end I reinstalled and created the virtual machine purely with virt-manager (from Fedora virt-preview repos) and just selected the GPU (only) as pass-through from the GUI. My version of virt-manager seems to use vfio by default. I did have to manually modprobe vfio-pci etc. though, and of course ensure that the radeon driver wasn&#039;t being used... X runs using the IGP and I see no graphics corruption or other issues even after repeated reboots of the VM. 3d acceleration also seems to work on the host.</p><p>I have an emulated Cirrus VGA chip on the VM too, but it stops working as soon as the guest boots up properly. I used it to install the Catalyst drivers (for some reason, with QXL the installer crashed)</p><p>The full virt-manager XML is here:<br /><a href="http://pastebin.com/ZX0Kfex5" rel="nofollow">http://pastebin.com/ZX0Kfex5</a></p><br /><p>My software versions are as follows:</p><p>- Kernel 3.15.6-200.fc20.x86_64 custom built with vga arbitration patches (81b5c7bc8de3e6f63419139c2fc91bf81dea8a7d, 6e1b4fdad5157bb9e88777d525704aba24389bee) though I am not sure if they&#039;re actually needed... I see no indication of it. Maybe because I do EFI boot?<br />- virt-manager 1.0.1<br />- qemu 2.0.93</p><p>and hardware:<br />Intel(R) Core(TM) i5-4670 CPU @ 3.40GHz<br />AMD Radeon R9 270<br />ASUS H87 Pro</p></div></blockquote></div><p>It&#039;s because you&#039;re not using vfio-pci, but normal pci-assign.</p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1441130">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1441143" class="blockpost rowodd"> <h2><span><span class="conr">#2405</span> <a href="viewtopic.php?pid=1441143#p1441143">2014-07-29 13:30:17</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=83924">Chousuke</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2014-07-29</span></dd> <dd><span>Posts: 2</span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>dwe11er wrote:</cite><blockquote><div><p>It&#039;s because you&#039;re not using vfio-pci, but normal pci-assign.</p></div></blockquote></div><p>I am quite sure I&#039;m using vfio, since the guest refuses to start without the vfio modules loaded:</p><div class="codebox"><pre><code>Error starting domain: internal error: process exited while connecting to monitor: pulseaudio: pa_context_connect() failed pulseaudio: Reason: Connection refused pulseaudio: Failed to initialize PA contextaudio: Could not init `pa&#039; audio driver 2014-07-29T13:28:42.126919Z qemu-system-x86_64: -device vfio-pci,host=01:00.0,id=hostdev0,bus=pci.0,addr=0x9,rombar=0: vfio: No available IOMMU models 2014-07-29T13:28:42.126941Z qemu-system-x86_64: -device vfio-pci,host=01:00.0,id=hostdev0,bus=pci.0,addr=0x9,rombar=0: vfio: failed to setup container for group 1 2014-07-29T13:28:42.126951Z qemu-system-x86_64: -device vfio-pci,host=01:00.0,id=hostdev0,bus=pci.0,addr=0x9,rombar=0: vfio: failed to get group 1 2014-07-29T13:28:42.126963Z qemu-system-x86_64: -device vfio-pci,host=01:00.0,id=hostdev0,bus=pci.0,addr=0x9,rombar=0: Device initialization failed. 2014-07-29T13:28:42.126975Z qemu-system-x86_64: -device vfio-pci,host=01:00.0,id=hostdev0,bus=pci.0,addr=0x9,rombar=0: Device &#039;vfio-pci&#039; could not be initialized</code></pre></div><p>EDIT: Curiously enough, this setup also works just fine with a completely unmodified 3.15.4-200.fc20.x86_64 Fedora kernel.<br />EDIT2: It is entirely possible that the virt-manager and qemu packages I am using have some special modifications which enable this to function. I just now discovered that the qemu binary seems to lie about its version... the package I have installed comes from the fedora-virt-preview repository and yum tells me its version is:</p><div class="codebox"><pre><code>Version : 2.1.0 Release : 0.5.rc3.fc20</code></pre></div> <p class="postedit"><em>Last edited by Chousuke (2014-07-29 13:46:05)</em></p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1441143">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1441730" class="blockpost roweven"> <h2><span><span class="conr">#2406</span> <a href="viewtopic.php?pid=1441730#p1441730">2014-07-30 17:22:48</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=83975">chillum</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2014-07-30</span></dd> <dd><span>Posts: 4</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=83975">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <p>what do I do if I have exactly the same times 2 wireless keyboard/ mouse; ID bit is the same </p><p>...<br />Bus 002 Device 006: ID 1a81:1006 Holtek Semiconductor, Inc. <br />...<br />Bus 011 Device 004: ID 1a81:1006 Holtek Semiconductor, Inc. <br />...<br />how do I tell KVM/windows which one to passthrough?</p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1441730">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1441733" class="blockpost rowodd"> <h2><span><span class="conr">#2407</span> <a href="viewtopic.php?pid=1441733#p1441733">2014-07-30 17:26:38</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=83975">chillum</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2014-07-30</span></dd> <dd><span>Posts: 4</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=83975">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <p>I know</p><p>-usbdevice host:1a81:1006</p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1441733">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1441750" class="blockpost roweven"> <h2><span><span class="conr">#2408</span> <a href="viewtopic.php?pid=1441750#p1441750">2014-07-30 18:14:40</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=8272">vogets</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2006-11-25</span></dd> <dd><span>Posts: 31</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=8272">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>mbirkis wrote:</cite><blockquote><div><p>Anyone running nouveau on host?</p></div></blockquote></div><p>A 9500 GT with nouveau runs smoothly for me. Unpatched.</p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1441750">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1442021" class="blockpost rowodd"> <h2><span><span class="conr">#2409</span> <a href="viewtopic.php?pid=1442021#p1442021">2014-07-31 10:12:32</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=79909">CharlieBra7o</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2014-03-01</span></dd> <dd><span>Posts: 20</span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>dwe11er wrote:</cite><blockquote><div><div class="quotebox"><cite>CharlieBra7o wrote:</cite><blockquote><div><div class="quotebox"><cite>CharlieBra7o wrote:</cite><blockquote><div><p>After I booted up my freshly installed Windows 8.1 for the first time it worked for about 60 seconds or so, then the monitor lost its signal. From this moment on the monitor always loses its signal during the Windows loading screen. The VM&#039;s CPU load from this moment on seems to be completely steady using up 1 full thread.</p><p>My guess is that Windows tried to install some crappy GPU/chipset drivers or apply some wrong settings...</p><p>Does anyone have an idea what might be going on there?</p><br /><p>Additional info:<br />- Radeon HD 7950<br />- 3.15.6 from the OP unchanged<br />- qemu-git 2.1.r34391.gf368c33-1 + libvirt 1.2.6-1 from GIT</p></div></blockquote></div><p>Just tried installing Windows 7 and after the installation I spent about 5 minutes clicking around, then shutdown the VM to make an image and started it up again. Now it always freezes during the &quot;Starting Windows&quot; screen and &#039;virsh list&#039; lists the VM as &#039;paused&#039;.<br />dmesg doesn&#039;t show anything peculiar, except maybe</p><div class="codebox"><pre><code>kvm: zapping shadow pages for mmio generation wraparound</code></pre></div><p>Honestly, I have absolutely no clue what to try next...</p></div></blockquote></div><p>virsh tells you the reason, why vm was paused. I had similar issue (I/O Error), because of vm&#039;s disks being raw file images on btrfs (and having really low performance).</p></div></blockquote></div><p>Could you please tell me where it states the reason and how you fixed your problem?<br />That&#039;s my disk...</p><div class="codebox"><pre><code>Device Start End Size Type ... /dev/sda7 167774208 330248191 77.5G Linux filesystem</code></pre></div><p>It worked perfectly fine with Win 8.1 without GPU passthrough and the first time I booted Win7 with GPU passthrough</p><div class="codebox"><pre><code> &lt;disk type=&#039;block&#039; device=&#039;disk&#039;&gt; &lt;driver name=&#039;qemu&#039; type=&#039;raw&#039; cache=&#039;none&#039; io=&#039;native&#039;/&gt; &lt;source dev=&#039;/dev/disk/by-partuuid/771af6c5-d5db-421d-9f67-8070092961bf&#039;/&gt; &lt;target dev=&#039;vda&#039; bus=&#039;virtio&#039;/&gt; &lt;address type=&#039;pci&#039; domain=&#039;0x0000&#039; bus=&#039;0x02&#039; slot=&#039;0x04&#039; function=&#039;0x0&#039;/&gt; &lt;/disk&gt;</code></pre></div><p>EDIT:<br />I just stumbled upon this post:</p><div class="quotebox"><cite>aw wrote:</cite><blockquote><div><div class="quotebox"><cite>andy123 wrote:</cite><blockquote><div><p>peaquino, your errors seem to be occuring on 01:00.1 not 01:00.0, which is your audio card.</p><div class="codebox"><pre><code>[ 2248.441807] AMD-Vi: Event logged [IO_PAGE_FAULT device=01:00.1 domain=0x0002 address=0x00000000857fc800 flags=0x0010] 01:00.1 Audio device: Advanced Micro Devices, Inc. [AMD/ATI] Tahiti XT HDMI Audio [Radeon HD 7970 Series]</code></pre></div><p>is there are reason why you aren&#039;t assigning it? (like so)</p><div class="codebox"><pre><code>-device vfio-pci,host=01:00.0,bus=root.1,addr=0.0,multifunction=on,x-vga=on,romfile=/home/myuser/Tahiti.rom \ -device vfio-pci,host=01:00.1,bus=root.1,addr=0.1 \</code></pre></div></div></blockquote></div><p>Numerous folks have reported BSODs which were solved by moving the audio device to the root complex rather than exposing it as a sub-function.&#160; It may work, but exposing it on pcie.0 has had more success it seems.</p></div></blockquote></div><p>So what I did is just remove the Radeon HD audio device qemu command line and now Win 7 seems so be content...</p> <p class="postedit"><em>Last edited by CharlieBra7o (2014-08-01 23:45:11)</em></p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1442021">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1442669" class="blockpost roweven"> <h2><span><span class="conr">#2410</span> <a href="viewtopic.php?pid=1442669#p1442669">2014-08-01 21:23:37</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=82117">devianceluka</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2014-05-19</span></dd> <dd><span>Posts: 43</span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <p>VFIO passthrough works flawlessly on Ubuntu 14.04 with no patches just yet but I have a few questions if someone could please help.</p><p>1) How to shutdown/forceshutdown/kill the VM started with qemu over SSH?</p><p>2) What are the parameters to make VM connect to the physical network (to eth0 on host)?</p><p>3) Is it possible to see &quot;display output&quot; over SSH? The host is a minimal virtual machine host with only CLI and no GUI.</p><p>4) Whats the best way to autostart 3 VMs with host, ofcourse each with its own vfio/config?</p><p>Thanks!</p> <p class="postedit"><em>Last edited by devianceluka (2014-08-01 21:35:23)</em></p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1442669">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1442708" class="blockpost rowodd"> <h2><span><span class="conr">#2411</span> <a href="viewtopic.php?pid=1442708#p1442708">2014-08-01 22:22:12</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=59241">tritron4</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2012-04-14</span></dd> <dd><span>Posts: 146</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=59241">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <p>Did anyone managed to run osx? is kvm better than xen ?</p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1442708">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1442712" class="blockpost roweven"> <h2><span><span class="conr">#2412</span> <a href="viewtopic.php?pid=1442712#p1442712">2014-08-01 22:28:32</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=83182">kristopher004</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2014-06-30</span></dd> <dd><span>Posts: 31</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=83182">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <p>osx works great, virtio network drivers crash though, better off with e1000, have to put it on high pcie bus addr though or osx won&#039;t see it.</p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1442712">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1442918" class="blockpost rowodd"> <h2><span><span class="conr">#2413</span> <a href="viewtopic.php?pid=1442918#p1442918">2014-08-02 14:39:56</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=82784">penetal</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2014-06-15</span></dd> <dd><span>Posts: 10</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=82784">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <p>I can not seem to get audio working right. No matter what I do I end up with crackling sound.<br />If I set QEMU_PA_SAMPLES to 128 its way way worse.<br />This affects all sound, not just the VM. If I have something playing on the host once I start the VM the sound gets all fucky.</p><p>I have no idea if it could possibly help, but here is the pulseauido output for when I start the VM, and then kill it almost right away (made sure the sound playing on the host had gone bad before I stopped it.</p><div class="codebox"><pre class="vscroll"><code>I: [pulseaudio] client.c: Created 3 &quot;Native client (UNIX socket client)&quot; I: [pulseaudio] protocol-native.c: Client authenticated anonymously. I: [pulseaudio] module-stream-restore.c: Restoring volume for sink input sink-input-by-application-name:/run/user/1000/pulse/native. I: [pulseaudio] module-stream-restore.c: Restoring mute state for sink input sink-input-by-application-name:/run/user/1000/pulse/native. I: [pulseaudio] sink-input.c: Created input 3 &quot;qemu&quot; on alsa_output.pci-0000_00_1b.0.analog-stereo with sample spec s16le 2ch 44100Hz and channel map front-left,front-right I: [pulseaudio] sink-input.c: media.name = &quot;qemu&quot; I: [pulseaudio] sink-input.c: application.name = &quot;/run/user/1000/pulse/native&quot; I: [pulseaudio] sink-input.c: native-protocol.peer = &quot;UNIX socket client&quot; I: [pulseaudio] sink-input.c: native-protocol.version = &quot;29&quot; I: [pulseaudio] sink-input.c: application.process.id = &quot;7409&quot; I: [pulseaudio] sink-input.c: application.process.user = &quot;root&quot; I: [pulseaudio] sink-input.c: application.process.host = &quot;ArcherBase&quot; I: [pulseaudio] sink-input.c: application.process.binary = &quot;qemu-system-x86_64&quot; I: [pulseaudio] sink-input.c: application.language = &quot;C&quot; I: [pulseaudio] sink-input.c: window.x11.display = &quot;:0&quot; I: [pulseaudio] sink-input.c: application.process.machine_id = &quot;81157a0d6cb84ce9b5fd22006cf55017&quot; I: [pulseaudio] sink-input.c: module-stream-restore.id = &quot;sink-input-by-application-name:/run/user/1000/pulse/native&quot; I: [pulseaudio] protocol-native.c: Requested tlength=10.00 ms, minreq=4.99 ms I: [pulseaudio] protocol-native.c: Final latency 10.98 ms = 0.50 ms + 2*4.99 ms + 0.50 ms I: [alsa-source-ALC1150 Analog] alsa-source.c: Trying resume... I: [alsa-source-ALC1150 Analog] alsa-util.c: Trying to disable ALSA period wakeups, using timers only I: [alsa-source-ALC1150 Analog] alsa-util.c: ALSA period wakeups disabled I: [alsa-source-ALC1150 Analog] alsa-source.c: Time scheduling watermark is 20.00ms I: [alsa-source-ALC1150 Analog] alsa-source.c: Resumed successfully... I: [alsa-source-ALC1150 Analog] alsa-source.c: Starting capture. I: [pulseaudio] source-output.c: Created output 1 &quot;qemu&quot; on alsa_input.pci-0000_00_1b.0.analog-stereo with sample spec s16le 2ch 44100Hz and channel map front-left,front-right I: [pulseaudio] source-output.c: media.name = &quot;qemu&quot; I: [pulseaudio] source-output.c: application.name = &quot;/run/user/1000/pulse/native&quot; I: [pulseaudio] source-output.c: native-protocol.peer = &quot;UNIX socket client&quot; I: [pulseaudio] source-output.c: native-protocol.version = &quot;29&quot; I: [pulseaudio] source-output.c: application.process.id = &quot;7409&quot; I: [pulseaudio] source-output.c: application.process.user = &quot;root&quot; I: [pulseaudio] source-output.c: application.process.host = &quot;ArcherBase&quot; I: [pulseaudio] source-output.c: application.process.binary = &quot;qemu-system-x86_64&quot; I: [pulseaudio] source-output.c: application.language = &quot;C&quot; I: [pulseaudio] source-output.c: window.x11.display = &quot;:0&quot; I: [pulseaudio] source-output.c: application.process.machine_id = &quot;81157a0d6cb84ce9b5fd22006cf55017&quot; I: [pulseaudio] source-output.c: module-stream-restore.id = &quot;source-output-by-application-name:/run/user/1000/pulse/native&quot; I: [pulseaudio] protocol-native.c: Final latency 2000.00 ms = 1000.00 ms + 1000.00 ms I: [alsa-sink-ALC1150 Analog] alsa-sink.c: Underrun! I: [alsa-sink-ALC1150 Analog] alsa-sink.c: Increasing minimal latency to 1.00 ms I: [pulseaudio] source-output.c: Freeing output 1 &quot;qemu&quot; I: [pulseaudio] sink-input.c: Freeing input 3 &quot;qemu&quot; I: [pulseaudio] client.c: Freed 3 &quot;/run/user/1000/pulse/native&quot; I: [pulseaudio] protocol-native.c: Connection died.</code></pre></div><p>When I kill the VM sound goes back to normal and the audio playing on the host is fine.</p><p>Script to start the VM</p><div class="codebox"><pre><code> 1 #!/bin/sh 2 3 vfio-bind 0000:01:00.0 0000:01:00.1 4 5 export QEMU_PA_SAMPLES=2048 6 export QEMU_PA_SERVER=/run/user/1000/pulse/native 7 8 qemu-system-x86_64 -enable-kvm -M q35 -m 10240 -cpu host \ 9 -smp 6,sockets=1,cores=3,threads=2 \ 10 -bios /usr/share/qemu/bios.bin \ 11 -device ioh3420,bus=pcie.0,addr=1c.0,multifunction=on,port=1,chassis=1,id=root.1 \ 12 -device vfio-pci,host=01:00.0,bus=root.1,addr=00.0,multifunction=on,x-vga=on \ 13 -device vfio-pci,host=01:00.1,bus=root.1,addr=00.1 \ 14 -drive id=system,file=/home/thomas/vm/GamingWindows.img,format=raw \ 15 -device ide-hd,bus=ide.0,drive=system \ 16 -vga none \ 17 -monitor stdio \ 18 -drive id=storage,file=/home/thomas/vm/GamingWindowsStorage.qcow2,format=qcow2 \ 19 -device ide-hd,bus=ide.1,drive=storage \ 20 -usb -device usb-host,hostbus=1,hostaddr=7 \ 21 -usb -device usb-host,hostbus=1,hostaddr=14 \ 22 -usb -usbdevice host:046d:c52b \ 23 -device ich9-intel-hda,bus=pcie.0,addr=1b.0,id=sound0 \ 24 -device hda-duplex,id=sound0-codec0,bus=sound0.0,cad=0</code></pre></div> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1442918">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1442976" class="blockpost roweven"> <h2><span><span class="conr">#2414</span> <a href="viewtopic.php?pid=1442976#p1442976">2014-08-02 17:51:48</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=84060">valkaiser</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2014-08-02</span></dd> <dd><span>Posts: 1</span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <p>Hi all, great thread.<br />I have successfully passed through an nVidia 7900GS to a windows XP SP3 guest.<br />Host hardware: ASUS P9X79 WS, i7 4930K, nVidia 7900GS x2, ATI X300 x2.<br />Host is running Arch with stock kernel, qemu, and seabios.<br />Guest is using emulated IDE for HDD as I had trouble getting XP to run, but I&#039;m still fiddling with it.<br />QEMU invocation script:</p><div class="codebox"><pre><code>#!/bin/bash modprobe vfio-pci vfio-bind 0000:04:00.0 qemu-system-x86_64 -enable-kvm -M q35 -m 1024 -cpu host \ -smp 6,sockets=1,cores=6,threads=1 \ -bios /usr/share/qemu/bios.bin -vga none \ -device ioh3420,bus=pcie.0,addr=1c.0,multifunction=on,port=1,chassis=1,id=root.1 \ -device vfio-pci,host=04:00.0,bus=root.1,addr=00.0,multifunction=on,x-vga=on \ -device piix4-ide,bus=pcie.0,id=piix4-ide \ -drive file=/media/Data3/OS/windows.img,id=disk,format=raw -device ide-hd,bus=piix4-ide.0,drive=disk \ -drive file=virtio-win-0.1-81.iso,id=isocd2 -device ide-cd,bus=piix4-ide.1,drive=isocd2 \ -usb -usbdevice host:05ac:0201 -usbdevice host:046d:c03d \ -boot once=d \ -no-acpi \ -nographic</code></pre></div><p>Anyways, what has me stumped currently is the nVidia drivers on the guest. I installed the latest available for my 7900, 307.83, and the install goes smoothly. However, upon rebooting, XP does not use the driver.<br />The device status screen gives me this:<br />Your computer&#039;s system firmware does not include enough information to properly configure and use this device. To use this device, contact your computer manufacturer to obtain a firmware or BIOS update. [CODE 35]<br />Are there other drivers for the guest that I needed to install first?</p><p>Any ideas?</p><p>Oh, and thanks for pooling all this information here. It has been enormously helpful.</p><p>UPDATE: I get exactly the same results when passing through an ATI X300.<br />UPDATE: Now using linux-mainline+patches from OP. No change.</p> <p class="postedit"><em>Last edited by valkaiser (2014-08-03 05:13:13)</em></p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1442976">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1442991" class="blockpost rowodd"> <h2><span><span class="conr">#2415</span> <a href="viewtopic.php?pid=1442991#p1442991">2014-08-02 18:40:12</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=83763">rg80</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2014-07-23</span></dd> <dd><span>Posts: 7</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=83763">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <p>Hi again. <img src="https://bbs.archlinux.org/img/smilies/smile.png" width="15" height="15" alt="smile" /> </p><p>Do you have any idea how to add -cpu kvm=off option into a virt-manager xml?<br />I already tried with qemu arg:</p><div class="codebox"><pre><code> &lt;qemu:arg value=&#039;-cpu&#039;/&gt; &lt;qemu:arg value=&#039;kvm=off&#039;/&gt;</code></pre></div><p>but it does not work.</p><p>Should i put it somewhere into CPU options?</p><div class="codebox"><pre><code> &lt;cpu mode=&#039;host-passthrough&#039;&gt; &lt;topology sockets=&#039;1&#039; cores=&#039;4&#039; threads=&#039;2&#039;/&gt; &lt;/cpu&gt;</code></pre></div><p>Thanks. <img src="https://bbs.archlinux.org/img/smilies/smile.png" width="15" height="15" alt="smile" /></p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1442991">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1443090" class="blockpost roweven"> <h2><span><span class="conr">#2416</span> <a href="viewtopic.php?pid=1443090#p1443090">2014-08-02 23:32:04</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=81745">siddharta</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2014-05-03</span></dd> <dd><span>Posts: 30</span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <p>I&#039;m in the process of assembling a new rig primarily for gaming and would run Win 8.1 as VM, I&#039;ve had good experiences with this on another setup as HTPC. I understand that GPU performance should be close to native, how does the CPU side of the equation look in terms of overhead? Is it worth getting the i7 4790K over the i5 4690K, the latter being one third cheaper (close to 100 euro difference here). </p><p>I would think that in case of using Steam in-home streaming the i7 would be better due to not having nVidia or Intel QuickSync available for hardware assisted h.264 encoding (using AMD and impossible to KVM passthrough the iGPU). If I disregard that scenario it looks less worth it. Is that correct? Thanks.</p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1443090">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1443182" class="blockpost rowodd"> <h2><span><span class="conr">#2417</span> <a href="viewtopic.php?pid=1443182#p1443182">2014-08-03 07:55:58</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=82442">slis</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2014-06-02</span></dd> <dd><span>Posts: 125</span></dd> <dd class="usercontacts"><span class="email"><a href="mailto:xslisx@gmail.com">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>siddharta wrote:</cite><blockquote><div><p>I&#039;m in the process of assembling a new rig primarily for gaming and would run Win 8.1 as VM, I&#039;ve had good experiences with this on another setup as HTPC. I understand that GPU performance should be close to native, how does the CPU side of the equation look in terms of overhead? Is it worth getting the i7 4790K over the i5 4690K, the latter being one third cheaper (close to 100 euro difference here). </p><p>I would think that in case of using Steam in-home streaming the i7 would be better due to not having nVidia or Intel QuickSync available for hardware assisted h.264 encoding (using AMD and impossible to KVM passthrough the iGPU). If I disregard that scenario it looks less worth it. Is that correct? Thanks.</p></div></blockquote></div><p>i7 is much better... 2x more vcpu-s..u won&#039;t have good streaming performance in software mode... but valve said they are working on AMD VCE and no ETA.</p> <p class="postedit"><em>Last edited by slis (2014-08-03 07:56:31)</em></p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1443182">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1443316" class="blockpost roweven"> <h2><span><span class="conr">#2418</span> <a href="viewtopic.php?pid=1443316#p1443316">2014-08-03 16:43:27</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=66944">shrubuntu</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2012-12-26</span></dd> <dd><span>Posts: 16</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=66944">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <p>Having some trouble with sound. I am using the command in the op, but the sound in windows is filled with alot of static. When I switch to usb audio, it works, but I prefer to keep it analog. </p><p>Any fix?</p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1443316">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1443317" class="blockpost rowodd"> <h2><span><span class="conr">#2419</span> <a href="viewtopic.php?pid=1443317#p1443317">2014-08-03 16:45:13</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=83145">kameloc</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2014-06-28</span></dd> <dd><span>Posts: 11</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=83145">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>shrubuntu wrote:</cite><blockquote><div><p>Having some trouble with sound. I am using the command in the op, but the sound in windows is filled with alot of static. When I switch to usb audio, it works, but I prefer to keep it analog. </p><p>Any fix?</p></div></blockquote></div><p>I had this issue on Windows 8 and tried using different cards to emulate with no fix. Switched to Windows 7 and using ac97 (-sound ac97) works really well.</p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1443317">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1443319" class="blockpost roweven"> <h2><span><span class="conr">#2420</span> <a href="viewtopic.php?pid=1443319#p1443319">2014-08-03 16:49:16</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=66944">shrubuntu</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2012-12-26</span></dd> <dd><span>Posts: 16</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=66944">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>kameloc wrote:</cite><blockquote><div><div class="quotebox"><cite>shrubuntu wrote:</cite><blockquote><div><p>Having some trouble with sound. I am using the command in the op, but the sound in windows is filled with alot of static. When I switch to usb audio, it works, but I prefer to keep it analog. </p><p>Any fix?</p></div></blockquote></div><p>I had this issue on Windows 8 and tried using different cards to emulate with no fix. Switched to Windows 7 and using ac97 (-sound ac97) works really well.</p></div></blockquote></div><div class="codebox"><pre><code>-device ac97,bus=pcie.0,addr=1b.0,id=sound0 \ -device hda-duplex,id=sound0-codec0,bus=sound0.0,cad=0</code></pre></div><p>like this?</p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1443319">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1443321" class="blockpost rowodd"> <h2><span><span class="conr">#2421</span> <a href="viewtopic.php?pid=1443321#p1443321">2014-08-03 16:53:03</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=83145">kameloc</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2014-06-28</span></dd> <dd><span>Posts: 11</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=83145">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>shrubuntu wrote:</cite><blockquote><div><div class="quotebox"><cite>kameloc wrote:</cite><blockquote><div><div class="quotebox"><cite>shrubuntu wrote:</cite><blockquote><div><p>Having some trouble with sound. I am using the command in the op, but the sound in windows is filled with alot of static. When I switch to usb audio, it works, but I prefer to keep it analog. </p><p>Any fix?</p></div></blockquote></div><p>I had this issue on Windows 8 and tried using different cards to emulate with no fix. Switched to Windows 7 and using ac97 (-sound ac97) works really well.</p></div></blockquote></div><div class="codebox"><pre><code>-device ac97,bus=pcie.0,addr=1b.0,id=sound0 \ -device hda-duplex,id=sound0-codec0,bus=sound0.0,cad=0</code></pre></div><p>like this?</p></div></blockquote></div><p>Oh sorry I don&#039;t passthrough my onboard audio, just share it. If you add </p><div class="codebox"><pre><code>-soundhw ac97</code></pre></div><p>It emulates Realtek AC&#039;97 for the guest. It allowed me to use my speakers from the VM or host, and at the same time</p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1443321">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1443437" class="blockpost roweven"> <h2><span><span class="conr">#2422</span> <a href="viewtopic.php?pid=1443437#p1443437">2014-08-03 22:56:22</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=84101">zerotri</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2014-08-03</span></dd> <dd><span>Posts: 2</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=84101">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <p>Been having trouble getting this all setup on my system. Tried with both Arch and Fedora 20 with similar results.<br />Motherboard is an Asus P9X79 Pro, cpu is an i7-3820, both support VT-d.</p><p>When I start my host it seems to stay in low resolution efifb mode. It also never reaches a login screen, just stays at service startup output. I have to switch to a login using Ctrl + Alt + F2. I&#039;ve tried going through quite a few of the pages in this thread and am not seeing anyone getting similar results.</p><p><strong>dmesg | grep -e DMAR -e IOMMU:</strong></p><div class="codebox"><pre><code>[root@Heimdall ~]# dmesg | grep -e DMAR -e IOMMU [ 0.000000] ACPI: DMAR 0x00000000BE4C32B0 0000B4 (v01 A M I OEMDMAR 00000001 INTL 00000001) [ 0.000000] Intel-IOMMU: enabled [ 0.166673] dmar: IOMMU 0: reg_base_addr fbffc000 ver 1:0 cap d2078c106f0462 ecap f020fe [ 0.166765] IOAPIC id 0 under DRHD base 0xfbffc000 IOMMU 0 [ 0.166766] IOAPIC id 2 under DRHD base 0xfbffc000 IOMMU 0 [ 0.771339] IOMMU 0 0xfbffc000: using Queued invalidation [ 0.771341] IOMMU: Setting RMRR: [ 0.771352] IOMMU: Setting identity map for device 0000:00:1a.0 [0xbea9a000 - 0xbeaa8fff] [ 0.771375] IOMMU: Setting identity map for device 0000:00:1d.0 [0xbea9a000 - 0xbeaa8fff] [ 0.771388] IOMMU: Prepare 0-16MiB unity mapping for LPC [ 0.771395] IOMMU: Setting identity map for device 0000:00:1f.0 [0x0 - 0xffffff] [ 1.231728] dmar: DMAR:[DMA Read] Request device [09:00.1] fault addr fffe0000 DMAR:[fault reason 02] Present bit in context entry is clear</code></pre></div><p><strong>Command line:</strong></p><div class="codebox"><pre><code>BOOT_IMAGE=/vmlinuz-3.15.7-200.fc20.x86_64 root=/dev/mapper/fedora-root ro vconsole.font=latarcyrheb-sun16 rd.lvm.lv=fedora/root intel_iommu=on pci-stub.ids=1002:68ba,1002:aa58 pcie_acs_override=downstream rhgb quiet LANG=en_US.UTF-8</code></pre></div><br /><p><strong>lspci -v (cut out just the GPUs):</strong></p><div class="codebox"><pre class="vscroll"><code>01:00.0 VGA compatible controller: Advanced Micro Devices, Inc. [AMD/ATI] Juniper XT [Radeon HD 6770] (prog-if 00 [VGA controller]) Subsystem: XFX Pine Group Inc. Device 3156 Flags: bus master, fast devsel, latency 0, IRQ 11 Memory at d0000000 (64-bit, prefetchable) [size=256M] Memory at fbe20000 (64-bit, non-prefetchable) [size=128K] I/O ports at e000 [size=256] Expansion ROM at fbe00000 [disabled] [size=128K] Capabilities: [50] Power Management version 3 Capabilities: [58] Express Legacy Endpoint, MSI 00 Capabilities: [a0] MSI: Enable- Count=1/1 Maskable- 64bit+ Capabilities: [100] Vendor Specific Information: ID=0001 Rev=1 Len=010 &lt;?&gt; Capabilities: [150] Advanced Error Reporting Kernel driver in use: vfio-pci Kernel modules: radeon 01:00.1 Audio device: Advanced Micro Devices, Inc. [AMD/ATI] Juniper HDMI Audio [Radeon HD 5700 Series] Subsystem: XFX Pine Group Inc. Device aa58 Flags: bus master, fast devsel, latency 0, IRQ 10 Memory at fbe40000 (64-bit, non-prefetchable) [size=16K] Capabilities: [50] Power Management version 3 Capabilities: [58] Express Legacy Endpoint, MSI 00 Capabilities: [a0] MSI: Enable- Count=1/1 Maskable- 64bit+ Capabilities: [100] Vendor Specific Information: ID=0001 Rev=1 Len=010 &lt;?&gt; Capabilities: [150] Advanced Error Reporting Kernel driver in use: vfio-pci Kernel modules: snd_hda_intel 02:00.0 VGA compatible controller: Advanced Micro Devices, Inc. [AMD/ATI] Juniper XT [Radeon HD 6770] (prog-if 00 [VGA controller]) Subsystem: XFX Pine Group Inc. Device 3156 Flags: fast devsel, IRQ 11 Memory at c0000000 (64-bit, prefetchable) [disabled] [size=256M] Memory at fbd20000 (64-bit, non-prefetchable) [disabled] [size=128K] I/O ports at d000 [disabled] [size=256] Expansion ROM at fbd00000 [disabled] [size=128K] Capabilities: [50] Power Management version 3 Capabilities: [58] Express Legacy Endpoint, MSI 00 Capabilities: [a0] MSI: Enable- Count=1/1 Maskable- 64bit+ Capabilities: [100] Vendor Specific Information: ID=0001 Rev=1 Len=010 &lt;?&gt; Capabilities: [150] Advanced Error Reporting Kernel driver in use: pci-stub Kernel modules: radeon 02:00.1 Audio device: Advanced Micro Devices, Inc. [AMD/ATI] Juniper HDMI Audio [Radeon HD 5700 Series] Subsystem: XFX Pine Group Inc. Device aa58 Flags: fast devsel, IRQ 10 Memory at fbd40000 (64-bit, non-prefetchable) [disabled] [size=16K] Capabilities: [50] Power Management version 3 Capabilities: [58] Express Legacy Endpoint, MSI 00 Capabilities: [a0] MSI: Enable- Count=1/1 Maskable- 64bit+ Capabilities: [100] Vendor Specific Information: ID=0001 Rev=1 Len=010 &lt;?&gt; Capabilities: [150] Advanced Error Reporting Kernel driver in use: pci-stub Kernel modules: snd_hda_intel</code></pre></div><p><strong>ls -al /dev/vfio/:</strong></p><div class="codebox"><pre><code>[root@Heimdall vfio]# ls -al /dev/vfio total 0 drwxr-xr-x. 2 root root 80 Aug 3 15:45 . drwxr-xr-x. 21 root root 3420 Aug 3 15:45 .. crw-------. 1 root root 246, 0 Aug 3 15:45 15 crw-rw-rw-. 1 root root 10, 196 Aug 3 15:45 vfio</code></pre></div><p>I&#039;m out of ideas as to what it could be. I&#039;ve tried with various command line options, tried swapping around which graphics card is bound as well as tried binding both.<br />Is there anything that is glaringly obvious to someone who has this working that I&#039;m just completely missing here? Could it be due to me using two of the same graphics card?</p><br /><p>And on a much less important matter for <strong>aw</strong>, I&#039;ve been reading up on the dma-alias patch because I have a Marvell 88SE9128 sata controller that causes boot to take several minutes with intel_iommu=on. It is my understanding that this patch has been rejected from mainline so I&#039;m likely out of luck. Would you happen to have any suggestions for how to deal with this?</p><p>Thank you for any and all help you can provide,<br />- Wynter Woods</p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1443437">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1443448" class="blockpost rowodd"> <h2><span><span class="conr">#2423</span> <a href="viewtopic.php?pid=1443448#p1443448">2014-08-03 23:22:22</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=75590">aw</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2013-10-04</span></dd> <dd><span>Posts: 921</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=75590">Email</a></span> <span class="website"><a href="http://vfio.blogspot.com/" rel="nofollow">Website</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>zerotri wrote:</cite><blockquote><div><p>And on a much less important matter for <strong>aw</strong>, I&#039;ve been reading up on the dma-alias patch because I have a Marvell 88SE9128 sata controller that causes boot to take several minutes with intel_iommu=on. It is my understanding that this patch has been rejected from mainline so I&#039;m likely out of luck. Would you happen to have any suggestions for how to deal with this?</p></div></blockquote></div><p>The latest attempt will come together in v3.17.&#160; I assume that&#039;s what&#039;s causing your DMAR fault.</p> </div> <div class="postsignature postmsg"><hr /><p><a href="http://vfio.blogspot.com" rel="nofollow">http://vfio.blogspot.com</a><br />Looking for a more open forum to discuss vfio related uses?&#160; Try <a href="https://www.redhat.com/mailman/listinfo/vfio-users" rel="nofollow">https://www.redhat.com/mailman/listinfo/vfio-users</a></p></div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1443448">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1443530" class="blockpost roweven"> <h2><span><span class="conr">#2424</span> <a href="viewtopic.php?pid=1443530#p1443530">2014-08-04 08:22:21</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=72498">atmouse</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd class="postavatar"><img src="https://bbs.archlinux.org/img/avatars/72498.png?m=1371804282" width="60" height="60" alt="" /></dd> <dd><span>Registered: 2013-06-21</span></dd> <dd><span>Posts: 5</span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <p>I have two video cards, HIS HD7870 x2. The hardware ID,vender just the same. </p><p>How could I use vga-passthrough one of them to qemu-kvm?&#160; is it that setting pci-stub.ids to the same id block both of the gpu? working or not？</p><p>CPU is AMD-FX8350, no gpu integrated.</p> <p class="postedit"><em>Last edited by atmouse (2014-08-04 13:56:52)</em></p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1443530">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1443645" class="blockpost rowodd"> <h2><span><span class="conr">#2425</span> <a href="viewtopic.php?pid=1443645#p1443645">2014-08-04 15:11:35</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=83763">rg80</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2014-07-23</span></dd> <dd><span>Posts: 7</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=83763">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>rg80 wrote:</cite><blockquote><div><p>Hi again. <img src="https://bbs.archlinux.org/img/smilies/smile.png" width="15" height="15" alt="smile" /> </p><p>Do you have any idea how to add -cpu kvm=off option into a virt-manager xml?<br />I already tried with qemu arg:</p><div class="codebox"><pre><code> &lt;qemu:arg value=&#039;-cpu&#039;/&gt; &lt;qemu:arg value=&#039;kvm=off&#039;/&gt;</code></pre></div><p>but it does not work.</p><p>Should i put it somewhere into CPU options?</p><div class="codebox"><pre><code> &lt;cpu mode=&#039;host-passthrough&#039;&gt; &lt;topology sockets=&#039;1&#039; cores=&#039;4&#039; threads=&#039;2&#039;/&gt; &lt;/cpu&gt;</code></pre></div><p>Thanks. <img src="https://bbs.archlinux.org/img/smilies/smile.png" width="15" height="15" alt="smile" /></p></div></blockquote></div><br /><p>Bumping in a different format.<br />I want to disable the KVM Signture to update my nvidia windows drivers to any newer than v335.</p><p>Then got latest GIT version of qemu, applied <a href="http://permalink.gmane.org/gmane.comp.emulators.kvm.devel/122649" rel="nofollow">this patch</a>, then config, make, make install, reboot.</p><p>Applied:</p><div class="codebox"><pre><code> &lt;qemu:arg value=&#039;-cpu&#039;/&gt; &lt;qemu:arg value=&#039;host,kvm=off&#039;/&gt;</code></pre></div><p>but qemu reports .kvm is not an available option for qemu-system-x86_64.</p><p>On the contrary:</p><div class="codebox"><pre><code> &lt;qemu:arg value=&#039;-cpu&#039;/&gt; &lt;qemu:arg value=&#039;host,hv-time&#039;/&gt;</code></pre></div><p>works.</p><p>Am i doing something wrong?</p><p>Note:<br />For some reason, <a href="http://lists.gnu.org/archive/html/qemu-devel/2014-06/msg00319.html" rel="nofollow">the original patch</a> posted on page 1 gives me a format error on:</p><div class="codebox"><pre><code>diff --git a/target-i386/cpu.c b/target-i386/cpu.c</code></pre></div><p>it&#039;s not a blank, i can&#039;t understand where the problem is...</p><p>Thanks! <img src="https://bbs.archlinux.org/img/smilies/smile.png" width="15" height="15" alt="smile" /></p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1443645">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div class="postlinksb"> <div class="inbox crumbsplus"> <div class="pagepost"> <p class="pagelink conl"><span class="pages-label">Pages: </span><a rel="prev" class="item1" href="viewtopic.php?id=162768&amp;p=96">Previous</a> <a href="viewtopic.php?id=162768">1</a> <span class="spacer">…</span> <a href="viewtopic.php?id=162768&amp;p=95">95</a> <a href="viewtopic.php?id=162768&amp;p=96">96</a> <strong>97</strong> <a href="viewtopic.php?id=162768&amp;p=98">98</a> <a href="viewtopic.php?id=162768&amp;p=99">99</a> <span class="spacer">…</span> <a href="viewtopic.php?id=162768&amp;p=234">234</a> <a rel="next" href="viewtopic.php?id=162768&amp;p=98">Next</a></p> <p class="postlink conr">Topic closed</p> </div> <ul class="crumbs"> <li><a href="index.php">Index</a></li> <li><span>»&#160;</span><a href="viewforum.php?id=48">Topics Going Nowhere</a></li> <li><span>»&#160;</span><strong><a href="viewtopic.php?id=162768">KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</a></strong></li> </ul> <p class="subscribelink clearb"><a href="misc.php?action=subscribe&amp;tid=162768">Subscribe to this topic</a></p> <div class="clearer"></div> </div> </div> </div> <div id="brdfooter" class="block"> <h2><span>Board footer</span></h2> <div class="box"> <div id="brdfooternav" class="inbox"> <div class="conl"> <form id="qjump" method="get" action="viewforum.php"> <div><label><span>Jump to<br /></span> <select name="id" onchange="window.location=('viewforum.php?id='+this.options[this.selectedIndex].value)"> <optgroup label="Technical Issues and Assistance"> <option value="23">Newbie Corner</option> <option value="17">Installation</option> <option value="22">Kernel &amp; Hardware</option> <option value="18">Applications &amp; Desktop Environments</option> <option value="31">Laptop Issues</option> <option value="8">Networking, Server, and Protection</option> <option value="32">Multimedia and Games</option> <option value="50">System Administration</option> <option value="35">Other Architectures</option> </optgroup> <optgroup label="Arch-centric"> <option value="24">Announcements, Package &amp; Security Advisories</option> <option value="1">Arch Discussion</option> <option value="13">Forum &amp; Wiki discussion</option> </optgroup> <optgroup label="Pacman Upgrades, Packaging &amp; AUR"> <option value="44">Pacman &amp; Package Upgrade Issues</option> <option value="49">[testing] Repo Forum</option> <option value="4">Creating &amp; Modifying Packages</option> <option value="38">AUR Issues, Discussion &amp; PKGBUILD Requests</option> </optgroup> <optgroup label="Contributions &amp; Discussion"> <option value="20">GNU/Linux Discussion</option> <option value="27">Community Contributions</option> <option value="33">Programming &amp; Scripting</option> <option value="30">Other Languages</option> <option value="47">Artwork and Screenshots</option> <option value="42">Try This</option> </optgroup> <optgroup label="/dev/null"> <option value="29">Off-Topic</option> <option value="48" selected="selected">Topics Going Nowhere</option> <option value="36">Dustbin</option> </optgroup> </select></label> <input type="submit" value=" Go " accesskey="g" /> </div> </form> </div> <div class="conr"> <p id="feedlinks"><span class="atom"><a href="extern.php?action=feed&amp;tid=162768&amp;type=atom">Atom topic feed</a></span></p> <p id="poweredby">Powered by <a href="http://fluxbb.org/">FluxBB</a></p> </div> <div class="clearer"></div> </div> </div> </div> </div> <div class="end-box"></div> </div> </body> </html>
