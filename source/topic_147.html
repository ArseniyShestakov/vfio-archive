<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"> <html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en" dir="ltr"> <head> <meta http-equiv="Content-Type" content="text/html; charset=utf-8" /> <title>KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9 (Page 147) / Topics Going Nowhere / Arch Linux Forums</title> <link rel="stylesheet" type="text/css" href="style/ArchLinux.css" /> <link rel="canonical" href="viewtopic.php?id=162768&amp;p=147" title="Page 147" /> <link rel="prev" href="viewtopic.php?id=162768&amp;p=146" title="Page 146" /> <link rel="next" href="viewtopic.php?id=162768&amp;p=148" title="Page 148" /> <link rel="alternate" type="application/atom+xml" href="extern.php?action=feed&amp;tid=162768&amp;type=atom" title="Atom topic feed" /> <link rel="stylesheet" media="screen" href="style/ArchLinux/arch.css?v=3" /> <link rel="stylesheet" media="screen" href="style/ArchLinux/archnavbar.css?v=2" /> <link rel="shortcut icon" href="style/ArchLinux/favicon.ico" /> </head> <body> <div id="archnavbar" class="anb-forum"> <div id="archnavbarlogo"><h1><a href="http://www.archlinux.org/">Arch Linux</a></h1></div> <div id="archnavbarmenu"> <ul id="archnavbarlist"> <li id="anb-home"><a href="http://www.archlinux.org/">Home</a></li><li id="anb-packages"><a href="http://www.archlinux.org/packages/">Packages</a></li><li id="anb-forums" class="anb-selected"><a href="https://bbs.archlinux.org/">Forums</a></li><li id="anb-wiki"><a href="https://wiki.archlinux.org/">Wiki</a></li><li id="anb-bugs"><a href="https://bugs.archlinux.org/">Bugs</a></li><li id="anb-aur"><a href="https://aur.archlinux.org/">AUR</a></li><li id="anb-download"><a href="http://www.archlinux.org/download/">Download</a></li> </ul> </div> </div> <div id="punviewtopic" class="pun"> <div class="top-box"></div> <div class="punwrap"> <div id="brdheader" class="block"> <div class="box"> <div id="brdmenu" class="inbox"> <ul> <li id="navindex" class="isactive"><a href="index.php">Index</a></li> <li id="navuserlist"><a href="userlist.php">User list</a></li> <li id="navsearch"><a href="search.php">Search</a></li> <li id="navprofile"><a href="profile.php?id=80749">Profile</a></li> <li id="navlogout"><a href="login.php?action=out&amp;id=80749&amp;csrf_token=5c20501ec397bb45ef8ee8c84db232c8d8e421c6">Logout</a></li> </ul> </div> <div id="brdwelcome" class="inbox"> <ul class="conl"> <li><span>Logged in as <strong>SXX</strong></span></li> <li><span>Last visit: 2015-08-16 12:20:09</span></li> </ul> <ul class="conr"> <li><span>Topics: <a href="search.php?action=show_replies" title="Find topics you have posted to.">Posted</a> | <a href="search.php?action=show_new" title="Find topics with new posts since your last visit.">New</a> | <a href="search.php?action=show_recent" title="Find topics with recent posts.">Active</a> | <a href="search.php?action=show_unanswered" title="Find topics with no replies.">Unanswered</a></span></li> </ul> <div class="clearer"></div> </div> </div> </div> <div id="brdmain"> <div class="linkst"> <div class="inbox crumbsplus"> <ul class="crumbs"> <li><a href="index.php">Index</a></li> <li><span>»&#160;</span><a href="viewforum.php?id=48">Topics Going Nowhere</a></li> <li><span>»&#160;</span><strong><a href="viewtopic.php?id=162768">KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</a></strong></li> </ul> <div class="pagepost"> <p class="pagelink conl"><span class="pages-label">Pages: </span><a rel="prev" class="item1" href="viewtopic.php?id=162768&amp;p=146">Previous</a> <a href="viewtopic.php?id=162768">1</a> <span class="spacer">…</span> <a href="viewtopic.php?id=162768&amp;p=145">145</a> <a href="viewtopic.php?id=162768&amp;p=146">146</a> <strong>147</strong> <a href="viewtopic.php?id=162768&amp;p=148">148</a> <a href="viewtopic.php?id=162768&amp;p=149">149</a> <span class="spacer">…</span> <a href="viewtopic.php?id=162768&amp;p=234">234</a> <a rel="next" href="viewtopic.php?id=162768&amp;p=148">Next</a></p> <p class="postlink conr">Topic closed</p> </div> <div class="clearer"></div> </div> </div> <div id="p1486858" class="blockpost rowodd blockpost1"> <h2><span><span class="conr">#3651</span> <a href="viewtopic.php?pid=1486858#p1486858">2014-12-23 10:28:38</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=87484">kainet</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2014-12-22</span></dd> <dd><span>Posts: 9</span></dd> <dd class="usercontacts"><span class="email"><a href="mailto:bart47@gmail.com">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>slis wrote:</cite><blockquote><div><p>You need to use OVMF, or patch kernel.</p></div></blockquote></div><br /><p>Thanks! What patches i should install ?</p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1486858">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1486868" class="blockpost roweven"> <h2><span><span class="conr">#3652</span> <a href="viewtopic.php?pid=1486868#p1486868">2014-12-23 11:49:51</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=82442">slis</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2014-06-02</span></dd> <dd><span>Posts: 125</span></dd> <dd class="usercontacts"><span class="email"><a href="mailto:xslisx@gmail.com">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <p><a href="https://lkml.org/lkml/2014/5/9/517" rel="nofollow">https://lkml.org/lkml/2014/5/9/517</a></p><p>This one.</p><p>Are you having latest qemu? whezzy&#039;s is too old i guess.</p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1486868">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1486869" class="blockpost rowodd"> <h2><span><span class="conr">#3653</span> <a href="viewtopic.php?pid=1486869#p1486869">2014-12-23 11:52:46</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=83627">JohnyPea</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2014-07-17</span></dd> <dd><span>Posts: 17</span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <p>Hello everybody,</p><p>I was watching this thread from its first post, bud had very little success passing through my cards in the beginning. Also didn&#039;t beg for help because I&#039;m doing this on ubuntu (please, don&#039;t laugh... too much) and tried to figure things out on my own. Thanks to so many useful advices in this thread I have learnt a lot, and also tried a few successful configurations. So thanks all for the contributions.<br />My actual working configuration:</p><p>Host:<br />- FX-8350, Sabertooth 990FX, 2xNV660Ti 3GB, 32GB RAM<br />- SSD Samsung 840Pro, Adaptec 2405 RAID0, And a few various big drives<br />- Ubuntu 15.04<br />- Self compiled kernel (based on arch config) 3.18.1, 1000HZ, voluntary preemption, builtin pci-back, and other tweaks; works also with stock ubuntu kernel if pci-back is in initramfs, but everything is slower</p><div class="codebox"><pre><code>BOOT_IMAGE=/boot/vmlinuz-3.18.1-custom root=UUID=7ca2c85e-f29e-404d-91c7-92ad1e087465 ro splash ivrs_ioapic[9]=00:14.0 ivrs_ioapic[10]=00:00.1 iommu=pt iommu=1 xen-pciback.hide=(06:00.0)(06:00.1) default_hugepagesz=1G hugepagesz=1G panic=10 hugepages=6 isolcpus=2-7 vt.handoff=7</code></pre></div><p>- qemu 2.2.50 with DEVID patch<br />- propietery nvidia drivers for primary card on host</p><p>Guest(s):<br />Almost completely through libvirt (thanks to aws wrapper script its pretty neat), I have just the pci-back &gt; vfio-pci in init script (probably can be done in libvirt pre-start script)<br />Im also using taskset in libvirt event script for compacting all running processes to cores 0-1 and releasing them to all cores after guest shutdown <br />aws qemu wrapper script was the last thing to tidy up libvirt config and solve the privilege mess, genial:</p><div class="codebox"><pre><code>dzon@xenhost:~$ cat /usr/bin/qemu-vfio #!/bin/sh exec qemu-system-x86_64 `echo &quot;\$@&quot; | sed &#039;s|06:00.0|06:00.0,x-vga=on,x-vid=0x10DE,x-did=0x11FA,x-ss-vid=0x10DE,x-ss-did=0x097C,romfile=/usr/share/qemu/NVIDIA.QuadroK4000.3072.120813.rom|g&#039;`</code></pre></div><p>Win8.1, libvirt, xml:</p><div class="codebox"><pre class="vscroll"><code>&lt;domain type=&#039;kvm&#039; xmlns:qemu=&#039;http://libvirt.org/schemas/domain/qemu/1.0&#039;&gt; &lt;name&gt;Win81&lt;/name&gt; &lt;uuid&gt;b61f94a6-08de-455b-9073-95c0c3316501&lt;/uuid&gt; &lt;memory unit=&#039;KiB&#039;&gt;6291456&lt;/memory&gt; &lt;currentMemory unit=&#039;KiB&#039;&gt;6291456&lt;/currentMemory&gt; &lt;memoryBacking&gt; &lt;hugepages/&gt; &lt;/memoryBacking&gt; &lt;vcpu placement=&#039;static&#039; cpuset=&#039;0-7&#039;&gt;6&lt;/vcpu&gt; &lt;iothreads&gt;2&lt;/iothreads&gt; &lt;cputune&gt; &lt;vcpupin vcpu=&#039;0&#039; cpuset=&#039;2&#039;/&gt; &lt;vcpupin vcpu=&#039;1&#039; cpuset=&#039;3&#039;/&gt; &lt;vcpupin vcpu=&#039;2&#039; cpuset=&#039;4&#039;/&gt; &lt;vcpupin vcpu=&#039;3&#039; cpuset=&#039;5&#039;/&gt; &lt;vcpupin vcpu=&#039;4&#039; cpuset=&#039;6&#039;/&gt; &lt;vcpupin vcpu=&#039;5&#039; cpuset=&#039;7&#039;/&gt; &lt;emulatorpin cpuset=&#039;0-1&#039;/&gt; &lt;iothreadpin iothread=&#039;1&#039; cpuset=&#039;0-1&#039;/&gt; &lt;/cputune&gt; &lt;os&gt; &lt;type arch=&#039;x86_64&#039; machine=&#039;pc-i440fx-2.2&#039;&gt;hvm&lt;/type&gt; &lt;loader readonly=&#039;yes&#039; type=&#039;pflash&#039;&gt;/mnt/home/dzon/App/virt/ovmf-x64/OVMF_CODE-pure-efi.fd&lt;/loader&gt; &lt;nvram&gt;/var/lib/libvirt/qemu/nvram/Win81_VARS.fd&lt;/nvram&gt; &lt;bios useserial=&#039;yes&#039; rebootTimeout=&#039;0&#039;/&gt; &lt;/os&gt; &lt;features&gt; &lt;acpi/&gt; &lt;apic eoi=&#039;on&#039;/&gt; &lt;pae/&gt; &lt;hyperv&gt; &lt;relaxed state=&#039;on&#039;/&gt; &lt;vapic state=&#039;on&#039;/&gt; &lt;spinlocks state=&#039;on&#039; retries=&#039;8191&#039;/&gt; &lt;/hyperv&gt; &lt;kvm&gt; &lt;hidden state=&#039;on&#039;/&gt; &lt;/kvm&gt; &lt;pvspinlock state=&#039;on&#039;/&gt; &lt;/features&gt; &lt;cpu mode=&#039;host-passthrough&#039;&gt; &lt;topology sockets=&#039;1&#039; cores=&#039;6&#039; threads=&#039;1&#039;/&gt; &lt;/cpu&gt; &lt;clock offset=&#039;localtime&#039;&gt; &lt;timer name=&#039;rtc&#039; tickpolicy=&#039;catchup&#039;/&gt; &lt;timer name=&#039;pit&#039; tickpolicy=&#039;delay&#039;/&gt; &lt;timer name=&#039;hpet&#039; present=&#039;no&#039;/&gt; &lt;timer name=&#039;hypervclock&#039; present=&#039;yes&#039;/&gt; &lt;/clock&gt; &lt;on_poweroff&gt;destroy&lt;/on_poweroff&gt; &lt;on_reboot&gt;destroy&lt;/on_reboot&gt; &lt;on_crash&gt;destroy&lt;/on_crash&gt; &lt;pm&gt; &lt;suspend-to-mem enabled=&#039;no&#039;/&gt; &lt;suspend-to-disk enabled=&#039;no&#039;/&gt; &lt;/pm&gt; &lt;devices&gt; &lt;emulator&gt;/usr/bin/qemu-vfio&lt;/emulator&gt; &lt;disk type=&#039;file&#039; device=&#039;disk&#039;&gt; &lt;driver name=&#039;qemu&#039; type=&#039;qcow2&#039; cache=&#039;none&#039; io=&#039;native&#039; discard=&#039;unmap&#039;/&gt; &lt;source file=&#039;/home/VMSSD/Win81.qcow2&#039;/&gt; &lt;target dev=&#039;sda&#039; bus=&#039;scsi&#039;/&gt; &lt;boot order=&#039;1&#039;/&gt; &lt;address type=&#039;drive&#039; controller=&#039;0&#039; bus=&#039;0&#039; target=&#039;0&#039; unit=&#039;0&#039;/&gt; &lt;/disk&gt; &lt;disk type=&#039;file&#039; device=&#039;disk&#039;&gt; &lt;driver name=&#039;qemu&#039; type=&#039;raw&#039; cache=&#039;none&#039; io=&#039;native&#039;/&gt; &lt;source file=&#039;/dev/sda2&#039;/&gt; &lt;target dev=&#039;sdc&#039; bus=&#039;scsi&#039;/&gt; &lt;address type=&#039;drive&#039; controller=&#039;0&#039; bus=&#039;0&#039; target=&#039;0&#039; unit=&#039;2&#039;/&gt; &lt;/disk&gt; &lt;disk type=&#039;file&#039; device=&#039;disk&#039;&gt; &lt;driver name=&#039;qemu&#039; type=&#039;qcow2&#039; cache=&#039;none&#039; io=&#039;native&#039;/&gt; &lt;source file=&#039;/home/VMSSD/Win81Data.qcow2&#039;/&gt; &lt;target dev=&#039;sdd&#039; bus=&#039;scsi&#039;/&gt; &lt;address type=&#039;drive&#039; controller=&#039;0&#039; bus=&#039;0&#039; target=&#039;0&#039; unit=&#039;3&#039;/&gt; &lt;/disk&gt; &lt;disk type=&#039;file&#039; device=&#039;disk&#039;&gt; &lt;driver name=&#039;qemu&#039; type=&#039;raw&#039;/&gt; &lt;source file=&#039;/home/dzon/VM/Win81q.raw&#039;/&gt; &lt;target dev=&#039;sde&#039; bus=&#039;scsi&#039;/&gt; &lt;address type=&#039;drive&#039; controller=&#039;0&#039; bus=&#039;0&#039; target=&#039;0&#039; unit=&#039;4&#039;/&gt; &lt;/disk&gt; &lt;controller type=&#039;usb&#039; index=&#039;0&#039; model=&#039;nec-xhci&#039;&gt; &lt;address type=&#039;pci&#039; domain=&#039;0x0000&#039; bus=&#039;0x00&#039; slot=&#039;0x05&#039; function=&#039;0x0&#039;/&gt; &lt;/controller&gt; &lt;controller type=&#039;pci&#039; index=&#039;0&#039; model=&#039;pci-root&#039;/&gt; &lt;controller type=&#039;virtio-serial&#039; index=&#039;0&#039;&gt; &lt;address type=&#039;pci&#039; domain=&#039;0x0000&#039; bus=&#039;0x00&#039; slot=&#039;0x06&#039; function=&#039;0x0&#039;/&gt; &lt;/controller&gt; &lt;controller type=&#039;scsi&#039; index=&#039;0&#039; model=&#039;virtio-scsi&#039;&gt; &lt;driver queues=&#039;6&#039;/&gt; &lt;address type=&#039;pci&#039; domain=&#039;0x0000&#039; bus=&#039;0x00&#039; slot=&#039;0x07&#039; function=&#039;0x0&#039;/&gt; &lt;/controller&gt; &lt;interface type=&#039;network&#039;&gt; &lt;mac address=&#039;52:54:00:a5:e1:5a&#039;/&gt; &lt;source network=&#039;default&#039;/&gt; &lt;model type=&#039;virtio&#039;/&gt; &lt;address type=&#039;pci&#039; domain=&#039;0x0000&#039; bus=&#039;0x00&#039; slot=&#039;0x03&#039; function=&#039;0x0&#039;/&gt; &lt;/interface&gt; &lt;serial type=&#039;pty&#039;&gt; &lt;target port=&#039;0&#039;/&gt; &lt;/serial&gt; &lt;console type=&#039;pty&#039;&gt; &lt;target type=&#039;serial&#039; port=&#039;0&#039;/&gt; &lt;/console&gt; &lt;channel type=&#039;spicevmc&#039;&gt; &lt;target type=&#039;virtio&#039; name=&#039;com.redhat.spice.0&#039;/&gt; &lt;address type=&#039;virtio-serial&#039; controller=&#039;0&#039; bus=&#039;0&#039; port=&#039;1&#039;/&gt; &lt;/channel&gt; &lt;input type=&#039;mouse&#039; bus=&#039;ps2&#039;/&gt; &lt;input type=&#039;keyboard&#039; bus=&#039;ps2&#039;/&gt; &lt;graphics type=&#039;spice&#039; autoport=&#039;yes&#039;/&gt; &lt;sound model=&#039;ich6&#039;&gt; &lt;address type=&#039;pci&#039; domain=&#039;0x0000&#039; bus=&#039;0x00&#039; slot=&#039;0x04&#039; function=&#039;0x0&#039;/&gt; &lt;/sound&gt; &lt;video&gt; &lt;model type=&#039;qxl&#039; ram=&#039;65536&#039; vram=&#039;65536&#039; vgamem=&#039;8192&#039; heads=&#039;1&#039;/&gt; &lt;address type=&#039;pci&#039; domain=&#039;0x0000&#039; bus=&#039;0x00&#039; slot=&#039;0x02&#039; function=&#039;0x0&#039;/&gt; &lt;/video&gt; &lt;hostdev mode=&#039;subsystem&#039; type=&#039;usb&#039; managed=&#039;yes&#039;&gt; &lt;source&gt; &lt;vendor id=&#039;0x046d&#039;/&gt; &lt;product id=&#039;0xc52b&#039;/&gt; &lt;/source&gt; &lt;/hostdev&gt; &lt;hostdev mode=&#039;subsystem&#039; type=&#039;pci&#039; managed=&#039;yes&#039;&gt; &lt;source&gt; &lt;address domain=&#039;0x0000&#039; bus=&#039;0x06&#039; slot=&#039;0x00&#039; function=&#039;0x0&#039;/&gt; &lt;/source&gt; &lt;address type=&#039;pci&#039; domain=&#039;0x0000&#039; bus=&#039;0x00&#039; slot=&#039;0x09&#039; function=&#039;0x0&#039;/&gt; &lt;/hostdev&gt; &lt;hostdev mode=&#039;subsystem&#039; type=&#039;pci&#039; managed=&#039;yes&#039;&gt; &lt;source&gt; &lt;address domain=&#039;0x0000&#039; bus=&#039;0x06&#039; slot=&#039;0x00&#039; function=&#039;0x1&#039;/&gt; &lt;/source&gt; &lt;address type=&#039;pci&#039; domain=&#039;0x0000&#039; bus=&#039;0x00&#039; slot=&#039;0x0a&#039; function=&#039;0x0&#039;/&gt; &lt;/hostdev&gt; &lt;redirdev bus=&#039;usb&#039; type=&#039;spicevmc&#039;&gt; &lt;/redirdev&gt; &lt;redirdev bus=&#039;usb&#039; type=&#039;spicevmc&#039;&gt; &lt;/redirdev&gt; &lt;redirdev bus=&#039;usb&#039; type=&#039;spicevmc&#039;&gt; &lt;/redirdev&gt; &lt;redirdev bus=&#039;usb&#039; type=&#039;spicevmc&#039;&gt; &lt;/redirdev&gt; &lt;memballoon model=&#039;virtio&#039;&gt; &lt;address type=&#039;pci&#039; domain=&#039;0x0000&#039; bus=&#039;0x00&#039; slot=&#039;0x08&#039; function=&#039;0x0&#039;/&gt; &lt;/memballoon&gt; &lt;/devices&gt; &lt;qemu:commandline&gt; &lt;qemu:env name=&#039;QEMU_AUDIO_DAC_FIXED_FREQ&#039; value=&#039;48000&#039;/&gt; &lt;qemu:env name=&#039;QEMU_AUDIO_ADC_FIXED_FREQ&#039; value=&#039;48000&#039;/&gt; &lt;qemu:env name=&#039;QEMU_PA_SAMPLES&#039; value=&#039;1024&#039;/&gt; &lt;qemu:env name=&#039;QEMU_AUDIO_DRV&#039; value=&#039;pa&#039;/&gt; &lt;qemu:env name=&#039;QEMU_PA_SERVER&#039; value=&#039;/run/user/1000/pulse/native&#039;/&gt; &lt;/qemu:commandline&gt; &lt;/domain&gt;</code></pre></div><div class="codebox"><pre><code>dzon@xenhost:~$ cat /etc/libvirt/hooks/qemu #!/bin/bash logPath=/home/dzon/libvirt_start echo &quot;skript_start&quot; $1 $2 &gt;&gt; $logPath if [ $2 == &quot;start&quot; ] ; then echo &quot;start&quot; &gt;&gt; $logPath for i in `pgrep -v rcu`; do taskset -pc 0-1 $i &gt;&gt; $logPath; done fi if [ $2 == &quot;release&quot; ] ; then echo &quot;shutdown&quot; &gt;&gt; $logPath for i in `pgrep -v rcu`; do taskset -pc 0-7 $i &gt;&gt; $logPath; done fi exit 0</code></pre></div><p>What works:<br />- primary spice graphics with keyboard/mouse grab and usb redirection<br />- usb redirection (I&#039;m using a sript forr ssh-ing into host through putty and disconnect my redirected keyb/mouse from guset with doubleclick, the same in host for redirection back in live guest)<br />- secondary passed through NV660Ti quadrified to K4000 with latest drivers in guest<br />- GPU performance 100% (weirdly sometimes above this as compared to native win install, probably some timing issues)<br />- CPU performance allmost 100% (6 cores), depends on applications<br />- HDD performace is great, also using partition passthrough, but not as boot drive - there are references in this thread on how to achieve that<br />- audio through pulseaudio daemon without a need to have connected client, also the HD audio on card is working fine<br />- no BSODs or lockups at all, very stable</p><p>What doesnt:<br />- in latest OMVF config the machine isn’t able to reboot, instead a new boot it just shuts down (correctly though)<br />- one anomaly is that without quadryfying my card the guest thinks that it is in pcieX1 mode, although on host I see it in full x16, after changing IDs and ROM for guest everything is ok<br />- there is a lot of host kernel time in some games during loading (not iowait) which causes temporary lagging, it seems according to perf that it is caused by _raw_spin_lock which could hint on multiple guest threads racing for timer gets - here I&#039;m stuck but its not a game breaker. According to some of the posts here this could be AMD specific. Still looking for solution, if its possible.</p><p>Also tried and worked combinations:<br />linux guests, Win7, i440fx, q35, qemu cmd line, few low-end AMD and Nvidia cards</p><p>Some of the config parts maybe leftovers from previous tests, not everything is necessary for working configuration<br />Hope some of this info is usefull. Thanks all.</p><p>edit:<br />corrected module name to pci-back - thats what I&#039;m using because of the two identical cards, added (dirty) hook script</p> <p class="postedit"><em>Last edited by JohnyPea (2014-12-23 12:36:36)</em></p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1486869">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1486926" class="blockpost roweven"> <h2><span><span class="conr">#3654</span> <a href="viewtopic.php?pid=1486926#p1486926">2014-12-23 16:10:45</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=85314">Duelist</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2014-09-22</span></dd> <dd><span>Posts: 358</span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>JohnyPea wrote:</cite><blockquote><div><p>&#160; &lt;on_reboot&gt;destroy&lt;/on_reboot&gt;<br />- in latest OMVF config the machine isn’t able to reboot, instead a new boot it just shuts down (correctly though)</p></div></blockquote></div><p>Errr, isn&#039;t that&#039;s the way it&#039;s supposed to work? Also, great setup, great info. Thanks. I think i&#039;m going to adapt some of your settings for my system.</p><p>By the way, what benchmarks did you use to check CPU and GPU performance?</p> </div> <div class="postsignature postmsg"><hr /><p><span class="bbs">The forum rules prohibit requesting support for distributions other than arch.</span><br /><a href="https://bbs.archlinux.org/viewtopic.php?pid=1551460#p1551460" rel="nofollow">I gave up.</a><a href="https://bbs.archlinux.org/viewtopic.php?id=162768" rel="nofollow"> It was too late.</a><br /><a href="http://pastebin.com/B3fL84bq" rel="nofollow">What I was trying to do</a>.<br /><a href="http://vfio.blogspot.com/" rel="nofollow">The reference about VFIO and KVM VGA passthrough.</a></p></div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1486926">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1486945" class="blockpost rowodd"> <h2><span><span class="conr">#3655</span> <a href="viewtopic.php?pid=1486945#p1486945">2014-12-23 18:15:10</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=83627">JohnyPea</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2014-07-17</span></dd> <dd><span>Posts: 17</span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>Duelist wrote:</cite><blockquote><div><div class="quotebox"><cite>JohnyPea wrote:</cite><blockquote><div><p>&#160; &lt;on_reboot&gt;destroy&lt;/on_reboot&gt;<br />- in latest OMVF config the machine isn’t able to reboot, instead a new boot it just shuts down (correctly though)</p></div></blockquote></div><p>Errr, isn&#039;t that&#039;s the way it&#039;s supposed to work? Also, great setup, great info. Thanks. I think i&#039;m going to adapt some of your settings for my system.</p><p>By the way, what benchmarks did you use to check CPU and GPU performance?</p></div></blockquote></div><p>OMFG, i&#039;m an idiot. Time to learn how to read again. Thank you very much.<br />I tried a lot of benchmarks, but basic synthetic ones were SuperPI, Furmark, Fluidmark. For drive performance ATTO disk benchmak. In Win7, I was comparing also builtin performance evaluation. (its possible in Win8, but its too much hassle for me). Also for guite a while I was using benchmark with Metro: Last Light - when the physics engine was acting weird, it is heavy on resources and most errors in machine config manifested even when synthetic benchmarks were running fine.<br />Noticed just now, that I left a Virtio SCSI disk types in the mentioned guest config. This way the iothreads config part isn&#039;t working (only with virtio). AFAIK the SCSI is goot only for trim operations in win guest and single virtual controller for multiple drives for now. Not performance gains. Virtio type is probably a better choice.<br />If you find anything usefull, I&#039;m glad I could help.<br />edit: added ATTO benchmark</p> <p class="postedit"><em>Last edited by JohnyPea (2014-12-23 18:36:24)</em></p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1486945">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1487038" class="blockpost roweven"> <h2><span><span class="conr">#3656</span> <a href="viewtopic.php?pid=1487038#p1487038">2014-12-24 06:47:15</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=87484">kainet</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2014-12-22</span></dd> <dd><span>Posts: 9</span></dd> <dd class="usercontacts"><span class="email"><a href="mailto:bart47@gmail.com">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <p>I managed to install latest nvidia drivers (344.75) on Windows 7 (32 bit) and everything looks ok. Still trying to install driver on Windows 7 64 bit. Still using unpatched kernel and qemu (2.1) from debian wheezy-backports repository.</p><p>P.S. Simple tutorial how to compile kernel with optimisations for vm in debian&#160; <a href="http://edencomputing.com/index.php/2014/04/qemukvm-with-gpu-passthrough-kernel-recompile-the-debian-way/" rel="nofollow">http://edencomputing.com/index.php/2014 … ebian-way/</a></p> <p class="postedit"><em>Last edited by kainet (2014-12-24 07:06:03)</em></p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1487038">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1487041" class="blockpost rowodd"> <h2><span><span class="conr">#3657</span> <a href="viewtopic.php?pid=1487041#p1487041">2014-12-24 07:04:58</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=87435">ailcp</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2014-12-20</span></dd> <dd><span>Posts: 4</span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>Duelist wrote:</cite><blockquote><div><p>750Ti is better than HD7750 or rare R7 250E. It eats less power, works faster, heats less. It should work. HD7750 isn&#039;t compatible with UEFI out-of-the-box, while 750Ti is.(aw has 750 too) Is there any related messages related to VFIO or your GPU in dmesg? Or, maybe, windows doesn&#039;t enable MSI? Can you show us &quot;sudo lspci -v&quot; when your VM is running?</p></div></blockquote></div><p>I got the &quot;AMD-Vi: Event logged [IO_PAGE_FAULT device=01:00.0&quot; error when the VM is running.&#160; Besides, I borrowed a i5-4460 and H97 motherboard for testing and turned out the same 750Ti worked smoothly on that machine with the same XML.&#160; I guess the code 43 error really lies with FM2/FM2+&#160; CPU + Motherboard + Nvidia GPU combo.&#160; Looking at the google doc again, there is a user &quot;Renfast&quot; who tested two FM2+ motherboard.&#160; He/She was successful with the HD7970 but not the GTX 680.</p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1487041">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1487068" class="blockpost roweven"> <h2><span><span class="conr">#3658</span> <a href="viewtopic.php?pid=1487068#p1487068">2014-12-24 10:17:55</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=87515">qquark</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2014-12-24</span></dd> <dd><span>Posts: 2</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=87515">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <p>Hi everyone,</p><p>I&#039;m thinking of doing a similar setup, but before starting messing with my system, I wanted to make sure that I&#039;m not wasting my time; I have a few questions that someone here might be able to answer, as I wasn&#039;t able to google the answers unfortunately:</p><br /><p>I currently have a P6T motherboard with shitty DMAR tables, changing it is not an option, and I sent a support request to Asus, but I don&#039;t have any satisfying answer yet (and probably won&#039;t get one). There are rumors of a &quot;beta&quot; bios working, but trying to find any info about it seems like a dead end from what I saw for now.</p><p>I noticed that apparently one of the RMRR entries is correct, and the other one is not. <br />Since this is very easy to do, I enabled intel_iommu=on to see what happens, and Linux tells me that while setting up identity mappings it detected that my bios is broken (true, true ...); *however*, after a lengthy log full of call stacks about the devices it tried to map at the second RMRR entry, I get a log showing success (or at least no error) for those same devices at the first RMRR entry.</p><p>My first question from this result is whether I have a chance of getting VGA passthrough working in those conditions (?). <br />Can Linux manage to work with only one entry by ignoring the error in the other ? (assuming the first one is correct AND working) ? And Is there a way to override this entry (I do not know what the RMRR actually represents, but I suspect the answer would be negative).<br />Also, in my dmesg log, I only find this identity mapping happening for the USB controller devices (or subdevices ?), should I also expect to see my current graphics card there ?</p><br /><p>Second topic: I see that most people are generally using setups with {intel,ATI}+{nvidia,ATI}, but I would like to know if there is any problem with an nvidia+nvidia setup (?), as I only have a spare 9800GT I can try in addition to my GTX660, and do not have any recent extra ATI card, nor an integrated intel GP (i7 920). From what I thought I understood, just being able to unbind/rebind the appropriate card should be enough to remove any conflict between host and guest, why are people also blacklisting drivers ? Do they interfere even though they&#039;re not bound to the card ? Or is it just an easier way to do boot-time non-binding ?</p><br /><p>Thanks for any help in advance !</p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1487068">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1487071" class="blockpost rowodd"> <h2><span><span class="conr">#3659</span> <a href="viewtopic.php?pid=1487071#p1487071">2014-12-24 10:32:12</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=82442">slis</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2014-06-02</span></dd> <dd><span>Posts: 125</span></dd> <dd class="usercontacts"><span class="email"><a href="mailto:xslisx@gmail.com">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <p>I can only help you with second topic.<br />You can use any combination, but you need to patch nvidia host driver for nvidia+nvidia etc... (same/similar goes for radeon).<br />People blacklist driver instead of using pci-stub I guess to achieve same effect easier (works if u don&#039;t have both cards that use same driver).</p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1487071">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1487076" class="blockpost roweven"> <h2><span><span class="conr">#3660</span> <a href="viewtopic.php?pid=1487076#p1487076">2014-12-24 10:48:34</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=87515">qquark</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2014-12-24</span></dd> <dd><span>Posts: 2</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=87515">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <p>I see, thanks !</p><p>That&#039;s a step in the right direction <img src="https://bbs.archlinux.org/img/smilies/smile.png" width="15" height="15" alt="smile" /></p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1487076">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1487085" class="blockpost rowodd"> <h2><span><span class="conr">#3661</span> <a href="viewtopic.php?pid=1487085#p1487085">2014-12-24 11:50:02</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=87519">Jimaklas</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2014-12-24</span></dd> <dd><span>Posts: 2</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=87519">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <p>Hello there, congratulations on the excellent advice and information found in this thread, it is by far the most helpful corner of the net as far as VGA Passthrough with KVM is concerned! Following the guide in the OP and solving most of my problems by searching the thread i managed to successfully pass my PCIe VGA adapter to a VM. By &quot;successfully&quot; i mean that there are no error messages issued during VM script execution. My problem is that i get no VGA output on the passthrough-ed card. Let me be more specific:</p><p>Motherboard: Intel DQ45CB (supports Intel&#039;s virtualization extensions + VT-d)<br />CPU: Intel Core2 Quad Q9450 @ 2.66GHz (supports Intel&#039;s virtualization extensions + VT-d)<br />GPU1: on chip Intel GMA 4500 (set as primary in BIOS)<br />GPU2: Nvidia GTX 550 Ti (passed-through in the VM)<br />RAM: 8GB Dual Channel DDR2<br />OS: openSuSE 13.2 x86_64</p><p>qemu: 2.1.0<br />seabios: 1.7.5 (also tried the git version)<br />kernel: 3.18.1 with acs override + i915 vga arbiter patches applied</p><p>I have patched the kernel with the patches provided in the OP (as found in linux-mainline-3.18.0.tar.gz), patch process went fine although i use kernel 3.18.1 instead of 3.18.0.<br />Some relevant kernel configuration parameters:</p><div class="codebox"><pre><code>dimitris@openSuSE:~&gt; cat /proc/config.gz | gzip -d | grep -e CONFIG_VIRTUALIZATION= -e CONFIG_KVM= -e CONFIG_KVM_INTEL= -e CONFIG_PCI_STUB= -e CONFIG_VFIO= -e CONFIG_VFIO_PCI= -e CONFIG_VFIO_PCI_VGA= -e CONFIG_VHOST_NET= -e CONFIG_VIRTIO_PCI= -e CONFIG_VIRTIO_BALLOON= -e CONFIG_VGA_ARB= CONFIG_PCI_STUB=y CONFIG_VHOST_NET=m CONFIG_VGA_ARB=y CONFIG_VFIO=y CONFIG_VFIO_PCI=y CONFIG_VFIO_PCI_VGA=y CONFIG_VIRTIO_PCI=m CONFIG_VIRTIO_BALLOON=m CONFIG_VIRTUALIZATION=y CONFIG_KVM=y CONFIG_KVM_INTEL=y</code></pre></div><p>I am booting the kernel with:</p><div class="codebox"><pre><code>dimitris@openSuSE:~&gt; cat /proc/cmdline BOOT_IMAGE=/boot/vmlinuz-3.18.1-2.kvmpcipass-desktop root=UUID=4b1fbf1a-5770-4424-8609-a2b384ce6c41 resume=/dev/disk/by-uuid/2b281131-8310-48d9-94a0-9f81531469f3 splash=silent quiet showopts drm_kms_helper.edid_firmware=VGA-1:edid/lg-L1982U.bin pci-stub.ids=10de:1244,10de:0bee intel_iommu=on vfio_iommu_type1.allow_unsafe_interrupts=1 i915.enable_hd_vgaarb=1</code></pre></div><p>I am using a VGA bios from <a href="http://www.techpowerup.com/vgabios/index.php?architecture=NVIDIA&amp;manufacturer=Gigabyte&amp;model=GTX+550+Ti&amp;interface=&amp;memType=&amp;memSize=" rel="nofollow"> techpowerup site </a> which compares equal to the VGA bios that i extracted from the card itself.</p><p>I am using the following script to boot the VM:</p><div class="codebox"><pre><code>#!/bin/bash /usr/bin/qemu-system-x86_64 \ -enable-kvm -M q35 -m 4096 -cpu host \ -smp 2,sockets=1,cores=2,threads=1 \ -bios /home/dimitris/Documents/build/seabios/out/bios.bin \ -vga none \ -device ioh3420,bus=pcie.0,addr=1c.0,multifunction=on,port=1,chassis=1,id=root.1 \ -device vfio-pci,host=01:00.0,bus=root.1,addr=00.0,multifunction=on,x-vga=on,romfile=/home/dimitris/Gigabyte.GTX550Ti.1024.111121.rom \ -device vfio-pci,host=01:00.1,bus=root.1,addr=00.1</code></pre></div><p>and i am getting no output on the monitor attached to the Nvidia card (tried VGA, DVI and HDMI connections).</p><p>All searches lead me to the answer: &quot;patch your kernel with i915 vga arbiter patch and enable it in the kernel command line of grub&quot;.<br />As far as i can understand, since the patch is already applied (CONFIG_VGA_ARB=y) and the grub command line includes i915.enable_hd_vgaarb=1, i should already have VGA output on my passed-through card.</p><p>I also tried to pass the card as secondary adapter:</p><div class="codebox"><pre><code>#!/bin/bash /usr/bin/qemu-system-x86_64 \ -enable-kvm -M q35 -m 4096 -cpu host \ -smp 2,sockets=1,cores=2,threads=1 \ -bios /home/dimitris/Documents/build/seabios/out/bios.bin \ -device ioh3420,bus=pcie.0,addr=1c.0,multifunction=on,port=1,chassis=1,id=root.1 \ -device vfio-pci,host=01:00.0,bus=root.1,addr=00.0,multifunction=on,x-vga=on,romfile=/home/dimitris/Gigabyte.GTX550Ti.1024.111121.rom \ -device vfio-pci,host=01:00.1,bus=root.1,addr=00.1 \ -device virtio-scsi-pci,id=scsi \ -drive file=/dev/mapper/os-win7,id=disk,format=raw -device scsi-hd,drive=disk \ -drive file=/home/dimitris/Downloads/GRMCPRXFREO_EL_DVD.iso,id=isocd -device scsi-cd,drive=isocd \ -drive file=/home/dimitris/Downloads/virtio-win-0.1-94.iso,id=virtiocd -device ide-cd,bus=ide.1,drive=virtiocd</code></pre></div><p>in which case the VM booted normally, Windows installation completed and the card could be seen in device manager. The Nvidia driver installation finished successfully (tried both 331.82 and 344.75) but the card was giving Error Code 12 mentioning that there are not enough resources to allocate to it. Then i <span class="bbs">removed</span> used the &quot;-vga none&quot; parameter and rebooted with no output from the card. This problem (Error Code 12 in windows device manager) was caused to another user of this thread because he hadn&#039;t applied the i915 vga arbiter patch to his kernel and was solved after the patch was applied. It seems the patch doesn&#039;t get activated in my situation and i am clueless as to why this could be happening. Any ideas?</p> <p class="postedit"><em>Last edited by Jimaklas (2014-12-24 14:01:50)</em></p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1487085">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1487121" class="blockpost roweven"> <h2><span><span class="conr">#3662</span> <a href="viewtopic.php?pid=1487121#p1487121">2014-12-24 15:17:04</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=85314">Duelist</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2014-09-22</span></dd> <dd><span>Posts: 358</span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>ailcp wrote:</cite><blockquote><div><div class="quotebox"><cite>Duelist wrote:</cite><blockquote><div><p>750Ti is better than HD7750 or rare R7 250E. It eats less power, works faster, heats less. It should work. HD7750 isn&#039;t compatible with UEFI out-of-the-box, while 750Ti is.(aw has 750 too) Is there any related messages related to VFIO or your GPU in dmesg? Or, maybe, windows doesn&#039;t enable MSI? Can you show us &quot;sudo lspci -v&quot; when your VM is running?</p></div></blockquote></div><p>I got the &quot;AMD-Vi: Event logged [IO_PAGE_FAULT device=01:00.0&quot; error when the VM is running.&#160; Besides, I borrowed a i5-4460 and H97 motherboard for testing and turned out the same 750Ti worked smoothly on that machine with the same XML.&#160; I guess the code 43 error really lies with FM2/FM2+&#160; CPU + Motherboard + Nvidia GPU combo.&#160; Looking at the google doc again, there is a user &quot;Renfast&quot; who tested two FM2+ motherboard.&#160; He/She was successful with the HD7970 but not the GTX 680.</p></div></blockquote></div><p>Try -realtime mlock=on and having firefox(or chrome or whatever) eating enough memory, just about 1.5G.</p> </div> <div class="postsignature postmsg"><hr /><p><span class="bbs">The forum rules prohibit requesting support for distributions other than arch.</span><br /><a href="https://bbs.archlinux.org/viewtopic.php?pid=1551460#p1551460" rel="nofollow">I gave up.</a><a href="https://bbs.archlinux.org/viewtopic.php?id=162768" rel="nofollow"> It was too late.</a><br /><a href="http://pastebin.com/B3fL84bq" rel="nofollow">What I was trying to do</a>.<br /><a href="http://vfio.blogspot.com/" rel="nofollow">The reference about VFIO and KVM VGA passthrough.</a></p></div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1487121">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1487122" class="blockpost rowodd"> <h2><span><span class="conr">#3663</span> <a href="viewtopic.php?pid=1487122#p1487122">2014-12-24 15:22:57</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=85314">Duelist</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2014-09-22</span></dd> <dd><span>Posts: 358</span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>Jimaklas wrote:</cite><blockquote><div><p>All searches lead me to the answer: &quot;patch your kernel with i915 vga arbiter patch and enable it in the kernel command line of grub&quot;.<br />As far as i can understand, since the patch is already applied (CONFIG_VGA_ARB=y) and the grub command line includes i915.enable_hd_vgaarb=1, i should already have VGA output on my passed-through card.</p></div></blockquote></div><p>As far as i know, i915 vgaarb patch isn&#039;t upstream yet, so you&#039;ll need to MANUALLY patch the kernel with, you know, patch command.<br />Config option isn&#039;t much related to it, it just enables any vga arbitration, and you need fixes from the patch to get i915&#039;s vgaarb logic working.</p><p>BTW, nice to see that this tech works on older, socket775 platforms too.</p> </div> <div class="postsignature postmsg"><hr /><p><span class="bbs">The forum rules prohibit requesting support for distributions other than arch.</span><br /><a href="https://bbs.archlinux.org/viewtopic.php?pid=1551460#p1551460" rel="nofollow">I gave up.</a><a href="https://bbs.archlinux.org/viewtopic.php?id=162768" rel="nofollow"> It was too late.</a><br /><a href="http://pastebin.com/B3fL84bq" rel="nofollow">What I was trying to do</a>.<br /><a href="http://vfio.blogspot.com/" rel="nofollow">The reference about VFIO and KVM VGA passthrough.</a></p></div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1487122">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1487130" class="blockpost roweven"> <h2><span><span class="conr">#3664</span> <a href="viewtopic.php?pid=1487130#p1487130">2014-12-24 16:16:40</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=87519">Jimaklas</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2014-12-24</span></dd> <dd><span>Posts: 2</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=87519">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>Duelist wrote:</cite><blockquote><div><div class="quotebox"><cite>Jimaklas wrote:</cite><blockquote><div><p>All searches lead me to the answer: &quot;patch your kernel with i915 vga arbiter patch and enable it in the kernel command line of grub&quot;.<br />As far as i can understand, since the patch is already applied (CONFIG_VGA_ARB=y) and the grub command line includes i915.enable_hd_vgaarb=1, i should already have VGA output on my passed-through card.</p></div></blockquote></div><p>As far as i know, i915 vgaarb patch isn&#039;t upstream yet, so you&#039;ll need to MANUALLY patch the kernel with, you know, patch command.<br />Config option isn&#039;t much related to it, it just enables any vga arbitration, and you need fixes from the patch to get i915&#039;s vgaarb logic working.</p><p>BTW, nice to see that this tech works on older, socket775 platforms too.</p></div></blockquote></div><p>I am sorry i wasn&#039;t clear enough in the 1st post. Indeed, the i915 vgaarb patch isn&#039;t upstream yet, so i have actually patched the kernel myself. The patch process went like a breeze and i have also checked that every relevant file is patched according to the diffs (i also diffed the patched files against the originals and got the diffs i applied with the above patch). Is there a way to tell if the patch indeed does it&#039;s job? Here is dmesg output in case it helps:</p><div class="codebox"><pre><code>dimitris@openSuSE:~&gt; dmesg | grep -i vgaarb [ 0.000000] Command line: BOOT_IMAGE=/boot/vmlinuz-3.18.1-2.kvmpcipass-desktop root=UUID=4b1fbf1a-5770-4424-8609-a2b384ce6c41 resume=/dev/disk/by-uuid/2b281131-8310-48d9-94a0-9f81531469f3 splash=silent quiet showopts drm_kms_helper.edid_firmware=VGA-1:edid/lg-L1982U.bin pci-stub.ids=10de:1244,10de:0bee intel_iommu=on vfio_iommu_type1.allow_unsafe_interrupts=1 i915.enable_hd_vgaarb=1 [ 0.000000] Kernel command line: BOOT_IMAGE=/boot/vmlinuz-3.18.1-2.kvmpcipass-desktop root=UUID=4b1fbf1a-5770-4424-8609-a2b384ce6c41 resume=/dev/disk/by-uuid/2b281131-8310-48d9-94a0-9f81531469f3 splash=silent quiet showopts drm_kms_helper.edid_firmware=VGA-1:edid/lg-L1982U.bin pci-stub.ids=10de:1244,10de:0bee intel_iommu=on vfio_iommu_type1.allow_unsafe_interrupts=1 i915.enable_hd_vgaarb=1 [ 0.115067] vgaarb: setting as boot device: PCI:0000:00:02.0 [ 0.115067] vgaarb: device added: PCI:0000:00:02.0,decodes=io+mem,owns=io+mem,locks=none [ 0.115067] vgaarb: device added: PCI:0000:01:00.0,decodes=io+mem,owns=none,locks=none [ 0.115067] vgaarb: loaded [ 0.115067] vgaarb: bridge control possible 0000:01:00.0 [ 0.115067] vgaarb: no bridge control possible 0000:00:02.0 [ 4.249183] vgaarb: device changed decodes: PCI:0000:00:02.0,olddecodes=io+mem,decodes=none:owns=io+mem</code></pre></div><p>Yes KVM passthrough works on socket 775 platforms and is effectively a quite cheap solution with very decent performance <img src="https://bbs.archlinux.org/img/smilies/wink.png" width="15" height="15" alt="wink" /></p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1487130">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1487137" class="blockpost rowodd"> <h2><span><span class="conr">#3665</span> <a href="viewtopic.php?pid=1487137#p1487137">2014-12-24 16:45:04</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=87525">Silar</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2014-12-24</span></dd> <dd><span>Posts: 2</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=87525">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <p>Hi guys! I just start playing around with VM and KVM&#160; VGA-Passthrough<br />My Hardware<br />OS: Latest Arch Linux with patched kernel from the first post (linux-mainline-3.18.0)<br />MB: Asrock Z68 Gen3 Extreme 3<br />CPU: i7 3770<br />Host GPU: Intel HD <br />Guest: GPU: nVidia GTX560Ti</p><p>I start qemu with the following parameters:</p><div class="codebox"><pre><code>qemu-system-x86_64 -enable-kvm -M q35 -m 8192 -cpu host \ -smp 6,sockets=1,cores=6,threads=1 \ -vga none \ -device ioh3420,bus=pcie.0,addr=1c.0,multifunction=on,port=1,chassis=1,id=root. -device vfio-pci,host=01:00.0,bus=root.1,addr=00.0,multifunction=on,x-vga=on \ -device vfio-pci,host=01:00.1,bus=root.1,addr=00.1 \ -device vfio-pci,host=00:1a.0,bus=pcie.0 \ -device virtio-scsi-pci,id=scsi \ -drive file=/mnt/windows.img,id=windisk,format=raw,if=virtio</code></pre></div><p>The first time i start the VM everything is ok. But after the guest was shutdown and start again I get this error:</p><div class="codebox"><pre><code>qemu-system-x86_64: vfio-pci: Cannot read device rom at 0000:01:00.0 Device option ROM contents are probably invalid (check dmesg). Skip option ROM probe with rombar=0, or load from file with romfile=</code></pre></div><p>dmesg also says:</p><div class="codebox"><pre><code>[ 3496.604688] vfio-pci 0000:00:1a.0: enabling device (0400 -&gt; 0402) [ 3496.707482] vfio_cap_init: 0000:00:1a.0 hiding cap 0xa [ 3500.034452] vfio-pci 0000:01:00.0: Invalid ROM contents [ 3500.883294] kvm: zapping shadow pages for mmio generation wraparound</code></pre></div><p>Does anybody know this error and can help me to fix it?</p><p>A second question:</p><p>I use qemu-git from AUR. How can i use -cpu kvm=off to hide the hypervisor to install latest nvidia driver?</p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1487137">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1487138" class="blockpost roweven"> <h2><span><span class="conr">#3666</span> <a href="viewtopic.php?pid=1487138#p1487138">2014-12-24 16:49:03</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=75590">aw</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2013-10-04</span></dd> <dd><span>Posts: 921</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=75590">Email</a></span> <span class="website"><a href="http://vfio.blogspot.com/" rel="nofollow">Website</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>qquark wrote:</cite><blockquote><div><p>I noticed that apparently one of the RMRR entries is correct, and the other one is not. <br />Since this is very easy to do, I enabled intel_iommu=on to see what happens, and Linux tells me that while setting up identity mappings it detected that my bios is broken (true, true ...); *however*, after a lengthy log full of call stacks about the devices it tried to map at the second RMRR entry, I get a log showing success (or at least no error) for those same devices at the first RMRR entry.</p><p>My first question from this result is whether I have a chance of getting VGA passthrough working in those conditions (?). <br />Can Linux manage to work with only one entry by ignoring the error in the other ? (assuming the first one is correct AND working) ? And Is there a way to override this entry (I do not know what the RMRR actually represents, but I suspect the answer would be negative).<br />Also, in my dmesg log, I only find this identity mapping happening for the USB controller devices (or subdevices ?), should I also expect to see my current graphics card there ?</p></div></blockquote></div><p>RMRRs (Reserved Memory Region Reporting) entries in the DMAR table are things that should see very little use, typically only USB and integrated graphics.&#160; They tell the IOMMU driver to configure a persistent identity map for the specified memory range and device(s).&#160; Google&#039;ing for the problem on this system seems to indicate that the RMRR points to a memory region that isn&#039;t listed as reserved by the e820 table.&#160; If that&#039;s the only problem, you could fix it using this following boot option:</p><div class="codebox"><pre><code> memmap=nn[KMG]$ss[KMG] [KNL,ACPI] Mark specific memory as reserved. Region of memory to be reserved is from ss to ss+nn. Example: Exclude memory from 0x18690000-0x1869ffff memmap=64K$0x18690000 or memmap=0x10000$0x18690000</code></pre></div><div class="quotebox"><blockquote><div><p>Second topic: I see that most people are generally using setups with {intel,ATI}+{nvidia,ATI}, but I would like to know if there is any problem with an nvidia+nvidia setup (?), as I only have a spare 9800GT I can try in addition to my GTX660, and do not have any recent extra ATI card, nor an integrated intel GP (i7 920). From what I thought I understood, just being able to unbind/rebind the appropriate card should be enough to remove any conflict between host and guest, why are people also blacklisting drivers ? Do they interfere even though they&#039;re not bound to the card ? Or is it just an easier way to do boot-time non-binding ?</p></div></blockquote></div><p>Don&#039;t expect that you can bind/unbind graphics cards from their driver as easily as you can a NIC.&#160; That&#039;s why people generally use pci-stub.ids= to make the stub driver claim devices rather than the host graphics driver.&#160; As long as the two cards have different device IDs, which they obviously will in this case, there&#039;s no problem using a host and assigned GPU by the same vendor.&#160; Note that there have been an maybe still are issues with using nvidia in the host regardless of the second card due to VGA arbiter locking.&#160; nouveau shouldn&#039;t be an issue.&#160; Ideally with a GTX660 you can get a UEFI ROM for it and use OVMF.</p> </div> <div class="postsignature postmsg"><hr /><p><a href="http://vfio.blogspot.com" rel="nofollow">http://vfio.blogspot.com</a><br />Looking for a more open forum to discuss vfio related uses?&#160; Try <a href="https://www.redhat.com/mailman/listinfo/vfio-users" rel="nofollow">https://www.redhat.com/mailman/listinfo/vfio-users</a></p></div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1487138">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1487143" class="blockpost rowodd"> <h2><span><span class="conr">#3667</span> <a href="viewtopic.php?pid=1487143#p1487143">2014-12-24 17:00:39</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=75590">aw</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2013-10-04</span></dd> <dd><span>Posts: 921</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=75590">Email</a></span> <span class="website"><a href="http://vfio.blogspot.com/" rel="nofollow">Website</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>Jimaklas wrote:</cite><blockquote><div><p>Hello there, congratulations on the excellent advice and information found in this thread, it is by far the most helpful corner of the net as far as VGA Passthrough with KVM is concerned! Following the guide in the OP and solving most of my problems by searching the thread i managed to successfully pass my PCIe VGA adapter to a VM. By &quot;successfully&quot; i mean that there are no error messages issued during VM script execution. My problem is that i get no VGA output on the passthrough-ed card. Let me be more specific:</p><p>Motherboard: Intel DQ45CB (supports Intel&#039;s virtualization extensions + VT-d)<br />CPU: Intel Core2 Quad Q9450 @ 2.66GHz (supports Intel&#039;s virtualization extensions + VT-d)<br />GPU1: on chip Intel GMA 4500 (set as primary in BIOS)<br />GPU2: Nvidia GTX 550 Ti (passed-through in the VM)<br />RAM: 8GB Dual Channel DDR2<br />OS: openSuSE 13.2 x86_64</p><p>qemu: 2.1.0<br />seabios: 1.7.5 (also tried the git version)<br />kernel: 3.18.1 with acs override + i915 vga arbiter patches applied</p></div></blockquote></div><p>You may be in a unique situation with this dinosaur.&#160; The i915 patch fixes VGA arbitration for CPU integrated Intel graphics.&#160; Your graphics is integrated into the chipset, not the CPU, so I don&#039;t expect the i915 or kernel boot option is going to help you.&#160; If you&#039;re not getting VGA output, then it&#039;s possible that Intel broke VGA routing even prior to the switch from PCH to CPU based IGD.&#160; IOW, you&#039;re probably out of luck unless you&#039;re able to do some debugging on your own.&#160; Your options with this system would be to disable integrated graphics and use a discrete card for the host or use an assigned GPU and guest capable of going the UEFI/OVMF route.</p> </div> <div class="postsignature postmsg"><hr /><p><a href="http://vfio.blogspot.com" rel="nofollow">http://vfio.blogspot.com</a><br />Looking for a more open forum to discuss vfio related uses?&#160; Try <a href="https://www.redhat.com/mailman/listinfo/vfio-users" rel="nofollow">https://www.redhat.com/mailman/listinfo/vfio-users</a></p></div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1487143">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1487144" class="blockpost roweven"> <h2><span><span class="conr">#3668</span> <a href="viewtopic.php?pid=1487144#p1487144">2014-12-24 17:01:22</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=75590">aw</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2013-10-04</span></dd> <dd><span>Posts: 921</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=75590">Email</a></span> <span class="website"><a href="http://vfio.blogspot.com/" rel="nofollow">Website</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>Duelist wrote:</cite><blockquote><div><div class="quotebox"><cite>ailcp wrote:</cite><blockquote><div><div class="quotebox"><cite>Duelist wrote:</cite><blockquote><div><p>750Ti is better than HD7750 or rare R7 250E. It eats less power, works faster, heats less. It should work. HD7750 isn&#039;t compatible with UEFI out-of-the-box, while 750Ti is.(aw has 750 too) Is there any related messages related to VFIO or your GPU in dmesg? Or, maybe, windows doesn&#039;t enable MSI? Can you show us &quot;sudo lspci -v&quot; when your VM is running?</p></div></blockquote></div><p>I got the &quot;AMD-Vi: Event logged [IO_PAGE_FAULT device=01:00.0&quot; error when the VM is running.&#160; Besides, I borrowed a i5-4460 and H97 motherboard for testing and turned out the same 750Ti worked smoothly on that machine with the same XML.&#160; I guess the code 43 error really lies with FM2/FM2+&#160; CPU + Motherboard + Nvidia GPU combo.&#160; Looking at the google doc again, there is a user &quot;Renfast&quot; who tested two FM2+ motherboard.&#160; He/She was successful with the HD7970 but not the GTX 680.</p></div></blockquote></div><p>Try -realtime mlock=on and having firefox(or chrome or whatever) eating enough memory, just about 1.5G.</p></div></blockquote></div><p>This sounds an awful lot like voodoo</p> </div> <div class="postsignature postmsg"><hr /><p><a href="http://vfio.blogspot.com" rel="nofollow">http://vfio.blogspot.com</a><br />Looking for a more open forum to discuss vfio related uses?&#160; Try <a href="https://www.redhat.com/mailman/listinfo/vfio-users" rel="nofollow">https://www.redhat.com/mailman/listinfo/vfio-users</a></p></div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1487144">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1487146" class="blockpost rowodd"> <h2><span><span class="conr">#3669</span> <a href="viewtopic.php?pid=1487146#p1487146">2014-12-24 17:05:59</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=75590">aw</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2013-10-04</span></dd> <dd><span>Posts: 921</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=75590">Email</a></span> <span class="website"><a href="http://vfio.blogspot.com/" rel="nofollow">Website</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>Silar wrote:</cite><blockquote><div><p>Hi guys! I just start playing around with VM and KVM&#160; VGA-Passthrough<br />My Hardware<br />OS: Latest Arch Linux with patched kernel from the first post (linux-mainline-3.18.0)<br />MB: Asrock Z68 Gen3 Extreme 3<br />CPU: i7 3770<br />Host GPU: Intel HD <br />Guest: GPU: nVidia GTX560Ti</p><p>I start qemu with the following parameters:</p><div class="codebox"><pre><code>qemu-system-x86_64 -enable-kvm -M q35 -m 8192 -cpu host \ -smp 6,sockets=1,cores=6,threads=1 \ -vga none \ -device ioh3420,bus=pcie.0,addr=1c.0,multifunction=on,port=1,chassis=1,id=root. -device vfio-pci,host=01:00.0,bus=root.1,addr=00.0,multifunction=on,x-vga=on \ -device vfio-pci,host=01:00.1,bus=root.1,addr=00.1 \ -device vfio-pci,host=00:1a.0,bus=pcie.0 \ -device virtio-scsi-pci,id=scsi \ -drive file=/mnt/windows.img,id=windisk,format=raw,if=virtio</code></pre></div><p>The first time i start the VM everything is ok. But after the guest was shutdown and start again I get this error:</p><div class="codebox"><pre><code>qemu-system-x86_64: vfio-pci: Cannot read device rom at 0000:01:00.0 Device option ROM contents are probably invalid (check dmesg). Skip option ROM probe with rombar=0, or load from file with romfile=</code></pre></div><p>dmesg also says:</p><div class="codebox"><pre><code>[ 3496.604688] vfio-pci 0000:00:1a.0: enabling device (0400 -&gt; 0402) [ 3496.707482] vfio_cap_init: 0000:00:1a.0 hiding cap 0xa [ 3500.034452] vfio-pci 0000:01:00.0: Invalid ROM contents [ 3500.883294] kvm: zapping shadow pages for mmio generation wraparound</code></pre></div><p>Does anybody know this error and can help me to fix it?</p></div></blockquote></div><p>Dump the ROM or get it from techpowerup database and use the romfile= option to provide the ROM to the guest.</p> </div> <div class="postsignature postmsg"><hr /><p><a href="http://vfio.blogspot.com" rel="nofollow">http://vfio.blogspot.com</a><br />Looking for a more open forum to discuss vfio related uses?&#160; Try <a href="https://www.redhat.com/mailman/listinfo/vfio-users" rel="nofollow">https://www.redhat.com/mailman/listinfo/vfio-users</a></p></div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1487146">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1487150" class="blockpost roweven"> <h2><span><span class="conr">#3670</span> <a href="viewtopic.php?pid=1487150#p1487150">2014-12-24 17:19:38</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=85314">Duelist</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2014-09-22</span></dd> <dd><span>Posts: 358</span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>aw wrote:</cite><blockquote><div><div class="quotebox"><cite>Duelist wrote:</cite><blockquote><div><div class="quotebox"><cite>ailcp wrote:</cite><blockquote><div><p>I got the &quot;AMD-Vi: Event logged [IO_PAGE_FAULT device=01:00.0&quot; error when the VM is running.&#160; Besides, I borrowed a i5-4460 and H97 motherboard for testing and turned out the same 750Ti worked smoothly on that machine with the same XML.&#160; I guess the code 43 error really lies with FM2/FM2+&#160; CPU + Motherboard + Nvidia GPU combo.&#160; Looking at the google doc again, there is a user &quot;Renfast&quot; who tested two FM2+ motherboard.&#160; He/She was successful with the HD7970 but not the GTX 680.</p></div></blockquote></div><p>Try -realtime mlock=on and having firefox(or chrome or whatever) eating enough memory, just about 1.5G.</p></div></blockquote></div><p>This sounds an awful lot like voodoo</p></div></blockquote></div><p>More like cargo-cult.</p><p>mlock is default:on, btw. But it works.<br />I still have no idea what&#039;s broken. Any ideas where do i dig to investigate the page faults? I&#039;m not so familiar with deep hardware fiddling yet.</p><p>Also, there are performance drawbacks on some applications.</p><p>My system needs a full overhaul.</p> </div> <div class="postsignature postmsg"><hr /><p><span class="bbs">The forum rules prohibit requesting support for distributions other than arch.</span><br /><a href="https://bbs.archlinux.org/viewtopic.php?pid=1551460#p1551460" rel="nofollow">I gave up.</a><a href="https://bbs.archlinux.org/viewtopic.php?id=162768" rel="nofollow"> It was too late.</a><br /><a href="http://pastebin.com/B3fL84bq" rel="nofollow">What I was trying to do</a>.<br /><a href="http://vfio.blogspot.com/" rel="nofollow">The reference about VFIO and KVM VGA passthrough.</a></p></div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1487150">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1487163" class="blockpost rowodd"> <h2><span><span class="conr">#3671</span> <a href="viewtopic.php?pid=1487163#p1487163">2014-12-24 18:15:15</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=84759">Ansa89</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2014-08-30</span></dd> <dd><span>Posts: 20</span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <p>Any hint about <a href="https://bbs.archlinux.org/viewtopic.php?pid=1486095#p1486095" rel="nofollow">this</a>?</p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1487163">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1487225" class="blockpost roweven"> <h2><span><span class="conr">#3672</span> <a href="viewtopic.php?pid=1487225#p1487225">2014-12-24 22:33:04</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=85314">Duelist</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2014-09-22</span></dd> <dd><span>Posts: 358</span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>Ansa89 wrote:</cite><blockquote><div><p>Any hint about <a href="https://bbs.archlinux.org/viewtopic.php?pid=1486095#p1486095" rel="nofollow">this</a>?</p></div></blockquote></div><p>As a &quot;better than nothing&quot; hint, i&#039;ll tell you: check whatever you use for your vm&#039;s disk. Be it filesystem&#039;s(you use file as a storage) health or actual hardware disk.<br />It seems to me like a kernel&#039;s problem, not a VM one.<br />Found this bugreport, seems somewhat related:<br /><a href="https://bugzilla.redhat.com/show_bug.cgi?id=1167001" rel="nofollow">https://bugzilla.redhat.com/show_bug.cgi?id=1167001</a></p><p>Also, if you&#039;re sure that your host disks are okay, try preparing your windows to migrating on virtio-blk-pci instead of scsi-way. That involves creating a dummy-drive on virtio-blk-pci device and feeding windows with drivers from virtio.iso and then &quot;reconnecting&quot; the drive.</p> </div> <div class="postsignature postmsg"><hr /><p><span class="bbs">The forum rules prohibit requesting support for distributions other than arch.</span><br /><a href="https://bbs.archlinux.org/viewtopic.php?pid=1551460#p1551460" rel="nofollow">I gave up.</a><a href="https://bbs.archlinux.org/viewtopic.php?id=162768" rel="nofollow"> It was too late.</a><br /><a href="http://pastebin.com/B3fL84bq" rel="nofollow">What I was trying to do</a>.<br /><a href="http://vfio.blogspot.com/" rel="nofollow">The reference about VFIO and KVM VGA passthrough.</a></p></div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1487225">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1487330" class="blockpost rowodd"> <h2><span><span class="conr">#3673</span> <a href="viewtopic.php?pid=1487330#p1487330">2014-12-25 14:07:20</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=34610">Myranti</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2010-03-04</span></dd> <dd><span>Posts: 19</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=34610">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <p>Has anyone run into an issue with black lines flickering on the host system when the secondary GPU is being passed through? <strong>(Edit below)</strong> It disappears when I shut the guest down but comes back when the guest starts up. I otherwise have things working, though haven&#039;t tested any games yet.</p><p>I&#039;m using two Radeon cards, R5 230 for host and R9 270X for guest with the open source drivers but have the second card bound to pci-stub. My google-fu hasn&#039;t found anything relevant yet, but if it&#039;s an issue that&#039;s already been posted that someone remembers I can work through earlier posts, perhaps with some targeted direction.</p><p>If people feel I need to provide more information to try determine what might be the cause, I&#039;m happy to do so.</p><p><strong>Edit:</strong> Okay, I&#039;ve tested a GTX460 (nouveau) and an R7 250 (radeon) and don&#039;t get flickering on either of them, so it looks like it&#039;s related to the R5 230 I&#039;m using. Will try to replace this with another card in the upcoming week.</p> <p class="postedit"><em>Last edited by Myranti (2014-12-28 09:12:40)</em></p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1487330">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1487336" class="blockpost roweven"> <h2><span><span class="conr">#3674</span> <a href="viewtopic.php?pid=1487336#p1487336">2014-12-25 15:31:06</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=85314">Duelist</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2014-09-22</span></dd> <dd><span>Posts: 358</span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>Myranti wrote:</cite><blockquote><div><p>Has anyone run into an issue with black lines flickering on the host system when the secondary GPU is being passed through? It disappears when I shut the guest down but comes back when the guest starts up. I otherwise have things working, though haven&#039;t tested any games yet.</p><p>I&#039;m using two Radeon cards, R5 230 for host and R9 270X for guest with the open source drivers but have the second card bound to pci-stub. My google-fu hasn&#039;t found anything relevant yet, but if it&#039;s an issue that&#039;s already been posted that someone remembers I can work through earlier posts, perhaps with some targeted direction.</p><p>If people feel I need to provide more information to try determine what might be the cause, I&#039;m happy to do so.</p></div></blockquote></div><p><strong>I don&#039;t know the solution</strong>, but i think motherboard and cpu information would be handy.</p> </div> <div class="postsignature postmsg"><hr /><p><span class="bbs">The forum rules prohibit requesting support for distributions other than arch.</span><br /><a href="https://bbs.archlinux.org/viewtopic.php?pid=1551460#p1551460" rel="nofollow">I gave up.</a><a href="https://bbs.archlinux.org/viewtopic.php?id=162768" rel="nofollow"> It was too late.</a><br /><a href="http://pastebin.com/B3fL84bq" rel="nofollow">What I was trying to do</a>.<br /><a href="http://vfio.blogspot.com/" rel="nofollow">The reference about VFIO and KVM VGA passthrough.</a></p></div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1487336">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1487350" class="blockpost rowodd"> <h2><span><span class="conr">#3675</span> <a href="viewtopic.php?pid=1487350#p1487350">2014-12-25 16:26:41</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=34610">Myranti</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2010-03-04</span></dd> <dd><span>Posts: 19</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=34610">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>Duelist wrote:</cite><blockquote><div><p><strong>I don&#039;t know the solution</strong>, but i think motherboard and cpu information would be handy.</p></div></blockquote></div><p>The motherboard i&#039;m using is an Asus P9D WS (VT-d and virtualization options enabled in BIOS of course) and the CPU is a Xeon E3-1241v3.</p> <p class="postedit"><em>Last edited by Myranti (2014-12-25 16:27:54)</em></p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1487350">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div class="postlinksb"> <div class="inbox crumbsplus"> <div class="pagepost"> <p class="pagelink conl"><span class="pages-label">Pages: </span><a rel="prev" class="item1" href="viewtopic.php?id=162768&amp;p=146">Previous</a> <a href="viewtopic.php?id=162768">1</a> <span class="spacer">…</span> <a href="viewtopic.php?id=162768&amp;p=145">145</a> <a href="viewtopic.php?id=162768&amp;p=146">146</a> <strong>147</strong> <a href="viewtopic.php?id=162768&amp;p=148">148</a> <a href="viewtopic.php?id=162768&amp;p=149">149</a> <span class="spacer">…</span> <a href="viewtopic.php?id=162768&amp;p=234">234</a> <a rel="next" href="viewtopic.php?id=162768&amp;p=148">Next</a></p> <p class="postlink conr">Topic closed</p> </div> <ul class="crumbs"> <li><a href="index.php">Index</a></li> <li><span>»&#160;</span><a href="viewforum.php?id=48">Topics Going Nowhere</a></li> <li><span>»&#160;</span><strong><a href="viewtopic.php?id=162768">KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</a></strong></li> </ul> <p class="subscribelink clearb"><a href="misc.php?action=subscribe&amp;tid=162768">Subscribe to this topic</a></p> <div class="clearer"></div> </div> </div> </div> <div id="brdfooter" class="block"> <h2><span>Board footer</span></h2> <div class="box"> <div id="brdfooternav" class="inbox"> <div class="conl"> <form id="qjump" method="get" action="viewforum.php"> <div><label><span>Jump to<br /></span> <select name="id" onchange="window.location=('viewforum.php?id='+this.options[this.selectedIndex].value)"> <optgroup label="Technical Issues and Assistance"> <option value="23">Newbie Corner</option> <option value="17">Installation</option> <option value="22">Kernel &amp; Hardware</option> <option value="18">Applications &amp; Desktop Environments</option> <option value="31">Laptop Issues</option> <option value="8">Networking, Server, and Protection</option> <option value="32">Multimedia and Games</option> <option value="50">System Administration</option> <option value="35">Other Architectures</option> </optgroup> <optgroup label="Arch-centric"> <option value="24">Announcements, Package &amp; Security Advisories</option> <option value="1">Arch Discussion</option> <option value="13">Forum &amp; Wiki discussion</option> </optgroup> <optgroup label="Pacman Upgrades, Packaging &amp; AUR"> <option value="44">Pacman &amp; Package Upgrade Issues</option> <option value="49">[testing] Repo Forum</option> <option value="4">Creating &amp; Modifying Packages</option> <option value="38">AUR Issues, Discussion &amp; PKGBUILD Requests</option> </optgroup> <optgroup label="Contributions &amp; Discussion"> <option value="20">GNU/Linux Discussion</option> <option value="27">Community Contributions</option> <option value="33">Programming &amp; Scripting</option> <option value="30">Other Languages</option> <option value="47">Artwork and Screenshots</option> <option value="42">Try This</option> </optgroup> <optgroup label="/dev/null"> <option value="29">Off-Topic</option> <option value="48" selected="selected">Topics Going Nowhere</option> <option value="36">Dustbin</option> </optgroup> </select></label> <input type="submit" value=" Go " accesskey="g" /> </div> </form> </div> <div class="conr"> <p id="feedlinks"><span class="atom"><a href="extern.php?action=feed&amp;tid=162768&amp;type=atom">Atom topic feed</a></span></p> <p id="poweredby">Powered by <a href="http://fluxbb.org/">FluxBB</a></p> </div> <div class="clearer"></div> </div> </div> </div> </div> <div class="end-box"></div> </div> </body> </html>
