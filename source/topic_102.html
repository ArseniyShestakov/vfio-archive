<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"> <html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en" dir="ltr"> <head> <meta http-equiv="Content-Type" content="text/html; charset=utf-8" /> <title>KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9 (Page 102) / Topics Going Nowhere / Arch Linux Forums</title> <link rel="stylesheet" type="text/css" href="style/ArchLinux.css" /> <link rel="canonical" href="viewtopic.php?id=162768&amp;p=102" title="Page 102" /> <link rel="prev" href="viewtopic.php?id=162768&amp;p=101" title="Page 101" /> <link rel="next" href="viewtopic.php?id=162768&amp;p=103" title="Page 103" /> <link rel="alternate" type="application/atom+xml" href="extern.php?action=feed&amp;tid=162768&amp;type=atom" title="Atom topic feed" /> <link rel="stylesheet" media="screen" href="style/ArchLinux/arch.css?v=3" /> <link rel="stylesheet" media="screen" href="style/ArchLinux/archnavbar.css?v=2" /> <link rel="shortcut icon" href="style/ArchLinux/favicon.ico" /> </head> <body> <div id="archnavbar" class="anb-forum"> <div id="archnavbarlogo"><h1><a href="http://www.archlinux.org/">Arch Linux</a></h1></div> <div id="archnavbarmenu"> <ul id="archnavbarlist"> <li id="anb-home"><a href="http://www.archlinux.org/">Home</a></li><li id="anb-packages"><a href="http://www.archlinux.org/packages/">Packages</a></li><li id="anb-forums" class="anb-selected"><a href="https://bbs.archlinux.org/">Forums</a></li><li id="anb-wiki"><a href="https://wiki.archlinux.org/">Wiki</a></li><li id="anb-bugs"><a href="https://bugs.archlinux.org/">Bugs</a></li><li id="anb-aur"><a href="https://aur.archlinux.org/">AUR</a></li><li id="anb-download"><a href="http://www.archlinux.org/download/">Download</a></li> </ul> </div> </div> <div id="punviewtopic" class="pun"> <div class="top-box"></div> <div class="punwrap"> <div id="brdheader" class="block"> <div class="box"> <div id="brdmenu" class="inbox"> <ul> <li id="navindex" class="isactive"><a href="index.php">Index</a></li> <li id="navuserlist"><a href="userlist.php">User list</a></li> <li id="navsearch"><a href="search.php">Search</a></li> <li id="navprofile"><a href="profile.php?id=80749">Profile</a></li> <li id="navlogout"><a href="login.php?action=out&amp;id=80749&amp;csrf_token=5c20501ec397bb45ef8ee8c84db232c8d8e421c6">Logout</a></li> </ul> </div> <div id="brdwelcome" class="inbox"> <ul class="conl"> <li><span>Logged in as <strong>SXX</strong></span></li> <li><span>Last visit: 2015-08-16 12:20:09</span></li> </ul> <ul class="conr"> <li><span>Topics: <a href="search.php?action=show_replies" title="Find topics you have posted to.">Posted</a> | <a href="search.php?action=show_new" title="Find topics with new posts since your last visit.">New</a> | <a href="search.php?action=show_recent" title="Find topics with recent posts.">Active</a> | <a href="search.php?action=show_unanswered" title="Find topics with no replies.">Unanswered</a></span></li> </ul> <div class="clearer"></div> </div> </div> </div> <div id="brdmain"> <div class="linkst"> <div class="inbox crumbsplus"> <ul class="crumbs"> <li><a href="index.php">Index</a></li> <li><span>»&#160;</span><a href="viewforum.php?id=48">Topics Going Nowhere</a></li> <li><span>»&#160;</span><strong><a href="viewtopic.php?id=162768">KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</a></strong></li> </ul> <div class="pagepost"> <p class="pagelink conl"><span class="pages-label">Pages: </span><a rel="prev" class="item1" href="viewtopic.php?id=162768&amp;p=101">Previous</a> <a href="viewtopic.php?id=162768">1</a> <span class="spacer">…</span> <a href="viewtopic.php?id=162768&amp;p=100">100</a> <a href="viewtopic.php?id=162768&amp;p=101">101</a> <strong>102</strong> <a href="viewtopic.php?id=162768&amp;p=103">103</a> <a href="viewtopic.php?id=162768&amp;p=104">104</a> <span class="spacer">…</span> <a href="viewtopic.php?id=162768&amp;p=234">234</a> <a rel="next" href="viewtopic.php?id=162768&amp;p=103">Next</a></p> <p class="postlink conr">Topic closed</p> </div> <div class="clearer"></div> </div> </div> <div id="p1448515" class="blockpost rowodd blockpost1"> <h2><span><span class="conr">#2526</span> <a href="viewtopic.php?pid=1448515#p1448515">2014-08-19 13:24:43</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=84278">Wimma77</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2014-08-12</span></dd> <dd><span>Posts: 15</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=84278">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <p>I&#039;m having issues too, and hoping someone could help please.<br />I&#039;ve tried lots of combinations, so probably screwed something simple up in the process.<br />I followed the ubuntu 14.04 guide here:<br /><a href="http://www.pugetsystems.com/labs/articles/Multiheaded-NVIDIA-Gaming-using-Ubuntu-14-04-KVM-585/" rel="nofollow">http://www.pugetsystems.com/labs/articl … 4-KVM-585/</a><br />That is based on this arch thread, and adjusted for Ubuntu.<br />I can pass through the HD7770 and audio, and both show up in device manager.<br />But once I install the 14.4 ATI drivers (either catalyst custom install or pointing Windows driver update to extracted files) I cannot reboot unless I use safe mode. And my keyboard is not always recognised, which makes it even more difficult.</p><p>I have the following hardware (been proven to work in EXSi)<br />GA-X58-UD5 board<br />E5520 cpu<br />BIOS supports passthrough also<br />primary card HD5450<br />passthrough HD7770<br />Ubuntu 14.04 x64 server<br />Win7x64 kvm VM</p><p>simon@cavetroll:~$ qemu-system-x86_64 -version<br />QEMU emulator version 2.0.0 (Debian 2.0.0+dfsg-2ubuntu1.2), Copyright (c) 2003-2008 Fabrice Bellard</p><p>simon@cavetroll:~$ cat /etc/initramfs-tools/modules<br />...<br />pci_stub ids=1002:683d,1002:aab0</p><p>simon@cavetroll:~$ cat /proc/cmdline<br />BOOT_IMAGE=/boot/vmlinuz-3.16.0-031600-generic root=UUID=a03285ef-5e8c-4182-b517-34f9717cbd18 ro quiet splash intel_iommu=on vfio_iommu_type1.allow_unsafe_interrupts=1 vt.handoff=7</p><p>I tried on the vanilla 3.12 kernal, then also tried installing the 3.16 as noted on page 1, no difference</p><p>HD7770 is card captured by pci-stub</p><p>simon@cavetroll:~$ dmesg | grep pci-stub<br />[&#160; &#160; 2.064508] pci-stub: add 1002:683D sub=FFFFFFFF:FFFFFFFF cls=00000000/00000000<br />[&#160; &#160; 2.064524] pci-stub 0000:03:00.0: claimed by stub<br />[&#160; &#160; 2.064534] pci-stub: add 1002:AAB0 sub=FFFFFFFF:FFFFFFFF cls=00000000/00000000<br />[&#160; &#160; 2.064543] pci-stub 0000:03:00.1: claimed by stub</p><p>simon@cavetroll:~$ lspci -nn |grep ATI<br />03:00.0 VGA compatible controller [0300]: Advanced Micro Devices, Inc. [AMD/ATI] Cape Verde XT [Radeon HD 7770/8760 / R7 250X] [1002:683d]<br />03:00.1 Audio device [0403]: Advanced Micro Devices, Inc. [AMD/ATI] Cape Verde/Pitcairn HDMI Audio [Radeon HD 7700/7800 Series] [1002:aab0]<br />04:00.0 VGA compatible controller [0300]: Advanced Micro Devices, Inc. [AMD/ATI] Park [Mobility Radeon HD 5430] [1002:68e1]<br />04:00.1 Audio device [0403]: Advanced Micro Devices, Inc. [AMD/ATI] Cedar HDMI Audio [Radeon HD 5400/6300 Series] [1002:aa68]</p><p>simon@cavetroll:~$ ls /sys/bus/pci/devices/0000\:03\:00.0/iommu_group/devices/<br />0000:03:00.0&#160; 0000:03:00.1</p><p>Can then capture video card and usb manually (script fails for me, but no need yet)</p><p>sudo vfio-bind 0000:03:00.0 0000:03:00.1<br />sudo vfio-bind 0000:00:1a.0 0000:00:1a.1 0000:00:1a.2 0000:00:1a.7</p><p>And can start a VM with display on HD7770 as expected, boots &amp; installs windows7, but after installing ATI driver it fails to reboot.<br />I get the error recovery screen but can log in (sometimes, when keyboard works) with safe mode, so assume driver issue?</p><p>sudo qemu-system-x86_64 -enable-kvm -M q35 -m 6144 -cpu host \<br />-smp 4,sockets=1,cores=2,threads=2 \<br />-bios /usr/share/qemu/bios.bin -vga none \<br />-device ioh3420,bus=pcie.0,addr=1c.0,multifunction=on,port=1,chassis=1,id=root.1 \<br />-device vfio-pci,host=03:00.0,bus=root.1,addr=00.0,multifunction=on,x-vga=on \<br />-device vfio-pci,host=03:00.1,bus=root.1,addr=00.1 \<br />-device vfio-pci,host=00:1a.0,bus=pcie.0 \<br />-device vfio-pci,host=00:1a.1,bus=pcie.0 \<br />-device vfio-pci,host=00:1a.2,bus=pcie.0 \<br />-device vfio-pci,host=00:1a.7,bus=pcie.0 \<br />-drive file=/home/simon/win7.img,id=disk,format=raw -device ide-hd,bus=ide.0,drive=disk \<br />-drive file=/home/simon/Downloads/Win7_64.iso,id=isocd -device ide-cd,bus=ide.1,drive=isocd \<br />-boot menu=on</p><p>Also tried IDE and virtio, on image file and partition, same result.<br />I assume I&#039;m missing something simple?</p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1448515">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1448548" class="blockpost roweven"> <h2><span><span class="conr">#2527</span> <a href="viewtopic.php?pid=1448548#p1448548">2014-08-19 15:31:15</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=58169">aldum</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd class="postavatar"><img src="https://bbs.archlinux.org/img/avatars/58169.jpg?m=1401983659" width="80" height="80" alt="" /></dd> <dd><span>Registered: 2012-03-14</span></dd> <dd><span>Posts: 7</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=58169">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>somebuddy wrote:</cite><blockquote><div><p>I can&#039;t get audio working right in Windows 8.1 as a guest, I get audio output but it is distorted.&#160; <br />Any ideas?</p></div></blockquote></div><p>What sinny said, try messing around with the parameters. It&#039;s a trial-and-error thing, can&#039;t really get it right otherwise.</p><p>Here&#039;s what&#039;s been working for me (Win7 guest):</p><div class="codebox"><pre><code>QEMU_ALSA_DAC_BUFFER_SIZE=1024 QEMU_AUDIO_DAC_FIXED_FREQ=48000 \ QEMU_AUDIO_ADC_FIXED_FREQ=48000 QEMU_ALSA_DAC_BUFFER_SIZE=16384 \ QEMU_AUDIO_DRV=pa \ qemu-system-x86_64 -enable-kvm -M q35 -m 4G -cpu host,hv-time,kvm=off \ (...) -device ich9-intel-hda,bus=pcie.0,addr=1b.0,id=sound0 \ -device hda-duplex,id=sound0-codec0,bus=sound0.0,cad=0 \ -soundhw hda,ac97 \</code></pre></div> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1448548">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1448549" class="blockpost rowodd"> <h2><span><span class="conr">#2528</span> <a href="viewtopic.php?pid=1448549#p1448549">2014-08-19 15:32:07</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=52587">Fira</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2011-09-24</span></dd> <dd><span>Posts: 8</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=52587">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <p>Hey there <img src="https://bbs.archlinux.org/img/smilies/smile.png" width="15" height="15" alt="smile" /><br />I recently broke my RAID when actually testing it (tip of the day: don&#039;t use FakeRAID, it can&#039;t do online recovery/degraded startup, at least at Intel&#039;s).</p><p>Reinstalled my whole Virt/Passthrough setup and I wanted to update on some things I figured out:<br /> - I profited of the occasion to downgrade from Windows 8.1 to Windows 7, hoping things would turn out better. Bad idea. The bootloader kept breaking for random reasons, even once Windows Update was turned off. Tip for anyone experimenting with this kind of problem: use LVM, make snapshots. You&#039;ll gain a lot of time rather than reinstalling Win$ every time (in my case, restoring GPT, Bootloader, and Boot partition wasn&#039;t enough).<br /> - Be careful with the versions of graphics drivers you run in your guest. For exemple i had a lucky streak with my first install because my GTX 750 Ti doesn&#039;t seem to run at all under passthrough when using versions above 335. It&#039;s probably always better to undershoot.<br /> - I added kernel boot args to capture the card to PCI-Stub before passing it to VFIO to ensure nothing would get loaded. This is important for nVidia cards it seems because otherwise they can load an audio driver for the sound sub-card.<br /> - A little important gotcha if you run PulseAudio and get connection issues, PulseAudio uses a cookie to authenticate users (though that might not be the case when running Policykit ?)... Because VFIO access requires root, and your pulseaudio server is probably running under a different user, the easiest workaround i found to that is to simply add a pulse input over TCP for 127.0.0.1 and add in /root/.pulse/client.conf the variable default-server=127.0.0.1 (or you could use PULSE_SERVER env variable).</p><p>Also a little errata. I said you need to lock your mouse to a screen when using Synergy with Mouse grabbing apps. That&#039;s true, but this will only work if you set the mouse movement type to relative rather than absolute in the Settings. Otherwise anything grabbing mouse expecting relative movements (hint: any FPS) will behave plain poorly...</p><p>Good luck !</p> <p class="postedit"><em>Last edited by Fira (2014-08-19 15:36:50)</em></p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1448549">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1448694" class="blockpost roweven"> <h2><span><span class="conr">#2529</span> <a href="viewtopic.php?pid=1448694#p1448694">2014-08-19 23:56:01</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=84422">somearchfan</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2014-08-18</span></dd> <dd><span>Posts: 33</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=84422">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <p>Hi all</p><p>I need some help here. I&#039;ve tried to set up hugepages but no luck. My computer crashes each and every time I start qemu w/ hpages enabled.<br /><a href="http://www.xup.to/dl,63559622/IMG_20140820_004957.jpg/" rel="nofollow"><span class="postimg"><img src="http://www1.xup.to/tn/2014_08/63559622.jpeg" alt="63559622.jpeg" /></span></a></p><p>cat /etc/fstab</p><div class="quotebox"><blockquote><div><p>UUID=B039-B9D4 /boot vfat defaults,rw,relatime 0 0<br />UUID=9416fa53-b808-4b96-bd92-6839effde5c5 swap swap defaults 0 0<br />UUID=8038e49a-447d-4955-823f-803d6e0c3e32 /home ext4 defaults,rw,relatime,data=ordered 0 0<br />UUID=9fb159a7-84b2-401b-a745-8199d3b0339c / ext4 defaults,rw,relatime,data=ordered 0 1<br />tmpfs /tmp tmpfs defaults,noatime,mode=1777 0 0<br />hugetlbfs&#160; &#160; &#160; &#160;/dev/hugepages&#160; hugetlbfs&#160; &#160; &#160; &#160;mode=1770,gid=78&#160; &#160; &#160; &#160; 0 0</p></div></blockquote></div><p>mount | grep huge</p><div class="quotebox"><blockquote><div><p>hugetlbfs on /dev/hugepages type hugetlbfs (rw,relatime,mode=1770,gid=78)</p></div></blockquote></div><p>grep HugePages_Total /proc/meminfo</p><div class="quotebox"><blockquote><div><p>HugePages_Total:&#160; &#160; 4096</p></div></blockquote></div><p>My config:</p><div class="quotebox"><blockquote><div><p>QEMU_ALSA_DAC_BUFFER_SIZE=512 QEMU_ALSA_DAC_PERIOD_SIZE=170 QEMU_AUDIO_DRV=alsa qemu-system-x86_64 -enable-kvm -M q35 -m 8196 -mem-path /dev/hugepages -cpu host -boot d \<br />-smp 4,sockets=1,cores=4,threads=1 \<br />-bios /usr/share/qemu/bios.bin -vga none \<br />-device ioh3420,bus=pcie.0,addr=1c.0,multifunction=on,port=1,chassis=1,id=root.1 \<br />-device vfio-pci,host=01:00.0,bus=root.1,addr=00.0,multifunction=on,x-vga=on,rombar=0,romfile=/home/john/Downloads/Asus.R9270.2048.131007.rom \<br />-device virtio-scsi-pci,id=scsi \<br />-drive file=/run/media/john/win/windows.img,id=disk,format=raw -device scsi-hd,drive=disk \<br />-drive file=/home/john/Downloads/virtio-win-0.1-81.iso,id=virtiocd -device ide-cd,bus=ide.2,drive=virtiocd \<br />-usb -usbdevice host:046d:c051 -usbdevice host:046a:0021 \<br />-net tap,vlan=0,ifname=tap0 -net nic,model=virtio,vlan=0 \<br />-device ich9-intel-hda,bus=pcie.0,addr=1b.0,id=sound0 \<br />-device hda-duplex,id=sound0-codec0,bus=sound0.0,cad=0</p></div></blockquote></div><br /><p>Any ideas?</p> <p class="postedit"><em>Last edited by somearchfan (2014-08-20 00:06:01)</em></p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1448694">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1448728" class="blockpost rowodd"> <h2><span><span class="conr">#2530</span> <a href="viewtopic.php?pid=1448728#p1448728">2014-08-20 02:28:35</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=79825">redger</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2014-02-26</span></dd> <dd><span>Posts: 15</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=79825">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <p>@Wimma77<br />I run a similar setup (using kUbuntu, tried server and wanted to run desktop n an LXC container - without much success) .... and have just spent 2+ days resolving a similar issue. The vm was working fine till the end of last week<br />Anyway, what I found was that the most useful debugging information came from a Ubuntu vm which I created specially to test whetehr or not the problem was Windows specific.&#160; Ubuntu startup information pointed to a sound problem, so I removed the AMD sound device passthrough (03:00.1 in your case) ... and then&#160; itbooted ok Very odd since it had been working for a couple of months until then. The other consequence was that the dx9 graphics performance then improved by about 20% ... particularly strange since the card worked perfectly in another PC booting Windows directly, so unlikely to be a hardware issue</p><p>Anyway, if you have the disk space create a Linux (ubuntu ?) VM to see if it indicates where to look,&#160; The other thing to be conscious of is the need to completely remove graphics drivers using something like <a href="http://www.guru3d.com/files-details/display-driver-uninstaller-download.html" rel="nofollow">http://www.guru3d.com/files-details/dis … nload.html</a> before trying again</p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1448728">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1448734" class="blockpost roweven"> <h2><span><span class="conr">#2531</span> <a href="viewtopic.php?pid=1448734#p1448734">2014-08-20 02:43:38</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=84278">Wimma77</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2014-08-12</span></dd> <dd><span>Posts: 15</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=84278">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <p>@redger<br />Thanks so much for the suggestion - will try that. But I thought you had to pass the whole iommu group through? Or just pass them both to vfio?<br />My card &amp; audio share a group.<br />ie ls /sys/bus/pci/devices/0000\:03\:00.0/iommu_group/devices/<br />0000:03:00.0&#160; 0000:03:00.1<br />I will try though. Good idea on the ubuntu VM too - definitely worth checking.<br />Can I just ask - did you use just vanilla kernel and qemu?<br />I have a headless server, but did install xfce4 so I could VNC to it and use a GUI when required.<br />Would love to be able to start the vm from cli but have not researched enough yet on how to accomplish that.<br />Cheers.</p> <p class="postedit"><em>Last edited by Wimma77 (2014-08-20 02:44:32)</em></p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1448734">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1448738" class="blockpost rowodd"> <h2><span><span class="conr">#2532</span> <a href="viewtopic.php?pid=1448738#p1448738">2014-08-20 03:27:37</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=79825">redger</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2014-02-26</span></dd> <dd><span>Posts: 15</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=79825">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <p>@Wimma77<br />you don&#039;t need to pass the whole group BUT you cannot pass parts of a group to fdifferent VMs<br />I start my VMs from the CLI using a simple script .. looks like this (ignore extra lines at the top, I keep them for debugging &amp; experimentation)</p><div class="codebox"><pre><code>#!/bin/sh # Real command # sudo sh /etc/init.d/vfio-bind-init.sh # qemu-system-x86_64 \ # QEMU_PA_SAMPLES=128 QEMU_AUDIO_DRV=pa qemu-system-x86_64 \ QEMU_ALSA_DAC_BUFFER_SIZE=512 QEMU_ALSA_DAC_PERIOD_SIZE=170 QEMU_AUDIO_DRV=alsa qemu-system-x86_64 \ -name win7 -enable-kvm -M q35 -m 6144 -mem-path /dev/hugepages \ -cpu Haswell,hv-time,hv_relaxed,hv_vapic,hv_spinlocks=0x1000 -rtc base=localtime \ -boot menu=on \ -smp 2,sockets=1,cores=2,threads=1 \ -bios /usr/share/qemu/bios.bin -vga none \ -usbdevice tablet \ -spice port=5902,disable-ticketing \ -device ioh3420,bus=pcie.0,addr=1c.0,multifunction=on,port=1,chassis=1,id=root.1 \ -device ahci,bus=pcie.0,id=ahci \ -net nic,macaddr=00:00:00:0a:5b:2c,model=virtio \ -net user \ -device ioh3420,bus=pcie.0,addr=1c.1,multifunction=on,port=2,chassis=2,id=root.2 \ -device ich9-intel-hda,bus=root.2 \ -device hda-duplex,bus=hda.0 \ -device vfio-pci,host=01:00.0,bus=root.1,addr=00.0,multifunction=on,x-vga=on \ -device vfio-pci,host=06:00.0,bus=pcie.0 \ -drive file=/dev/ssd-virt/lvwin7_kvm,id=disk1,format=raw,if=virtio \ -drive file=/mnt/programming_data/isos/virtio-win-0.1-74.iso,id=isocd2 \ -device ide-cd,bus=ahci.2,drive=isocd2 \ -drive file=/mnt/programming_data/isos/winfiles_2.iso,id=isocd3 \ -device ide-cd,bus=ahci.3,drive=isocd3</code></pre></div><p>which I then added to the KDE menu - to be executed as root .... but you could easily adjust to enable direct execution. I have similar scripts fopr binding the VFIO devices and for strating spice (useful when debugging)</p><p>I used qemu etc. from the Ubuntu repos but I patched the kernel using the following script -</p><div class="codebox"><pre><code>#!/bin/bash # patch --dry-run --verbose -p 1 -i re_xxxxxxxxxxxxx echo echo ... PATCHING ... VGA Arbiter patch -b -p 1 -i re_patch_01_i915_313rc4.patch echo echo ... PATCHING ... acs override patch -b -p 1 -i re_patch_02_override_for_missing_acs_capabilities.patch echo echo ... PATCHING ... memleak patch -b -p 1 -i re_patch_03_fix_memleak.patch echo echo ... PATCHING ... read DR6 patch -b -p 1 -i re_patch_04_fix_reading_of_DR6.patch echo echo ... PATCHING ... debug registers - has problem, needs to follow DR6 patch patch -b -p 1 -i re_patch_05_debug_registers.patch # patch -b -p 1 -i re_debug_registers_RE.patch # Corrected to add additional lines before DR6 patch runs echo echo ... PATCHING ... kernel__gcc patch -b -p 1 -i re_patch_06_kernel-38-gcc48-2.patch</code></pre></div><p>Generally I copy the &quot;mainline&quot; file nbhs posts and extract the patches for each kernel generation, just be be sure. So I have the patches he posted for 3.13 and I have patched kernels for Ubuntu releases 24, 28, 32, 34 and I have copied patches for 3.13, 3.15, 3.15 (missed 3.14 somehow)</p><p>Here are my notes for patching the kernel, if they&#039;re of any use</p><div class="codebox"><pre class="vscroll"><code>To compile a new kernel https://wiki.ubuntu.com/Kernel/BuildYourOwnKernel https://help.ubuntu.com/community/Kernel/Compile https://wiki.ubuntu.com/KernelTeam/KernelMaintenance https://www.debian.org/releases/stable/i386/ch08s06.html.en architecture is &quot;amd64&quot; or &quot;x86_64&quot; 1) download the source into the current directory using &quot;apt-get source linux-image-xxxxx&quot; where xxxx is the name of the version eg. apt-get source linux-image-3.13.0-32-generic This should download the tarball(s) and extract the source code into a directory (which should be renamed immediately because all versions use the same directory name !!!) 2) Open the new directory, clean up and prepare chmod a+x debian/scripts/* chmod a+x debian/scripts/misc/* fakeroot debian/rules clean and generate the required config by either - a) editing using &quot;fakeroot debian/rules editconfigs&quot; (for all targets, one after another) ... or b) &quot;make menuconfig&quot; and work through the various options. Remember to save before exit c) copy the current config from the boot directory as &quot;.config&quot; in the root direcotry for the new kernel and then use &quot;make oldconfig&quot; ... which will ask a question for the value of each new config option Required config options are CONFIG_VFIO_IOMMU_TYPE1=y in Device Drivers. 2 pages back from end CONFIG_VFIO=y CONFIG_VFIO_PCI=y CONFIG_VFIO_PCI_VGA=y CONFIG_PCI_STUB=y in Bus Options, second page down HZ_1000=y in Processor Type &amp; Features (last page) PREEMPT=voluntary 3) apply any patches /// remember to verify that they worked ok (look for fail) &quot;sh re_apply_patches.sh &gt; re_output_patch.txt&quot; 4) &quot;fakeroot debian/rules clean&quot; to remove any old build information / files 5) Ignore modules not created with new parameters ... copy re_modules.ignore to ...debian.master/abi/&lt;previous-version&gt;/modules.ignore and ignore other ABI errors by copying re_prevrelease_arch_ignore (rename to &quot;ignore&quot;) to debian.master/abi/&lt;previous-version&gt;/&lt;arch&gt; eg. to debian.master/abi/3.13.0-32.56/amd64/ 6) &quot;DEB_BUILD_OPTIONS=parallel=3 skipmodule=true fakeroot debian/rules binary-headers binary-generic &gt; re_output_compile.txt&quot; to generate the deb files which can be installed (second thoughts don&#039;t pipe the poutput to a file - it will prevent selection of the CPU type) 7) Install all the Debs with command &quot;sudo dpkg -i linux*&lt;ver&gt;*.deb eg. sudo dpkg -i linux*3.13.0-32_3.13.0-32.57*.deb sudo dpkg -i linux*3.13.0-32-generic_3.13.0-32.57*.deb 8) go into Synaptic and lock all the newly installed elements (linux-image*, linux-header*, linux-tool*, linx-cloud-tool*) - to prevent the new kernel and components being overwritten in the next upgrade</code></pre></div> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1448738">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1448740" class="blockpost roweven"> <h2><span><span class="conr">#2533</span> <a href="viewtopic.php?pid=1448740#p1448740">2014-08-20 03:36:11</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=79825">redger</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2014-02-26</span></dd> <dd><span>Posts: 15</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=79825">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <p>@somearchfan<br />have you tried either (a) increasing the size of your hugepages or (b) decreasing the amount of memory allocated to the VM<br />The hugepages mechanism needs a small amount of RAM for management .. over and above what is allocated to the VM(s). For instance mine is set to </p><div class="codebox"><pre><code>grep HugePages_Total /proc/meminfo HugePages_Total: 3200</code></pre></div><p>for a VM with memory allocation of 6144</p><div class="codebox"><pre><code>qemu-system-x86_64 \ -name win7 -enable-kvm -M q35 -m 6144 -mem-path /dev/hugepages \</code></pre></div> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1448740">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1448744" class="blockpost rowodd"> <h2><span><span class="conr">#2534</span> <a href="viewtopic.php?pid=1448744#p1448744">2014-08-20 04:00:02</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=84323">deivid</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2014-08-13</span></dd> <dd><span>Posts: 5</span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <p>using<br />-device ich9-intel-hda,bus=pcie.0,addr=1b.0,id=sound0 \<br />-device hda-duplex,id=sound0-codec0,bus=sound0.0,cad=0 </p><p>I get way lower performance in general and very choppy audio (using alsa). Any clue?</p><p>In particular, I get higher in-game ping (from 60ms to ~120ms) and also my network latency increases, the games drop from 60+ fps to ~12-20fps.. I&#039;ll keep looking later</p> <p class="postedit"><em>Last edited by deivid (2014-08-20 04:14:30)</em></p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1448744">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1448746" class="blockpost roweven"> <h2><span><span class="conr">#2535</span> <a href="viewtopic.php?pid=1448746#p1448746">2014-08-20 04:27:24</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=79825">redger</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2014-02-26</span></dd> <dd><span>Posts: 15</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=79825">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <p>@deivid<br />have a look at my command line a couple of posts above. Note the prefix to qemu right at the beginning and the 3 lines for the sound card ie. add another PCI slot for the card (ioh3420). You could also try Pulseaudio using the commented line at the top of what I posted - tho it performed poorly for me (lag), Alsa was much better performed and host tasks can still play sounds simultaneously via Pulse</p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1448746">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1448756" class="blockpost rowodd"> <h2><span><span class="conr">#2536</span> <a href="viewtopic.php?pid=1448756#p1448756">2014-08-20 05:09:36</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=84323">deivid</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2014-08-13</span></dd> <dd><span>Posts: 5</span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <p>Basically copied the first line and last 3 lines from your config, but it&#039;s the same result (very choppy sound and poor graphics performance, didn&#039;t test network).. there must be something obvious I&#039;m missing. <br />As &#039;recommended&#039; above I removed my AMD sound device (01:00.1), which wasn&#039;t doing anything anyway</p><div class="codebox"><pre><code>QEMU_ALSA_DAC_BUFFER_SIZE=512 QEMU_ALSA_DAC_PERIOD_SIZE=170 QEMU_AUDIO_DRV=alsa \ qemu-system-x86_64 -enable-kvm -M q35 -m 3200 -cpu host \ -smp 3,sockets=1,cores=3,threads=1 \ -bios /usr/share/qemu/bios.bin \ -device ioh3420,bus=pcie.0,addr=1c.0,multifunction=on,port=1,chassis=1,id=root.1 \ -device vfio-pci,host=01:00.0,bus=root.1,addr=00.0,multifunction=on,x-vga=on \ -device piix4-ide,bus=pcie.0,id=piix4-ide \ -usb -usbdevice host:1bcf:0002 \ -usb -usbdevice host:04d9:1602 \ -drive file=/storage/virt/windows.qcow2,id=disk,format=qcow2 -device ide-hd,bus=ide.0,drive=disk \ -vga none -vnc :0 \ -net nic -net tap,ifname=tap0,script=no,downscript=no \ -mem-path /dev/hugepages \ -device ioh3420,bus=pcie.0,addr=1c.1,multifunction=on,port=2,chassis=2,id=root.2 \ -device ich9-intel-hda,bus=root.2 \ -device hda-duplex,bus=hda.0</code></pre></div><p>Do you see what am&#160; I doing wrong?</p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1448756">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1448757" class="blockpost roweven"> <h2><span><span class="conr">#2537</span> <a href="viewtopic.php?pid=1448757#p1448757">2014-08-20 05:26:33</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=84480">blu3bird</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2014-08-20</span></dd> <dd><span>Posts: 2</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=84480">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <p>@somearchfan</p><p>It does not crash, it just get&#039;s very very very slow because you are ouf of memory ;-)</p><p>Using 2MB hugepages adds 16MB overhead per vm =&gt; If you want to assign 8192MB to your vm, you&#039;ll need 8208MB of hugepages.</p><p>PS: You can try 1GB hugepages to avoid this overhead. But that requires extra hardware support: grep pdpe1gb /proc/cpuinfo</p> <p class="postedit"><em>Last edited by blu3bird (2014-08-20 05:29:24)</em></p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1448757">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1448782" class="blockpost rowodd"> <h2><span><span class="conr">#2538</span> <a href="viewtopic.php?pid=1448782#p1448782">2014-08-20 08:13:00</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=79825">redger</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2014-02-26</span></dd> <dd><span>Posts: 15</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=79825">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <p>@deivid<br />errrr I&#039;m not an expert .... but</p><p>look at (a) your disk, it&#039;s on an IDE controller whereas it will perform much better using virtio (I create an LVM partition and passed that using virtio) (b) if running a 64 bit Windows it may be short of RAM - 3GB is a bit lean, can you allocate 4GB or more - paging could be killing the vm (c) you appear to have defined a VNC connection which may not help (shouldn&#039;t be necessary if you&#039;re passing a graphcis card, try using Spice instead). Presumably you&#039;re running this on a quad core Intel cpu / motherboard (guess) given that you&#039;re passing 3 cores, single thread each and no pinning. If this is an AMD you probably want to (i) allocate an even number of cores and (ii) pin them to avoid NUMA problems ie. cache build / rebuild<br />Have you set Hugepages appropriately ? See discussion up the page a bit</p><p>Also refer to NBHS&#039;s tuning comments on the first page. I have added hv-time,hv_relaxed,hv_vapic,hv_spinlocks=0x1000 to help improve Windows performance (refered to in early pages - maybe search for them). </p><p>perhaps one of the more capable folk on the forum could offer better / more advice</p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1448782">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1448799" class="blockpost roweven"> <h2><span><span class="conr">#2539</span> <a href="viewtopic.php?pid=1448799#p1448799">2014-08-20 10:20:40</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=82238">sinny</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2014-05-24</span></dd> <dd><span>Posts: 75</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=82238">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>somearchfan wrote:</cite><blockquote><div><p>Hi all</p><p>I need some help here. I&#039;ve tried to set up hugepages but no luck. My computer crashes each and every time I start qemu w/ hpages enabled.</p></div></blockquote></div><p>yep, hugepages is completely undocumented and almost not yet publically known kernel feature. thread on pci passthrough is a perfect place to whine about you not being able to use google</p><div class="quotebox"><cite>deivid wrote:</cite><blockquote><div><p>Basically copied the first line and last 3 lines from your config, but it&#039;s the same result (very choppy sound and poor graphics performance, didn&#039;t test network).. there must be something obvious I&#039;m missing. <br />As &#039;recommended&#039; above I removed my AMD sound device (01:00.1), which wasn&#039;t doing anything anyway</p><div class="codebox"><pre><code>...</code></pre></div><p>Do you see what am&#160; I doing wrong?</p></div></blockquote></div><p>i see what you are doing wrong (more like - it seems for me that it&#039;s the only thing you are doing) - being completely ignorant.</p><p>you got problems with sound - too high and mighty to pinpoint command line arguments used that are related to sound and read some manuals on their meaning?<br />got poor graphics performance - too busy to try tons of performance tips that are all over this thread (not to mention google)?<br />got any problems - too cute to at least try resolving the problem yourself (and i mean really trying to soil your hands digging around the issue)?</p><p>p.s. thanks for making the thread less usable with question about something pretty trivial that was already discussed quite a few times</p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1448799">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1448886" class="blockpost rowodd"> <h2><span><span class="conr">#2540</span> <a href="viewtopic.php?pid=1448886#p1448886">2014-08-20 17:17:07</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=84323">deivid</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2014-08-13</span></dd> <dd><span>Posts: 5</span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>redger wrote:</cite><blockquote><div><p>@deivid<br />errrr I&#039;m not an expert .... but</p><p>look at (a) your disk, it&#039;s on an IDE controller whereas it will perform much better using virtio (I create an LVM partition and passed that using virtio)</p></div></blockquote></div><p>I&#039;ll look into it but I installed windows with the disk set to IDE, then installed drivers; trying to boot on virtio mode&#160; gives me a BSOD and I&#039;d have to format the virtual machine, which I might do anyway tomorrow.</p><div class="quotebox"><cite>redger wrote:</cite><blockquote><div><p> (b) if running a 64 bit Windows it may be short of RAM - 3GB is a bit lean, can you allocate 4GB or more - paging could be killing the vm</p></div></blockquote></div><p>I&#039;m running this with only windows and a game (dota 2/half life) for now, so it&#039;s enough; didn&#039;t notice any difference between 3 or 4gb (I have 8 but I&#039;m running a few things on the host)</p><div class="quotebox"><cite>redger wrote:</cite><blockquote><div><p> (c) you appear to have defined a VNC connection which may not help (shouldn&#039;t be necessary if you&#039;re passing a graphcis card, try using Spice instead). Presumably you&#039;re running this on a quad core Intel cpu / motherboard (guess) given that you&#039;re passing 3 cores, single thread each and no pinning. If this is an AMD you probably want to (i) allocate an even number of cores and (ii) pin them to avoid NUMA problems ie. cache build / rebuild</p></div></blockquote></div><p>VNC connection: I was getting a &#039;couldn&#039;t initialize SDL&#039; on the machine, it&#039;s running headless, and this solved it. The vnc session only lets me manage the qemu console.</p><p>I&#039;m running on an 8-code 8350, again, no difference with 3/4 cores, I&#039;ll look into pinning them.</p><div class="quotebox"><cite>redger wrote:</cite><blockquote><div><p>Have you set Hugepages appropriately ? See discussion up the page a bit</p><p>Also refer to NBHS&#039;s tuning comments on the first page. I have added hv-time,hv_relaxed,hv_vapic,hv_spinlocks=0x1000 to help improve Windows performance (refered to in early pages - maybe search for them). </p><p>perhaps one of the more capable folk on the forum could offer better / more advice</p></div></blockquote></div><p>I&#039;ve set up 2MB hugepages but my mobo supports 1GB hugepages so I&#039;ll set it up later (didn&#039;t notice any difference with the hugepages on/off).<br />I&#039;ll look into the hv-* parameters. </p><p>Thank you</p> <p class="postedit"><em>Last edited by deivid (2014-08-20 17:29:27)</em></p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1448886">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1448887" class="blockpost roweven"> <h2><span><span class="conr">#2541</span> <a href="viewtopic.php?pid=1448887#p1448887">2014-08-20 17:20:53</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=84323">deivid</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2014-08-13</span></dd> <dd><span>Posts: 5</span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>sinny wrote:</cite><blockquote><div><p>you got problems with sound - too high and mighty to pinpoint command line arguments used that are related to sound and read some manuals on their meaning?<br />got poor graphics performance - too busy to try tons of performance tips that are all over this thread (not to mention google)?<br />got any problems - too cute to at least try resolving the problem yourself (and i mean really trying to soil your hands digging around the issue)?</p><p>p.s. thanks for making the thread less usable with question about something pretty trivial that was already discussed quite a few times</p></div></blockquote></div><p>I&#039;m guessing you didn&#039;t understand my post. All my problems start if I add the audio device. Without audio device, the VM works wonders, with it, I get poor network performance (LAN and WAN) and poor graphics/CPU performance, and the audio crackles like hell.</p><p>They are not separate issues and only happen with the audio device enabled; pci-passthrough is pretty obscure and most &#039;documentation&#039; comes from guessing. I haven&#039;t found anything related to my problem so I posted here</p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1448887">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1448893" class="blockpost rowodd"> <h2><span><span class="conr">#2542</span> <a href="viewtopic.php?pid=1448893#p1448893">2014-08-20 17:45:27</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=82117">devianceluka</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2014-05-19</span></dd> <dd><span>Posts: 43</span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <p>Could someone please help me with compiling kernel with acs override patch on Fedora? I want to compile the latest kernel from &quot;yum update&quot;. I have those lines set up already and they are not the best:</p><p>yum install yum-utils<br />yumdownloader --source kernel<br />yum-builddep kernel-&lt;version&gt;.src.rpm<br />rpm -Uvh kernel-&lt;version&gt;.src.rpm<br />cd<br />cd rpmbuild/SOURCES<br />tar -xvf ....<br />cd rpmbuild/SOURCES/linux../<br />&lt;copy acs.patch here&gt;<br />patch -p1 &lt; acs.patch<br />make oldconfig<br />make<br />make install</p><p>Please someone....</p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1448893">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1448907" class="blockpost roweven"> <h2><span><span class="conr">#2543</span> <a href="viewtopic.php?pid=1448907#p1448907">2014-08-20 18:29:33</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=82238">sinny</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2014-05-24</span></dd> <dd><span>Posts: 75</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=82238">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>deivid wrote:</cite><blockquote><div><div class="quotebox"><cite>sinny wrote:</cite><blockquote><div><p>you got problems with sound - too high and mighty to pinpoint command line arguments used that are related to sound and read some manuals on their meaning?<br />got poor graphics performance - too busy to try tons of performance tips that are all over this thread (not to mention google)?<br />got any problems - too cute to at least try resolving the problem yourself (and i mean really trying to soil your hands digging around the issue)?</p><p>p.s. thanks for making the thread less usable with question about something pretty trivial that was already discussed quite a few times</p></div></blockquote></div><p>I&#039;m guessing you didn&#039;t understand my post. All my problems start if I add the audio device. Without audio device, the VM works wonders, with it, I get poor network performance (LAN and WAN) and poor graphics/CPU performance, and the audio crackles like hell.</p><p>They are not separate issues and only happen with the audio device enabled; pci-passthrough is pretty obscure and most &#039;documentation&#039; comes from guessing. I haven&#039;t found anything related to my problem so I posted here</p></div></blockquote></div><p>well, i had both choppy audio and poor 3d game fps. resolved this by using isolcpus/cpuset, hugetlbfs and playing around with audio parameters. everything was found in the thread - so you probably never searched or just stopped doing it after few minutes.</p><div class="quotebox"><cite>devianceluka wrote:</cite><blockquote><div><p>Could someone please help me with compiling kernel with acs override patch on Fedora? I want to compile the latest kernel from &quot;yum update&quot;. I have those lines set up already and they are not the best:<br />yum install yum-utils<br />yumdownloader --source kernel<br />yum-builddep kernel-&lt;version&gt;.src.rpm<br />rpm -Uvh kernel-&lt;version&gt;.src.rpm<br />cd<br />cd rpmbuild/SOURCES<br />tar -xvf ....<br />cd rpmbuild/SOURCES/linux../<br />&lt;copy acs.patch here&gt;<br />patch -p1 &lt; acs.patch<br />make oldconfig<br />make<br />make install<br />Please someone....</p></div></blockquote></div><p>you have &quot;lines&quot; &quot;set up&quot;? i dont even want to think what kind of disorder it might be... <br />and the &quot;lines&quot; look very weird from fedora perspective - why use yum/rpmbuild at all if you are going to do everything (incorrectly, by the way) by hands later?</p><p>excuse me, but i hope noone will spoon-feed you with this info. it&#039;s god damned fedora - it even has its&#039; own dedicated wiki with pretty good info (not to mention it being pretty popular/used distro).</p><p>why did you switch to fedora if you neither have an idea on its&#039; infrastructure nor willing to use TONS of info on it in the net? search the damned web or stop begging for help (well, technically not for &quot;help&quot;, but for someone to do everything for you)</p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1448907">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1448960" class="blockpost rowodd"> <h2><span><span class="conr">#2544</span> <a href="viewtopic.php?pid=1448960#p1448960">2014-08-20 20:56:55</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=80387">dwe11er</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2014-03-18</span></dd> <dd><span>Posts: 73</span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>somearchfan wrote:</cite><blockquote><div><p>Hi all</p><p>I need some help here. I&#039;ve tried to set up hugepages but no luck. My computer crashes each and every time I start qemu w/ hpages enabled.<br /><a href="http://www.xup.to/dl,63559622/IMG_20140820_004957.jpg/" rel="nofollow">http://www1.xup.to/tn/2014_08/63559622.jpeg</a></p><p>...</p><p>Any ideas?</p></div></blockquote></div><p>Try to allocate bit more, like 5004 or something.</p> <p class="postedit"><em>Last edited by dwe11er (2014-08-20 20:57:25)</em></p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1448960">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1449049" class="blockpost roweven"> <h2><span><span class="conr">#2545</span> <a href="viewtopic.php?pid=1449049#p1449049">2014-08-21 06:23:19</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=45984">starlays</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2011-02-02</span></dd> <dd><span>Posts: 10</span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <p>If I have only one GPU available can I use&#160; KVM VGA-Passthrough?<br />I have Gnome running on the host and I want to create a windows VM for gaming, I&#039;m new to virtualization and I&#039;m curious if It is possible to share the GPU between the host and the guest. All the scenarios that I found for now are involving the presence of 2 video cards, one on CPU and one PCI. My CPU has VT-d, it is&#160; Intel Xeon 1230v3.<br />Thank you in advance.</p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1449049">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1449068" class="blockpost rowodd"> <h2><span><span class="conr">#2546</span> <a href="viewtopic.php?pid=1449068#p1449068">2014-08-21 08:37:47</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=84422">somearchfan</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2014-08-18</span></dd> <dd><span>Posts: 33</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=84422">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <p>You can&#039;t run both at the same time on one gpu. Just buy a cheap Radeon 5450 / 6450 for linux.</p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1449068">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1449108" class="blockpost roweven"> <h2><span><span class="conr">#2547</span> <a href="viewtopic.php?pid=1449108#p1449108">2014-08-21 12:44:07</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=84278">Wimma77</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2014-08-12</span></dd> <dd><span>Posts: 15</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=84278">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>redger wrote:</cite><blockquote><div><p>@Wimma77<br />you don&#039;t need to pass the whole group BUT you cannot pass parts of a group to fdifferent VMs<br />I start my VMs from the CLI using a simple script .. looks like this (ignore extra lines at the top, I keep them for debugging &amp; experimentation)</p><p>which I then added to the KDE menu - to be executed as root .... but you could easily adjust to enable direct execution. I have similar scripts fopr binding the VFIO devices and for strating spice (useful when debugging)</p><p>I used qemu etc. from the Ubuntu repos but I patched the kernel using the following script -</p></div></blockquote></div><p>Thanks so much for this.<br />Will try this weekend when I get some quiet time.<br />Got an nvidia card coming too, so might be a good time to start fresh.<br />Much appreciated.</p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1449108">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1449299" class="blockpost rowodd"> <h2><span><span class="conr">#2548</span> <a href="viewtopic.php?pid=1449299#p1449299">2014-08-22 02:47:54</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=83411">erganzi</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2014-07-09</span></dd> <dd><span>Posts: 19</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=83411">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>erganzi wrote:</cite><blockquote><div><p>Thank you for the guide! It finally work after I tried many times, changed many kernel and qemu versions.</p><p>So I want to share my experience.</p><p>Hardware Info：<br />Gigabyte Z97-D3H<br />i5-4570<br />i915 built-in card for host<br />Sapphire hd7850 for vm</p><p>Software Info:<br />linux-3.12.4 from kernel.org with following patchs.<br /><a href="http://www.spinics.net/lists/linux-pci/msg22136.html" rel="nofollow">pci/iommu: Quirk non-compliant PCIe-to-PCI bridges</a><br /><a href="http://git.kernel.org/cgit/linux/kernel/git/torvalds/linux.git/patch/?id=81b5c7bc8de3e6f63419139c2fc91bf81dea8a7d" rel="nofollow">i915_fixes[1]</a><br /><a href="http://git.kernel.org/cgit/linux/kernel/git/torvalds/linux.git/patch/?id=6e1b4fdad5157bb9e88777d525704aba24389bee" rel="nofollow">i915_fixes[2]</a><br /><a href="http://www.spinics.net/lists/kvm/msg92163.html" rel="nofollow">Enable overrides for missing ACS capabilities</a> </p><p>qemu-2.0.0 with patch<br /><a href="http://lists.nongnu.org/archive/html/qemu-devel/2013-10/msg00597.html" rel="nofollow">vfio-pci: Disallow device from using NoSnoop transactions</a></p><p>Kernel commandline:</p><div class="quotebox"><blockquote><div><p>linux /vmlinuz-3.12.4-VFIOPassthrough root=UUID=6b2e5409-8b73-40db-ad45-f4ec79cdc0cc quiet <br />intel_iommu=on vfio_iommu_type1.allow_unsafe_interrupts=1 pcie_acs_override=downstream <br />pci-stub.ids=1002:6819,1002:aab0</p></div></blockquote></div><p>/etc/modprobe.d/kvm.conf</p><div class="quotebox"><blockquote><div><p>options kvm ignore_msrs=1<br />options kvm allow_unsafe_assigned_interrupts=1<br />options kvm_intel emulate_invalid_guest_state=0</p></div></blockquote></div><p>Qemu commandline:</p><div class="quotebox"><blockquote><div><p>01:00.0 VGA compatible controller: ATI Technologies Inc Device 6819<br />01:00.1 Audio device: ATI Technologies Inc Device aab0</p><p>/root/vfio-bind 0000:01:00.0 0000:01:00.1</p></div></blockquote></div><div class="quotebox"><blockquote><div><p>qemu-system-x86_64 -cpu SandyBridge -smp 2,sockets=2,cores=1,threads=1 \<br />-m 4096 -M q35 -enable-kvm \<br />-device piix4-ide,bus=pcie.0,id=piix4-ide \<br />-drive file=/var/lib/libvirt/images/fwq_win7_vfio.img,id=disk,format=raw \<br />-device ide-hd,bus=piix4-ide.0,drive=disk \<br />-drive file=/var/lib/libvirt/images/LENOVO_WIN7_64.iso,id=isocd \<br />-device ide-cd,bus=piix4-ide.1,drive=isocd \<br />-net nic,model=rtl8139,macaddr=52:54:00:1a:2b:3c \<br />-net tap,ifname=tap0,script=/etc/qemu-ifup,downscript=/etc/qemu-ifdown \<br />-vga none -display none \<br />-device ioh3420,bus=pcie.0,addr=1c.0,multifunction=on,port=1,chassis=1,id=root.1 \<br />-device vfio-pci,host=01:00.0,bus=root.1,addr=00.0,multifunction=on,x-vga=on \<br />-device vfio-pci,host=01:00.1,bus=pcie.0 \&#160; &#160; &#160;/* the audio bus must be pcie.0 or you will be failed. */<br />-usb -usbdevice host:17ef:6018 -usbdevice host:17ef:600e \<br />-boot order=cd -monitor stdio</p></div></blockquote></div><div class="quotebox"><blockquote><div><p>PS: the graphic driver for hd7850 that I use [amd_13_9_win7_win8_64_dd_ccc_whql.exe]</p></div></blockquote></div></div></blockquote></div><p>Upon this, AMD FirePro R5000 works too, but there is another problem, if I start vm with VFIO passthrough, my host terminal has no response like screen freezed, only ssh works. give me some help, thanks!</p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1449299">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1449305" class="blockpost roweven"> <h2><span><span class="conr">#2549</span> <a href="viewtopic.php?pid=1449305#p1449305">2014-08-22 03:11:28</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=83411">erganzi</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2014-07-09</span></dd> <dd><span>Posts: 19</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=83411">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <p>I found it seems like i915 driver. if I blacked i915 driver in blacklist.conf, the host is no respond. but canceled it, it normal.</p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1449305">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1449432" class="blockpost rowodd"> <h2><span><span class="conr">#2550</span> <a href="viewtopic.php?pid=1449432#p1449432">2014-08-22 15:50:40</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=73125">BahbGTR</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd class="postavatar"><img src="https://bbs.archlinux.org/img/avatars/73125.jpg?m=1373634954" width="80" height="64" alt="" /></dd> <dd><span>From: Kentucky</span></dd> <dd><span>Registered: 2013-07-12</span></dd> <dd><span>Posts: 19</span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <p>I got tired of manually patching and compiling the mainline kernel, so I used customizepkg to patch the default linux package automatically.&#160; This may not be the proper way of doing things, but it&#039;s the lazy way!&#160; This process would probably work with any kernel in AUR or any of the repositories.&#160; I&#039;m not sure if the patches will.&#160; I would be surprised if they didn&#039;t, but you never know until you try.&#160; </p><p>Sorry if this has been posted before, but it&#039;s super hard to search this thread.&#160; My system specs are in my signature.&#160; I passthrough my nvidia card to my VM, and I use the Intel P4600 graphics on my host.&#160; I have been building the acs override patch, i915 VGA arbiter fix, and the VGA arbiter fix.&#160; I boot using efi stubs and refind.</p><p><span style="color: red">Please, make sure you understand what the following commands do.&#160; Don&#039;t just copy and paste what I have here.&#160; There is a serious risk it could break your install.&#160; Don&#039;t drop your existing kernel until you know the patched one is working.&#160; Don&#039;t blame me for any broken installs!</span></p><p>Requirements: <a href="https://wiki.archlinux.org/index.php/Yaourt" rel="nofollow">yaourt</a>, customizepkg, and <a href="https://wiki.archlinux.org/index.php/Abs" rel="nofollow">Abs</a>.</p><p>First of all, save the patches you need to apply to a location where the userid that will use yaourt can reach.&#160; I have a build directory in my home folder, so I placed them there.</p><p>Second, take a look at <a href="https://wiki.archlinux.org/index.php/Abs#How_to_use_ABS" rel="nofollow">How to use ABS</a>.&#160; Copy the kernel you want to patch and open up the PKGBUILD file in your text editor.&#160; Look for the prepare() section.&#160; Specifically where all the patch files are located.&#160; You&#039;re going to use customizepkg to recognize where you want your patches to be inserted.&#160; You&#039;ll need to copy one of the patch entries.&#160; For the linux package I used the following as my entry point:&#160; </p><div class="codebox"><pre><code>patch -p1 -i &quot;${srcdir}/change-default-console-loglevel.patch&quot;</code></pre></div><p>Open up your favorite text editor and create /etc/customizepkg.d/linux.&#160; The file name should reflect the name of the package you are installing.&#160; If it&#039;s linux-ck you should use /etc/customizepkg.d/linux-ck.</p><p>In that file, place the following on a <strong>single line (very important!)</strong>:&#160; </p><div class="codebox"><pre><code>replace#global#patch -p1 -i \&quot;${srcdir}\\/change-default-console-loglevel.patch\&quot;#patch -p1 -i \&quot;${srcdir}\\/change-default-console-loglevel.patch\&quot;\\npatch -p1 -i \&quot;\\/PATH_TO_PATCHES\\/i915_316.patch\&quot;\\npatch -p1 -i \&quot;\\/PATH_TO_PATCHES\\/override_for_missing_acs_capabilities.patch\&quot;\\npatch -p1 -i \&quot;\\PATH_TO_PATCHES\\/vga_arbitrer.patch\&quot;</code></pre></div><p>This code snippet will only for work for the linux package.&#160; If you want to use a different kernel package, you&#039;re on your own to find the place to insert the patches.</p><p>A bit of an explanation of the snippet.&#160; The below is the bit of the PKGBUILD customizepkg watches for.&#160; When this point is reached, everything coming after this point on the same line is added to the PKGBUILD. </p><div class="codebox"><pre><code>replace#global#patch -p1 -i \&quot;${srcdir}\\/change-default-console-loglevel.patch\&quot;</code></pre></div><p>Below is what is being added to the PKGBUILD.&#160; I added change-default-console-loglevel.patch back in because I still want that patch applied.&#160; If you don&#039;t add it back in, that patch will be dropped.&#160; </p><div class="codebox"><pre><code>#patch -p1 -i \&quot;${srcdir}\\/change-default-console-loglevel.patch\&quot;\\npatch -p1 -i \&quot;\\/PATH_TO_PATCHES\\/i915_316.patch\&quot;\\npatch -p1 -i \&quot;\\/PATH_TO_PATCHES\\/override_for_missing_acs_capabilities.patch\&quot;\\npatch -p1 -i \&quot;\\PATH_TO_PATCHES\\/vga_arbitrer.patch\&quot;</code></pre></div><p>Save the file, and now it&#039;s time test!</p><div class="codebox"><pre><code>yaourt -S linux</code></pre></div><p>Take a look at the output.&#160; You should see customizepkg doing its thing.&#160; Your three patches should show up a few lines above where yaourt asks if you wan to edit the PKGBUILD.&#160; They probably wont be listed at the start where it receives the file list.&#160; This is OK.&#160; Also, it will tell you if there are any errors.&#160; If there are errors from sed you&#039;ll need to tweak your file in customizepkg.d.&#160; All slashes and double quotes need to be escaped.&#160; That&#039;s a common error.&#160; If there are no errors, continue the build and see if it completes.&#160; If it compiles and installs properly, try booting from the new kernel.&#160; Finally, try out your VM.</p><p>If all goes well, you should be able to update your whole system without having to do anything else manually using: </p><div class="codebox"><pre><code>yaourt -Syua</code></pre></div><p>It&#039;s worth watching the first page of this thread to see if any of the patches are changed every now and then.&#160; Also, be careful if the kernel changes from one major kernel version to another (3.16 -&gt; 3.17).&#160; I just starting using this method, so I&#039;m not sure if things will break at that point.</p><p>If there is a better, cleaner way of doing this, please let me know!&#160; I recognize this is kind of hackish, but it works well for me so far.</p> <p class="postedit"><em>Last edited by BahbGTR (2014-08-22 15:51:28)</em></p> </div> <div class="postsignature postmsg"><hr /><p>Xeon E3 1245v3&#160; |&#160; ASRock Z87 Extreme6&#160; |&#160; 20 GB DDR3-1666&#160; |&#160; EVGA Nvidia GTX 560 ti |&#160; MSI Nvidia GTX 760 (passthrough)&#160; |&#160; 256 GB Samsung 850 Pro | 120 GB Samsung 830&#160; |&#160; 300 GB WD Velociraptor&#160; |&#160; 2 TB WD Black</p></div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1449432">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div class="postlinksb"> <div class="inbox crumbsplus"> <div class="pagepost"> <p class="pagelink conl"><span class="pages-label">Pages: </span><a rel="prev" class="item1" href="viewtopic.php?id=162768&amp;p=101">Previous</a> <a href="viewtopic.php?id=162768">1</a> <span class="spacer">…</span> <a href="viewtopic.php?id=162768&amp;p=100">100</a> <a href="viewtopic.php?id=162768&amp;p=101">101</a> <strong>102</strong> <a href="viewtopic.php?id=162768&amp;p=103">103</a> <a href="viewtopic.php?id=162768&amp;p=104">104</a> <span class="spacer">…</span> <a href="viewtopic.php?id=162768&amp;p=234">234</a> <a rel="next" href="viewtopic.php?id=162768&amp;p=103">Next</a></p> <p class="postlink conr">Topic closed</p> </div> <ul class="crumbs"> <li><a href="index.php">Index</a></li> <li><span>»&#160;</span><a href="viewforum.php?id=48">Topics Going Nowhere</a></li> <li><span>»&#160;</span><strong><a href="viewtopic.php?id=162768">KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</a></strong></li> </ul> <p class="subscribelink clearb"><a href="misc.php?action=subscribe&amp;tid=162768">Subscribe to this topic</a></p> <div class="clearer"></div> </div> </div> </div> <div id="brdfooter" class="block"> <h2><span>Board footer</span></h2> <div class="box"> <div id="brdfooternav" class="inbox"> <div class="conl"> <form id="qjump" method="get" action="viewforum.php"> <div><label><span>Jump to<br /></span> <select name="id" onchange="window.location=('viewforum.php?id='+this.options[this.selectedIndex].value)"> <optgroup label="Technical Issues and Assistance"> <option value="23">Newbie Corner</option> <option value="17">Installation</option> <option value="22">Kernel &amp; Hardware</option> <option value="18">Applications &amp; Desktop Environments</option> <option value="31">Laptop Issues</option> <option value="8">Networking, Server, and Protection</option> <option value="32">Multimedia and Games</option> <option value="50">System Administration</option> <option value="35">Other Architectures</option> </optgroup> <optgroup label="Arch-centric"> <option value="24">Announcements, Package &amp; Security Advisories</option> <option value="1">Arch Discussion</option> <option value="13">Forum &amp; Wiki discussion</option> </optgroup> <optgroup label="Pacman Upgrades, Packaging &amp; AUR"> <option value="44">Pacman &amp; Package Upgrade Issues</option> <option value="49">[testing] Repo Forum</option> <option value="4">Creating &amp; Modifying Packages</option> <option value="38">AUR Issues, Discussion &amp; PKGBUILD Requests</option> </optgroup> <optgroup label="Contributions &amp; Discussion"> <option value="20">GNU/Linux Discussion</option> <option value="27">Community Contributions</option> <option value="33">Programming &amp; Scripting</option> <option value="30">Other Languages</option> <option value="47">Artwork and Screenshots</option> <option value="42">Try This</option> </optgroup> <optgroup label="/dev/null"> <option value="29">Off-Topic</option> <option value="48" selected="selected">Topics Going Nowhere</option> <option value="36">Dustbin</option> </optgroup> </select></label> <input type="submit" value=" Go " accesskey="g" /> </div> </form> </div> <div class="conr"> <p id="feedlinks"><span class="atom"><a href="extern.php?action=feed&amp;tid=162768&amp;type=atom">Atom topic feed</a></span></p> <p id="poweredby">Powered by <a href="http://fluxbb.org/">FluxBB</a></p> </div> <div class="clearer"></div> </div> </div> </div> </div> <div class="end-box"></div> </div> </body> </html>
