<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"> <html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en" dir="ltr"> <head> <meta http-equiv="Content-Type" content="text/html; charset=utf-8" /> <title>KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9 (Page 151) / Topics Going Nowhere / Arch Linux Forums</title> <link rel="stylesheet" type="text/css" href="style/ArchLinux.css" /> <link rel="canonical" href="viewtopic.php?id=162768&amp;p=151" title="Page 151" /> <link rel="prev" href="viewtopic.php?id=162768&amp;p=150" title="Page 150" /> <link rel="next" href="viewtopic.php?id=162768&amp;p=152" title="Page 152" /> <link rel="alternate" type="application/atom+xml" href="extern.php?action=feed&amp;tid=162768&amp;type=atom" title="Atom topic feed" /> <link rel="stylesheet" media="screen" href="style/ArchLinux/arch.css?v=3" /> <link rel="stylesheet" media="screen" href="style/ArchLinux/archnavbar.css?v=2" /> <link rel="shortcut icon" href="style/ArchLinux/favicon.ico" /> </head> <body> <div id="archnavbar" class="anb-forum"> <div id="archnavbarlogo"><h1><a href="http://www.archlinux.org/">Arch Linux</a></h1></div> <div id="archnavbarmenu"> <ul id="archnavbarlist"> <li id="anb-home"><a href="http://www.archlinux.org/">Home</a></li><li id="anb-packages"><a href="http://www.archlinux.org/packages/">Packages</a></li><li id="anb-forums" class="anb-selected"><a href="https://bbs.archlinux.org/">Forums</a></li><li id="anb-wiki"><a href="https://wiki.archlinux.org/">Wiki</a></li><li id="anb-bugs"><a href="https://bugs.archlinux.org/">Bugs</a></li><li id="anb-aur"><a href="https://aur.archlinux.org/">AUR</a></li><li id="anb-download"><a href="http://www.archlinux.org/download/">Download</a></li> </ul> </div> </div> <div id="punviewtopic" class="pun"> <div class="top-box"></div> <div class="punwrap"> <div id="brdheader" class="block"> <div class="box"> <div id="brdmenu" class="inbox"> <ul> <li id="navindex" class="isactive"><a href="index.php">Index</a></li> <li id="navuserlist"><a href="userlist.php">User list</a></li> <li id="navsearch"><a href="search.php">Search</a></li> <li id="navprofile"><a href="profile.php?id=80749">Profile</a></li> <li id="navlogout"><a href="login.php?action=out&amp;id=80749&amp;csrf_token=5c20501ec397bb45ef8ee8c84db232c8d8e421c6">Logout</a></li> </ul> </div> <div id="brdwelcome" class="inbox"> <ul class="conl"> <li><span>Logged in as <strong>SXX</strong></span></li> <li><span>Last visit: 2015-08-16 12:20:09</span></li> </ul> <ul class="conr"> <li><span>Topics: <a href="search.php?action=show_replies" title="Find topics you have posted to.">Posted</a> | <a href="search.php?action=show_new" title="Find topics with new posts since your last visit.">New</a> | <a href="search.php?action=show_recent" title="Find topics with recent posts.">Active</a> | <a href="search.php?action=show_unanswered" title="Find topics with no replies.">Unanswered</a></span></li> </ul> <div class="clearer"></div> </div> </div> </div> <div id="brdmain"> <div class="linkst"> <div class="inbox crumbsplus"> <ul class="crumbs"> <li><a href="index.php">Index</a></li> <li><span>»&#160;</span><a href="viewforum.php?id=48">Topics Going Nowhere</a></li> <li><span>»&#160;</span><strong><a href="viewtopic.php?id=162768">KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</a></strong></li> </ul> <div class="pagepost"> <p class="pagelink conl"><span class="pages-label">Pages: </span><a rel="prev" class="item1" href="viewtopic.php?id=162768&amp;p=150">Previous</a> <a href="viewtopic.php?id=162768">1</a> <span class="spacer">…</span> <a href="viewtopic.php?id=162768&amp;p=149">149</a> <a href="viewtopic.php?id=162768&amp;p=150">150</a> <strong>151</strong> <a href="viewtopic.php?id=162768&amp;p=152">152</a> <a href="viewtopic.php?id=162768&amp;p=153">153</a> <span class="spacer">…</span> <a href="viewtopic.php?id=162768&amp;p=234">234</a> <a rel="next" href="viewtopic.php?id=162768&amp;p=152">Next</a></p> <p class="postlink conr">Topic closed</p> </div> <div class="clearer"></div> </div> </div> <div id="p1491000" class="blockpost rowodd blockpost1"> <h2><span><span class="conr">#3751</span> <a href="viewtopic.php?pid=1491000#p1491000">2015-01-07 13:06:09</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=86321">thearcherblog</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2014-10-30</span></dd> <dd><span>Posts: 165</span></dd> <dd class="usercontacts"><span class="email"><a href="mailto:jjgarcianorway@gmail.com">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>4kGamer wrote:</cite><blockquote><div><div class="quotebox"><cite>Ansa89 wrote:</cite><blockquote><div><div class="quotebox"><cite>Duelist wrote:</cite><blockquote><div><p>Also, if you&#039;re sure that your host disks are okay, try preparing your windows to migrating on virtio-blk-pci instead of scsi-way. That involves creating a dummy-drive on virtio-blk-pci device and feeding windows with drivers from virtio.iso and then &quot;reconnecting&quot; the drive.</p></div></blockquote></div><p>The disk seems good to me, which qemu options I need to use virtio-blk-pci?</p></div></blockquote></div><div class="quotebox"><cite>Duelist wrote:</cite><blockquote><div><p>First - you&#039;ve got to create a -device entry with virtio-blk-pci and drive=null, where -drive=/dev/null,id=null,if=none,format=raw .<br />Second - you boot windows with virtio.iso plugged into it, load the drivers for that disk controller.<br />Third - you change the drive of given virtio-blk-pci device to your windows drive and it should boot. If it gets BSOD 7B during startup - drivers for disk controller aren&#039;t installed.</p></div></blockquote></div><div class="quotebox"><cite>JohnyPea wrote:</cite><blockquote><div><div class="quotebox"><cite>Ansa89 wrote:</cite><blockquote><div><p>PS: what are the benefits of using virtio-blk instead of virtio-scsi?</p></div></blockquote></div><p>With virtio-blk you can use x-data-plane=on, which increases IOPS in guest and lowers overhead in host. In windows guest I wasn&#039;t able to pass trim operations through virtio-blk as opposed to virtio-scsi. Later I found a workaround to this by using detect-zeroes=on with discard=&#039;unmap&#039; and writing zeros to desired sectors (zero out unused disk space inside guest).</p></div></blockquote></div><p>Can someone please share with me how I can enable virtio-blk-data-plane for the Libvirt Domain XML?</p><p>I couldn&#039;t transform these posts into my XML.</p><p>I also found some slides from redhat, but they don&#039;t work either. How does the relevant code look like in XML?</p><p>I am trying for some days now without luck.</p><p>thank you very much.</p></div></blockquote></div><p>I didn&#039;t tried before but seems like google has the answer: <a href="http://blog.vmsplice.net/2013/03/new-in-qemu-14-high-performance-virtio.html" rel="nofollow">http://blog.vmsplice.net/2013/03/new-in … irtio.html</a></p><p>Regards,</p><br /><p>TheArcher</p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1491000">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1491037" class="blockpost roweven"> <h2><span><span class="conr">#3752</span> <a href="viewtopic.php?pid=1491037#p1491037">2015-01-07 15:17:16</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=86302">4kGamer</a></strong></dt> <dd class="usertitle"><strong>Banned</strong></dd> <dd><span>Registered: 2014-10-29</span></dd> <dd><span>Posts: 82</span></dd> <dd class="usercontacts"><span class="email"><a href="mailto:oktayaslantas@gmx.de">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <p>thank you TheArcher! Always there when needed <img src="https://bbs.archlinux.org/img/smilies/smile.png" width="15" height="15" alt="smile" /></p><p>I found that page too. But on that page it doesn&#039;t mention anything about <strong>detect-zeroes=on</strong> and how do I &quot;zero out unused disk space inside guest&quot;?</p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1491037">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1491053" class="blockpost rowodd"> <h2><span><span class="conr">#3753</span> <a href="viewtopic.php?pid=1491053#p1491053">2015-01-07 16:32:49</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=86302">4kGamer</a></strong></dt> <dd class="usertitle"><strong>Banned</strong></dd> <dd><span>Registered: 2014-10-29</span></dd> <dd><span>Posts: 82</span></dd> <dd class="usercontacts"><span class="email"><a href="mailto:oktayaslantas@gmx.de">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <p>and it says &quot;Red Hat VirtIO SCSI Disk Device&quot; in Device Manager in Windows. Is this correct for virtio-blk-<strong>data-plane</strong>?</p><br /><p>and these are the relevant parts of my XML:</p><div class="quotebox"><blockquote><div><p>&lt;domain type=&#039;kvm&#039; xmlns:qemu=&#039;http://libvirt.org/schemas/domain/qemu/1.0&#039;&gt;</p></div></blockquote></div><div class="quotebox"><blockquote><div><p>&lt;disk type=&#039;block&#039; device=&#039;disk&#039;&gt;<br />&#160; &#160; &#160; &lt;driver name=&#039;qemu&#039; type=&#039;raw&#039; cache=&#039;none&#039; io=&#039;native&#039; <strong>discard=&#039;unmap&#039;</strong>/&gt;<br />&#160; &#160; &#160; &lt;source dev=&#039;/dev/sda&#039;/&gt;<br />&#160; &#160; &#160; &lt;target dev=&#039;vda&#039; bus=&#039;virtio&#039;/&gt;<br />&#160; &#160; &#160; &lt;boot order=&#039;1&#039;/&gt;<br />&#160; &#160; &#160; &lt;address type=&#039;pci&#039; domain=&#039;0x0000&#039; bus=&#039;0x00&#039; slot=&#039;0x0f&#039; function=&#039;0x0&#039;/&gt;<br />&#160; &#160; &lt;/disk&gt;</p></div></blockquote></div><div class="quotebox"><blockquote><div><p>&lt;qemu:commandline&gt;<br />&#160; &#160; &lt;qemu:arg value=&#039;-set&#039;/&gt;<br />&#160; &#160; &lt;qemu:arg value=&#039;device.virtio-disk0.scsi=off&#039;/&gt;<br />&#160; &#160; &lt;qemu:arg value=&#039;-set&#039;/&gt;<br />&#160; &#160; &lt;qemu:arg value=&#039;device.virtio-disk0.config-wce=off&#039;/&gt;<br />&#160; &#160; &lt;qemu:arg value=&#039;-set&#039;/&gt;<br />&#160; &#160; &lt;qemu:arg value=&#039;device.virtio-disk0.x-data-plane=on&#039;/&gt;<br />&#160; &lt;/qemu:commandline&gt;</p></div></blockquote></div> <p class="postedit"><em>Last edited by 4kGamer (2015-01-07 17:30:16)</em></p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1491053">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1491112" class="blockpost roweven"> <h2><span><span class="conr">#3754</span> <a href="viewtopic.php?pid=1491112#p1491112">2015-01-07 19:35:44</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=79471">Bronek</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>From: London</span></dd> <dd><span>Registered: 2014-02-14</span></dd> <dd><span>Posts: 90</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=79471">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <p>Success story, it took me few days to get it right by seems pretty stable. The biggest obstacle was ZFS on Linux as root partition (still causing hiccups - obviously not related to topic at all) and few silly mistakes in network setup etc. Other issue was selection of hardware passed-thru eventually I settled for either of my two GPUs (AMD Turks ie. FirePro V4900 and Hawaii ie. 290X - both work nicely), all USB controllers (but one) including PCIe cards and keyboard (attached to only USB controller remaining to host). From the start the intent was to <strong>not</strong> to leave any graphic capability to host, and both GPU cards are meant for virtual machines. For this I simply blacklisted radeon and configured pci-stub to take the ownership of both cards.</p><p>Following Alex&#039;s advice I set to use FX440 rather than Q35, also right from the start I installed Windows on Virtio thus being spared abysmal perfomance of emulated disk. Also I do not use HDMI audio output and do not plan on using it, my audio is from DAC attached to one of passed-thru USB controllers. I had BSODs or other problems if I explicitly declared CPU type to something different than qemu64 (or host), tried SandyBridge and Nehalem. I also run almost exactly same command to start Linux guest (mint 17.1) which also runs nicely - obvious differences being -rtc base=utc, different -drive for disk backing store and virtio network card rather than e1000 (I might try virtio on Windows again actually, there may be better versions avialable).</p><p>My goal is to split my machine into 3 machines - one &quot;visible&quot; Windows that you will see after starting the computer, &quot;invisible&quot; host which provides zfs for user files shared over virtual network and another &quot;invisible&quot; linux machine for general hacking and experimentation. Both linux machines to be accessed through shh &quot;as if they were over network&quot;. I might eventually split the machine to run concurrently two &quot;visible&quot; Windows since it has two GPUs , enough CPU power and enough RAM for that. Only a question of finding space on desk for another monitor and keyboard.</p><p>Here is my qemu command:</p><div class="codebox"><pre><code>#!/bin/bash qemu-system-x86_64 -enable-kvm \ -M pc -m 16G -mem-path /dev/hugepages \ -smp cpus=8,cores=4,threads=2,sockets=2 \ -cpu host,hv-time,hv_relaxed,hv_vapic,hv_spinlocks=0x1000 \ -bios /usr/share/qemu/bios.bin \ -rtc base=localtime,clock=host \ -nodefaults \ -nographic -vga none \ -monitor stdio \ -boot order=c \ -device vfio-pci,host=02:00.0,addr=08.0,romfile=ROM/Hawaii-1.rom,x-vga=on \ -device vfio-pci,host=00:1b.0,addr=09.0 \ -device vfio-pci,host=00:1d.0,addr=0a.0 \ -device vfio-pci,host=00:1a.0,addr=0b.0 \ -device vfio-pci,host=81:00.0,addr=0e.0 \ -device vfio-pci,host=83:00.0,addr=0f.0 \ -usb -usbdevice host:04D9:2011 \ -drive file=/dev/zvol/zdata/image1,id=disk0,format=raw,if=virtio \ -drive file=/home/bronek/windows7.iso,id=isocd0,if=none -device ide-cd,drive=isocd0 \ -drive file=/home/bronek/virtio-win-0.1-94.iso,id=isocd1,if=none -device ide-cd,drive=isocd1\ -netdev bridge,br=br0,id=net0 -net nic,netdev=net0,macaddr=52:54:01:23:45:f5,model=e1000</code></pre></div><p>My software versions are qemu-2.2.0 (from testing), linux-3.17.7 (modified linux 3.17.6 package with newer version and own config) and zfs 0.6.3-r1.2 + few patches from zfsonlinux (modified archzfs package).</p><p>I also switched from systemd-networkd to netctl because I liked its configuration better and enabled sysctl for definition of iptables overrides for bridge and for initialisation of huge pages:</p><div class="codebox"><pre><code>root@gdansk ~ # cat /etc/sysctl.d/80-hugepages.conf # Reserve 40GB in 2MB pages for virtual machines vm.nr_hugepages = 20480; root@gdansk ~ # cat /etc/sysctl.d/81-bridge.conf # Disable ip tables on bridge frames net.bridge.bridge-nf-call-ip6tables = 0 net.bridge.bridge-nf-call-iptables = 0 net.bridge.bridge-nf-call-arptables = 0</code></pre></div><p>Didnt run any games yet - this machine is actually not &quot;for gaming&quot; although I will certainly allow my children to play&#160; games.</p><p>Next step is to replace qemu command with libvirt (for CPU pinning, automatic start and managment) but without GUI managment part since the host is headless and I only access it through SSH (and I like command line in Linux better than GUI tools). I also plan to setup smb sharing of zfs setup on the host, with the guest. Tempted to make it Kerberos with help of samba4 running on host but not sure, I might not have time for that.</p><p>Last part I was struggling to find qemu guest agent for Windows binaries (for VSS support) prepared by someone but even without it I can take backups of my guest, the only difference being I need to do it offline. Building qemu guest agent myself, from qemu sources proved to be bit more difficult than I expected it to be. Although I might try it again later.</p> <p class="postedit"><em>Last edited by Bronek (2015-01-07 19:38:34)</em></p> </div> <div class="postsignature postmsg"><hr /><p>Sorry about&#160; &quot;KVM VGA-Passthrough ...&quot; thread <img src="https://bbs.archlinux.org/img/smilies/sad.png" width="15" height="15" alt="sad" /> Anyone interested in continuing this discussion elsewhere, please contact me privately. I might be able to find it a new home.</p></div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1491112">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1491117" class="blockpost rowodd"> <h2><span><span class="conr">#3755</span> <a href="viewtopic.php?pid=1491117#p1491117">2015-01-07 19:45:17</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=75590">aw</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2013-10-04</span></dd> <dd><span>Posts: 921</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=75590">Email</a></span> <span class="website"><a href="http://vfio.blogspot.com/" rel="nofollow">Website</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>Bronek wrote:</cite><blockquote><div><p>Success story, it took me few days to get it right by seems pretty stable.</p></div></blockquote></div><p>Thanks for the report and congrats!&#160; Tiny tip, add <em>-serial none -parallel none</em> to your QEMU commandline to avoid the terminal needing a reset after guest shutdown.&#160; I think some recent upstream changes preventing multiple things being muxed to stdio will require this for the next release anyway.</p> </div> <div class="postsignature postmsg"><hr /><p><a href="http://vfio.blogspot.com" rel="nofollow">http://vfio.blogspot.com</a><br />Looking for a more open forum to discuss vfio related uses?&#160; Try <a href="https://www.redhat.com/mailman/listinfo/vfio-users" rel="nofollow">https://www.redhat.com/mailman/listinfo/vfio-users</a></p></div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1491117">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1491124" class="blockpost roweven"> <h2><span><span class="conr">#3756</span> <a href="viewtopic.php?pid=1491124#p1491124">2015-01-07 20:05:24</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=79471">Bronek</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>From: London</span></dd> <dd><span>Registered: 2014-02-14</span></dd> <dd><span>Posts: 90</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=79471">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <p>Regarding virtio Ethernet adapter for Windows, version virtio-win-0.1-94 didn&#039;t work for me, but version virtio-win-0.1-81 did, so I&#039;m no longer using e1000. Virtio SCSI driver worked from both versions. I&#039;m running Windows 7 Ultimate.</p><p>Now to that libvirt setup .... hope it wont be that hard.</p> </div> <div class="postsignature postmsg"><hr /><p>Sorry about&#160; &quot;KVM VGA-Passthrough ...&quot; thread <img src="https://bbs.archlinux.org/img/smilies/sad.png" width="15" height="15" alt="sad" /> Anyone interested in continuing this discussion elsewhere, please contact me privately. I might be able to find it a new home.</p></div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1491124">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1491128" class="blockpost rowodd"> <h2><span><span class="conr">#3757</span> <a href="viewtopic.php?pid=1491128#p1491128">2015-01-07 20:09:52</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=79471">Bronek</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>From: London</span></dd> <dd><span>Registered: 2014-02-14</span></dd> <dd><span>Posts: 90</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=79471">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>aw wrote:</cite><blockquote><div><p>Thanks for the report and congrats!&#160; Tiny tip, add <em>-serial none -parallel none</em> to your QEMU commandline to avoid the terminal needing a reset after guest shutdown.&#160; I think some recent upstream changes preventing multiple things being muxed to stdio will require this for the next release anyway.</p></div></blockquote></div><p>Thanks for the tip, I&#039;m using -nodefaults since that seemed the only way to get rid of bogus floppy drive and also to get -monitor stdio working (wont need it after migration to libvirt, but now its very useful) but I will add the above nevertheless <img src="https://bbs.archlinux.org/img/smilies/smile.png" width="15" height="15" alt="smile" /></p><p>Any other tips will be hugely appreciated <img src="https://bbs.archlinux.org/img/smilies/smile.png" width="15" height="15" alt="smile" /></p> </div> <div class="postsignature postmsg"><hr /><p>Sorry about&#160; &quot;KVM VGA-Passthrough ...&quot; thread <img src="https://bbs.archlinux.org/img/smilies/sad.png" width="15" height="15" alt="sad" /> Anyone interested in continuing this discussion elsewhere, please contact me privately. I might be able to find it a new home.</p></div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1491128">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1491252" class="blockpost roweven"> <h2><span><span class="conr">#3758</span> <a href="viewtopic.php?pid=1491252#p1491252">2015-01-08 06:18:26</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=86321">thearcherblog</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2014-10-30</span></dd> <dd><span>Posts: 165</span></dd> <dd class="usercontacts"><span class="email"><a href="mailto:jjgarcianorway@gmail.com">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>4kGamer wrote:</cite><blockquote><div><p>thank you TheArcher! Always there when needed <img src="https://bbs.archlinux.org/img/smilies/smile.png" width="15" height="15" alt="smile" /></p><p>I found that page too. But on that page it doesn&#039;t mention anything about <strong>detect-zeroes=on</strong> and how do I &quot;zero out unused disk space inside guest&quot;?</p></div></blockquote></div><p>Hello sir,</p><p>According to <a href="http://qemu.11.n7.nabble.com/is-x-data-plane-considered-quot-stable-quot-td293026.html#a293049" rel="nofollow">http://qemu.11.n7.nabble.com/is-x-data- … ml#a293049</a>, dataplane is deprecated and will be removed on QEMU 2.2.</p><p>I do not know exactly the problem you have with the performance but, in my case, with normal image (raw), my windows 8.1 boots in 2 seconds on a SSD non dedicated one. I think is enough performance for me <img src="https://bbs.archlinux.org/img/smilies/smile.png" width="15" height="15" alt="smile" /></p><p>Best regards,</p><br /><p>TheArcher</p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1491252">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1491255" class="blockpost rowodd"> <h2><span><span class="conr">#3759</span> <a href="viewtopic.php?pid=1491255#p1491255">2015-01-08 07:08:01</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=86302">4kGamer</a></strong></dt> <dd class="usertitle"><strong>Banned</strong></dd> <dd><span>Registered: 2014-10-29</span></dd> <dd><span>Posts: 82</span></dd> <dd class="usercontacts"><span class="email"><a href="mailto:oktayaslantas@gmx.de">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <p>hello! I didn&#039;t know that. Thank you very much. This is valuable information for me. Some of us here are obviously confused with what&#039;s best as a storage device. </p><p>To tell you the truth I don&#039;t even know how to rate my performance. I guess all the Windows benchmark tools for assessing hardware cannot be regarded as reliable.</p><p>What benchmark tools do you use or can you recommend? Especially for storage (IOPS and 4k random read/write in particular)</p> <p class="postedit"><em>Last edited by 4kGamer (2015-01-08 07:14:51)</em></p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1491255">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1491262" class="blockpost roweven"> <h2><span><span class="conr">#3760</span> <a href="viewtopic.php?pid=1491262#p1491262">2015-01-08 08:00:24</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=86321">thearcherblog</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2014-10-30</span></dd> <dd><span>Posts: 165</span></dd> <dd class="usercontacts"><span class="email"><a href="mailto:jjgarcianorway@gmail.com">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <p>I never use benchmark utilities because normally are synthetic ones and are just numbers that can be really different from the real performance I&#039;m getting. Well, to be honest I run them on the beginning... you know, the normal ones, some for graphic card and some for general... but I have been too many years working with computers to know that best benchmark utilities and results does not mean that is better performance... talking about phones... look antutu results for different phones and read the feelings... No one is agree! <img src="https://bbs.archlinux.org/img/smilies/smile.png" width="15" height="15" alt="smile" /></p><p>For me is just a feeling, I mean, if I can run my games and boots ok, can copy files in a reasonable time, etc... is ok. Sometimes I notice that is slower or not giving me the right performance and then I look for some information about but, talking about the QEMU/KVM... I&#039;m so happy about how it works. Performance is really good even when I&#039;m not checking it with benchmarks.</p><p>Cheers,</p><br /><p>TheArcher</p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1491262">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1491264" class="blockpost rowodd"> <h2><span><span class="conr">#3761</span> <a href="viewtopic.php?pid=1491264#p1491264">2015-01-08 08:12:32</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=86302">4kGamer</a></strong></dt> <dd class="usertitle"><strong>Banned</strong></dd> <dd><span>Registered: 2014-10-29</span></dd> <dd><span>Posts: 82</span></dd> <dd class="usercontacts"><span class="email"><a href="mailto:oktayaslantas@gmx.de">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <p>yeah you&#039;re definitely right! I completely agree. </p><p>I am not after certain numbers. It&#039;s only that sometimes I experience issues in Games and I wonder if it&#039;s related to poor disk performance. I therefore need to make sure that I have the right tools to test NOW so I don&#039;t have to worry LATER.</p><p>So it&#039;s only to get the configuration right. And I am happy you made me aware that I was trying a depriaciated technique. Before I also tried SATA passthrough which worked fine for most parts, but then I had issues in Games and I still don&#039;t know why ...</p><p>some tools would definitely help for now <img src="https://bbs.archlinux.org/img/smilies/smile.png" width="15" height="15" alt="smile" /></p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1491264">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1491267" class="blockpost roweven"> <h2><span><span class="conr">#3762</span> <a href="viewtopic.php?pid=1491267#p1491267">2015-01-08 08:23:32</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=86321">thearcherblog</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2014-10-30</span></dd> <dd><span>Posts: 165</span></dd> <dd class="usercontacts"><span class="email"><a href="mailto:jjgarcianorway@gmail.com">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <p>But... what kind of issues do you have?</p><p>As I&#039;m not expert, maybe if you put your hardware configuration, config files and so on, and describe as detailed as possible the problems... maybe a guru from here can help you <img src="https://bbs.archlinux.org/img/smilies/smile.png" width="15" height="15" alt="smile" /></p><p>Cheers <img src="https://bbs.archlinux.org/img/smilies/smile.png" width="15" height="15" alt="smile" /></p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1491267">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1491274" class="blockpost rowodd"> <h2><span><span class="conr">#3763</span> <a href="viewtopic.php?pid=1491274#p1491274">2015-01-08 09:00:07</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=86302">4kGamer</a></strong></dt> <dd class="usertitle"><strong>Banned</strong></dd> <dd><span>Registered: 2014-10-29</span></dd> <dd><span>Posts: 82</span></dd> <dd class="usercontacts"><span class="email"><a href="mailto:oktayaslantas@gmx.de">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <p>ok, I will post my complete config in a few hours. Here is my issue:</p><p>what I experienced a few times already: all of a sudden there is &quot;a glitch&quot; in the Picture, just for a second. And right at that instant CPU usage jumps to 100 % and then it goes down again. Maybe it&#039;s related to disk performance, maybe it&#039;s just the CPU or maybe it&#039;s just a mistake of the Game. I experienced this when I play offline Fifa 15 with friends. (Normally my CPU usage is about 20-30 % when I play Fifa 15 at 4k resolution)<br />I also tried to replicate the issue when I use bare metal Windows, but it didn&#039;t occur in it so far.</p> <p class="postedit"><em>Last edited by 4kGamer (2015-01-08 09:03:03)</em></p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1491274">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1491275" class="blockpost roweven"> <h2><span><span class="conr">#3764</span> <a href="viewtopic.php?pid=1491275#p1491275">2015-01-08 09:04:41</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=86321">thearcherblog</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2014-10-30</span></dd> <dd><span>Posts: 165</span></dd> <dd class="usercontacts"><span class="email"><a href="mailto:jjgarcianorway@gmail.com">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>4kGamer wrote:</cite><blockquote><div><p>ok, I will post my complete config in a few hours. Here is my issue:</p><p>what I experienced a few times already: all of a sudden there is &quot;a glitch&quot; in the Picture, just for a second. And right at that instant CPU usage jumps to 100 % and then it goes down again. Maybe it&#039;s related to disk performance, maybe it&#039;s just the CPU or maybe it&#039;s just a mistake of the Game. I experienced this when I play offline Fifa 15 with friends. I also tried to replicate the issue when I use bare metal Windows, but it didn&#039;t occur in it so far.</p></div></blockquote></div><p>Don&#039;t know for sure but can be several things:</p><p>- As is on playing internet... can be the ethernet? Are you passing it through or emulating?<br />- Can be NVIDIA drivers? (you know, loading an effect or similar)<br />- If it&#039;s not happening with any other game... can be the game? <img src="https://bbs.archlinux.org/img/smilies/smile.png" width="15" height="15" alt="smile" /></p><p>Hope we can solve it together <img src="https://bbs.archlinux.org/img/smilies/smile.png" width="15" height="15" alt="smile" /></p><br /><p>Cheers</p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1491275">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1491276" class="blockpost rowodd"> <h2><span><span class="conr">#3765</span> <a href="viewtopic.php?pid=1491276#p1491276">2015-01-08 09:08:42</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=86302">4kGamer</a></strong></dt> <dd class="usertitle"><strong>Banned</strong></dd> <dd><span>Registered: 2014-10-29</span></dd> <dd><span>Posts: 82</span></dd> <dd class="usercontacts"><span class="email"><a href="mailto:oktayaslantas@gmx.de">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <p>I am passing through my Ethernet. And it happened offline when I played with friends. I couldn&#039;t test thoroughly with other games. I barely played on it so far. A few days back we had a Soccer session here and it happened a few times. Never before and I am familiar with the game.</p><p>So my guess: It could be Nvidia Drivers or the CPU or the disk. But maybe it&#039;s something completely different <img src="https://bbs.archlinux.org/img/smilies/smile.png" width="15" height="15" alt="smile" /></p><p>I will post my complete settings in a few hours. I am very grateful for your help!</p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1491276">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1491277" class="blockpost roweven"> <h2><span><span class="conr">#3766</span> <a href="viewtopic.php?pid=1491277#p1491277">2015-01-08 09:18:51</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=86321">thearcherblog</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2014-10-30</span></dd> <dd><span>Posts: 165</span></dd> <dd class="usercontacts"><span class="email"><a href="mailto:jjgarcianorway@gmail.com">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>4kGamer wrote:</cite><blockquote><div><p>I am passing through my Ethernet. And it happened offline when I played with friends. I couldn&#039;t test thoroughly with other games. I barely played on it so far. A few days back we had a Soccer session here and it happened a few times. Never before and I am familiar with the game.</p><p>So my guess: It could be Nvidia Drivers or the CPU or the disk. But maybe it&#039;s something completely different <img src="https://bbs.archlinux.org/img/smilies/smile.png" width="15" height="15" alt="smile" /></p><p>I will post my complete settings in a few hours. I am very grateful for your help!</p></div></blockquote></div><p>Ok <img src="https://bbs.archlinux.org/img/smilies/smile.png" width="15" height="15" alt="smile" /></p><p>As you have quite similar hadrware as me... Are you passing through the intel LAN isn&#039;t it? I know that the realtek ones give me problems <img src="https://bbs.archlinux.org/img/smilies/smile.png" width="15" height="15" alt="smile" /></p><p>Anyway... yes, can be but... my suggestion to troubleshoot this would be:</p><p>Try different things (different stadiums, weather conditions,... to try to find if there is any pattern)<br />Different NVIDIA drivers... sometimes the last version is not the best, talking by experience<br />I do not know how many vCPU you have assigned or if you have different setup. In my case I assign 4 because if I assign 8 the heat increase really high and I didn&#039;t notice any performance improvement.</p><p>Anyway, I will wait for your config files <img src="https://bbs.archlinux.org/img/smilies/smile.png" width="15" height="15" alt="smile" /></p><p>Cheers.</p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1491277">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1491329" class="blockpost rowodd"> <h2><span><span class="conr">#3767</span> <a href="viewtopic.php?pid=1491329#p1491329">2015-01-08 13:47:52</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=86302">4kGamer</a></strong></dt> <dd class="usertitle"><strong>Banned</strong></dd> <dd><span>Registered: 2014-10-29</span></dd> <dd><span>Posts: 82</span></dd> <dd class="usercontacts"><span class="email"><a href="mailto:oktayaslantas@gmx.de">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <p>So here is my setup and config files:</p><p><strong>Motherboard:</strong>ASROCK Z97 Extreme6<br /><strong>CPU:</strong> i7-4790k<br /><strong>GPU:</strong> MSI GTX 980 Gaming 4G<br /><strong>RAM:</strong> 12 GB RAM<br /><strong>Storage for Windows 8.1:</strong> Samsung 840 EVO Basic 1TB (/dev/sda)<br /><strong>Linux Kernel:</strong> linux-3.17.6-1 (untouched)</p><p><strong>Packages installed:</strong> <br />qemu 2.1<br />libvirt<br />virt-manager</p><p><strong>cat /proc/cmdline </strong><br />&quot;rw root=/dev/mapper/VG-root rdblacklist=nouveau nouveau.modeset=0 elevator=noop vfio_iommu_type1 intel_iommu=on,igfx_off panic=10 pci-stub.ids=10de:13c0,10de:0fbb,8086:15a1,8086:8cb1 intel_pstate=disable pcie_acs_override=downstream vfio_iommu_type1.allow_unsafe_interrupts=1 quiet&quot;</p><br /><p><strong>/etc/modprobe.d/modprobe.conf: </strong></p><div class="quotebox"><blockquote><div><p>options kvm ignore_msrs=1<br />options intel_kvm emulate_invalid_guest_state=0<br />options intel_kvm nested=1<br />options intel_kvm enable_shadow_vmcs=1<br />options intel_kvm enable_apicv=1<br />options intel_kvm ept=1<br />#options vfio_pci nointxmask=1<br />options vfio_iommu_type1 disable_hugepages=1<br />options vfio_iommu_type1 allow_unsafe_interrupts=1</p></div></blockquote></div><p><strong>/etc/libvirt/qemu/vm1.xml: </strong></p><div class="quotebox"><blockquote><div><p>&lt;!--<br />WARNING: THIS IS AN AUTO-GENERATED FILE. CHANGES TO IT ARE LIKELY TO BE<br />OVERWRITTEN AND LOST. Changes to this xml configuration should be made using:<br />&#160; virsh edit vm1<br />or other application using the libvirt API.<br />--&gt;</p><p>&lt;domain type=&#039;kvm&#039;&gt;<br />&#160; &lt;name&gt;vm1&lt;/name&gt;<br />&#160; &lt;uuid&gt;2459c3f0-4269-4823-55d4-43528ff0d991&lt;/uuid&gt;<br />&#160; &lt;memory unit=&#039;KiB&#039;&gt;10485760&lt;/memory&gt;<br />&#160; &lt;currentMemory unit=&#039;KiB&#039;&gt;10485760&lt;/currentMemory&gt;<br />&#160; &lt;vcpu placement=&#039;static&#039; cpuset=&#039;0-7&#039;&gt;8&lt;/vcpu&gt;<br />&#160; &lt;cputune&gt;<br />&#160; &#160; &lt;vcpupin vcpu=&#039;0&#039; cpuset=&#039;0,4&#039;/&gt;<br />&#160; &#160; &lt;vcpupin vcpu=&#039;1&#039; cpuset=&#039;1,5&#039;/&gt;<br />&#160; &#160; &lt;vcpupin vcpu=&#039;2&#039; cpuset=&#039;2,6&#039;/&gt;<br />&#160; &#160; &lt;vcpupin vcpu=&#039;3&#039; cpuset=&#039;3,7&#039;/&gt;<br />&#160; &#160; &lt;vcpupin vcpu=&#039;4&#039; cpuset=&#039;0,4&#039;/&gt;<br />&#160; &#160; &lt;vcpupin vcpu=&#039;5&#039; cpuset=&#039;1,5&#039;/&gt;<br />&#160; &#160; &lt;vcpupin vcpu=&#039;6&#039; cpuset=&#039;2,6&#039;/&gt;<br />&#160; &#160; &lt;vcpupin vcpu=&#039;7&#039; cpuset=&#039;3,7&#039;/&gt;<br />&#160; &lt;/cputune&gt;<br />&#160; &lt;os&gt;<br />&#160; &#160; &lt;type arch=&#039;x86_64&#039; machine=&#039;pc-i440fx-2.1&#039;&gt;hvm&lt;/type&gt;<br />&#160; &#160; &lt;loader type=&#039;pflash&#039;&gt;/var/lib/libvirt/images/VM1-OVMF.fd&lt;/loader&gt;<br />&#160; &#160; &lt;bootmenu enable=&#039;no&#039;/&gt;<br />&#160; &lt;/os&gt;<br />&#160; &lt;features&gt;<br />&#160; &#160; &lt;acpi/&gt;<br />&#160; &#160; &lt;apic/&gt;<br />&#160; &#160; &lt;pae/&gt;<br />&#160; &#160; &lt;kvm&gt;<br />&#160; &#160; &#160; &lt;hidden state=&#039;on&#039;/&gt;<br />&#160; &#160; &lt;/kvm&gt;<br />&#160; &lt;/features&gt;<br />&#160; &lt;cpu mode=&#039;host-passthrough&#039;&gt;<br />&#160; &#160; &lt;topology sockets=&#039;1&#039; cores=&#039;4&#039; threads=&#039;2&#039;/&gt;<br />&#160; &lt;/cpu&gt;<br />&#160; &lt;clock offset=&#039;localtime&#039;/&gt;<br />&#160; &lt;on_poweroff&gt;destroy&lt;/on_poweroff&gt;<br />&#160; &lt;on_reboot&gt;restart&lt;/on_reboot&gt;<br />&#160; &lt;on_crash&gt;restart&lt;/on_crash&gt;<br />&#160; &lt;pm&gt;<br />&#160; &#160; &lt;suspend-to-mem enabled=&#039;no&#039;/&gt;<br />&#160; &#160; &lt;suspend-to-disk enabled=&#039;no&#039;/&gt;<br />&#160; &lt;/pm&gt;<br />&#160; &lt;devices&gt;<br />&#160; &#160; &lt;emulator&gt;/usr/sbin/qemu-system-x86_64&lt;/emulator&gt;<br />&#160; &#160; &lt;disk type=&#039;block&#039; device=&#039;disk&#039;&gt;<br />&#160; &#160; &#160; &lt;driver name=&#039;qemu&#039; type=&#039;raw&#039; cache=&#039;none&#039; io=&#039;native&#039;/&gt;<br />&#160; &#160; &#160; &lt;source dev=&#039;/dev/sda&#039;/&gt;<br />&#160; &#160; &#160; &lt;target dev=&#039;vda&#039; bus=&#039;virtio&#039;/&gt;<br />&#160; &#160; &#160; &lt;boot order=&#039;1&#039;/&gt;<br />&#160; &#160; &#160; &lt;address type=&#039;pci&#039; domain=&#039;0x0000&#039; bus=&#039;0x00&#039; slot=&#039;0x0f&#039; function=&#039;0x0&#039;/&gt;<br />&#160; &#160; &lt;/disk&gt;<br />&#160; &#160; &lt;disk type=&#039;file&#039; device=&#039;cdrom&#039;&gt;<br />&#160; &#160; &#160; &lt;driver name=&#039;qemu&#039; type=&#039;raw&#039; cache=&#039;none&#039;/&gt;<br />&#160; &#160; &#160; &lt;source file=&#039;/root/virtio-win-0.1-94.iso&#039;/&gt;<br />&#160; &#160; &#160; &lt;target dev=&#039;hda&#039; bus=&#039;ide&#039;/&gt;<br />&#160; &#160; &#160; &lt;readonly/&gt;<br />&#160; &#160; &#160; &lt;boot order=&#039;2&#039;/&gt;<br />&#160; &#160; &#160; &lt;address type=&#039;drive&#039; controller=&#039;0&#039; bus=&#039;0&#039; target=&#039;0&#039; unit=&#039;0&#039;/&gt;<br />&#160; &#160; &lt;/disk&gt;<br />&#160; &#160; &lt;disk type=&#039;file&#039; device=&#039;cdrom&#039;&gt;<br />&#160; &#160; &#160; &lt;driver name=&#039;qemu&#039; type=&#039;raw&#039; cache=&#039;none&#039;/&gt;<br />&#160; &#160; &#160; &lt;source file=&#039;/root/windows.iso&#039;/&gt;<br />&#160; &#160; &#160; &lt;target dev=&#039;hdb&#039; bus=&#039;ide&#039;/&gt;<br />&#160; &#160; &#160; &lt;readonly/&gt;<br />&#160; &#160; &#160; &lt;boot order=&#039;3&#039;/&gt;<br />&#160; &#160; &#160; &lt;address type=&#039;drive&#039; controller=&#039;0&#039; bus=&#039;0&#039; target=&#039;0&#039; unit=&#039;1&#039;/&gt;<br />&#160; &#160; &lt;/disk&gt;<br />&#160; &#160; &lt;controller type=&#039;usb&#039; index=&#039;0&#039; model=&#039;ich9-ehci1&#039;&gt;<br />&#160; &#160; &#160; &lt;address type=&#039;pci&#039; domain=&#039;0x0000&#039; bus=&#039;0x00&#039; slot=&#039;0x0e&#039; function=&#039;0x7&#039;/&gt;<br />&#160; &#160; &lt;/controller&gt;<br />&#160; &#160; &lt;controller type=&#039;usb&#039; index=&#039;0&#039; model=&#039;ich9-uhci1&#039;&gt;<br />&#160; &#160; &#160; &lt;master startport=&#039;0&#039;/&gt;<br />&#160; &#160; &#160; &lt;address type=&#039;pci&#039; domain=&#039;0x0000&#039; bus=&#039;0x00&#039; slot=&#039;0x05&#039; function=&#039;0x0&#039; multifunction=&#039;on&#039;/&gt;<br />&#160; &#160; &lt;/controller&gt;<br />&#160; &#160; &lt;controller type=&#039;usb&#039; index=&#039;0&#039; model=&#039;ich9-uhci2&#039;&gt;<br />&#160; &#160; &#160; &lt;master startport=&#039;2&#039;/&gt;<br />&#160; &#160; &#160; &lt;address type=&#039;pci&#039; domain=&#039;0x0000&#039; bus=&#039;0x00&#039; slot=&#039;0x05&#039; function=&#039;0x1&#039;/&gt;<br />&#160; &#160; &lt;/controller&gt;<br />&#160; &#160; &lt;controller type=&#039;usb&#039; index=&#039;0&#039; model=&#039;ich9-uhci3&#039;&gt;<br />&#160; &#160; &#160; &lt;master startport=&#039;4&#039;/&gt;<br />&#160; &#160; &#160; &lt;address type=&#039;pci&#039; domain=&#039;0x0000&#039; bus=&#039;0x00&#039; slot=&#039;0x05&#039; function=&#039;0x2&#039;/&gt;<br />&#160; &#160; &lt;/controller&gt;<br />&#160; &#160; &lt;controller type=&#039;pci&#039; index=&#039;0&#039; model=&#039;pci-root&#039;/&gt;<br />&#160; &#160; &lt;controller type=&#039;scsi&#039; index=&#039;1&#039; model=&#039;virtio-scsi&#039;&gt;<br />&#160; &#160; &#160; &lt;address type=&#039;pci&#039; domain=&#039;0x0000&#039; bus=&#039;0x00&#039; slot=&#039;0x09&#039; function=&#039;0x0&#039;/&gt;<br />&#160; &#160; &lt;/controller&gt;<br />&#160; &#160; &lt;controller type=&#039;ide&#039; index=&#039;0&#039;&gt;<br />&#160; &#160; &#160; &lt;address type=&#039;pci&#039; domain=&#039;0x0000&#039; bus=&#039;0x00&#039; slot=&#039;0x01&#039; function=&#039;0x1&#039;/&gt;<br />&#160; &#160; &lt;/controller&gt;<br />&#160; &#160; &lt;hostdev mode=&#039;subsystem&#039; type=&#039;pci&#039; managed=&#039;yes&#039;&gt;<br />&#160; &#160; &#160; &lt;driver name=&#039;vfio&#039;/&gt;<br />&#160; &#160; &#160; &lt;source&gt;<br />&#160; &#160; &#160; &#160; &lt;address domain=&#039;0x0000&#039; bus=&#039;0x01&#039; slot=&#039;0x00&#039; function=&#039;0x0&#039;/&gt;<br />&#160; &#160; &#160; &lt;/source&gt;<br />&#160; &#160; &#160; &lt;address type=&#039;pci&#039; domain=&#039;0x0000&#039; bus=&#039;0x00&#039; slot=&#039;0x02&#039; function=&#039;0x0&#039;/&gt;<br />&#160; &#160; &lt;/hostdev&gt;<br />&#160; &#160; &lt;hostdev mode=&#039;subsystem&#039; type=&#039;pci&#039; managed=&#039;yes&#039;&gt;<br />&#160; &#160; &#160; &lt;driver name=&#039;vfio&#039;/&gt;<br />&#160; &#160; &#160; &lt;source&gt;<br />&#160; &#160; &#160; &#160; &lt;address domain=&#039;0x0000&#039; bus=&#039;0x01&#039; slot=&#039;0x00&#039; function=&#039;0x1&#039;/&gt;<br />&#160; &#160; &#160; &lt;/source&gt;<br />&#160; &#160; &#160; &lt;address type=&#039;pci&#039; domain=&#039;0x0000&#039; bus=&#039;0x00&#039; slot=&#039;0x03&#039; function=&#039;0x0&#039;/&gt;<br />&#160; &#160; &lt;/hostdev&gt;<br />&#160; &#160; &lt;hostdev mode=&#039;subsystem&#039; type=&#039;pci&#039; managed=&#039;yes&#039;&gt;<br />&#160; &#160; &#160; &lt;driver name=&#039;vfio&#039;/&gt;<br />&#160; &#160; &#160; &lt;source&gt;<br />&#160; &#160; &#160; &#160; &lt;address domain=&#039;0x0000&#039; bus=&#039;0x00&#039; slot=&#039;0x19&#039; function=&#039;0x0&#039;/&gt;<br />&#160; &#160; &#160; &lt;/source&gt;<br />&#160; &#160; &#160; &lt;address type=&#039;pci&#039; domain=&#039;0x0000&#039; bus=&#039;0x00&#039; slot=&#039;0x04&#039; function=&#039;0x0&#039;/&gt;<br />&#160; &#160; &lt;/hostdev&gt;<br />&#160; &#160; &lt;hostdev mode=&#039;subsystem&#039; type=&#039;pci&#039; managed=&#039;yes&#039;&gt;<br />&#160; &#160; &#160; &lt;driver name=&#039;vfio&#039;/&gt;<br />&#160; &#160; &#160; &lt;source&gt;<br />&#160; &#160; &#160; &#160; &lt;address domain=&#039;0x0000&#039; bus=&#039;0x00&#039; slot=&#039;0x14&#039; function=&#039;0x0&#039;/&gt;<br />&#160; &#160; &#160; &lt;/source&gt;<br />&#160; &#160; &#160; &lt;address type=&#039;pci&#039; domain=&#039;0x0000&#039; bus=&#039;0x00&#039; slot=&#039;0x0b&#039; function=&#039;0x0&#039;/&gt;<br />&#160; &#160; &lt;/hostdev&gt;<br />&#160; &#160; &lt;hostdev mode=&#039;subsystem&#039; type=&#039;pci&#039; managed=&#039;yes&#039;&gt;<br />&#160; &#160; &#160; &lt;driver name=&#039;vfio&#039;/&gt;<br />&#160; &#160; &#160; &lt;source&gt;<br />&#160; &#160; &#160; &#160; &lt;address domain=&#039;0x0000&#039; bus=&#039;0x00&#039; slot=&#039;0x1a&#039; function=&#039;0x0&#039;/&gt;<br />&#160; &#160; &#160; &lt;/source&gt;<br />&#160; &#160; &#160; &lt;address type=&#039;pci&#039; domain=&#039;0x0000&#039; bus=&#039;0x00&#039; slot=&#039;0x0c&#039; function=&#039;0x0&#039;/&gt;<br />&#160; &#160; &lt;/hostdev&gt;<br />&#160; &#160; &lt;hostdev mode=&#039;subsystem&#039; type=&#039;pci&#039; managed=&#039;yes&#039;&gt;<br />&#160; &#160; &#160; &lt;driver name=&#039;vfio&#039;/&gt;<br />&#160; &#160; &#160; &lt;source&gt;<br />&#160; &#160; &#160; &#160; &lt;address domain=&#039;0x0000&#039; bus=&#039;0x00&#039; slot=&#039;0x1d&#039; function=&#039;0x0&#039;/&gt;<br />&#160; &#160; &#160; &lt;/source&gt;<br />&#160; &#160; &#160; &lt;address type=&#039;pci&#039; domain=&#039;0x0000&#039; bus=&#039;0x00&#039; slot=&#039;0x0d&#039; function=&#039;0x0&#039;/&gt;<br />&#160; &#160; &lt;/hostdev&gt;<br />&#160; &#160; &lt;memballoon model=&#039;virtio&#039;&gt;<br />&#160; &#160; &#160; &lt;address type=&#039;pci&#039; domain=&#039;0x0000&#039; bus=&#039;0x00&#039; slot=&#039;0x07&#039; function=&#039;0x0&#039;/&gt;<br />&#160; &#160; &lt;/memballoon&gt;<br />&#160; &lt;/devices&gt;<br />&lt;/domain&gt;</p></div></blockquote></div> <p class="postedit"><em>Last edited by 4kGamer (2015-01-08 14:00:15)</em></p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1491329">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1491331" class="blockpost roweven"> <h2><span><span class="conr">#3768</span> <a href="viewtopic.php?pid=1491331#p1491331">2015-01-08 13:49:07</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=86302">4kGamer</a></strong></dt> <dd class="usertitle"><strong>Banned</strong></dd> <dd><span>Registered: 2014-10-29</span></dd> <dd><span>Posts: 82</span></dd> <dd class="usercontacts"><span class="email"><a href="mailto:oktayaslantas@gmx.de">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <p>If I forgot something just tell me and I&#039;ll provide it <img src="https://bbs.archlinux.org/img/smilies/smile.png" width="15" height="15" alt="smile" /></p><p>oh and yes I pass through the Intel LAN</p><p>and I forgot to post this:</p><p><strong>lsblk</strong></p><div class="quotebox"><blockquote><div><p>00:00.0 Host bridge: Intel Corporation 4th Gen Core Processor DRAM Controller (rev 06)<br />00:01.0 PCI bridge: Intel Corporation Xeon E3-1200 v3/4th Gen Core Processor PCI Express x16 Controller (rev 06)<br />00:02.0 VGA compatible controller: Intel Corporation Xeon E3-1200 v3/4th Gen Core Processor Integrated Graphics Controller (rev 06)<br />00:03.0 Audio device: Intel Corporation Xeon E3-1200 v3/4th Gen Core Processor HD Audio Controller (rev 06)<br /><strong>00:14.0 USB controller: Intel Corporation 9 Series Chipset Family USB xHCI Controller</strong><br />00:16.0 Communication controller: Intel Corporation 9 Series Chipset Family ME Interface #1<br /><strong>00:19.0 Ethernet controller: Intel Corporation Ethernet Connection (2) I218-V</strong><br /><strong>00:1a.0 USB controller: Intel Corporation 9 Series Chipset Family USB EHCI Controller #2</strong><br />00:1c.0 PCI bridge: Intel Corporation 9 Series Chipset Family PCI Express Root Port 1 (rev d0)<br />00:1c.2 PCI bridge: Intel Corporation 9 Series Chipset Family PCI Express Root Port 3 (rev d0)<br />00:1c.3 PCI bridge: Intel Corporation 9 Series Chipset Family PCI Express Root Port 4 (rev d0)<br />00:1c.4 PCI bridge: Intel Corporation 9 Series Chipset Family PCI Express Root Port 5 (rev d0)<br />00:1c.6 PCI bridge: Intel Corporation 9 Series Chipset Family PCI Express Root Port 7 (rev d0)<br /><strong>00:1d.0 USB controller: Intel Corporation 9 Series Chipset Family USB EHCI Controller #1</strong><br />00:1f.0 ISA bridge: Intel Corporation 9 Series Chipset Family Z97 LPC Controller<br />00:1f.2 SATA controller: Intel Corporation 9 Series Chipset Family SATA Controller [AHCI Mode]<br />00:1f.3 SMBus: Intel Corporation 9 Series Chipset Family SMBus Controller<br /><strong>01:00.0 VGA compatible controller: NVIDIA Corporation GM204 [GeForce GTX 980] (rev a1)</strong><br /><strong>01:00.1 Audio device: NVIDIA Corporation GM204 High Definition Audio Controller (rev a1)</strong><br />03:00.0 Ethernet controller: Realtek Semiconductor Co., Ltd. RTL8111/8168/8411 PCI Express Gigabit Ethernet Controller (rev 11)<br />04:00.0 PCI bridge: ASMedia Technology Inc. Device 1184<br />05:01.0 PCI bridge: ASMedia Technology Inc. Device 1184<br />05:03.0 PCI bridge: ASMedia Technology Inc. Device 1184<br />05:05.0 PCI bridge: ASMedia Technology Inc. Device 1184<br />05:07.0 PCI bridge: ASMedia Technology Inc. Device 1184<br />07:00.0 SATA controller: ASMedia Technology Inc. ASM1062 Serial ATA Controller (rev 02)<br />09:00.0 SATA controller: ASMedia Technology Inc. ASM1062 Serial ATA Controller (rev 02)<br />0a:00.0 Multimedia controller: Digital Devices GmbH Octopus DVB Adapter<br />0b:00.0 USB controller: ASMedia Technology Inc. ASM1042A USB 3.0 Host Controller</p></div></blockquote></div><p>the bold ones are the pci devices I passed through (successfully)</p> <p class="postedit"><em>Last edited by 4kGamer (2015-01-08 13:58:10)</em></p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1491331">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1491340" class="blockpost rowodd"> <h2><span><span class="conr">#3769</span> <a href="viewtopic.php?pid=1491340#p1491340">2015-01-08 14:12:27</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=86321">thearcherblog</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2014-10-30</span></dd> <dd><span>Posts: 165</span></dd> <dd class="usercontacts"><span class="email"><a href="mailto:jjgarcianorway@gmail.com">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <p>As you make CPU pin with the libvirt.... is happening the same using the command line? and not using them? I don&#039;t use any CPU pin <img src="https://bbs.archlinux.org/img/smilies/smile.png" width="15" height="15" alt="smile" /></p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1491340">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1491341" class="blockpost roweven"> <h2><span><span class="conr">#3770</span> <a href="viewtopic.php?pid=1491341#p1491341">2015-01-08 14:16:33</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=86302">4kGamer</a></strong></dt> <dd class="usertitle"><strong>Banned</strong></dd> <dd><span>Registered: 2014-10-29</span></dd> <dd><span>Posts: 82</span></dd> <dd class="usercontacts"><span class="email"><a href="mailto:oktayaslantas@gmx.de">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <p>I haven&#039;t tried without CPU Pin, but that is something I am not really sure if I did it correctly. Also hugepages, which are disabled in my setup. I think I have to review both. And like you know I am really uncertain of the storage device. <img src="https://bbs.archlinux.org/img/smilies/smile.png" width="15" height="15" alt="smile" /></p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1491341">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1491351" class="blockpost rowodd"> <h2><span><span class="conr">#3771</span> <a href="viewtopic.php?pid=1491351#p1491351">2015-01-08 14:50:25</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=75590">aw</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2013-10-04</span></dd> <dd><span>Posts: 921</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=75590">Email</a></span> <span class="website"><a href="http://vfio.blogspot.com/" rel="nofollow">Website</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>4kGamer wrote:</cite><blockquote><div><p>So here is my setup and config files:</p><p><strong>Motherboard:</strong>ASROCK Z97 Extreme6<br /><strong>CPU:</strong> i7-4790k<br /><strong>GPU:</strong> MSI GTX 980 Gaming 4G<br /><strong>RAM:</strong> 12 GB RAM<br /><strong>Storage for Windows 8.1:</strong> Samsung 840 EVO Basic 1TB (/dev/sda)<br /><strong>Linux Kernel:</strong> linux-3.17.6-1 (untouched)</p><p><strong>Packages installed:</strong> <br />qemu 2.1<br />libvirt<br />virt-manager</p><p><strong>cat /proc/cmdline </strong><br />&quot;rw root=/dev/mapper/VG-root rdblacklist=nouveau nouveau.modeset=0 elevator=noop vfio_iommu_type1 intel_iommu=on,igfx_off panic=10 pci-stub.ids=10de:13c0,10de:0fbb,8086:15a1,8086:8cb1 intel_pstate=disable pcie_acs_override=downstream vfio_iommu_type1.allow_unsafe_interrupts=1 quiet&quot;</p></div></blockquote></div><p>If you&#039;re using an &quot;untouched&quot; kernel, the pcie_acs_override option isn&#039;t doing anything.&#160; You also shouldn&#039;t need the vfio option here.</p><div class="quotebox"><blockquote><div><p><strong>/etc/modprobe.d/modprobe.conf: </strong></p><div class="quotebox"><blockquote><div><p>options kvm ignore_msrs=1<br />options intel_kvm emulate_invalid_guest_state=0<br />options intel_kvm nested=1<br />options intel_kvm enable_shadow_vmcs=1<br />options intel_kvm enable_apicv=1<br />options intel_kvm ept=1<br />#options vfio_pci nointxmask=1<br />options vfio_iommu_type1 disable_hugepages=1<br />options vfio_iommu_type1 allow_unsafe_interrupts=1</p></div></blockquote></div></div></blockquote></div><p>Could you not find any more random option to add?&#160; You should not need any of the vfio ones, and by disabling huge pages, you&#039;re making the IOMMU work harder.&#160; BTW, the Intel kvm module is called kvm_intel, not intel_kvm, so all of those options are not doing anything.&#160; I don&#039;t think you want to be touching any of those option anyway.</p><div class="quotebox"><blockquote><div><p><strong>/etc/libvirt/qemu/vm1.xml: </strong></p><div class="quotebox"><blockquote><div><p>&lt;!--<br />WARNING: THIS IS AN AUTO-GENERATED FILE. CHANGES TO IT ARE LIKELY TO BE<br />OVERWRITTEN AND LOST. Changes to this xml configuration should be made using:<br />&#160; virsh edit vm1<br />or other application using the libvirt API.<br />--&gt;</p><p>&lt;domain type=&#039;kvm&#039;&gt;<br />&#160; &lt;name&gt;vm1&lt;/name&gt;<br />&#160; &lt;uuid&gt;2459c3f0-4269-4823-55d4-43528ff0d991&lt;/uuid&gt;<br />&#160; &lt;memory unit=&#039;KiB&#039;&gt;10485760&lt;/memory&gt;<br />&#160; &lt;currentMemory unit=&#039;KiB&#039;&gt;10485760&lt;/currentMemory&gt;<br />&#160; &lt;vcpu placement=&#039;static&#039; cpuset=&#039;0-7&#039;&gt;8&lt;/vcpu&gt;<br />&#160; &lt;cputune&gt;<br />&#160; &#160; &lt;vcpupin vcpu=&#039;0&#039; cpuset=&#039;0,4&#039;/&gt;<br />&#160; &#160; &lt;vcpupin vcpu=&#039;1&#039; cpuset=&#039;1,5&#039;/&gt;<br />&#160; &#160; &lt;vcpupin vcpu=&#039;2&#039; cpuset=&#039;2,6&#039;/&gt;<br />&#160; &#160; &lt;vcpupin vcpu=&#039;3&#039; cpuset=&#039;3,7&#039;/&gt;<br />&#160; &#160; &lt;vcpupin vcpu=&#039;4&#039; cpuset=&#039;0,4&#039;/&gt;<br />&#160; &#160; &lt;vcpupin vcpu=&#039;5&#039; cpuset=&#039;1,5&#039;/&gt;<br />&#160; &#160; &lt;vcpupin vcpu=&#039;6&#039; cpuset=&#039;2,6&#039;/&gt;<br />&#160; &#160; &lt;vcpupin vcpu=&#039;7&#039; cpuset=&#039;3,7&#039;/&gt;</p></div></blockquote></div></div></blockquote></div><p>You really want to pin to a single CPU, so I&#039;d eliminate the a,b options, pick one.&#160; I recognize that you&#039;re trying to pin to a core, which should share cache, but I don&#039;t think this is helping you.&#160; Also, you&#039;re assigning 100% of your CPU power to the guest.&#160; Are you running a very minimal host?&#160; How is the host supposed to do anything without stealing CPU from the guest?&#160; In my setup I assign the cores to the guest and leave the threads for the host.&#160; Huge pages are another tuning option here.</p> </div> <div class="postsignature postmsg"><hr /><p><a href="http://vfio.blogspot.com" rel="nofollow">http://vfio.blogspot.com</a><br />Looking for a more open forum to discuss vfio related uses?&#160; Try <a href="https://www.redhat.com/mailman/listinfo/vfio-users" rel="nofollow">https://www.redhat.com/mailman/listinfo/vfio-users</a></p></div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1491351">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1491359" class="blockpost roweven"> <h2><span><span class="conr">#3772</span> <a href="viewtopic.php?pid=1491359#p1491359">2015-01-08 15:19:31</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=74748">kaeptnb</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2013-09-04</span></dd> <dd><span>Posts: 30</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=74748">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>4kGamer wrote:</cite><blockquote><div><p>ok, I will post my complete config in a few hours. Here is my issue:</p><p>what I experienced a few times already: all of a sudden there is &quot;a glitch&quot; in the Picture, just for a second. And right at that instant CPU usage jumps to 100 % and then it goes down again. Maybe it&#039;s related to disk performance, maybe it&#039;s just the CPU or maybe it&#039;s just a mistake of the Game. I experienced this when I play offline Fifa 15 with friends. (Normally my CPU usage is about 20-30 % when I play Fifa 15 at 4k resolution)<br />I also tried to replicate the issue when I use bare metal Windows, but it didn&#039;t occur in it so far.</p></div></blockquote></div><p>You really should try to pin your vcpus 1:1 to real cpus; and keep hyper-threading in mind to prevent cache-trashing (which very well could be the cause for your micro-stutters);</p><p>With a i7 920 Host CPU (8 virtual cpus; hyperthreading) i use this:</p><div class="codebox"><pre><code> &lt;vcpu placement=&#039;static&#039;&gt;4&lt;/vcpu&gt; &lt;cputune&gt; &lt;vcpupin vcpu=&#039;0&#039; cpuset=&#039;2&#039;/&gt; &lt;vcpupin vcpu=&#039;1&#039; cpuset=&#039;6&#039;/&gt; &lt;vcpupin vcpu=&#039;2&#039; cpuset=&#039;3&#039;/&gt; &lt;vcpupin vcpu=&#039;3&#039; cpuset=&#039;7&#039;/&gt; &lt;emulatorpin cpuset=&#039;0-1,4-5&#039;/&gt; &lt;/cputune&gt; &lt;os&gt; &lt;type arch=&#039;x86_64&#039; machine=&#039;pc-i440fx-2.1&#039;&gt;hvm&lt;/type&gt; &lt;loader readonly=&#039;yes&#039; type=&#039;pflash&#039;&gt;/etc/libvirt/efi/edk2.git/ovmf-x64/OVMF_CODE-pure-efi.fd&lt;/loader&gt; &lt;nvram template=&#039;/etc/libvirt/efi/edk2.git/ovmf-x64/OVMF_VARS-pure-efi.fd&#039;&gt;/var/lib/libvirt/qemu/nvram/win_VARS.fd&lt;/nvram&gt; &lt;bootmenu enable=&#039;yes&#039;/&gt; &lt;/os&gt; &lt;features&gt; &lt;acpi/&gt; &lt;apic/&gt; &lt;pae/&gt; &lt;hyperv&gt; &lt;relaxed state=&#039;on&#039;/&gt; &lt;vapic state=&#039;on&#039;/&gt; &lt;spinlocks state=&#039;on&#039; retries=&#039;8191&#039;/&gt; &lt;/hyperv&gt; &lt;/features&gt; &lt;cpu mode=&#039;host-passthrough&#039;&gt; &lt;topology sockets=&#039;1&#039; cores=&#039;2&#039; threads=&#039;2&#039;/&gt; &lt;/cpu&gt;</code></pre></div><p>Looking forward to hear if that helps!<br />Greetings</p> <p class="postedit"><em>Last edited by kaeptnb (2015-01-08 15:21:24)</em></p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1491359">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1491360" class="blockpost rowodd"> <h2><span><span class="conr">#3773</span> <a href="viewtopic.php?pid=1491360#p1491360">2015-01-08 15:28:11</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=86302">4kGamer</a></strong></dt> <dd class="usertitle"><strong>Banned</strong></dd> <dd><span>Registered: 2014-10-29</span></dd> <dd><span>Posts: 82</span></dd> <dd class="usercontacts"><span class="email"><a href="mailto:oktayaslantas@gmx.de">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <p>Alex, thank you very much for having a closer look. I will adjust accordingly. I didn&#039;t know many of the things you wrote. I have assigned all CPUs to guest to make sure I have enough power. It&#039;s just for now when I am still trying to find out what I really need. I will leave 25 - 50 % to the host as I am not doing anything other than using the console at the moment - but that might change in time <img src="https://bbs.archlinux.org/img/smilies/smile.png" width="15" height="15" alt="smile" /></p><br /><p>Alex, is this okay?<br />&#160; &#160; &#160; &#160;</p><div class="quotebox"><blockquote><div><p>&lt;vcpu placement=<strong>&#039;static&#039; cpuset=&#039;0-5&#039;&gt;8</strong>&lt;/vcpu&gt;<br />&#160; &#160; &lt;vcpupin vcpu=&#039;0&#039; cpuset=&#039;0&#039;/&gt;<br />&#160; &#160; &lt;vcpupin vcpu=&#039;1&#039; cpuset=&#039;1&#039;/&gt;<br />&#160; &#160; &lt;vcpupin vcpu=&#039;2&#039; cpuset=&#039;2&#039;/&gt;<br />&#160; &#160; &lt;vcpupin vcpu=&#039;3&#039; cpuset=&#039;3&#039;/&gt;<br />&#160; &#160; &lt;vcpupin vcpu=&#039;4&#039; cpuset=&#039;4&#039;/&gt;<br />&#160; &#160; &lt;vcpupin vcpu=&#039;5&#039; cpuset=&#039;5&#039;/&gt;</p></div></blockquote></div><p>You said you only assign cores to the guest. How is this done within the XML?</p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1491360">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1491364" class="blockpost roweven"> <h2><span><span class="conr">#3774</span> <a href="viewtopic.php?pid=1491364#p1491364">2015-01-08 15:37:52</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=86302">4kGamer</a></strong></dt> <dd class="usertitle"><strong>Banned</strong></dd> <dd><span>Registered: 2014-10-29</span></dd> <dd><span>Posts: 82</span></dd> <dd class="usercontacts"><span class="email"><a href="mailto:oktayaslantas@gmx.de">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>kaeptnb wrote:</cite><blockquote><div><div class="quotebox"><cite>4kGamer wrote:</cite><blockquote><div><p>ok, I will post my complete config in a few hours. Here is my issue:</p><p>what I experienced a few times already: all of a sudden there is &quot;a glitch&quot; in the Picture, just for a second. And right at that instant CPU usage jumps to 100 % and then it goes down again. Maybe it&#039;s related to disk performance, maybe it&#039;s just the CPU or maybe it&#039;s just a mistake of the Game. I experienced this when I play offline Fifa 15 with friends. (Normally my CPU usage is about 20-30 % when I play Fifa 15 at 4k resolution)<br />I also tried to replicate the issue when I use bare metal Windows, but it didn&#039;t occur in it so far.</p></div></blockquote></div><p>You really should try to pin your vcpus 1:1 to real cpus; and keep hyper-threading in mind to prevent cache-trashing (which very well could be the cause for your micro-stutters);</p><p>With a i7 920 Host CPU (8 virtual cpus; hyperthreading) i use this:</p><div class="codebox"><pre><code> &lt;vcpu placement=&#039;static&#039;&gt;4&lt;/vcpu&gt; &lt;cputune&gt; &lt;vcpupin vcpu=&#039;0&#039; cpuset=&#039;2&#039;/&gt; &lt;vcpupin vcpu=&#039;1&#039; cpuset=&#039;6&#039;/&gt; &lt;vcpupin vcpu=&#039;2&#039; cpuset=&#039;3&#039;/&gt; &lt;vcpupin vcpu=&#039;3&#039; cpuset=&#039;7&#039;/&gt; &lt;emulatorpin cpuset=&#039;0-1,4-5&#039;/&gt; &lt;/cputune&gt; &lt;os&gt; &lt;type arch=&#039;x86_64&#039; machine=&#039;pc-i440fx-2.1&#039;&gt;hvm&lt;/type&gt; &lt;loader readonly=&#039;yes&#039; type=&#039;pflash&#039;&gt;/etc/libvirt/efi/edk2.git/ovmf-x64/OVMF_CODE-pure-efi.fd&lt;/loader&gt; &lt;nvram template=&#039;/etc/libvirt/efi/edk2.git/ovmf-x64/OVMF_VARS-pure-efi.fd&#039;&gt;/var/lib/libvirt/qemu/nvram/win_VARS.fd&lt;/nvram&gt; &lt;bootmenu enable=&#039;yes&#039;/&gt; &lt;/os&gt; &lt;features&gt; &lt;acpi/&gt; &lt;apic/&gt; &lt;pae/&gt; &lt;hyperv&gt; &lt;relaxed state=&#039;on&#039;/&gt; &lt;vapic state=&#039;on&#039;/&gt; &lt;spinlocks state=&#039;on&#039; retries=&#039;8191&#039;/&gt; &lt;/hyperv&gt; &lt;/features&gt; &lt;cpu mode=&#039;host-passthrough&#039;&gt; &lt;topology sockets=&#039;1&#039; cores=&#039;2&#039; threads=&#039;2&#039;/&gt; &lt;/cpu&gt;</code></pre></div><p>Looking forward to hear if that helps!<br />Greetings</p></div></blockquote></div><p>Thank you for sharing your configs! I will definitely pin 1:1 from now on. </p><p>About hyperv: If I understand correctly I can&#039;t enable hyper-threading because I use an Nvidia GPU. It would give me Code 43 on my GTX 980.</p> <p class="postedit"><em>Last edited by 4kGamer (2015-01-08 15:39:12)</em></p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1491364">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1491365" class="blockpost rowodd"> <h2><span><span class="conr">#3775</span> <a href="viewtopic.php?pid=1491365#p1491365">2015-01-08 15:41:30</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=75590">aw</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2013-10-04</span></dd> <dd><span>Posts: 921</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=75590">Email</a></span> <span class="website"><a href="http://vfio.blogspot.com/" rel="nofollow">Website</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>4kGamer wrote:</cite><blockquote><div><p>Alex, thank you very much for having a closer look. I will adjust accordingly. I didn&#039;t know many of the things you wrote. I have assigned all CPUs to guest to make sure I have enough power. It&#039;s just for now when I am still trying to find out what I really need. I will leave 25 - 50 % to the host as I am not doing anything other than using the console at the moment - but that might change in time <img src="https://bbs.archlinux.org/img/smilies/smile.png" width="15" height="15" alt="smile" /></p><br /><p>Alex, is this okay?<br />&#160; &#160; &#160; &#160;</p><div class="quotebox"><blockquote><div><p>&lt;vcpu placement=<strong>&#039;static&#039; cpuset=&#039;0-5&#039;&gt;8</strong>&lt;/vcpu&gt;<br />&#160; &#160; &lt;vcpupin vcpu=&#039;0&#039; cpuset=&#039;0&#039;/&gt;<br />&#160; &#160; &lt;vcpupin vcpu=&#039;1&#039; cpuset=&#039;1&#039;/&gt;<br />&#160; &#160; &lt;vcpupin vcpu=&#039;2&#039; cpuset=&#039;2&#039;/&gt;<br />&#160; &#160; &lt;vcpupin vcpu=&#039;3&#039; cpuset=&#039;3&#039;/&gt;<br />&#160; &#160; &lt;vcpupin vcpu=&#039;4&#039; cpuset=&#039;4&#039;/&gt;<br />&#160; &#160; &lt;vcpupin vcpu=&#039;5&#039; cpuset=&#039;5&#039;/&gt;</p></div></blockquote></div><p>You said you only assign cores to the guest. How is this done within the XML?</p></div></blockquote></div><p>I don&#039;t think you have the right idea about what a thread is.&#160; A thread is not a full execution unit, so your example here has vcpus 4 &amp; 5 partially sharing vcpus 0 &amp; 1.&#160; I don&#039;t know how you&#039;d represent that to the guest.&#160; You also need to realize that a thread only adds maybe 10-20% performance, so if you assign 4 cores (without threads), you&#039;re already providing the VM with perhaps 75%+ of the processing power of the socket.&#160; I do something more like kaeptnb, although I don&#039;t know how they came up with those cpuset values.&#160; AFAIK, cpusets are the same as processor numbers, where the cores are generally enumerated before the threads.&#160; Thus on a 4-core w/ threads processor, 0-3 are cores and 4-7 are threads, where 4 is the thread sibling of 0, 5 of 1, etc.</p> </div> <div class="postsignature postmsg"><hr /><p><a href="http://vfio.blogspot.com" rel="nofollow">http://vfio.blogspot.com</a><br />Looking for a more open forum to discuss vfio related uses?&#160; Try <a href="https://www.redhat.com/mailman/listinfo/vfio-users" rel="nofollow">https://www.redhat.com/mailman/listinfo/vfio-users</a></p></div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1491365">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div class="postlinksb"> <div class="inbox crumbsplus"> <div class="pagepost"> <p class="pagelink conl"><span class="pages-label">Pages: </span><a rel="prev" class="item1" href="viewtopic.php?id=162768&amp;p=150">Previous</a> <a href="viewtopic.php?id=162768">1</a> <span class="spacer">…</span> <a href="viewtopic.php?id=162768&amp;p=149">149</a> <a href="viewtopic.php?id=162768&amp;p=150">150</a> <strong>151</strong> <a href="viewtopic.php?id=162768&amp;p=152">152</a> <a href="viewtopic.php?id=162768&amp;p=153">153</a> <span class="spacer">…</span> <a href="viewtopic.php?id=162768&amp;p=234">234</a> <a rel="next" href="viewtopic.php?id=162768&amp;p=152">Next</a></p> <p class="postlink conr">Topic closed</p> </div> <ul class="crumbs"> <li><a href="index.php">Index</a></li> <li><span>»&#160;</span><a href="viewforum.php?id=48">Topics Going Nowhere</a></li> <li><span>»&#160;</span><strong><a href="viewtopic.php?id=162768">KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</a></strong></li> </ul> <p class="subscribelink clearb"><a href="misc.php?action=subscribe&amp;tid=162768">Subscribe to this topic</a></p> <div class="clearer"></div> </div> </div> </div> <div id="brdfooter" class="block"> <h2><span>Board footer</span></h2> <div class="box"> <div id="brdfooternav" class="inbox"> <div class="conl"> <form id="qjump" method="get" action="viewforum.php"> <div><label><span>Jump to<br /></span> <select name="id" onchange="window.location=('viewforum.php?id='+this.options[this.selectedIndex].value)"> <optgroup label="Technical Issues and Assistance"> <option value="23">Newbie Corner</option> <option value="17">Installation</option> <option value="22">Kernel &amp; Hardware</option> <option value="18">Applications &amp; Desktop Environments</option> <option value="31">Laptop Issues</option> <option value="8">Networking, Server, and Protection</option> <option value="32">Multimedia and Games</option> <option value="50">System Administration</option> <option value="35">Other Architectures</option> </optgroup> <optgroup label="Arch-centric"> <option value="24">Announcements, Package &amp; Security Advisories</option> <option value="1">Arch Discussion</option> <option value="13">Forum &amp; Wiki discussion</option> </optgroup> <optgroup label="Pacman Upgrades, Packaging &amp; AUR"> <option value="44">Pacman &amp; Package Upgrade Issues</option> <option value="49">[testing] Repo Forum</option> <option value="4">Creating &amp; Modifying Packages</option> <option value="38">AUR Issues, Discussion &amp; PKGBUILD Requests</option> </optgroup> <optgroup label="Contributions &amp; Discussion"> <option value="20">GNU/Linux Discussion</option> <option value="27">Community Contributions</option> <option value="33">Programming &amp; Scripting</option> <option value="30">Other Languages</option> <option value="47">Artwork and Screenshots</option> <option value="42">Try This</option> </optgroup> <optgroup label="/dev/null"> <option value="29">Off-Topic</option> <option value="48" selected="selected">Topics Going Nowhere</option> <option value="36">Dustbin</option> </optgroup> </select></label> <input type="submit" value=" Go " accesskey="g" /> </div> </form> </div> <div class="conr"> <p id="feedlinks"><span class="atom"><a href="extern.php?action=feed&amp;tid=162768&amp;type=atom">Atom topic feed</a></span></p> <p id="poweredby">Powered by <a href="http://fluxbb.org/">FluxBB</a></p> </div> <div class="clearer"></div> </div> </div> </div> </div> <div class="end-box"></div> </div> </body> </html>
