<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"> <html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en" dir="ltr"> <head> <meta http-equiv="Content-Type" content="text/html; charset=utf-8" /> <title>KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9 (Page 12) / Topics Going Nowhere / Arch Linux Forums</title> <link rel="stylesheet" type="text/css" href="style/ArchLinux.css" /> <link rel="canonical" href="viewtopic.php?id=162768&amp;p=12" title="Page 12" /> <link rel="prev" href="viewtopic.php?id=162768&amp;p=11" title="Page 11" /> <link rel="next" href="viewtopic.php?id=162768&amp;p=13" title="Page 13" /> <link rel="alternate" type="application/atom+xml" href="extern.php?action=feed&amp;tid=162768&amp;type=atom" title="Atom topic feed" /> <link rel="stylesheet" media="screen" href="style/ArchLinux/arch.css?v=3" /> <link rel="stylesheet" media="screen" href="style/ArchLinux/archnavbar.css?v=2" /> <link rel="shortcut icon" href="style/ArchLinux/favicon.ico" /> </head> <body> <div id="archnavbar" class="anb-forum"> <div id="archnavbarlogo"><h1><a href="http://www.archlinux.org/">Arch Linux</a></h1></div> <div id="archnavbarmenu"> <ul id="archnavbarlist"> <li id="anb-home"><a href="http://www.archlinux.org/">Home</a></li><li id="anb-packages"><a href="http://www.archlinux.org/packages/">Packages</a></li><li id="anb-forums" class="anb-selected"><a href="https://bbs.archlinux.org/">Forums</a></li><li id="anb-wiki"><a href="https://wiki.archlinux.org/">Wiki</a></li><li id="anb-bugs"><a href="https://bugs.archlinux.org/">Bugs</a></li><li id="anb-aur"><a href="https://aur.archlinux.org/">AUR</a></li><li id="anb-download"><a href="http://www.archlinux.org/download/">Download</a></li> </ul> </div> </div> <div id="punviewtopic" class="pun"> <div class="top-box"></div> <div class="punwrap"> <div id="brdheader" class="block"> <div class="box"> <div id="brdmenu" class="inbox"> <ul> <li id="navindex" class="isactive"><a href="index.php">Index</a></li> <li id="navuserlist"><a href="userlist.php">User list</a></li> <li id="navsearch"><a href="search.php">Search</a></li> <li id="navprofile"><a href="profile.php?id=80749">Profile</a></li> <li id="navlogout"><a href="login.php?action=out&amp;id=80749&amp;csrf_token=5c20501ec397bb45ef8ee8c84db232c8d8e421c6">Logout</a></li> </ul> </div> <div id="brdwelcome" class="inbox"> <ul class="conl"> <li><span>Logged in as <strong>SXX</strong></span></li> <li><span>Last visit: 2015-08-16 12:20:09</span></li> </ul> <ul class="conr"> <li><span>Topics: <a href="search.php?action=show_replies" title="Find topics you have posted to.">Posted</a> | <a href="search.php?action=show_new" title="Find topics with new posts since your last visit.">New</a> | <a href="search.php?action=show_recent" title="Find topics with recent posts.">Active</a> | <a href="search.php?action=show_unanswered" title="Find topics with no replies.">Unanswered</a></span></li> </ul> <div class="clearer"></div> </div> </div> </div> <div id="brdmain"> <div class="linkst"> <div class="inbox crumbsplus"> <ul class="crumbs"> <li><a href="index.php">Index</a></li> <li><span>»&#160;</span><a href="viewforum.php?id=48">Topics Going Nowhere</a></li> <li><span>»&#160;</span><strong><a href="viewtopic.php?id=162768">KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</a></strong></li> </ul> <div class="pagepost"> <p class="pagelink conl"><span class="pages-label">Pages: </span><a rel="prev" class="item1" href="viewtopic.php?id=162768&amp;p=11">Previous</a> <a href="viewtopic.php?id=162768">1</a> <span class="spacer">…</span> <a href="viewtopic.php?id=162768&amp;p=10">10</a> <a href="viewtopic.php?id=162768&amp;p=11">11</a> <strong>12</strong> <a href="viewtopic.php?id=162768&amp;p=13">13</a> <a href="viewtopic.php?id=162768&amp;p=14">14</a> <span class="spacer">…</span> <a href="viewtopic.php?id=162768&amp;p=234">234</a> <a rel="next" href="viewtopic.php?id=162768&amp;p=13">Next</a></p> <p class="postlink conr">Topic closed</p> </div> <div class="clearer"></div> </div> </div> <div id="p1304450" class="blockpost rowodd blockpost1"> <h2><span><span class="conr">#276</span> <a href="viewtopic.php?pid=1304450#p1304450">2013-07-26 20:51:40</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=53953">andy123</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2011-11-04</span></dd> <dd><span>Posts: 169</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=53953">Email</a></span> <span class="website"><a href="http://ajs124.de" rel="nofollow">Website</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>nbhs wrote:</cite><blockquote><div><p>Have you tried passing through both? the marvell device is prolly a multifunction device, so you should pass it through as such, maybe even behind a pcie root port like the gpu, something like this:</p><div class="codebox"><pre><code>-device ioh3420,bus=pcie.0,addr=1c.1,multifunction=on,port=2,chassis=2,id=root.2 \ -device vfio-pci,host=02:00.0,bus=root.2,addr=00.0,multifunction=on \ -device vfio-pci,host=02:00.1,bus=root.2,addr=00.1</code></pre></div><p>if you need the rom you can do:</p><div class="codebox"><pre><code>-device ioh3420,bus=pcie.0,addr=1c.1,multifunction=on,port=2,chassis=2,id=root.2 \ -device vfio-pci,host=02:00.0,bus=root.2,addr=00.0,multifunction=on,romfile=/path/to/your/rom.bin \ -device vfio-pci,host=02:00.1,bus=root.2,addr=00.1</code></pre></div><p>or using pci-assign instead of vfio</p></div></blockquote></div><p>No idea how I didn&#039;t think of that yet, but it sadly doesn&#039;t seem to solve the problem. But why excactly should it work passed through, when the situation is like this: IOMMU in UEFI on → pata-marvell driver (on host) barely works, as in less than 4mb/s with hdparm or dd after a few minutes to recognize a device. IOMMU off, normal speeds, several 100mb/s from SSD.<br />Anyway, vfio with or without romfile and behind the pcie root port or not produce BSODs in windows 7+8 guests while loading the driver and pci-assign kind of crashes the host</p><div class="codebox"><pre class="vscroll"><code>Jul 26 22:36:58 desk kernel: ---[ end trace efd4627dfc7dbb30 ]--- Jul 26 22:36:58 desk kernel: RSP &lt;ffff8804475e1ce0&gt; Jul 26 22:36:58 desk kernel: RIP [&lt;ffffffff81141c64&gt;] free_huge_page+0x124/0x140 Jul 26 22:36:58 desk kernel: Code: 10 00 00 00 ad de 48 89 43 20 48 b8 00 02 20 00 00 00 ad de 48 89 43 28 e8 ca e9 ff ff 49 ff 4c 24 38 41 ff 4c 24 70 eb 8f 0f 0b &lt;0f&gt; 0b 66 66 2e 0f 1f 84 00 00 00 00 00 66 66 66 66 66 66 2e 0f Jul 26 22:36:58 desk kernel: [&lt;ffffffff81621986&gt;] system_call_fastpath+0x1a/0x1f Jul 26 22:36:58 desk kernel: [&lt;ffffffff8161d82e&gt;] ? do_page_fault+0xe/0x20 Jul 26 22:36:58 desk kernel: [&lt;ffffffff81174cc1&gt;] SyS_ioctl+0x81/0xa0 Jul 26 22:36:58 desk kernel: [&lt;ffffffff8112f4d8&gt;] ? do_munmap+0x2b8/0x3e0 Jul 26 22:36:58 desk kernel: [&lt;ffffffff81174a5d&gt;] do_vfs_ioctl+0x2dd/0x4c0 Jul 26 22:36:58 desk kernel: [&lt;ffffffff814b3f38&gt;] vfio_fops_unl_ioctl+0x78/0x360 Jul 26 22:36:58 desk kernel: [&lt;ffffffff8161d544&gt;] ? __do_page_fault+0x2e4/0x5c0 Jul 26 22:36:58 desk kernel: [&lt;ffffffff814b5c31&gt;] vfio_iommu_type1_ioctl+0x4b1/0x7a0 Jul 26 22:36:58 desk kernel: [&lt;ffffffff814b52ee&gt;] vfio_dma_unmap+0xe/0x20 Jul 26 22:36:58 desk kernel: [&lt;ffffffff814b51bf&gt;] __vfio_dma_do_unmap.isra.3+0x7f/0xa0 Jul 26 22:36:58 desk kernel: [&lt;ffffffff814b511a&gt;] put_pfn+0x3a/0x60 Jul 26 22:36:58 desk kernel: [&lt;ffffffff8110e10c&gt;] put_page+0x2c/0x40 Jul 26 22:36:58 desk kernel: [&lt;ffffffff8110df15&gt;] put_compound_page+0x55/0x220 Jul 26 22:36:58 desk kernel: [&lt;ffffffff8110de5f&gt;] __put_compound_page+0x1f/0x40 Jul 26 22:36:58 desk kernel: Call Trace: Jul 26 22:36:58 desk kernel: ffff880445b88428 0000000000000000 000000000f400000 0000000000000002 Jul 26 22:36:58 desk kernel: ffffffff8110de5f ffffea000f400000 ffff8804475e1d58 ffffffff8110df15 Jul 26 22:36:58 desk kernel: ffffea000f000000 ffffea000f000000 ffffea000f00001c ffff8804475e1d10 Jul 26 22:36:58 desk kernel: Stack: Jul 26 22:36:58 desk kernel: DR3: 0000000000000000 DR6: 00000000ffff0ff0 DR7: 0000000000000400 Jul 26 22:36:58 desk kernel: DR0: 0000000000000000 DR1: 0000000000000000 DR2: 0000000000000000 Jul 26 22:36:58 desk kernel: CR2: 00007f509648a180 CR3: 000000033e0b7000 CR4: 00000000000407f0 Jul 26 22:36:58 desk kernel: CS: 0010 DS: 0000 ES: 0000 CR0: 000000008005003b Jul 26 22:36:58 desk kernel: FS: 00007f509617d900(0000) GS:ffff88045ec00000(0000) knlGS:0000000000000000 Jul 26 22:36:58 desk kernel: R13: 0000000000000000 R14: 0000000000000246 R15: ffff8804475e1fd8 Jul 26 22:36:58 desk kernel: R10: 0000000000000000 R11: 000ffffffffff000 R12: ffffffff81ce3e20 Jul 26 22:36:58 desk kernel: RBP: ffff8804475e1cf8 R08: 0000000000000001 R09: ffff88044892b2a0 Jul 26 22:36:58 desk kernel: RDX: 800000000000001c RSI: 0000000000000003 RDI: 0000000040000000 Jul 26 22:36:58 desk kernel: RAX: 0000000000000000 RBX: ffffea000f000000 RCX: 0000000000000012 Jul 26 22:36:58 desk kernel: RSP: 0018:ffff8804475e1ce0 EFLAGS: 00010213 Jul 26 22:36:58 desk kernel: RIP: 0010:[&lt;ffffffff81141c64&gt;] [&lt;ffffffff81141c64&gt;] free_huge_page+0x124/0x140 Jul 26 22:36:58 desk kernel: task: ffff880443d85040 ti: ffff8804475e0000 task.ti: ffff8804475e0000 Jul 26 22:36:58 desk kernel: Hardware name: To Be Filled By O.E.M. To Be Filled By O.E.M./990FX Extreme4, BIOS P2.00 10/15/2012 Jul 26 22:36:58 desk kernel: CPU: 0 PID: 947 Comm: qemu-system-x86 Tainted: P O 3.10.3-1-ck #1 Jul 26 22:36:58 desk kernel: usbhid hid ata_generic ahci pata_acpi libahci ohci_hcd ehci_pci xhci_hcd ehci_hcd libata usbcore usb_common scsi_mod Jul 26 22:36:58 desk kernel: Modules linked in: tun nfsd auth_rpcgss oid_registry nfs_acl bridge stp llc ipt_MASQUERADE iptable_nat nf_nat_ipv4 nf_na Jul 26 22:36:58 desk kernel: invalid opcode: 0000 [#1] PREEMPT SMP Jul 26 22:36:58 desk kernel: kernel BUG at mm/hugetlb.c:627! Jul 26 22:36:58 desk kernel: ------------[ cut here ]------------</code></pre></div><p>and qemu says something about wrong PCI something size, not a multiple of 4k? If this might be relevant, I&#039;ll reproduce it and copy&amp;paste the output.<br />It&#039;s been a while, so is this the right syntax for pci-assign? </p><div class="codebox"><pre><code>-device pci-assign,host=02:00.0,romfile=/root/1b4b-9120_v1001033.bin,multifunction=on \ -device pci-assign,host=02:00.1,rombar=0 </code></pre></div><p>I still think it&#039;s a hardware error on Marvell&#039;s side that might be worked arround in the amd_iommu driver, but it would be nice if there was another way to solve this.</p> </div> <div class="postsignature postmsg"><hr /><p>i&#039;m sorry for my poor english wirting skills…</p></div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1304450">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1304455" class="blockpost roweven"> <h2><span><span class="conr">#277</span> <a href="viewtopic.php?pid=1304455#p1304455">2013-07-26 21:05:14</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=53621">teekay</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2011-10-26</span></dd> <dd><span>Posts: 267</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=53621">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>nbhs wrote:</cite><blockquote><div><div class="quotebox"><cite>andy123 wrote:</cite><blockquote><div><div class="quotebox"><cite>nbhs wrote:</cite><blockquote><div><p>Have you tried appending iommu=pt to your grub cfg?</p></div></blockquote></div><p>syslinux.cfg and yes. (I just checked /proc/cmdline)<br />At first there are the option rom errors, which I might have fixed but then there are these </p><div class="codebox"><pre><code>AMD-Vi: Event logged [IO_PAGE_FAULT device=02:00.1 domain=0x0000 address=0x00000000af418000 flags=0x0050]</code></pre></div><p>The thing is, I forward 02:00.0 not 02:00.1, but the Marvell Controller does some strange things I don&#039;t understand, because I have no idea how PCIe works.</p></div></blockquote></div><p>Have you tried passing through both? the marvell device is prolly a multifunction device, so you should pass it through as such, maybe even behind a pcie root port like the gpu, something like this:</p><div class="codebox"><pre><code>-device ioh3420,bus=pcie.0,addr=1c.1,multifunction=on,port=2,chassis=2,id=root.2 \ -device vfio-pci,host=02:00.0,bus=root.2,addr=00.0,multifunction=on \ -device vfio-pci,host=02:00.1,bus=root.2,addr=00.1</code></pre></div><p>if you need the rom you can do:</p><div class="codebox"><pre><code>-device ioh3420,bus=pcie.0,addr=1c.1,multifunction=on,port=2,chassis=2,id=root.2 \ -device vfio-pci,host=02:00.0,bus=root.2,addr=00.0,multifunction=on,romfile=/path/to/your/rom.bin \ -device vfio-pci,host=02:00.1,bus=root.2,addr=00.1</code></pre></div><p>or using pci-assign instead of vfio</p></div></blockquote></div><p>The IO_PAGE_FAULT stuff is what I meant with &quot;it doesn&#039;t work in Linux if IOMMU is enabled&quot;.<br />I added it to <em>pci_stub.ids</em> boot parameter so the host ignores it, and passed it through as a simple pcie device. Works well in Win7 with built-in drivers here.</p> <p class="postedit"><em>Last edited by teekay (2013-07-26 21:08:44)</em></p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1304455">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1304456" class="blockpost rowodd"> <h2><span><span class="conr">#278</span> <a href="viewtopic.php?pid=1304456#p1304456">2013-07-26 21:07:06</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=70922">nbhs</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd class="postavatar"><img src="https://bbs.archlinux.org/img/avatars/70922.jpg?m=1367773811" width="80" height="80" alt="" /></dd> <dd><span>From: Montevideo, Uruguay</span></dd> <dd><span>Registered: 2013-05-02</span></dd> <dd><span>Posts: 402</span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>teekay wrote:</cite><blockquote><div><div class="quotebox"><cite>nbhs wrote:</cite><blockquote><div><div class="quotebox"><cite>andy123 wrote:</cite><blockquote><div><p>syslinux.cfg and yes. (I just checked /proc/cmdline)<br />At first there are the option rom errors, which I might have fixed but then there are these </p><div class="codebox"><pre><code>AMD-Vi: Event logged [IO_PAGE_FAULT device=02:00.1 domain=0x0000 address=0x00000000af418000 flags=0x0050]</code></pre></div><p>The thing is, I forward 02:00.0 not 02:00.1, but the Marvell Controller does some strange things I don&#039;t understand, because I have no idea how PCIe works.</p></div></blockquote></div><p>Have you tried passing through both? the marvell device is prolly a multifunction device, so you should pass it through as such, maybe even behind a pcie root port like the gpu, something like this:</p><div class="codebox"><pre><code>-device ioh3420,bus=pcie.0,addr=1c.1,multifunction=on,port=2,chassis=2,id=root.2 \ -device vfio-pci,host=02:00.0,bus=root.2,addr=00.0,multifunction=on \ -device vfio-pci,host=02:00.1,bus=root.2,addr=00.1</code></pre></div><p>if you need the rom you can do:</p><div class="codebox"><pre><code>-device ioh3420,bus=pcie.0,addr=1c.1,multifunction=on,port=2,chassis=2,id=root.2 \ -device vfio-pci,host=02:00.0,bus=root.2,addr=00.0,multifunction=on,romfile=/path/to/your/rom.bin \ -device vfio-pci,host=02:00.1,bus=root.2,addr=00.1</code></pre></div><p>or using pci-assign instead of vfio</p></div></blockquote></div><p>The IO_PAGE_FAULT stuff is what I meant with &quot;it doesn&#039;t work in Linux if IOMMU is enabled&quot;.<br />I added it to <em>pci_stub.ids</em> boot parameter so the host ignores it, and passed it through as a simple pcie device. Works well in Win7 with built-in drivers here.</p></div></blockquote></div><p>Yeah that another thing you can try, binding it to pci-stub before the driver grabs it</p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1304456">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1304463" class="blockpost roweven"> <h2><span><span class="conr">#279</span> <a href="viewtopic.php?pid=1304463#p1304463">2013-07-26 21:16:01</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=53953">andy123</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2011-11-04</span></dd> <dd><span>Posts: 169</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=53953">Email</a></span> <span class="website"><a href="http://ajs124.de" rel="nofollow">Website</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>nbhs wrote:</cite><blockquote><div><div class="quotebox"><cite>teekay wrote:</cite><blockquote><div><p>The IO_PAGE_FAULT stuff is what I meant with &quot;it doesn&#039;t work in Linux if IOMMU is enabled&quot;.<br />I added it to <em>pci_stub.ids</em> boot parameter so the host ignores it, and passed it through as a simple pcie device. Works well in Win7 with built-in drivers here.</p></div></blockquote></div><p>Yeah that another thing you can try, binding it to pci-stub before the driver grabs it</p></div></blockquote></div><p>Well, I blacklisted the pata-marvell driver, because when it loaded it slowed the boot by several minutes, so that should already be the case.<br />Teekay, what parameters do you use excactly to pass it though as a simple pcie device? Do you get Option rom errors?</p><p>p.s.: I contacted AsRock a few days ago, but all I got back until now was something along the lines of &quot;we notified some department in Taiwan about it and will write back in a week&quot;.</p> </div> <div class="postsignature postmsg"><hr /><p>i&#039;m sorry for my poor english wirting skills…</p></div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1304463">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1304471" class="blockpost rowodd"> <h2><span><span class="conr">#280</span> <a href="viewtopic.php?pid=1304471#p1304471">2013-07-26 21:24:39</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=53621">teekay</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2011-10-26</span></dd> <dd><span>Posts: 267</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=53621">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>andy123 wrote:</cite><blockquote><div><div class="quotebox"><cite>nbhs wrote:</cite><blockquote><div><div class="quotebox"><cite>teekay wrote:</cite><blockquote><div><p>The IO_PAGE_FAULT stuff is what I meant with &quot;it doesn&#039;t work in Linux if IOMMU is enabled&quot;.<br />I added it to <em>pci_stub.ids</em> boot parameter so the host ignores it, and passed it through as a simple pcie device. Works well in Win7 with built-in drivers here.</p></div></blockquote></div><p>Yeah that another thing you can try, binding it to pci-stub before the driver grabs it</p></div></blockquote></div><p>Well, I blacklisted the pata-marvell driver, because when it loaded it slowed the boot by several minutes, so that should already be the case.<br />Teekay, what parameters do you use excactly to pass it though as a simple pcie device? Do you get Option rom errors?</p><p>p.s.: I contacted AsRock a few days ago, but all I got back until now was something along the lines of &quot;we notified some department in Taiwan about it and will write back in a week&quot;.</p></div></blockquote></div><p>In the qemu command I use</p><div class="codebox"><pre><code>-device vfio-pci,host=03:00.0,bus=pcie.0</code></pre></div><p>and it works fine, no error messages on the host side. But as said, I needed to bind it to pci-stub, otherwhise the host&#039;s ahci driver would go nuts (but that&#039;s fully unrelated to qemu, passthrough and all that).</p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1304471">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1304475" class="blockpost roweven"> <h2><span><span class="conr">#281</span> <a href="viewtopic.php?pid=1304475#p1304475">2013-07-26 21:31:26</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=70922">nbhs</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd class="postavatar"><img src="https://bbs.archlinux.org/img/avatars/70922.jpg?m=1367773811" width="80" height="80" alt="" /></dd> <dd><span>From: Montevideo, Uruguay</span></dd> <dd><span>Registered: 2013-05-02</span></dd> <dd><span>Posts: 402</span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>andy123 wrote:</cite><blockquote><div><div class="quotebox"><cite>nbhs wrote:</cite><blockquote><div><div class="quotebox"><cite>teekay wrote:</cite><blockquote><div><p>The IO_PAGE_FAULT stuff is what I meant with &quot;it doesn&#039;t work in Linux if IOMMU is enabled&quot;.<br />I added it to <em>pci_stub.ids</em> boot parameter so the host ignores it, and passed it through as a simple pcie device. Works well in Win7 with built-in drivers here.</p></div></blockquote></div><p>Yeah that another thing you can try, binding it to pci-stub before the driver grabs it</p></div></blockquote></div><p>Well, I blacklisted the pata-marvell driver, because when it loaded it slowed the boot by several minutes, so that should already be the case.<br />Teekay, what parameters do you use excactly to pass it though as a simple pcie device? Do you get Option rom errors?</p><p>p.s.: I contacted AsRock a few days ago, but all I got back until now was something along the lines of &quot;we notified some department in Taiwan about it and will write back in a week&quot;.</p></div></blockquote></div><p>Excuse my ignorance but isnt the pata driver needed for ide only? shouldnt it be using the ahci module?</p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1304475">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1304481" class="blockpost rowodd"> <h2><span><span class="conr">#282</span> <a href="viewtopic.php?pid=1304481#p1304481">2013-07-26 21:41:35</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=53621">teekay</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2011-10-26</span></dd> <dd><span>Posts: 267</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=53621">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>nbhs wrote:</cite><blockquote><div><p>Excuse my ignorance but isnt the pata driver needed for ide only? shouldnt it be using the ahci module?</p></div></blockquote></div><p>Good point, nbhs is correct: it&#039;s the ahci driver. The pata-marvell is unrelated, so blacklisting it won&#039;t help. That&#039;s why only pci-stub can stop the host from acting upon the controller.</p><div class="codebox"><pre><code>└» zcat /proc/config.gz |grep PATA_MARVELL # CONFIG_PATA_MARVELL is not set</code></pre></div> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1304481">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1304482" class="blockpost roweven"> <h2><span><span class="conr">#283</span> <a href="viewtopic.php?pid=1304482#p1304482">2013-07-26 21:42:23</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=53953">andy123</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2011-11-04</span></dd> <dd><span>Posts: 169</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=53953">Email</a></span> <span class="website"><a href="http://ajs124.de" rel="nofollow">Website</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>nbhs wrote:</cite><blockquote><div><div class="quotebox"><cite>andy123 wrote:</cite><blockquote><div><div class="quotebox"><cite>nbhs wrote:</cite><blockquote><div><p>Yeah that another thing you can try, binding it to pci-stub before the driver grabs it</p></div></blockquote></div><p>Well, I blacklisted the pata-marvell driver, because when it loaded it slowed the boot by several minutes, so that should already be the case.<br />Teekay, what parameters do you use excactly to pass it though as a simple pcie device? Do you get Option rom errors?</p><p>p.s.: I contacted AsRock a few days ago, but all I got back until now was something along the lines of &quot;we notified some department in Taiwan about it and will write back in a week&quot;.</p></div></blockquote></div><p>Excuse my ignorance but isnt the pata driver needed for ide only? shouldnt it be using the ahci module?</p></div></blockquote></div><p>That&#039;s what I though at first, but &quot;lspci -nnvvv&quot; tells me this:</p><div class="codebox"><pre class="vscroll"><code>02:00.0 IDE interface [0101]: Marvell Technology Group Ltd. 88SE91A0 SATA 6Gb/s Controller [1b4b:91a0] (rev 12) (prog-if 8f [Master SecP SecO PriP PriO]) Subsystem: ASRock Incorporation Device [1849:91a0] Control: I/O+ Mem+ BusMaster- SpecCycle- MemWINV- VGASnoop- ParErr- Stepping- SERR- FastB2B- DisINTx- Status: Cap+ 66MHz- UDF- FastB2B- ParErr- DEVSEL=fast &gt;TAbort- &lt;TAbort- &lt;MAbort- &gt;SERR- &lt;PERR- INTx- Interrupt: pin A routed to IRQ 44 Region 0: I/O ports at d090 [size=8] Region 1: I/O ports at d080 [size=4] Region 2: I/O ports at d070 [size=8] Region 3: I/O ports at d060 [size=4] Region 4: I/O ports at d050 [size=16] Region 5: Memory at fe615000 (32-bit, non-prefetchable) [size=2K] Expansion ROM at fe600000 [disabled] [size=64K] Capabilities: &lt;access denied&gt; Kernel driver in use: vfio-pci Kernel modules: pata_marvell, pata_acpi, ata_generic 02:00.1 IDE interface [0101]: Marvell Technology Group Ltd. 88SE912x IDE Controller [1b4b:91a4] (rev 12) (prog-if 8f [Master SecP SecO PriP PriO]) Subsystem: Marvell Technology Group Ltd. 88SE912x IDE Controller [1b4b:91a4] Control: I/O+ Mem+ BusMaster- SpecCycle- MemWINV- VGASnoop- ParErr- Stepping- SERR- FastB2B- DisINTx- Status: Cap+ 66MHz- UDF- FastB2B- ParErr- DEVSEL=fast &gt;TAbort- &lt;TAbort- &lt;MAbort- &gt;SERR- &lt;PERR- INTx- Interrupt: pin B routed to IRQ 45 Region 0: I/O ports at d040 [size=8] Region 1: I/O ports at d030 [size=4] Region 2: I/O ports at d020 [size=8] Region 3: I/O ports at d010 [size=4] Region 4: I/O ports at d000 [size=16] Region 5: Memory at fe614000 (32-bit, non-prefetchable) [size=16] Expansion ROM at fe610000 [disabled] [size=16K] Capabilities: &lt;access denied&gt; Kernel driver in use: vfio-pci Kernel modules: pata_marvell, pata_acpi, ata_generic</code></pre></div><p>And I found <a href="https://lkml.org/lkml/2011/5/18/193" rel="nofollow">this patch</a> on the kernel mailinglist, that seems to be responsible for this, but as said it works well without IOMMU.<br />And yes, this is indepented of AHCI or IDE setting in the UEFI. But iirc, it&#039;s always detected as an IDE controller in windows (bare-metal), too.<br />There are some quite strange controllers on this board, the USB3 is from Etron, it works better than the Marvell SATA controller, but sometimes freezes and caused BSODs in a guest, that&#039;s why I pass though one of the usb2 controllers now.</p><p>edit: </p><div class="quotebox"><cite>teekay wrote:</cite><blockquote><div><p>Good point, nbhs is correct: it&#039;s the ahci driver. The pata-marvell is unrelated, so blacklisting it won&#039;t help. That&#039;s why only pci-stub can stop the host from acting upon the controller.</p></div></blockquote></div><p>Interpret the lspci output above for yourself, but I read from it, that I blacklisted the right driver. Please tell me if I didn&#039;t.</p> <p class="postedit"><em>Last edited by andy123 (2013-07-26 21:48:49)</em></p> </div> <div class="postsignature postmsg"><hr /><p>i&#039;m sorry for my poor english wirting skills…</p></div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1304482">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1304483" class="blockpost rowodd"> <h2><span><span class="conr">#284</span> <a href="viewtopic.php?pid=1304483#p1304483">2013-07-26 21:45:59</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=70922">nbhs</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd class="postavatar"><img src="https://bbs.archlinux.org/img/avatars/70922.jpg?m=1367773811" width="80" height="80" alt="" /></dd> <dd><span>From: Montevideo, Uruguay</span></dd> <dd><span>Registered: 2013-05-02</span></dd> <dd><span>Posts: 402</span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>andy123 wrote:</cite><blockquote><div><div class="quotebox"><cite>nbhs wrote:</cite><blockquote><div><div class="quotebox"><cite>andy123 wrote:</cite><blockquote><div><p>Well, I blacklisted the pata-marvell driver, because when it loaded it slowed the boot by several minutes, so that should already be the case.<br />Teekay, what parameters do you use excactly to pass it though as a simple pcie device? Do you get Option rom errors?</p><p>p.s.: I contacted AsRock a few days ago, but all I got back until now was something along the lines of &quot;we notified some department in Taiwan about it and will write back in a week&quot;.</p></div></blockquote></div><p>Excuse my ignorance but isnt the pata driver needed for ide only? shouldnt it be using the ahci module?</p></div></blockquote></div><p>That&#039;s what I though at first, but &quot;lspci -nnvvv&quot; tells me this:</p><div class="codebox"><pre class="vscroll"><code>02:00.0 IDE interface [0101]: Marvell Technology Group Ltd. 88SE91A0 SATA 6Gb/s Controller [1b4b:91a0] (rev 12) (prog-if 8f [Master SecP SecO PriP PriO]) Subsystem: ASRock Incorporation Device [1849:91a0] Control: I/O+ Mem+ BusMaster- SpecCycle- MemWINV- VGASnoop- ParErr- Stepping- SERR- FastB2B- DisINTx- Status: Cap+ 66MHz- UDF- FastB2B- ParErr- DEVSEL=fast &gt;TAbort- &lt;TAbort- &lt;MAbort- &gt;SERR- &lt;PERR- INTx- Interrupt: pin A routed to IRQ 44 Region 0: I/O ports at d090 [size=8] Region 1: I/O ports at d080 [size=4] Region 2: I/O ports at d070 [size=8] Region 3: I/O ports at d060 [size=4] Region 4: I/O ports at d050 [size=16] Region 5: Memory at fe615000 (32-bit, non-prefetchable) [size=2K] Expansion ROM at fe600000 [disabled] [size=64K] Capabilities: &lt;access denied&gt; Kernel driver in use: vfio-pci Kernel modules: pata_marvell, pata_acpi, ata_generic 02:00.1 IDE interface [0101]: Marvell Technology Group Ltd. 88SE912x IDE Controller [1b4b:91a4] (rev 12) (prog-if 8f [Master SecP SecO PriP PriO]) Subsystem: Marvell Technology Group Ltd. 88SE912x IDE Controller [1b4b:91a4] Control: I/O+ Mem+ BusMaster- SpecCycle- MemWINV- VGASnoop- ParErr- Stepping- SERR- FastB2B- DisINTx- Status: Cap+ 66MHz- UDF- FastB2B- ParErr- DEVSEL=fast &gt;TAbort- &lt;TAbort- &lt;MAbort- &gt;SERR- &lt;PERR- INTx- Interrupt: pin B routed to IRQ 45 Region 0: I/O ports at d040 [size=8] Region 1: I/O ports at d030 [size=4] Region 2: I/O ports at d020 [size=8] Region 3: I/O ports at d010 [size=4] Region 4: I/O ports at d000 [size=16] Region 5: Memory at fe614000 (32-bit, non-prefetchable) [size=16] Expansion ROM at fe610000 [disabled] [size=16K] Capabilities: &lt;access denied&gt; Kernel driver in use: vfio-pci Kernel modules: pata_marvell, pata_acpi, ata_generic</code></pre></div><p>And I found <a href="https://lkml.org/lkml/2011/5/18/193" rel="nofollow">this patch</a> on the kernel mailinglist, that seems to be responsible for this, but as said it works well without IOMMU.<br />And yes, this is indepented of AHCI oder IDE setting in the UEFI. But iirc, it&#039;s always detected as an IDE controller in windows (bare-metal), too.<br />There are some quite strange controllers on this board, the USB3 is from Etron, it works better than the Marvell SATA controller, but sometimes freezes and caused BSODs in a guest, that&#039;s why I pass though one of the usb2 controllers now.</p></div></blockquote></div><p>Well you problem seems to be its running on ide mode, check your mobo configuration and try to switch it to ahci</p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1304483">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1304486" class="blockpost roweven"> <h2><span><span class="conr">#285</span> <a href="viewtopic.php?pid=1304486#p1304486">2013-07-26 21:48:21</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=53953">andy123</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2011-11-04</span></dd> <dd><span>Posts: 169</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=53953">Email</a></span> <span class="website"><a href="http://ajs124.de" rel="nofollow">Website</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>nbhs wrote:</cite><blockquote><div><p>Well you problem seems to be its running on ide mode, check your mobo configuration and try to switch it to ahci</p></div></blockquote></div><p>To quote myself:</p><div class="quotebox"><cite>andy123 wrote:</cite><blockquote><div><p>And yes, this is indepented of AHCI or IDE setting in the UEFI.</p></div></blockquote></div> <p class="postedit"><em>Last edited by andy123 (2013-07-26 21:48:34)</em></p> </div> <div class="postsignature postmsg"><hr /><p>i&#039;m sorry for my poor english wirting skills…</p></div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1304486">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1304491" class="blockpost rowodd"> <h2><span><span class="conr">#286</span> <a href="viewtopic.php?pid=1304491#p1304491">2013-07-26 21:55:02</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=70922">nbhs</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd class="postavatar"><img src="https://bbs.archlinux.org/img/avatars/70922.jpg?m=1367773811" width="80" height="80" alt="" /></dd> <dd><span>From: Montevideo, Uruguay</span></dd> <dd><span>Registered: 2013-05-02</span></dd> <dd><span>Posts: 402</span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>andy123 wrote:</cite><blockquote><div><div class="quotebox"><cite>nbhs wrote:</cite><blockquote><div><p>Well you problem seems to be its running on ide mode, check your mobo configuration and try to switch it to ahci</p></div></blockquote></div><p>To quote myself:</p><div class="quotebox"><cite>andy123 wrote:</cite><blockquote><div><p>And yes, this is indepented of AHCI or IDE setting in the UEFI.</p></div></blockquote></div></div></blockquote></div><p>Im sorry i overlooked that, does this behavior happens when you disable iommu?</p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1304491">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1304492" class="blockpost roweven"> <h2><span><span class="conr">#287</span> <a href="viewtopic.php?pid=1304492#p1304492">2013-07-26 21:59:39</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=70922">nbhs</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd class="postavatar"><img src="https://bbs.archlinux.org/img/avatars/70922.jpg?m=1367773811" width="80" height="80" alt="" /></dd> <dd><span>From: Montevideo, Uruguay</span></dd> <dd><span>Registered: 2013-05-02</span></dd> <dd><span>Posts: 402</span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>nbhs wrote:</cite><blockquote><div><div class="quotebox"><cite>andy123 wrote:</cite><blockquote><div><div class="quotebox"><cite>nbhs wrote:</cite><blockquote><div><p>Well you problem seems to be its running on ide mode, check your mobo configuration and try to switch it to ahci</p></div></blockquote></div><p>To quote myself:</p><div class="quotebox"><cite>andy123 wrote:</cite><blockquote><div><p>And yes, this is indepented of AHCI or IDE setting in the UEFI.</p></div></blockquote></div></div></blockquote></div><p>Im sorry i overlooked that, does this behavior happens when you disable iommu?</p></div></blockquote></div><p>EDIT: also make sure you disable &quot;combined mode&quot;, this should only affect the amd controller though<br />EDIT2: from the guide <a href="http://www.manualslib.com/manual/434060/Asrock-990fx-Extreme4.html?page=59" rel="nofollow">http://www.manualslib.com/manual/434060 … ml?page=59</a></p> <p class="postedit"><em>Last edited by nbhs (2013-07-26 22:07:21)</em></p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1304492">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1304513" class="blockpost rowodd"> <h2><span><span class="conr">#288</span> <a href="viewtopic.php?pid=1304513#p1304513">2013-07-26 22:14:57</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=53953">andy123</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2011-11-04</span></dd> <dd><span>Posts: 169</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=53953">Email</a></span> <span class="website"><a href="http://ajs124.de" rel="nofollow">Website</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>nbhs wrote:</cite><blockquote><div><div class="quotebox"><cite>nbhs wrote:</cite><blockquote><div><div class="quotebox"><cite>andy123 wrote:</cite><blockquote><div><p>To quote myself:</p></div></blockquote></div><p>Im sorry i overlooked that, does this behavior happens when you disable iommu?</p></div></blockquote></div><p>EDIT: also make sure you disable &quot;combined mode&quot;, this should only affect the amd controller though<br />EDIT2: from the guide <a href="http://www.manualslib.com/manual/434060/Asrock-990fx-Extreme4.html?page=59" rel="nofollow">http://www.manualslib.com/manual/434060 … ml?page=59</a></p></div></blockquote></div><p>No Problem. I have this guide as paper, but it&#039;s kind of worthless, since it depicts the old, 1.x version of the UEFI, so wrong defaults and stuff.<br />As stated somewhere above, with IOMMU off, the driver works good (normal SSD speeds and devices recognized normally).</p> </div> <div class="postsignature postmsg"><hr /><p>i&#039;m sorry for my poor english wirting skills…</p></div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1304513">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1304520" class="blockpost roweven"> <h2><span><span class="conr">#289</span> <a href="viewtopic.php?pid=1304520#p1304520">2013-07-26 22:18:39</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=70922">nbhs</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd class="postavatar"><img src="https://bbs.archlinux.org/img/avatars/70922.jpg?m=1367773811" width="80" height="80" alt="" /></dd> <dd><span>From: Montevideo, Uruguay</span></dd> <dd><span>Registered: 2013-05-02</span></dd> <dd><span>Posts: 402</span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>andy123 wrote:</cite><blockquote><div><div class="quotebox"><cite>nbhs wrote:</cite><blockquote><div><div class="quotebox"><cite>nbhs wrote:</cite><blockquote><div><p>Im sorry i overlooked that, does this behavior happens when you disable iommu?</p></div></blockquote></div><p>EDIT: also make sure you disable &quot;combined mode&quot;, this should only affect the amd controller though<br />EDIT2: from the guide <a href="http://www.manualslib.com/manual/434060/Asrock-990fx-Extreme4.html?page=59" rel="nofollow">http://www.manualslib.com/manual/434060 … ml?page=59</a></p></div></blockquote></div><p>No Problem. I have this guide as paper, but it&#039;s kind of worthless, since it depicts the old, 1.x version of the UEFI, so wrong defaults and stuff.<br />As stated somewhere above, with IOMMU off, the driver works good (normal SSD speeds and devices recognized normally).</p></div></blockquote></div><p>Yes but is it using the ahci or pata driver?, from what im getting enabling iommu switches the marvell controller into ide mode is this correct?, i believe there is a way to switch the controller into ahci using grub using the setpci command, i know some mac users did that when dual booting windows on some intel controller, im not sure how or if this is possible on yours</p><p>EDIT: something to read if you&#039;re interested <a href="http://www.projectosx.com/forum/index.php?showtopic=1150" rel="nofollow">http://www.projectosx.com/forum/index.p … topic=1150</a><br /><a href="http://wiki.debian.org/InstallingDebianOn/Apple/MacBook/3-1" rel="nofollow">http://wiki.debian.org/InstallingDebian … acBook/3-1</a></p> <p class="postedit"><em>Last edited by nbhs (2013-07-26 22:27:08)</em></p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1304520">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1304527" class="blockpost rowodd"> <h2><span><span class="conr">#290</span> <a href="viewtopic.php?pid=1304527#p1304527">2013-07-26 22:27:04</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=53953">andy123</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2011-11-04</span></dd> <dd><span>Posts: 169</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=53953">Email</a></span> <span class="website"><a href="http://ajs124.de" rel="nofollow">Website</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>nbhs wrote:</cite><blockquote><div><p>Yes but is it using the ahci or pata driver?, from what im getting enabling iommu switches the marvell controller into ide mode is this correct?, i believe there is a way to switch the controller into ahci using grub using the setpci command, i know some mac users did that when dual booting windows on some intel controller, im not sure how or if this is possible on yours</p></div></blockquote></div><p>I highly doubt that. It&#039;s ~00:30 here and I tested this a few hours ago, so I might be wrong but the driver is matched via tha pci id and that shouldn&#039;t change. Since I blacklisted the driver, I think I remember loading it manually and testing the drive, but I should probably go to bed, soon.</p> </div> <div class="postsignature postmsg"><hr /><p>i&#039;m sorry for my poor english wirting skills…</p></div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1304527">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1304533" class="blockpost roweven"> <h2><span><span class="conr">#291</span> <a href="viewtopic.php?pid=1304533#p1304533">2013-07-26 22:35:51</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=70922">nbhs</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd class="postavatar"><img src="https://bbs.archlinux.org/img/avatars/70922.jpg?m=1367773811" width="80" height="80" alt="" /></dd> <dd><span>From: Montevideo, Uruguay</span></dd> <dd><span>Registered: 2013-05-02</span></dd> <dd><span>Posts: 402</span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>andy123 wrote:</cite><blockquote><div><div class="quotebox"><cite>nbhs wrote:</cite><blockquote><div><p>Yes but is it using the ahci or pata driver?, from what im getting enabling iommu switches the marvell controller into ide mode is this correct?, i believe there is a way to switch the controller into ahci using grub using the setpci command, i know some mac users did that when dual booting windows on some intel controller, im not sure how or if this is possible on yours</p></div></blockquote></div><p>I highly doubt that. It&#039;s ~00:30 here and I tested this a few hours ago, so I might be wrong but the driver is matched via tha pci id and that shouldn&#039;t change. Since I blacklisted the driver, I think I remember loading it manually and testing the drive, but I should probably go to bed, soon.</p></div></blockquote></div><div class="codebox"><pre><code>modinfo ahci</code></pre></div><div class="codebox"><pre><code>parm: marvell_enable:Marvell SATA via AHCI (1 = enabled) (int)</code></pre></div><p>So you could try to add&#160; ahci.marvell_enable=1 as a kernel parameter or to /etc/modprobe.d/marvel.conf, i also found <a href="http://forum.mandriva.com/en/viewtopic.php?t=120279" rel="nofollow">http://forum.mandriva.com/en/viewtopic.php?t=120279</a>, so yeah if that doesnt work i dunno</p><p>EDIT: from wikipedia:</p><p>88SE91xx chipsets Linux support</p><p>Linux SATA driver<br />Appears to be supported by the standard AHCI driver, however out of the box is not recognised by the AHCI driver - AHCI driver needs to be taught to be loaded for the relevant PCI vendor and product ID.</p><p>Check lspci -nnk for the PCI vendor and product ID. i.e. in the following instance the relevant part is &quot;1b4b:9192&quot;</p><p>04:00.0 RAID bus controller [0104]: Marvell Technology Group Ltd. Device [1b4b:9192] (re11)</p><p>To associate these IDs with the AHCI driver run</p><p>/bin/echo 1b4b 9192 &gt; /sys/bus/pci/drivers/ahci/new_id</p> <p class="postedit"><em>Last edited by nbhs (2013-07-26 23:09:11)</em></p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1304533">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1304556" class="blockpost rowodd"> <h2><span><span class="conr">#292</span> <a href="viewtopic.php?pid=1304556#p1304556">2013-07-26 23:19:10</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=73506">GizmoChicken</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2013-07-25</span></dd> <dd><span>Posts: 15</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=73506">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>teekay wrote:</cite><blockquote><div><p>The Gigabyte 990FXA-UD5 rev. 3.0 I use has no issues with interrrupt remapping. Same for the 990FXA-UD3 as far as I know.<br />The only issue this board has is, if IOMMU is enabled, the Marvell SATA controller doesn&#039;t see any drives in Linux (a bug in the amd_iommu driver) but then again the marvell controller can be passed through to the VM.</p></div></blockquote></div><div class="quotebox"><cite>nbhs wrote:</cite><blockquote><div><p>Im not going to write anything to Asus anymore this is my last board from them, they dont support linux, and they dont care fixing anything after the release, my next MB will be Gigabyte</p></div></blockquote></div><p>@teekay and nbhs:</p><p>Thanks much!&#160; I think I&#039;ll give Gigabyte a try next time.</p><div class="quotebox"><cite>nbhs wrote:</cite><blockquote><div><p>yeah its got to do with the number of cpu cores on your board just add ivrs_ioapic[5]=00:14.0 ivrs_ioapic[6]=00:00.1 as a kernel parameter to grub and you&#039;re done, once you get it working remove this line: </p><div class="codebox"><pre><code>vfio_iommu_type1.allow_unsafe_interrupts=1</code></pre></div></div></blockquote></div><p>@nbhs:</p><p>Thanks for this too.&#160; As you suggested, I passed &quot;ivrs_ioapic[5]=00:14.0&quot; and &quot;ivrs_ioapic[6]=00:00.1&quot; as kernel parameters, and now I no longer need the allow_unsafe_interrupts module.&#160; Great!</p><div class="quotebox"><cite>nbhs wrote:</cite><blockquote><div><p>Have you tried appending iommu=pt to your grub cfg?</p></div></blockquote></div><p>I&#039;ve seen this &quot;iommu=pt&quot; parameter mentioned many times, but despite my search attempts, I have yet to figure out what it does.&#160; &#160;Is there simple explanation of what this parameter does?</p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1304556">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1304560" class="blockpost roweven"> <h2><span><span class="conr">#293</span> <a href="viewtopic.php?pid=1304560#p1304560">2013-07-26 23:25:55</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=70922">nbhs</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd class="postavatar"><img src="https://bbs.archlinux.org/img/avatars/70922.jpg?m=1367773811" width="80" height="80" alt="" /></dd> <dd><span>From: Montevideo, Uruguay</span></dd> <dd><span>Registered: 2013-05-02</span></dd> <dd><span>Posts: 402</span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>GizmoChicken wrote:</cite><blockquote><div><div class="quotebox"><cite>teekay wrote:</cite><blockquote><div><p>The Gigabyte 990FXA-UD5 rev. 3.0 I use has no issues with interrrupt remapping. Same for the 990FXA-UD3 as far as I know.<br />The only issue this board has is, if IOMMU is enabled, the Marvell SATA controller doesn&#039;t see any drives in Linux (a bug in the amd_iommu driver) but then again the marvell controller can be passed through to the VM.</p></div></blockquote></div><div class="quotebox"><cite>nbhs wrote:</cite><blockquote><div><p>Im not going to write anything to Asus anymore this is my last board from them, they dont support linux, and they dont care fixing anything after the release, my next MB will be Gigabyte</p></div></blockquote></div><p>@teekay and nbhs:</p><p>Thanks much!&#160; I think I&#039;ll give Gigabyte a try next time.</p><div class="quotebox"><cite>nbhs wrote:</cite><blockquote><div><p>yeah its got to do with the number of cpu cores on your board just add ivrs_ioapic[5]=00:14.0 ivrs_ioapic[6]=00:00.1 as a kernel parameter to grub and you&#039;re done, once you get it working remove this line: </p><div class="codebox"><pre><code>vfio_iommu_type1.allow_unsafe_interrupts=1</code></pre></div></div></blockquote></div><p>@nbhs:</p><p>Thanks for this too.&#160; As you suggested, I passed &quot;ivrs_ioapic[5]=00:14.0&quot; and &quot;ivrs_ioapic[6]=00:00.1&quot; as kernel parameters, and now I no longer need the allow_unsafe_interrupts module.&#160; Great!</p><div class="quotebox"><cite>nbhs wrote:</cite><blockquote><div><p>Have you tried appending iommu=pt to your grub cfg?</p></div></blockquote></div><p>I&#039;ve seen this &quot;iommu=pt&quot; parameter mentioned many times, but despite my search attempts, I have yet to figure out what it does.&#160; &#160;Is there simple explanation of what this parameter does?</p></div></blockquote></div><p>I believe this disables DMA remapping</p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1304560">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1304565" class="blockpost rowodd"> <h2><span><span class="conr">#294</span> <a href="viewtopic.php?pid=1304565#p1304565">2013-07-26 23:33:10</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=73506">GizmoChicken</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2013-07-25</span></dd> <dd><span>Posts: 15</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=73506">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>nbhs wrote:</cite><blockquote><div><div class="quotebox"><cite>GizmoChicken wrote:</cite><blockquote><div><p>I&#039;ve seen this &quot;iommu=pt&quot; parameter mentioned many times, but despite my search attempts, I have yet to figure out what it does.&#160; &#160;Is there simple explanation of what this parameter does?</p></div></blockquote></div><p>I believe this disables DMA remapping</p></div></blockquote></div><p>Thanks!</p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1304565">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1304619" class="blockpost roweven"> <h2><span><span class="conr">#295</span> <a href="viewtopic.php?pid=1304619#p1304619">2013-07-27 06:44:34</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=73506">GizmoChicken</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2013-07-25</span></dd> <dd><span>Posts: 15</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=73506">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <p>IT WORKS!&#160; </p><p>For me, the trick for ending the <a href="https://bbs.archlinux.org/viewtopic.php?pid=1304181#p1304181" rel="nofollow">BSODs that I previously reported</a> was to replace the ahci controller (&quot;-device ahci,bus=pcie.0,id=ahci&quot;) with an ide controller (&quot;-device piix4-ide,bus=pcie.0&quot;).&#160; It took me a few tries to figure out that the change in controller necessitated&#160; replacing &quot;-device ide-hd,bus=ahci.0,drive=disk&quot; with &quot;-device ide-hd,drive=disk&quot; (no &quot;bus=...,&quot;) compared to the original example.</p><p>Here&#039;s a minimalist version of the qemu commands that I&#039;m using:</p><div class="codebox"><pre><code>qemu-system-x86_64 -enable-kvm -M q35 -m 4096 -cpu host \ -smp 4,sockets=1,cores=4,threads=1 \ -bios /usr/share/qemu/bios.bin -vga none \ -device ioh3420,bus=pcie.0,addr=1c.0,multifunction=on,port=1,chassis=1,id=root \ -device vfio-pci,host=02:00.0,bus=root,addr=00.0,multifunction=on,x-vga=on \ -device vfio-pci,host=02:00.1,bus=root,addr=00.1 \ -device piix4-ide,bus=pcie.0 \ -drive file=/images/Win7HVM.img,id=disk,format=raw -device ide-hd,drive=disk</code></pre></div><p>Even with an outdated Nvidia driver (downloaded with Windows updates), I have HDMI audio and a Windows experience of 6.9 for desktop graphics and gaming graphics.&#160; But something tells me that a newer driver would improve matters.</p><p>Here&#039;s a summary of my setup:</p><div class="codebox"><pre><code>MB: ASUS M5A99FX PRO R2.0 w/ BIOS v2005 CPU: AMD Phenom II X4 955 RAM: 20 GB DDR3 1600 Primary GPU: Radeon HD6670 w/ a Catalyst 13.6-beta driver on the host Seconday GPU: Nvidia GTX550Ti w/ an Nvidia driver (from Windows updates) on the guest Ubuntu 13.10 (current daily build) Kernel 3.10.0-5 (from Ubuntu, no patches) seabios 1.7.3 (from Ununtu, no patches) qemu 1.5.0 (from Ununtu, no patches)</code></pre></div><p>Since I&#039;m using a stock Ubuntu kernel, I added the following to /etc/modules:</p><div class="codebox"><pre><code>vfio vfio_iommu_type1 vfio_pci kvm kvm_amd amd_iommu_v2 pci_stub</code></pre></div><p>Also, here&#039;s the GRUB cmdline that I&#039;m using:</p><div class="codebox"><pre><code>GRUB_CMDLINE_LINUX_DEFAULT=&quot;quiet splash pci-stub.ids=10de:1244,10de:0bee&quot;</code></pre></div><p>Using BIOS v2005, IOMMU works flawlessly on my ASUS M5A99FX PRO R2.0 motherboard.&#160; Using older BIOS versions with that motherboard, IOMMU errors occurred, but those errors could be cured by adding &quot;ivrs_ioapic[5]=00:14.0&quot; and &quot;ivrs_ioapic[6]=00:00.1&quot; to the GRUB cmdline (<a href="https://bbs.archlinux.org/viewtopic.php?pid=1304410#p1304410" rel="nofollow">as suggested by nbhs</a>).&#160; (Note that the pci addresses and values &quot;[5]&quot; and &quot;[6]&quot; may need to be changed, depending on setup.)</p><p>Using BIOS v2005, &quot;dmesg | grep AMD-Vi&quot; gives me the following output:</p><div class="codebox"><pre><code>$ dmesg | grep AMD-Vi AMD-Vi: Found IOMMU at 0000:00:00.2 cap 0x40 AMD-Vi: Interrupt remapping enabled AMD-Vi: Lazy IO/TLB flushing enabled</code></pre></div><p>I haven&#039;t tested much, but so far, the only major hiccup has been a frozen GPU when attempting to passthough an Ubuntu guest to the GPU.&#160; (I never was able to get my Ubuntu guest to boot with vfio passthough.) </p><p>Now, if only I could use VirtManager to start/stop/monitor this VM.</p><p>EDIT 1:&#160; I made a few minor tweaks since I first posted the above.&#160; For details, have a look here:&#160; <a href="https://bbs.archlinux.org/viewtopic.php?pid=1313007#p1313007" rel="nofollow">https://bbs.archlinux.org/viewtopic.php … 7#p1313007</a><br />EDIT 2:&#160; Updated to reflect that BIOS v2005 cures previously reported IOMMU errors and other small tweaks.</p> <p class="postedit"><em>Last edited by GizmoChicken (2013-11-08 04:03:16)</em></p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1304619">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1304648" class="blockpost rowodd"> <h2><span><span class="conr">#296</span> <a href="viewtopic.php?pid=1304648#p1304648">2013-07-27 08:09:02</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=73506">GizmoChicken</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2013-07-25</span></dd> <dd><span>Posts: 15</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=73506">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>GizmoChicken wrote:</cite><blockquote><div><p>I haven&#039;t tested much, but so far, the only major hiccup has been a frozen GPU when attempting to passthough an Ubuntu guest to the GPU.&#160; (I never was able to get my Ubuntu guest to boot with vfio passthough.)</p></div></blockquote></div><p>Small update:&#160; I just noticed that, when booting from an iso and running in &quot;try it&quot; mode, I am able to passthough an Ubuntu 13.10 guest to the GPU.&#160; So my guess is that vfio doesn&#039;t like something about the Ubuntu VM that I had previously created using VirtManager.&#160; At some point, I&#039;ll try creating a fresh Ubuntu VM and test again.</p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1304648">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1304664" class="blockpost roweven"> <h2><span><span class="conr">#297</span> <a href="viewtopic.php?pid=1304664#p1304664">2013-07-27 08:58:23</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=70922">nbhs</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd class="postavatar"><img src="https://bbs.archlinux.org/img/avatars/70922.jpg?m=1367773811" width="80" height="80" alt="" /></dd> <dd><span>From: Montevideo, Uruguay</span></dd> <dd><span>Registered: 2013-05-02</span></dd> <dd><span>Posts: 402</span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>GizmoChicken wrote:</cite><blockquote><div><p>IT WORKS!&#160; </p><p>For me, the trick for ending the <a href="https://bbs.archlinux.org/viewtopic.php?pid=1304181#p1304181" rel="nofollow">BSODs that I previously reported</a> was to replace the ahci controller (&quot;-device ahci,bus=pcie.0,id=ahci&quot;) with an ide controller (&quot;-device piix4-ide,bus=pcie.0&quot;).&#160; It took me a few tries to figure out that the change in controller necessitated&#160; replacing &quot;-device ide-hd,bus=ahci.0,drive=disk&quot; with &quot;-device ide-hd,drive=disk&quot; (no &quot;bus=...,&quot;) compared to the original example.</p><p>Here&#039;s a minimalist version of the qemu commands that I&#039;m using:</p><div class="codebox"><pre><code>qemu-system-x86_64 -enable-kvm -M q35 -m 4096 -cpu host \ -smp 4,sockets=1,cores=4,threads=1 \ -bios /usr/share/qemu/bios.bin -vga none \ -device ioh3420,bus=pcie.0,addr=1c.0,multifunction=on,port=1,chassis=1,id=root \ -device vfio-pci,host=02:00.0,bus=root,addr=00.0,multifunction=on,x-vga=on \ -device vfio-pci,host=02:00.1,bus=root,addr=00.1 \ -device piix4-ide,bus=pcie.0 \ -drive file=/images/Win7HVM.img,id=disk,format=raw -device ide-hd,drive=disk</code></pre></div><p>Even with an outdated Nvidia driver (downloaded with Windows updates), I have HDMI audio and a Windows experience of 6.9 for desktop graphics and gaming graphics.&#160; But something tells me that a newer driver would improve matters.</p><p>Here&#039;s a summary of my setup:</p><div class="codebox"><pre><code>MB: ASUS M5A99FX PRO R2.0 CPU: AMD Phenom II X4 955 RAM: 20 GB DDR3 1600 Primary GPU: Radeon HD6670 w/ a Catalyst 13.6-beta driver on the host Seconday GPU: Nvidia GTX550Ti w/ an Nvidia driver (from Windows updates) on the guest Ubuntu 13.10 (current daily build) Kernel 3.10.0-5 (from Ubuntu, no patches) qemu 1.5.0 (from Ununtu, no patches) seabios 1.7.3 (from Ununtu, no patches)</code></pre></div><p>Since I&#039;m using a stock Ubuntu kernel, I added the following to /etc/modules:</p><div class="codebox"><pre><code>vfio vfio_iommu_type1 vfio_pci kvm kvm_amd amd_iommu_v2 pci_stub</code></pre></div><p>Also, here&#039;s the GRUB cmdline that I&#039;m using:</p><div class="codebox"><pre><code>GRUB_CMDLINE_LINUX_DEFAULT=&quot;quiet splash amd_iommu=on ivrs_ioapic[5]=00:14.0 ivrs_ioapic[6]=00:00.1 pci-stub.ids=10de:1244,10de:0bee&quot;</code></pre></div><p>As I mentioned elsewhere, the addition of &quot;ivrs_ioapic[5]=00:14.0&quot; and &quot;ivrs_ioapic[6]=00:00.1&quot; (<a href="https://bbs.archlinux.org/viewtopic.php?pid=1304410#p1304410" rel="nofollow">as suggested by nbhs</a>) seems to cure the IOMMU errors with ASUS M5A99FX PRO R2.0 motherboard.&#160; (Note that the pci addresses and values &quot;[5]&quot; and &quot;[6]&quot; may need to be changed, depending on setup.)</p><div class="codebox"><pre><code>$ dmesg | grep AMD-Vi AMD-Vi: Found IOMMU at 0000:00:00.2 cap 0x40 AMD-Vi: Interrupt remapping enabled AMD-Vi: Lazy IO/TLB flushing enabled</code></pre></div><p>I haven&#039;t tested much, but so far, the only major hiccup has been a frozen GPU when attempting to passthough an Ubuntu guest to the GPU.&#160; (I never was able to get my Ubuntu guest to boot with vfio passthough.) </p><p>Now, if only I could use VirtManager to start/stop/monitor this VM.</p></div></blockquote></div><p>Congrats, your problem is you installed windows with virt-manager using the ide controller instead of the &quot;sata&quot; controller (ahci), and windows doesnt like that (it doesnt like that even on bare hardware), see this post on the same problem <a href="https://bbs.archlinux.org/viewtopic.php?pid=1298880#p1298880" rel="nofollow">https://bbs.archlinux.org/viewtopic.php … 0#p1298880</a>, also &quot;amd_iommu=on&quot; is not a valid kernel parameter as the kernel automatically enables it on amd boards</p> <p class="postedit"><em>Last edited by nbhs (2013-07-27 08:59:17)</em></p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1304664">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1304695" class="blockpost rowodd"> <h2><span><span class="conr">#298</span> <a href="viewtopic.php?pid=1304695#p1304695">2013-07-27 10:35:12</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=73506">GizmoChicken</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2013-07-25</span></dd> <dd><span>Posts: 15</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=73506">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>nbhs wrote:</cite><blockquote><div><p>Congrats, your problem is you installed windows with virt-manager using the ide controller instead of the &quot;sata&quot; controller (ahci), and windows doesnt like that (it doesnt like that even on bare hardware), see this post on the same problem <a href="https://bbs.archlinux.org/viewtopic.php?pid=1298880#p1298880" rel="nofollow">https://bbs.archlinux.org/viewtopic.php … 0#p1298880</a>, also &quot;amd_iommu=on&quot; is not a valid kernel parameter as the kernel automatically enables it on amd boards</p></div></blockquote></div><p>Yep, that probably explains it.&#160; I&#039;ll create fresh VMs (Windows and Ubuntu) using sata/ahci next week and will test whether they too run with the unpatched versions of qemu and seabios along with the stock Ubuntu 3.10 kernel.</p><p>Oh, I tested my Nvidia GT610 as yet another secondary GPU, and it seems to be working great too.&#160; Not quite as fast as my Nvidia GTX550Ti, but plenty&#160; fast for Netflix and Youtube.</p><p>QUESTION:&#160; Although it&#039;s a bit slow, I really like that my GT610 is fanless, and therefore silent.&#160; And so I&#039;m thinking that I might like a matching GT610 for use as a primary card on my host.&#160; But I&#039;m wondering, if my primary and secondary cards are identical (both GT610s), would I be able to use pci-stub to bind selectively my secondary card?&#160; &#160;That is, in the case where the primary and secondary cards (and presumably their identifies) are identical, would there be some means by which pci-stub could distinguish the two cards, such as by pci-slot location?</p> <p class="postedit"><em>Last edited by GizmoChicken (2013-07-27 10:42:05)</em></p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1304695">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1304711" class="blockpost roweven"> <h2><span><span class="conr">#299</span> <a href="viewtopic.php?pid=1304711#p1304711">2013-07-27 11:35:39</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=73162">myweb</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2013-07-13</span></dd> <dd><span>Posts: 68</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=73162">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <p>Dear All,</p><p> I am still unable get Windows running with ATI HD7750 card:<br /> I could pass first part of windows installation (partitionig and files<br /> copying), but then VM reboots and I get black screen.<br />Alex Williamson proposed to use &quot;vga-current&quot; branch of : <br />git://github.com/awilliam/qemu-vfio.git<br />git://github.com/awilliam/linux-vfio.git</p><p>Could you please check if I created right PKGBUILD files?</p><p>Linux vfio: <a href="http://www.fileswap.com/dl/K7s93euILN/" rel="nofollow">http://www.fileswap.com/dl/K7s93euILN/</a><br />Qemu vfio: <a href="http://www.fileswap.com/dl/Oie83lou8B/" rel="nofollow">http://www.fileswap.com/dl/Oie83lou8B/</a></p> <p class="postedit"><em>Last edited by myweb (2013-07-27 11:37:51)</em></p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1304711">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1304754" class="blockpost rowodd"> <h2><span><span class="conr">#300</span> <a href="viewtopic.php?pid=1304754#p1304754">2013-07-27 13:46:47</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=73162">myweb</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2013-07-13</span></dd> <dd><span>Posts: 68</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=73162">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <p>Hm,</p><p>I have builded new kernel, but can&#039;t execute qemu:<br />Could not access KVM kernel module: No such file or directory<br />failed to initialize KVM: No such file or directory</p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1304754">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div class="postlinksb"> <div class="inbox crumbsplus"> <div class="pagepost"> <p class="pagelink conl"><span class="pages-label">Pages: </span><a rel="prev" class="item1" href="viewtopic.php?id=162768&amp;p=11">Previous</a> <a href="viewtopic.php?id=162768">1</a> <span class="spacer">…</span> <a href="viewtopic.php?id=162768&amp;p=10">10</a> <a href="viewtopic.php?id=162768&amp;p=11">11</a> <strong>12</strong> <a href="viewtopic.php?id=162768&amp;p=13">13</a> <a href="viewtopic.php?id=162768&amp;p=14">14</a> <span class="spacer">…</span> <a href="viewtopic.php?id=162768&amp;p=234">234</a> <a rel="next" href="viewtopic.php?id=162768&amp;p=13">Next</a></p> <p class="postlink conr">Topic closed</p> </div> <ul class="crumbs"> <li><a href="index.php">Index</a></li> <li><span>»&#160;</span><a href="viewforum.php?id=48">Topics Going Nowhere</a></li> <li><span>»&#160;</span><strong><a href="viewtopic.php?id=162768">KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</a></strong></li> </ul> <p class="subscribelink clearb"><a href="misc.php?action=subscribe&amp;tid=162768">Subscribe to this topic</a></p> <div class="clearer"></div> </div> </div> </div> <div id="brdfooter" class="block"> <h2><span>Board footer</span></h2> <div class="box"> <div id="brdfooternav" class="inbox"> <div class="conl"> <form id="qjump" method="get" action="viewforum.php"> <div><label><span>Jump to<br /></span> <select name="id" onchange="window.location=('viewforum.php?id='+this.options[this.selectedIndex].value)"> <optgroup label="Technical Issues and Assistance"> <option value="23">Newbie Corner</option> <option value="17">Installation</option> <option value="22">Kernel &amp; Hardware</option> <option value="18">Applications &amp; Desktop Environments</option> <option value="31">Laptop Issues</option> <option value="8">Networking, Server, and Protection</option> <option value="32">Multimedia and Games</option> <option value="50">System Administration</option> <option value="35">Other Architectures</option> </optgroup> <optgroup label="Arch-centric"> <option value="24">Announcements, Package &amp; Security Advisories</option> <option value="1">Arch Discussion</option> <option value="13">Forum &amp; Wiki discussion</option> </optgroup> <optgroup label="Pacman Upgrades, Packaging &amp; AUR"> <option value="44">Pacman &amp; Package Upgrade Issues</option> <option value="49">[testing] Repo Forum</option> <option value="4">Creating &amp; Modifying Packages</option> <option value="38">AUR Issues, Discussion &amp; PKGBUILD Requests</option> </optgroup> <optgroup label="Contributions &amp; Discussion"> <option value="20">GNU/Linux Discussion</option> <option value="27">Community Contributions</option> <option value="33">Programming &amp; Scripting</option> <option value="30">Other Languages</option> <option value="47">Artwork and Screenshots</option> <option value="42">Try This</option> </optgroup> <optgroup label="/dev/null"> <option value="29">Off-Topic</option> <option value="48" selected="selected">Topics Going Nowhere</option> <option value="36">Dustbin</option> </optgroup> </select></label> <input type="submit" value=" Go " accesskey="g" /> </div> </form> </div> <div class="conr"> <p id="feedlinks"><span class="atom"><a href="extern.php?action=feed&amp;tid=162768&amp;type=atom">Atom topic feed</a></span></p> <p id="poweredby">Powered by <a href="http://fluxbb.org/">FluxBB</a></p> </div> <div class="clearer"></div> </div> </div> </div> </div> <div class="end-box"></div> </div> </body> </html>
