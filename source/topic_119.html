<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"> <html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en" dir="ltr"> <head> <meta http-equiv="Content-Type" content="text/html; charset=utf-8" /> <title>KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9 (Page 119) / Topics Going Nowhere / Arch Linux Forums</title> <link rel="stylesheet" type="text/css" href="style/ArchLinux.css" /> <link rel="canonical" href="viewtopic.php?id=162768&amp;p=119" title="Page 119" /> <link rel="prev" href="viewtopic.php?id=162768&amp;p=118" title="Page 118" /> <link rel="next" href="viewtopic.php?id=162768&amp;p=120" title="Page 120" /> <link rel="alternate" type="application/atom+xml" href="extern.php?action=feed&amp;tid=162768&amp;type=atom" title="Atom topic feed" /> <link rel="stylesheet" media="screen" href="style/ArchLinux/arch.css?v=3" /> <link rel="stylesheet" media="screen" href="style/ArchLinux/archnavbar.css?v=2" /> <link rel="shortcut icon" href="style/ArchLinux/favicon.ico" /> </head> <body> <div id="archnavbar" class="anb-forum"> <div id="archnavbarlogo"><h1><a href="http://www.archlinux.org/">Arch Linux</a></h1></div> <div id="archnavbarmenu"> <ul id="archnavbarlist"> <li id="anb-home"><a href="http://www.archlinux.org/">Home</a></li><li id="anb-packages"><a href="http://www.archlinux.org/packages/">Packages</a></li><li id="anb-forums" class="anb-selected"><a href="https://bbs.archlinux.org/">Forums</a></li><li id="anb-wiki"><a href="https://wiki.archlinux.org/">Wiki</a></li><li id="anb-bugs"><a href="https://bugs.archlinux.org/">Bugs</a></li><li id="anb-aur"><a href="https://aur.archlinux.org/">AUR</a></li><li id="anb-download"><a href="http://www.archlinux.org/download/">Download</a></li> </ul> </div> </div> <div id="punviewtopic" class="pun"> <div class="top-box"></div> <div class="punwrap"> <div id="brdheader" class="block"> <div class="box"> <div id="brdmenu" class="inbox"> <ul> <li id="navindex" class="isactive"><a href="index.php">Index</a></li> <li id="navuserlist"><a href="userlist.php">User list</a></li> <li id="navsearch"><a href="search.php">Search</a></li> <li id="navprofile"><a href="profile.php?id=80749">Profile</a></li> <li id="navlogout"><a href="login.php?action=out&amp;id=80749&amp;csrf_token=5c20501ec397bb45ef8ee8c84db232c8d8e421c6">Logout</a></li> </ul> </div> <div id="brdwelcome" class="inbox"> <ul class="conl"> <li><span>Logged in as <strong>SXX</strong></span></li> <li><span>Last visit: 2015-08-16 12:20:09</span></li> </ul> <ul class="conr"> <li><span>Topics: <a href="search.php?action=show_replies" title="Find topics you have posted to.">Posted</a> | <a href="search.php?action=show_new" title="Find topics with new posts since your last visit.">New</a> | <a href="search.php?action=show_recent" title="Find topics with recent posts.">Active</a> | <a href="search.php?action=show_unanswered" title="Find topics with no replies.">Unanswered</a></span></li> </ul> <div class="clearer"></div> </div> </div> </div> <div id="brdmain"> <div class="linkst"> <div class="inbox crumbsplus"> <ul class="crumbs"> <li><a href="index.php">Index</a></li> <li><span>»&#160;</span><a href="viewforum.php?id=48">Topics Going Nowhere</a></li> <li><span>»&#160;</span><strong><a href="viewtopic.php?id=162768">KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</a></strong></li> </ul> <div class="pagepost"> <p class="pagelink conl"><span class="pages-label">Pages: </span><a rel="prev" class="item1" href="viewtopic.php?id=162768&amp;p=118">Previous</a> <a href="viewtopic.php?id=162768">1</a> <span class="spacer">…</span> <a href="viewtopic.php?id=162768&amp;p=117">117</a> <a href="viewtopic.php?id=162768&amp;p=118">118</a> <strong>119</strong> <a href="viewtopic.php?id=162768&amp;p=120">120</a> <a href="viewtopic.php?id=162768&amp;p=121">121</a> <span class="spacer">…</span> <a href="viewtopic.php?id=162768&amp;p=234">234</a> <a rel="next" href="viewtopic.php?id=162768&amp;p=120">Next</a></p> <p class="postlink conr">Topic closed</p> </div> <div class="clearer"></div> </div> </div> <div id="p1465731" class="blockpost rowodd blockpost1"> <h2><span><span class="conr">#2951</span> <a href="viewtopic.php?pid=1465731#p1465731">2014-10-14 12:53:22</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=77255">dave558</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2013-11-28</span></dd> <dd><span>Posts: 3</span></dd> <dd class="usercontacts"><span class="email"><a href="mailto:sophal.lee@live.com">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <p>Hi all</p><p>I&#039;m trying to pass through a graphic card to my virtual guests. Steps I&#039;ve performed so far are as follows:<br />* Compiled kernel version 3.10 with vfio support (CONFIG_VFIO_PCI_VGA=y)<br />* Disabled radeon kernel modules via the blacklist in /etc/modprobe.d.<br />* Unbinded the graphics card from the PCI bus and assigned it the VFIO for pass through.</p><p>I have installed qemu-kvm through yum but it appears that this RPM has not been compiled for VFIO. When trying assign the graphic card to guests there is no option to assign device to vfio-pci. The partial command below results in errors:<br />&#160; &#160; /usr/libexec/qemu-kvm -device&#160; vfio-pci</p><p>I have read also that qemu 2.0+ supports VFIO and I am thinking of compiling qemu from the QEMU website. Although Qemu can run as a stand-alone emulator, I am assumming it will use the kernel-module automatically if available. Is this the case?</p><p>Also will there be any difference in performance between qemu compiled from source and qemu-kvm? Or is there anything else you can recommend? Thank you.</p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1465731">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1465806" class="blockpost roweven"> <h2><span><span class="conr">#2952</span> <a href="viewtopic.php?pid=1465806#p1465806">2014-10-14 17:03:55</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=85175">evilsephiroth</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2014-09-16</span></dd> <dd><span>Posts: 14</span></dd> <dd class="usercontacts"><span class="email"><a href="mailto:evilsephiroth@gmail.com">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <p>Hi to all...</p><p>I&#039;ve got a headless server(Proxmox) with kvm/qemu git with fully working passthrough(pciex) to various vm.</p><p>I can passthrough nvidia gpu to windows vm, dvb-s pci express card to ubuntu and a pciexpress ethernet card to another ubuntu host.</p><p>My machine runs on kernel 3.16.2 with some patches (intel arbiter) and latest qemu.</p><p>I&#039;m trying to create an openelec VM to use as media center&#160; and thus I need intel gpu passthrough.</p><p>Basically I don&#039;t need a monitor attached because I&#039;m administering with ssh/webinterface.</p><br /><p>Grub Settings</p><div class="codebox"><pre><code>GRUB_CMDLINE_LINUX_DEFAULT=&quot;quiet intel_iommu=on i915.enable_hd_vgaarb=1 pci-stub.ids=10de:1380,10de:0fbc,4254:0952,7470:3468,8086:0152,8086:1e20&quot;</code></pre></div><p>lspci</p><div class="codebox"><pre><code>00:00.0 Host bridge: Intel Corporation Xeon E3-1200 v2/3rd Gen Core processor DRAM Controller (rev 09) 00:01.0 PCI bridge: Intel Corporation Xeon E3-1200 v2/3rd Gen Core processor PCI Express Root Port (rev 09) 00:02.0 VGA compatible controller: Intel Corporation Xeon E3-1200 v2/3rd Gen Core processor Graphics Controller (rev 09) 00:14.0 USB controller: Intel Corporation 7 Series/C210 Series Chipset Family USB xHCI Host Controller (rev 04) 00:16.0 Communication controller: Intel Corporation 7 Series/C210 Series Chipset Family MEI Controller #1 (rev 04) 00:1a.0 USB controller: Intel Corporation 7 Series/C210 Series Chipset Family USB Enhanced Host Controller #2 (rev 04) 00:1b.0 Audio device: Intel Corporation 7 Series/C210 Series Chipset Family High Definition Audio Controller (rev 04) 00:1c.0 PCI bridge: Intel Corporation 7 Series/C210 Series Chipset Family PCI Express Root Port 1 (rev c4) 00:1c.1 PCI bridge: Intel Corporation 7 Series/C210 Series Chipset Family PCI Express Root Port 2 (rev c4) 00:1c.2 PCI bridge: Intel Corporation 7 Series/C210 Series Chipset Family PCI Express Root Port 3 (rev c4) 00:1c.4 PCI bridge: Intel Corporation 7 Series/C210 Series Chipset Family PCI Express Root Port 5 (rev c4) 00:1d.0 USB controller: Intel Corporation 7 Series/C210 Series Chipset Family USB Enhanced Host Controller #1 (rev 04) 00:1e.0 PCI bridge: Intel Corporation 82801 PCI Bridge (rev a4) 00:1f.0 ISA bridge: Intel Corporation B75 Express Chipset LPC Controller (rev 04) 00:1f.2 SATA controller: Intel Corporation 7 Series/C210 Series Chipset Family 6-port SATA Controller [AHCI mode] (rev 04) 00:1f.3 SMBus: Intel Corporation 7 Series/C210 Series Chipset Family SMBus Controller (rev 04) 01:00.0 VGA compatible controller: NVIDIA Corporation GM107 [GeForce GTX 750 Ti] (rev a2) 01:00.1 Audio device: NVIDIA Corporation Device 0fbc (rev a1) 02:00.0 Multimedia video controller: Conexant Systems, Inc. CX23885 PCI Video and Audio Decoder (rev 04) 03:00.0 SATA controller: ASMedia Technology Inc. ASM1062 Serial ATA Controller (rev 01) 04:00.0 Ethernet controller: Realtek Semiconductor Co., Ltd. RTL8111/8168/8411 PCI Express Gigabit Ethernet Controller (rev 06) 05:00.0 Ethernet controller: Realtek Semiconductor Co., Ltd. RTL8111/8168/8411 PCI Express Gigabit Ethernet Controller (rev 06)</code></pre></div><p>lspci -n</p><div class="codebox"><pre><code>00:00.0 0600: 8086:0150 (rev 09) 00:01.0 0604: 8086:0151 (rev 09) 00:02.0 0300: 8086:0152 (rev 09) 00:14.0 0c03: 8086:1e31 (rev 04) 00:16.0 0780: 8086:1e3a (rev 04) 00:1a.0 0c03: 8086:1e2d (rev 04) 00:1b.0 0403: 8086:1e20 (rev 04) 00:1c.0 0604: 8086:1e10 (rev c4) 00:1c.1 0604: 8086:1e12 (rev c4) 00:1c.2 0604: 8086:1e14 (rev c4) 00:1c.4 0604: 8086:1e18 (rev c4) 00:1d.0 0c03: 8086:1e26 (rev 04) 00:1e.0 0604: 8086:244e (rev a4) 00:1f.0 0601: 8086:1e49 (rev 04) 00:1f.2 0106: 8086:1e02 (rev 04) 00:1f.3 0c05: 8086:1e22 (rev 04) 01:00.0 0300: 10de:1380 (rev a2) 01:00.1 0403: 10de:0fbc (rev a1) 02:00.0 0400: 14f1:8852 (rev 04) 03:00.0 0106: 1b21:0612 (rev 01) 04:00.0 0200: 10ec:8168 (rev 06) 05:00.0 0200: 10ec:8168 (rev 06)</code></pre></div><p>KVM command</p><div class="codebox"><pre><code>/usr/bin/kvm -id 105 -chardev &#039;socket,id=qmp,path=/var/run/qemu-server/105.qmp,server,nowait&#039; -mon &#039;chardev=qmp,mode=control&#039; -vnc unix:/var/run/qemu-server/105.vnc,x509,password -pidfile /var/run/qemu-server/105.pid -daemonize -smbios &#039;type=1,uuid=2233690f-30ac-499f-ad7e-91a1e2f62792&#039; -name Openelec -smp &#039;sockets=1,cores=1&#039; -nodefaults -boot &#039;menu=on&#039; -vga none -cpu &#039;kvm64,kvm=off,+lahf_lm,+x2apic,+sep&#039; -k it -m 2048 -readconfig /usr/share/qemu-server/pve-q35.cfg -device &#039;usb-tablet,id=tablet,bus=ehci.0,port=1&#039; -device &#039;vfio-pci,host=00:02.0,id=hostpci0,bus=ich9-pcie-port-1,addr=0x0,x-vga=on&#039; -device &#039;virtio-balloon-pci,id=balloon0,bus=pci.0,addr=0x3&#039; -iscsi &#039;initiator-name=iqn.1993-08.org.debian:01:d4d6185a22&#039; -drive &#039;file=/var/lib/vz/template/iso/ubuntu-14.04.1-desktop-amd64.iso,if=none,id=drive-ide2,media=cdrom,aio=native&#039; -device &#039;ide-cd,bus=ide.1,unit=0,drive=drive-ide2,id=ide2,bootindex=200&#039; -drive &#039;file=/var/lib/vz/images/105/vm-105-disk-1.qcow2,if=none,id=drive-ide0,format=qcow2,aio=native,cache=none&#039; -device &#039;ide-hd,bus=ide.0,unit=0,drive=drive-ide0,id=ide0,bootindex=100&#039; -netdev &#039;type=tap,id=net0,ifname=tap105i0,script=/var/lib/qemu-server/pve-bridge,downscript=/var/lib/qemu-server/pve-bridgedown,vhost=on&#039; -device &#039;virtio-net-pci,mac=EE:4E:D1:CD:4A:51,netdev=net0,bus=pci.0,addr=0x12,id=net0,bootindex=300&#039; -machine &#039;type=q35&#039;</code></pre></div><p>dmesg</p><div class="codebox"><pre><code>Device is ineligible for IOMMU domain attach due to platform RMRR requirement.</code></pre></div><p>Modprobe.d/blacklist.conf</p><div class="codebox"><pre><code>i915 nouveau snd-hda-intel-hdmi snd-hda-codec-hdmi</code></pre></div><p>Intel audio/video is correctly assigned to pci-stub and iommu group are correct but when I run I get</p><div class="codebox"><pre><code>vm: -device vfio-pci,host=00:02.0,id=hostpci0,bus=ich9-pcie-port-1,addr=0x0,x-vga=on: vfio: failed to set iommu for container: Operation not permitted kvm: -device vfio-pci,host=00:02.0,id=hostpci0,bus=ich9-pcie-port-1,addr=0x0,x-vga=on: vfio: failed to setup container for group 2 kvm: -device vfio-pci,host=00:02.0,id=hostpci0,bus=ich9-pcie-port-1,addr=0x0,x-vga=on: vfio: failed to get group 2 kvm: -device vfio-pci,host=00:02.0,id=hostpci0,bus=ich9-pcie-port-1,addr=0x0,x-vga=on: Device initialization failed. kvm: -device vfio-pci,host=00:02.0,id=hostpci0,bus=ich9-pcie-port-1,addr=0x0,x-vga=on: Device &#039;vfio-pci&#039; could not be initialized</code></pre></div><p>I&#039;ve seen this patch</p><p><a href="https://lkml.org/lkml/2014/7/3/580" rel="nofollow">https://lkml.org/lkml/2014/7/3/580</a> that disables devices using&#160; rmrr.</p><p>My doubt is if I&#039;m correctly not loading intel drivers so device is free for passthrough...</p><p>Thanks in advance</p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1465806">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1465813" class="blockpost rowodd"> <h2><span><span class="conr">#2953</span> <a href="viewtopic.php?pid=1465813#p1465813">2014-10-14 17:10:23</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=74748">kaeptnb</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2013-09-04</span></dd> <dd><span>Posts: 30</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=74748">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>aw wrote:</cite><blockquote><div><p>Does this resolve the emulation failure: <a href="https://git.kernel.org/cgit/virt/kvm/kvm.git/patch/?id=0a37027e83f867793af0ccb9176a6b383dd0b7c8" rel="nofollow">https://git.kernel.org/cgit/virt/kvm/kv … 383dd0b7c8</a></p></div></blockquote></div><br /><p>Hi aw,</p><p>i have a similar regression - but without passing a nvidia card to the guest (i pass a ati radeon hd to the guest) whichs works flawless with 3.16, but with 3.17 (with and without your patch) i get:</p><br /><div class="codebox"><pre><code>KVM internal error. Suberror: 1 emulation failure EAX=00000000 EBX=00000000 ECX=00000000 EDX=000106a5 ESI=00000000 EDI=00000000 EBP=00000000 ESP=00000000 EIP=0000fff2 EFL=00000002 [-------] CPL=0 II=0 A20=1 SMM=0 HLT=0 ES =0000 00000000 0000ffff 00009300 CS =f000 ffff0000 0000ffff 00009b00 SS =0000 00000000 0000ffff 00009300 DS =0000 00000000 0000ffff 00009300 FS =0000 00000000 0000ffff 00009300 GS =0000 00000000 0000ffff 00009300 LDT=0000 00000000 0000ffff 00008200 TR =0000 00000000 0000ffff 00008b00 GDT= 00000000 0000ffff IDT= 00000000 0000ffff CR0=60000010 CR2=00000000 CR3=00000000 CR4=00000000 DR0=0000000000000000 DR1=0000000000000000 DR2=0000000000000000 DR3=0000000000000000 DR6=00000000ffff0ff0 DR7=0000000000000400 EFER=0000000000000000 Code=90 90 eb c3 90 90 90 90 90 90 00 00 00 00 56 54 46 00 90 90 &lt;eb&gt; ac 90 90 90 90 90 90 90 90 90 90 90 90 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00</code></pre></div><p>The only change is kernel upgrade from 3.16 to 3.17. I already tried your patch - doesn&#039;t seem to help</p><p>Greetings</p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1465813">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1465851" class="blockpost roweven"> <h2><span><span class="conr">#2954</span> <a href="viewtopic.php?pid=1465851#p1465851">2014-10-14 18:52:48</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=84905">zsph</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2014-09-04</span></dd> <dd><span>Posts: 9</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=84905">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>aw wrote:</cite><blockquote><div><div class="quotebox"><cite>DanaGoyette wrote:</cite><blockquote><div><p>I actually get something similar when I stop or start (I forgot which) a VM, if I have the AMD High-Definition Audio Controller bound to the VM.&#160; Blacklisting snd-hda-intel on the host prevents the panic, but also prevents the integrated Realtek sound card from working on the host.</p><p>EDIT: By &quot;similar&quot;, I mean a very similar, if not the same, backtrace.</p></div></blockquote></div><p>Try using pci-stub.ids instead of blacklisting the driver</p></div></blockquote></div><p>Thank you both. For the whole week not a single crush! I&#039;m so happy <img src="https://bbs.archlinux.org/img/smilies/smile.png" width="15" height="15" alt="smile" /></p> </div> <div class="postsignature postmsg"><hr /><p>Asus P8Z77-V LK, Core i7 3770, Asus NVIDIA GTX 770 DirectCU II OC, Debian x64, EFI, Kernel 3.16 + i915 arbiter patch. <br />3DMark11: bare metal <a href="http://www.3dmark.com/3dm11/8748717" rel="nofollow">P10231</a> vs vfio <a href="http://www.3dmark.com/3dm11/8754453" rel="nofollow">P10039</a>: 98% of performance!</p></div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1465851">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1465854" class="blockpost rowodd"> <h2><span><span class="conr">#2955</span> <a href="viewtopic.php?pid=1465854#p1465854">2014-10-14 19:05:58</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=53258">Calrama</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>From: Berlin</span></dd> <dd><span>Registered: 2011-10-14</span></dd> <dd><span>Posts: 30</span></dd> <dd class="usercontacts"><span class="email"><a href="mailto:moritzmaxeiner@googlemail.com">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>Denso wrote:</cite><blockquote><div><p>Hi everyone .</p><p>Can anyone who uses OVMF successfully post his entire qemu launch command ?</p><p>OVMF might be the answer to all my hangs issues on VMs&#039; reboots , but it still doesn&#039;t detect any of my drives .</p><p>I don&#039;t use libvirt , just plain shell scripts .</p><p>Much appreciated .</p></div></blockquote></div><div class="codebox"><pre><code>qemu-system-x86_64 \ -pflash /usr/share/qemu/bios_ovmf.bin \ -enable-kvm -cpu host,hv_time,kvm=off \ -smp cpus=4,cores=4,threads=1 \ -m 8GiB \ -name WinGamingOVMF,process=WinGamingOVMF \ -device vfio-pci,host=01:00.0,multifunction=on,x-vga=on \ -device vfio-pci,host=01:00.1 \ -daemonize \ -rtc base=localtime \ -soundhw hda \ -vga none \ -device virtio-scsi-pci,id=scsi \ -drive file=/dev/partitions/wingamingovmf,if=none,id=disk_primary,format=raw \ -device ide-hd,bus=ide.0,drive=disk_primary \ -drive file=/dev/partitions/games,if=none,id=disk_games,format=raw \ -device scsi-hd,bus=scsi.0,drive=disk_games \ -netdev bridge,br=br0,id=veth0 -device virtio-net-pci,netdev=veth0 -usb</code></pre></div><p>I&#039;m using this on Gentoo, not on Arch, but the above command should be the same. The relevant stuff is this:<br />Kernel: 3.16.3-gentoo (with all the patches in the OP of this thread, I will try 3.17 without any of these patches later, because iirc none of the patches should be necessary when using OVMF)<br />Architecture: x86_64<br />QEMU: GIT master on commit 2472b6c07bb50179019589af1c22f43935ab7f5c<br />EDK2 (OVMF): SVN trunk on revision 16195</p><br /><p>I know that you only asked for the command, but I&#039;d like to share some of my notes from my adventure about using OVMF (started last saturday because pretty much every other VM boot would make my host freeze and force me to power down my whole system the old-fashioned way, got it working sunday):</p><p>First, the <strong>graphics card</strong> you want to pass through absolutely <strong>must have either a hybrid, or uefi-only bios</strong>; if your graphics card has only<br />legacy bios (as my GTX 660 TI did), you need to flash it to hybrid / uefi-only, or OVMF won&#039;t do anything for you. If you do try<br />to use a legacy-bios graphics card with OVMF, your virtual machine will detect the passed-through graphics card (even by name in the device manager in case of Windows), but it will not be useable (any monitor you connect to the graphics card will not receive any signal from it / Windows will not detect any monitor connected to the graphics card).</p><p>Furthermore, if you want to use Windows (which I&#039;m going to assume), I think you need at least Windows 8 (I tested it only with Windows 8.1 and Windows 7, but Windows 8.1 and 8 extremely similar in nature, so I&#039;m going to assume that they behave the same in regards to this - please correct me on this if I am wrong), because when trying to boot the Windows 7 installation disk, after the usual &quot;Windows is loading files...&quot; the Windows 7 install freezes as soon as the Windows logo shows up.</p><p>Additionally, the newer Q35 architecture (option &quot;-M q35&quot;) does not seem to work well with Windows 8+. While I could install Windows 8.1 perfectly fine while having q35 enabled, after the installation - at first bootup - the &quot;Getting devices ready&quot; freezes at 15% (on multiple tries, every time). Even if the system is setup completely without q35 (or having it only enabled until first reboot, then shutoff the machine and disable it), enabling q35 will then consistently freeze the VM at the Windows logo.</p><p>When trying to install Windows 8+, I would suggest including the relevant disc images like this:</p><div class="codebox"><pre><code> -drive file=/path/to/${WINDOWS_IMAGE},id=iso_install,if=none \ -device scsi-cd,drive=iso_install \ -cdrom /path/to/virtio-win-0.1-81.iso`</code></pre></div><p>These two <em>should</em> ensure that OVMF recognizes the windows disc image as a UEFI boot option, while having the windows virtio drivers available at install time. I had some trouble with QEMU+OVMF not recognizing any non-virtio disc images as UEFI-bootage (they did not show up on the UEFI shell / at the boot manager). On that note: When trying to install, you will likely automatically enter the EFI shell initially instead of the VM booting from the only available EFI boot option (the windows disc image). The OVMF EFI shell should be a bunch of yellow text (listing all pci devices you could theoretically try to boot from) on black background and a prompt. Quit the prompt (Enter &quot;exit&quot;) and you should be taken to the UEFI bios, where you should select &quot;Boot manager&quot;, followed by the (emulated) scsi cd drive, that contains the windows disc image.</p><p>Also, I suggest compiling OVMF yourself (The &quot;bios_ovmf.bin&quot; in the above command is in fact a symlink to $HOME/src/edk2/Build/OvmfX64/DEBUG_GCC48/QEMU/bios.bin), I found the instructions fairly easy to follow:<br />First setup and do first build like this:<br /><a href="http://tianocore.sourceforge.net/wiki/Unix-like_systems#Common_instructions_for_UNIX-like_systems" rel="nofollow">http://tianocore.sourceforge.net/wiki/U … ke_systems</a><br />Afterwards build your real OVMF bios like this:<br /><a href="http://tianocore.sourceforge.net/wiki/How_to_build_OVMF" rel="nofollow">http://tianocore.sourceforge.net/wiki/How_to_build_OVMF</a></p><p>Lastly, if you use a consumer NVIDIA graphics card, the latest driver (imho) you should use is 340.52, because the 344.11 driver includes a new check whether or not &quot;hv_time&quot; is active and will make your card go to 800x600 with a &quot;Code 43&quot;. If you want to use the latest driver, you could also remove the &quot;hv_time&quot; from the qemu command, but according to the QEMU changelog (<a href="http://wiki.qemu.org/ChangeLog/2.0" rel="nofollow">http://wiki.qemu.org/ChangeLog/2.0</a>) this option can give you a significant performance boost for exactly the type of calculations game engines tend to make heavy use of. See <a href="https://forums.geforce.com/default/topic/775950/official-nvidia-344-11-whql-display-driver-feedback-thread-9-18-14-/?offset=200#4314345" rel="nofollow">https://forums.geforce.com/default/topi … 00#4314345</a> for more information on this issue.</p><p>Alright, I think that should cover everything you need to know when switching from the usual passthrough to OVMF.<br />I hope the above information helps you and/or anyone else trying OVMF out, I wrote this down as more of a memo on how I did it than a proper guide, so forgive any lack in quality (I intend to make a proper gist about this when I have the time).</p> <p class="postedit"><em>Last edited by Calrama (2014-10-14 19:34:16)</em></p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1465854">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1465859" class="blockpost roweven"> <h2><span><span class="conr">#2956</span> <a href="viewtopic.php?pid=1465859#p1465859">2014-10-14 19:23:00</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=85328">PureTryOut</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2014-09-23</span></dd> <dd><span>Posts: 63</span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <p>I&#039;ve been trying to get this too work for a few hours, but something is somehow going wrong and I don&#039;t understand how.</p><p>The problem is that it seems I can&#039;t use pci-stub.<br />When I add it to /etc/mkinitcpio.conf in the MODULES section it gives me</p><div class="codebox"><pre><code>==&gt; ERROR: Hook &#039;pci-stub&#039; cannot be found ==&gt; WARNING: errors were encountered during the build. The image may not be complete.</code></pre></div><p>The output of lspci -nn gives me</p><div class="codebox"><pre><code>02:00.0 VGA compatible controller [0300]: NVIDIA Corporation Device [10de:13c0] (rev a1) 02:00.1 Audio device [0403]: NVIDIA Corporation Device [10de:0fbb] (rev a1)</code></pre></div><p>So i&#039;ve added the following to my bootloader (Grub)</p><div class="codebox"><pre><code>pci-stub.ids=10de:13c0,10de:0fbb</code></pre></div><p>But after rebooting and running &quot;dmesg | grep pci-stub&quot; I only get the following output</p><div class="codebox"><pre><code>[ 0.000000] Command line: BOOT_IMAGE=/boot/vmlinuz-linux-mainline root=UUID=a0e2f143-41fc-4a4f-905d-6a12ac5b0237 rw quiet pci-stub.ids=10de:13c0,10de:0fbb [ 0.000000] Kernel command line: BOOT_IMAGE=/boot/vmlinuz-linux-mainline root=UUID=a0e2f143-41fc-4a4f-905d-6a12ac5b0237 rw quiet pci-stub.ids=10de:13c0,10de:0fbb</code></pre></div><p>So stub didn&#039;t actually claim my graphic card.</p><p>If I continue without stub it only gives me more errors later on.<br />I can&#039;t just disable my graphic card driver because both of my cards are NVIDIA.</p><p>Using the kernel provided in the first post (3.17 + acs override patch + i915 vga arbiter fixes) and a GTX 980 to passthrough combined with a i7 4790k with VT-d enabled.</p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1465859">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1465863" class="blockpost rowodd"> <h2><span><span class="conr">#2957</span> <a href="viewtopic.php?pid=1465863#p1465863">2014-10-14 19:33:11</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=70922">nbhs</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd class="postavatar"><img src="https://bbs.archlinux.org/img/avatars/70922.jpg?m=1367773811" width="80" height="80" alt="" /></dd> <dd><span>From: Montevideo, Uruguay</span></dd> <dd><span>Registered: 2013-05-02</span></dd> <dd><span>Posts: 402</span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>PureTryOut wrote:</cite><blockquote><div><p>I&#039;ve been trying to get this too work for a few hours, but something is somehow going wrong and I don&#039;t understand how.</p><p>The problem is that it seems I can&#039;t use pci-stub.<br />When I add it to /etc/mkinitcpio.conf in the MODULES section it gives me</p><div class="codebox"><pre><code>==&gt; ERROR: Hook &#039;pci-stub&#039; cannot be found ==&gt; WARNING: errors were encountered during the build. The image may not be complete.</code></pre></div></div></blockquote></div><div class="quotebox"><cite>nbhs wrote:</cite><blockquote><div><p>NOTE: If pci-stub was built as a module, you&#039;ll need to modify /etc/mkinitcpio.conf and add pci-stub in the MODULES section, after that you need to update your initramfs like this.</p></div></blockquote></div> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1465863">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1465876" class="blockpost roweven"> <h2><span><span class="conr">#2958</span> <a href="viewtopic.php?pid=1465876#p1465876">2014-10-14 19:50:19</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=85328">PureTryOut</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2014-09-23</span></dd> <dd><span>Posts: 63</span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <p>So no answer then? Like I said I added pci-stub to the MODULES section, but it just gave me the error that it could not find the pci-stub hook...</p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1465876">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1465879" class="blockpost rowodd"> <h2><span><span class="conr">#2959</span> <a href="viewtopic.php?pid=1465879#p1465879">2014-10-14 19:54:49</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=70922">nbhs</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd class="postavatar"><img src="https://bbs.archlinux.org/img/avatars/70922.jpg?m=1367773811" width="80" height="80" alt="" /></dd> <dd><span>From: Montevideo, Uruguay</span></dd> <dd><span>Registered: 2013-05-02</span></dd> <dd><span>Posts: 402</span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>PureTryOut wrote:</cite><blockquote><div><p>So no answer then? Like I said I added pci-stub to the MODULES section, but it just gave me the error that it could not find the pci-stub hook...</p></div></blockquote></div><p>Check the hooks section then, perhaps you&#039;re missing a &#039;&quot;&#039; or, delete /etc/mkinitpio.conf then reinstall it (pacman -S mkinitcpio) and try again</p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1465879">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1465891" class="blockpost roweven"> <h2><span><span class="conr">#2960</span> <a href="viewtopic.php?pid=1465891#p1465891">2014-10-14 20:19:02</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=85328">PureTryOut</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2014-09-23</span></dd> <dd><span>Posts: 63</span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <p>Thanks for your help, that actually worked!<br />I removed the file, and then reinstalled mkinitcpio, added it to modules, and this time it somehow worked.<br />No clue what went wrong.</p><p>Anyways now when I run the test</p><div class="codebox"><pre><code># qemu-system-x86_64 -enable-kvm -M q35 -m 1024 -cpu host \ -smp 6,sockets=1,cores=6,threads=1 \ -bios /usr/share/qemu/bios.bin -vga none \ -device ioh3420,bus=pcie.0,addr=1c.0,multifunction=on,port=1,chassis=1,id=root.1 \ -device vfio-pci,host=02:00.0,bus=root.1,addr=00.0,multifunction=on,x-vga=on \ -device vfio-pci,host=02:00.1,bus=root.1,addr=00.1</code></pre></div><p>it gives me the following errors:</p><div class="codebox"><pre><code>qemu-system-x86_64: -device vfio-pci,host=02:00.0,bus=root.1,addr=00.0,multifunction=on,x-vga=on: vfio: error no iommu_group for device qemu-system-x86_64: -device vfio-pci,host=02:00.0,bus=root.1,addr=00.0,multifunction=on,x-vga=on: Device initialization failed. qemu-system-x86_64: -device vfio-pci,host=02:00.0,bus=root.1,addr=00.0,multifunction=on,x-vga=on: Device &#039;vfio-pci&#039; could not be initialized</code></pre></div><p>Any clue what&#039;s happening?</p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1465891">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1465894" class="blockpost rowodd"> <h2><span><span class="conr">#2961</span> <a href="viewtopic.php?pid=1465894#p1465894">2014-10-14 20:26:57</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=70922">nbhs</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd class="postavatar"><img src="https://bbs.archlinux.org/img/avatars/70922.jpg?m=1367773811" width="80" height="80" alt="" /></dd> <dd><span>From: Montevideo, Uruguay</span></dd> <dd><span>Registered: 2013-05-02</span></dd> <dd><span>Posts: 402</span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>PureTryOut wrote:</cite><blockquote><div><p>Thanks for your help, that actually worked!<br />I removed the file, and then reinstalled mkinitcpio, added it to modules, and this time it somehow worked.<br />No clue what went wrong.</p><p>Anyways now when I run the test</p><div class="codebox"><pre><code># qemu-system-x86_64 -enable-kvm -M q35 -m 1024 -cpu host \ -smp 6,sockets=1,cores=6,threads=1 \ -bios /usr/share/qemu/bios.bin -vga none \ -device ioh3420,bus=pcie.0,addr=1c.0,multifunction=on,port=1,chassis=1,id=root.1 \ -device vfio-pci,host=02:00.0,bus=root.1,addr=00.0,multifunction=on,x-vga=on \ -device vfio-pci,host=02:00.1,bus=root.1,addr=00.1</code></pre></div><p>it gives me the following errors:</p><div class="codebox"><pre><code>qemu-system-x86_64: -device vfio-pci,host=02:00.0,bus=root.1,addr=00.0,multifunction=on,x-vga=on: vfio: error no iommu_group for device qemu-system-x86_64: -device vfio-pci,host=02:00.0,bus=root.1,addr=00.0,multifunction=on,x-vga=on: Device initialization failed. qemu-system-x86_64: -device vfio-pci,host=02:00.0,bus=root.1,addr=00.0,multifunction=on,x-vga=on: Device &#039;vfio-pci&#039; could not be initialized</code></pre></div><p>Any clue what&#039;s happening?</p></div></blockquote></div><p>Uhm yes, you need to bind your devices to vfio-pci, i suggest you re-read the guide, also if you are using an nvidia card on your host, you might need to patch it (though im using an nvidia card myself on the host, with <a href="https://aur.archlinux.org/packages/nvidia-dkms/" rel="nofollow">unpatched drivers</a>), also since your card is pretty new and it suports uefi, <a href="http://vfio.blogspot.com/" rel="nofollow">you might want to try OVMF</a></p> <p class="postedit"><em>Last edited by nbhs (2014-10-14 20:29:02)</em></p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1465894">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1465898" class="blockpost roweven"> <h2><span><span class="conr">#2962</span> <a href="viewtopic.php?pid=1465898#p1465898">2014-10-14 20:39:09</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=85328">PureTryOut</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2014-09-23</span></dd> <dd><span>Posts: 63</span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <p>Yeah I figured out I hadn&#039;t done that, my mistake, sorry.</p><p>Now I have bind my device to vfio-pci, but I get the following:</p><div class="codebox"><pre><code>qemu-system-x86_64: -device vfio-pci,host=02:00.0,bus=root.1,addr=00.0,multifunction=on,x-vga=on: vfio: error, group 1 is not viable, please ensure all devices within the iommu_group are bound to their vfio bus driver. qemu-system-x86_64: -device vfio-pci,host=02:00.0,bus=root.1,addr=00.0,multifunction=on,x-vga=on: vfio: failed to get group 1 qemu-system-x86_64: -device vfio-pci,host=02:00.0,bus=root.1,addr=00.0,multifunction=on,x-vga=on: Device initialization failed. qemu-system-x86_64: -device vfio-pci,host=02:00.0,bus=root.1,addr=00.0,multifunction=on,x-vga=on: Device &#039;vfio-pci&#039; could not be initialized</code></pre></div><p>I guess my main card (the one I use in the host, a GTX 770) is also in this group, which is of course not bound to the vfio bus driver.<br />Is this because I need to patch my driver?</p><p>Also, my system is using BIOS, not UEFI, or is this UEFI different? I rather not reinstall my pc to EUFI when I don&#039;t have too.</p><p><strong>EDIT:</strong> Installed nvidia-dkms, didn&#039;t help sadly, still the same error.</p> <p class="postedit"><em>Last edited by PureTryOut (2014-10-14 20:48:05)</em></p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1465898">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1465909" class="blockpost rowodd"> <h2><span><span class="conr">#2963</span> <a href="viewtopic.php?pid=1465909#p1465909">2014-10-14 21:11:36</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=70922">nbhs</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd class="postavatar"><img src="https://bbs.archlinux.org/img/avatars/70922.jpg?m=1367773811" width="80" height="80" alt="" /></dd> <dd><span>From: Montevideo, Uruguay</span></dd> <dd><span>Registered: 2013-05-02</span></dd> <dd><span>Posts: 402</span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>PureTryOut wrote:</cite><blockquote><div><p>Yeah I figured out I hadn&#039;t done that, my mistake, sorry.</p><p>Now I have bind my device to vfio-pci, but I get the following:</p><div class="codebox"><pre><code>qemu-system-x86_64: -device vfio-pci,host=02:00.0,bus=root.1,addr=00.0,multifunction=on,x-vga=on: vfio: error, group 1 is not viable, please ensure all devices within the iommu_group are bound to their vfio bus driver. qemu-system-x86_64: -device vfio-pci,host=02:00.0,bus=root.1,addr=00.0,multifunction=on,x-vga=on: vfio: failed to get group 1 qemu-system-x86_64: -device vfio-pci,host=02:00.0,bus=root.1,addr=00.0,multifunction=on,x-vga=on: Device initialization failed. qemu-system-x86_64: -device vfio-pci,host=02:00.0,bus=root.1,addr=00.0,multifunction=on,x-vga=on: Device &#039;vfio-pci&#039; could not be initialized</code></pre></div><p>I guess my main card (the one I use in the host, a GTX 770) is also in this group, which is of course not bound to the vfio bus driver.<br />Is this because I need to patch my driver?</p><p>Also, my system is using BIOS, not UEFI, or is this UEFI different? I rather not reinstall my pc to EUFI when I don&#039;t have too.</p><p><strong>EDIT:</strong> Installed nvidia-dkms, didn&#039;t help sadly, still the same error.</p></div></blockquote></div><p>That error means that you need to bind ALL the devices on that iommu group to vfio pci, also, you dont need to reinstall anything to use OVMF</p><div class="codebox"><pre><code>ls /sys/bus/pci/devices/0000\:02\:00.0/iommu_group/devices/</code></pre></div> <p class="postedit"><em>Last edited by nbhs (2014-10-14 21:15:26)</em></p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1465909">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1465917" class="blockpost roweven"> <h2><span><span class="conr">#2964</span> <a href="viewtopic.php?pid=1465917#p1465917">2014-10-14 21:28:46</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=85328">PureTryOut</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2014-09-23</span></dd> <dd><span>Posts: 63</span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <p>Well yes I understand that, and I would love to bind all of the devices in that group to vfio pci, but it&#039;s not possible.<br />The GPU I use as display in the host (a GTX 770) is also in that group:</p><div class="codebox"><pre><code>ls /sys/bus/pci/devices/0000\:02\:00.0/iommu_group/devices/ 0000:00:01.0 0000:01:00.0 0000:02:00.0 0000:00:01.1 0000:01:00.1 0000:02:00.1</code></pre></div><div class="codebox"><pre><code>lspci -nn 00:01.0 PCI bridge [0604]: Intel Corporation Xeon E3-1200 v3/4th Gen Core Processor PCI Express x16 Controller [8086:0c01] (rev 06) 00:01.1 PCI bridge [0604]: Intel Corporation Xeon E3-1200 v3/4th Gen Core Processor PCI Express x8 Controller [8086:0c05] (rev 06) 01:00.0 VGA compatible controller [0300]: NVIDIA Corporation GK104 [GeForce GTX 770] [10de:1184] (rev a1) 01:00.1 Audio device [0403]: NVIDIA Corporation GK104 HDMI Audio Controller [10de:0e0a] (rev a1) 02:00.0 VGA compatible controller [0300]: NVIDIA Corporation Device [10de:13c0] (rev a1) 02:00.1 Audio device [0403]: NVIDIA Corporation Device [10de:0fbb] (rev a1)</code></pre></div><p>When I bind it my screen just turns black and I can&#039;t do anything anymore without restarting my pc.</p><p>Anyways I will look into OVMF.</p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1465917">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1465928" class="blockpost rowodd"> <h2><span><span class="conr">#2965</span> <a href="viewtopic.php?pid=1465928#p1465928">2014-10-14 21:58:03</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=70922">nbhs</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd class="postavatar"><img src="https://bbs.archlinux.org/img/avatars/70922.jpg?m=1367773811" width="80" height="80" alt="" /></dd> <dd><span>From: Montevideo, Uruguay</span></dd> <dd><span>Registered: 2013-05-02</span></dd> <dd><span>Posts: 402</span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>PureTryOut wrote:</cite><blockquote><div><p>Well yes I understand that, and I would love to bind all of the devices in that group to vfio pci, but it&#039;s not possible.<br />The GPU I use as display in the host (a GTX 770) is also in that group:</p><div class="codebox"><pre><code>ls /sys/bus/pci/devices/0000\:02\:00.0/iommu_group/devices/ 0000:00:01.0 0000:01:00.0 0000:02:00.0 0000:00:01.1 0000:01:00.1 0000:02:00.1</code></pre></div><div class="codebox"><pre><code>lspci -nn 00:01.0 PCI bridge [0604]: Intel Corporation Xeon E3-1200 v3/4th Gen Core Processor PCI Express x16 Controller [8086:0c01] (rev 06) 00:01.1 PCI bridge [0604]: Intel Corporation Xeon E3-1200 v3/4th Gen Core Processor PCI Express x8 Controller [8086:0c05] (rev 06) 01:00.0 VGA compatible controller [0300]: NVIDIA Corporation GK104 [GeForce GTX 770] [10de:1184] (rev a1) 01:00.1 Audio device [0403]: NVIDIA Corporation GK104 HDMI Audio Controller [10de:0e0a] (rev a1) 02:00.0 VGA compatible controller [0300]: NVIDIA Corporation Device [10de:13c0] (rev a1) 02:00.1 Audio device [0403]: NVIDIA Corporation Device [10de:0fbb] (rev a1)</code></pre></div><p>When I bind it my screen just turns black and I can&#039;t do anything anymore without restarting my pc.</p><p>Anyways I will look into OVMF.</p></div></blockquote></div><p>That&#039;s what the acs override patch is for</p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1465928">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1465939" class="blockpost roweven"> <h2><span><span class="conr">#2966</span> <a href="viewtopic.php?pid=1465939#p1465939">2014-10-14 22:42:48</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=80387">dwe11er</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2014-03-18</span></dd> <dd><span>Posts: 73</span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <p>I&#039;d like to point out one thing:</p><p>If you&#039;re about to flash card without EFI GOP with BIOS (from similar card) that support EFI - don&#039;t do this (unless you&#039;re sure). You can pass BIOS with qemu adding &#039;romfile=...&#039; like this:</p><div class="codebox"><pre><code>-device vfio-pci,host=01:00.0,id=hostdev1,bus=pci.0,multifunction=on,addr=0x7,rombar=0,romfile=/var/lib/libvirt/firmware/HD7870_EFI.rom</code></pre></div> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1465939">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1466068" class="blockpost rowodd"> <h2><span><span class="conr">#2967</span> <a href="viewtopic.php?pid=1466068#p1466068">2014-10-15 11:36:44</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=84759">Ansa89</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2014-08-30</span></dd> <dd><span>Posts: 20</span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>aw wrote:</cite><blockquote><div><p>Oh dear, you&#039;ve gone to all this trouble to compile OVMF but haven&#039;t read this <a href="http://vfio.blogspot.com/2014/08/primary-graphics-assignment-without-vga.html" rel="nofollow">post</a> to determine why you&#039;d want it and how to use it?&#160; Have I missed something in describing the motivation and requirements there?&#160; OVMF isn&#039;t a &quot;test&quot;, it&#039;s an alternative to VGA.&#160; Since you&#039;re not getting any output from the monitor, it seems like you have an issue with VGA routing.&#160; Avoiding VGA by using OVMF is one method of dealing with this.</p></div></blockquote></div><p>Ok, now it&#039;s a bit more clear.</p><br /><div class="quotebox"><cite>aw wrote:</cite><blockquote><div><p>Regarding the parse error, how recently did you grab that copy of rom-parser?&#160; I fixed a similar issue in the code on the 4th.&#160; Otherwise please send me a copy of the ROM binary so I can fix the code for it.&#160; Since you already have the edk2 tree, there&#039;s also a parser there you can use, details in the comments <a href="http://vfio.blogspot.com/2014/08/does-my-graphics-card-rom-support-efi.html" rel="nofollow">here</a>.</p></div></blockquote></div><p>I used latest code from your master branch.<br />At what address should I send you the bios?</p><br /><div class="quotebox"><cite>aw wrote:</cite><blockquote><div><p>For the -bios option; you shouldn&#039;t ever need a -bios option.&#160; The default bios that comes with QEMU is fine for seabios use and for OVMF you&#039;d add an option like:</p><p>-drive if=pflash,format=raw,readonly,file=/path/to/OVMF.fd</p></div></blockquote></div><p>Ok, added that line and I can boot in a sort of efi shell, but can&#039;t see any kind of &quot;boot menu&quot; or something similar.<br />Consider that I&#039;m connecting through vnc so I could miss some initial boot screens.</p><br /><div class="quotebox"><cite>aw wrote:</cite><blockquote><div><p>Your previous posts indicate that you&#039;re using Windows 7, so please pay particular attention to the guest operating support for UEFI.&#160; You&#039;d need to upgrade your guest to Windows 8 for OVMF.</p></div></blockquote></div><p>Searching on the web, I found some guides about how booting/installing Windows 7 over UEFI. Can I follow such a tutorial or OVMF/VM is different?</p><br /><div class="quotebox"><cite>aw wrote:</cite><blockquote><div><p>If that&#039;s not any option, we&#039;ll need to go back to debugging your VGA routing issue and &#039;dmesg | grep -i vga&#039; might shed some light on what&#039;s wrong.&#160; Please also pastebin the entire dmesg log from the host.</p></div></blockquote></div><div class="codebox"><pre><code># dmesg | grep -i vga Command line: BOOT_IMAGE=/boot/vmlinuz-3.16.5 root=UUID=a4837900-ca63-43d4-bc2c-cf3f37cff7c6 ro i915.enable_hd_vgaarb=1 intel_iommu=on pci-stub.ids=10de:0fc6,10de:0e1b quiet Kernel command line: BOOT_IMAGE=/boot/vmlinuz-3.16.5 root=UUID=a4837900-ca63-43d4-bc2c-cf3f37cff7c6 ro i915.enable_hd_vgaarb=1 intel_iommu=on pci-stub.ids=10de:0fc6,10de:0e1b quiet Console: colour VGA+ 80x25 vgaarb: setting as boot device: PCI:0000:00:02.0 vgaarb: device added: PCI:0000:00:02.0,decodes=io+mem,owns=io+mem,locks=none vgaarb: device added: PCI:0000:01:00.0,decodes=io+mem,owns=none,locks=none vgaarb: loaded vgaarb: bridge control possible 0000:01:00.0 vgaarb: no bridge control possible 0000:00:02.0 [drm] Replacing VGA console driver vgaarb: device changed decodes: PCI:0000:00:02.0,olddecodes=io+mem,decodes=io:owns=io+mem</code></pre></div><br /><p>PS: sorry for the delay, but I got some trouble.</p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1466068">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1466107" class="blockpost roweven"> <h2><span><span class="conr">#2968</span> <a href="viewtopic.php?pid=1466107#p1466107">2014-10-15 12:53:24</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=85314">Duelist</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2014-09-22</span></dd> <dd><span>Posts: 358</span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <p><a href="https://bbs.archlinux.org/viewtopic.php?pid=1465127#p1465127" rel="nofollow">https://bbs.archlinux.org/viewtopic.php … 7#p1465127</a></p><p>Downgraded bios to the oldest version having IOMMU support - still getting page faults.<br />If i pass only one GPU without sound - windows 7 still fails to boot with BSOD 116.</p><p>I am using nvidia gpu as a host gpu, by the way.</p><p>Passing second(host:02:00.00) GPU doesn&#039;t show any video output, but there is still <br />AMD-Vi: Event logged [IO_PAGE_FAULT device=02:00.0 domain=0x0021 address=0x0000000122dde000 flags=0x0010]<br />errors.</p><p><strong>UPD:</strong> something wild and unknown happened - windows now may boot, but it&#039;ll do it with horrible memory corruption artifacts looking like horizontal stripes, and then BSOD. Cryptic messages in dmesg are gone...</p> <p class="postedit"><em>Last edited by Duelist (2014-10-15 16:33:13)</em></p> </div> <div class="postsignature postmsg"><hr /><p><span class="bbs">The forum rules prohibit requesting support for distributions other than arch.</span><br /><a href="https://bbs.archlinux.org/viewtopic.php?pid=1551460#p1551460" rel="nofollow">I gave up.</a><a href="https://bbs.archlinux.org/viewtopic.php?id=162768" rel="nofollow"> It was too late.</a><br /><a href="http://pastebin.com/B3fL84bq" rel="nofollow">What I was trying to do</a>.<br /><a href="http://vfio.blogspot.com/" rel="nofollow">The reference about VFIO and KVM VGA passthrough.</a></p></div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1466107">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1466140" class="blockpost rowodd"> <h2><span><span class="conr">#2969</span> <a href="viewtopic.php?pid=1466140#p1466140">2014-10-15 14:56:33</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=84760">Denso</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd class="postavatar"><img src="https://bbs.archlinux.org/img/avatars/84760.png?m=1412533733" width="71" height="80" alt="" /></dd> <dd><span>Registered: 2014-08-30</span></dd> <dd><span>Posts: 179</span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>Calrama wrote:</cite><blockquote><div><div class="quotebox"><cite>Denso wrote:</cite><blockquote><div><p>Hi everyone .</p><p>Can anyone who uses OVMF successfully post his entire qemu launch command ?</p><p>OVMF might be the answer to all my hangs issues on VMs&#039; reboots , but it still doesn&#039;t detect any of my drives .</p><p>I don&#039;t use libvirt , just plain shell scripts .</p><p>Much appreciated .</p></div></blockquote></div><div class="codebox"><pre><code>qemu-system-x86_64 \ -pflash /usr/share/qemu/bios_ovmf.bin \ -enable-kvm -cpu host,hv_time,kvm=off \ -smp cpus=4,cores=4,threads=1 \ -m 8GiB \ -name WinGamingOVMF,process=WinGamingOVMF \ -device vfio-pci,host=01:00.0,multifunction=on,x-vga=on \ -device vfio-pci,host=01:00.1 \ -daemonize \ -rtc base=localtime \ -soundhw hda \ -vga none \ -device virtio-scsi-pci,id=scsi \ -drive file=/dev/partitions/wingamingovmf,if=none,id=disk_primary,format=raw \ -device ide-hd,bus=ide.0,drive=disk_primary \ -drive file=/dev/partitions/games,if=none,id=disk_games,format=raw \ -device scsi-hd,bus=scsi.0,drive=disk_games \ -netdev bridge,br=br0,id=veth0 -device virtio-net-pci,netdev=veth0 -usb</code></pre></div><p>I&#039;m using this on Gentoo, not on Arch, but the above command should be the same. The relevant stuff is this:<br />Kernel: 3.16.3-gentoo (with all the patches in the OP of this thread, I will try 3.17 without any of these patches later, because iirc none of the patches should be necessary when using OVMF)<br />Architecture: x86_64<br />QEMU: GIT master on commit 2472b6c07bb50179019589af1c22f43935ab7f5c<br />EDK2 (OVMF): SVN trunk on revision 16195</p><br /><p>I know that you only asked for the command, but I&#039;d like to share some of my notes from my adventure about using OVMF (started last saturday because pretty much every other VM boot would make my host freeze and force me to power down my whole system the old-fashioned way, got it working sunday):</p><p>First, the <strong>graphics card</strong> you want to pass through absolutely <strong>must have either a hybrid, or uefi-only bios</strong>; if your graphics card has only<br />legacy bios (as my GTX 660 TI did), you need to flash it to hybrid / uefi-only, or OVMF won&#039;t do anything for you. If you do try<br />to use a legacy-bios graphics card with OVMF, your virtual machine will detect the passed-through graphics card (even by name in the device manager in case of Windows), but it will not be useable (any monitor you connect to the graphics card will not receive any signal from it / Windows will not detect any monitor connected to the graphics card).</p><p>Furthermore, if you want to use Windows (which I&#039;m going to assume), I think you need at least Windows 8 (I tested it only with Windows 8.1 and Windows 7, but Windows 8.1 and 8 extremely similar in nature, so I&#039;m going to assume that they behave the same in regards to this - please correct me on this if I am wrong), because when trying to boot the Windows 7 installation disk, after the usual &quot;Windows is loading files...&quot; the Windows 7 install freezes as soon as the Windows logo shows up.</p><p>Additionally, the newer Q35 architecture (option &quot;-M q35&quot;) does not seem to work well with Windows 8+. While I could install Windows 8.1 perfectly fine while having q35 enabled, after the installation - at first bootup - the &quot;Getting devices ready&quot; freezes at 15% (on multiple tries, every time). Even if the system is setup completely without q35 (or having it only enabled until first reboot, then shutoff the machine and disable it), enabling q35 will then consistently freeze the VM at the Windows logo.</p><p>When trying to install Windows 8+, I would suggest including the relevant disc images like this:</p><div class="codebox"><pre><code> -drive file=/path/to/${WINDOWS_IMAGE},id=iso_install,if=none \ -device scsi-cd,drive=iso_install \ -cdrom /path/to/virtio-win-0.1-81.iso`</code></pre></div><p>These two <em>should</em> ensure that OVMF recognizes the windows disc image as a UEFI boot option, while having the windows virtio drivers available at install time. I had some trouble with QEMU+OVMF not recognizing any non-virtio disc images as UEFI-bootage (they did not show up on the UEFI shell / at the boot manager). On that note: When trying to install, you will likely automatically enter the EFI shell initially instead of the VM booting from the only available EFI boot option (the windows disc image). The OVMF EFI shell should be a bunch of yellow text (listing all pci devices you could theoretically try to boot from) on black background and a prompt. Quit the prompt (Enter &quot;exit&quot;) and you should be taken to the UEFI bios, where you should select &quot;Boot manager&quot;, followed by the (emulated) scsi cd drive, that contains the windows disc image.</p><p>Also, I suggest compiling OVMF yourself (The &quot;bios_ovmf.bin&quot; in the above command is in fact a symlink to $HOME/src/edk2/Build/OvmfX64/DEBUG_GCC48/QEMU/bios.bin), I found the instructions fairly easy to follow:<br />First setup and do first build like this:<br /><a href="http://tianocore.sourceforge.net/wiki/Unix-like_systems#Common_instructions_for_UNIX-like_systems" rel="nofollow">http://tianocore.sourceforge.net/wiki/U … ke_systems</a><br />Afterwards build your real OVMF bios like this:<br /><a href="http://tianocore.sourceforge.net/wiki/How_to_build_OVMF" rel="nofollow">http://tianocore.sourceforge.net/wiki/How_to_build_OVMF</a></p><p>Lastly, if you use a consumer NVIDIA graphics card, the latest driver (imho) you should use is 340.52, because the 344.11 driver includes a new check whether or not &quot;hv_time&quot; is active and will make your card go to 800x600 with a &quot;Code 43&quot;. If you want to use the latest driver, you could also remove the &quot;hv_time&quot; from the qemu command, but according to the QEMU changelog (<a href="http://wiki.qemu.org/ChangeLog/2.0" rel="nofollow">http://wiki.qemu.org/ChangeLog/2.0</a>) this option can give you a significant performance boost for exactly the type of calculations game engines tend to make heavy use of. See <a href="https://forums.geforce.com/default/topic/775950/official-nvidia-344-11-whql-display-driver-feedback-thread-9-18-14-/?offset=200#4314345" rel="nofollow">https://forums.geforce.com/default/topi … 00#4314345</a> for more information on this issue.</p><p>Alright, I think that should cover everything you need to know when switching from the usual passthrough to OVMF.<br />I hope the above information helps you and/or anyone else trying OVMF out, I wrote this down as more of a memo on how I did it than a proper guide, so forgive any lack in quality (I intend to make a proper gist about this when I have the time).</p></div></blockquote></div><p>Wow .. Thank you very much for this detailed walkthrough , I&#039;m going to try ASAP and return with results !</p><p>Thank you for taking your time typing this detailed information !</p><p>EDIT !!!! :</p><p>YES ! It worked ! finally it detected my Windows 8.1 ISO ! The magic word is : SCSI .</p><p>It didn&#039;t detect regular IDE , but it detected SCSI .</p><p>Thank you Calrama !</p> <p class="postedit"><em>Last edited by Denso (2014-10-15 15:13:44)</em></p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1466140">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1466179" class="blockpost roweven"> <h2><span><span class="conr">#2970</span> <a href="viewtopic.php?pid=1466179#p1466179">2014-10-15 16:48:16</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=85328">PureTryOut</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2014-09-23</span></dd> <dd><span>Posts: 63</span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>nbhs wrote:</cite><blockquote><div><p>That&#039;s what the acs override patch is for</p></div></blockquote></div><p>Yes that is what I understand as well... I have installed your version of the kernel (3.17 + acs override patch + i915 vga arbiter fixes), but it still gives me the same error.</p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1466179">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1466180" class="blockpost rowodd"> <h2><span><span class="conr">#2971</span> <a href="viewtopic.php?pid=1466180#p1466180">2014-10-15 16:51:23</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=53258">Calrama</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>From: Berlin</span></dd> <dd><span>Registered: 2011-10-14</span></dd> <dd><span>Posts: 30</span></dd> <dd class="usercontacts"><span class="email"><a href="mailto:moritzmaxeiner@googlemail.com">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>Denso wrote:</cite><blockquote><div><div class="quotebox"><cite>Calrama wrote:</cite><blockquote><div><div class="quotebox"><cite>Denso wrote:</cite><blockquote><div><p>Hi everyone .</p><p>Can anyone who uses OVMF successfully post his entire qemu launch command ?</p><p>OVMF might be the answer to all my hangs issues on VMs&#039; reboots , but it still doesn&#039;t detect any of my drives .</p><p>I don&#039;t use libvirt , just plain shell scripts .</p><p>Much appreciated .</p></div></blockquote></div><div class="codebox"><pre><code>qemu-system-x86_64 \ -pflash /usr/share/qemu/bios_ovmf.bin \ -enable-kvm -cpu host,hv_time,kvm=off \ -smp cpus=4,cores=4,threads=1 \ -m 8GiB \ -name WinGamingOVMF,process=WinGamingOVMF \ -device vfio-pci,host=01:00.0,multifunction=on,x-vga=on \ -device vfio-pci,host=01:00.1 \ -daemonize \ -rtc base=localtime \ -soundhw hda \ -vga none \ -device virtio-scsi-pci,id=scsi \ -drive file=/dev/partitions/wingamingovmf,if=none,id=disk_primary,format=raw \ -device ide-hd,bus=ide.0,drive=disk_primary \ -drive file=/dev/partitions/games,if=none,id=disk_games,format=raw \ -device scsi-hd,bus=scsi.0,drive=disk_games \ -netdev bridge,br=br0,id=veth0 -device virtio-net-pci,netdev=veth0 -usb</code></pre></div><p>[...]</p></div></blockquote></div><p>Wow .. Thank you very much for this detailed walkthrough , I&#039;m going to try ASAP and return with results !</p><p>Thank you for taking your time typing this detailed information !</p><p>EDIT !!!! :</p><p>YES ! It worked ! finally it detected my Windows 8.1 ISO ! The magic word is : SCSI .</p><p>It didn&#039;t detect regular IDE , but it detected SCSI .</p><p>Thank you Calrama !</p></div></blockquote></div><p>That&#039;s good to hear and you&#039;re welcome.</p><p>Thanks for pointing out that SCSI is the key and not VIRTIO itself, I&#039;ll take that into consideration when writing the gist.</p><p>Have you experienced any host freezes / crashes with OVMF? I&#039;m just curious, because for me it has - so far - been the all-cure regarding that.<br />Since I started using OVMF I haven&#039;t had a single crash or host freeze and even better, OVMF seems to be a lot faster than the normal bios.<br />My Gaming VM takes only 15 seconds from the time I issue the qemu command until it&#039;s fully-booted onto the Windows desktop.</p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1466180">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1466209" class="blockpost roweven"> <h2><span><span class="conr">#2972</span> <a href="viewtopic.php?pid=1466209#p1466209">2014-10-15 17:51:18</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=84760">Denso</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd class="postavatar"><img src="https://bbs.archlinux.org/img/avatars/84760.png?m=1412533733" width="71" height="80" alt="" /></dd> <dd><span>Registered: 2014-08-30</span></dd> <dd><span>Posts: 179</span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>Calrama wrote:</cite><blockquote><div><div class="quotebox"><cite>Denso wrote:</cite><blockquote><div><div class="quotebox"><cite>Calrama wrote:</cite><blockquote><div><div class="codebox"><pre><code>qemu-system-x86_64 \ -pflash /usr/share/qemu/bios_ovmf.bin \ -enable-kvm -cpu host,hv_time,kvm=off \ -smp cpus=4,cores=4,threads=1 \ -m 8GiB \ -name WinGamingOVMF,process=WinGamingOVMF \ -device vfio-pci,host=01:00.0,multifunction=on,x-vga=on \ -device vfio-pci,host=01:00.1 \ -daemonize \ -rtc base=localtime \ -soundhw hda \ -vga none \ -device virtio-scsi-pci,id=scsi \ -drive file=/dev/partitions/wingamingovmf,if=none,id=disk_primary,format=raw \ -device ide-hd,bus=ide.0,drive=disk_primary \ -drive file=/dev/partitions/games,if=none,id=disk_games,format=raw \ -device scsi-hd,bus=scsi.0,drive=disk_games \ -netdev bridge,br=br0,id=veth0 -device virtio-net-pci,netdev=veth0 -usb</code></pre></div><p>[...]</p></div></blockquote></div><p>Wow .. Thank you very much for this detailed walkthrough , I&#039;m going to try ASAP and return with results !</p><p>Thank you for taking your time typing this detailed information !</p><p>EDIT !!!! :</p><p>YES ! It worked ! finally it detected my Windows 8.1 ISO ! The magic word is : SCSI .</p><p>It didn&#039;t detect regular IDE , but it detected SCSI .</p><p>Thank you Calrama !</p></div></blockquote></div><p>That&#039;s good to hear and you&#039;re welcome.</p><p>Thanks for pointing out that SCSI is the key and not VIRTIO itself, I&#039;ll take that into consideration when writing the gist.</p><p>Have you experienced any host freezes / crashes with OVMF? I&#039;m just curious, because for me it has - so far - been the all-cure regarding that.<br />Since I started using OVMF I haven&#039;t had a single crash or host freeze and even better, OVMF seems to be a lot faster than the normal bios.<br />My Gaming VM takes only 15 seconds from the time I issue the qemu command until it&#039;s fully-booted onto the Windows desktop.</p></div></blockquote></div><p>Hi <img src="https://bbs.archlinux.org/img/smilies/smile.png" width="15" height="15" alt="smile" /></p><p>I can confirm that NOW I can reboot VM without freezing the host ! I believe that is because OVMF is legacy-free (VGA-free) .</p><p>On a side note , OVMF initializes the machine faster than SeaBIOS does . (a couple seconds faster) . </p><p>I can&#039;t thank you enough (I&#039;m typing this reply from my new OVMF VM !) <img src="https://bbs.archlinux.org/img/smilies/wink.png" width="15" height="15" alt="wink" /></p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1466209">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1466215" class="blockpost rowodd"> <h2><span><span class="conr">#2973</span> <a href="viewtopic.php?pid=1466215#p1466215">2014-10-15 18:09:28</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=85175">evilsephiroth</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2014-09-16</span></dd> <dd><span>Posts: 14</span></dd> <dd class="usercontacts"><span class="email"><a href="mailto:evilsephiroth@gmail.com">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <p>so no one passing through intel gpu?</p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1466215">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1466222" class="blockpost roweven"> <h2><span><span class="conr">#2974</span> <a href="viewtopic.php?pid=1466222#p1466222">2014-10-15 18:21:09</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=85314">Duelist</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2014-09-22</span></dd> <dd><span>Posts: 358</span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <p><a href="http://awilliam.github.io/presentations/KVM-Forum-2014" rel="nofollow">http://awilliam.github.io/presentations/KVM-Forum-2014</a></p><p>Fresh aw&#039;s presentation works like sort of a FAQ for everybody. Now i know that i definitely need OVMF.</p> </div> <div class="postsignature postmsg"><hr /><p><span class="bbs">The forum rules prohibit requesting support for distributions other than arch.</span><br /><a href="https://bbs.archlinux.org/viewtopic.php?pid=1551460#p1551460" rel="nofollow">I gave up.</a><a href="https://bbs.archlinux.org/viewtopic.php?id=162768" rel="nofollow"> It was too late.</a><br /><a href="http://pastebin.com/B3fL84bq" rel="nofollow">What I was trying to do</a>.<br /><a href="http://vfio.blogspot.com/" rel="nofollow">The reference about VFIO and KVM VGA passthrough.</a></p></div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1466222">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1466225" class="blockpost rowodd"> <h2><span><span class="conr">#2975</span> <a href="viewtopic.php?pid=1466225#p1466225">2014-10-15 18:43:41</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=80387">dwe11er</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2014-03-18</span></dd> <dd><span>Posts: 73</span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>evilsephiroth wrote:</cite><blockquote><div><p>so no one passing through intel gpu?</p></div></blockquote></div><p>You need KvmGT (which isn&#039;t released for wide public yet) or XenGT.</p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1466225">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div class="postlinksb"> <div class="inbox crumbsplus"> <div class="pagepost"> <p class="pagelink conl"><span class="pages-label">Pages: </span><a rel="prev" class="item1" href="viewtopic.php?id=162768&amp;p=118">Previous</a> <a href="viewtopic.php?id=162768">1</a> <span class="spacer">…</span> <a href="viewtopic.php?id=162768&amp;p=117">117</a> <a href="viewtopic.php?id=162768&amp;p=118">118</a> <strong>119</strong> <a href="viewtopic.php?id=162768&amp;p=120">120</a> <a href="viewtopic.php?id=162768&amp;p=121">121</a> <span class="spacer">…</span> <a href="viewtopic.php?id=162768&amp;p=234">234</a> <a rel="next" href="viewtopic.php?id=162768&amp;p=120">Next</a></p> <p class="postlink conr">Topic closed</p> </div> <ul class="crumbs"> <li><a href="index.php">Index</a></li> <li><span>»&#160;</span><a href="viewforum.php?id=48">Topics Going Nowhere</a></li> <li><span>»&#160;</span><strong><a href="viewtopic.php?id=162768">KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</a></strong></li> </ul> <p class="subscribelink clearb"><a href="misc.php?action=subscribe&amp;tid=162768">Subscribe to this topic</a></p> <div class="clearer"></div> </div> </div> </div> <div id="brdfooter" class="block"> <h2><span>Board footer</span></h2> <div class="box"> <div id="brdfooternav" class="inbox"> <div class="conl"> <form id="qjump" method="get" action="viewforum.php"> <div><label><span>Jump to<br /></span> <select name="id" onchange="window.location=('viewforum.php?id='+this.options[this.selectedIndex].value)"> <optgroup label="Technical Issues and Assistance"> <option value="23">Newbie Corner</option> <option value="17">Installation</option> <option value="22">Kernel &amp; Hardware</option> <option value="18">Applications &amp; Desktop Environments</option> <option value="31">Laptop Issues</option> <option value="8">Networking, Server, and Protection</option> <option value="32">Multimedia and Games</option> <option value="50">System Administration</option> <option value="35">Other Architectures</option> </optgroup> <optgroup label="Arch-centric"> <option value="24">Announcements, Package &amp; Security Advisories</option> <option value="1">Arch Discussion</option> <option value="13">Forum &amp; Wiki discussion</option> </optgroup> <optgroup label="Pacman Upgrades, Packaging &amp; AUR"> <option value="44">Pacman &amp; Package Upgrade Issues</option> <option value="49">[testing] Repo Forum</option> <option value="4">Creating &amp; Modifying Packages</option> <option value="38">AUR Issues, Discussion &amp; PKGBUILD Requests</option> </optgroup> <optgroup label="Contributions &amp; Discussion"> <option value="20">GNU/Linux Discussion</option> <option value="27">Community Contributions</option> <option value="33">Programming &amp; Scripting</option> <option value="30">Other Languages</option> <option value="47">Artwork and Screenshots</option> <option value="42">Try This</option> </optgroup> <optgroup label="/dev/null"> <option value="29">Off-Topic</option> <option value="48" selected="selected">Topics Going Nowhere</option> <option value="36">Dustbin</option> </optgroup> </select></label> <input type="submit" value=" Go " accesskey="g" /> </div> </form> </div> <div class="conr"> <p id="feedlinks"><span class="atom"><a href="extern.php?action=feed&amp;tid=162768&amp;type=atom">Atom topic feed</a></span></p> <p id="poweredby">Powered by <a href="http://fluxbb.org/">FluxBB</a></p> </div> <div class="clearer"></div> </div> </div> </div> </div> <div class="end-box"></div> </div> </body> </html>
