<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"> <html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en" dir="ltr"> <head> <meta http-equiv="Content-Type" content="text/html; charset=utf-8" /> <title>KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9 (Page 38) / Topics Going Nowhere / Arch Linux Forums</title> <link rel="stylesheet" type="text/css" href="style/ArchLinux.css" /> <link rel="canonical" href="viewtopic.php?id=162768&amp;p=38" title="Page 38" /> <link rel="prev" href="viewtopic.php?id=162768&amp;p=37" title="Page 37" /> <link rel="next" href="viewtopic.php?id=162768&amp;p=39" title="Page 39" /> <link rel="alternate" type="application/atom+xml" href="extern.php?action=feed&amp;tid=162768&amp;type=atom" title="Atom topic feed" /> <link rel="stylesheet" media="screen" href="style/ArchLinux/arch.css?v=3" /> <link rel="stylesheet" media="screen" href="style/ArchLinux/archnavbar.css?v=2" /> <link rel="shortcut icon" href="style/ArchLinux/favicon.ico" /> </head> <body> <div id="archnavbar" class="anb-forum"> <div id="archnavbarlogo"><h1><a href="http://www.archlinux.org/">Arch Linux</a></h1></div> <div id="archnavbarmenu"> <ul id="archnavbarlist"> <li id="anb-home"><a href="http://www.archlinux.org/">Home</a></li><li id="anb-packages"><a href="http://www.archlinux.org/packages/">Packages</a></li><li id="anb-forums" class="anb-selected"><a href="https://bbs.archlinux.org/">Forums</a></li><li id="anb-wiki"><a href="https://wiki.archlinux.org/">Wiki</a></li><li id="anb-bugs"><a href="https://bugs.archlinux.org/">Bugs</a></li><li id="anb-aur"><a href="https://aur.archlinux.org/">AUR</a></li><li id="anb-download"><a href="http://www.archlinux.org/download/">Download</a></li> </ul> </div> </div> <div id="punviewtopic" class="pun"> <div class="top-box"></div> <div class="punwrap"> <div id="brdheader" class="block"> <div class="box"> <div id="brdmenu" class="inbox"> <ul> <li id="navindex" class="isactive"><a href="index.php">Index</a></li> <li id="navuserlist"><a href="userlist.php">User list</a></li> <li id="navsearch"><a href="search.php">Search</a></li> <li id="navprofile"><a href="profile.php?id=80749">Profile</a></li> <li id="navlogout"><a href="login.php?action=out&amp;id=80749&amp;csrf_token=5c20501ec397bb45ef8ee8c84db232c8d8e421c6">Logout</a></li> </ul> </div> <div id="brdwelcome" class="inbox"> <ul class="conl"> <li><span>Logged in as <strong>SXX</strong></span></li> <li><span>Last visit: 2015-08-16 12:20:09</span></li> </ul> <ul class="conr"> <li><span>Topics: <a href="search.php?action=show_replies" title="Find topics you have posted to.">Posted</a> | <a href="search.php?action=show_new" title="Find topics with new posts since your last visit.">New</a> | <a href="search.php?action=show_recent" title="Find topics with recent posts.">Active</a> | <a href="search.php?action=show_unanswered" title="Find topics with no replies.">Unanswered</a></span></li> </ul> <div class="clearer"></div> </div> </div> </div> <div id="brdmain"> <div class="linkst"> <div class="inbox crumbsplus"> <ul class="crumbs"> <li><a href="index.php">Index</a></li> <li><span>»&#160;</span><a href="viewforum.php?id=48">Topics Going Nowhere</a></li> <li><span>»&#160;</span><strong><a href="viewtopic.php?id=162768">KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</a></strong></li> </ul> <div class="pagepost"> <p class="pagelink conl"><span class="pages-label">Pages: </span><a rel="prev" class="item1" href="viewtopic.php?id=162768&amp;p=37">Previous</a> <a href="viewtopic.php?id=162768">1</a> <span class="spacer">…</span> <a href="viewtopic.php?id=162768&amp;p=36">36</a> <a href="viewtopic.php?id=162768&amp;p=37">37</a> <strong>38</strong> <a href="viewtopic.php?id=162768&amp;p=39">39</a> <a href="viewtopic.php?id=162768&amp;p=40">40</a> <span class="spacer">…</span> <a href="viewtopic.php?id=162768&amp;p=234">234</a> <a rel="next" href="viewtopic.php?id=162768&amp;p=39">Next</a></p> <p class="postlink conr">Topic closed</p> </div> <div class="clearer"></div> </div> </div> <div id="p1363780" class="blockpost rowodd blockpost1"> <h2><span><span class="conr">#926</span> <a href="viewtopic.php?pid=1363780#p1363780">2013-12-25 13:48:52</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=77556">peaquino</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2013-12-09</span></dd> <dd><span>Posts: 5</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=77556">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <p>Hi all!</p><p>I would like to report partial success with my APU setup (A85X, A10-5800K and 7870XT). With latest mainline kernel and qemu-git (from AUR, not the patched versions from first page) I was able to start Windows 8.1 with latest Catalyst and even play few minutes of Metro 2033. Unfortunatelly, the game is hanging up after a while (host stays responsive). It looks like it hangs during intense disk activity (ex. loading textures when entering new area). I tried booting the system with nohz=off and voluntary preemption, it doesn&#039;t seem to make any difference. Do you have any idea what else can I check?</p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1363780">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1363806" class="blockpost roweven"> <h2><span><span class="conr">#927</span> <a href="viewtopic.php?pid=1363806#p1363806">2013-12-25 16:24:14</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=77297">paradexes</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2013-11-30</span></dd> <dd><span>Posts: 13</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=77297">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>noobman wrote:</cite><blockquote><div><p>@techdude300: i have exactly same problem with memory, pls let me/us know if you find a fix/workaround;</p><p>@paradexes: i had same output, but i saw it works prefix sudo ...&#160; so looking into it <a href="https://www.kernel.org/doc/Documentation/vfio.txt" rel="nofollow">i found this</a> :</p><div class="quotebox"><blockquote><div><p>...The final step is to provide the user with access to the group if unprivileged operation is desired (note that /dev/vfio/vfio provides no capabilities on its own and is therefore expected to be set to mode 0666 by the system)...</p></div></blockquote></div><div class="codebox"><pre><code># chown user:user /dev/vfio/17</code></pre></div><p>Afterwards i think should work. This is like a default and needs a change, i would vote for this to be mentioned by OP because it was not obvious for me either.</p></div></blockquote></div><p>Thanks for the advice. It seems obvious however it still didnt work. I am running these commands as root. Im going in sudo -s instead of just running sudo + command as it gets tedious after hours of that. At any rate seeing as its being run as root and I am still getting this error Im trying to figure out what else it could be. Thanks for the help so far <img src="https://bbs.archlinux.org/img/smilies/big_smile.png" width="15" height="15" alt="big_smile" /></p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1363806">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1363855" class="blockpost rowodd"> <h2><span><span class="conr">#928</span> <a href="viewtopic.php?pid=1363855#p1363855">2013-12-25 19:10:45</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=75590">aw</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2013-10-04</span></dd> <dd><span>Posts: 921</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=75590">Email</a></span> <span class="website"><a href="http://vfio.blogspot.com/" rel="nofollow">Website</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>paradexes wrote:</cite><blockquote><div><p>This thread has been great. Thanks for the all the info so far. Also I have hardware now that does work and is supported for IOMMU. However now I am running into an issue when I run the qemu commands. Here is my commands and output:</p><div class="codebox"><pre><code>qemu-system-x86_64 -enable-kvm -M q35 -m 16024 -cpu host -smp 6,sockets=1,cores=6,threads=1 -bios /usr/share/qemu/bios.bin -vga none -device ioh3420,bus=pcie.0,addr=1c.0,multifunction=on,port=1,chassis=1,id=root.1 -device vfio-pci,host=03:00.0,bus=root.1,addr=00.0,multifunction=on,x-vga=on -device vfio-pci,host=03:00.1,bus=root.1,addr=00.1</code></pre></div><div class="codebox"><pre><code>qemu-system-x86_64: -device vfio-pci,host=03:00.0,bus=root.1,addr=00.0,multifunction=on,x-vga=on: vfio: error, group 17 is not viable, please ensure all devices within the iommu_group are bound to their vfio bus driver. qemu-system-x86_64: -device vfio-pci,host=03:00.0,bus=root.1,addr=00.0,multifunction=on,x-vga=on: vfio: failed to get group 17 qemu-system-x86_64: -device vfio-pci,host=03:00.0,bus=root.1,addr=00.0,multifunction=on,x-vga=on: Device initialization failed. qemu-system-x86_64: -device vfio-pci,host=03:00.0,bus=root.1,addr=00.0,multifunction=on,x-vga=on: Device &#039;vfio-pci&#039; could not be initialized</code></pre></div><p>What am I missing here? It seems like its almost there but I am sure I am issing something here. The error seems to indicate to put this in an iommu_group which I was under the impression I did. </p><p>Edit: Specs. Im running on an TYAN S8225 board. Running 32Gb of memory with 2x 4234 Opterons, OS: Linuxmint 16 with 3.12.6 kernel. I have an nvidia 660ti as the host card and my intended card is an AMD R9 270X.</p><p>Thanks</p></div></blockquote></div><p>The error message is trying really hard to tell you what the problem is: &quot;please ensure all devices within the iommu_group are bound to their vfio bus driver&quot;.&#160; So, run lsgroup, look at everything in group 17.&#160; If it&#039;s an endpoint it must be bound to vfio-pci (or pci-stub if you don&#039;t plan to assign it).&#160; If it&#039;s a root port, leave it alone.</p> </div> <div class="postsignature postmsg"><hr /><p><a href="http://vfio.blogspot.com" rel="nofollow">http://vfio.blogspot.com</a><br />Looking for a more open forum to discuss vfio related uses?&#160; Try <a href="https://www.redhat.com/mailman/listinfo/vfio-users" rel="nofollow">https://www.redhat.com/mailman/listinfo/vfio-users</a></p></div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1363855">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1363864" class="blockpost roweven"> <h2><span><span class="conr">#929</span> <a href="viewtopic.php?pid=1363864#p1363864">2013-12-25 20:04:32</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=77297">paradexes</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2013-11-30</span></dd> <dd><span>Posts: 13</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=77297">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>aw wrote:</cite><blockquote><div><div class="quotebox"><cite>paradexes wrote:</cite><blockquote><div><p>This thread has been great. Thanks for the all the info so far. Also I have hardware now that does work and is supported for IOMMU. However now I am running into an issue when I run the qemu commands. Here is my commands and output:</p><div class="codebox"><pre><code>qemu-system-x86_64 -enable-kvm -M q35 -m 16024 -cpu host -smp 6,sockets=1,cores=6,threads=1 -bios /usr/share/qemu/bios.bin -vga none -device ioh3420,bus=pcie.0,addr=1c.0,multifunction=on,port=1,chassis=1,id=root.1 -device vfio-pci,host=03:00.0,bus=root.1,addr=00.0,multifunction=on,x-vga=on -device vfio-pci,host=03:00.1,bus=root.1,addr=00.1</code></pre></div><div class="codebox"><pre><code>qemu-system-x86_64: -device vfio-pci,host=03:00.0,bus=root.1,addr=00.0,multifunction=on,x-vga=on: vfio: error, group 17 is not viable, please ensure all devices within the iommu_group are bound to their vfio bus driver. qemu-system-x86_64: -device vfio-pci,host=03:00.0,bus=root.1,addr=00.0,multifunction=on,x-vga=on: vfio: failed to get group 17 qemu-system-x86_64: -device vfio-pci,host=03:00.0,bus=root.1,addr=00.0,multifunction=on,x-vga=on: Device initialization failed. qemu-system-x86_64: -device vfio-pci,host=03:00.0,bus=root.1,addr=00.0,multifunction=on,x-vga=on: Device &#039;vfio-pci&#039; could not be initialized</code></pre></div><p>What am I missing here? It seems like its almost there but I am sure I am issing something here. The error seems to indicate to put this in an iommu_group which I was under the impression I did. </p><p>Edit: Specs. Im running on an TYAN S8225 board. Running 32Gb of memory with 2x 4234 Opterons, OS: Linuxmint 16 with 3.12.6 kernel. I have an nvidia 660ti as the host card and my intended card is an AMD R9 270X.</p><p>Thanks</p></div></blockquote></div><p>The error message is trying really hard to tell you what the problem is: &quot;please ensure all devices within the iommu_group are bound to their vfio bus driver&quot;.&#160; So, run lsgroup, look at everything in group 17.&#160; If it&#039;s an endpoint it must be bound to vfio-pci (or pci-stub if you don&#039;t plan to assign it).&#160; If it&#039;s a root port, leave it alone.</p></div></blockquote></div><p>aw thanks for the input. This device is an AMD R9 270X. The host card is an nvidia 660ti. The output appears to be correct. Forgive the n00bness in the question but how do I know if its a root port vs not? right now the card is coming up with the usual lspci and grep commands as 0000:03:00.0 and 0000:03:00.1 (hdmi part) They appear to be bound correctly using the vfio-pci script in the OP. This seems like the last piece of the puzzle. I suppose a step by step on what would be needed to fix this error? I have done some reading but nothing is really clearing this part up here. Thanks.</p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1363864">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1363866" class="blockpost rowodd"> <h2><span><span class="conr">#930</span> <a href="viewtopic.php?pid=1363866#p1363866">2013-12-25 20:28:03</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=75590">aw</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2013-10-04</span></dd> <dd><span>Posts: 921</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=75590">Email</a></span> <span class="website"><a href="http://vfio.blogspot.com/" rel="nofollow">Website</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>paradexes wrote:</cite><blockquote><div><div class="quotebox"><cite>aw wrote:</cite><blockquote><div><p>The error message is trying really hard to tell you what the problem is: &quot;please ensure all devices within the iommu_group are bound to their vfio bus driver&quot;.&#160; So, run lsgroup, look at everything in group 17.&#160; If it&#039;s an endpoint it must be bound to vfio-pci (or pci-stub if you don&#039;t plan to assign it).&#160; If it&#039;s a root port, leave it alone.</p></div></blockquote></div><p>aw thanks for the input. This device is an AMD R9 270X. The host card is an nvidia 660ti. The output appears to be correct. Forgive the n00bness in the question but how do I know if its a root port vs not? right now the card is coming up with the usual lspci and grep commands as 0000:03:00.0 and 0000:03:00.1 (hdmi part) They appear to be bound correctly using the vfio-pci script in the OP. This seems like the last piece of the puzzle. I suppose a step by step on what would be needed to fix this error? I have done some reading but nothing is really clearing this part up here. Thanks.</p></div></blockquote></div><p>lsgroup will give you the lspci description of the device, you can interrogate further with lspci -vvv -s &lt;pci device&gt;, or just paste the lsgroup output for the group and we can tell you.&#160; Chances are that there are more devices in the group than just the GPU and audio device if you&#039;re getting this error.&#160; You can also use &#039;find /sys/kernel/iommu_groups&#039; to understand the grouping if you don&#039;t have lsgroup (it&#039;s pasted somewhere in this forum thread).&#160; If you want to change the grouping beyond what the hardware tells us is safe, you can use the ACS override patch to supply boot options to do this, but note the risks I mentioned a page or two back about using this.&#160; I hope to be able to release a patch that will make this unnecessary for a bunch of Intel root ports soon.</p> </div> <div class="postsignature postmsg"><hr /><p><a href="http://vfio.blogspot.com" rel="nofollow">http://vfio.blogspot.com</a><br />Looking for a more open forum to discuss vfio related uses?&#160; Try <a href="https://www.redhat.com/mailman/listinfo/vfio-users" rel="nofollow">https://www.redhat.com/mailman/listinfo/vfio-users</a></p></div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1363866">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1363868" class="blockpost roweven"> <h2><span><span class="conr">#931</span> <a href="viewtopic.php?pid=1363868#p1363868">2013-12-25 20:42:36</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=76834">Val532</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2013-11-13</span></dd> <dd><span>Posts: 35</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=76834">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>aw wrote:</cite><blockquote><div><p>I hope to be able to release a patch that will make this unnecessary for a bunch of Intel root ports soon.</p></div></blockquote></div><p>So you work on new proper patch for ACS on Intel ??? Or it&#039;s just a wish ?</p><br /><p>And is someone has managed to use a Sata card with vfio ?</p><p>I have two AsMedia 1062 (2*sata3) and it does not work correctly.</p><p>Thanks</p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1363868">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1363877" class="blockpost rowodd"> <h2><span><span class="conr">#932</span> <a href="viewtopic.php?pid=1363877#p1363877">2013-12-25 21:32:39</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=77297">paradexes</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2013-11-30</span></dd> <dd><span>Posts: 13</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=77297">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>aw wrote:</cite><blockquote><div><div class="quotebox"><cite>paradexes wrote:</cite><blockquote><div><div class="quotebox"><cite>aw wrote:</cite><blockquote><div><p>The error message is trying really hard to tell you what the problem is: &quot;please ensure all devices within the iommu_group are bound to their vfio bus driver&quot;.&#160; So, run lsgroup, look at everything in group 17.&#160; If it&#039;s an endpoint it must be bound to vfio-pci (or pci-stub if you don&#039;t plan to assign it).&#160; If it&#039;s a root port, leave it alone.</p></div></blockquote></div><p>aw thanks for the input. This device is an AMD R9 270X. The host card is an nvidia 660ti. The output appears to be correct. Forgive the n00bness in the question but how do I know if its a root port vs not? right now the card is coming up with the usual lspci and grep commands as 0000:03:00.0 and 0000:03:00.1 (hdmi part) They appear to be bound correctly using the vfio-pci script in the OP. This seems like the last piece of the puzzle. I suppose a step by step on what would be needed to fix this error? I have done some reading but nothing is really clearing this part up here. Thanks.</p></div></blockquote></div><p>lsgroup will give you the lspci description of the device, you can interrogate further with lspci -vvv -s &lt;pci device&gt;, or just paste the lsgroup output for the group and we can tell you.&#160; Chances are that there are more devices in the group than just the GPU and audio device if you&#039;re getting this error.&#160; You can also use &#039;find /sys/kernel/iommu_groups&#039; to understand the grouping if you don&#039;t have lsgroup (it&#039;s pasted somewhere in this forum thread).&#160; If you want to change the grouping beyond what the hardware tells us is safe, you can use the ACS override patch to supply boot options to do this, but note the risks I mentioned a page or two back about using this.&#160; I hope to be able to release a patch that will make this unnecessary for a bunch of Intel root ports soon.</p></div></blockquote></div><br /><p>Ok here is the output I have from the lsgroup script. (applicable to group 17 since thats where I am having the issue. also below is the output to the lspci and find commands you specified thanks again.</p><div class="codebox"><pre class="vscroll"><code>~#sh lsgroup.sh ### Group 17 ### 03:00.0 VGA compatible controller: Advanced Micro Devices, Inc. [AMD/ATI] Curacao XT [Radeon R9 270X] 03:00.1 Audio device: Advanced Micro Devices, Inc. [AMD/ATI] Cape Verde/Pitcairn HDMI Audio [Radeon HD 7700/7800 Series] ~#find /sys/kernel/iommu_groups/ /sys/kernel/iommu_groups/17 /sys/kernel/iommu_groups/17/devices /sys/kernel/iommu_groups/17/devices/0000:03:00.0 /sys/kernel/iommu_groups/17/devices/0000:03:00.1 ~ # lspci -vvv -s 0000:03:00.0 03:00.0 VGA compatible controller: Advanced Micro Devices, Inc. [AMD/ATI] Curacao XT [Radeon R9 270X] (prog-if 00 [VGA controller]) Subsystem: Gigabyte Technology Co., Ltd Device 2272 Control: I/O+ Mem+ BusMaster- SpecCycle- MemWINV- VGASnoop- ParErr- Stepping- SERR- FastB2B- DisINTx- Status: Cap+ 66MHz- UDF- FastB2B- ParErr- DEVSEL=fast &gt;TAbort- &lt;TAbort- &lt;MAbort- &gt;SERR- &lt;PERR- INTx- Interrupt: pin A routed to IRQ 32 Region 0: Memory at c0000000 (64-bit, prefetchable) [size=256M] Region 2: Memory at fcc80000 (64-bit, non-prefetchable) [size=256K] Region 4: I/O ports at b000 [size=256] Expansion ROM at fcc60000 [disabled] [size=128K] Capabilities: [48] Vendor Specific Information: Len=08 &lt;?&gt; Capabilities: [50] Power Management version 3 Flags: PMEClk- DSI- D1+ D2+ AuxCurrent=0mA PME(D0-,D1+,D2+,D3hot+,D3cold-) Status: D0 NoSoftRst- PME-Enable- DSel=0 DScale=0 PME- Capabilities: [58] Express (v2) Legacy Endpoint, MSI 00 DevCap: MaxPayload 256 bytes, PhantFunc 0, Latency L0s &lt;4us, L1 unlimited ExtTag+ AttnBtn- AttnInd- PwrInd- RBE+ FLReset- DevCtl: Report errors: Correctable- Non-Fatal- Fatal- Unsupported- RlxdOrd+ ExtTag- PhantFunc- AuxPwr- NoSnoop+ MaxPayload 128 bytes, MaxReadReq 512 bytes DevSta: CorrErr- UncorrErr- FatalErr- UnsuppReq- AuxPwr- TransPend- LnkCap: Port #0, Speed 8GT/s, Width x16, ASPM L0s L1, Latency L0 &lt;64ns, L1 &lt;1us ClockPM- Surprise- LLActRep- BwNot- LnkCtl: ASPM Disabled; RCB 64 bytes Disabled- Retrain- CommClk+ ExtSynch- ClockPM- AutWidDis- BWInt- AutBWInt- LnkSta: Speed 5GT/s, Width x16, TrErr- Train- SlotClk+ DLActive- BWMgmt- ABWMgmt- DevCap2: Completion Timeout: Not Supported, TimeoutDis- DevCtl2: Completion Timeout: 50us to 50ms, TimeoutDis- LnkCtl2: Target Link Speed: 8GT/s, EnterCompliance- SpeedDis-, Selectable De-emphasis: -6dB Transmit Margin: Normal Operating Range, EnterModifiedCompliance- ComplianceSOS- Compliance De-emphasis: -6dB LnkSta2: Current De-emphasis Level: -3.5dB, EqualizationComplete-, EqualizationPhase1- EqualizationPhase2-, EqualizationPhase3-, LinkEqualizationRequest- Capabilities: [a0] MSI: Enable- Count=1/1 Maskable- 64bit+ Address: 0000000000000000 Data: 0000 Capabilities: [100 v1] Vendor Specific Information: ID=0001 Rev=1 Len=010 &lt;?&gt; Capabilities: [150 v2] Advanced Error Reporting UESta: DLP- SDES- TLP- FCP- CmpltTO- CmpltAbrt- UnxCmplt- RxOF- MalfTLP- ECRC- UnsupReq- ACSViol- UEMsk: DLP- SDES- TLP- FCP- CmpltTO- CmpltAbrt- UnxCmplt- RxOF- MalfTLP- ECRC- UnsupReq- ACSViol- UESvrt: DLP+ SDES+ TLP- FCP+ CmpltTO- CmpltAbrt- UnxCmplt- RxOF+ MalfTLP+ ECRC- UnsupReq- ACSViol- CESta: RxErr- BadTLP- BadDLLP- Rollover- Timeout- NonFatalErr+ CEMsk: RxErr- BadTLP- BadDLLP- Rollover- Timeout- NonFatalErr+ AERCap: First Error Pointer: 00, GenCap+ CGenEn- ChkCap+ ChkEn- Capabilities: [270 v1] #19 Capabilities: [2b0 v1] Address Translation Service (ATS) ATSCap: Invalidate Queue Depth: 00 ATSCtl: Enable-, Smallest Translation Unit: 00 Capabilities: [2c0 v1] #13 Capabilities: [2d0 v1] #1b Kernel driver in use: vfio-pci ~ # lspci -vvv -s 0000:03:00.1 03:00.1 Audio device: Advanced Micro Devices, Inc. [AMD/ATI] Cape Verde/Pitcairn HDMI Audio [Radeon HD 7700/7800 Series] Subsystem: Gigabyte Technology Co., Ltd Device aab0 Control: I/O+ Mem+ BusMaster+ SpecCycle- MemWINV- VGASnoop- ParErr- Stepping- SERR+ FastB2B- DisINTx+ Status: Cap+ 66MHz- UDF- FastB2B- ParErr- DEVSEL=fast &gt;TAbort- &lt;TAbort- &lt;MAbort- &gt;SERR- &lt;PERR- INTx- Latency: 0, Cache Line Size: 64 bytes Interrupt: pin B routed to IRQ 124 Region 0: Memory at fccfc000 (64-bit, non-prefetchable) [size=16K] Capabilities: [48] Vendor Specific Information: Len=08 &lt;?&gt; Capabilities: [50] Power Management version 3 Flags: PMEClk- DSI- D1+ D2+ AuxCurrent=0mA PME(D0-,D1-,D2-,D3hot-,D3cold-) Status: D0 NoSoftRst- PME-Enable- DSel=0 DScale=0 PME- Capabilities: [58] Express (v2) Legacy Endpoint, MSI 00 DevCap: MaxPayload 256 bytes, PhantFunc 0, Latency L0s &lt;4us, L1 unlimited ExtTag+ AttnBtn- AttnInd- PwrInd- RBE+ FLReset- DevCtl: Report errors: Correctable- Non-Fatal- Fatal- Unsupported- RlxdOrd+ ExtTag- PhantFunc- AuxPwr- NoSnoop+ MaxPayload 128 bytes, MaxReadReq 512 bytes DevSta: CorrErr- UncorrErr- FatalErr- UnsuppReq- AuxPwr- TransPend- LnkCap: Port #0, Speed 8GT/s, Width x16, ASPM L0s L1, Latency L0 &lt;64ns, L1 &lt;1us ClockPM- Surprise- LLActRep- BwNot- LnkCtl: ASPM Disabled; RCB 64 bytes Disabled- Retrain- CommClk+ ExtSynch- ClockPM- AutWidDis- BWInt- AutBWInt- LnkSta: Speed 5GT/s, Width x16, TrErr- Train- SlotClk+ DLActive- BWMgmt- ABWMgmt- DevCap2: Completion Timeout: Not Supported, TimeoutDis- DevCtl2: Completion Timeout: 50us to 50ms, TimeoutDis- LnkCtl2: Target Link Speed: 2.5GT/s, EnterCompliance- SpeedDis-, Selectable De-emphasis: -6dB Transmit Margin: Normal Operating Range, EnterModifiedCompliance- ComplianceSOS- Compliance De-emphasis: -6dB LnkSta2: Current De-emphasis Level: -3.5dB, EqualizationComplete-, EqualizationPhase1- EqualizationPhase2-, EqualizationPhase3-, LinkEqualizationRequest- Capabilities: [a0] MSI: Enable+ Count=1/1 Maskable- 64bit+ Address: 00000000fee00000 Data: 0000 Capabilities: [100 v1] Vendor Specific Information: ID=0001 Rev=1 Len=010 &lt;?&gt; Capabilities: [150 v2] Advanced Error Reporting UESta: DLP- SDES- TLP- FCP- CmpltTO- CmpltAbrt- UnxCmplt- RxOF- MalfTLP- ECRC- UnsupReq- ACSViol- UEMsk: DLP- SDES- TLP- FCP- CmpltTO- CmpltAbrt- UnxCmplt- RxOF- MalfTLP- ECRC- UnsupReq- ACSViol- UESvrt: DLP+ SDES+ TLP- FCP+ CmpltTO- CmpltAbrt- UnxCmplt- RxOF+ MalfTLP+ ECRC- UnsupReq- ACSViol- CESta: RxErr- BadTLP- BadDLLP- Rollover- Timeout- NonFatalErr+ CEMsk: RxErr- BadTLP- BadDLLP- Rollover- Timeout- NonFatalErr+ AERCap: First Error Pointer: 00, GenCap+ CGenEn- ChkCap+ ChkEn- Kernel driver in use: snd_hda_intel</code></pre></div><p>I think from what I am seeing its actually the HDMI 03.00.1 that is actually causing my problem? I presume it would need to have had the same vfio-pci driver as well. That seems tobe the one thing that stood out to me on this. That said I have already done what I needed in order to pass that as well as the card itself. Anything I did to the 03.00.0 I also did to 03.00.1 as well.</p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1363877">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1363906" class="blockpost roweven"> <h2><span><span class="conr">#933</span> <a href="viewtopic.php?pid=1363906#p1363906">2013-12-25 23:34:47</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=75590">aw</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2013-10-04</span></dd> <dd><span>Posts: 921</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=75590">Email</a></span> <span class="website"><a href="http://vfio.blogspot.com/" rel="nofollow">Website</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>paradexes wrote:</cite><blockquote><div><p>Ok here is the output I have from the lsgroup script. (applicable to group 17 since thats where I am having the issue. also below is the output to the lspci and find commands you specified thanks again.</p><div class="codebox"><pre><code>~#sh lsgroup.sh ### Group 17 ### 03:00.0 VGA compatible controller: Advanced Micro Devices, Inc. [AMD/ATI] Curacao XT [Radeon R9 270X] 03:00.1 Audio device: Advanced Micro Devices, Inc. [AMD/ATI] Cape Verde/Pitcairn HDMI Audio [Radeon HD 7700/7800 Series] ~ # lspci -vvv -s 0000:03:00.0 03:00.0 VGA compatible controller: Advanced Micro Devices, Inc. [AMD/ATI] Curacao XT [Radeon R9 270X] (prog-if 00 [VGA controller]) Kernel driver in use: vfio-pci ~ # lspci -vvv -s 0000:03:00.1 03:00.1 Audio device: Advanced Micro Devices, Inc. [AMD/ATI] Cape Verde/Pitcairn HDMI Audio [Radeon HD 7700/7800 Series] Kernel driver in use: snd_hda_intel</code></pre></div><p>I think from what I am seeing its actually the HDMI 03.00.1 that is actually causing my problem? I presume it would need to have had the same vfio-pci driver as well. That seems tobe the one thing that stood out to me on this. That said I have already done what I needed in order to pass that as well as the card itself. Anything I did to the 03.00.0 I also did to 03.00.1 as well.</p></div></blockquote></div><p>Yes, you can see from lspci that 3:00.1 is bound to snd_hda_intel, not vfio_pci.&#160; Check your setup procedure.</p> </div> <div class="postsignature postmsg"><hr /><p><a href="http://vfio.blogspot.com" rel="nofollow">http://vfio.blogspot.com</a><br />Looking for a more open forum to discuss vfio related uses?&#160; Try <a href="https://www.redhat.com/mailman/listinfo/vfio-users" rel="nofollow">https://www.redhat.com/mailman/listinfo/vfio-users</a></p></div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1363906">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1363946" class="blockpost rowodd"> <h2><span><span class="conr">#934</span> <a href="viewtopic.php?pid=1363946#p1363946">2013-12-26 06:01:31</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=77762">firewing1</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2013-12-17</span></dd> <dd><span>Posts: 9</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=77762">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <p>For those of us experiencing the memory allocation bug (guest VM memory is not freed after shutdown), are you passing through USB devices from the host? I just noticed that I encountered the memory issue only after attempting to add a USB mouse attached to the host to my VM,</p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1363946">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1363955" class="blockpost roweven"> <h2><span><span class="conr">#935</span> <a href="viewtopic.php?pid=1363955#p1363955">2013-12-26 08:20:42</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=77819">tuoni</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2013-12-19</span></dd> <dd><span>Posts: 7</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=77819">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>firewing1 wrote:</cite><blockquote><div><p>For those of us experiencing the memory allocation bug (guest VM memory is not freed after shutdown), are you passing through USB devices from the host? I just noticed that I encountered the memory issue only after attempting to add a USB mouse attached to the host to my VM,</p></div></blockquote></div><p>Nope, I&#039;ve got the memory allocation bug, but the only thing I&#039;m passing through is the VGA card.&#160; This is my invocation:</p><div class="codebox"><pre><code>sudo QEMU_AUDIO_DRV=alsa \ QEMU_AUDIO_TIMER_PERIOD=0 \ qemu-system-x86_64 -enable-kvm -M q35 -m 3072 -cpu host \ -smp 6,sockets=1,cores=6,threads=1 \ -monitor stdio -bios /usr/share/qemu/bios.bin -vga none \ -device ahci,bus=pcie.0,id=ahci \ -drive file=/home/tuoni/kvm/win7.img,id=disk,format=raw -device ide-hd,bus=ahci.0,drive=disk \ -device ioh3420,bus=pcie.0,addr=1c.0,multifunction=on,port=1,chassis=1,id=root.1 \ -device vfio-pci,host=01:00.0,bus=root.1,addr=00.0,multifunction=on,x-vga=on \ -device vfio-pci,host=01:00.1,bus=root.1,addr=00.1 \ -soundhw hda,ac97</code></pre></div><p>I&#039;m pretty sure some of those switches are sub-optimal, but I&#039;m just sticking with the first thing I got working <img src="https://bbs.archlinux.org/img/smilies/smile.png" width="15" height="15" alt="smile" /></p><p>EDIT: One thing I have noticed is there has been a marked decrease in my host (i915) graphics performance since using mainline-rc3 + i915 patch.&#160; I&#039;m presuming it&#039;s the kernel rather than the patch...?</p> <p class="postedit"><em>Last edited by tuoni (2013-12-26 08:29:08)</em></p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1363955">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1363965" class="blockpost rowodd"> <h2><span><span class="conr">#936</span> <a href="viewtopic.php?pid=1363965#p1363965">2013-12-26 10:21:21</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=77960">xani</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2013-12-24</span></dd> <dd><span>Posts: 6</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=77960">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>Val532 wrote:</cite><blockquote><div><p>And is someone has managed to use a Sata card with vfio ?</p><p>I have two AsMedia 1062 (2*sata3) and it does not work correctly.</p></div></blockquote></div><p>I don&#039;t have any problems with this controller. </p><div class="codebox"><pre><code>05:00.0 SATA controller: ASMedia Technology Inc. ASM1062 Serial ATA Controller (rev 01) (prog-if 01 [AHCI 1.0])</code></pre></div><p>I am passing it like this </p><div class="codebox"><pre><code>-device vfio-pci,host=05:00.0,bus=pcie.0</code></pre></div><p>Windows 7 is recognising it without any hassle.</p><div class="quotebox"><cite>firewing1 wrote:</cite><blockquote><div><p>For those of us experiencing the memory allocation bug (guest VM memory is not freed after shutdown), are you passing through USB devices from the host? I just noticed that I encountered the memory issue only after attempting to add a USB mouse attached to the host to my VM,</p></div></blockquote></div><p>For me it doesn&#039;t matter if I&#039;m using usb passthrough or not. It happens when using pci-assing or vfio-pci. Did you try my kernel package? Here&#039;s <a href="http://www.fileswap.com/dl/n6NTVldSHX/" rel="nofollow">new</a> one. It includes acs override and i915 arbiter fix patches.</p><div class="quotebox"><cite>tuoni wrote:</cite><blockquote><div><p>Nope, I&#039;ve got the memory allocation bug, but the only thing I&#039;m passing through is the VGA card.</p></div></blockquote></div><p> @tuoni you can test if my package helps on mem leaks too.</p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1363965">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1364016" class="blockpost roweven"> <h2><span><span class="conr">#937</span> <a href="viewtopic.php?pid=1364016#p1364016">2013-12-26 14:26:08</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=70922">nbhs</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd class="postavatar"><img src="https://bbs.archlinux.org/img/avatars/70922.jpg?m=1367773811" width="80" height="80" alt="" /></dd> <dd><span>From: Montevideo, Uruguay</span></dd> <dd><span>Registered: 2013-05-02</span></dd> <dd><span>Posts: 402</span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>xani wrote:</cite><blockquote><div><div class="quotebox"><cite>Val532 wrote:</cite><blockquote><div><p>And is someone has managed to use a Sata card with vfio ?</p><p>I have two AsMedia 1062 (2*sata3) and it does not work correctly.</p></div></blockquote></div><p>I don&#039;t have any problems with this controller. </p><div class="codebox"><pre><code>05:00.0 SATA controller: ASMedia Technology Inc. ASM1062 Serial ATA Controller (rev 01) (prog-if 01 [AHCI 1.0])</code></pre></div><p>I am passing it like this </p><div class="codebox"><pre><code>-device vfio-pci,host=05:00.0,bus=pcie.0</code></pre></div><p>Windows 7 is recognising it without any hassle.</p><div class="quotebox"><cite>firewing1 wrote:</cite><blockquote><div><p>For those of us experiencing the memory allocation bug (guest VM memory is not freed after shutdown), are you passing through USB devices from the host? I just noticed that I encountered the memory issue only after attempting to add a USB mouse attached to the host to my VM,</p></div></blockquote></div><p>For me it doesn&#039;t matter if I&#039;m using usb passthrough or not. It happens when using pci-assing or vfio-pci. Did you try my kernel package? Here&#039;s <a href="http://www.fileswap.com/dl/n6NTVldSHX/" rel="nofollow">new</a> one. It includes acs override and i915 arbiter fix patches.</p><div class="quotebox"><cite>tuoni wrote:</cite><blockquote><div><p>Nope, I&#039;ve got the memory allocation bug, but the only thing I&#039;m passing through is the VGA card.</p></div></blockquote></div><p> @tuoni you can test if my package helps on mem leaks too.</p></div></blockquote></div><p>Thanks a lot for the kernel package, i have linked it at the front page.</p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1364016">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1364023" class="blockpost rowodd"> <h2><span><span class="conr">#938</span> <a href="viewtopic.php?pid=1364023#p1364023">2013-12-26 15:02:49</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=77960">xani</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2013-12-24</span></dd> <dd><span>Posts: 6</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=77960">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>nbhs wrote:</cite><blockquote><div><p>Thanks a lot for the kernel package, i have linked it at the front page.</p></div></blockquote></div><p>No problem, it is you that started this little vga passthrough movement in here <img src="https://bbs.archlinux.org/img/smilies/wink.png" width="15" height="15" alt="wink" /></p><p>Package that I posted also includes patch that disables gcc asm goto instructions, I think that only folks that have problem with memory leaks should use it. It is really low level x86 and gcc stuff that I don&#039;t fully understand.<br />Anyway, I made new one with all those fixes except asm goto: <a href="http://www.fileswap.com/dl/yjCS7emBNS/linux-mainline.tar.gz.html" rel="nofollow">linux-mainline.tar.gz</a>.<br />This is ofc yours updated to rc5 and patches so I don&#039;t want to take all the credit <img src="https://bbs.archlinux.org/img/smilies/smile.png" width="15" height="15" alt="smile" /></p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1364023">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1364034" class="blockpost roweven"> <h2><span><span class="conr">#939</span> <a href="viewtopic.php?pid=1364034#p1364034">2013-12-26 15:51:51</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=76834">Val532</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2013-11-13</span></dd> <dd><span>Posts: 35</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=76834">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>xani wrote:</cite><blockquote><div><div class="quotebox"><cite>Val532 wrote:</cite><blockquote><div><p>And is someone has managed to use a Sata card with vfio ?</p><p>I have two AsMedia 1062 (2*sata3) and it does not work correctly.</p></div></blockquote></div><p>I don&#039;t have any problems with this controller. </p><div class="codebox"><pre><code>05:00.0 SATA controller: ASMedia Technology Inc. ASM1062 Serial ATA Controller (rev 01) (prog-if 01 [AHCI 1.0])</code></pre></div><p>I am passing it like this </p><div class="codebox"><pre><code>-device vfio-pci,host=05:00.0,bus=pcie.0</code></pre></div><p>Windows 7 is recognising it without any hassle.</p></div></blockquote></div><p>It&#039;s strange for me it&#039;s work but only once, i can start my VM only once, if my VM reboot (cold reboot or hot reboot) it&#039;s bug on VM bios screen. And i have some dmesg :</p><div class="codebox"><pre><code>[ 404.206866] dmar: DRHD: handling fault status reg 2 [ 404.206870] dmar: DMAR:[DMA Write] Request device [07:00.0] fault addr 2affdf000 [ 404.206870] DMAR:[fault reason 05] PTE Write access is not set [ 404.206877] dmar: DRHD: handling fault status reg 2 [ 404.206879] dmar: DMAR:[DMA Read] Request device [07:00.0] fault addr 2affda000 [ 404.206879] DMAR:[fault reason 06] PTE Read access is not set</code></pre></div><p>What is your config ?</p> <p class="postedit"><em>Last edited by Val532 (2013-12-26 15:55:26)</em></p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1364034">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1364039" class="blockpost rowodd"> <h2><span><span class="conr">#940</span> <a href="viewtopic.php?pid=1364039#p1364039">2013-12-26 16:10:38</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=77960">xani</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2013-12-24</span></dd> <dd><span>Posts: 6</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=77960">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>Val532 wrote:</cite><blockquote><div><div class="quotebox"><cite>xani wrote:</cite><blockquote><div><div class="quotebox"><cite>Val532 wrote:</cite><blockquote><div><p>And is someone has managed to use a Sata card with vfio ?</p><p>I have two AsMedia 1062 (2*sata3) and it does not work correctly.</p></div></blockquote></div><p>I don&#039;t have any problems with this controller. </p><div class="codebox"><pre><code>05:00.0 SATA controller: ASMedia Technology Inc. ASM1062 Serial ATA Controller (rev 01) (prog-if 01 [AHCI 1.0])</code></pre></div><p>I am passing it like this </p><div class="codebox"><pre><code>-device vfio-pci,host=05:00.0,bus=pcie.0</code></pre></div><p>Windows 7 is recognising it without any hassle.</p></div></blockquote></div><p>It&#039;s strange for me it&#039;s work but only once, i can start my VM only once, if my VM reboot (cold reboot or hot reboot) it&#039;s bug on VM bios screen. And i have some dmesg :</p><div class="codebox"><pre><code>[ 404.206866] dmar: DRHD: handling fault status reg 2 [ 404.206870] dmar: DMAR:[DMA Write] Request device [07:00.0] fault addr 2affdf000 [ 404.206870] DMAR:[fault reason 05] PTE Write access is not set [ 404.206877] dmar: DRHD: handling fault status reg 2 [ 404.206879] dmar: DMAR:[DMA Read] Request device [07:00.0] fault addr 2affda000 [ 404.206879] DMAR:[fault reason 06] PTE Read access is not set</code></pre></div><p>What is your config ?</p></div></blockquote></div><p>Sorry to misguide you, but I noticed that this controller is responsible for seabios hang after I posted, and I wanted to test more before writing about it.<br />I think that when I was hunting for mem leak issue I changed my config to use this controller and I forgot about it.<br />Anyway, I think that vfio is not properly resetting it. Seabios showed that it cannot send commands to it, but this is only hunch.<br />I am going back to virtio because I don&#039;t have time to debug this and my sata drive that I used to passthrough is slower than using virtio...</p><p>Here&#039;s my current config if it can help somehow:</p><div class="codebox"><pre><code>$ cat /proc/cmdline BOOT_IMAGE=/vmlinuz-linux-mainline root=UUID=a63d1c94-4682-431c-9788-0cccd29ee598 rw intel_iommu=on pci-stub.ids=1002:6818,1002:aab0,8086:0 c0c,8086:153b pcie_acs_override=downstream sudo qemu-system-x86_64 -M q35 \ -m 8196 -enable-kvm -cpu host -monitor stdio \ -smp 4,sockets=1,cores=4,threads=1 \ -rtc clock=host,base=localtime \ -vga none -net none \ -parallel none -serial none -usb \ -drive cache=off,id=disk,file=/home/xani/old_home/xani/obrazy/windows/win-7.raw,format=raw \ -drive if=virtio,cache=off,id=diskc,file=/home/xani/old_home/xani/obrazy/windows/data.raw,format=raw \ -device ahci,bus=pcie.0,id=ahci \ -device ide-hd,bus=ahci.0,drive=disk \ -drive id=isocd,file=/home/xani/downloads/virtio-win-0.1-74.iso \ -device ide-cd,bus=ahci.1,drive=isocd \ -device ioh3420,bus=pcie.0,addr=1c.0,multifunction=on,port=1,chassis=1,id=root.1 \ -device vfio-pci,host=01:00.0,bus=root.1,addr=00.0,multifunction=on,x-vga=on \ -device vfio-pci,host=01:00.1,bus=pcie.0 \ -device vfio-pci,host=00:19.0,bus=pcie.0 \ -chardev file,id=seabios,path=/home/xani/seabios.log -device isa-debugcon,iobase=0x402,chardev=seabios</code></pre></div> <p class="postedit"><em>Last edited by xani (2013-12-26 16:16:17)</em></p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1364039">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1364079" class="blockpost roweven"> <h2><span><span class="conr">#941</span> <a href="viewtopic.php?pid=1364079#p1364079">2013-12-26 18:50:42</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=77651">noobman</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2013-12-13</span></dd> <dd><span>Posts: 21</span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>xani wrote:</cite><blockquote><div><p>Here&#039;s my directory from which you can test that memory leak issues.<br /><a href="http://www.fileswap.com/dl/qlZAIl1IF/" rel="nofollow">linux-mainline.tar.gz</a><br />Provide me with feedback if you have the same problem with seabios after reverting those patches.</p></div></blockquote></div><p>Hi and tyvm. I just used your linux-mainline-x and now the memory behaves nicely: i get it all back now upon closing the vm via qemu window. So i can confirm this fixed me. I just started using it and works great.<br />I will also try the second link asap, just holidays and etc. Speaking of which: Happy holidays to everybody <img src="https://bbs.archlinux.org/img/smilies/smile.png" width="15" height="15" alt="smile" /></p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1364079">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1364097" class="blockpost rowodd"> <h2><span><span class="conr">#942</span> <a href="viewtopic.php?pid=1364097#p1364097">2013-12-26 19:35:24</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=76834">Val532</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2013-11-13</span></dd> <dd><span>Posts: 35</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=76834">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <p>@xani :</p><p>Ok so i&#039;m not the only one to have this probleme, the funny fact is when you lauch a linux live cd and boot on it with the AsMedia 1062 you can access to your hard drive but you can reboot on it, but you have to wait some minute when Seabios hang (it finish to boot on CD)</p><p>So an other Sata controler ?</p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1364097">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1364211" class="blockpost roweven"> <h2><span><span class="conr">#943</span> <a href="viewtopic.php?pid=1364211#p1364211">2013-12-27 01:33:50</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=78023">doubledr</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2013-12-26</span></dd> <dd><span>Posts: 13</span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <p>I just registered to say thank you to every one. I managed to use vfio to passthrough my nvidia 760 GTX.</p><p>My setup: <br />CPU: Xeon 1230V2<br />MotherBoard: Tyan S5512. It has an onboard video chip AST 2150 for IPMI, which turns out to be a cause of Code 43.</p><p>Host: Gentoo linux: kernel 3.12.6 with 3 patches from this link (which has been shown in this thread): <a href="https://lists.fedoraproject.org/pipermail/virt/2013-December/003916.html" rel="nofollow">https://lists.fedoraproject.org/piperma … 03916.html</a> NoSnoop patch in top post is no longer necessary.<br />QEMU: 1.7 with 2 patches also provided in the link.</p><p>Note: <br />if you have an intel cpu with intel video gpu, you need to include the i915 video arbitration patches or you will have Code 43. If you don&#039;t want to patch then kernel 3.13 is the first working kernel...<br />But in my case it is something different, I don&#039;t think there is arbitration patch avaliable for AST chips. The only workaround is to set AST as primary video output in bios.</p><p>Note 2:<br />if you have intel CPU and want to use ATI card, I think it still needs some time to make them work with vfio. Black Screen is what I am facing right now. However, ATI cards works perfectly with PCI-STUB. But the last working build I have is qemu 1.5.3 with seabios 1.6.3. Any higher version results in a black screen.</p><p>Performance:<br />I just use windows index to check, everything looks normal except mem access. Qemu with Q35 simulation has some mem access regression. It is much slower than with 440fx：(5.5 vs 7.1). As a result, my 760 GTX doesn&#039;t play games faster than my 7790. 250 dollar is wasted...</p><br /><p>I would say for ATI card users, stay with PCI-stub, you ready get the best performance. Everything is perfect except the reboot problem. By the way, My via usb 3 controller works flawless with 440fx emulation. With Q35 chipset, I always receive code 10...</p><p>For nvidia card users, well, no choices. I never make PCI-stub work for nvidia cards.</p> <p class="postedit"><em>Last edited by doubledr (2013-12-27 01:35:07)</em></p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1364211">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1364223" class="blockpost rowodd"> <h2><span><span class="conr">#944</span> <a href="viewtopic.php?pid=1364223#p1364223">2013-12-27 02:49:07</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=75590">aw</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2013-10-04</span></dd> <dd><span>Posts: 921</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=75590">Email</a></span> <span class="website"><a href="http://vfio.blogspot.com/" rel="nofollow">Website</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>tuoni wrote:</cite><blockquote><div><p>EDIT: One thing I have noticed is there has been a marked decrease in my host (i915) graphics performance since using mainline-rc3 + i915 patch.&#160; I&#039;m presuming it&#039;s the kernel rather than the patch...?</p></div></blockquote></div><p>This is why the i915 patches were reverted upstream, X wants to mmap the VGA mmio space and will disable DRI if the arbiter reports that more than one VGA device is present.&#160; Therefore i915 has gone back to incorrectly reporting the VGA ranges the hardware decodes.</p> </div> <div class="postsignature postmsg"><hr /><p><a href="http://vfio.blogspot.com" rel="nofollow">http://vfio.blogspot.com</a><br />Looking for a more open forum to discuss vfio related uses?&#160; Try <a href="https://www.redhat.com/mailman/listinfo/vfio-users" rel="nofollow">https://www.redhat.com/mailman/listinfo/vfio-users</a></p></div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1364223">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1364261" class="blockpost roweven"> <h2><span><span class="conr">#945</span> <a href="viewtopic.php?pid=1364261#p1364261">2013-12-27 08:57:24</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=78033">dismuter</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2013-12-27</span></dd> <dd><span>Posts: 4</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=78033">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <p>I&#039;ve been trying to get passthrough working for a Radeon on an Intel platform, but it seems that it just doesn&#039;t work right now (black screens or code 10 in windows).<br />If I may... Forums are nice to discuss subjects but if anyone is accustomed to creating wikis, one would be nice to summarize information for various cases. 38 pages is starting to be critical in terms of finding the right information, and it&#039;s never good to rely solely on the OP to update his post.</p><div class="quotebox"><cite>doubledr wrote:</cite><blockquote><div><p>if you have intel CPU and want to use ATI card, I think it still needs some time to make them work with vfio. Black Screen is what I am facing right now. However, ATI cards works perfectly with PCI-STUB. But the last working build I have is qemu 1.5.3 with seabios 1.6.3. Any higher version results in a black screen.<br />[...]<br />I would say for ATI card users, stay with PCI-stub, you ready get the best performance.</p></div></blockquote></div><p>You mean legacy pci-assign? It&#039;s a shame that it doesn&#039;t work with the latest qemu+seabios then.</p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1364261">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1364361" class="blockpost rowodd"> <h2><span><span class="conr">#946</span> <a href="viewtopic.php?pid=1364361#p1364361">2013-12-27 17:04:42</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=78039">xj4reg</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2013-12-27</span></dd> <dd><span>Posts: 1</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=78039">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <p>I have two Radeon cards on a intel i7 machine, the vga pass through worked, but I meet BSoD on gust VM after install the newest ATI Catalyst driver. The BSoD told the error is on atikmpag.sys.<br />My HW configuration are - i7 3820, MSI x79a-gd45(8d), ATI Radeon 5400(for host),MSI Hawk ATI Radeon 6850(for gust windows).</p><p>I strictly follow the instructions, using the PKGBUILD to seabios, qemu and linux-mainline listed in page 1, but still run into this issue. Do you have any idea?</p><p>lspci outputs</p><div class="quotebox"><blockquote><div><p>02:00.0 VGA compatible controller: Advanced Micro Devices, Inc. [AMD/ATI] Cedar [Radeon HD 5000/6000/7350/8350 Series]<br />02:00.1 Audio device: Advanced Micro Devices, Inc. [AMD/ATI] Cedar HDMI Audio [Radeon HD 5400/6300 Series]<br />03:00.0 VGA compatible controller: Advanced Micro Devices, Inc. [AMD/ATI] Barts PRO [Radeon HD 6850]<br />03:00.1 Audio device: Advanced Micro Devices, Inc. [AMD/ATI] Barts HDMI Audio [Radeon HD 6800 Series]</p></div></blockquote></div><p>lspci -n</p><div class="quotebox"><blockquote><div><p>03:00.0 0300: 1002:6739<br />03:00.1 0403: 1002:aa88</p></div></blockquote></div><p>cat /proc/cmdline </p><div class="quotebox"><blockquote><div><p>BOOT_IMAGE=/boot/vmlinuz-linux-mainline root=UUID=a6859dd0-b64e-4c62-82ac-cbef89dce8ae rw intel_iommu=on vfio_iommu_type1.allow_unsafe_interrupts=1 pcie_acs_override=downstream pci-stubs.ids=1002:6739,1002:aa88 quiet</p></div></blockquote></div><p>vfio-bind.cfg</p><div class="quotebox"><blockquote><div><p>DEVICES=&quot;0000:03:00.0 0000:03:00.1&quot;</p></div></blockquote></div><p>qemu script</p><div class="quotebox"><blockquote><div><p>qemu-system-x86_64 -enable-kvm -M q35 -m 1024 -cpu host \<br />-smp 2,sockets=1,cores=2,threads=1 \<br />-bios /usr/share/qemu/bios.bin -vga none \<br />-usb -usbdevice &quot;host:7.4&quot; -usbdevice &quot;host:7.3&quot; \<br />-net nic -net user \<br />-device ioh3420,bus=pcie.0,addr=1c.0,multifunction=on,port=1,chassis=1,id=root.1 \<br />-device vfio-pci,host=03:00.0,bus=root.1,addr=00.0,multifunction=on,x-vga=on \<br />-device vfio-pci,host=03:00.1,bus=root.1,addr=00.1 \<br />-device ahci,bus=pcie.0,id=ahci \<br />-drive file=/home/tianxj/temp/windows.img,id=disk,format=raw -device ide-hd,bus=ahci.0,drive=disk \<br />-drive file=/home/tianxj/temp/cn_windows_7_ultimate_with_sp1_x64_dvd_u_677408.iso,id=isocd -device ide-cd,bus=ahci.1,drive=isocd \<br />-boot menu=on</p></div></blockquote></div> <p class="postedit"><em>Last edited by xj4reg (2013-12-27 17:05:43)</em></p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1364361">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1364393" class="blockpost roweven"> <h2><span><span class="conr">#947</span> <a href="viewtopic.php?pid=1364393#p1364393">2013-12-27 17:59:23</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=59037">techdude300</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2012-04-09</span></dd> <dd><span>Posts: 4</span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>xani wrote:</cite><blockquote><div><p>Here&#039;s my directory from which you can test that memory leak issues.<br /><a href="http://www.fileswap.com/dl/qlZAIl1IF/" rel="nofollow">linux-mainline.tar.gz</a></p><p>Provide me with feedback if you have the same problem with seabios after reverting those patches.</p></div></blockquote></div><p>Thanks so much! I can confirm that this does in fact seem to fix the issue. For some reason I was having trouble building it when i tried the first two times, but I got it to work on the 3rd try. All the memory the VM allocates is now returned back to the machine, so I no longer have to reboot the host. A very strange issue. Now all that&#039;s left on my end is to figure out sound.</p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1364393">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1364576" class="blockpost rowodd"> <h2><span><span class="conr">#948</span> <a href="viewtopic.php?pid=1364576#p1364576">2013-12-28 03:46:37</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=77080">sbd</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2013-11-21</span></dd> <dd><span>Posts: 4</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=77080">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>firewing1 wrote:</cite><blockquote><div><p>A.W. recommended using kernel 3.13rc + qemu.git OR kernel 3.12.5 + qemu 1.7.0 with the following commits patched in: <a href="https://lists.fedoraproject.org/pipermail/virt/2013-December/003916.html" rel="nofollow">https://lists.fedoraproject.org/piperma … 03916.html</a></p></div></blockquote></div><p>I can confirm that the 3.12.5 kernel series will work with the method described above, if anyone would prefer not to use 3.13rc. I applied the patches to kernel 3.12.5-302 and 1.7.0-3 on Fedora 20 (qemu package is from rawhide), and I&#039;ve installed the Catalyst drivers in the Windows 7 guest with no special options (control centre is included). It seems to be working normally. </p><p>I did use different i915 patches though, since the ones being linked in this thread are for the 3.13 series and don&#039;t compile on 3.12.5. I used the following instead:</p><p>81b5c7bc8de3e6f63419139c2fc91bf81dea8a7d<br />6e1b4fdad5157bb9e88777d525704aba24389bee</p><p>Thanks very much for all the advice guys, this thread has been great.</p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1364576">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1364646" class="blockpost roweven"> <h2><span><span class="conr">#949</span> <a href="viewtopic.php?pid=1364646#p1364646">2013-12-28 11:13:27</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=73593">BulliteShot</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2013-07-28</span></dd> <dd><span>Posts: 26</span></dd> <dd class="usercontacts"><span class="email"><a href="mailto:josh@servebyte.com">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <p>The windows VM now works perfectly, except if i&#039;m running the open source radeon driver on the host, my entire system freezes when windows boots. So if I blacklist radeon, windows boots perfectly but then I can&#039;t use Linux XD Anyone experienced this? :s</p><p>Primary GPU for Linux: AMD X1300 (R500 arch)<br />Secondary GPU for Windows: AMD R7950</p><div class="codebox"><pre><code>root@josh-desktop ~]# dmesg | grep AMD-Vi [ 1.079338] AMD-Vi: Found IOMMU at 0000:00:00.2 cap 0x40 [ 1.079340] AMD-Vi: Interrupt remapping enabled [ 1.091501] AMD-Vi: Lazy IO/TLB flushing enabled [ 3.073444] AMD-Vi: Event logged [IO_PAGE_FAULT device=01:00.1 domain=0x0019 address=0x0000000000009000 flags=0x0000] [ 3.073453] AMD-Vi: Event logged [IO_PAGE_FAULT device=01:00.1 domain=0x0019 address=0x0000000000005000 flags=0x0020] [ 3.073461] AMD-Vi: Event logged [IO_PAGE_FAULT device=01:00.1 domain=0x0019 address=0x0000000000009040 flags=0x0000] [ 3.073468] AMD-Vi: Event logged [IO_PAGE_FAULT device=01:00.1 domain=0x0019 address=0x0000000000009080 flags=0x0000] [ 3.073474] AMD-Vi: Event logged [IO_PAGE_FAULT device=01:00.1 domain=0x0019 address=0x00000000000090c0 flags=0x0000] [ 3.426471] AMD-Vi: Event logged [IO_PAGE_FAULT device=01:00.1 domain=0x0019 address=0x0000000000005400 flags=0x0020]</code></pre></div><div class="codebox"><pre><code>[root@josh-desktop ~]# dmesg | grep pci-stub [ 0.000000] Command line: BOOT_IMAGE=/vmlinuz-linux-mainline root=UUID=7af60c5d-239a-4347-ae94-424f99fe644d rw vfio_iommu_type1.allow_unsafe_interrupts=1 pci-stub.ids=1002:679a,1002:aaa0 quiet [ 0.000000] Kernel command line: BOOT_IMAGE=/vmlinuz-linux-mainline root=UUID=7af60c5d-239a-4347-ae94-424f99fe644d rw vfio_iommu_type1.allow_unsafe_interrupts=1 pci-stub.ids=1002:679a,1002:aaa0 quiet [ 1.227222] pci-stub: add 1002:679A sub=FFFFFFFF:FFFFFFFF cls=00000000/00000000 [ 1.227232] pci-stub 0000:09:00.0: claimed by stub [ 1.227236] pci-stub: add 1002:AAA0 sub=FFFFFFFF:FFFFFFFF cls=00000000/00000000 [ 1.227242] pci-stub 0000:09:00.1: claimed by stub</code></pre></div><div class="codebox"><pre class="vscroll"><code>[root@josh-desktop ~]# lspci 00:00.0 Host bridge: Advanced Micro Devices, Inc. [AMD/ATI] RD890 PCI to PCI bridge (external gfx0 port B) (rev 02) 00:00.2 IOMMU: Advanced Micro Devices, Inc. [AMD/ATI] RD990 I/O Memory Management Unit (IOMMU) 00:02.0 PCI bridge: Advanced Micro Devices, Inc. [AMD/ATI] RD890 PCI to PCI bridge (PCI express gpp port B) 00:04.0 PCI bridge: Advanced Micro Devices, Inc. [AMD/ATI] RD890 PCI to PCI bridge (PCI express gpp port D) 00:05.0 PCI bridge: Advanced Micro Devices, Inc. [AMD/ATI] RD890 PCI to PCI bridge (PCI express gpp port E) 00:06.0 PCI bridge: Advanced Micro Devices, Inc. [AMD/ATI] RD890 PCI to PCI bridge (PCI express gpp port F) 00:07.0 PCI bridge: Advanced Micro Devices, Inc. [AMD/ATI] RD890 PCI to PCI bridge (PCI express gpp port G) 00:09.0 PCI bridge: Advanced Micro Devices, Inc. [AMD/ATI] RD890 PCI to PCI bridge (PCI express gpp port H) 00:0a.0 PCI bridge: Advanced Micro Devices, Inc. [AMD/ATI] RD890 PCI to PCI bridge (external gfx1 port A) 00:0b.0 PCI bridge: Advanced Micro Devices, Inc. [AMD/ATI] RD890 PCI to PCI bridge (NB-SB link) 00:0d.0 PCI bridge: Advanced Micro Devices, Inc. [AMD/ATI] RD890 PCI to PCI bridge (external gfx1 port B) 00:11.0 SATA controller: Advanced Micro Devices, Inc. [AMD/ATI] SB7x0/SB8x0/SB9x0 SATA Controller [AHCI mode] (rev 40) 00:12.0 USB controller: Advanced Micro Devices, Inc. [AMD/ATI] SB7x0/SB8x0/SB9x0 USB OHCI0 Controller 00:12.2 USB controller: Advanced Micro Devices, Inc. [AMD/ATI] SB7x0/SB8x0/SB9x0 USB EHCI Controller 00:13.0 USB controller: Advanced Micro Devices, Inc. [AMD/ATI] SB7x0/SB8x0/SB9x0 USB OHCI0 Controller 00:13.2 USB controller: Advanced Micro Devices, Inc. [AMD/ATI] SB7x0/SB8x0/SB9x0 USB EHCI Controller 00:14.0 SMBus: Advanced Micro Devices, Inc. [AMD/ATI] SBx00 SMBus Controller (rev 42) 00:14.2 Audio device: Advanced Micro Devices, Inc. [AMD/ATI] SBx00 Azalia (Intel HDA) (rev 40) 00:14.3 ISA bridge: Advanced Micro Devices, Inc. [AMD/ATI] SB7x0/SB8x0/SB9x0 LPC host controller (rev 40) 00:14.4 PCI bridge: Advanced Micro Devices, Inc. [AMD/ATI] SBx00 PCI to PCI Bridge (rev 40) 00:14.5 USB controller: Advanced Micro Devices, Inc. [AMD/ATI] SB7x0/SB8x0/SB9x0 USB OHCI2 Controller 00:16.0 USB controller: Advanced Micro Devices, Inc. [AMD/ATI] SB7x0/SB8x0/SB9x0 USB OHCI0 Controller 00:16.2 USB controller: Advanced Micro Devices, Inc. [AMD/ATI] SB7x0/SB8x0/SB9x0 USB EHCI Controller 00:18.0 Host bridge: Advanced Micro Devices, Inc. [AMD] Family 15h Processor Function 0 00:18.1 Host bridge: Advanced Micro Devices, Inc. [AMD] Family 15h Processor Function 1 00:18.2 Host bridge: Advanced Micro Devices, Inc. [AMD] Family 15h Processor Function 2 00:18.3 Host bridge: Advanced Micro Devices, Inc. [AMD] Family 15h Processor Function 3 00:18.4 Host bridge: Advanced Micro Devices, Inc. [AMD] Family 15h Processor Function 4 00:18.5 Host bridge: Advanced Micro Devices, Inc. [AMD] Family 15h Processor Function 5 01:00.0 VGA compatible controller: Advanced Micro Devices, Inc. [AMD/ATI] RV516 [Radeon X1300/X1550 Series] 01:00.1 Display controller: Advanced Micro Devices, Inc. [AMD/ATI] RV516 [Radeon X1300/X1550 Series] (Secondary) 02:00.0 SATA controller: ASMedia Technology Inc. ASM1062 Serial ATA Controller (rev 01) 03:00.0 Ethernet controller: Intel Corporation 82583V Gigabit Network Connection 04:00.0 USB controller: ASMedia Technology Inc. ASM1042 SuperSpeed USB Host Controller 05:00.0 USB controller: ASMedia Technology Inc. ASM1042 SuperSpeed USB Host Controller 06:00.0 USB controller: ASMedia Technology Inc. ASM1042 SuperSpeed USB Host Controller 07:00.0 SATA controller: ASMedia Technology Inc. ASM1062 Serial ATA Controller (rev 01) 09:00.0 VGA compatible controller: Advanced Micro Devices, Inc. [AMD/ATI] Tahiti PRO [Radeon HD 7950] 09:00.1 Audio device: Advanced Micro Devices, Inc. [AMD/ATI] Tahiti XT HDMI Audio [Radeon HD 7970 Series]</code></pre></div><p><strong>EDIT: Fixed it by updating BIOS, moving the 2nd CPU to a different PCI port, enabling a 64MB IOMMU mode in the BIOS, adding &quot;iommu=pt iommu=1 amd_iommu=on&quot; to kernel boot and compiling the kernel to have static modules. Not sure which one actually fixed it but it works! <img src="https://bbs.archlinux.org/img/smilies/big_smile.png" width="15" height="15" alt="big_smile" /></strong></p><p>By the way, the linux-mainline package provided in this topic doesn&#039;t have the kernel modules statically loaded by default. I had to change the config files manually and skip makepkg integrity check. I know you can enable them in the kernel config dialog but I can never find anything there. I don&#039;t understand why they wouldn&#039;t be enabled by default in the package since it&#039;s possible to do so?</p> <p class="postedit"><em>Last edited by BulliteShot (2013-12-28 12:08:08)</em></p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1364646">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1364674" class="blockpost rowodd"> <h2><span><span class="conr">#950</span> <a href="viewtopic.php?pid=1364674#p1364674">2013-12-28 13:32:11</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=77651">noobman</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2013-12-13</span></dd> <dd><span>Posts: 21</span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <p>@ xj4reg : <br />I have quite same setup, i7-3820 and dx79to (same x79 chipset), my primary is also ati (hd6570 with open source drivers), passing secondary gtx770. Perhaps not the best for this, but nonetheless i think it should work also for you.<br />About kernel, i had &#039;bus options \ pci-stub&#039; built-in (not module) - if its module then see OP. Also &#039; device drivers \ iommu \ enable intel dma remmapping default &#039; built-in. And i did built in all virtio (except mem balooning). Perhaps not all this are necesarily like that but i am&#160; just describing mine. For kernel, i had the memory issue with OP ones, so now i use the first link from xani (the link with fixmemory patch, not the second without). About config i used options kvm ignore_msrs=1 and about all the rest from OP. Also i am passing an entire usb controller instead of just devices, that is because i use a kvm switch. So i made the system service from OP and upon startup is good to check lspci -vvv and see kernel driver in use: vfio-pci for devices card, sound, and usb controller if passed like so. My sound works from guest to host with just the first two lines from OP, no other kinky quemu start params. </p><p>Good luck!</p> <p class="postedit"><em>Last edited by noobman (2013-12-28 13:44:54)</em></p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1364674">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div class="postlinksb"> <div class="inbox crumbsplus"> <div class="pagepost"> <p class="pagelink conl"><span class="pages-label">Pages: </span><a rel="prev" class="item1" href="viewtopic.php?id=162768&amp;p=37">Previous</a> <a href="viewtopic.php?id=162768">1</a> <span class="spacer">…</span> <a href="viewtopic.php?id=162768&amp;p=36">36</a> <a href="viewtopic.php?id=162768&amp;p=37">37</a> <strong>38</strong> <a href="viewtopic.php?id=162768&amp;p=39">39</a> <a href="viewtopic.php?id=162768&amp;p=40">40</a> <span class="spacer">…</span> <a href="viewtopic.php?id=162768&amp;p=234">234</a> <a rel="next" href="viewtopic.php?id=162768&amp;p=39">Next</a></p> <p class="postlink conr">Topic closed</p> </div> <ul class="crumbs"> <li><a href="index.php">Index</a></li> <li><span>»&#160;</span><a href="viewforum.php?id=48">Topics Going Nowhere</a></li> <li><span>»&#160;</span><strong><a href="viewtopic.php?id=162768">KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</a></strong></li> </ul> <p class="subscribelink clearb"><a href="misc.php?action=subscribe&amp;tid=162768">Subscribe to this topic</a></p> <div class="clearer"></div> </div> </div> </div> <div id="brdfooter" class="block"> <h2><span>Board footer</span></h2> <div class="box"> <div id="brdfooternav" class="inbox"> <div class="conl"> <form id="qjump" method="get" action="viewforum.php"> <div><label><span>Jump to<br /></span> <select name="id" onchange="window.location=('viewforum.php?id='+this.options[this.selectedIndex].value)"> <optgroup label="Technical Issues and Assistance"> <option value="23">Newbie Corner</option> <option value="17">Installation</option> <option value="22">Kernel &amp; Hardware</option> <option value="18">Applications &amp; Desktop Environments</option> <option value="31">Laptop Issues</option> <option value="8">Networking, Server, and Protection</option> <option value="32">Multimedia and Games</option> <option value="50">System Administration</option> <option value="35">Other Architectures</option> </optgroup> <optgroup label="Arch-centric"> <option value="24">Announcements, Package &amp; Security Advisories</option> <option value="1">Arch Discussion</option> <option value="13">Forum &amp; Wiki discussion</option> </optgroup> <optgroup label="Pacman Upgrades, Packaging &amp; AUR"> <option value="44">Pacman &amp; Package Upgrade Issues</option> <option value="49">[testing] Repo Forum</option> <option value="4">Creating &amp; Modifying Packages</option> <option value="38">AUR Issues, Discussion &amp; PKGBUILD Requests</option> </optgroup> <optgroup label="Contributions &amp; Discussion"> <option value="20">GNU/Linux Discussion</option> <option value="27">Community Contributions</option> <option value="33">Programming &amp; Scripting</option> <option value="30">Other Languages</option> <option value="47">Artwork and Screenshots</option> <option value="42">Try This</option> </optgroup> <optgroup label="/dev/null"> <option value="29">Off-Topic</option> <option value="48" selected="selected">Topics Going Nowhere</option> <option value="36">Dustbin</option> </optgroup> </select></label> <input type="submit" value=" Go " accesskey="g" /> </div> </form> </div> <div class="conr"> <p id="feedlinks"><span class="atom"><a href="extern.php?action=feed&amp;tid=162768&amp;type=atom">Atom topic feed</a></span></p> <p id="poweredby">Powered by <a href="http://fluxbb.org/">FluxBB</a></p> </div> <div class="clearer"></div> </div> </div> </div> </div> <div class="end-box"></div> </div> </body> </html>
