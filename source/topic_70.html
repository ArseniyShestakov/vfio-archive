<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"> <html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en" dir="ltr"> <head> <meta http-equiv="Content-Type" content="text/html; charset=utf-8" /> <title>KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9 (Page 70) / Topics Going Nowhere / Arch Linux Forums</title> <link rel="stylesheet" type="text/css" href="style/ArchLinux.css" /> <link rel="canonical" href="viewtopic.php?id=162768&amp;p=70" title="Page 70" /> <link rel="prev" href="viewtopic.php?id=162768&amp;p=69" title="Page 69" /> <link rel="next" href="viewtopic.php?id=162768&amp;p=71" title="Page 71" /> <link rel="alternate" type="application/atom+xml" href="extern.php?action=feed&amp;tid=162768&amp;type=atom" title="Atom topic feed" /> <link rel="stylesheet" media="screen" href="style/ArchLinux/arch.css?v=3" /> <link rel="stylesheet" media="screen" href="style/ArchLinux/archnavbar.css?v=2" /> <link rel="shortcut icon" href="style/ArchLinux/favicon.ico" /> </head> <body> <div id="archnavbar" class="anb-forum"> <div id="archnavbarlogo"><h1><a href="http://www.archlinux.org/">Arch Linux</a></h1></div> <div id="archnavbarmenu"> <ul id="archnavbarlist"> <li id="anb-home"><a href="http://www.archlinux.org/">Home</a></li><li id="anb-packages"><a href="http://www.archlinux.org/packages/">Packages</a></li><li id="anb-forums" class="anb-selected"><a href="https://bbs.archlinux.org/">Forums</a></li><li id="anb-wiki"><a href="https://wiki.archlinux.org/">Wiki</a></li><li id="anb-bugs"><a href="https://bugs.archlinux.org/">Bugs</a></li><li id="anb-aur"><a href="https://aur.archlinux.org/">AUR</a></li><li id="anb-download"><a href="http://www.archlinux.org/download/">Download</a></li> </ul> </div> </div> <div id="punviewtopic" class="pun"> <div class="top-box"></div> <div class="punwrap"> <div id="brdheader" class="block"> <div class="box"> <div id="brdmenu" class="inbox"> <ul> <li id="navindex" class="isactive"><a href="index.php">Index</a></li> <li id="navuserlist"><a href="userlist.php">User list</a></li> <li id="navsearch"><a href="search.php">Search</a></li> <li id="navprofile"><a href="profile.php?id=80749">Profile</a></li> <li id="navlogout"><a href="login.php?action=out&amp;id=80749&amp;csrf_token=5c20501ec397bb45ef8ee8c84db232c8d8e421c6">Logout</a></li> </ul> </div> <div id="brdwelcome" class="inbox"> <ul class="conl"> <li><span>Logged in as <strong>SXX</strong></span></li> <li><span>Last visit: 2015-08-16 12:20:09</span></li> </ul> <ul class="conr"> <li><span>Topics: <a href="search.php?action=show_replies" title="Find topics you have posted to.">Posted</a> | <a href="search.php?action=show_new" title="Find topics with new posts since your last visit.">New</a> | <a href="search.php?action=show_recent" title="Find topics with recent posts.">Active</a> | <a href="search.php?action=show_unanswered" title="Find topics with no replies.">Unanswered</a></span></li> </ul> <div class="clearer"></div> </div> </div> </div> <div id="brdmain"> <div class="linkst"> <div class="inbox crumbsplus"> <ul class="crumbs"> <li><a href="index.php">Index</a></li> <li><span>»&#160;</span><a href="viewforum.php?id=48">Topics Going Nowhere</a></li> <li><span>»&#160;</span><strong><a href="viewtopic.php?id=162768">KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</a></strong></li> </ul> <div class="pagepost"> <p class="pagelink conl"><span class="pages-label">Pages: </span><a rel="prev" class="item1" href="viewtopic.php?id=162768&amp;p=69">Previous</a> <a href="viewtopic.php?id=162768">1</a> <span class="spacer">…</span> <a href="viewtopic.php?id=162768&amp;p=68">68</a> <a href="viewtopic.php?id=162768&amp;p=69">69</a> <strong>70</strong> <a href="viewtopic.php?id=162768&amp;p=71">71</a> <a href="viewtopic.php?id=162768&amp;p=72">72</a> <span class="spacer">…</span> <a href="viewtopic.php?id=162768&amp;p=234">234</a> <a rel="next" href="viewtopic.php?id=162768&amp;p=71">Next</a></p> <p class="postlink conr">Topic closed</p> </div> <div class="clearer"></div> </div> </div> <div id="p1417077" class="blockpost rowodd blockpost1"> <h2><span><span class="conr">#1726</span> <a href="viewtopic.php?pid=1417077#p1417077">2014-05-19 18:01:19</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=75590">aw</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2013-10-04</span></dd> <dd><span>Posts: 921</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=75590">Email</a></span> <span class="website"><a href="http://vfio.blogspot.com/" rel="nofollow">Website</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>Namelles_One wrote:</cite><blockquote><div><div class="quotebox"><cite>zzz3000 wrote:</cite><blockquote><div><p>I have the same problem with HD7750.<br />The problem with windows radeon driver dissapeared only after I had installed&#160; fedora rawhide, so I am waiting fedora 21.</p></div></blockquote></div><p>Thank you! &quot;Rawhide&quot; - it is a keyword ^^</p></div></blockquote></div><p>If you don&#039;t want to go bleeding edge for the whole distro, you can use the Fedora virt-preview repo: <a href="http://fedoraproject.org/wiki/Virtualization_Preview_Repository" rel="nofollow">http://fedoraproject.org/wiki/Virtualiz … Repository</a></p><p>It effectively gives you &quot;rawhide&quot; virt bits while keeping the rest on the latest stable version.</p> </div> <div class="postsignature postmsg"><hr /><p><a href="http://vfio.blogspot.com" rel="nofollow">http://vfio.blogspot.com</a><br />Looking for a more open forum to discuss vfio related uses?&#160; Try <a href="https://www.redhat.com/mailman/listinfo/vfio-users" rel="nofollow">https://www.redhat.com/mailman/listinfo/vfio-users</a></p></div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1417077">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1417086" class="blockpost roweven"> <h2><span><span class="conr">#1727</span> <a href="viewtopic.php?pid=1417086#p1417086">2014-05-19 18:30:01</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=82094">Namelles_One</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2014-05-18</span></dd> <dd><span>Posts: 8</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=82094">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>aw wrote:</cite><blockquote><div><div class="quotebox"><cite>Namelles_One wrote:</cite><blockquote><div><div class="quotebox"><cite>zzz3000 wrote:</cite><blockquote><div><p>I have the same problem with HD7750.<br />The problem with windows radeon driver dissapeared only after I had installed&#160; fedora rawhide, so I am waiting fedora 21.</p></div></blockquote></div><p>Thank you! &quot;Rawhide&quot; - it is a keyword ^^</p></div></blockquote></div><p>If you don&#039;t want to go bleeding edge for the whole distro, you can use the Fedora virt-preview repo: <a href="http://fedoraproject.org/wiki/Virtualization_Preview_Repository" rel="nofollow">http://fedoraproject.org/wiki/Virtualiz … Repository</a></p><p>It effectively gives you &quot;rawhide&quot; virt bits while keeping the rest on the latest stable version.</p></div></blockquote></div><p>I use Gentoo. &quot;Rawhide&quot; - gives me an idea about kernel version.</p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1417086">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1417184" class="blockpost rowodd"> <h2><span><span class="conr">#1728</span> <a href="viewtopic.php?pid=1417184#p1417184">2014-05-20 01:57:37</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=79578">AKSN74</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd class="postavatar"><img src="https://bbs.archlinux.org/img/avatars/79578.jpg?m=1423108340" width="80" height="80" alt="" /></dd> <dd><span>From: Taichung, Taiwan</span></dd> <dd><span>Registered: 2014-02-18</span></dd> <dd><span>Posts: 52</span></dd> <dd class="usercontacts"><span class="email"><a href="mailto:missile0407@gmail.com">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <p>Also, I got another problem yesterday.</p><p>Because my target is build VM with GTX480, and want to run CUDA with GTX480 in VM.</p><p>As guest OS is Ubuntu 12.04-4, first I install NVIDIA Driver without a problem.<br />Then I install CUDA SDK 6.0, and still no problem. And it can compile the sample application.</p><p>But when I tried to run deviceQueryDrv, it got error.</p><div class="codebox"><pre><code>CUDA_ERROR_INVALID_DEVICE (device specified is not a valid CUDA device)</code></pre></div><p>So I downgrade my SDK version to 5.5, because GTX480 is old GPU, some functions in 6.0 may not support.<br />When I installed 5.5, and compile ver 5.5 samples, still got a same error while I ran deviceQueryDrv.</p><p>But before that, I can run CUDA while guest OS is Windows 7. And it can get matrix multiply result.<br />Maybe it&#039;s driver and SDK compatible problem (if it is VFIO problem, graphic driver will got issue first. Neither NVIDIA offical driver nor Nouveau.)</p> <p class="postedit"><em>Last edited by AKSN74 (2014-05-20 01:58:52)</em></p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1417184">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1417205" class="blockpost roweven"> <h2><span><span class="conr">#1729</span> <a href="viewtopic.php?pid=1417205#p1417205">2014-05-20 04:58:30</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=81794">Destroy</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2014-05-05</span></dd> <dd><span>Posts: 10</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=81794">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <p>This post is very funny and exciting!!! Thanks again to all, specially to nbhs and AW</p><p>Now I&#039;m trying to pass my SATA port Marvell at 08:00.0<br />lspci -tv</p><div class="codebox"><pre><code>-[0000:00]-+-00.0 Intel Corporation Xeon E3-1200 v2/3rd Gen Core processor DRAM Controller +-01.0-[01]----00.0 NVIDIA Corporation G73 [GeForce 7600 GT] +-02.0 Intel Corporation Xeon E3-1200 v2/3rd Gen Core processor Graphics Controller +-14.0 Intel Corporation 7 Series/C210 Series Chipset Family USB xHCI Host Controller +-16.0 Intel Corporation 7 Series/C210 Series Chipset Family MEI Controller #1 +-19.0 Intel Corporation 82579V Gigabit Network Connection +-1a.0 Intel Corporation 7 Series/C210 Series Chipset Family USB Enhanced Host Controller #2 +-1b.0 Intel Corporation 7 Series/C210 Series Chipset Family High Definition Audio Controller +-1c.0-[02]-- +-1c.1-[03]----00.0 Marvell Technology Group Ltd. 88SE9172 SATA 6Gb/s Controller +-1c.3-[04]----00.0 Atheros Communications Inc. AR9462 Wireless Network Adapter +-1c.5-[05-06]----00.0-[06]----01.0 VIA Technologies, Inc. VT6306/7/8 [Fire II(M)] IEEE 1394 OHCI Controller +-1c.6-[07]----00.0 Qualcomm Atheros AR8151 v2.0 Gigabit Ethernet +-1c.7-[08]----00.0 Marvell Technology Group Ltd. 88SE9172 SATA 6Gb/s Controller +-1d.0 Intel Corporation 7 Series/C210 Series Chipset Family USB Enhanced Host Controller #1 +-1f.0 Intel Corporation Z77 Express Chipset LPC Controller +-1f.2 Intel Corporation 7 Series/C210 Series Chipset Family 6-port SATA Controller [AHCI mode] \-1f.3 Intel Corporation 7 Series/C210 Series Chipset Family SMBus Controller</code></pre></div><p>but it&#039;s in a group</p><p>lsgroup</p><div class="codebox"><pre><code>### Group 8 ### 00:1c.0 PCI bridge: Intel Corporation 7 Series/C210 Series Chipset Family PCI Express Root Port 1 (rev c4) 00:1c.1 PCI bridge: Intel Corporation 7 Series/C210 Series Chipset Family PCI Express Root Port 2 (rev c4) 00:1c.3 PCI bridge: Intel Corporation 7 Series/C210 Series Chipset Family PCI Express Root Port 4 (rev c4) 00:1c.5 PCI bridge: Intel Corporation 82801 PCI Bridge (rev c4) 00:1c.6 PCI bridge: Intel Corporation 7 Series/C210 Series Chipset Family PCI Express Root Port 7 (rev c4) 00:1c.7 PCI bridge: Intel Corporation 7 Series/C210 Series Chipset Family PCI Express Root Port 8 (rev c4) 03:00.0 SATA controller: Marvell Technology Group Ltd. 88SE9172 SATA 6Gb/s Controller (rev 11) 04:00.0 Network controller: Atheros Communications Inc. AR9462 Wireless Network Adapter (rev 01) 05:00.0 PCI bridge: Intel Corporation 82801 PCI Bridge (rev 30) 06:01.0 FireWire (IEEE 1394): VIA Technologies, Inc. VT6306/7/8 [Fire II(M)] IEEE 1394 OHCI Controller (rev c0) 07:00.0 Ethernet controller: Qualcomm Atheros AR8151 v2.0 Gigabit Ethernet (rev c0) 08:00.0 SATA controller: Marvell Technology Group Ltd. 88SE9172 SATA 6Gb/s Controller (rev 11)</code></pre></div><p>I have been reading and it says&#160; I must apply the path to override ACS but that is from march 2013 (<a href="https://lkml.org/lkml/2013/5/30/513" rel="nofollow">https://lkml.org/lkml/2013/5/30/513</a>) , also I found the v2 from February 2014 (<a href="https://lkml.org/lkml/2014/2/3/487" rel="nofollow">https://lkml.org/lkml/2014/2/3/487</a>) but it does haven the kernel parameters.</p><p>the questions are:<br />are for the same?<br />then I must apply the v2?<br />it&#039;s included in kernel 3.15?</p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1417205">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1417208" class="blockpost rowodd"> <h2><span><span class="conr">#1730</span> <a href="viewtopic.php?pid=1417208#p1417208">2014-05-20 05:23:37</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=75590">aw</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2013-10-04</span></dd> <dd><span>Posts: 921</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=75590">Email</a></span> <span class="website"><a href="http://vfio.blogspot.com/" rel="nofollow">Website</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>Destroy wrote:</cite><blockquote><div><p>I have been reading and it says&#160; I must apply the path to override ACS but that is from march 2013 (<a href="https://lkml.org/lkml/2013/5/30/513" rel="nofollow">https://lkml.org/lkml/2013/5/30/513</a>) , also I found the v2 from February 2014 (<a href="https://lkml.org/lkml/2014/2/3/487" rel="nofollow">https://lkml.org/lkml/2014/2/3/487</a>) but it does haven the kernel parameters.</p><p>the questions are:<br />are for the same?<br />then I must apply the v2?<br />it&#039;s included in kernel 3.15?</p></div></blockquote></div><p>Upgrade to 3.15 and you won&#039;t need the ACS override patch.&#160; That doesn&#039;t mean that the Marvell card is going to work, because it&#039;s terribly broken (remember those DMA patches you&#039;ve applied?)</p> </div> <div class="postsignature postmsg"><hr /><p><a href="http://vfio.blogspot.com" rel="nofollow">http://vfio.blogspot.com</a><br />Looking for a more open forum to discuss vfio related uses?&#160; Try <a href="https://www.redhat.com/mailman/listinfo/vfio-users" rel="nofollow">https://www.redhat.com/mailman/listinfo/vfio-users</a></p></div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1417208">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1417216" class="blockpost roweven"> <h2><span><span class="conr">#1731</span> <a href="viewtopic.php?pid=1417216#p1417216">2014-05-20 06:26:15</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=79578">AKSN74</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd class="postavatar"><img src="https://bbs.archlinux.org/img/avatars/79578.jpg?m=1423108340" width="80" height="80" alt="" /></dd> <dd><span>From: Taichung, Taiwan</span></dd> <dd><span>Registered: 2014-02-18</span></dd> <dd><span>Posts: 52</span></dd> <dd class="usercontacts"><span class="email"><a href="mailto:missile0407@gmail.com">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>aw wrote:</cite><blockquote><div><p>Upgrade to 3.15 and you won&#039;t need the ACS override patch.&#160; That doesn&#039;t mean that the Marvell card is going to work, because it&#039;s terribly broken (remember those DMA patches you&#039;ve applied?)</p></div></blockquote></div><p>Hi, aw.</p><p>I found that not only VM hangs when reboot with 2 VMs working together, but also only 1 VM working.</p><p>And I tried to shutdown, not reboot, it can back to tty successfully.<br />But when I try to start again with same command, it got another error message.</p><div class="codebox"><pre><code>qemu-system-x86_64: vfio-pci: Cannot read device rom at 0000:03:00.0 Device option ROM contents are probably invalid (check dmesg). Skip option ROM probe with rombar=0, or load from file with romfile=</code></pre></div><p>It&#039;s may a reason why it hangs when reboot.<br />But I found that when&#160; I reboot VM while guest OS is Windows 7, it can reboot successfully some times.<br />So it is very strange for this problem.......</p><p>I&#039;ll try to use 3.14.4 kernel and see it still a same problem or not.</p> <p class="postedit"><em>Last edited by AKSN74 (2014-05-20 13:35:14)</em></p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1417216">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1417292" class="blockpost rowodd"> <h2><span><span class="conr">#1732</span> <a href="viewtopic.php?pid=1417292#p1417292">2014-05-20 11:25:58</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=79237">mbroemme</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>From: Cologne</span></dd> <dd><span>Registered: 2014-02-05</span></dd> <dd><span>Posts: 39</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=79237">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>zzz3000 wrote:</cite><blockquote><div><p>Hello.<br />Is it possible to passthrough radeon card and use another radeon in host?<br />How don&#039;t blacklist radeon driver and get it works.</p><p>Looks like I just have to use psi-stub for guest card and don&#039;t blacklist radeon driver.</p></div></blockquote></div><p>If you are on Arch Linux you can make it even more simple. I use a 7870 for my Linux system and a R9 290X for my VM. In Arch Linux just do the following:</p><p>#1 Create file &#039;/etc/modules-load.d/vfio-pci.conf&#039; with content:<br />vfio-pci</p><p>#2 Create file &#039;/etc/modprobe.d/vfio-pci.conf&#039; with content:<br />install vfio-pci /usr/bin/modprobe --ignore-install vfio-pci ; echo VENDOR DEVICE &gt; /sys/bus/pci/drivers/vfio-pci/new_id</p><p>Just replace VENDOR and DEVICE with your appropriate IDs from &#039;lspci -n&#039; output. Also this can be extended with any other device, if they are bound already (most probably USB devices) you can unbind them with the modprobe configuration.</p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1417292">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1417295" class="blockpost roweven"> <h2><span><span class="conr">#1733</span> <a href="viewtopic.php?pid=1417295#p1417295">2014-05-20 11:32:48</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=82136">Chrissi</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2014-05-20</span></dd> <dd><span>Posts: 5</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=82136">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <p>Hey guys! <br />I followed the instruction step by step, but when i try to start the vm with</p><div class="quotebox"><blockquote><div><p>qemu-system-x86_64 -enable-kvm -M q35 -m 1024 -cpu host \<br />-smp 6,sockets=1,cores=6,threads=1 \<br />-bios /usr/share/qemu/bios.bin -vga none \<br />-device ioh3420,bus=pcie.0,addr=1c.0,multifunction=on,port=1,chassis=1,id=root.$<br />-device vfio-pci,host=01:00.0,bus=root.1,addr=00.0,multifunction=on,x-vga=on \<br />-device vfio-pci,host=01:00.1,bus=root.1,addr=00.1</p></div></blockquote></div><p>i get the following error:</p><div class="quotebox"><blockquote><div><p>qemu-system-x86_64: -device vfio-pci,host=01:00.0,bus=root.1,addr=00.0,multifunction=on,x-vga=on: vfio: error no iommu_group for device<br />qemu-system-x86_64: -device vfio-pci,host=01:00.0,bus=root.1,addr=00.0,multifunction=on,x-vga=on: Device initialization failed.<br />qemu-system-x86_64: -device vfio-pci,host=01:00.0,bus=root.1,addr=00.0,multifunction=on,x-vga=on: Device &#039;vfio-pci&#039; could not be initialized</p></div></blockquote></div><p>The interesting thing is I got the same error output on a ubuntu based machine, so I guess its something hardware related or something I just don&#039;t get.</p><p>dmesg | grep -e DMAR -e IOMMU</p><div class="quotebox"><blockquote><div><p>[&#160; &#160; 0.000000] ACPI: DMAR 000000007c1789f8 0000B8 (v01 INTEL&#160; &#160; &#160; HSW&#160; 00000001 INTL 00000001)<br />[&#160; &#160; 0.016013] dmar: IOMMU 0: reg_base_addr fed90000 ver 1:0 cap c0000020660462 ecap f0101a<br />[&#160; &#160; 0.016017] dmar: IOMMU 1: reg_base_addr fed91000 ver 1:0 cap d2008020660462 ecap f010da<br />[&#160; &#160; 0.016082] IOAPIC id 2 under DRHD base&#160; 0xfed91000 IOMMU 1</p></div></blockquote></div><p>dmesg | grep vfio</p><div class="quotebox"><blockquote><div><p>[&#160; &#160; 2.966707] vfio-pci: probe of 0000:01:00.0 failed with error -22 ... for every card</p></div></blockquote></div><p><a href="http://pastebin.com/6AHUEQDm" rel="nofollow"> full dmesg on pastebin </a></p><p>my system:<br />i7 4770<br />asrock extreme 6 (vt-d in bios enabled)<br />2x 290x / 1x290 (my good old coin mining cards)<br />grub boots with&#160; intel_iommu=on</p><p>i am using qemu 2.0.0.3 (installed via pacman) and the mainline kernel with patches by OP. <br />Since I want to pass all my cards, I just blacklisted &quot;radeon&quot; in modprobe.d.</p><p>would be great if someone could give me a little advice how i may proceed with this. Thanks in advance !</p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1417295">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1417324" class="blockpost rowodd"> <h2><span><span class="conr">#1734</span> <a href="viewtopic.php?pid=1417324#p1417324">2014-05-20 12:58:43</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=75590">aw</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2013-10-04</span></dd> <dd><span>Posts: 921</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=75590">Email</a></span> <span class="website"><a href="http://vfio.blogspot.com/" rel="nofollow">Website</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>Chrissi wrote:</cite><blockquote><div><p>grub boots with&#160; intel_iommu=on</p></div></blockquote></div><p>Your pastebin says otherwise</p><div class="codebox"><pre><code>[ 0.000000] Command line: BOOT_IMAGE=/boot/vmlinuz-linux root=UUID=e60e5956-3c30-4b5d-a86b-5272a29bc246 rw quiet</code></pre></div> </div> <div class="postsignature postmsg"><hr /><p><a href="http://vfio.blogspot.com" rel="nofollow">http://vfio.blogspot.com</a><br />Looking for a more open forum to discuss vfio related uses?&#160; Try <a href="https://www.redhat.com/mailman/listinfo/vfio-users" rel="nofollow">https://www.redhat.com/mailman/listinfo/vfio-users</a></p></div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1417324">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1417386" class="blockpost roweven"> <h2><span><span class="conr">#1735</span> <a href="viewtopic.php?pid=1417386#p1417386">2014-05-20 15:48:19</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=82136">Chrissi</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2014-05-20</span></dd> <dd><span>Posts: 5</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=82136">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>aw wrote:</cite><blockquote><div><div class="quotebox"><cite>Chrissi wrote:</cite><blockquote><div><p>grub boots with&#160; intel_iommu=on</p></div></blockquote></div><p>Your pastebin says otherwise</p><div class="codebox"><pre><code>[ 0.000000] Command line: BOOT_IMAGE=/boot/vmlinuz-linux root=UUID=e60e5956-3c30-4b5d-a86b-5272a29bc246 rw quiet</code></pre></div></div></blockquote></div><p>sometimes there is a very easy way but we just don&#039;t see it. thank you.</p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1417386">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1417646" class="blockpost rowodd"> <h2><span><span class="conr">#1736</span> <a href="viewtopic.php?pid=1417646#p1417646">2014-05-21 07:08:36</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=79578">AKSN74</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd class="postavatar"><img src="https://bbs.archlinux.org/img/avatars/79578.jpg?m=1423108340" width="80" height="80" alt="" /></dd> <dd><span>From: Taichung, Taiwan</span></dd> <dd><span>Registered: 2014-02-18</span></dd> <dd><span>Posts: 52</span></dd> <dd class="usercontacts"><span class="email"><a href="mailto:missile0407@gmail.com">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>AKSN74 wrote:</cite><blockquote><div><p>Also, I got another problem yesterday.</p><p>Because my target is build VM with GTX480, and want to run CUDA with GTX480 in VM.</p><p>As guest OS is Ubuntu 12.04-4, first I install NVIDIA Driver without a problem.<br />Then I install CUDA SDK 6.0, and still no problem. And it can compile the sample application.</p><p>But when I tried to run deviceQueryDrv, it got error.</p><div class="codebox"><pre><code>CUDA_ERROR_INVALID_DEVICE (device specified is not a valid CUDA device)</code></pre></div><p>So I downgrade my SDK version to 5.5, because GTX480 is old GPU, some functions in 6.0 may not support.<br />When I installed 5.5, and compile ver 5.5 samples, still got a same error while I ran deviceQueryDrv.</p><p>But before that, I can run CUDA while guest OS is Windows 7. And it can get matrix multiply result.<br />Maybe it&#039;s driver and SDK compatible problem (if it is VFIO problem, graphic driver will got issue first. Neither NVIDIA offical driver nor Nouveau.)</p></div></blockquote></div><p>Also I found that if I using Ubuntu 12.04 as guest OS, it always came out these message:</p><div class="codebox"><pre><code>[81.114285] kvm [1993]: vcpu0 unhandled wrmsr: 0xxxx data 0</code></pre></div><p>And here is my dmesg.<br /><a href="https://mega.co.nz/#!d5EywB4A!UaUBbqd9FE1G84E-mZEclg0TuyeVjLkrmZ--D3jrYFk" rel="nofollow">dmesg download</a></p><p>Hope it can solve reboot hangs when I using Ubuntu as guest OS.</p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1417646">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1417677" class="blockpost roweven"> <h2><span><span class="conr">#1737</span> <a href="viewtopic.php?pid=1417677#p1417677">2014-05-21 08:32:10</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=78080">Slabity</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2013-12-29</span></dd> <dd><span>Posts: 40</span></dd> <dd class="usercontacts"><span class="email"><a href="mailto:tslabinski@mygsc.com">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <p>Hey all, so I&#039;m having some trouble. I feel like I&#039;m close to finishing this, but the qemu test does not display video though my passthrough&#039;d card. And in my Windows guest OS, it disables the card because it&#039;s &quot;not functioning correctly&quot;:</p><p><a href="https://i.imgur.com/inKbcua.png" rel="nofollow">https://i.imgur.com/inKbcua.png</a></p><p>Here&#039;s my dmesg | grep pci-stub:</p><div class="codebox"><pre><code>[ 0.000000] Command line: root=/dev/sda2 rw initrd=/initramfs-linux-mainline.img pcie_acs_override=downstream intel_iommu=on pci-stub.ids=10de:1004,10de:0e1a [ 0.000000] Kernel command line: root=/dev/sda2 rw initrd=/initramfs-linux-mainline.img pcie_acs_override=downstream intel_iommu=on pci-stub.ids=10de:1004,10de:0e1a [ 0.438320] pci-stub: add 10DE:1004 sub=FFFFFFFF:FFFFFFFF cls=00000000/00000000 [ 0.438326] pci-stub 0000:02:00.0: claimed by stub [ 0.438329] pci-stub: add 10DE:0E1A sub=FFFFFFFF:FFFFFFFF cls=00000000/00000000 [ 0.438333] pci-stub 0000:02:00.1: claimed by stub</code></pre></div><p>Anyone got any ideas?</p> <p class="postedit"><em>Last edited by Slabity (2014-05-22 06:12:08)</em></p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1417677">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1417710" class="blockpost rowodd"> <h2><span><span class="conr">#1738</span> <a href="viewtopic.php?pid=1417710#p1417710">2014-05-21 11:26:32</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=79578">AKSN74</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd class="postavatar"><img src="https://bbs.archlinux.org/img/avatars/79578.jpg?m=1423108340" width="80" height="80" alt="" /></dd> <dd><span>From: Taichung, Taiwan</span></dd> <dd><span>Registered: 2014-02-18</span></dd> <dd><span>Posts: 52</span></dd> <dd class="usercontacts"><span class="email"><a href="mailto:missile0407@gmail.com">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>Slabity wrote:</cite><blockquote><div><p>Hey all, so I&#039;m having some trouble. I feel like I&#039;m close to finishing this, but the qemu test does not display video though my passthrough&#039;d card. And in my Windows guest OS, it disables the card because it&#039;s &quot;not functioning correctly&quot;:</p><p><a href="https://i.imgur.com/inKbcua.png" rel="nofollow">https://i.imgur.com/inKbcua.png</a></p><p>Here&#039;s my dmesg | grep pci-stub:</p><div class="codebox"><pre><code>[ 0.000000] Command line: root=/dev/sda2 rw initrd=/initramfs-linux-mainline.img pcie_acs_override=downstream intel_iommu=on pci-stub.ids=10de:1004,10de:0e1a [ 0.000000] Kernel command line: root=/dev/sda2 rw initrd=/initramfs-linux-mainline.img pcie_acs_override=downstream intel_iommu=on pci-stub.ids=10de:1004,10de:0e1a [ 0.438320] pci-stub: add 10DE:1004 sub=FFFFFFFF:FFFFFFFF cls=00000000/00000000 [ 0.438326] pci-stub 0000:02:00.0: claimed by stub [ 0.438329] pci-stub: add 10DE:0E1A sub=FFFFFFFF:FFFFFFFF cls=00000000/00000000 [ 0.438333] pci-stub 0000:02:00.1: claimed by stub</code></pre></div><p>Anyone got any ideas?</p></div></blockquote></div><p>Looks like you&#039;re using virtual display right?<br />You need to disable virtual display, and plug a cable on your graphic card that you mounted.<br />Also, can you show us your launch command?</p> <p class="postedit"><em>Last edited by AKSN74 (2014-05-21 11:27:38)</em></p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1417710">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1417805" class="blockpost roweven"> <h2><span><span class="conr">#1739</span> <a href="viewtopic.php?pid=1417805#p1417805">2014-05-21 16:19:07</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=78080">Slabity</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2013-12-29</span></dd> <dd><span>Posts: 40</span></dd> <dd class="usercontacts"><span class="email"><a href="mailto:tslabinski@mygsc.com">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>AKSN74 wrote:</cite><blockquote><div><p>Looks like you&#039;re using virtual display right?<br />You need to disable virtual display, and plug a cable on your graphic card that you mounted.<br />Also, can you show us your launch command?</p></div></blockquote></div><p>Well, if I run the example qemu script:</p><div class="codebox"><pre><code>qemu-system-x86_64 -enable-kvm -M q35 -m 1024 -cpu host \ -smp 6,sockets=1,cores=6,threads=1 \ -bios /usr/share/qemu/bios.bin -vga none \ -device ioh3420,bus=pcie.0,addr=1c.0,multifunction=on,port=1,chassis=1,id=root.1 \ -device vfio-pci,host=02:00.0,bus=root.1,addr=00.0,multifunction=on,x-vga=on \ -device vfio-pci,host=02:00.1,bus=root.1,addr=00.1</code></pre></div><p>In the above case, a black window appears with nothing in it. Nothing appears on my monitor attached through the passthrough&#039;d card.</p><p>I am running the Windows VM through Virt-manager. Here&#039;s my configuration file:</p><p><a href="http://pastebin.com/zJ4CbqZc" rel="nofollow">http://pastebin.com/zJ4CbqZc</a></p><p>I try to remove the &lt;video&gt; section, but it seems to add itself back each time I run virt-manager.</p><p>EDIT: It seems the qemu script creates a black window, but if I type anything or resize the window, the window displays a console with the following:</p><div class="codebox"><pre><code>compat_monitor0 console QEMU 2.0.0 monitor - type &#039;help&#039; for more information&#039; (qemu)</code></pre></div><p>How is that possible if the script disables vga?</p> <p class="postedit"><em>Last edited by Slabity (2014-05-21 16:32:15)</em></p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1417805">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1417831" class="blockpost rowodd"> <h2><span><span class="conr">#1740</span> <a href="viewtopic.php?pid=1417831#p1417831">2014-05-21 17:30:57</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=70922">nbhs</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd class="postavatar"><img src="https://bbs.archlinux.org/img/avatars/70922.jpg?m=1367773811" width="80" height="80" alt="" /></dd> <dd><span>From: Montevideo, Uruguay</span></dd> <dd><span>Registered: 2013-05-02</span></dd> <dd><span>Posts: 402</span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>Slabity wrote:</cite><blockquote><div><div class="quotebox"><cite>AKSN74 wrote:</cite><blockquote><div><p>Looks like you&#039;re using virtual display right?<br />You need to disable virtual display, and plug a cable on your graphic card that you mounted.<br />Also, can you show us your launch command?</p></div></blockquote></div><p>Well, if I run the example qemu script:</p><div class="codebox"><pre><code>qemu-system-x86_64 -enable-kvm -M q35 -m 1024 -cpu host \ -smp 6,sockets=1,cores=6,threads=1 \ -bios /usr/share/qemu/bios.bin -vga none \ -device ioh3420,bus=pcie.0,addr=1c.0,multifunction=on,port=1,chassis=1,id=root.1 \ -device vfio-pci,host=02:00.0,bus=root.1,addr=00.0,multifunction=on,x-vga=on \ -device vfio-pci,host=02:00.1,bus=root.1,addr=00.1</code></pre></div><p>In the above case, a black window appears with nothing in it. Nothing appears on my monitor attached through the passthrough&#039;d card.</p><p>I am running the Windows VM through Virt-manager. Here&#039;s my configuration file:</p><p><a href="http://pastebin.com/zJ4CbqZc" rel="nofollow">http://pastebin.com/zJ4CbqZc</a></p><p>I try to remove the &lt;video&gt; section, but it seems to add itself back each time I run virt-manager.</p><p>EDIT: It seems the qemu script creates a black window, but if I type anything or resize the window, the window displays a console with the following:</p><div class="codebox"><pre><code>compat_monitor0 console QEMU 2.0.0 monitor - type &#039;help&#039; for more information&#039; (qemu)</code></pre></div><p>How is that possible if the script disables vga?</p></div></blockquote></div><p>Are you using the i915 vga arbiter patch?</p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1417831">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1417855" class="blockpost roweven"> <h2><span><span class="conr">#1741</span> <a href="viewtopic.php?pid=1417855#p1417855">2014-05-21 18:13:13</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=78080">Slabity</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2013-12-29</span></dd> <dd><span>Posts: 40</span></dd> <dd class="usercontacts"><span class="email"><a href="mailto:tslabinski@mygsc.com">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>nbhs wrote:</cite><blockquote><div><p>Are you using the i915 vga arbiter patch?</p></div></blockquote></div><p>I believe so. I&#039;m using the linux-mainline from the first post. The makepkg command automatically patches it, right? Then I just used pacman -U to install the kernel and change my boot command to use that kernel.</p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1417855">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1417920" class="blockpost rowodd"> <h2><span><span class="conr">#1742</span> <a href="viewtopic.php?pid=1417920#p1417920">2014-05-21 21:00:19</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=81948">thehighhat</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2014-05-12</span></dd> <dd><span>Posts: 5</span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>AKSN74 wrote:</cite><blockquote><div><div class="quotebox"><cite>aw wrote:</cite><blockquote><div><p>Upgrade to 3.15 and you won&#039;t need the ACS override patch.&#160; That doesn&#039;t mean that the Marvell card is going to work, because it&#039;s terribly broken (remember those DMA patches you&#039;ve applied?)</p></div></blockquote></div><p>Hi, aw.</p><p>I found that not only VM hangs when reboot with 2 VMs working together, but also only 1 VM working.</p><p>And I tried to shutdown, not reboot, it can back to tty successfully.<br />But when I try to start again with same command, it got another error message.</p><div class="codebox"><pre><code>qemu-system-x86_64: vfio-pci: Cannot read device rom at 0000:03:00.0 Device option ROM contents are probably invalid (check dmesg). Skip option ROM probe with rombar=0, or load from file with romfile=</code></pre></div><p>It&#039;s may a reason why it hangs when reboot.<br />But I found that when&#160; I reboot VM while guest OS is Windows 7, it can reboot successfully some times.<br />So it is very strange for this problem.......</p><p>I&#039;ll try to use 3.14.4 kernel and see it still a same problem or not.</p></div></blockquote></div><br /><p>Same problem here.&#160; I cannot reboot or reissue the qemu command without this error.&#160; Do I need to undo the vfio-bind stuffs?</p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1417920">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1417981" class="blockpost roweven"> <h2><span><span class="conr">#1743</span> <a href="viewtopic.php?pid=1417981#p1417981">2014-05-22 01:44:38</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=82181">esmth</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2014-05-22</span></dd> <dd><span>Posts: 4</span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <p>Hey guys, first post here. I&#039;m having some trouble trying to get this to work correctly. My hardware supports IOMMU and it is enabled in the BIOS, and the IOMMU kernel driver loads. My system specs are here: AMD A10-7850k, Gigabyte F2A88X-D3H. I&#039;m using the integrated graphics as the host, and i&#039;m passing though a reference R9-290x. I also have older GPUs i&#039;ve tested that cause the same issue.&#160; The problem is that when I run the command to start the VM, the colors on the host&#039;s monitor become distorted, and the 2nd monitor connected to the passed though GPU turns on, and sometimes gets passed the seabios screen and onto the&#160; OS and then freezes the host and guest, sometimes it doesn&#039;t, and the both the guest and host freeze. When the PC freezes, it seems like everything connected to the PCI bus is down, but the host is still running (the terminal cursor on the host continues to blink), while the guest also seems to be frozen. </p><p>I use this command to start the guest:</p><div class="codebox"><pre><code>sudo su bin/vfio-bind 0000:01:00:0 0000:01:00.1 ./qemu-system-x86_64 -enable-kvm -M q35 -m 1024 -cpu host -smp 6,sockets=1,cores=6,threads=1 -bios /home/esmth/src/seabios/out/bios.bin -vga std -device ioh3420,bus=pcie.0,addr=1c.0,multifunction=on,port=1,chassis=1,id=root.1 -device vfio-pci,host=01:00.0,bus=root.1,addr=00.0,multifunction=on,x-vga=on -device vfio-pci,host=01:00.1,bus=root.1,addr=00.1 -drive file=/home/esmth/image.img,id=disk,format=raw -device ide-hd,bus=ide.0,drive=disk -drive file=/home/esmth/tmp/windows.iso,id=isocd -device ide-cd,bus=ide.1,drive=isocd -usb -usbdevice host:046d:c52b</code></pre></div><p>if anyone can help, it&#039;d be appreciated, thanks</p><p>edit: i git clone&#039;d both seabios and qemu and compiled them , and am running kernel 3.15rc5 with the vfio and iommu options enabled</p> <p class="postedit"><em>Last edited by esmth (2014-05-22 12:59:21)</em></p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1417981">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1418037" class="blockpost rowodd"> <h2><span><span class="conr">#1744</span> <a href="viewtopic.php?pid=1418037#p1418037">2014-05-22 06:05:02</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=81794">Destroy</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2014-05-05</span></dd> <dd><span>Posts: 10</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=81794">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>aw wrote:</cite><blockquote><div><p>Upgrade to 3.15 and you won&#039;t need the ACS override patch.&#160; That doesn&#039;t mean that the Marvell card is going to work, because it&#039;s terribly broken (remember those DMA patches you&#039;ve applied?)</p></div></blockquote></div><p>1.- I&#039;ve compiled 3.15-rc5 but after boot, it gave me error with the Marvell card as you say.<br />2.- I&#039;ve tried to applied the same patch for the Marvell card but it gave me one error <br />cat intel-iommu.c.rej</p><div class="codebox"><pre><code>--- drivers/iommu/intel-iommu.c +++ drivers/iommu/intel-iommu.c @@ -3878,6 +3990,9 @@ iommu_disable_dev_iotlb(info); iommu_detach_dev(iommu, info-&gt;bus, info-&gt;devfn); iommu_detach_dependent_devices(iommu, pdev); + quirk_unmap_multi_requesters(pdev, + pci_multi_requesters(pdev)); + quirk_unmap_requester_id(pdev); free_devinfo_mem(info); spin_lock_irqsave(&amp;device_domain_lock, flags);</code></pre></div><p>so I manually edit the file and added the lines closes to line 4197 and compiled it but I had an error</p><div class="codebox"><pre class="vscroll"><code> CC drivers/iommu/intel-iommu.o drivers/iommu/intel-iommu.c: In function &#039;quirk_unmap_multi_requesters&#039;: drivers/iommu/intel-iommu.c:1850:7: warning: passing argument 1 of &#039;device_to_iommu&#039; makes pointer from integer without a cast [enabled by default] pdev-&gt;bus-&gt;number, pdev-&gt;devfn); ^ drivers/iommu/intel-iommu.c:667:28: note: expected &#039;struct device *&#039; but argument is of type &#039;int&#039; static struct intel_iommu *device_to_iommu(struct device *dev, u8 *bus, u8 *devfn) ^ drivers/iommu/intel-iommu.c:1850:7: warning: passing argument 2 of &#039;device_to_iommu&#039; makes pointer from integer without a cast [enabled by default] pdev-&gt;bus-&gt;number, pdev-&gt;devfn); ^ drivers/iommu/intel-iommu.c:667:28: note: expected &#039;u8 *&#039; but argument is of type &#039;unsigned char&#039; static struct intel_iommu *device_to_iommu(struct device *dev, u8 *bus, u8 *devfn) ^ drivers/iommu/intel-iommu.c:1850:7: warning: passing argument 3 of &#039;device_to_iommu&#039; makes pointer from integer without a cast [enabled by default] pdev-&gt;bus-&gt;number, pdev-&gt;devfn); ^ drivers/iommu/intel-iommu.c:667:28: note: expected &#039;u8 *&#039; but argument is of type &#039;unsigned int&#039; static struct intel_iommu *device_to_iommu(struct device *dev, u8 *bus, u8 *devfn) ^ drivers/iommu/intel-iommu.c: In function &#039;quirk_map_multi_requester_ids&#039;: drivers/iommu/intel-iommu.c:1888:6: warning: passing argument 2 of &#039;domain_context_mapping_one&#039; makes pointer from integer without a cast [enabled by default] translation); ^ drivers/iommu/intel-iommu.c:1718:12: note: expected &#039;struct intel_iommu *&#039; but argument is of type &#039;int&#039; static int domain_context_mapping_one(struct dmar_domain *domain, ^ drivers/iommu/intel-iommu.c: In function &#039;quirk_unmap_requester_id&#039;: drivers/iommu/intel-iommu.c:1907:7: warning: passing argument 1 of &#039;device_to_iommu&#039; makes pointer from integer without a cast [enabled by default] pdev-&gt;bus-&gt;number, pdev-&gt;devfn); ^ drivers/iommu/intel-iommu.c:667:28: note: expected &#039;struct device *&#039; but argument is of type &#039;int&#039; static struct intel_iommu *device_to_iommu(struct device *dev, u8 *bus, u8 *devfn) ^ drivers/iommu/intel-iommu.c:1907:7: warning: passing argument 2 of &#039;device_to_iommu&#039; makes pointer from integer without a cast [enabled by default] pdev-&gt;bus-&gt;number, pdev-&gt;devfn); ^ drivers/iommu/intel-iommu.c:667:28: note: expected &#039;u8 *&#039; but argument is of type &#039;unsigned char&#039; static struct intel_iommu *device_to_iommu(struct device *dev, u8 *bus, u8 *devfn) ^ drivers/iommu/intel-iommu.c:1907:7: warning: passing argument 3 of &#039;device_to_iommu&#039; makes pointer from integer without a cast [enabled by default] pdev-&gt;bus-&gt;number, pdev-&gt;devfn); ^ drivers/iommu/intel-iommu.c:667:28: note: expected &#039;u8 *&#039; but argument is of type &#039;unsigned int&#039; static struct intel_iommu *device_to_iommu(struct device *dev, u8 *bus, u8 *devfn) ^ drivers/iommu/intel-iommu.c: In function &#039;quirk_map_requester_id&#039;: drivers/iommu/intel-iommu.c:1933:4: warning: passing argument 2 of &#039;domain_context_mapping_one&#039; makes pointer from integer without a cast [enabled by default] translation); ^ drivers/iommu/intel-iommu.c:1718:12: note: expected &#039;struct intel_iommu *&#039; but argument is of type &#039;int&#039; static int domain_context_mapping_one(struct dmar_domain *domain, ^ drivers/iommu/intel-iommu.c: In function &#039;domain_remove_one_dev_info&#039;: drivers/iommu/intel-iommu.c:4197:33: error: &#039;pdev&#039; undeclared (first use in this function) quirk_unmap_multi_requesters(pdev, ^ drivers/iommu/intel-iommu.c:4197:33: note: each undeclared identifier is reported only once for each function it appears in make[2]: 1.sh topic_10.html topic_11.html topic_12.html topic_13.html topic_14.html topic_15.html topic_16.html topic_17.html topic_18.html topic_19.html topic_1.html topic_20.html topic_21.html topic_22.html topic_23.html topic_24.html topic_25.html topic_26.html topic_27.html topic_28.html topic_29.html topic_2.html topic_30.html topic_31.html topic_32.html topic_33.html topic_34.html topic_35.html topic_36.html topic_37.html topic_38.html topic_39.html topic_3.html topic_40.html topic_41.html topic_42.html topic_43.html topic_44.html topic_45.html topic_46.html topic_47.html topic_48.html topic_49.html topic_4.html topic_50.html topic_51.html topic_52.html topic_53.html topic_54.html topic_55.html topic_56.html topic_57.html topic_58.html topic_59.html topic_5.html topic_60.html topic_61.html topic_62.html topic_63.html topic_64.html topic_65.html topic_66.html topic_67.html topic_68.html topic_69.html topic_6.html topic_7.html topic_8.html topic_9.html [drivers/iommu/intel-iommu.o] Error 1 make[1]: 1.sh topic_10.html topic_11.html topic_12.html topic_13.html topic_14.html topic_15.html topic_16.html topic_17.html topic_18.html topic_19.html topic_1.html topic_20.html topic_21.html topic_22.html topic_23.html topic_24.html topic_25.html topic_26.html topic_27.html topic_28.html topic_29.html topic_2.html topic_30.html topic_31.html topic_32.html topic_33.html topic_34.html topic_35.html topic_36.html topic_37.html topic_38.html topic_39.html topic_3.html topic_40.html topic_41.html topic_42.html topic_43.html topic_44.html topic_45.html topic_46.html topic_47.html topic_48.html topic_49.html topic_4.html topic_50.html topic_51.html topic_52.html topic_53.html topic_54.html topic_55.html topic_56.html topic_57.html topic_58.html topic_59.html topic_5.html topic_60.html topic_61.html topic_62.html topic_63.html topic_64.html topic_65.html topic_66.html topic_67.html topic_68.html topic_69.html topic_6.html topic_7.html topic_8.html topic_9.html [drivers/iommu] Error 2 make: 1.sh topic_10.html topic_11.html topic_12.html topic_13.html topic_14.html topic_15.html topic_16.html topic_17.html topic_18.html topic_19.html topic_1.html topic_20.html topic_21.html topic_22.html topic_23.html topic_24.html topic_25.html topic_26.html topic_27.html topic_28.html topic_29.html topic_2.html topic_30.html topic_31.html topic_32.html topic_33.html topic_34.html topic_35.html topic_36.html topic_37.html topic_38.html topic_39.html topic_3.html topic_40.html topic_41.html topic_42.html topic_43.html topic_44.html topic_45.html topic_46.html topic_47.html topic_48.html topic_49.html topic_4.html topic_50.html topic_51.html topic_52.html topic_53.html topic_54.html topic_55.html topic_56.html topic_57.html topic_58.html topic_59.html topic_5.html topic_60.html topic_61.html topic_62.html topic_63.html topic_64.html topic_65.html topic_66.html topic_67.html topic_68.html topic_69.html topic_6.html topic_7.html topic_8.html topic_9.html [drivers] Error 2</code></pre></div><p>So I&#039;ll wait for more of your magic AW <img src="https://bbs.archlinux.org/img/smilies/big_smile.png" width="15" height="15" alt="big_smile" /><br />Thanks again for your harder work</p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1418037">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1418039" class="blockpost roweven"> <h2><span><span class="conr">#1745</span> <a href="viewtopic.php?pid=1418039#p1418039">2014-05-22 06:10:11</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=78080">Slabity</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2013-12-29</span></dd> <dd><span>Posts: 40</span></dd> <dd class="usercontacts"><span class="email"><a href="mailto:tslabinski@mygsc.com">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <p>So I&#039;ve completely reset my system from scratch to see if I could fix my issue. I still do not get any output on my passthrough&#039;d VGA card.</p><p>Here is the qemu command I&#039;m running:</p><div class="codebox"><pre><code>qemu-system-x86_64 -enable-kvm -M q35 -m 1024 -cpu host \ -smp 6,sockets=1,cores=6,threads=1 \ -bios /usr/share/qemu/bios.bin -vga none \ -device ioh3420,bus=pcie.0,addr=1c.0,multifunction=on,port=1,chassis=1,id=root.1 \ -device vfio-pci,host=02:00.0,bus=root.1,addr=00.0,multifunction=on,x-vga=on \ -device vfio-pci,host=02:00.1,bus=root.1,addr=00.1</code></pre></div><p>The result is a blank window with nothing being displayed on the monitor.</p><p>My host is running off of a Radeon HD 6870 with open-source drivers. My passthrough card is a Geforce 780:</p><div class="codebox"><pre><code>$ lspci -v 02:00.0 VGA compatible controller: NVIDIA Corporation GK110 [GeForce GTX 780] (rev a1) (prog-if 00 [VGA controller]) Subsystem: eVga.com. Corp. Device 2784 Flags: fast devsel, IRQ 17 Memory at ee000000 (32-bit, non-prefetchable) [size=16M] Memory at e0000000 (64-bit, prefetchable) [size=128M] Memory at e8000000 (64-bit, prefetchable) [size=32M] I/O ports at d000 [size=128] Expansion ROM at ef000000 [disabled] [size=512K] Capabilities: &lt;access denied&gt; Kernel driver in use: vfio-pci Kernel modules: nouveau 02:00.1 Audio device: NVIDIA Corporation GK110 HDMI Audio (rev a1) Subsystem: eVga.com. Corp. Device 2784 Flags: fast devsel, IRQ 18 Memory at ef080000 (32-bit, non-prefetchable) [size=16K] Capabilities: &lt;access denied&gt; Kernel driver in use: vfio-pci Kernel modules: snd_hda_intel</code></pre></div><div class="codebox"><pre><code>$ lspci -n 01:00.0 0300: 1002:6738 01:00.1 0403: 1002:aa88 02:00.0 0300: 10de:1004 (rev a1) 02:00.1 0403: 10de:0e1a (rev a1)</code></pre></div><p>My kernel&#039;s command line is:</p><div class="codebox"><pre><code>root=/dev/sda2 rw initrd=/initramfs-linux-mainline.img pci-stub.ids=10de:1004,10de:0e1a intel_iommu=on pcie_acs_override=downstream</code></pre></div><p>I see some other people had similar issues but didn&#039;t report a solution. Is there something fundamental that I&#039;m missing here?</p> <p class="postedit"><em>Last edited by Slabity (2014-05-22 06:18:33)</em></p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1418039">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1418047" class="blockpost rowodd"> <h2><span><span class="conr">#1746</span> <a href="viewtopic.php?pid=1418047#p1418047">2014-05-22 06:39:44</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=79237">mbroemme</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>From: Cologne</span></dd> <dd><span>Registered: 2014-02-05</span></dd> <dd><span>Posts: 39</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=79237">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>Slabity wrote:</cite><blockquote><div><p>So I&#039;ve completely reset my system from scratch to see if I could fix my issue. I still do not get any output on my passthrough&#039;d VGA card.</p><p>Here is the qemu command I&#039;m running:</p><div class="codebox"><pre><code>qemu-system-x86_64 -enable-kvm -M q35 -m 1024 -cpu host \ -smp 6,sockets=1,cores=6,threads=1 \ -bios /usr/share/qemu/bios.bin -vga none \ -device ioh3420,bus=pcie.0,addr=1c.0,multifunction=on,port=1,chassis=1,id=root.1 \ -device vfio-pci,host=02:00.0,bus=root.1,addr=00.0,multifunction=on,x-vga=on \ -device vfio-pci,host=02:00.1,bus=root.1,addr=00.1</code></pre></div><p>The result is a blank window with nothing being displayed on the monitor.</p><p>My host is running off of a Radeon HD 6870 with open-source drivers. My passthrough card is a Geforce 780:</p></div></blockquote></div><p>I had similar troubles in the past with my AMD R9 290X inside guest and what helped me to get it fairly stable (at least for the first boot of VM as AMD Radeon cards are known to not support proper reset) was to boot my host with VGA enabled on card used for passthrough. So I changed in BIOS that my R9 290X will show the host BIOS post, boot the system and after binding this card to VFIO during boot it loads radeon driver for my second card (HD 7870) which works now as my Linux primary card. After this change my VM always allows me to use x-vga=on and shows SeaBIOS screen.</p><p>If I boot my system with second HD 7870 enabled as primary device in BIOS I was not able to use x-vga=on ever for the R9 290X.</p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1418047">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1418048" class="blockpost roweven"> <h2><span><span class="conr">#1747</span> <a href="viewtopic.php?pid=1418048#p1418048">2014-05-22 06:42:11</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=79237">mbroemme</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>From: Cologne</span></dd> <dd><span>Registered: 2014-02-05</span></dd> <dd><span>Posts: 39</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=79237">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>esmth wrote:</cite><blockquote><div><div class="codebox"><pre><code>sudo su bin/vfio-bind 0000:01:00:0 0000:01:00.1 ./qemu-system-x86_64 -enable-kvm -M q35 -m 1024 -cpu host -smp 6,sockets=1,cores=6,threads=1 -bios /home/esmth/src/seabios/out/bios.bin -vga std -device ioh3420,bus=pcie.0,addr=1c.0,multifunction=on,port=1,chassis=1,id=root.1 -device vfio-pci,host=01:00.0,bus=root.1,addr=00.0,multifunction=on,x-vga=on -device vfio-pci,host=01:00.1,bus=root.1,addr=00.1 -drive file=/home/esmth/image.img,id=disk,format=raw -device ide-hd,bus=ide.0,drive=disk -drive file=/home/esmth/tmp/Windows_8.1_Pro_X64_Activated_Final/Windows_8.1_Pro_X64_Activated.iso,id=isocd -device ide-cd,bus=ide.1,drive=isocd -usb -usbdevice host:046d:c52b</code></pre></div><p>if anyone can help, it&#039;d be appreciated, thanks</p></div></blockquote></div><p>Could you try to use it with</p><div class="codebox"><pre><code>-vga none</code></pre></div> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1418048">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1418049" class="blockpost rowodd"> <h2><span><span class="conr">#1748</span> <a href="viewtopic.php?pid=1418049#p1418049">2014-05-22 06:44:52</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=82094">Namelles_One</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2014-05-18</span></dd> <dd><span>Posts: 8</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=82094">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <p>So, now please help me another way)</p><p>With VGA - all is good, but audio&#160; - not(</p><p>In host Linus (I use ALSA) - all is good and best quality, but in Windows guest - quality is ugly, sound is like a frog - &quot;He-quauq-llo!&quot; 0_o</p><p>Where is problem may be?</p><p>P.S. I use </p><div class="codebox"><pre><code>QEMU_ALSA_DAC_BUFFER_SIZE=512 QEMU_ALSA_DAC_PERIOD_SIZE=170 QEMU_AUDIO_DRV=alsa</code></pre></div><p> and </p><div class="codebox"><pre><code>-device ich9-intel-hda,bus=pcie.0,addr=1b.0,id=sound0 -device hda-duplex,id=sound0-codec0,bus=sound0.0,cad=0 </code></pre></div> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1418049">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1418074" class="blockpost roweven"> <h2><span><span class="conr">#1749</span> <a href="viewtopic.php?pid=1418074#p1418074">2014-05-22 09:13:04</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=82191">IyaFR</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2014-05-22</span></dd> <dd><span>Posts: 1</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=82191">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <p>It&#039;s possible to do this vga-passthrough with 1 gpu. I boot in multi-user.target and&#160; i have modify my grub for enable the serial mode.<br />in grub.cfg:<br />terminal_input serial<br />terminal_output serial</p><p>And in the menuentry:<br />linux&#160; &#160; .... quiet&#160; APPEND console=ttyS0 </p><p>After that, i run my vm with a ssh access.</p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1418074">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1418085" class="blockpost rowodd"> <h2><span><span class="conr">#1750</span> <a href="viewtopic.php?pid=1418085#p1418085">2014-05-22 10:29:19</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=81745">siddharta</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2014-05-03</span></dd> <dd><span>Posts: 30</span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <p>Hi,</p><p>I&#039;ve had partial success so far with passing through an AMD 6450 on an Asrock H61 and i5-2400. Partial success meaning I can get it to work invoking qemu directly but I can&#039;t get it working when using libvirt. There is no other discrete graphics present, the integrated graphics is for the host.</p><p>The kernel is 3.14 recompiled with vfio flags set and the i915 VGA arbiter patch applied, qemu version 2.0.0 and seabios version 1.7.4</p><p>lsgroups.sh shows</p><div class="codebox"><pre><code>### Group 1 ### 00:01.0 PCI bridge: Intel Corporation Xeon E3-1200/2nd Generation Core Processor Family PCI Express Root Port (rev 09) 01:00.0 VGA compatible controller: Advanced Micro Devices, Inc. [AMD/ATI] Caicos [Radeon HD 6450/7450/8450] 01:00.1 Audio device: Advanced Micro Devices, Inc. [AMD/ATI] Caicos HDMI Audio [Radeon HD 6400 Series]</code></pre></div><p>&#160; &#160; <br />hwinfo --gfxcard shows the 6450 (which is not the primary card) bound to vfio-pci (done through vfio-bind.sh 0000:01:00.0 0000:01:00.1)</p><div class="codebox"><pre><code>20: PCI 100.0: 0300 VGA compatible controller (VGA) SysFS ID: /devices/pci0000:00/0000:00:01.0/0000:01:00.0 SysFS BusID: 0000:01:00.0 Hardware Class: graphics card Model: &quot;ATI VGA compatible controller&quot; Vendor: pci 0x1002 &quot;ATI Technologies Inc&quot; Device: pci 0x6779 SubVendor: pci 0x1043 &quot;ASUSTeK Computer Inc.&quot; SubDevice: pci 0x047b Driver: &quot;vfio-pci&quot; Driver Modules: &quot;vfio_pci&quot; Memory Range: 0xe0000000-0xefffffff (ro,non-prefetchable,disabled) Memory Range: 0xf7c20000-0xf7c3ffff (rw,non-prefetchable,disabled) I/O Ports: 0xe000-0xefff (rw,disabled) Memory Range: 0xf7c00000-0xf7c1ffff (ro,non-prefetchable,disabled) IRQ: 11 (no events) Module Alias: &quot;pci:v00001002d00006779sv00001043sd0000047Bbc03sc00i00&quot; Driver Info #0: Driver Status: radeon is not active Driver Activation Cmd: &quot;modprobe radeon&quot; Config Status: cfg=no, avail=yes, need=no, active=unknown Attached to: #9 (PCI bridge) Primary display adapter: #10</code></pre></div><p>ls -l /sys/bus/pci/drivers/vfio-pci/ looks well </p><div class="codebox"><pre><code>total 0 lrwxrwxrwx 1 root root 0 May 22 11:14 0000:01:00.0 -&gt; ../../../../devices/pci0000:00/0000:00:01.0/0000:01:00.0 lrwxrwxrwx 1 root root 0 May 22 11:14 0000:01:00.1 -&gt; ../../../../devices/pci0000:00/0000:00:01.0/0000:01:00.1 --w------- 1 root root 4096 May 22 11:14 bind lrwxrwxrwx 1 root root 0 May 22 11:14 module -&gt; ../../../../module/vfio_pci --w------- 1 root root 4096 May 22 11:14 new_id --w------- 1 root root 4096 May 22 11:14 remove_id --w------- 1 root root 4096 May 22 11:14 uevent --w------- 1 root root 4096 May 22 11:14 unbind</code></pre></div><p>&#160; <br />Invoking qemu as </p><div class="codebox"><pre><code>qemu-system-x86_64 -enable-kvm -M q35 -m 512 \ -smp 1,sockets=1,cores=1,threads=1 \ -bios /usr/share/qemu/bios.bin -vga none \ -device ioh3420,bus=pcie.0,addr=1c.0,multifunction=on,port=1,chassis=1,id=root.1 \ -device vfio-pci,host=01:00.0,bus=root.1,addr=00.0,multifunction=on,x-vga=on \ -device vfio-pci,host=01:00.1,bus=root.1,addr=00.1 </code></pre></div><p>works (showing seabios output on the display attached to the 6450) with dmesg | grep -e vfio showing</p><div class="codebox"><pre><code>[ 526.686460] vfio-pci 0000:01:00.0: enabling device (0000 -&gt; 0003)</code></pre></div><p>but! When I attempt to start a libvirt managed guest defined from the following xml (note that here I&#039;m not including the HDMI audio device)</p><div class="codebox"><pre class="vscroll"><code>&lt;domain type=&#039;kvm&#039; xmlns:qemu=&#039;http://libvirt.org/schemas/domain/qemu/1.0&#039;&gt; &lt;name&gt;test&lt;/name&gt; &lt;uuid&gt;c4658435-dfb4-4c8d-afc2-f9dfad2e10f0&lt;/uuid&gt; &lt;memory unit=&#039;KiB&#039;&gt;524288&lt;/memory&gt; &lt;currentMemory unit=&#039;KiB&#039;&gt;524288&lt;/currentMemory&gt; &lt;vcpu placement=&#039;static&#039;&gt;1&lt;/vcpu&gt; &lt;os&gt; &lt;type arch=&#039;x86_64&#039; machine=&#039;q35&#039;&gt;hvm&lt;/type&gt; &lt;loader&gt;/usr/share/qemu/bios.bin&lt;/loader&gt; &lt;/os&gt; &lt;features&gt; &lt;acpi/&gt; &lt;/features&gt; &lt;cpu&gt; &lt;topology sockets=&#039;1&#039; cores=&#039;1&#039; threads=&#039;1&#039;/&gt; &lt;/cpu&gt; &lt;clock offset=&#039;utc&#039;/&gt; &lt;on_poweroff&gt;destroy&lt;/on_poweroff&gt; &lt;on_reboot&gt;restart&lt;/on_reboot&gt; &lt;on_crash&gt;destroy&lt;/on_crash&gt; &lt;devices&gt; &lt;emulator&gt;/usr/bin/qemu-system-x86_64&lt;/emulator&gt; &lt;controller type=&#039;sata&#039; index=&#039;0&#039;/&gt; &lt;controller type=&#039;pci&#039; index=&#039;0&#039; model=&#039;pcie-root&#039;/&gt; &lt;controller type=&#039;pci&#039; index=&#039;1&#039; model=&#039;dmi-to-pci-bridge&#039;/&gt; &lt;controller type=&#039;pci&#039; index=&#039;2&#039; model=&#039;pci-bridge&#039;/&gt; &lt;input type=&#039;mouse&#039; bus=&#039;ps2&#039;/&gt; &lt;input type=&#039;keyboard&#039; bus=&#039;ps2&#039;/&gt; &lt;memballoon model=&#039;virtio&#039;&gt; &lt;address type=&#039;pci&#039; domain=&#039;0x0000&#039; bus=&#039;0x02&#039; slot=&#039;0x05&#039; function=&#039;0x0&#039;/&gt; &lt;/memballoon&gt; &lt;/devices&gt; &lt;qemu:commandline&gt; &lt;qemu:arg value=&#039;-device&#039;/&gt; &lt;qemu:arg value=&#039;ioh3420,bus=pcie.0,addr=1c.0,multifunction=on,port=1,chassis=1,id=root.1&#039;/&gt; &lt;qemu:arg value=&#039;-device&#039;/&gt; &lt;qemu:arg value=&#039;vfio-pci,host=01:00.0,bus=root.1,addr=00.0,multifunction=on,x-vga=on&#039;/&gt; &lt;/qemu:commandline&gt; &lt;/domain&gt;</code></pre></div><p>the error output is </p><div class="codebox"><pre><code>error: Failed to start domain test error: internal error: process exited while connecting to monitor: qemu-system-x86_64: -device vfio-pci,host=01:00.0,bus=root.1,addr=00.0,multifunction=on,x-vga=on: vfio_dma_map(0x7fce2c9e4b00, 0x0, 0x20000000, 0x7fcdf0000000) = -12 (Cannot allocate memory) qemu-system-x86_64: -device vfio-pci,host=01:00.0,bus=root.1,addr=00.0,multifunction=on,x-vga=on: vfio: memory listener initialization failed for container qemu-system-x86_64: -device vfio-pci,host=01:00.0,bus=root.1,addr=00.0,multifunction=on,x-vga=on: vfio: failed to setup container for group 1 qemu-system-x86_64: -device vfio-pci,host=01:00.0,bus=root.1,addr=00.0,multifunction=on,x-vga=on: vfio: failed to get group 1 qemu-system-x86_64: -device vfio-pci,host=01:00.0,bus=root.1,addr=00.0,multifunction=on,x-vga=on: Device initialization failed. qemu-system-x86_64: -device vfio-pci,host=01:00.0,bus=root.1,addr=00.0,multifunction=on,x-vga=on: Device &#039;vfio-pci&#039; could not be initialized</code></pre></div><p>dmesg | grep -e vfio then shows</p><div class="codebox"><pre><code>[302278.633004] vfio_pin_pages: RLIMIT_MEMLOCK (65536) exceeded [302278.633015] vfio_pin_pages: RLIMIT_MEMLOCK (65536) exceeded</code></pre></div><p>VT-d is enabled as per dmesg | grep -e DMAR -e IOMMU output</p><div class="codebox"><pre><code>[ 0.000000] ACPI: DMAR 00000000be148e78 0000B0 (v01 INTEL SNB 00000001 INTL 00000001) [ 0.000000] Intel-IOMMU: enabled [ 0.018580] dmar: IOMMU 0: reg_base_addr fed90000 ver 1:0 cap c0000020e60262 ecap f0101a [ 0.018585] dmar: IOMMU 1: reg_base_addr fed91000 ver 1:0 cap c9008020660262 ecap f0105a [ 0.018657] IOAPIC id 2 under DRHD base 0xfed91000 IOMMU 1 [ 0.485319] DMAR: No ATSR found [ 0.485340] IOMMU 0 0xfed90000: using Queued invalidation [ 0.485341] IOMMU 1 0xfed91000: using Queued invalidation [ 0.485342] IOMMU: Setting RMRR: [ 0.485352] IOMMU: Setting identity map for device 0000:00:02.0 [0xbf800000 - 0xcf9fffff] [ 0.486624] IOMMU: Setting identity map for device 0000:00:1d.0 [0xbdf8d000 - 0xbdfb9fff] [ 0.486642] IOMMU: Setting identity map for device 0000:00:1a.0 [0xbdf8d000 - 0xbdfb9fff] [ 0.486652] IOMMU: Prepare 0-16MiB unity mapping for LPC [ 0.486659] IOMMU: Setting identity map for device 0000:00:1f.0 [0x0 - 0xffffff] [ 1.157895] [drm] DMAR active, disabling use of stolen memory</code></pre></div><p>Permissions for /dev/vfio/ are</p><div class="codebox"><pre><code>crw-rw-rw- 1 root root 251, 0 May 18 22:48 1 crw-rw-rw- 1 root root 10, 196 May 18 22:45 vfio</code></pre></div><p>qemu is running its processes as root and the acl in /etc/libvirt/qemu.conf is</p><div class="codebox"><pre><code>cgroup_device_acl = [ &quot;/dev/null&quot;, &quot;/dev/full&quot;, &quot;/dev/zero&quot;, &quot;/dev/random&quot;, &quot;/dev/urandom&quot;, &quot;/dev/ptmx&quot;, &quot;/dev/kvm&quot;, &quot;/dev/kqemu&quot;, &quot;/dev/rtc&quot;,&quot;/dev/hpet&quot;, &quot;/dev/vfio/vfio&quot;, &quot;/dev/vfio/1&quot; ]</code></pre></div><p>I&#039;m researched this but haven&#039;t found a way forward. Any pointers are very much appreciated. Thanks to the Arch community (in particular you who have provided mountains of insight here!) for all the work done so far, this has all been highly educational! <img src="https://bbs.archlinux.org/img/smilies/smile.png" width="15" height="15" alt="smile" /></p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1418085">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div class="postlinksb"> <div class="inbox crumbsplus"> <div class="pagepost"> <p class="pagelink conl"><span class="pages-label">Pages: </span><a rel="prev" class="item1" href="viewtopic.php?id=162768&amp;p=69">Previous</a> <a href="viewtopic.php?id=162768">1</a> <span class="spacer">…</span> <a href="viewtopic.php?id=162768&amp;p=68">68</a> <a href="viewtopic.php?id=162768&amp;p=69">69</a> <strong>70</strong> <a href="viewtopic.php?id=162768&amp;p=71">71</a> <a href="viewtopic.php?id=162768&amp;p=72">72</a> <span class="spacer">…</span> <a href="viewtopic.php?id=162768&amp;p=234">234</a> <a rel="next" href="viewtopic.php?id=162768&amp;p=71">Next</a></p> <p class="postlink conr">Topic closed</p> </div> <ul class="crumbs"> <li><a href="index.php">Index</a></li> <li><span>»&#160;</span><a href="viewforum.php?id=48">Topics Going Nowhere</a></li> <li><span>»&#160;</span><strong><a href="viewtopic.php?id=162768">KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</a></strong></li> </ul> <p class="subscribelink clearb"><a href="misc.php?action=subscribe&amp;tid=162768">Subscribe to this topic</a></p> <div class="clearer"></div> </div> </div> </div> <div id="brdfooter" class="block"> <h2><span>Board footer</span></h2> <div class="box"> <div id="brdfooternav" class="inbox"> <div class="conl"> <form id="qjump" method="get" action="viewforum.php"> <div><label><span>Jump to<br /></span> <select name="id" onchange="window.location=('viewforum.php?id='+this.options[this.selectedIndex].value)"> <optgroup label="Technical Issues and Assistance"> <option value="23">Newbie Corner</option> <option value="17">Installation</option> <option value="22">Kernel &amp; Hardware</option> <option value="18">Applications &amp; Desktop Environments</option> <option value="31">Laptop Issues</option> <option value="8">Networking, Server, and Protection</option> <option value="32">Multimedia and Games</option> <option value="50">System Administration</option> <option value="35">Other Architectures</option> </optgroup> <optgroup label="Arch-centric"> <option value="24">Announcements, Package &amp; Security Advisories</option> <option value="1">Arch Discussion</option> <option value="13">Forum &amp; Wiki discussion</option> </optgroup> <optgroup label="Pacman Upgrades, Packaging &amp; AUR"> <option value="44">Pacman &amp; Package Upgrade Issues</option> <option value="49">[testing] Repo Forum</option> <option value="4">Creating &amp; Modifying Packages</option> <option value="38">AUR Issues, Discussion &amp; PKGBUILD Requests</option> </optgroup> <optgroup label="Contributions &amp; Discussion"> <option value="20">GNU/Linux Discussion</option> <option value="27">Community Contributions</option> <option value="33">Programming &amp; Scripting</option> <option value="30">Other Languages</option> <option value="47">Artwork and Screenshots</option> <option value="42">Try This</option> </optgroup> <optgroup label="/dev/null"> <option value="29">Off-Topic</option> <option value="48" selected="selected">Topics Going Nowhere</option> <option value="36">Dustbin</option> </optgroup> </select></label> <input type="submit" value=" Go " accesskey="g" /> </div> </form> </div> <div class="conr"> <p id="feedlinks"><span class="atom"><a href="extern.php?action=feed&amp;tid=162768&amp;type=atom">Atom topic feed</a></span></p> <p id="poweredby">Powered by <a href="http://fluxbb.org/">FluxBB</a></p> </div> <div class="clearer"></div> </div> </div> </div> </div> <div class="end-box"></div> </div> </body> </html>
