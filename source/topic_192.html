<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"> <html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en" dir="ltr"> <head> <meta http-equiv="Content-Type" content="text/html; charset=utf-8" /> <title>KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9 (Page 192) / Topics Going Nowhere / Arch Linux Forums</title> <link rel="stylesheet" type="text/css" href="style/ArchLinux.css" /> <link rel="canonical" href="viewtopic.php?id=162768&amp;p=192" title="Page 192" /> <link rel="prev" href="viewtopic.php?id=162768&amp;p=191" title="Page 191" /> <link rel="next" href="viewtopic.php?id=162768&amp;p=193" title="Page 193" /> <link rel="alternate" type="application/atom+xml" href="extern.php?action=feed&amp;tid=162768&amp;type=atom" title="Atom topic feed" /> <link rel="stylesheet" media="screen" href="style/ArchLinux/arch.css?v=3" /> <link rel="stylesheet" media="screen" href="style/ArchLinux/archnavbar.css?v=2" /> <link rel="shortcut icon" href="style/ArchLinux/favicon.ico" /> </head> <body> <div id="archnavbar" class="anb-forum"> <div id="archnavbarlogo"><h1><a href="http://www.archlinux.org/">Arch Linux</a></h1></div> <div id="archnavbarmenu"> <ul id="archnavbarlist"> <li id="anb-home"><a href="http://www.archlinux.org/">Home</a></li><li id="anb-packages"><a href="http://www.archlinux.org/packages/">Packages</a></li><li id="anb-forums" class="anb-selected"><a href="https://bbs.archlinux.org/">Forums</a></li><li id="anb-wiki"><a href="https://wiki.archlinux.org/">Wiki</a></li><li id="anb-bugs"><a href="https://bugs.archlinux.org/">Bugs</a></li><li id="anb-aur"><a href="https://aur.archlinux.org/">AUR</a></li><li id="anb-download"><a href="http://www.archlinux.org/download/">Download</a></li> </ul> </div> </div> <div id="punviewtopic" class="pun"> <div class="top-box"></div> <div class="punwrap"> <div id="brdheader" class="block"> <div class="box"> <div id="brdmenu" class="inbox"> <ul> <li id="navindex" class="isactive"><a href="index.php">Index</a></li> <li id="navuserlist"><a href="userlist.php">User list</a></li> <li id="navsearch"><a href="search.php">Search</a></li> <li id="navprofile"><a href="profile.php?id=80749">Profile</a></li> <li id="navlogout"><a href="login.php?action=out&amp;id=80749&amp;csrf_token=5c20501ec397bb45ef8ee8c84db232c8d8e421c6">Logout</a></li> </ul> </div> <div id="brdwelcome" class="inbox"> <ul class="conl"> <li><span>Logged in as <strong>SXX</strong></span></li> <li><span>Last visit: 2015-08-16 12:20:09</span></li> </ul> <ul class="conr"> <li><span>Topics: <a href="search.php?action=show_replies" title="Find topics you have posted to.">Posted</a> | <a href="search.php?action=show_new" title="Find topics with new posts since your last visit.">New</a> | <a href="search.php?action=show_recent" title="Find topics with recent posts.">Active</a> | <a href="search.php?action=show_unanswered" title="Find topics with no replies.">Unanswered</a></span></li> </ul> <div class="clearer"></div> </div> </div> </div> <div id="brdmain"> <div class="linkst"> <div class="inbox crumbsplus"> <ul class="crumbs"> <li><a href="index.php">Index</a></li> <li><span>»&#160;</span><a href="viewforum.php?id=48">Topics Going Nowhere</a></li> <li><span>»&#160;</span><strong><a href="viewtopic.php?id=162768">KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</a></strong></li> </ul> <div class="pagepost"> <p class="pagelink conl"><span class="pages-label">Pages: </span><a rel="prev" class="item1" href="viewtopic.php?id=162768&amp;p=191">Previous</a> <a href="viewtopic.php?id=162768">1</a> <span class="spacer">…</span> <a href="viewtopic.php?id=162768&amp;p=190">190</a> <a href="viewtopic.php?id=162768&amp;p=191">191</a> <strong>192</strong> <a href="viewtopic.php?id=162768&amp;p=193">193</a> <a href="viewtopic.php?id=162768&amp;p=194">194</a> <span class="spacer">…</span> <a href="viewtopic.php?id=162768&amp;p=234">234</a> <a rel="next" href="viewtopic.php?id=162768&amp;p=193">Next</a></p> <p class="postlink conr">Topic closed</p> </div> <div class="clearer"></div> </div> </div> <div id="p1518938" class="blockpost rowodd blockpost1"> <h2><span><span class="conr">#4776</span> <a href="viewtopic.php?pid=1518938#p1518938">2015-04-11 17:47:20</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=76557">logix</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2013-11-04</span></dd> <dd><span>Posts: 12</span></dd> <dd class="usercontacts"><span class="email"><a href="mailto:ken@logic.fm">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <p>Any ideas on why I can&#039;t get IOMMU working? My original post: <a href="https://bbs.archlinux.org/viewtopic.php?pid=1517314#p1517314" rel="nofollow">https://bbs.archlinux.org/viewtopic.php … 4#p1517314</a></p><p>I cannot get DMAR tables populated:</p><div class="codebox"><pre><code># ls /sys/firmware/acpi/tables/ APIC BGRT DSDT dynamic FACP FACS FPDT HPET MCFG SSDT</code></pre></div><p>I have everything enabled as mentioned in <a href="https://bbs.archlinux.org/viewtopic.php?pid=1517314#p1517314" rel="nofollow">previous post</a>&#160; . Only thing I can think of is hardware issues; however, I&#039;ve switched motherboards twice.</p><p>i7-3930k w/ C2 Stepping (SR0KY)<br />ASUS P9x79 LE (Tried 4 different bios)<br />ASUS RAMPAGE IV GENE( Tried 3 different bios)</p><p>Internet research shows people have successfully used this hardware. Any ideas?</p> <p class="postedit"><em>Last edited by logix (2015-04-11 17:49:41)</em></p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1518938">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1518946" class="blockpost roweven"> <h2><span><span class="conr">#4777</span> <a href="viewtopic.php?pid=1518946#p1518946">2015-04-11 18:13:27</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=75590">aw</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2013-10-04</span></dd> <dd><span>Posts: 921</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=75590">Email</a></span> <span class="website"><a href="http://vfio.blogspot.com/" rel="nofollow">Website</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <p>@logix</p><p>It&#039;s still a BIOS issue, nothing we can do here.&#160; Maybe Asus doesn&#039;t detect the C2 stepping as having VT-d.&#160; It is possible to pass tables into the kernel, but creating and passing that table is beyond the scope of this thread.</p> </div> <div class="postsignature postmsg"><hr /><p><a href="http://vfio.blogspot.com" rel="nofollow">http://vfio.blogspot.com</a><br />Looking for a more open forum to discuss vfio related uses?&#160; Try <a href="https://www.redhat.com/mailman/listinfo/vfio-users" rel="nofollow">https://www.redhat.com/mailman/listinfo/vfio-users</a></p></div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1518946">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1518963" class="blockpost rowodd"> <h2><span><span class="conr">#4778</span> <a href="viewtopic.php?pid=1518963#p1518963">2015-04-11 19:00:30</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=78620">mostlyharmless</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2014-01-16</span></dd> <dd><span>Posts: 50</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=78620">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <p>Anyone tried the UEFI new machine install on virt-manager? There&#039;s supposed to be a patch to allow selecting Overview|Firmware and then UEFI or BIOS while &quot;Customizing before install&quot; when making a new machine. All I see is the 440fx or Q35 choice using the latest libvirtd/virt-manager on Arch.</p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1518963">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1518979" class="blockpost roweven"> <h2><span><span class="conr">#4779</span> <a href="viewtopic.php?pid=1518979#p1518979">2015-04-11 19:40:29</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=89552">lersek</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2015-03-15</span></dd> <dd><span>Posts: 34</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=89552">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>mostlyharmless wrote:</cite><blockquote><div><p>Anyone tried the UEFI new machine install on virt-manager? There&#039;s supposed to be a patch to allow selecting Overview|Firmware and then UEFI or BIOS while &quot;Customizing before install&quot; when making a new machine. All I see is the 440fx or Q35 choice using the latest libvirtd/virt-manager on Arch.</p></div></blockquote></div><p>You should have the OVMF package installed, and its files (firmware binary and varstore template) listed as a pair in the &quot;nvram&quot; stanza of /etc/libvirtd/qemu.comf. IIRC virt-manager queries libvirtd, and the UEFI choice means the first entry in that list of pairs (assuming there is a pair). My memories might be off though.</p><p>If you edit qemu.conf, don&#039;t forget to restart libvirtd.</p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1518979">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1518984" class="blockpost rowodd"> <h2><span><span class="conr">#4780</span> <a href="viewtopic.php?pid=1518984#p1518984">2015-04-11 19:54:51</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=78620">mostlyharmless</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2014-01-16</span></dd> <dd><span>Posts: 50</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=78620">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <p>Yeah, followed the instructions in the white paper, restarted, still no joy. Any other troubleshooting I can try?</p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1518984">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1519010" class="blockpost roweven"> <h2><span><span class="conr">#4781</span> <a href="viewtopic.php?pid=1519010#p1519010">2015-04-11 21:22:38</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=78620">mostlyharmless</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2014-01-16</span></dd> <dd><span>Posts: 50</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=78620">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <p>@logix<br />My functioning system with a RIVE IV and a 4930K, bios 4901 shows the same output as you have, namely:</p><div class="codebox"><pre><code>ls /sys/firmware/acpi/tables/ APIC BGRT DMAR DSDT dynamic FACP FACS FPDT HPET MCFG SSDT</code></pre></div><p>so I don&#039;t think that indicates anything. However you should see something like </p><div class="codebox"><pre><code>#dmesg | grep -e DMAR -e IOMMU [ 0.000000] ACPI: DMAR 0x00000000AC4D3690 0000B4 (v01 A M I OEMDMAR 00000001 INTL 00000001) [ 0.000000] Intel-IOMMU: enabled [ 0.337843] dmar: IOMMU 0: reg_base_addr fbffc000 ver 1:0 cap d2078c106f0466 ecap f020de [ 0.337938] IOAPIC id 0 under DRHD base 0xfbffc000 IOMMU 0 [ 0.337938] IOAPIC id 2 under DRHD base 0xfbffc000 IOMMU 0 [ 1.001689] IOMMU: dmar0 using Queued invalidation [ 1.001692] IOMMU: Setting RMRR: [ 1.001702] IOMMU: Setting identity map for device 0000:00:1a.0 [0xac39b000 - 0xac3a8fff] [ 1.001727] IOMMU: Setting identity map for device 0000:00:1d.0 [0xac39b000 - 0xac3a8fff] [ 1.001741] IOMMU: Prepare 0-16MiB unity mapping for LPC [ 1.001749] IOMMU: Setting identity map for device 0000:00:1f.0 [0x0 - 0xffffff] [ 10.885128] AMD IOMMUv2 driver by Joerg Roedel &lt;joerg.roedel@amd.com&gt; [ 10.885129] AMD IOMMUv2 functionality not available on this system</code></pre></div><p>Note in particular the first line.&#160; Support for your hardware should be there since bios 1005, see <a href="http://rog.asus.com/61782011/news/uefi-bios-update-rampage-iv-extreme-formula-and-gene/" rel="nofollow">http://rog.asus.com/61782011/news/uefi- … -and-gene/</a> although your bios could be up to date at 4901 as well.&#160; The only other thing I see that&#039;s different is&#160; &quot;pcie_acs_override=downstream&quot; which I don&#039;t use.&#160; My kernel line has intel_iommu=on pci-stub.ids=10de:0ffe,10de:0e1b modprobe.blacklist=nouveau,nvidia.&#160; The other weird thing is that your command </p><div class="codebox"><pre><code>#dmesg | grep pci-stub [ 0.700460] pci-stub 0000:02:00.0: claimed by stub [ 0.700501] pci-stub 0000:02:00.1: claimed by stub</code></pre></div><p>doesn&#039;t actually show pci-stub in your kernel command line.&#160; Is there a typo somewhere? Extra whitespace? Or did you edit the output? <br />Here&#039;s the result on my machine:</p><div class="codebox"><pre><code>dmesg | grep pci-stub [ 0.000000] Command line: BOOT_IMAGE=/vmlinuz-linux root=/dev/mapper/cryptvg2-arch rw intel_iommu=on pci-stub.ids=10de:0ffe,10de:0e1b modprobe.blacklist=nouveau,nvidia radeon.dpm=1 radeon.modeset=1 cryptdevice=/dev/sdb1:cryptvg2 cryptkey=/dev/sdc:vfat:/keyfile [ 0.000000] Kernel command line: BOOT_IMAGE=/vmlinuz-linux root=/dev/mapper/cryptvg2-arch rw intel_iommu=on pci-stub.ids=10de:0ffe,10de:0e1b modprobe.blacklist=nouveau,nvidia radeon.dpm=1 radeon.modeset=1 cryptdevice=/dev/sdb1:cryptvg2 cryptkey=/dev/sdc:vfat:/keyfile [ 1.039022] pci-stub: add 10DE:0FFE sub=FFFFFFFF:FFFFFFFF cls=00000000/00000000 [ 1.039030] pci-stub 0000:03:00.0: claimed by stub [ 1.039037] pci-stub: add 10DE:0E1B sub=FFFFFFFF:FFFFFFFF cls=00000000/00000000 [ 1.039045] pci-stub 0000:03:00.1: claimed by stub</code></pre></div><p>You&#039;d have to have horrible luck to have two bad motherboards, so a hardware problem seems unlikely. I am using the standard Arch kernel.</p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1519010">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1519017" class="blockpost rowodd"> <h2><span><span class="conr">#4782</span> <a href="viewtopic.php?pid=1519017#p1519017">2015-04-11 21:39:50</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=75590">aw</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2013-10-04</span></dd> <dd><span>Posts: 921</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=75590">Email</a></span> <span class="website"><a href="http://vfio.blogspot.com/" rel="nofollow">Website</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>mostlyharmless wrote:</cite><blockquote><div><p>@logix<br />My functioning system with a RIVE IV and a 4930K, bios 4901 shows the same output as you have, namely:</p><div class="codebox"><pre><code>ls /sys/firmware/acpi/tables/ APIC BGRT DMAR DSDT dynamic FACP FACS FPDT HPET MCFG SSDT</code></pre></div></div></blockquote></div><p>You&#039;re missing that logix&#039;s output doesn&#039;t include the DMAR table, which is essential to VT-d functionality.</p> </div> <div class="postsignature postmsg"><hr /><p><a href="http://vfio.blogspot.com" rel="nofollow">http://vfio.blogspot.com</a><br />Looking for a more open forum to discuss vfio related uses?&#160; Try <a href="https://www.redhat.com/mailman/listinfo/vfio-users" rel="nofollow">https://www.redhat.com/mailman/listinfo/vfio-users</a></p></div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1519017">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1519020" class="blockpost roweven"> <h2><span><span class="conr">#4783</span> <a href="viewtopic.php?pid=1519020#p1519020">2015-04-11 21:54:57</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=78620">mostlyharmless</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2014-01-16</span></dd> <dd><span>Posts: 50</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=78620">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <p>Hmm, missed that; still hope the other suggestions are helpful.</p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1519020">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1519031" class="blockpost rowodd"> <h2><span><span class="conr">#4784</span> <a href="viewtopic.php?pid=1519031#p1519031">2015-04-11 22:59:42</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=65869">Helios747</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2012-11-17</span></dd> <dd><span>Posts: 11</span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <p>I&#039;ve made a bit more progress from a blank output. I&#039;ve tried OVMF and am now correctly passing through my GTX 770 and I&#039;m getting a display!</p><p>The snag I&#039;m hitting now is that I can only seem to boot into the default EFI shell. I have no idea what to do from there. I can&#039;t seem to boot from my Windows 8 ISO file. I tried typing &quot;bootx64.efi&quot; to see if I could manually trigger a boot but that didn&#039;t work.</p><p>This is my QEMU command</p><div class="quotebox"><blockquote><div><p>qemu-system-x86_64 -enable-kvm -m 1024 -cpu host,kvm=off&#160; \<br />-smp 4,sockets=1,cores=4,threads=1 \<br />-drive if=pflash,format=raw,readonly,file=/usr/share/edk2.git/ovmf-x64/OVMF_CODE-pure-efi.fd \<br />-drive if=pflash,format=raw,file=/usr/share/edk2.git/ovmf-x64/OVMF_VARS-pure-efi.fd \<br />-device vfio-pci,host=01:00.0 -device vfio-pci,host=01:00.1 \<br />-vga none&#160; -device virtio-scsi-pci,id=scsi -drive file=/home/anthony/windows.img,id=disk,format=raw,if=none \<br />-device scsi-hd,drive=disk -drive file=/home/anthony/win8.iso,id=isocd,if=none -drive file=/home/anthony/virtio.iso,id=virtiocd,if=none \<br />-device ide-cd,bus=ide.1,drive=virtiocd</p></div></blockquote></div><p>What am I missing? Anything obvious?</p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1519031">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1519039" class="blockpost roweven"> <h2><span><span class="conr">#4785</span> <a href="viewtopic.php?pid=1519039#p1519039">2015-04-11 23:19:12</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=84760">Denso</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd class="postavatar"><img src="https://bbs.archlinux.org/img/avatars/84760.png?m=1412533733" width="71" height="80" alt="" /></dd> <dd><span>Registered: 2014-08-30</span></dd> <dd><span>Posts: 179</span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>Helios747 wrote:</cite><blockquote><div><p>I&#039;ve made a bit more progress from a blank output. I&#039;ve tried OVMF and am now correctly passing through my GTX 770 and I&#039;m getting a display!</p><p>The snag I&#039;m hitting now is that I can only seem to boot into the default EFI shell. I have no idea what to do from there. I can&#039;t seem to boot from my Windows 8 ISO file. I tried typing &quot;bootx64.efi&quot; to see if I could manually trigger a boot but that didn&#039;t work.</p><p>This is my QEMU command</p><div class="quotebox"><blockquote><div><p>qemu-system-x86_64 -enable-kvm -m 1024 -cpu host,kvm=off&#160; \<br />-smp 4,sockets=1,cores=4,threads=1 \<br />-drive if=pflash,format=raw,readonly,file=/usr/share/edk2.git/ovmf-x64/OVMF_CODE-pure-efi.fd \<br />-drive if=pflash,format=raw,file=/usr/share/edk2.git/ovmf-x64/OVMF_VARS-pure-efi.fd \<br />-device vfio-pci,host=01:00.0 -device vfio-pci,host=01:00.1 \<br />-vga none&#160; -device virtio-scsi-pci,id=scsi -drive file=/home/anthony/windows.img,id=disk,format=raw,if=none \<br />-device scsi-hd,drive=disk -drive file=/home/anthony/win8.iso,id=isocd,if=none -drive file=/home/anthony/virtio.iso,id=virtiocd,if=none \<br />-device ide-cd,bus=ide.1,drive=virtiocd</p></div></blockquote></div><p>What am I missing? Anything obvious?</p></div></blockquote></div><p>All I can provide is my working Drives configuration , replace yours with these and see if it works :</p><div class="codebox"><pre><code>-drive file=/home/anthony/windows.img,cache=writeback,format=raw,if=none,id=drive0,aio=threads \ -device virtio-blk-pci,drive=drive0,ioeventfd=on,bootindex=1 \ -device virtio-scsi-pci,id=scsi \ -drive file=/home/anthony/win8.iso,id=iso_install,if=none,format=raw \ -device scsi-cd,drive=iso_install \ -cdrom /home/anthony/virtio.iso \</code></pre></div><p>When the UEFI shell appears , type &quot;exit&quot; and hit enter , you will see a menu choose &quot;boot devices&quot; if I remember correctly , then choose the SCSI device .</p><p>Hope you&#039;d find your path around ! Good luck .</p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1519039">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1519043" class="blockpost rowodd"> <h2><span><span class="conr">#4786</span> <a href="viewtopic.php?pid=1519043#p1519043">2015-04-12 00:01:38</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=70922">nbhs</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd class="postavatar"><img src="https://bbs.archlinux.org/img/avatars/70922.jpg?m=1367773811" width="80" height="80" alt="" /></dd> <dd><span>From: Montevideo, Uruguay</span></dd> <dd><span>Registered: 2013-05-02</span></dd> <dd><span>Posts: 402</span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>Helios747 wrote:</cite><blockquote><div><p>I&#039;ve made a bit more progress from a blank output. I&#039;ve tried OVMF and am now correctly passing through my GTX 770 and I&#039;m getting a display!</p><p>The snag I&#039;m hitting now is that I can only seem to boot into the default EFI shell. I have no idea what to do from there. I can&#039;t seem to boot from my Windows 8 ISO file. I tried typing &quot;bootx64.efi&quot; to see if I could manually trigger a boot but that didn&#039;t work.</p><p>This is my QEMU command</p><div class="quotebox"><blockquote><div><p>qemu-system-x86_64 -enable-kvm -m 1024 -cpu host,kvm=off&#160; \<br />-smp 4,sockets=1,cores=4,threads=1 \<br />-drive if=pflash,format=raw,readonly,file=/usr/share/edk2.git/ovmf-x64/OVMF_CODE-pure-efi.fd \<br />-drive if=pflash,format=raw,file=/usr/share/edk2.git/ovmf-x64/OVMF_VARS-pure-efi.fd \<br />-device vfio-pci,host=01:00.0 -device vfio-pci,host=01:00.1 \<br />-vga none&#160; -device virtio-scsi-pci,id=scsi -drive file=/home/anthony/windows.img,id=disk,format=raw,if=none \<br />-device scsi-hd,drive=disk -drive file=/home/anthony/win8.iso,id=isocd,if=none -drive file=/home/anthony/virtio.iso,id=virtiocd,if=none \<br />-device ide-cd,bus=ide.1,drive=virtiocd</p></div></blockquote></div><p>What am I missing? Anything obvious?</p></div></blockquote></div><p>Create a 4GB fat32 image and copy your windows installation files there, it should work</p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1519043">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1519067" class="blockpost roweven"> <h2><span><span class="conr">#4787</span> <a href="viewtopic.php?pid=1519067#p1519067">2015-04-12 03:30:45</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=65869">Helios747</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2012-11-17</span></dd> <dd><span>Posts: 11</span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <p>Alright, I tried that, I didn&#039;t get very far though.</p><p>This is my new qemu command</p><div class="quotebox"><blockquote><div><p>qemu-system-x86_64 -enable-kvm -m 1024 -cpu host,kvm=off&#160; \<br />-smp 4,sockets=1,cores=4,threads=1 \<br />-drive if=pflash,format=raw,readonly,file=/usr/share/edk2.git/ovmf-x64/OVMF_CODE-pure-efi.fd \<br />-drive if=pflash,format=raw,file=/usr/share/edk2.git/ovmf-x64/OVMF_VARS-pure-efi.fd \<br />-device vfio-pci,host=01:00.0 -device vfio-pci,host=01:00.1 \<br />-vga none \<br />-device virtio-scsi-pci,id=scsi \<br />-drive file=/home/anthony/windows.img,id=disk,format=raw,if=none -device scsi-hd,drive=disk \<br />-drive file=/home/anthony/win8boot.img,id=isocd,if=none -device scsi-cd,drive=isocd \<br />-drive file=/home/anthony/virtio.iso,id=virtiocd,if=none -device ide-cd,bus=ide.1,drive=virtiocd</p></div></blockquote></div><p>win8boot.img is a fat32 formatted image with all the files from the win8.iso copied to it.</p><br /><p>By the way, when I boot the VM, I get msgs of it trying to boot from EFI floppy, EFI floppy 2, EFI DVD/CDROM and all failing.</p><p>It then tries to boot from network, fails, then drops me to an EFI shell.</p> <p class="postedit"><em>Last edited by Helios747 (2015-04-12 03:31:03)</em></p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1519067">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1519068" class="blockpost rowodd"> <h2><span><span class="conr">#4788</span> <a href="viewtopic.php?pid=1519068#p1519068">2015-04-12 03:38:50</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=70922">nbhs</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd class="postavatar"><img src="https://bbs.archlinux.org/img/avatars/70922.jpg?m=1367773811" width="80" height="80" alt="" /></dd> <dd><span>From: Montevideo, Uruguay</span></dd> <dd><span>Registered: 2013-05-02</span></dd> <dd><span>Posts: 402</span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>Helios747 wrote:</cite><blockquote><div><p>Alright, I tried that, I didn&#039;t get very far though.</p><p>This is my new qemu command</p><div class="quotebox"><blockquote><div><p>qemu-system-x86_64 -enable-kvm -m 1024 -cpu host,kvm=off&#160; \<br />-smp 4,sockets=1,cores=4,threads=1 \<br />-drive if=pflash,format=raw,readonly,file=/usr/share/edk2.git/ovmf-x64/OVMF_CODE-pure-efi.fd \<br />-drive if=pflash,format=raw,file=/usr/share/edk2.git/ovmf-x64/OVMF_VARS-pure-efi.fd \<br />-device vfio-pci,host=01:00.0 -device vfio-pci,host=01:00.1 \<br />-vga none \<br />-device virtio-scsi-pci,id=scsi \<br />-drive file=/home/anthony/windows.img,id=disk,format=raw,if=none -device scsi-hd,drive=disk \<br />-drive file=/home/anthony/win8boot.img,id=isocd,if=none -device scsi-cd,drive=isocd \<br />-drive file=/home/anthony/virtio.iso,id=virtiocd,if=none -device ide-cd,bus=ide.1,drive=virtiocd</p></div></blockquote></div><p>win8boot.img is a fat32 formatted image with all the files from the win8.iso copied to it.</p><br /><p>By the way, when I boot the VM, I get msgs of it trying to boot from EFI floppy, EFI floppy 2, EFI DVD/CDROM and all failing.</p><p>It then tries to boot from network, fails, then drops me to an EFI shell.</p></div></blockquote></div><p>First change this:</p><div class="codebox"><pre><code>-drive file=/home/anthony/win8boot.img,id=isocd,if=none -device scsi-cd,drive=isocd \</code></pre></div><div class="codebox"><pre><code>-drive file=/home/anthony/win8boot.img,id=isocd,if=none -device scsi-hd,drive=isocd \</code></pre></div><p>Second:</p><p>Make sure the file /efi/boot/bootx64.efi exists on the image</p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1519068">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1519077" class="blockpost roweven"> <h2><span><span class="conr">#4789</span> <a href="viewtopic.php?pid=1519077#p1519077">2015-04-12 04:34:53</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=65869">Helios747</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2012-11-17</span></dd> <dd><span>Posts: 11</span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <p>Did you mean to paste the changes to be made on the second line?</p><p>I think you just copied my win8boot.img line twice.</p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1519077">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1519078" class="blockpost rowodd"> <h2><span><span class="conr">#4790</span> <a href="viewtopic.php?pid=1519078#p1519078">2015-04-12 04:35:50</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=70922">nbhs</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd class="postavatar"><img src="https://bbs.archlinux.org/img/avatars/70922.jpg?m=1367773811" width="80" height="80" alt="" /></dd> <dd><span>From: Montevideo, Uruguay</span></dd> <dd><span>Registered: 2013-05-02</span></dd> <dd><span>Posts: 402</span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>Helios747 wrote:</cite><blockquote><div><p>Did you mean to paste the changes to be made on the second line?</p><p>I think you just copied my win8boot.img line twice.</p></div></blockquote></div><p>-device scsi-cd != -device scsi-hd</p><p>this</p><div class="codebox"><pre><code>-drive file=/home/anthony/win8boot.img,id=isocd,if=none -device scsi-cd,drive=isocd \</code></pre></div><p>to this</p><div class="codebox"><pre><code>-drive file=/home/anthony/win8boot.img,id=isocd,if=none -device scsi-hd,drive=isocd \</code></pre></div> <p class="postedit"><em>Last edited by nbhs (2015-04-12 04:36:34)</em></p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1519078">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1519198" class="blockpost roweven"> <h2><span><span class="conr">#4791</span> <a href="viewtopic.php?pid=1519198#p1519198">2015-04-12 16:36:59</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=90273">ughman</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2015-04-12</span></dd> <dd><span>Posts: 7</span></dd> <dd class="usercontacts"><span class="email"><a href="mailto:chekwob@yahoo.com">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <p>Hello. I am trying to pass through an AMD Radeon R9 290 to an x86-64 Windows 7 guest using qemu with kvm. I have had significant success so far, the card passes through and runs with excellent performance, however I am having an issue with the guest freezing and/or crashing.</p><p>The first issue I had encountered was a crash (BSOD) every time while booting the guest. I believe it was code 0x116 in atikmpag.sys, however I cannot recall for certain. I was able to fix this issue by ensuring the host&#039;s module vfio_iommu_type1 was loaded with the parameter &quot;disable_hugepages=1&quot;.</p><p>For my current issue, there appears to be two cases where the guest fails in (at least slightly) different ways.</p><h5>Case A</h5><p>While booting the VM, during the windows logo on black background screen, the following appears in dmesg -w:</p><div class="codebox"><pre><code>[ 803.389766] AMD-Vi: Event logged [INVALID_DEVICE_REQUEST device=00:00.1 address=0x000000fdf8010020 flags=0x0a00]</code></pre></div><p>The guest runs fine until some point, usually seems to be associated with high memory or cpu usage. At this point, the following messages appear, in one quick burst, in dmesg -w:</p><div class="codebox"><pre><code>[ 2517.239350] AMD-Vi: Event logged [IO_PAGE_FAULT device=00:00.0 domain=0x0002 address=0x000000009822d400 flags=0x0010] [ 2517.239357] AMD-Vi: Event logged [IO_PAGE_FAULT device=00:00.0 domain=0x0002 address=0x000000009822d480 flags=0x0010] [ 2517.239359] AMD-Vi: Event logged [IO_PAGE_FAULT device=00:00.0 domain=0x0002 address=0x000000009822d440 flags=0x0010] [ 2517.239361] AMD-Vi: Event logged [IO_PAGE_FAULT device=00:00.0 domain=0x0002 address=0x000000009822d4c0 flags=0x0010] [ 2517.239363] AMD-Vi: Event logged [IO_PAGE_FAULT device=00:00.0 domain=0x0002 address=0x000000009822d500 flags=0x0010] [ 2517.239364] AMD-Vi: Event logged [IO_PAGE_FAULT device=00:00.0 domain=0x0002 address=0x000000009822d540 flags=0x0010] [ 2517.239365] AMD-Vi: Event logged [IO_PAGE_FAULT device=00:00.0 domain=0x0002 address=0x000000009822d580 flags=0x0010] [ 2517.239367] AMD-Vi: Event logged [IO_PAGE_FAULT device=00:00.0 domain=0x0002 address=0x000000009822d5c0 flags=0x0010] [ 2517.239368] AMD-Vi: Event logged [IO_PAGE_FAULT device=00:00.0 domain=0x0002 address=0x000000009822d540 flags=0x0010] [ 2517.239370] AMD-Vi: Event logged [IO_PAGE_FAULT device=00:00.0 domain=0x0002 address=0x000000009822d580 flags=0x0010] (etc, about 47 of these)</code></pre></div><p>At this point, most (all?) applications in the guest (appear to) stop responding to window events, and do not appear to render to their windows anymore. Some, but not all, applications stop producing audio. After 2 to 4 seconds, the mouse cursor freezes. At this point, the guest is unusable except remotely. The keyboard (ps2-over-usb usb passthrough) responds to numlock, some applications continue to run. For example, I have been running a Zandronum game server (UDP) and it continues to receive/send packets, run its game simulation, accept new connections, etc. The client I have running on the same guest appears to stop functioning, however its software MIDI synthesizing still runs. I have been unable to get any -soundhw working without serious quality and skipping/choppiness issues, so I have written a program (user-mode) for the guest to record the audio and then send it over the (virtual) network to the host which then plays it back (this happens over UDP). This program, too, continues to run without issue.</p><p>The guest at this point does not respond to system_powerdown from the qemu console. If I press alt-tab or ctrl-alt-delete in the guest, it enters a further frozen state where the keyboard no longer responds to numlock, and the guest appears to no longer get incoming packets (or perhaps the server has frozen/crashed/terminated?). The MIDI synth continues to run, however, and the audio software I have written continues to record the audio and send it correctly.</p><h5>Case B</h5><p>When booting the VM, the above error message does not appear in dmesg. Eventually, the system freezes, however no messages appear in dmesg, and there is a chance the screen will turn black for a few seconds and then display a BSOD with the following message:</p><div class="codebox"><pre><code>Attempt to reset the display driver and recover from timeout failed. 1.sh topic_100.html topic_101.html topic_102.html topic_103.html topic_104.html topic_105.html topic_106.html topic_107.html topic_108.html topic_109.html topic_10.html topic_110.html topic_111.html topic_112.html topic_113.html topic_114.html topic_115.html topic_116.html topic_117.html topic_118.html topic_119.html topic_11.html topic_120.html topic_121.html topic_122.html topic_123.html topic_124.html topic_125.html topic_126.html topic_127.html topic_128.html topic_129.html topic_12.html topic_130.html topic_131.html topic_132.html topic_133.html topic_134.html topic_135.html topic_136.html topic_137.html topic_138.html topic_139.html topic_13.html topic_140.html topic_141.html topic_142.html topic_143.html topic_144.html topic_145.html topic_146.html topic_147.html topic_148.html topic_149.html topic_14.html topic_150.html topic_151.html topic_152.html topic_153.html topic_154.html topic_155.html topic_156.html topic_157.html topic_158.html topic_159.html topic_15.html topic_160.html topic_161.html topic_162.html topic_163.html topic_164.html topic_165.html topic_166.html topic_167.html topic_168.html topic_169.html topic_16.html topic_170.html topic_171.html topic_172.html topic_173.html topic_174.html topic_175.html topic_176.html topic_177.html topic_178.html topic_179.html topic_17.html topic_180.html topic_181.html topic_182.html topic_183.html topic_184.html topic_185.html topic_186.html topic_187.html topic_188.html topic_189.html topic_18.html topic_190.html topic_191.html topic_19.html topic_1.html topic_20.html topic_21.html topic_22.html topic_23.html topic_24.html topic_25.html topic_26.html topic_27.html topic_28.html topic_29.html topic_2.html topic_30.html topic_31.html topic_32.html topic_33.html topic_34.html topic_35.html topic_36.html topic_37.html topic_38.html topic_39.html topic_3.html topic_40.html topic_41.html topic_42.html topic_43.html topic_44.html topic_45.html topic_46.html topic_47.html topic_48.html topic_49.html topic_4.html topic_50.html topic_51.html topic_52.html topic_53.html topic_54.html topic_55.html topic_56.html topic_57.html topic_58.html topic_59.html topic_5.html topic_60.html topic_61.html topic_62.html topic_63.html topic_64.html topic_65.html topic_66.html topic_67.html topic_68.html topic_69.html topic_6.html topic_70.html topic_71.html topic_72.html topic_73.html topic_74.html topic_75.html topic_76.html topic_77.html topic_78.html topic_79.html topic_7.html topic_80.html topic_81.html topic_82.html topic_83.html topic_84.html topic_85.html topic_86.html topic_87.html topic_88.html topic_89.html topic_8.html topic_90.html topic_91.html topic_92.html topic_93.html topic_94.html topic_95.html topic_96.html topic_97.html topic_98.html topic_99.html topic_9.html STOP: 0x00000116 (0xFFFFFA8006257010,0xFFFFF88003C0B848,0x0000000000000000,0 x0000000000000002) 1.sh topic_100.html topic_101.html topic_102.html topic_103.html topic_104.html topic_105.html topic_106.html topic_107.html topic_108.html topic_109.html topic_10.html topic_110.html topic_111.html topic_112.html topic_113.html topic_114.html topic_115.html topic_116.html topic_117.html topic_118.html topic_119.html topic_11.html topic_120.html topic_121.html topic_122.html topic_123.html topic_124.html topic_125.html topic_126.html topic_127.html topic_128.html topic_129.html topic_12.html topic_130.html topic_131.html topic_132.html topic_133.html topic_134.html topic_135.html topic_136.html topic_137.html topic_138.html topic_139.html topic_13.html topic_140.html topic_141.html topic_142.html topic_143.html topic_144.html topic_145.html topic_146.html topic_147.html topic_148.html topic_149.html topic_14.html topic_150.html topic_151.html topic_152.html topic_153.html topic_154.html topic_155.html topic_156.html topic_157.html topic_158.html topic_159.html topic_15.html topic_160.html topic_161.html topic_162.html topic_163.html topic_164.html topic_165.html topic_166.html topic_167.html topic_168.html topic_169.html topic_16.html topic_170.html topic_171.html topic_172.html topic_173.html topic_174.html topic_175.html topic_176.html topic_177.html topic_178.html topic_179.html topic_17.html topic_180.html topic_181.html topic_182.html topic_183.html topic_184.html topic_185.html topic_186.html topic_187.html topic_188.html topic_189.html topic_18.html topic_190.html topic_191.html topic_19.html topic_1.html topic_20.html topic_21.html topic_22.html topic_23.html topic_24.html topic_25.html topic_26.html topic_27.html topic_28.html topic_29.html topic_2.html topic_30.html topic_31.html topic_32.html topic_33.html topic_34.html topic_35.html topic_36.html topic_37.html topic_38.html topic_39.html topic_3.html topic_40.html topic_41.html topic_42.html topic_43.html topic_44.html topic_45.html topic_46.html topic_47.html topic_48.html topic_49.html topic_4.html topic_50.html topic_51.html topic_52.html topic_53.html topic_54.html topic_55.html topic_56.html topic_57.html topic_58.html topic_59.html topic_5.html topic_60.html topic_61.html topic_62.html topic_63.html topic_64.html topic_65.html topic_66.html topic_67.html topic_68.html topic_69.html topic_6.html topic_70.html topic_71.html topic_72.html topic_73.html topic_74.html topic_75.html topic_76.html topic_77.html topic_78.html topic_79.html topic_7.html topic_80.html topic_81.html topic_82.html topic_83.html topic_84.html topic_85.html topic_86.html topic_87.html topic_88.html topic_89.html topic_8.html topic_90.html topic_91.html topic_92.html topic_93.html topic_94.html topic_95.html topic_96.html topic_97.html topic_98.html topic_99.html topic_9.html atikmpag.sys - Address FFFFF88003C0B848 base at FFFFF88003C00000, DateStamp 546e9eb6</code></pre></div><p>In either case, I can reset the guest using system_reset (or just quit and then run it later) without doing any kind of reboot/reset/suspend-resume with the host.</p><p>The first time running the guest after booting the host, I get case A every time, however from that point on I will (at least it seems) either <em>always</em> get case A or <em>always</em> get case B, until I reboot the host. I could be mistaken about this, however.</p><p>The devices I am looking at are these:</p><div class="codebox"><pre><code>00:00.0 Host bridge: Advanced Micro Devices, Inc. [AMD] Family 15h (Models 30h-3fh) Processor Root Complex ( there does not appear to actually be a 00:00.1 ) 00:00.2 IOMMU: Advanced Micro Devices, Inc. [AMD] Family 15h (Models 30h-3fh) I/O Memory Management Unit 00:02.0 Host bridge: Advanced Micro Devices, Inc. [AMD] Device 1424 00:02.1 PCI bridge: Advanced Micro Devices, Inc. [AMD] Device 1425 01:00.0 VGA compatible controller: Advanced Micro Devices, Inc. [AMD/ATI] Hawaii PRO [Radeon R9 290] 01:00.1 Audio device: Advanced Micro Devices, Inc. [AMD/ATI] Device aac8 02:00.0 VGA compatible controller: NVIDIA Corporation G92 [GeForce 9800 GT] (rev a2) 03:07.0 VGA compatible controller: Advanced Micro Devices, Inc. [AMD/ATI] RV280 [Radeon 9200 PRO] (rev 01) 03:07.1 Display controller: Advanced Micro Devices, Inc. [AMD/ATI] RV280 [Radeon 9200 PRO] (Secondary) (rev 01)</code></pre></div><p>00:02.x are in the same iommu group as 01:00.x which is the card I am passing through. 02:00.0 is the graphics card I&#039;m using for the host. I have blacklisted radeon so the device does not come up aside from the BIOS when booting. The card I am passing through is selected by the BIOS as primary, which I thought might be the issue so I installed a PCI radeon card (03:07.x) and set PCI as the primary VGA display. This did not appear to have any effect on my problem at all.</p><p>The script I use to launch the VM is the following:</p><div class="codebox"><pre><code>#!/bin/sh export QEMU_AUDIO_DRV=alsa export QEMU_ALSA_DAC_FIXED_FREQ=48000 export QEMU_ALSA_DAC_BUFFER_SIZE=8192 #export QEMU_ALSA_DAC_PERIOD_SIZE=170 qemu-system-x86_64 \ -enable-kvm \ -cpu host,kvm=off \ -m 4096 \ -smp cores=2,threads=1,sockets=1 \ -drive file=/dev/mapper/urw-win,format=raw,if=virtio \ -device vfio-pci,host=01:00.0,x-vga=on \ -device vfio-pci,host=01:00.1 \ -usb \ -usbdevice host:13ba:0018 \ -usbdevice host:046d:c040 \ -usbdevice host:0810:0001 \ -vga none \ -soundhw hda \ $*</code></pre></div><p>I have tried various changes to the script with no success:</p><ul><li><p>-m 2048, -smp cores=1,threads=1,sockets=1 (didn&#039;t fix anything)</p></li><li><p>-smp cores=1,threads=3,sockets=1 (didn&#039;t fix anything)</p></li><li><p>removing x-vga=on (system does not appear to actually boot, suspect either seabios or windows can&#039;t handle not having any graphics)</p></li><li><p>removing x-vga=on, adding -vga cirrus (system boots, seems more sluggish, did not fix issue)</p></li><li><p>adding multi-function=on to 01:00.0 (had this before, didn&#039;t work then either)</p></li><li><p>no soundhw (actually had this before, didn&#039;t fix anything)</p></li><li><p>adding vfio-pci devices for 00:02.0, 00:02.1 (error in dmesg unable to reset one of the devices, boots fine but didn&#039;t fix anything)</p></li><li><p>without kvm=off (didn&#039;t fix anything)</p></li><li><p>-realtime mlock=on (looked hopeful but didn&#039;t fix anything)</p></li><li><p>-realtime mlock=off (nope)</p></li></ul><p>I have included some dmesg lines from booting the host, which may be relevant (blank lines where I have cut):</p><div class="codebox"><pre class="vscroll"><code>[ 0.000000] Linux version 3.19.3-3-ARCH (builduser@tobias) (gcc version 4.9.2 20150304 (prerelease) (GCC) ) #1 SMP PREEMPT Wed Apr 8 14:10:00 CEST 2015 [ 0.000000] Command line: BOOT_IMAGE=/vmlinuz-linux root=UUID=4f2e65ef-ef21-4628-bbd7-219d7855732b rw quiet cryptdevice=UUI D=17b9c41f-ab59-4a68-a5ec-b7b3e2776bf6:calue [ 0.000000] tseg: 009f800000 [ 0.000000] e820: BIOS-provided physical RAM map: [ 0.000000] BIOS-e820: [mem 0x0000000000100000-0x000000009bc9bfff] usable [ 0.000000] DMI: To Be Filled By O.E.M. To Be Filled By O.E.M./FM2A88X+ Killer, BIOS P2.10 07/31/2014 [ 0.000000] ACPI BIOS Warning (bug): Optional FADT field Pm2ControlBlock has zero address or length: 0x0000000000000000/0x1 (20141107/tbfadt-649) [ 0.000000] AGP: Checking aperture... [ 0.000000] AGP: No AGP bridge found [ 0.000000] AGP: Node 0: aperture [bus addr 0x00000000-0x01ffffff] (32MB) [ 0.000000] AGP: Your BIOS doesn&#039;t leave a aperture memory hole [ 0.000000] AGP: Please enable the IOMMU option in the BIOS setup (&lt;- it is enabled) [ 0.000000] AGP: This costs you 64MB of RAM [ 0.000000] AGP: Mapping aperture over RAM [mem 0x90000000-0x93ffffff] (65536KB) [ 0.365445] ACPI: Using IOAPIC for interrupt routing [ 0.365463] PCI: MMCONFIG for domain 0000 [bus 00-ff] at [mem 0xe0000000-0xefffffff] (base 0xe0000000) [ 0.365501] PCI: MMCONFIG at [mem 0xe0000000-0xefffffff] reserved in ACPI motherboard resources [ 0.365837] PCI: Using host bridge windows from ACPI; if necessary, use &quot;pci=nocrs&quot; and report a bug [ 0.401076] vgaarb: device added: PCI:0000:01:00.0,decodes=io+mem,owns=none,locks=none [ 0.401080] vgaarb: device added: PCI:0000:02:00.0,decodes=io+mem,owns=none,locks=none [ 0.401083] vgaarb: setting as boot device: PCI:0000:03:07.0 [ 0.401085] vgaarb: device added: PCI:0000:03:07.0,decodes=io+mem,owns=io+mem,locks=none [ 0.401086] vgaarb: loaded [ 0.401088] vgaarb: bridge control possible 0000:03:07.0 [ 0.401089] vgaarb: bridge control possible 0000:02:00.0 [ 0.401090] vgaarb: bridge control possible 0000:01:00.0 [ 0.401183] PCI: Using ACPI for IRQ routing [ 0.841509] ERROR: Unable to locate IOAPIC for GSI 56 (&lt;- this one appears on the screen during my cryptsetup password entry prompt) [ 0.841566] Failed to set pin attr for GSI56 [ 0.841569] pci 0000:00:00.2: PCI INT A: failed to register GSI [ 0.842108] AMD-Vi: Found IOMMU at 0000:00:00.2 cap 0x40 [ 0.842109] AMD-Vi: Extended features: PPR GT IA PC [ 0.842112] AMD-Vi: Interrupt remapping enabled [ 0.853022] AMD-Vi: Using passthrough domain for device 0000:01:00.0 [ 0.854512] AMD-Vi: Lazy IO/TLB flushing enabled [ 0.854893] PCI-DMA: Using software bounce buffering for IO (SWIOTLB) [ 0.854896] software IO TLB [mem 0x97c9c000-0x9bc9c000] (64MB) mapped at [ffff880097c9c000-ffff88009bc9bfff] [ 0.858586] pcieport 0000:00:02.1: Signaling PME through PCIe PME interrupt [ 0.858588] pci 0000:01:00.0: Signaling PME through PCIe PME interrupt [ 0.858589] pci 0000:01:00.1: Signaling PME through PCIe PME interrupt [ 0.858592] pcie_pme 0000:00:02.1:pcie01: service driver pcie_pme loaded [ 0.858604] pcieport 0000:00:03.1: Signaling PME through PCIe PME interrupt [ 0.858605] pci 0000:02:00.0: Signaling PME through PCIe PME interrupt [ 0.858607] pcie_pme 0000:00:03.1:pcie01: service driver pcie_pme loaded [ 0.858619] pcieport 0000:00:15.0: Signaling PME through PCIe PME interrupt [ 0.858622] pcie_pme 0000:00:15.0:pcie01: service driver pcie_pme loaded [ 0.858635] pcieport 0000:00:15.2: Signaling PME through PCIe PME interrupt [ 0.858636] pci 0000:05:00.0: Signaling PME through PCIe PME interrupt [ 0.858639] pcie_pme 0000:00:15.2:pcie01: service driver pcie_pme loaded [ 0.858651] pcieport 0000:00:15.3: Signaling PME through PCIe PME interrupt [ 0.858652] pci 0000:06:00.0: Signaling PME through PCIe PME interrupt [ 0.858655] pcie_pme 0000:00:15.3:pcie01: service driver pcie_pme loaded [ 0.858660] pci_hotplug: PCI Hot Plug PCI Core version: 0.5 [ 0.858675] pciehp: PCI Express Hot Plug Controller Driver version: 0.4 [ 0.858716] GHES: HEST is not enabled! [ 11.604037] input: HD-Audio Generic HDMI/DP,pcm=3 as /devices/pci0000:00/0000:00:02.1/0000:01:00.1/sound/card1/input8 [ 11.604117] input: HD-Audio Generic HDMI/DP,pcm=7 as /devices/pci0000:00/0000:00:02.1/0000:01:00.1/sound/card1/input9 [ 11.604189] input: HD-Audio Generic HDMI/DP,pcm=8 as /devices/pci0000:00/0000:00:02.1/0000:01:00.1/sound/card1/input10 [ 11.604258] input: HD-Audio Generic HDMI/DP,pcm=9 as /devices/pci0000:00/0000:00:02.1/0000:01:00.1/sound/card1/input11 [ 11.604329] input: HD-Audio Generic HDMI/DP,pcm=10 as /devices/pci0000:00/0000:00:02.1/0000:01:00.1/sound/card1/input12 [ 11.604396] input: HD-Audio Generic HDMI/DP,pcm=11 as /devices/pci0000:00/0000:00:02.1/0000:01:00.1/sound/card1/input13</code></pre></div><p>I also get these while starting the vm:</p><div class="codebox"><pre><code>[ 124.786012] vfio-pci 0000:01:00.0: enabling device (0000 -&gt; 0003) [ 124.786149] vfio_ecap_init: 0000:01:00.0 hiding ecap 0x19@0x270 [ 124.786155] vfio_ecap_init: 0000:01:00.0 hiding ecap 0x1b@0x2d0 [ 128.333852] vgaarb: device changed decodes: PCI:0000:02:00.0,olddecodes=io+mem,decodes=none:owns=none</code></pre></div><p>At some point while troubleshooting I stopped using pci-stub on the kernel command line. Enabling it again has not fixed the problem:</p><div class="codebox"><pre><code>[ 0.917064] pci-stub: add 1002:67B1 sub=FFFFFFFF:FFFFFFFF cls=00000000/00000000 [ 0.917083] pci-stub 0000:01:00.0: claimed by stub [ 0.917091] pci-stub: add 1002:AAC8 sub=FFFFFFFF:FFFFFFFF cls=00000000/00000000 [ 0.917100] pci-stub 0000:01:00.1: claimed by stub</code></pre></div><p>I hope this post is not too long, but I really don&#039;t know where to go from here. If anyone has any answers or advice, please. I&#039;m dying here.</p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1519198">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1519201" class="blockpost rowodd"> <h2><span><span class="conr">#4792</span> <a href="viewtopic.php?pid=1519201#p1519201">2015-04-12 16:53:57</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=85314">Duelist</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2014-09-22</span></dd> <dd><span>Posts: 358</span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <p>@ughman<br />Just a sidenote: instead of writing a userspace tool for audio transfer, you could use NetJACK instead. Works the same way, pushing audio into UDP. </p><p>I can&#039;t help you with the main problems, because they&#039;re very complex. But i&#039;ll just cut some of the info you&#039;ve provided:</p><div class="codebox"><pre><code>[ 0.917064] pci-stub: add 1002:67B1 sub=FFFFFFFF:FFFFFFFF cls=00000000/00000000 [ 0.917083] pci-stub 0000:01:00.0: claimed by stub [ 0.917091] pci-stub: add 1002:AAC8 sub=FFFFFFFF:FFFFFFFF cls=00000000/00000000 [ 0.917100] pci-stub 0000:01:00.1: claimed by stub</code></pre></div><p>This is 100% fine.</p><div class="codebox"><pre><code>[ 124.786012] vfio-pci 0000:01:00.0: enabling device (0000 -&gt; 0003) [ 124.786149] vfio_ecap_init: 0000:01:00.0 hiding ecap 0x19@0x270 [ 124.786155] vfio_ecap_init: 0000:01:00.0 hiding ecap 0x1b@0x2d0 [ 128.333852] vgaarb: device changed decodes: PCI:0000:02:00.0,olddecodes=io+mem,decodes=none:owns=none</code></pre></div><p>This is fine, but vgaarb line looks strange. AW may provide more info on this, if he&#039;ll come.</p><div class="codebox"><pre><code>00:02.0 Host bridge: Advanced Micro Devices, Inc. [AMD] Device 1424 00:02.1 PCI bridge: Advanced Micro Devices, Inc. [AMD] Device 1425</code></pre></div><p>This looks very weird. What kernel version are you using? I suppose you should have something alike to this:</p><div class="codebox"><pre><code>00:02.0 PCI bridge [0604]: Advanced Micro Devices, Inc. [AMD] Family 15h (Models 10h-1fh) Processor Root Port [1022:1412] 00:04.0 PCI bridge [0604]: Advanced Micro Devices, Inc. [AMD] Family 15h (Models 10h-1fh) Processor Root Port [1022:1414]</code></pre></div><p>And since we&#039;re sharing same CPU BugList(i&#039;ve got fam15h mod10h-1fh), and i&#039;ve been experiencing same weird issues on my x-vga VM too...</p><p>I&#039;d suggest you to move to OVMF. That helped me much. In fact, that&#039;s the only way i&#039;m able to run VM stable.</p><p>P.S.<br />And why do you have <strong>three</strong> different GPUs in your system?..</p> <p class="postedit"><em>Last edited by Duelist (2015-04-12 17:03:57)</em></p> </div> <div class="postsignature postmsg"><hr /><p><span class="bbs">The forum rules prohibit requesting support for distributions other than arch.</span><br /><a href="https://bbs.archlinux.org/viewtopic.php?pid=1551460#p1551460" rel="nofollow">I gave up.</a><a href="https://bbs.archlinux.org/viewtopic.php?id=162768" rel="nofollow"> It was too late.</a><br /><a href="http://pastebin.com/B3fL84bq" rel="nofollow">What I was trying to do</a>.<br /><a href="http://vfio.blogspot.com/" rel="nofollow">The reference about VFIO and KVM VGA passthrough.</a></p></div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1519201">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1519216" class="blockpost roweven"> <h2><span><span class="conr">#4793</span> <a href="viewtopic.php?pid=1519216#p1519216">2015-04-12 17:58:03</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=90273">ughman</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2015-04-12</span></dd> <dd><span>Posts: 7</span></dd> <dd class="usercontacts"><span class="email"><a href="mailto:chekwob@yahoo.com">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>Duelist wrote:</cite><blockquote><div><p>Just a sidenote: instead of writing a userspace tool for audio transfer, you could use NetJACK instead. Works the same way, pushing audio into UDP.</p></div></blockquote></div><p>Thank you, I will look into that.</p><div class="quotebox"><cite>Duelist wrote:</cite><blockquote><div><div class="codebox"><pre><code>00:02.0 Host bridge: Advanced Micro Devices, Inc. [AMD] Device 1424 00:02.1 PCI bridge: Advanced Micro Devices, Inc. [AMD] Device 1425</code></pre></div><p>This looks very weird. What kernel version are you using? I suppose you should have something alike to this:</p><div class="codebox"><pre><code>00:02.0 PCI bridge [0604]: Advanced Micro Devices, Inc. [AMD] Family 15h (Models 10h-1fh) Processor Root Port [1022:1412] 00:04.0 PCI bridge [0604]: Advanced Micro Devices, Inc. [AMD] Family 15h (Models 10h-1fh) Processor Root Port [1022:1414]</code></pre></div></div></blockquote></div><p>I am running &quot;3.19.3-3-ARCH #1 SMP PREEMPT Wed Apr 8 14:10:00 CEST 2015 x86_64 GNU/Linux&quot; according to uname -a. The complete lspci list is here:</p><div class="codebox"><pre class="vscroll"><code>00:00.0 Host bridge: Advanced Micro Devices, Inc. [AMD] Family 15h (Models 30h-3fh) Processor Root Complex 00:00.2 IOMMU: Advanced Micro Devices, Inc. [AMD] Family 15h (Models 30h-3fh) I/O Memory Management Unit 00:02.0 Host bridge: Advanced Micro Devices, Inc. [AMD] Device 1424 00:02.1 PCI bridge: Advanced Micro Devices, Inc. [AMD] Device 1425 00:03.0 Host bridge: Advanced Micro Devices, Inc. [AMD] Device 1424 00:03.1 PCI bridge: Advanced Micro Devices, Inc. [AMD] Family 15h (Models 30h-3fh) Processor Root Port 00:04.0 Host bridge: Advanced Micro Devices, Inc. [AMD] Device 1424 00:10.0 USB controller: Advanced Micro Devices, Inc. [AMD] FCH USB XHCI Controller (rev 09) 00:10.1 USB controller: Advanced Micro Devices, Inc. [AMD] FCH USB XHCI Controller (rev 09) 00:11.0 SATA controller: Advanced Micro Devices, Inc. [AMD] FCH SATA Controller [AHCI mode] (rev 40) 00:12.0 USB controller: Advanced Micro Devices, Inc. [AMD] FCH USB OHCI Controller (rev 11) 00:12.2 USB controller: Advanced Micro Devices, Inc. [AMD] FCH USB EHCI Controller (rev 11) 00:13.0 USB controller: Advanced Micro Devices, Inc. [AMD] FCH USB OHCI Controller (rev 11) 00:13.2 USB controller: Advanced Micro Devices, Inc. [AMD] FCH USB EHCI Controller (rev 11) 00:14.0 SMBus: Advanced Micro Devices, Inc. [AMD] FCH SMBus Controller (rev 16) 00:14.1 IDE interface: Advanced Micro Devices, Inc. [AMD] FCH IDE Controller 00:14.2 Audio device: Advanced Micro Devices, Inc. [AMD] FCH Azalia Controller (rev 01) 00:14.3 ISA bridge: Advanced Micro Devices, Inc. [AMD] FCH LPC Bridge (rev 11) 00:14.4 PCI bridge: Advanced Micro Devices, Inc. [AMD] FCH PCI Bridge (rev 40) 00:14.5 USB controller: Advanced Micro Devices, Inc. [AMD] FCH USB OHCI Controller (rev 11) 00:15.0 PCI bridge: Advanced Micro Devices, Inc. [AMD] Hudson PCI to PCI bridge (PCIE port 0) 00:15.2 PCI bridge: Advanced Micro Devices, Inc. [AMD] Hudson PCI to PCI bridge (PCIE port 2) 00:15.3 PCI bridge: Advanced Micro Devices, Inc. [AMD] Hudson PCI to PCI bridge (PCIE port 3) 00:18.0 Host bridge: Advanced Micro Devices, Inc. [AMD] Family 15h (Models 30h-3fh) Processor Function 0 00:18.1 Host bridge: Advanced Micro Devices, Inc. [AMD] Family 15h (Models 30h-3fh) Processor Function 1 00:18.2 Host bridge: Advanced Micro Devices, Inc. [AMD] Family 15h (Models 30h-3fh) Processor Function 2 00:18.3 Host bridge: Advanced Micro Devices, Inc. [AMD] Family 15h (Models 30h-3fh) Processor Function 3 00:18.4 Host bridge: Advanced Micro Devices, Inc. [AMD] Family 15h (Models 30h-3fh) Processor Function 4 00:18.5 Host bridge: Advanced Micro Devices, Inc. [AMD] Family 15h (Models 30h-3fh) Processor Function 5 01:00.0 VGA compatible controller: Advanced Micro Devices, Inc. [AMD/ATI] Hawaii PRO [Radeon R9 290] 01:00.1 Audio device: Advanced Micro Devices, Inc. [AMD/ATI] Device aac8 02:00.0 VGA compatible controller: NVIDIA Corporation G92 [GeForce 9800 GT] (rev a2) 03:07.0 VGA compatible controller: Advanced Micro Devices, Inc. [AMD/ATI] RV280 [Radeon 9200 PRO] (rev 01) 03:07.1 Display controller: Advanced Micro Devices, Inc. [AMD/ATI] RV280 [Radeon 9200 PRO] (Secondary) (rev 01) 05:00.0 USB controller: ASMedia Technology Inc. ASM1042A USB 3.0 Host Controller 06:00.0 Ethernet controller: Qualcomm Atheros Killer E220x Gigabit Ethernet Controller (rev 10)</code></pre></div><div class="quotebox"><cite>Duelist wrote:</cite><blockquote><div><p>I&#039;d suggest you to move to OVMF. That helped me much. In fact, that&#039;s the only way i&#039;m able to run VM stable.</p></div></blockquote></div><p>I will work on this then. Will this require me to get the guest OS UEFI-bootable? At the moment it is installed on an MBR-partitioned virtual drive.</p><div class="quotebox"><cite>Duelist wrote:</cite><blockquote><div><p>P.S.<br />And why do you have <strong>three</strong> different GPUs in your system?..</p></div></blockquote></div><p>I only installed the third so that I could get the BIOS to select a card other than the one I&#039;m using for passthrough to not be the primary VGA adapter. The setup screen only allows me to select &quot;PCI Express&quot;, &quot;PCI&quot;, or &quot;Onboard&quot;. The other two are both pci-e and I&#039;m pretty sure I don&#039;t actually have onboard graphics because I&#039;m running a non-APU on an FM2+ board.</p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1519216">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1519234" class="blockpost rowodd"> <h2><span><span class="conr">#4794</span> <a href="viewtopic.php?pid=1519234#p1519234">2015-04-12 19:28:30</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=85314">Duelist</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2014-09-22</span></dd> <dd><span>Posts: 358</span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>ughman wrote:</cite><blockquote><div><p>I will work on this then. Will this require me to get the guest OS UEFI-bootable? At the moment it is installed on an MBR-partitioned virtual drive.</p></div></blockquote></div><p>Yes, the OS will need to be UEFI-bootable. Using <a href="http://www.linux-kvm.org/downloads/lersek/ovmf-whitepaper-c770f8c.txt" rel="nofollow">OVMF whitepaper</a> you can get Windows 7 to boot.</p><div class="quotebox"><blockquote><div><p>I&#039;m running a non-APU on an FM2+ board.</p></div></blockquote></div><p>AH THE PAIN I FEEL.<br />So you have AMD Athlon 860K(kaveri) or something and you are experiencing same problems as i&#039;ve had on 750K(trinity based).<br />God damn it...<br />And you even have A88X-based motherboard...<br />Damn it!<br />I&#039;ve considered upgrading my system to 860K+A88X, but seems like my system can not be saved.</p><p>So, the <strong>only way</strong> to run vfio-pci <span class="bbu">stable</span> on AMD APU-based Athlon CPUs or APUs is OVMF.</p><p>UPD:<br />Just checked AMD&#039;s revision guide on fam15h mod30h-3fh - they&#039;ve deleted a lot of bugs, but the IOMMU ones are still present. Still not quite sure what do they mean.</p> <p class="postedit"><em>Last edited by Duelist (2015-04-12 20:06:59)</em></p> </div> <div class="postsignature postmsg"><hr /><p><span class="bbs">The forum rules prohibit requesting support for distributions other than arch.</span><br /><a href="https://bbs.archlinux.org/viewtopic.php?pid=1551460#p1551460" rel="nofollow">I gave up.</a><a href="https://bbs.archlinux.org/viewtopic.php?id=162768" rel="nofollow"> It was too late.</a><br /><a href="http://pastebin.com/B3fL84bq" rel="nofollow">What I was trying to do</a>.<br /><a href="http://vfio.blogspot.com/" rel="nofollow">The reference about VFIO and KVM VGA passthrough.</a></p></div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1519234">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1519243" class="blockpost roweven"> <h2><span><span class="conr">#4795</span> <a href="viewtopic.php?pid=1519243#p1519243">2015-04-12 19:55:04</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=65869">Helios747</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2012-11-17</span></dd> <dd><span>Posts: 11</span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>nbhs wrote:</cite><blockquote><div><div class="quotebox"><cite>Helios747 wrote:</cite><blockquote><div><p>Did you mean to paste the changes to be made on the second line?</p><p>I think you just copied my win8boot.img line twice.</p></div></blockquote></div><p>-device scsi-cd != -device scsi-hd</p><p>this</p><div class="codebox"><pre><code>-drive file=/home/anthony/win8boot.img,id=isocd,if=none -device scsi-cd,drive=isocd \</code></pre></div><p>to this</p><div class="codebox"><pre><code>-drive file=/home/anthony/win8boot.img,id=isocd,if=none -device scsi-hd,drive=isocd \</code></pre></div></div></blockquote></div><br /><p>THANK YOU. IT BOOTS!</p><p>I installed windows 8.1, and nVidia drivers installed just fine! Device Manager shows my 770 running properly!</p><p>All I need now is sound, but that should be simple enough.</p><p>Also, for anybody lurking this thread, I got this all working in Arch Linux with the vfio kernel from AUR. I had trouble getting in working in Ubuntu or Fedora so I said screw it and installed Arch.</p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1519243">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1519252" class="blockpost rowodd"> <h2><span><span class="conr">#4796</span> <a href="viewtopic.php?pid=1519252#p1519252">2015-04-12 20:29:35</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=85314">Duelist</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2014-09-22</span></dd> <dd><span>Posts: 358</span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>Helios747 wrote:</cite><blockquote><div><p>I had trouble getting in working in Ubuntu or Fedora so I said screw it and installed Arch.</p></div></blockquote></div><p>Well, you do know that aw(who wrote vfio-pci) is a redhat developer and he&#039;s using.. well.. redhat products?<br />As my long experience reading this thread says, it&#039;s either hardware or people, rarely software problems. So this should work distribution-independent.</p> </div> <div class="postsignature postmsg"><hr /><p><span class="bbs">The forum rules prohibit requesting support for distributions other than arch.</span><br /><a href="https://bbs.archlinux.org/viewtopic.php?pid=1551460#p1551460" rel="nofollow">I gave up.</a><a href="https://bbs.archlinux.org/viewtopic.php?id=162768" rel="nofollow"> It was too late.</a><br /><a href="http://pastebin.com/B3fL84bq" rel="nofollow">What I was trying to do</a>.<br /><a href="http://vfio.blogspot.com/" rel="nofollow">The reference about VFIO and KVM VGA passthrough.</a></p></div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1519252">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1519268" class="blockpost roweven"> <h2><span><span class="conr">#4797</span> <a href="viewtopic.php?pid=1519268#p1519268">2015-04-12 21:27:01</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=76557">logix</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2013-11-04</span></dd> <dd><span>Posts: 12</span></dd> <dd class="usercontacts"><span class="email"><a href="mailto:ken@logic.fm">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <p>We&#039;ll I&#039;m finally up and running with a successful GTX 770 pass (what a long adventure).</p><p> Looking for some performance tuning, performance is a bit choppy while gaming (med settings, easy to run game). Currently, I cannot get Windows 8 to boot with cpu=host. I get the SYSTEM_THREAD_EXCEPTION_NOT_HANDLED error. I have to use cpu=qemu64 to boot.</p><p>Any advice for my boot script?</p><div class="codebox"><pre><code>sudo qemu-system-x86_64 -enable-kvm -m 10240 -cpu qemu64,kvm=off -smp 4,sockets=1,cores=4,threads=4 \ -device vfio-pci,host=03:00.0,x-vga=on \ -device vfio-pci,host=03:00.1 \ -device vfio-pci,host=00:1f.2 \ -device vfio-pci,host=06:00.0 \ -net nic -net bridge,br=br0 \ -rtc base=localtime,clock=host \ -soundhw hda \ -vga none</code></pre></div><p>I am just passing my SATA controller (00:1f.2) directly to the guest in order to boot, because it has Windows already installed on the ssd. 03:00.0 is GTX 770 and 06:00.0 is 1 of 3 USB controllers.</p><p>Edit: I&#039;m using a KVM switch and my monitors digital/analog input selector to switch between host and guest. I noticed that when my host goes to sleep, I cannot wake it back up. Any ideas on why?</p> <p class="postedit"><em>Last edited by logix (2015-04-12 21:34:45)</em></p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1519268">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1519295" class="blockpost rowodd"> <h2><span><span class="conr">#4798</span> <a href="viewtopic.php?pid=1519295#p1519295">2015-04-12 23:20:15</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=85314">Duelist</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2014-09-22</span></dd> <dd><span>Posts: 358</span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>logix wrote:</cite><blockquote><div><p>We&#039;ll I&#039;m finally up and running with a successful GTX 770 pass (what a long adventure).</p><p> Looking for some performance tuning, performance is a bit choppy while gaming (med settings, easy to run game). Currently, I cannot get Windows 8 to boot with cpu=host. I get the SYSTEM_THREAD_EXCEPTION_NOT_HANDLED error. I have to use cpu=qemu64 to boot.</p><p>Any advice for my boot script?</p><div class="codebox"><pre><code>sudo qemu-system-x86_64 -enable-kvm -m 10240 -cpu qemu64,kvm=off -smp 4,sockets=1,cores=4,threads=4 \ -device vfio-pci,host=03:00.0,x-vga=on \ -device vfio-pci,host=03:00.1 \ -device vfio-pci,host=00:1f.2 \ -device vfio-pci,host=06:00.0 \ -net nic -net bridge,br=br0 \ -rtc base=localtime,clock=host \ -soundhw hda \ -vga none</code></pre></div><p>I am just passing my SATA controller (00:1f.2) directly to the guest in order to boot, because it has Windows already installed on the ssd. 03:00.0 is GTX 770 and 06:00.0 is 1 of 3 USB controllers.</p><p>Edit: I&#039;m using a KVM switch and my monitors digital/analog input selector to switch between host and guest. I noticed that when my host goes to sleep, I cannot wake it back up. Any ideas on why?</p></div></blockquote></div><p>There&#039;s a lot of options for -cpu. Choose one that will represent your cpu best, usually i do -cpu host.<br />Also, when -smp cores=NUM or sockets=NUM or threads=NUM argument is supplied, the first -smp NUMBER is ignored.<br />If you want the most simple config - use -smp 4(that&#039;ll give you 4 cores).<br />If you want to follow your cpu&#039;s logical core topology as stated in lscpu, you&#039;d do something like -smp sockets=1,cores=4,thread=2(NUM threads is NUM threads <strong>per core</strong>), that&#039;ll give your guest EIGHT logical cpus, like on a real core i7-alike CPU with hyperthreading.<br />If you&#039;ll specify, let&#039;s say, one socket, four cores-per-socket and four threads-per-core while having a regular four core host, you&#039;d have a huge performance hit because every one physical core would need to work as two logical cores. When using libvirt, there&#039;s a warning issued about that.</p><p>So, currently your machine is having one socket, four cores per socket and four threads per core, which sums up into 16 logical cores. Y&#039; sure that you have that much? What does your VM&#039;s task manager say about that?</p><p>You could also try enabling hugepages or npt.<br />And you can try pinning your cpus, since looks like you have a lot of cpu cores. Usually that improves latencies and performance alot.</p><p>Regarding your edit:<br />I guess your KVM switch is passive, and just disconnects your mouse and keyboard from the machine. Of course when it&#039;s disconnected, your firmware lefts those ports unpowered and it doesn&#039;t wait for any signals to come from them. When the power is given, KVM switch is switching somewhere.<br />Actually, that&#039;s a way i&#039;ve considered going back in the day, but i&#039;ve stayed on libvirt&#039;s VNC &quot;display&quot; - works like a charm, even ACPI power button event is transfered into VM.<br />But being kind of dumb and retarded, instead of going netjack way or any other way of software audio output, i&#039;ve built a hardware audio mixer just4lulz and plugged a separate sound card for host needs. So your mileage may vary.</p><p>P.S.<br />Windows 7 is limited to one or two sockets depending on the edition, but it&#039;s not limited on overall core or thread core, so it&#039;s legal to put two opteron-6300s CPUs and have 32 cores on a real machine, and of course it&#039;s possible to do so in a VM.</p> <p class="postedit"><em>Last edited by Duelist (2015-04-12 23:27:42)</em></p> </div> <div class="postsignature postmsg"><hr /><p><span class="bbs">The forum rules prohibit requesting support for distributions other than arch.</span><br /><a href="https://bbs.archlinux.org/viewtopic.php?pid=1551460#p1551460" rel="nofollow">I gave up.</a><a href="https://bbs.archlinux.org/viewtopic.php?id=162768" rel="nofollow"> It was too late.</a><br /><a href="http://pastebin.com/B3fL84bq" rel="nofollow">What I was trying to do</a>.<br /><a href="http://vfio.blogspot.com/" rel="nofollow">The reference about VFIO and KVM VGA passthrough.</a></p></div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1519295">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1519298" class="blockpost roweven"> <h2><span><span class="conr">#4799</span> <a href="viewtopic.php?pid=1519298#p1519298">2015-04-12 23:29:06</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=65869">Helios747</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2012-11-17</span></dd> <dd><span>Posts: 11</span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>Duelist wrote:</cite><blockquote><div><div class="quotebox"><cite>Helios747 wrote:</cite><blockquote><div><p>I had trouble getting in working in Ubuntu or Fedora so I said screw it and installed Arch.</p></div></blockquote></div><p>Well, you do know that aw(who wrote vfio-pci) is a redhat developer and he&#039;s using.. well.. redhat products?<br />As my long experience reading this thread says, it&#039;s either hardware or people, rarely software problems. So this should work distribution-independent.</p></div></blockquote></div><p>It was simpler for me because I didn&#039;t have to translate many steps listed in this guide to work with various distros. All the steps he gave here worked without modification in Arch Linux.</p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1519298">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1519307" class="blockpost rowodd"> <h2><span><span class="conr">#4800</span> <a href="viewtopic.php?pid=1519307#p1519307">2015-04-13 00:32:06</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=65869">Helios747</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2012-11-17</span></dd> <dd><span>Posts: 11</span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <p>One last issue I&#039;m having, is the sound in the Windows 8.1 VM is choppy. I&#039;m thinking about working around this by simply giving the VM my g930 through a USB passthrough, but if I can I&#039;d like to fix this.</p><p>This is my command line</p><div class="quotebox"><blockquote><div><p>#!/bin/sh</p><p>QEMU_ALSA_DAC_BUFFER_SIZE=512 QEMU_ALSA_DAC_PERIOD_SIZE=170 QEMU_AUDIO_DRV=alsa qemu-system-x86_64 -enable-kvm -m 8192 -cpu host,kvm=off&#160; \<br />-smp 4,sockets=1,cores=2,threads=2 \<br />-drive if=pflash,format=raw,readonly,file=/usr/share/ovmf/x64/ovmf_code_x64.bin \<br />-drive if=pflash,format=raw,file=/usr/share/ovmf/x64/ovmf_vars_x64.bin \<br />-device vfio-pci,host=01:00.0 -device vfio-pci,host=01:00.1 \<br />-vga none \<br />-device virtio-scsi-pci,id=scsi \<br />-drive file=/dev/SSD/lvWinRoot,id=disk,format=raw,if=none -device scsi-hd,drive=disk \<br />-drive file=/dev/HDD/lvWinStorage,id=disk2,format=raw,if=none -device scsi-hd,drive=disk2 \<br />-usb -usbdevice host:046d:c31c -usbdevice host:062a:3621 -usbdevice host:1532:0201 \<br />-soundhw hda</p></div></blockquote></div><p>The audio device Linux is routing this through is &quot;Analog output&quot; on my Logitech G930 headset. I tried the pulseaudio driver but the problem was even worse.</p><p>The OP said I&#039;d have to mess around with those env variables to get sound working right but I don&#039;t really know how to mess with them. Should I increase the values? Decrease?</p> <p class="postedit"><em>Last edited by Helios747 (2015-04-13 00:32:50)</em></p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1519307">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div class="postlinksb"> <div class="inbox crumbsplus"> <div class="pagepost"> <p class="pagelink conl"><span class="pages-label">Pages: </span><a rel="prev" class="item1" href="viewtopic.php?id=162768&amp;p=191">Previous</a> <a href="viewtopic.php?id=162768">1</a> <span class="spacer">…</span> <a href="viewtopic.php?id=162768&amp;p=190">190</a> <a href="viewtopic.php?id=162768&amp;p=191">191</a> <strong>192</strong> <a href="viewtopic.php?id=162768&amp;p=193">193</a> <a href="viewtopic.php?id=162768&amp;p=194">194</a> <span class="spacer">…</span> <a href="viewtopic.php?id=162768&amp;p=234">234</a> <a rel="next" href="viewtopic.php?id=162768&amp;p=193">Next</a></p> <p class="postlink conr">Topic closed</p> </div> <ul class="crumbs"> <li><a href="index.php">Index</a></li> <li><span>»&#160;</span><a href="viewforum.php?id=48">Topics Going Nowhere</a></li> <li><span>»&#160;</span><strong><a href="viewtopic.php?id=162768">KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</a></strong></li> </ul> <p class="subscribelink clearb"><a href="misc.php?action=subscribe&amp;tid=162768">Subscribe to this topic</a></p> <div class="clearer"></div> </div> </div> </div> <div id="brdfooter" class="block"> <h2><span>Board footer</span></h2> <div class="box"> <div id="brdfooternav" class="inbox"> <div class="conl"> <form id="qjump" method="get" action="viewforum.php"> <div><label><span>Jump to<br /></span> <select name="id" onchange="window.location=('viewforum.php?id='+this.options[this.selectedIndex].value)"> <optgroup label="Technical Issues and Assistance"> <option value="23">Newbie Corner</option> <option value="17">Installation</option> <option value="22">Kernel &amp; Hardware</option> <option value="18">Applications &amp; Desktop Environments</option> <option value="31">Laptop Issues</option> <option value="8">Networking, Server, and Protection</option> <option value="32">Multimedia and Games</option> <option value="50">System Administration</option> <option value="35">Other Architectures</option> </optgroup> <optgroup label="Arch-centric"> <option value="24">Announcements, Package &amp; Security Advisories</option> <option value="1">Arch Discussion</option> <option value="13">Forum &amp; Wiki discussion</option> </optgroup> <optgroup label="Pacman Upgrades, Packaging &amp; AUR"> <option value="44">Pacman &amp; Package Upgrade Issues</option> <option value="49">[testing] Repo Forum</option> <option value="4">Creating &amp; Modifying Packages</option> <option value="38">AUR Issues, Discussion &amp; PKGBUILD Requests</option> </optgroup> <optgroup label="Contributions &amp; Discussion"> <option value="20">GNU/Linux Discussion</option> <option value="27">Community Contributions</option> <option value="33">Programming &amp; Scripting</option> <option value="30">Other Languages</option> <option value="47">Artwork and Screenshots</option> <option value="42">Try This</option> </optgroup> <optgroup label="/dev/null"> <option value="29">Off-Topic</option> <option value="48" selected="selected">Topics Going Nowhere</option> <option value="36">Dustbin</option> </optgroup> </select></label> <input type="submit" value=" Go " accesskey="g" /> </div> </form> </div> <div class="conr"> <p id="feedlinks"><span class="atom"><a href="extern.php?action=feed&amp;tid=162768&amp;type=atom">Atom topic feed</a></span></p> <p id="poweredby">Powered by <a href="http://fluxbb.org/">FluxBB</a></p> </div> <div class="clearer"></div> </div> </div> </div> </div> <div class="end-box"></div> </div> </body> </html>
