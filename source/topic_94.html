<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"> <html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en" dir="ltr"> <head> <meta http-equiv="Content-Type" content="text/html; charset=utf-8" /> <title>KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9 (Page 94) / Topics Going Nowhere / Arch Linux Forums</title> <link rel="stylesheet" type="text/css" href="style/ArchLinux.css" /> <link rel="canonical" href="viewtopic.php?id=162768&amp;p=94" title="Page 94" /> <link rel="prev" href="viewtopic.php?id=162768&amp;p=93" title="Page 93" /> <link rel="next" href="viewtopic.php?id=162768&amp;p=95" title="Page 95" /> <link rel="alternate" type="application/atom+xml" href="extern.php?action=feed&amp;tid=162768&amp;type=atom" title="Atom topic feed" /> <link rel="stylesheet" media="screen" href="style/ArchLinux/arch.css?v=3" /> <link rel="stylesheet" media="screen" href="style/ArchLinux/archnavbar.css?v=2" /> <link rel="shortcut icon" href="style/ArchLinux/favicon.ico" /> </head> <body> <div id="archnavbar" class="anb-forum"> <div id="archnavbarlogo"><h1><a href="http://www.archlinux.org/">Arch Linux</a></h1></div> <div id="archnavbarmenu"> <ul id="archnavbarlist"> <li id="anb-home"><a href="http://www.archlinux.org/">Home</a></li><li id="anb-packages"><a href="http://www.archlinux.org/packages/">Packages</a></li><li id="anb-forums" class="anb-selected"><a href="https://bbs.archlinux.org/">Forums</a></li><li id="anb-wiki"><a href="https://wiki.archlinux.org/">Wiki</a></li><li id="anb-bugs"><a href="https://bugs.archlinux.org/">Bugs</a></li><li id="anb-aur"><a href="https://aur.archlinux.org/">AUR</a></li><li id="anb-download"><a href="http://www.archlinux.org/download/">Download</a></li> </ul> </div> </div> <div id="punviewtopic" class="pun"> <div class="top-box"></div> <div class="punwrap"> <div id="brdheader" class="block"> <div class="box"> <div id="brdmenu" class="inbox"> <ul> <li id="navindex" class="isactive"><a href="index.php">Index</a></li> <li id="navuserlist"><a href="userlist.php">User list</a></li> <li id="navsearch"><a href="search.php">Search</a></li> <li id="navprofile"><a href="profile.php?id=80749">Profile</a></li> <li id="navlogout"><a href="login.php?action=out&amp;id=80749&amp;csrf_token=5c20501ec397bb45ef8ee8c84db232c8d8e421c6">Logout</a></li> </ul> </div> <div id="brdwelcome" class="inbox"> <ul class="conl"> <li><span>Logged in as <strong>SXX</strong></span></li> <li><span>Last visit: 2015-08-16 12:20:09</span></li> </ul> <ul class="conr"> <li><span>Topics: <a href="search.php?action=show_replies" title="Find topics you have posted to.">Posted</a> | <a href="search.php?action=show_new" title="Find topics with new posts since your last visit.">New</a> | <a href="search.php?action=show_recent" title="Find topics with recent posts.">Active</a> | <a href="search.php?action=show_unanswered" title="Find topics with no replies.">Unanswered</a></span></li> </ul> <div class="clearer"></div> </div> </div> </div> <div id="brdmain"> <div class="linkst"> <div class="inbox crumbsplus"> <ul class="crumbs"> <li><a href="index.php">Index</a></li> <li><span>»&#160;</span><a href="viewforum.php?id=48">Topics Going Nowhere</a></li> <li><span>»&#160;</span><strong><a href="viewtopic.php?id=162768">KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</a></strong></li> </ul> <div class="pagepost"> <p class="pagelink conl"><span class="pages-label">Pages: </span><a rel="prev" class="item1" href="viewtopic.php?id=162768&amp;p=93">Previous</a> <a href="viewtopic.php?id=162768">1</a> <span class="spacer">…</span> <a href="viewtopic.php?id=162768&amp;p=92">92</a> <a href="viewtopic.php?id=162768&amp;p=93">93</a> <strong>94</strong> <a href="viewtopic.php?id=162768&amp;p=95">95</a> <a href="viewtopic.php?id=162768&amp;p=96">96</a> <span class="spacer">…</span> <a href="viewtopic.php?id=162768&amp;p=234">234</a> <a rel="next" href="viewtopic.php?id=162768&amp;p=95">Next</a></p> <p class="postlink conr">Topic closed</p> </div> <div class="clearer"></div> </div> </div> <div id="p1436859" class="blockpost rowodd blockpost1"> <h2><span><span class="conr">#2326</span> <a href="viewtopic.php?pid=1436859#p1436859">2014-07-17 01:39:52</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=83617">paigeadele</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2014-07-17</span></dd> <dd><span>Posts: 3</span></dd> <dd class="usercontacts"><span class="email"><a href="mailto:paigeadele@gmail.com">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <p>I got mine working on gentoo, a friend of mine helped me with some performance issues as well. Here all some links to the scripts I use to start the windows VM: </p><p><a href="https://github.com/paigeadele/windowlicker.yourstruly.sx/blob/master/run_windows.sh" rel="nofollow">https://github.com/paigeadele/windowlic … windows.sh</a></p><p>I added the (-cpu host,hv_relaxed,hv_vapic,hv_time,hv_spinlocks=0x1000) options a friend of mine said that they help, but I haven&#039;t benchmarked it yet to see if there&#039;s any difference. I&#039;m using an ATI Radeon 5770 which I may upgrade now that I&#039;ve at least seen this work. Initially I had configured the cpu topology to use two sockets, 2 cores each and decided to reduce it to 1 and 6 cores in case using 2 sockets might have been adding any contention...was mostly just curious to see how it worked. I haven&#039;t found much good documentation on the hv_spinlocks and threads=1 stuff, I&#039;m curious to see how the impact the responsiveness. I also figured out how to setup macvtap which I currently use for all of my libvirtd instances.</p><p><a href="https://github.com/paigeadele/windowlicker.yourstruly.sx/blob/master/kernels/kernel-config-x86_64-3.15.5-gentoo" rel="nofollow">https://github.com/paigeadele/windowlic … 5.5-gentoo</a></p><p>someone posted in this forum about enabling preemption helping (though I thought preemption didn&#039;t work on it&#039;s own.) I also set the ticks frequency to 1000hz and figured at least that option might make some difference. </p><p>Everything seems to be working fine, theres one issue with netflix when the playback menu pops up when you hover over it that makes the video lag a bit... and I&#039;m not sure if thats the card being slow or processor bottleneck....lots to figure out but everything is awesome, thank you for this post!</p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1436859">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1436870" class="blockpost roweven"> <h2><span><span class="conr">#2327</span> <a href="viewtopic.php?pid=1436870#p1436870">2014-07-17 02:44:20</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=83617">paigeadele</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2014-07-17</span></dd> <dd><span>Posts: 3</span></dd> <dd class="usercontacts"><span class="email"><a href="mailto:paigeadele@gmail.com">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <p>Interesting, removed the threads=1 to see if it would let it spin up however many threads it wants, seem to be a little snappier but hard to tell. </p><p><a href="http://imgur.com/6W8Nbnl" rel="nofollow">http://imgur.com/6W8Nbnl</a></p><p>Was having some trouble with HD video playback on netflix in firefox. It seems a little slow / choppy,... yeah still same.. I wonder why... silverlight / plugin container seems to eat up quite a bit of cpu in the vm</p><p>I guess I could unmask the 9999 qemu build and give it a try.</p> <p class="postedit"><em>Last edited by paigeadele (2014-07-17 02:54:04)</em></p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1436870">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1436874" class="blockpost rowodd"> <h2><span><span class="conr">#2328</span> <a href="viewtopic.php?pid=1436874#p1436874">2014-07-17 02:54:07</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=75590">aw</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2013-10-04</span></dd> <dd><span>Posts: 921</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=75590">Email</a></span> <span class="website"><a href="http://vfio.blogspot.com/" rel="nofollow">Website</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>paigeadele wrote:</cite><blockquote><div><p>Interesting, removed the threads=1 to see if it would let it spin up however many threads it wants, seem to be a little snappier but hard to tell. </p><p><a href="http://imgur.com/6W8Nbnl" rel="nofollow">http://imgur.com/6W8Nbnl</a></p><p>Was having some trouble with HD video playback on netflix in firefox. It seems a little slow / choppy,... yeah still same.. I wonder why... silverlight / plugin container seems to eat up quite a bit of cpu in the vm</p></div></blockquote></div><p><em>threads</em> is just a modifier of the topology of the vCPU, it exposes processor threads, or <a href="http://en.wikipedia.org/wiki/Hyper-threading" rel="nofollow">hyper threads</a>.&#160; <em>threads=1</em> is the default, each core has one thread.&#160; Core i5/i7 processors often have 2 threads per core.&#160; The total number of vCPUs exposed to the guest is &quot;<em>sockets</em> x <em>cores</em> x <em>threads</em>&quot;.&#160; The guest scheduler can make various optimizations given a topology, like optimizing for power efficiency by only running on a single socket, or optimizing for throughput by using cores within the same socket or only a single thread per core, etc.</p> </div> <div class="postsignature postmsg"><hr /><p><a href="http://vfio.blogspot.com" rel="nofollow">http://vfio.blogspot.com</a><br />Looking for a more open forum to discuss vfio related uses?&#160; Try <a href="https://www.redhat.com/mailman/listinfo/vfio-users" rel="nofollow">https://www.redhat.com/mailman/listinfo/vfio-users</a></p></div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1436874">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1436876" class="blockpost roweven"> <h2><span><span class="conr">#2329</span> <a href="viewtopic.php?pid=1436876#p1436876">2014-07-17 03:02:21</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=83617">paigeadele</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2014-07-17</span></dd> <dd><span>Posts: 3</span></dd> <dd class="usercontacts"><span class="email"><a href="mailto:paigeadele@gmail.com">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <p>gotcha, yeah I&#039;m building the qemu 9999 package now I&#039;ll see if there&#039;s much of a performance change since 2.0</p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1436876">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1436953" class="blockpost rowodd"> <h2><span><span class="conr">#2330</span> <a href="viewtopic.php?pid=1436953#p1436953">2014-07-17 09:44:47</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=79237">mbroemme</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>From: Cologne</span></dd> <dd><span>Registered: 2014-02-05</span></dd> <dd><span>Posts: 39</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=79237">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>aw wrote:</cite><blockquote><div><div class="quotebox"><cite>mbroemme wrote:</cite><blockquote><div><p>I&#039;ve tested them against 3.16-rc5 kernel. They apply clean, I&#039;ve rebooted and re-tested my Linux + fglrx and Windows + catalyst with my R9 290X. It still suffers from the reset problem. <img src="https://bbs.archlinux.org/img/smilies/sad.png" width="15" height="15" alt="sad" /> On Linux + fglrx I get oops (inside VM) after reboot of VM and X start. On Windows + catalyst I still get the BSOD PAGE_FAULT_IN_NONPAGED_AREA.</p></div></blockquote></div><p>Bummer.&#160; Is the oops a regression or is that something you see already?</p></div></blockquote></div><p>It is the same.</p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1436953">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1436970" class="blockpost roweven"> <h2><span><span class="conr">#2331</span> <a href="viewtopic.php?pid=1436970#p1436970">2014-07-17 10:57:04</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=83626">DLWood1001</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2014-07-17</span></dd> <dd><span>Posts: 4</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=83626">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <p>aw,</p><p>I tested the reset patch against 3.15.5 mainline. Patches applied with no merge problems, however it didn&#039;t reset the card. Using Sapphire R9 290x Tri-X. I&#039;ll try building 3.16-rc5 tonight and reply back if there is any improvement.</p><p>On a side note, your dma-alias-v4 patch series worked great for me; fixed the Intel 82801 issue I was seeing.</p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1436970">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1437056" class="blockpost rowodd"> <h2><span><span class="conr">#2332</span> <a href="viewtopic.php?pid=1437056#p1437056">2014-07-17 15:05:45</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=75590">aw</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2013-10-04</span></dd> <dd><span>Posts: 921</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=75590">Email</a></span> <span class="website"><a href="http://vfio.blogspot.com/" rel="nofollow">Website</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>DLWood1001 wrote:</cite><blockquote><div><p>aw,</p><p>I tested the reset patch against 3.15.5 mainline. Patches applied with no merge problems, however it didn&#039;t reset the card. Using Sapphire R9 290x Tri-X. I&#039;ll try building 3.16-rc5 tonight and reply back if there is any improvement.</p></div></blockquote></div><p>Thanks for the test, both series weren&#039;t really targeted at fixing this, but I needed to add a device specific reset for my Oland-based HD8570 to get it to reset on release and I thought it worth a test to see if it fixed anything.&#160; If you kill the qemu process with these patches, what happens on your r9 290x?&#160; Does the monitor stay in sync and the framebuffer show the last image, or does the monitor go blank and the GPU fan reset to high speed?</p><div class="quotebox"><blockquote><div><p>On a side note, your dma-alias-v4 patch series worked great for me; fixed the Intel 82801 issue I was seeing.</p></div></blockquote></div><p>Great, these should show up in 3.17</p> </div> <div class="postsignature postmsg"><hr /><p><a href="http://vfio.blogspot.com" rel="nofollow">http://vfio.blogspot.com</a><br />Looking for a more open forum to discuss vfio related uses?&#160; Try <a href="https://www.redhat.com/mailman/listinfo/vfio-users" rel="nofollow">https://www.redhat.com/mailman/listinfo/vfio-users</a></p></div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1437056">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1437169" class="blockpost roweven"> <h2><span><span class="conr">#2333</span> <a href="viewtopic.php?pid=1437169#p1437169">2014-07-17 21:30:52</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=66944">shrubuntu</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2012-12-26</span></dd> <dd><span>Posts: 16</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=66944">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <p>Anyone have success with the GTX 580?</p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1437169">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1437622" class="blockpost rowodd"> <h2><span><span class="conr">#2334</span> <a href="viewtopic.php?pid=1437622#p1437622">2014-07-19 09:18:04</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=73114">noctavian</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2013-07-11</span></dd> <dd><span>Posts: 9</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=73114">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>shrubuntu wrote:</cite><blockquote><div><p>Anyone have success with the GTX 580?</p></div></blockquote></div><p>Take a look at this<br /><a href="https://bbs.archlinux.org/viewtopic.php?pid=1371808#p1371808" rel="nofollow">https://bbs.archlinux.org/viewtopic.php … 8#p1371808</a></p><p>And there is also this<br /><a href="https://docs.google.com/spreadsheet/ccc?key=0Aryg5nO-kBebdFozaW9tUWdVd2VHM0lvck95TUlpMlE&amp;usp=drive_web#gid=0" rel="nofollow">https://docs.google.com/spreadsheet/ccc … _web#gid=0</a></p> </div> <div class="postsignature postmsg"><hr /><p><a href="https://docs.google.com/spreadsheet/ccc?key=0Aryg5nO-kBebdFozaW9tUWdVd2VHM0lvck95TUlpMlE&amp;usp=drive_web#gid=0" rel="nofollow">VGA-Passthrough configs</a></p></div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1437622">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1437726" class="blockpost roweven"> <h2><span><span class="conr">#2335</span> <a href="viewtopic.php?pid=1437726#p1437726">2014-07-19 14:36:56</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=45496">BitMaster</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2011-01-15</span></dd> <dd><span>Posts: 2</span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <p>I&#039;m using this setup:</p><ul><li><p><a href="http://www.asus.com/Motherboards/CSB/specifications/" rel="nofollow">Asus CS-B with Q87 chipset</a> (BIOS: 1002)</p></li><li><p><a href="http://ark.intel.com/products/80807/" rel="nofollow">Intel i7-4790k</a> (with VT-d support)</p></li><li><p>Host GPU: Onboard Intel 4600, i915 driver, primary display adapter</p></li><li><p>Guest GPU: <a href="http://www.asus.com/Graphics_Cards/GTX780DC2OC3GD5/specifications/" rel="nofollow">Asus/Nvidia GeForce GTX 780</a></p></li><li><p>Booting with UEFI (gummiboot)</p></li></ul><p>First I applied all the OP patches (acs, i915 and vga arbiter) and this worked more or less. I got it booting with display on the Nvidia card, but it breaks the intel driver on the host. X switches to software rendering and glxinfo indicates it no longer uses Intel/Mesa OpenGL but instead VMware (?):</p><div class="codebox"><pre><code>$ glxinfo | grep OpenGL OpenGL vendor string: VMware, Inc. OpenGL renderer string: Gallium 0.4 on llvmpipe (LLVM 3.4, 256 bits) OpenGL version string: 3.0 Mesa 10.2.3 OpenGL shading language version string: 1.30 OpenGL context flags: (none) OpenGL extensions:</code></pre></div><p>Next i tried to minimize the amount of patches (in an effort to pinpoint the intel host driver issue). These are the remaining patches i need to have a working VGA passthrough: <a href="http://pastebin.com/MWMDeDPL" rel="nofollow">i915-vtd.patch</a>.<br />If i disable the </p><div class="codebox"><pre><code>i915_disable_vga_mem(dev);</code></pre></div><p> line in &#039;drivers/gpu/drm/i915/i915_dma.c&#039; X is in normal mode again and Intel/Mesa OpenGL is used, but sadly VGA passthrough is broken. This means the display goes to sleep mode when the virtual machine is started.</p><p>I scanned the driver code, but I can&#039;t find the line that enables the vga memory again (only on &#039;deinit/cleanup&#039;?). Is it impossible to use the onboard VGA memory in combination with VGA passthrough?<br />Any suggestions are very welcome!</p><p>----<br />Oh, by the way i disabled/blacklisted the nouveau module. My kernel parameters are nothing special:</p><div class="codebox"><pre><code>$ cat /proc/cmdline initrd=\initramfs-linux-vtd2.img root=PARTUUID=1b8f88d4-3bb2-4eae-abe8-180d0300f908 rw nouveau.modeset=0 quiet intel_iommu=on pci-stub.ids=10de:1004,10de:0e1a drm.debug=0x02</code></pre></div><p>I don&#039;t need to use pci-stub, as my graphics card is not bound to any driver on boot. Before i start the VM, I bind them to vfio (see OP). I use qemu-git from the AUR.</p> <p class="postedit"><em>Last edited by BitMaster (2014-07-19 14:58:29)</em></p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1437726">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1437917" class="blockpost rowodd"> <h2><span><span class="conr">#2336</span> <a href="viewtopic.php?pid=1437917#p1437917">2014-07-19 21:54:53</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=78217">DanaGoyette</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2014-01-03</span></dd> <dd><span>Posts: 46</span></dd> <dd class="usercontacts"><span class="email"><a href="mailto:danagoyette@gmail.com">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <p>I&#039;ve been lurking for a while, since the inability to bus-reset the R9 290 is kind of a show-stopper.&#160; I couldn&#039;t find an official bug report to follow for it, and the thread I found on the mailing lists has stopped.</p><p>I hope OVMF will get support for the Q35 machine soon.&#160; With a UEFI video card and a legacy-free (Windows 8.1) guest, you don&#039;t need the Intel VGA Arbiter.</p><p>I&#039;ve noticed that the instructions in the OP, as well as virt-manager, put all passed-through devices directly behind &quot;root port 0&quot;.&#160; <br />Real boards have one device (which may be a switch) behind each port, and each port (numbered starting at 1, not 0) has a different device ID.<br />I can&#039;t see how multiple devices behind one port has ever worked, and it wouldn&#039;t surprise me if drivers don&#039;t like it.</p><p>When I tried Q35 in non-EFI mode, I used this file to give multiple root ports: <a href="https://github.com/qemu/qemu/blob/master/docs/q35-chipset.cfg" rel="nofollow">https://github.com/qemu/qemu/blob/maste … hipset.cfg</a></p><p>(Interestingly enough, the &#039;-m q35&#039; default AHCI controller is named &#039;ide&#039;; you attach disks to bus ide.0, ide.1, and so on.)</p><p>Now, for a question: do you think it would be reasonable to start factoring device <em>types</em> into the building of IOMMU groups?</p><p>For example, given multiple video cards behind the Intel CPU ports, they are highly likely to converse peer-to-peer.<br />Given an LSI SAS controller and an AMD video card, on the other hand, what are the chances of one trying to talk to the other?</p> <p class="postedit"><em>Last edited by DanaGoyette (2014-07-19 22:01:42)</em></p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1437917">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1437964" class="blockpost roweven"> <h2><span><span class="conr">#2337</span> <a href="viewtopic.php?pid=1437964#p1437964">2014-07-20 01:20:46</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=83687">k0olfir3</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2014-07-20</span></dd> <dd><span>Posts: 7</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=83687">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <p>Hi all,</p><p>this thread is amazing. However, I have to admit that I didn&#039;t read all the 94 pages. </p><p>I tried to replicate the OP&#039;s procedures. Unfortunately, I have not been very succesfull so far. Whenever I test passing through the Video card my monitor stays blank. I have an Intel i7 4790 CPU on an AsRock Z87 Pro 4 board and a NVIDIA GTX 770 card. I use the OP&#039;s mainline kernel and git 2.0 from the standard Arch repositories. Here are some further details on my setup:</p><div class="codebox"><pre><code>uname -a Linux arch-desk 3.15.1-1-mainline #1 SMP PREEMPT Sun Jul 20 00:50:27 CEST 2014 x86_64 GNU/Linux</code></pre></div><div class="codebox"><pre><code>cat /proc/cmdline BOOT_IMAGE=/boot/vmlinuz-linux-mainline root=UUID=xxx quiet iommu=1 intel_iommu=on pci-stub.ids=10de:1184,10de:0e0a</code></pre></div><p>I noticed the following errors in dmesg when I run qemu without passing some romfile option:</p><div class="codebox"><pre><code>[ 5716.098747] [drm:hsw_unclaimed_reg_clear] *ERROR* Unknown unclaimed register before writing to c400c [ 5716.098802] [drm:intel_uncore_check_errors] *ERROR* Unclaimed register before interrupt [ 5716.098814] [drm:intel_uncore_check_errors] *ERROR* Unclaimed register before interrupt [ 5716.098827] [drm:intel_uncore_check_errors] *ERROR* Unclaimed register before interrupt</code></pre></div><p>These errors vanish if I use a vga-bios rom file I downloaded from: <a href="http://www.techpowerup.com/vgabios/145418/gainward-gtx770-2048-130704.html" rel="nofollow">http://www.techpowerup.com/vgabios/1454 … 30704.html</a>. Both my screen is staying blank in either case. I tried the OP&#039;s suggestions:</p><div class="codebox"><pre><code>vfio_iommu_type1.allow_unsafe_interrupts=1 and kvm_intel emulate_invalid_guest_state=0</code></pre></div><p>But that did not appear to change very much. Do you guys have any suggestions what I could try next? Am I missing something?</p><p>EDIT: I forgot to mention that I want to use the internal Intel GPU on the host system.</p> <p class="postedit"><em>Last edited by k0olfir3 (2014-07-20 01:25:21)</em></p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1437964">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1437967" class="blockpost rowodd"> <h2><span><span class="conr">#2338</span> <a href="viewtopic.php?pid=1437967#p1437967">2014-07-20 01:25:37</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=79578">AKSN74</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd class="postavatar"><img src="https://bbs.archlinux.org/img/avatars/79578.jpg?m=1423108340" width="80" height="80" alt="" /></dd> <dd><span>From: Taichung, Taiwan</span></dd> <dd><span>Registered: 2014-02-18</span></dd> <dd><span>Posts: 52</span></dd> <dd class="usercontacts"><span class="email"><a href="mailto:missile0407@gmail.com">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>aw wrote:</cite><blockquote><div><p>Hey folks,</p><p>I&#039;ve got some reset tweaks up for testing that might be useful to a number of you:</p><p><a href="https://lkml.org/lkml/2014/7/16/562" rel="nofollow">https://lkml.org/lkml/2014/7/16/562</a> (<a href="https://lkml.org/lkml/diff/2014/7/16/561/1" rel="nofollow">patch 1</a>, <a href="https://lkml.org/lkml/diff/2014/7/16/565/1" rel="nofollow">patch 2</a>, <a href="https://lkml.org/lkml/diff/2014/7/16/560/1" rel="nofollow">patch 3</a>)</p><p><a href="https://lkml.org/lkml/2014/7/16/567" rel="nofollow">https://lkml.org/lkml/2014/7/16/567</a> (<a href="https://lkml.org/lkml/diff/2014/7/16/567/1" rel="nofollow">patch</a>)</p><p>With these, the GPU should be reset regardless of how clean the guest was shutdown.&#160; Note that all devices on the bus need to be bound to vfio-pci for this to work.&#160; That means that if you&#039;re using pci-stub to sequester unused devices (perhaps the audio function), bind them to vfio-pci or there won&#039;t be any change.&#160; The second set of links is a patch necessary for AMD GPU users only and I&#039;d appreciate feedback on whether it solves and of the other reset issues (lack of reset) found on these GPUs.&#160; Thanks</p><p>PS - these are kernel patches against the latest development kernel, 3.16-rc5.&#160; They may or may not apply cleanly to older kernels.</p></div></blockquote></div><p>Thanks for aw&#039;s patch, I&#039;ll try this to solve VM reboot stuck issue in these days. And I&#039;ll report.</p><p>Also, I got another goods news is, now I can run CUDA perfectly in VM right now.</p><p>I found that I need to do this with GUI-based OS, so if I tried to run CUDA when the OS is terminal only (like Ubuntu Server), I need to launch GPU acceleration in text mode (for Linux, it means like &quot;init 3&quot;)<br />So I give up to try Ubuntu Server and change guest OS to Fedora 20, and when I finished the installation and entered into system. I checked host OS&#039;s dmesg.<br />And I found that IRQ is already set up while GUI interface launched.</p><div class="codebox"><pre><code>vfio-pci: 0000:03:00.0: irq 89 for MSI/MSI-X</code></pre></div><p>Then I install NVIDIA driver, CUDA SDK, and compile CUDA sample codes. After all, I run some sample application. It works perfectly! Now I&#039;m not get any strange errors.<br />Also I checked host dmesg each time I run CUDA application, and VFIO not reported IRQ changed message anymore. Just showed while Fedora boot.</p><p>But I still need to turn off GUI to get a better performance, fortunately someone knows how to get GPU acceleration with NVIDIA official driver in text mode.<br />I&#039;ll try it up and report that.</p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1437967">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1437983" class="blockpost roweven"> <h2><span><span class="conr">#2339</span> <a href="viewtopic.php?pid=1437983#p1437983">2014-07-20 03:40:13</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=70922">nbhs</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd class="postavatar"><img src="https://bbs.archlinux.org/img/avatars/70922.jpg?m=1367773811" width="80" height="80" alt="" /></dd> <dd><span>From: Montevideo, Uruguay</span></dd> <dd><span>Registered: 2013-05-02</span></dd> <dd><span>Posts: 402</span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>k0olfir3 wrote:</cite><blockquote><div><p>Hi all,</p><p>this thread is amazing. However, I have to admit that I didn&#039;t read all the 94 pages. </p><p>I tried to replicate the OP&#039;s procedures. Unfortunately, I have not been very succesfull so far. Whenever I test passing through the Video card my monitor stays blank. I have an Intel i7 4790 CPU on an AsRock Z87 Pro 4 board and a NVIDIA GTX 770 card. I use the OP&#039;s mainline kernel and git 2.0 from the standard Arch repositories. Here are some further details on my setup:</p><div class="codebox"><pre><code>uname -a Linux arch-desk 3.15.1-1-mainline #1 SMP PREEMPT Sun Jul 20 00:50:27 CEST 2014 x86_64 GNU/Linux</code></pre></div><div class="codebox"><pre><code>cat /proc/cmdline BOOT_IMAGE=/boot/vmlinuz-linux-mainline root=UUID=xxx quiet iommu=1 intel_iommu=on pci-stub.ids=10de:1184,10de:0e0a</code></pre></div><p>I noticed the following errors in dmesg when I run qemu without passing some romfile option:</p><div class="codebox"><pre><code>[ 5716.098747] [drm:hsw_unclaimed_reg_clear] *ERROR* Unknown unclaimed register before writing to c400c [ 5716.098802] [drm:intel_uncore_check_errors] *ERROR* Unclaimed register before interrupt [ 5716.098814] [drm:intel_uncore_check_errors] *ERROR* Unclaimed register before interrupt [ 5716.098827] [drm:intel_uncore_check_errors] *ERROR* Unclaimed register before interrupt</code></pre></div><p>These errors vanish if I use a vga-bios rom file I downloaded from: <a href="http://www.techpowerup.com/vgabios/145418/gainward-gtx770-2048-130704.html" rel="nofollow">http://www.techpowerup.com/vgabios/1454 … 30704.html</a>. Both my screen is staying blank in either case. I tried the OP&#039;s suggestions:</p><div class="codebox"><pre><code>vfio_iommu_type1.allow_unsafe_interrupts=1 and kvm_intel emulate_invalid_guest_state=0</code></pre></div><p>But that did not appear to change very much. Do you guys have any suggestions what I could try next? Am I missing something?</p><p>EDIT: I forgot to mention that I want to use the internal Intel GPU on the host system.</p></div></blockquote></div><p>You need to boot with i915.enable_hd_vgaarb=1 kernel parameter, this will disable dri on the host though.</p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1437983">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1438032" class="blockpost rowodd"> <h2><span><span class="conr">#2340</span> <a href="viewtopic.php?pid=1438032#p1438032">2014-07-20 09:10:45</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=82294">_pheinrich_</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2014-05-26</span></dd> <dd><span>Posts: 32</span></dd> <dd class="usercontacts"><span class="email"><a href="mailto:pascalheinrich.de@googlemail.com">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <p>Hi,</p><p>all is working like expected now!</p><p>Config:</p><p>MB: Asus P8P67EVO<br />CPU: i5 3470<br />Host GPU: nvidia 6600GT<br />Guest GPU: nvidia GTX 260</p><p>Kernel 3.15.5-2 with acs patch<br />Nvidia Kernel module with <a href="http://bpaste.net/show/109185/" rel="nofollow">http://bpaste.net/show/109185/</a></p><div class="codebox"><pre><code>BOOT_IMAGE=/boot/vmlinuz-linux-acs root=UUID=3264d3aa-f452-4866-9397-644efdb107a1 rw intel_iommu=on pcie_acs_override=downstream pci-stub.ids=10de:05e2</code></pre></div><p>I want to thank you all for your support! Keep alive this thread.</p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1438032">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1438074" class="blockpost roweven"> <h2><span><span class="conr">#2341</span> <a href="viewtopic.php?pid=1438074#p1438074">2014-07-20 12:33:57</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=83687">k0olfir3</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2014-07-20</span></dd> <dd><span>Posts: 7</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=83687">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>nbhs wrote:</cite><blockquote><div><p>You need to boot with i915.enable_hd_vgaarb=1 kernel parameter, this will disable dri on the host though.</p></div></blockquote></div><p>That did the trick.</p><p>When I just returned to your original post for the further proceedings, I saw that you you mentioned that option there. Did you just put it there or did I really miss it? That would be kind of embarassing. Anyway, thanks for your help.</p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1438074">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1438076" class="blockpost rowodd"> <h2><span><span class="conr">#2342</span> <a href="viewtopic.php?pid=1438076#p1438076">2014-07-20 12:44:57</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=79825">redger</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2014-02-26</span></dd> <dd><span>Posts: 15</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=79825">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <p>USING VIRT-MANAGER</p><p>This may help someone - after much investigation, trial &amp; error and general messing around I have managed to get VGA passthroufgh working with virt-manager / libvirt&#160; (on Ubuntu Trusty)</p><p>you will need to install the virt-manager, libvirt first.<br />The process assumes you already have a working qemu command and you have saved it to a file</p><p>1) Create the standard qemu command and save it into a text file<br />&#160; &#160; &#160; Remove all the line feed and backslash entries first (they seem to cause virsh some grief) ie. one long line of text<br />&#160; &#160; &#160; NOTE will probably have to add some backslash and linefeeds back in (needed for cd-rom defs at end in my case)<br />2) use --&gt;&#160; virsh domxml-from-native qemu-argv qemu_command_temp.txt &gt; my_qemu_start.xml<br />&#160; &#160; &#160; THis will create a new file (my_qemu_start.xml) which can be imported<br />&#160; &#160; &#160; NOTE you may have to add some backslash and linefeeds back in (I needed them for cd defs at end, but then removed themmanually in final machine definition)<br />3) use --&gt; virsh define my_qemu_start.xml&#160; &#160; &#160; &#160; &#160; &#160; which will create the actual machine xml (file name will be the machine name specified, plus .xml suffix)<br />4) use --&gt; export EDITOR=nano; virsh edit machine.xml&#160; &#160;... <br />&#160; &#160; &#160;change the boot source to &#039;hd&#039;&#160; &#160;from &#039;network&#039;&#160; &#160;(why virsh creates this I don&#039;t know)<br />&#160; &#160; &#160;check the emulator line, may need to specify location of qemu eg. in my case /usr/bin/qemu-system-x86_64<br />&#160; &#160; &#160;remove the video lines in the definition (because we want primary passthru - no cirrus)<br />&#160; &#160; &#160;remove the sdl line&#160; (video type) cause&#160; we don&#039;t want it either<br />&#160; &#160; &#160;remove the &quot;tablet&quot; definition - it fails to conenct to USB device, along with keyboard and mouse<br />&#160; &#160; &#160;remove the &quot;\&quot; from the cd lines (had to be added in previous step)<br />5) edit /etc/libvirt/qemu.conf and set </p><div class="codebox"><pre><code> user = &quot;+0&quot; group = &quot;+0&quot; </code></pre></div><p>&#160; &#160; &#160;<br />&#160; &#160; &#160;add /dev/vfio/xxxxx (in my case 1, 15, 16 17)&#160; &#160; &#160;entries to cgroup_device_acl section</p><div class="codebox"><pre><code> cgroup_device_acl = [ &quot;/dev/null&quot;, &quot;/dev/full&quot;, &quot;/dev/zero&quot;, &quot;/dev/random&quot;, &quot;/dev/urandom&quot;, &quot;/dev/ptmx&quot;, &quot;/dev/kvm&quot;, &quot;/dev/kqemu&quot;, &quot;/dev/rtc&quot;,&quot;/dev/hpet&quot;, &quot;/dev/vfio/vfio&quot;, &quot;/dev/vfio/1&quot;, &quot;/dev/vfio/15&quot;, &quot;/dev/vfio/16&quot;, &quot;/dev/vfio/17&quot; ] security_driver = &quot;none&quot; security_default_confined = 0 hugetlbfs_mount = &quot;/dev/hugepages&quot; clear_emulator_capabilities = 0 relaxed_acs_check = 1 </code></pre></div><p>6) reboot to instantiate the new libvirt parameters<br />7) start new machine from virt-manager ...... </p><p>NOTE if &quot;open&quot; the machine (initiate virt-viewer) then some new entries may be added to the machine definition which will stop it working. If this does happen use &quot;virsh edit&quot; and remove the gratuitous video, tablet, keyboard, mouse etc ... and check the updated qemu:arg entries, in my case backspaces were added which stopped the machine starting. It looked as though the originally generated definition was being restored ie. pre the edits to &quot;fix&quot; the generation errors.</p><p>I started with this </p><div class="codebox"><pre><code> qemu-system-x86_64 -name win7 -enable-kvm -M q35 -m 6144 -mem-path /dev/hugepages \ -cpu Haswell,hv-time,hv_relaxed,hv_vapic,hv_spinlocks=0x1000 \ -boot menu=on \ -smp 3,sockets=1,cores=3,threads=1 \ -bios /usr/share/qemu/bios.bin -vga none \ -usbdevice tablet \ -spice port=5902,disable-ticketing \ -device ioh3420,bus=pcie.0,addr=1c.0,multifunction=on,port=1,chassis=1,id=root.1 \ -device ahci,bus=pcie.0,id=ahci \ -net nic,macaddr=00:00:00:aa:bb:cc,model=virtio \ -net user \ -device vfio-pci,host=01:00.0,bus=root.1,addr=00.0,multifunction=on,x-vga=on \ -device vfio-pci,host=01:00.1,bus=root.1,addr=00.1 \ -device vfio-pci,host=02:00.0,bus=pcie.0 \ -device vfio-pci,host=04:00.0,bus=pcie.0 \ -device vfio-pci,host=06:00.0,bus=pcie.0 \ -device vfio-pci,host=05:00.0,bus=pcie.0 \ -drive file=/dev/virt-test/lvwin7_kvm,id=disk1,format=raw,if=virtio \ -drive file=/home/redger/Downloads/isos/virtio-win-0.1-74.iso,id=isocd2 \ -device ide-cd,bus=ahci.2,drive=isocd2 \ -drive file=/home/redger/Downloads/isos/winfiles.iso,id=isocd3 \ -device ide-cd,bus=ahci.3,drive=isocd3 </code></pre></div><p>I edited it and made it into this </p><div class="codebox"><pre><code>qemu-system-x86_64 -name win7_t2 -enable-kvm -M q35 -m 6144 -mem-path /dev/hugepages -cpu Haswell,hv-time,hv_relaxed,hv_vapic,hv_spinlocks=0x1000 -boot menu=on -smp 3,sockets=1,cores=3,threads=1 -bios /usr/share/qemu/bios.bin -vga none -usbdevice tablet -spice port=5902,disable-ticketing -device ioh3420,bus=pcie.0,addr=1c.0,multifunction=on,port=1,chassis=1,id=root.1 -device ahci,bus=pcie.0,id=ahci -net nic,macaddr=00:00:00:aa:bb:cc,model=virtio -net user -device vfio-pci,host=01:00.0,bus=root.1,addr=00.0,multifunction=on,x-vga=on -device vfio-pci,host=01:00.1,bus=root.1,addr=00.1 -device vfio-pci,host=02:00.0,bus=pcie.0 -device vfio-pci,host=04:00.0,bus=pcie.0 -device vfio-pci,host=06:00.0,bus=pcie.0 -device vfio-pci,host=05:00.0,bus=pcie.0 -drive file=/dev/virt-test/lvwin7_kvm,id=disk1,format=raw,if=virtio \ -drive file=/home/redger/Downloads/isos/virtio-win-0.1-74.iso,id=isocd2 \ -device ide-cd,bus=ahci.2,drive=isocd2 \ -drive file=/home/redger/Downloads/isos/winfiles.iso,id=isocd3 \ -device ide-cd,bus=ahci.3,drive=isocd3</code></pre></div><p>note that I had to restore some of the backslashes and linefeeds because the machine was giving some strange errors like </p><div class="codebox"><pre><code>Error starting domain: internal error: process exited while connecting to monitor: 2014-07-20T12:09:56.863675Z qemu-system-x86_64: -device vfio-pci,host=05:00.0,bus=pcie.0: could not open disk image \ -drive: Could not open &#039;\ -drive&#039;: No such file or directory</code></pre></div><p>Other errors related to permissions and use of hugepages were addressed by the changes to /etc/libvirt/qemu.conf</p><br /><p>that became this once <strong>virsh domxml-from-native qemu-argv</strong> was run&#160; </p><div class="codebox"><pre class="vscroll"><code>&lt;domain type=&#039;kvm&#039; xmlns:qemu=&#039;http://libvirt.org/schemas/domain/qemu/1.0&#039;&gt; &lt;name&gt;win7_t2&lt;/name&gt; &lt;uuid&gt;f778660a-9da7-4bad-ba5b-477feb74f2b9&lt;/uuid&gt; &lt;memory unit=&#039;KiB&#039;&gt;6291456&lt;/memory&gt; &lt;currentMemory unit=&#039;KiB&#039;&gt;6291456&lt;/currentMemory&gt; &lt;vcpu placement=&#039;static&#039;&gt;3&lt;/vcpu&gt; &lt;os&gt; &lt;type arch=&#039;x86_64&#039; machine=&#039;q35&#039;&gt;hvm&lt;/type&gt; &lt;loader&gt;/usr/share/qemu/bios.bin&lt;/loader&gt; &lt;boot dev=&#039;network&#039;/&gt; &lt;boot dev=&#039;network&#039;/&gt; &lt;/os&gt; &lt;features&gt; &lt;acpi/&gt; &lt;hyperv&gt; &lt;relaxed state=&#039;on&#039;/&gt; &lt;vapic state=&#039;on&#039;/&gt; &lt;spinlocks state=&#039;on&#039; retries=&#039;4096&#039;/&gt; &lt;/hyperv&gt; &lt;/features&gt; &lt;cpu mode=&#039;custom&#039; match=&#039;exact&#039;&gt; &lt;model fallback=&#039;allow&#039;&gt;Haswell&lt;/model&gt; &lt;topology sockets=&#039;1&#039; cores=&#039;3&#039; threads=&#039;1&#039;/&gt; &lt;/cpu&gt; &lt;clock offset=&#039;utc&#039;/&gt; &lt;on_poweroff&gt;destroy&lt;/on_poweroff&gt; &lt;on_reboot&gt;restart&lt;/on_reboot&gt; &lt;on_crash&gt;destroy&lt;/on_crash&gt; &lt;devices&gt; &lt;emulator&gt;/usr/bin/qemu-system-x86_64&lt;/emulator&gt; &lt;disk type=&#039;block&#039; device=&#039;disk&#039;&gt; &lt;driver name=&#039;qemu&#039; type=&#039;raw&#039;/&gt; &lt;source dev=&#039;/dev/virt-test/lvwin7_kvm&#039;/&gt; &lt;target dev=&#039;vda&#039; bus=&#039;virtio&#039;/&gt; &lt;/disk&gt; &lt;controller type=&#039;sata&#039; index=&#039;0&#039;/&gt; &lt;controller type=&#039;pci&#039; index=&#039;0&#039; model=&#039;pcie-root&#039;/&gt; &lt;controller type=&#039;pci&#039; index=&#039;1&#039; model=&#039;dmi-to-pci-bridge&#039;/&gt; &lt;controller type=&#039;pci&#039; index=&#039;2&#039; model=&#039;pci-bridge&#039;/&gt; &lt;interface type=&#039;user&#039;&gt; &lt;mac address=&#039;00:00:00:aa:bb:cc&#039;/&gt; &lt;model type=&#039;virtio&#039;/&gt; &lt;/interface&gt; &lt;input type=&#039;tablet&#039; bus=&#039;usb&#039;/&gt; &lt;input type=&#039;mouse&#039; bus=&#039;ps2&#039;/&gt; &lt;input type=&#039;keyboard&#039; bus=&#039;ps2&#039;/&gt; &lt;graphics type=&#039;sdl&#039;/&gt; &lt;video&gt; &lt;model type=&#039;cirrus&#039; vram=&#039;9216&#039; heads=&#039;1&#039;/&gt; &lt;/video&gt; &lt;memballoon model=&#039;none&#039;/&gt; &lt;/devices&gt; &lt;qemu:commandline&gt; &lt;qemu:arg value=&#039;-mem-path&#039;/&gt; &lt;qemu:arg value=&#039;/dev/hugepages&#039;/&gt; &lt;qemu:arg value=&#039;-spice&#039;/&gt; &lt;qemu:arg value=&#039;port=5902,disable-ticketing&#039;/&gt; &lt;qemu:arg value=&#039;-device&#039;/&gt; &lt;qemu:arg value=&#039;ioh3420,bus=pcie.0,addr=1c.0,multifunction=on,port=1,chassis=1,id=root.1&#039;/&gt; &lt;qemu:arg value=&#039;-device&#039;/&gt; &lt;qemu:arg value=&#039;ahci,bus=pcie.0,id=ahci&#039;/&gt; &lt;qemu:arg value=&#039;-device&#039;/&gt; &lt;qemu:arg value=&#039;vfio-pci,host=01:00.0,bus=root.1,addr=00.0,multifunction=on,x-vga=on&#039;/&gt; &lt;qemu:arg value=&#039;-device&#039;/&gt; &lt;qemu:arg value=&#039;vfio-pci,host=01:00.1,bus=root.1,addr=00.1&#039;/&gt; &lt;qemu:arg value=&#039;-device&#039;/&gt; &lt;qemu:arg value=&#039;vfio-pci,host=02:00.0,bus=pcie.0&#039;/&gt; &lt;qemu:arg value=&#039;-device&#039;/&gt; &lt;qemu:arg value=&#039;vfio-pci,host=04:00.0,bus=pcie.0&#039;/&gt; &lt;qemu:arg value=&#039;-device&#039;/&gt; &lt;qemu:arg value=&#039;vfio-pci,host=06:00.0,bus=pcie.0&#039;/&gt; &lt;qemu:arg value=&#039;-device&#039;/&gt; &lt;qemu:arg value=&#039;vfio-pci,host=05:00.0,bus=pcie.0&#039;/&gt; &lt;qemu:arg value=&#039;\ -drive&#039;/&gt; &lt;qemu:arg value=&#039;file=/home/redger/Downloads/isos/virtio-win-0.1-74.iso,id=isocd2&#039;/&gt; &lt;qemu:arg value=&#039;\ -device&#039;/&gt; &lt;qemu:arg value=&#039;ide-cd,bus=ahci.2,drive=isocd2&#039;/&gt; &lt;qemu:arg value=&#039;\ -drive&#039;/&gt; &lt;qemu:arg value=&#039;file=/home/redger/Downloads/isos/winfiles.iso,id=isocd3&#039;/&gt; &lt;qemu:arg value=&#039;\ -device&#039;/&gt; &lt;qemu:arg value=&#039;ide-cd,bus=ahci.3,drive=isocd3&#039;/&gt; &lt;/qemu:commandline&gt; &lt;/domain&gt;</code></pre></div><p>and then became this after running <strong>virsh define my_qemu_start.xml</strong> and then using <strong>virsh edit</strong> to remove the unnecessary lines (and change the boot from network to hd)</p><div class="codebox"><pre class="vscroll"><code>&lt;!-- WARNING: THIS IS AN AUTO-GENERATED FILE. CHANGES TO IT ARE LIKELY TO BE OVERWRITTEN AND LOST. Changes to this xml configuration should be made using: virsh edit win7_t2 or other application using the libvirt API. --&gt; &lt;domain type=&#039;kvm&#039; xmlns:qemu=&#039;http://libvirt.org/schemas/domain/qemu/1.0&#039;&gt; &lt;name&gt;win7_t2&lt;/name&gt; &lt;uuid&gt;f778660a-9da7-4bad-ba5b-477feb74f2b9&lt;/uuid&gt; &lt;memory unit=&#039;KiB&#039;&gt;6291456&lt;/memory&gt; &lt;currentMemory unit=&#039;KiB&#039;&gt;6291456&lt;/currentMemory&gt; &lt;vcpu placement=&#039;static&#039;&gt;3&lt;/vcpu&gt; &lt;os&gt; &lt;type arch=&#039;x86_64&#039; machine=&#039;pc-q35-2.0&#039;&gt;hvm&lt;/type&gt; &lt;loader&gt;/usr/share/qemu/bios.bin&lt;/loader&gt; &lt;boot dev=&#039;hd&#039;/&gt; &lt;/os&gt; &lt;features&gt; &lt;acpi/&gt; &lt;hyperv&gt; &lt;relaxed state=&#039;on&#039;/&gt; &lt;vapic state=&#039;on&#039;/&gt; &lt;spinlocks state=&#039;on&#039; retries=&#039;4096&#039;/&gt; &lt;/hyperv&gt; &lt;/features&gt; &lt;cpu mode=&#039;custom&#039; match=&#039;exact&#039;&gt; &lt;model fallback=&#039;allow&#039;&gt;Haswell&lt;/model&gt; &lt;topology sockets=&#039;1&#039; cores=&#039;3&#039; threads=&#039;1&#039;/&gt; &lt;/cpu&gt; &lt;clock offset=&#039;utc&#039;/&gt; &lt;on_poweroff&gt;destroy&lt;/on_poweroff&gt; &lt;on_reboot&gt;restart&lt;/on_reboot&gt; &lt;on_crash&gt;destroy&lt;/on_crash&gt; &lt;devices&gt; &lt;emulator&gt;/usr/bin/qemu-system-x86_64&lt;/emulator&gt; &lt;disk type=&#039;block&#039; device=&#039;disk&#039;&gt; &lt;driver name=&#039;qemu&#039; type=&#039;raw&#039;/&gt; &lt;source dev=&#039;/dev/virt-test/lvwin7_kvm&#039;/&gt; &lt;target dev=&#039;vda&#039; bus=&#039;virtio&#039;/&gt; &lt;address type=&#039;pci&#039; domain=&#039;0x0000&#039; bus=&#039;0x02&#039; slot=&#039;0x02&#039; function=&#039;0x0&#039;/&gt; &lt;/disk&gt; &lt;controller type=&#039;sata&#039; index=&#039;0&#039;&gt; &lt;address type=&#039;pci&#039; domain=&#039;0x0000&#039; bus=&#039;0x00&#039; slot=&#039;0x1f&#039; function=&#039;0x2&#039;/&gt; &lt;/controller&gt; &lt;controller type=&#039;pci&#039; index=&#039;0&#039; model=&#039;pcie-root&#039;/&gt; &lt;controller type=&#039;pci&#039; index=&#039;1&#039; model=&#039;dmi-to-pci-bridge&#039;&gt; &lt;address type=&#039;pci&#039; domain=&#039;0x0000&#039; bus=&#039;0x00&#039; slot=&#039;0x1e&#039; function=&#039;0x0&#039;/&gt; &lt;/controller&gt; &lt;controller type=&#039;pci&#039; index=&#039;2&#039; model=&#039;pci-bridge&#039;&gt; &lt;address type=&#039;pci&#039; domain=&#039;0x0000&#039; bus=&#039;0x01&#039; slot=&#039;0x01&#039; function=&#039;0x0&#039;/&gt; &lt;/controller&gt; &lt;interface type=&#039;user&#039;&gt; &lt;mac address=&#039;00:00:00:aa:bb:cc&#039;/&gt; &lt;model type=&#039;virtio&#039;/&gt; &lt;address type=&#039;pci&#039; domain=&#039;0x0000&#039; bus=&#039;0x02&#039; slot=&#039;0x01&#039; function=&#039;0x0&#039;/&gt; &lt;/interface&gt; &lt;memballoon model=&#039;none&#039;/&gt; &lt;/devices&gt; &lt;qemu:commandline&gt; &lt;qemu:arg value=&#039;-mem-path&#039;/&gt; &lt;qemu:arg value=&#039;/dev/hugepages&#039;/&gt; &lt;qemu:arg value=&#039;-spice&#039;/&gt; &lt;qemu:arg value=&#039;port=5902,disable-ticketing&#039;/&gt; &lt;qemu:arg value=&#039;-device&#039;/&gt; &lt;qemu:arg value=&#039;ioh3420,bus=pcie.0,addr=1c.0,multifunction=on,port=1,chassis=1,id=root.1&#039;/&gt; &lt;qemu:arg value=&#039;-device&#039;/&gt; &lt;qemu:arg value=&#039;ahci,bus=pcie.0,id=ahci&#039;/&gt; &lt;qemu:arg value=&#039;-device&#039;/&gt; &lt;qemu:arg value=&#039;vfio-pci,host=01:00.0,bus=root.1,addr=00.0,multifunction=on,x-vga=on&#039;/&gt; &lt;qemu:arg value=&#039;-device&#039;/&gt; &lt;qemu:arg value=&#039;vfio-pci,host=01:00.1,bus=root.1,addr=00.1&#039;/&gt; &lt;qemu:arg value=&#039;-device&#039;/&gt; &lt;qemu:arg value=&#039;vfio-pci,host=02:00.0,bus=pcie.0&#039;/&gt; &lt;qemu:arg value=&#039;-device&#039;/&gt; &lt;qemu:arg value=&#039;vfio-pci,host=04:00.0,bus=pcie.0&#039;/&gt; &lt;qemu:arg value=&#039;-device&#039;/&gt; &lt;qemu:arg value=&#039;vfio-pci,host=06:00.0,bus=pcie.0&#039;/&gt; &lt;qemu:arg value=&#039;-device&#039;/&gt; &lt;qemu:arg value=&#039;vfio-pci,host=05:00.0,bus=pcie.0&#039;/&gt; &lt;qemu:arg value=&#039;-drive&#039;/&gt; &lt;qemu:arg value=&#039;file=/home/redger/Downloads/isos/virtio-win-0.1-74.iso,id=isocd2&#039;/&gt; &lt;qemu:arg value=&#039;-device&#039;/&gt; &lt;qemu:arg value=&#039;ide-cd,bus=ahci.2,drive=isocd2&#039;/&gt; &lt;qemu:arg value=&#039;-drive&#039;/&gt; &lt;qemu:arg value=&#039;file=/home/redger/Downloads/isos/winfiles.iso,id=isocd3&#039;/&gt; &lt;qemu:arg value=&#039;-device&#039;/&gt; &lt;qemu:arg value=&#039;ide-cd,bus=ahci.3,drive=isocd3&#039;/&gt; &lt;/qemu:commandline&gt; &lt;/domain&gt;</code></pre></div><p>which would run as machine <strong>win_t2</strong><br />it was all quite painfull the first time since I tried to create a definition file from scratch - which was completely unsuccessful even though it looked a lot like the final product.</p><p>Comments / improvements welcome</p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1438076">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1438147" class="blockpost roweven"> <h2><span><span class="conr">#2343</span> <a href="viewtopic.php?pid=1438147#p1438147">2014-07-20 16:03:43</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=70922">nbhs</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd class="postavatar"><img src="https://bbs.archlinux.org/img/avatars/70922.jpg?m=1367773811" width="80" height="80" alt="" /></dd> <dd><span>From: Montevideo, Uruguay</span></dd> <dd><span>Registered: 2013-05-02</span></dd> <dd><span>Posts: 402</span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>k0olfir3 wrote:</cite><blockquote><div><div class="quotebox"><cite>nbhs wrote:</cite><blockquote><div><p>You need to boot with i915.enable_hd_vgaarb=1 kernel parameter, this will disable dri on the host though.</p></div></blockquote></div><p>That did the trick.</p><p>When I just returned to your original post for the further proceedings, I saw that you you mentioned that option there. Did you just put it there or did I really miss it? That would be kind of embarassing. Anyway, thanks for your help.</p></div></blockquote></div><p>It was a ninja edit</p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1438147">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1438149" class="blockpost rowodd"> <h2><span><span class="conr">#2344</span> <a href="viewtopic.php?pid=1438149#p1438149">2014-07-20 16:08:59</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=83687">k0olfir3</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2014-07-20</span></dd> <dd><span>Posts: 7</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=83687">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <p>Hi all,</p><p>I was now able to pass through my GTX 770 card and to install win 7 on the virtual machine. However, in windows I cannot use the card with the NVIDIA drivers. I get that annoying yellow triangle with Code 43. </p><p>My research in this thread indicates that this problem is related to the NoSnoop attribute. At least it appears to be enabled on my system:</p><div class="codebox"><pre><code>lspci -vvvv 01:00.0 VGA compatible controller: NVIDIA Corporation GK104 [GeForce GTX 770] (rev a1) (prog-if 00 [VGA controller]) ... Capabilities: [78] Express (v2) Endpoint, MSI 00 DevCap: MaxPayload 256 bytes, PhantFunc 0, Latency L0s unlimited, L1 &lt;64us ExtTag+ AttnBtn- AttnInd- PwrInd- RBE+ FLReset- DevCtl: Report errors: Correctable- Non-Fatal- Fatal- Unsupported- RlxdOrd- ExtTag+ PhantFunc- AuxPwr- NoSnoop+ ... 01:00.1 Audio device: NVIDIA Corporation GK104 HDMI Audio Controller (rev a1) ... Capabilities: [78] Express (v2) Endpoint, MSI 00 DevCap: MaxPayload 256 bytes, PhantFunc 0, Latency L0s unlimited, L1 &lt;64us ExtTag+ AttnBtn- AttnInd- PwrInd- RBE+ FLReset- DevCtl: Report errors: Correctable- Non-Fatal- Fatal- Unsupported- RlxdOrd- ExtTag+ PhantFunc- AuxPwr- NoSnoop+ ...</code></pre></div><p>In this forum aw posted a patch for qemu to solve this issue. However, if I understand this correctly that patch should already be included in qemu &gt;=2.0.0. </p><p>On the web I found this site: <br /><a href="http://site" rel="nofollow">http://www.firewing1.com/howtos/fedora-20/create-gaming-virtual-machine-using-vfio-pci-passthrough-kvm</a> <br />which is suggesting to the following kernel patches.</p><p><a href="http://git.kernel.org/cgit/linux/kernel/git/torvalds/linux.git/commit/?id=e0f0bbc527f6e9c0261f1d16b2a0b47612b7f235" rel="nofollow">http://git.kernel.org/cgit/linux/kernel … 7612b7f235</a><br /><a href="http://git.kernel.org/cgit/linux/kernel/git/torvalds/linux.git/commit/?id=d96eb2c6f480769bff32054e78b964860dae4d56" rel="nofollow">http://git.kernel.org/cgit/linux/kernel … 860dae4d56</a><br /><a href="http://git.kernel.org/cgit/linux/kernel/git/torvalds/linux.git/commit/?id=ec53500fae421e07c5d035918ca454a429732ef4" rel="nofollow">http://git.kernel.org/cgit/linux/kernel … a429732ef4</a></p><p>They appear to older than 3.15.1, should I try them?</p><p>If yes, can I just edit nbhs&#039;s PKGBUILD such that these patches are apllied to linux-mainline? For example by adding something like this to the prepare section?</p><div class="codebox"><pre><code>patch -p1 -i &quot;${srcdir}/whatever_file_name.patch&quot;</code></pre></div><p>Assuming this works out, will I need to pass any additional options to the kernel to enable the patches (as was the case for the i915 patch)?</p><p>Or do you have any other ideas that may solve my problem? </p><p>Sorry for posing all those stupid questions. I don&#039;t know very much about programming, but I really want that gaming virtual machine.</p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1438149">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1438152" class="blockpost roweven"> <h2><span><span class="conr">#2345</span> <a href="viewtopic.php?pid=1438152#p1438152">2014-07-20 16:19:03</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=70922">nbhs</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd class="postavatar"><img src="https://bbs.archlinux.org/img/avatars/70922.jpg?m=1367773811" width="80" height="80" alt="" /></dd> <dd><span>From: Montevideo, Uruguay</span></dd> <dd><span>Registered: 2013-05-02</span></dd> <dd><span>Posts: 402</span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>k0olfir3 wrote:</cite><blockquote><div><p>Hi all,</p><p>I was now able to pass through my GTX 770 card and to install win 7 on the virtual machine. However, in windows I cannot use the card with the NVIDIA drivers. I get that annoying yellow triangle with Code 43. </p><p>My research in this thread indicates that this problem is related to the NoSnoop attribute. At least it appears to be enabled on my system:</p><div class="codebox"><pre><code>lspci -vvvv 01:00.0 VGA compatible controller: NVIDIA Corporation GK104 [GeForce GTX 770] (rev a1) (prog-if 00 [VGA controller]) ... Capabilities: [78] Express (v2) Endpoint, MSI 00 DevCap: MaxPayload 256 bytes, PhantFunc 0, Latency L0s unlimited, L1 &lt;64us ExtTag+ AttnBtn- AttnInd- PwrInd- RBE+ FLReset- DevCtl: Report errors: Correctable- Non-Fatal- Fatal- Unsupported- RlxdOrd- ExtTag+ PhantFunc- AuxPwr- NoSnoop+ ... 01:00.1 Audio device: NVIDIA Corporation GK104 HDMI Audio Controller (rev a1) ... Capabilities: [78] Express (v2) Endpoint, MSI 00 DevCap: MaxPayload 256 bytes, PhantFunc 0, Latency L0s unlimited, L1 &lt;64us ExtTag+ AttnBtn- AttnInd- PwrInd- RBE+ FLReset- DevCtl: Report errors: Correctable- Non-Fatal- Fatal- Unsupported- RlxdOrd- ExtTag+ PhantFunc- AuxPwr- NoSnoop+ ...</code></pre></div><p>In this forum aw posted a patch for qemu to solve this issue. However, if I understand this correctly that patch should already be included in qemu &gt;=2.0.0. </p><p>On the web I found this site: <br /><a href="http://site" rel="nofollow">http://www.firewing1.com/howtos/fedora-20/create-gaming-virtual-machine-using-vfio-pci-passthrough-kvm</a> <br />which is suggesting to the following kernel patches.</p><p><a href="http://git.kernel.org/cgit/linux/kernel/git/torvalds/linux.git/commit/?id=e0f0bbc527f6e9c0261f1d16b2a0b47612b7f235" rel="nofollow">http://git.kernel.org/cgit/linux/kernel … 7612b7f235</a><br /><a href="http://git.kernel.org/cgit/linux/kernel/git/torvalds/linux.git/commit/?id=d96eb2c6f480769bff32054e78b964860dae4d56" rel="nofollow">http://git.kernel.org/cgit/linux/kernel … 860dae4d56</a><br /><a href="http://git.kernel.org/cgit/linux/kernel/git/torvalds/linux.git/commit/?id=ec53500fae421e07c5d035918ca454a429732ef4" rel="nofollow">http://git.kernel.org/cgit/linux/kernel … a429732ef4</a></p><p>They appear to older than 3.15.1, should I try them?</p><p>If yes, can I just edit nbhs&#039;s PKGBUILD such that these patches are apllied to linux-mainline? For example by adding something like this to the prepare section?</p><div class="codebox"><pre><code>patch -p1 -i &quot;${srcdir}/whatever_file_name.patch&quot;</code></pre></div><p>Assuming this works out, will I need to pass any additional options to the kernel to enable the patches (as was the case for the i915 patch)?</p><p>Or do you have any other ideas that may solve my problem? </p><p>Sorry for posing all those stupid questions. I don&#039;t know very much about programming, but I really want that gaming virtual machine.</p></div></blockquote></div><p>I believe there are some problems with the lastest nvidia drivers, if you are using the lastest qemu git, you can also try kvm=off as a cpu option, theres a discussion about this a few pages back</p> <p class="postedit"><em>Last edited by nbhs (2014-07-20 16:42:45)</em></p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1438152">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1438161" class="blockpost rowodd"> <h2><span><span class="conr">#2346</span> <a href="viewtopic.php?pid=1438161#p1438161">2014-07-20 16:53:30</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=83687">k0olfir3</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2014-07-20</span></dd> <dd><span>Posts: 7</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=83687">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>nbhs wrote:</cite><blockquote><div><p>I believe there are some problems with the lastest nvidia drivers, if you are using the lastest qemu git, you can also try kvm=off as a cpu option, theres a discussion about this a few pages back</p></div></blockquote></div><p>Great! You always come up with easy solutions when I think everything is terribly complicated. I installed an earlier version of the NVIDIA drivers (332.21) in the virtual machine and now, the graphics are working. Thanks!</p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1438161">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1438282" class="blockpost roweven"> <h2><span><span class="conr">#2347</span> <a href="viewtopic.php?pid=1438282#p1438282">2014-07-21 00:39:41</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=83626">DLWood1001</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2014-07-17</span></dd> <dd><span>Posts: 4</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=83626">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>aw wrote:</cite><blockquote><div><div class="quotebox"><cite>DLWood1001 wrote:</cite><blockquote><div><p>aw,</p><p>I tested the reset patch against 3.15.5 mainline. Patches applied with no merge problems, however it didn&#039;t reset the card. Using Sapphire R9 290x Tri-X. I&#039;ll try building 3.16-rc5 tonight and reply back if there is any improvement.</p></div></blockquote></div><p>Thanks for the test, both series weren&#039;t really targeted at fixing this, but I needed to add a device specific reset for my Oland-based HD8570 to get it to reset on release and I thought it worth a test to see if it fixed anything.&#160; If you kill the qemu process with these patches, what happens on your r9 290x?&#160; Does the monitor stay in sync and the framebuffer show the last image, or does the monitor go blank and the GPU fan reset to high speed?</p><div class="quotebox"><blockquote><div><p>On a side note, your dma-alias-v4 patch series worked great for me; fixed the Intel 82801 issue I was seeing.</p></div></blockquote></div><p>Great, these should show up in 3.17</p></div></blockquote></div><p>Hi Aw,</p><p>Sorry about the delay in my response. I tested with the 3.16 rc5 kernel, reset patch applied and with a R9 290X. Still the same result. As an A/B test, I tried an HD7770 it seems to reset just fine with OSX as the guest, however I&#039;m not sure if it had a problem pre-patch as I had never used the 7770 for VGA-Passthrough. I&#039;m going to try an unpatched kernel with the HD 7770 later to see if it was truly the patch that allows this card to reset.</p><p>Lastly, in regards to the monitor output on the R9 290x, the output will go out of sync and I don&#039;t see/hear anything noticeable with the GPU fans. I&#039;ve tried force closing QEMU and shutting down the guest gracefully and get the same result.</p> <p class="postedit"><em>Last edited by DLWood1001 (2014-07-21 11:40:54)</em></p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1438282">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1438311" class="blockpost rowodd"> <h2><span><span class="conr">#2348</span> <a href="viewtopic.php?pid=1438311#p1438311">2014-07-21 03:41:57</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=79578">AKSN74</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd class="postavatar"><img src="https://bbs.archlinux.org/img/avatars/79578.jpg?m=1423108340" width="80" height="80" alt="" /></dd> <dd><span>From: Taichung, Taiwan</span></dd> <dd><span>Registered: 2014-02-18</span></dd> <dd><span>Posts: 52</span></dd> <dd class="usercontacts"><span class="email"><a href="mailto:missile0407@gmail.com">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>aw wrote:</cite><blockquote><div><div class="quotebox"><cite>DLWood1001 wrote:</cite><blockquote><div><p>aw,</p><p>I tested the reset patch against 3.15.5 mainline. Patches applied with no merge problems, however it didn&#039;t reset the card. Using Sapphire R9 290x Tri-X. I&#039;ll try building 3.16-rc5 tonight and reply back if there is any improvement.</p></div></blockquote></div><p>Thanks for the test, both series weren&#039;t really targeted at fixing this, but I needed to add a device specific reset for my Oland-based HD8570 to get it to reset on release and I thought it worth a test to see if it fixed anything.&#160; If you kill the qemu process with these patches, what happens on your r9 290x?&#160; Does the monitor stay in sync and the framebuffer show the last image, or does the monitor go blank and the GPU fan reset to high speed?</p><div class="quotebox"><blockquote><div><p>On a side note, your dma-alias-v4 patch series worked great for me; fixed the Intel 82801 issue I was seeing.</p></div></blockquote></div><p>Great, these should show up in 3.17</p></div></blockquote></div><p>Hi, aw<br />I tested the patch, but unluckly it still got hangs when I reboot guest OS (Fedora 20 /w GTX480).<br />And I&#039;m sure that I patched with kernel 3.16-rc5.</p> <p class="postedit"><em>Last edited by AKSN74 (2014-07-21 03:42:19)</em></p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1438311">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1438314" class="blockpost roweven"> <h2><span><span class="conr">#2349</span> <a href="viewtopic.php?pid=1438314#p1438314">2014-07-21 03:50:00</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=83696">ctwdoecoss</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2014-07-20</span></dd> <dd><span>Posts: 3</span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <p>Did anyone passthrough gpu successfully on a laptop?</p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1438314">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1438335" class="blockpost rowodd"> <h2><span><span class="conr">#2350</span> <a href="viewtopic.php?pid=1438335#p1438335">2014-07-21 06:42:07</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=80701">apex8</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2014-03-29</span></dd> <dd><span>Posts: 47</span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <p>Hi,<br />I had a working Win7 VM using linux-mainline-3.14.1, along with stable qemu 2.0 as well as seabios. <br />Yesterday I compiled the mainline 3.15.6 package and since that the VM hangs somewhere before boot begins. No output at the monitor. <br />However using vga=on -vga std the VM boots up as usual.</p><p>Is there something that changed in the meantime and whichs needs to be adjusted?</p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1438335">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div class="postlinksb"> <div class="inbox crumbsplus"> <div class="pagepost"> <p class="pagelink conl"><span class="pages-label">Pages: </span><a rel="prev" class="item1" href="viewtopic.php?id=162768&amp;p=93">Previous</a> <a href="viewtopic.php?id=162768">1</a> <span class="spacer">…</span> <a href="viewtopic.php?id=162768&amp;p=92">92</a> <a href="viewtopic.php?id=162768&amp;p=93">93</a> <strong>94</strong> <a href="viewtopic.php?id=162768&amp;p=95">95</a> <a href="viewtopic.php?id=162768&amp;p=96">96</a> <span class="spacer">…</span> <a href="viewtopic.php?id=162768&amp;p=234">234</a> <a rel="next" href="viewtopic.php?id=162768&amp;p=95">Next</a></p> <p class="postlink conr">Topic closed</p> </div> <ul class="crumbs"> <li><a href="index.php">Index</a></li> <li><span>»&#160;</span><a href="viewforum.php?id=48">Topics Going Nowhere</a></li> <li><span>»&#160;</span><strong><a href="viewtopic.php?id=162768">KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</a></strong></li> </ul> <p class="subscribelink clearb"><a href="misc.php?action=subscribe&amp;tid=162768">Subscribe to this topic</a></p> <div class="clearer"></div> </div> </div> </div> <div id="brdfooter" class="block"> <h2><span>Board footer</span></h2> <div class="box"> <div id="brdfooternav" class="inbox"> <div class="conl"> <form id="qjump" method="get" action="viewforum.php"> <div><label><span>Jump to<br /></span> <select name="id" onchange="window.location=('viewforum.php?id='+this.options[this.selectedIndex].value)"> <optgroup label="Technical Issues and Assistance"> <option value="23">Newbie Corner</option> <option value="17">Installation</option> <option value="22">Kernel &amp; Hardware</option> <option value="18">Applications &amp; Desktop Environments</option> <option value="31">Laptop Issues</option> <option value="8">Networking, Server, and Protection</option> <option value="32">Multimedia and Games</option> <option value="50">System Administration</option> <option value="35">Other Architectures</option> </optgroup> <optgroup label="Arch-centric"> <option value="24">Announcements, Package &amp; Security Advisories</option> <option value="1">Arch Discussion</option> <option value="13">Forum &amp; Wiki discussion</option> </optgroup> <optgroup label="Pacman Upgrades, Packaging &amp; AUR"> <option value="44">Pacman &amp; Package Upgrade Issues</option> <option value="49">[testing] Repo Forum</option> <option value="4">Creating &amp; Modifying Packages</option> <option value="38">AUR Issues, Discussion &amp; PKGBUILD Requests</option> </optgroup> <optgroup label="Contributions &amp; Discussion"> <option value="20">GNU/Linux Discussion</option> <option value="27">Community Contributions</option> <option value="33">Programming &amp; Scripting</option> <option value="30">Other Languages</option> <option value="47">Artwork and Screenshots</option> <option value="42">Try This</option> </optgroup> <optgroup label="/dev/null"> <option value="29">Off-Topic</option> <option value="48" selected="selected">Topics Going Nowhere</option> <option value="36">Dustbin</option> </optgroup> </select></label> <input type="submit" value=" Go " accesskey="g" /> </div> </form> </div> <div class="conr"> <p id="feedlinks"><span class="atom"><a href="extern.php?action=feed&amp;tid=162768&amp;type=atom">Atom topic feed</a></span></p> <p id="poweredby">Powered by <a href="http://fluxbb.org/">FluxBB</a></p> </div> <div class="clearer"></div> </div> </div> </div> </div> <div class="end-box"></div> </div> </body> </html>
