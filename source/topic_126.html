<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"> <html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en" dir="ltr"> <head> <meta http-equiv="Content-Type" content="text/html; charset=utf-8" /> <title>KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9 (Page 126) / Topics Going Nowhere / Arch Linux Forums</title> <link rel="stylesheet" type="text/css" href="style/ArchLinux.css" /> <link rel="canonical" href="viewtopic.php?id=162768&amp;p=126" title="Page 126" /> <link rel="prev" href="viewtopic.php?id=162768&amp;p=125" title="Page 125" /> <link rel="next" href="viewtopic.php?id=162768&amp;p=127" title="Page 127" /> <link rel="alternate" type="application/atom+xml" href="extern.php?action=feed&amp;tid=162768&amp;type=atom" title="Atom topic feed" /> <link rel="stylesheet" media="screen" href="style/ArchLinux/arch.css?v=3" /> <link rel="stylesheet" media="screen" href="style/ArchLinux/archnavbar.css?v=2" /> <link rel="shortcut icon" href="style/ArchLinux/favicon.ico" /> </head> <body> <div id="archnavbar" class="anb-forum"> <div id="archnavbarlogo"><h1><a href="http://www.archlinux.org/">Arch Linux</a></h1></div> <div id="archnavbarmenu"> <ul id="archnavbarlist"> <li id="anb-home"><a href="http://www.archlinux.org/">Home</a></li><li id="anb-packages"><a href="http://www.archlinux.org/packages/">Packages</a></li><li id="anb-forums" class="anb-selected"><a href="https://bbs.archlinux.org/">Forums</a></li><li id="anb-wiki"><a href="https://wiki.archlinux.org/">Wiki</a></li><li id="anb-bugs"><a href="https://bugs.archlinux.org/">Bugs</a></li><li id="anb-aur"><a href="https://aur.archlinux.org/">AUR</a></li><li id="anb-download"><a href="http://www.archlinux.org/download/">Download</a></li> </ul> </div> </div> <div id="punviewtopic" class="pun"> <div class="top-box"></div> <div class="punwrap"> <div id="brdheader" class="block"> <div class="box"> <div id="brdmenu" class="inbox"> <ul> <li id="navindex" class="isactive"><a href="index.php">Index</a></li> <li id="navuserlist"><a href="userlist.php">User list</a></li> <li id="navsearch"><a href="search.php">Search</a></li> <li id="navprofile"><a href="profile.php?id=80749">Profile</a></li> <li id="navlogout"><a href="login.php?action=out&amp;id=80749&amp;csrf_token=5c20501ec397bb45ef8ee8c84db232c8d8e421c6">Logout</a></li> </ul> </div> <div id="brdwelcome" class="inbox"> <ul class="conl"> <li><span>Logged in as <strong>SXX</strong></span></li> <li><span>Last visit: 2015-08-16 12:20:09</span></li> </ul> <ul class="conr"> <li><span>Topics: <a href="search.php?action=show_replies" title="Find topics you have posted to.">Posted</a> | <a href="search.php?action=show_new" title="Find topics with new posts since your last visit.">New</a> | <a href="search.php?action=show_recent" title="Find topics with recent posts.">Active</a> | <a href="search.php?action=show_unanswered" title="Find topics with no replies.">Unanswered</a></span></li> </ul> <div class="clearer"></div> </div> </div> </div> <div id="brdmain"> <div class="linkst"> <div class="inbox crumbsplus"> <ul class="crumbs"> <li><a href="index.php">Index</a></li> <li><span>»&#160;</span><a href="viewforum.php?id=48">Topics Going Nowhere</a></li> <li><span>»&#160;</span><strong><a href="viewtopic.php?id=162768">KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</a></strong></li> </ul> <div class="pagepost"> <p class="pagelink conl"><span class="pages-label">Pages: </span><a rel="prev" class="item1" href="viewtopic.php?id=162768&amp;p=125">Previous</a> <a href="viewtopic.php?id=162768">1</a> <span class="spacer">…</span> <a href="viewtopic.php?id=162768&amp;p=124">124</a> <a href="viewtopic.php?id=162768&amp;p=125">125</a> <strong>126</strong> <a href="viewtopic.php?id=162768&amp;p=127">127</a> <a href="viewtopic.php?id=162768&amp;p=128">128</a> <span class="spacer">…</span> <a href="viewtopic.php?id=162768&amp;p=234">234</a> <a rel="next" href="viewtopic.php?id=162768&amp;p=127">Next</a></p> <p class="postlink conr">Topic closed</p> </div> <div class="clearer"></div> </div> </div> <div id="p1471406" class="blockpost rowodd blockpost1"> <h2><span><span class="conr">#3126</span> <a href="viewtopic.php?pid=1471406#p1471406">2014-10-31 19:48:58</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=75590">aw</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2013-10-04</span></dd> <dd><span>Posts: 921</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=75590">Email</a></span> <span class="website"><a href="http://vfio.blogspot.com/" rel="nofollow">Website</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>Duelist wrote:</cite><blockquote><div><div class="quotebox"><cite>aw wrote:</cite><blockquote><div><div class="quotebox"><cite>Duelist wrote:</cite><blockquote><div><p>I&#039;ve got my HD7750 working on F2A55, all asus. Crossfire left. IO_PAGE_FAULTs are fixed by -realtime mlock=on switch.</p></div></blockquote></div><p>This would be surprising, mlock=on should do nothing when a device is assigned.&#160; The memory is already pinned for the IOMMU, so mlock&#039;ing it is redundant.</p></div></blockquote></div><p>Well, there may be some quirks. But the io page faults were pointing into system ram area of /proc/iomem. <span class="bbs">And also, may be not the mlock, but allow-unsafe-interrupt thing did the job, that&#039;s to pin down for me.</span> Definitely, it&#039;s mlock that does the trick. When i remove it - it gets BSOD 116. <span class="bbs">Or maybe i&#039;m just hell of extremely lucky, getting memory locked in a ~safe area and not messing up anything(but HD7750 needs at least 256M as noted by lspci).</span> Not a case either - i&#039;ve survived a reboot.</p></div></blockquote></div><p>Hmm, does it also work if you use hugepages?</p> </div> <div class="postsignature postmsg"><hr /><p><a href="http://vfio.blogspot.com" rel="nofollow">http://vfio.blogspot.com</a><br />Looking for a more open forum to discuss vfio related uses?&#160; Try <a href="https://www.redhat.com/mailman/listinfo/vfio-users" rel="nofollow">https://www.redhat.com/mailman/listinfo/vfio-users</a></p></div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1471406">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1471418" class="blockpost roweven"> <h2><span><span class="conr">#3127</span> <a href="viewtopic.php?pid=1471418#p1471418">2014-10-31 20:32:08</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=85314">Duelist</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2014-09-22</span></dd> <dd><span>Posts: 358</span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>aw wrote:</cite><blockquote><div><p>Hmm, does it also work if you use hugepages?</p></div></blockquote></div><p>I&#039;ve assigned 2048 2048kb hugepages, and it spew out IO_PAGE_FAULTs at me, resulting in BSOD 116. No, it doesn&#039;t work with hugepages.<br />Also, dmesg is showing &quot;kvm: zapping shadow pages for mmio generation wraparound&quot;.</p><p>I&#039;ve found the difference between q35 and pc(440fx)! When using q35, only one GPU got MSI/MSI-X interrupt enabled. When using pc - both GPUs have their msi enabled. And that fact results in MANY variants of stuff. I can now repeat that interrupt-mess-and-emergency-shutdown behavior. Awesome.</p> <p class="postedit"><em>Last edited by Duelist (2014-10-31 21:20:21)</em></p> </div> <div class="postsignature postmsg"><hr /><p><span class="bbs">The forum rules prohibit requesting support for distributions other than arch.</span><br /><a href="https://bbs.archlinux.org/viewtopic.php?pid=1551460#p1551460" rel="nofollow">I gave up.</a><a href="https://bbs.archlinux.org/viewtopic.php?id=162768" rel="nofollow"> It was too late.</a><br /><a href="http://pastebin.com/B3fL84bq" rel="nofollow">What I was trying to do</a>.<br /><a href="http://vfio.blogspot.com/" rel="nofollow">The reference about VFIO and KVM VGA passthrough.</a></p></div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1471418">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1471469" class="blockpost rowodd"> <h2><span><span class="conr">#3128</span> <a href="viewtopic.php?pid=1471469#p1471469">2014-11-01 00:12:28</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=83606">Child_of_Sun</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2014-07-16</span></dd> <dd><span>Posts: 8</span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>aw wrote:</cite><blockquote><div><div class="quotebox"><cite>Child_of_Sun wrote:</cite><blockquote><div><p>I use Gentoo Linux ~amd64 with kernel 3.18.0-rc2 (Because of the OverlayFS :-), should work with 3.17.1 too) and a Patched Qemu from here: <a href="https://github.com/awilliam/qemu-vfio/releases" rel="nofollow">https://github.com/awilliam/qemu-vfio/releases</a> with Seabios-1.7.5 (Release)</p></div></blockquote></div><p>Please don&#039;t use random tags (or even branches) from my tree.&#160; My tags are for pull requests to upstream and not intended to be any kind of release for general consumption.</p></div></blockquote></div><p>Sorry for that, tested it now with qemu-2.1.2 and it works, too.</p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1471469">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1471581" class="blockpost roweven"> <h2><span><span class="conr">#3129</span> <a href="viewtopic.php?pid=1471581#p1471581">2014-11-01 12:58:51</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=68939">Renfast</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2013-03-04</span></dd> <dd><span>Posts: 4</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=68939">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <p>I&#039;m having problems passing-through a Gigabyte GTX680. When I launch qemu the host starts to lag and after about 5 seconds the system freezes, having to reset.</p><p>But if I use a Sapphire 7970 it works fine.</p><p>I&#039;ve tested both graphics cards in two setups, crashing in both and always using the iGPU as the host:</p><p>PC 1:<br /> - Gigabyte G1 Sniper A88X<br /> - AMD A10-6800K</p><p>PC 2:<br /> - Asus A88X-Pro<br /> - AMD A10-7850K</p><p>IOMMU is enabled in both motherboards. The sapphire card works in both, the GTX680 crashes in both.</p><p>The qemu command I use is this:</p><div class="codebox"><pre><code>qemu-system-x86_64 \ -enable-kvm \ -M q35 \ -m 1024 \ -cpu host \ -smp 4,sockets=1,cores=4,threads=1 \ -bios /usr/share/qemu/bios.bin \ -vga none \ -device ioh3420,bus=pcie.0,addr=1c.0,multifunction=on,port=1,chassis=1,id=root.1 \ -device vfio-pci,host=01:00.0,bus=root.1,addr=00.0,multifunction=on,x-vga=on \ -device vfio-pci,host=01:00.1,bus=root.1,addr=00.1</code></pre></div><p>And the cmdline:</p><div class="codebox"><pre><code>root=/dev/sda1 rw iommu=pt iommu=1 amd_iommu=on kvm.ignore_msrs=1 ivrs_ioapic[0]=00:14.0 pci-stub.ids=1002:6798,1002:aaa0 pcie_acs_override=downstream initrd=../initramfs-linux-mainline.img</code></pre></div><p>The <em>ivrs_ioapic[0]=00:14.0</em> is only required in the first setup or else the interrupt remapping can&#039;t be enabled.</p><p>I don&#039;t know if I have to add or remove any other argument but this works for the Sapphire 7970.</p><p>Of course the <em>pci-stub.ids</em> are changed to properly match the connected graphic card.</p><p>In the BIOS the integrated GPU is forced and I am also blacklisting nvidia and nouveau (although those drivers aren&#039;t installed, the only one installed is xf86-video-ati).</p><p>I&#039;m using Arch Linux and the kernel used is the one provided by the OP yesterday, which I compiled and installed.</p><br /><p>I can&#039;t seem to find out what is causing these freezes, am I missing something?</p><br /><p>EDIT: I just realized I changed the kernel arguments so many times that now I have the <em>iommu</em> argument duplicated, but I don&#039;t think that&#039;s the main cause.</p> <p class="postedit"><em>Last edited by Renfast (2014-11-01 13:16:29)</em></p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1471581">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1471661" class="blockpost rowodd"> <h2><span><span class="conr">#3130</span> <a href="viewtopic.php?pid=1471661#p1471661">2014-11-01 17:40:45</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=86302">4kGamer</a></strong></dt> <dd class="usertitle"><strong>Banned</strong></dd> <dd><span>Registered: 2014-10-29</span></dd> <dd><span>Posts: 82</span></dd> <dd class="usercontacts"><span class="email"><a href="mailto:oktayaslantas@gmx.de">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>aw wrote:</cite><blockquote><div><div class="quotebox"><cite>4kGamer wrote:</cite><blockquote><div><p>Awesome! thanks a lot for your help Alex! <strong>I can confirm that the brand new MSI GTX 980 Gaming has been successfully passed through Windows 8.1 with the latest NVidia drivers! </strong></p><p>Now, I will try to install it with virtio.</p><p>One question: do you recommend the use of libvirt for performance reasons? If so, is it enough to simply install it??</p></div></blockquote></div><p>libvirt makes some aspects of performance tuning easier, especially things like vCPU pinning, network configuration, and device tuning options, but it&#039;s not required.&#160; If you use VGA assignment you also need to deal with the lack of support for the x-vga option, which often leads people to use &lt;qemu:commandline&gt; blocks that hide the device assignment from libvirt and make lots of things more difficult.&#160; I recommend instead using a wrapper script around qemu to insert the option (I provided a link to some redhat documentation that could be adapted for this a while ago).&#160; The even better option is to use OVMF, which seems like it should be possible for you since you&#039;re running Win8.1 and have a new video card.&#160; There are no libvirt hacks required for GPU assignment with OVMF (but you do need very new libvirt).</p><p>libvirt needs to manage the VM, so it&#039;s a bit more than simply installing it, you&#039;ll need to create/import the VM to work from libvirt.&#160; virt-manager is a reasonable tool to get started for that, but for advanced tuning you&#039;ll likely need to edit the xml and refer to the excellent documentation on the libvirt website.&#160; My blog below hopefully also has some useful examples.</p></div></blockquote></div><br /><p>Hi, thanks a lot for your help. I want to do GPU assignment with OVMF. However I have a few questions left. You will see my questions are pretty elementary, so please bear with me please:</p><p>1. For OVMF: will I still need <strong>linux-mainline-3.17.2.tar.gz</strong> provided by nbhs? I do have an Intel Mainboard. And to nbhs: thank you very much for this thread and for your work!<br />2. Do I need to enable something in kernel configuration or is it enough to simply hit exit in the wizard and let it compile?<br />3. In your blog you wrote: </p><div class="quotebox"><blockquote><div><p>Ok, you&#039;re still reading, let&#039;s get started.&#160; First you need an OVMF binary.&#160; You can build this from source using the TianoCore EDK2 tree, but it is a massive pain.&#160; Therefore, I recommend using a pre-built binary, like the one Gerd Hoffmann provides.&#160; With Gerd&#039;s repo setup (or one appropriate to your distribution), you can install the edk2.git-ovmf-x64 package, which gives us the OVMF-pure-efi.fd OVMF image.</p></div></blockquote></div><p>As I use arch <strong>where do I get the pure OVMF Image? </strong> <br />There is a ovmf-svn package in AUR but I couldn&#039;t install it. It breaks.</p><p>thanks a lot for helping me!</p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1471661">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1471687" class="blockpost roweven"> <h2><span><span class="conr">#3131</span> <a href="viewtopic.php?pid=1471687#p1471687">2014-11-01 19:30:13</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=70922">nbhs</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd class="postavatar"><img src="https://bbs.archlinux.org/img/avatars/70922.jpg?m=1367773811" width="80" height="80" alt="" /></dd> <dd><span>From: Montevideo, Uruguay</span></dd> <dd><span>Registered: 2013-05-02</span></dd> <dd><span>Posts: 402</span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>4kGamer wrote:</cite><blockquote><div><div class="quotebox"><cite>aw wrote:</cite><blockquote><div><div class="quotebox"><cite>4kGamer wrote:</cite><blockquote><div><p>Awesome! thanks a lot for your help Alex! <strong>I can confirm that the brand new MSI GTX 980 Gaming has been successfully passed through Windows 8.1 with the latest NVidia drivers! </strong></p><p>Now, I will try to install it with virtio.</p><p>One question: do you recommend the use of libvirt for performance reasons? If so, is it enough to simply install it??</p></div></blockquote></div><p>libvirt makes some aspects of performance tuning easier, especially things like vCPU pinning, network configuration, and device tuning options, but it&#039;s not required.&#160; If you use VGA assignment you also need to deal with the lack of support for the x-vga option, which often leads people to use &lt;qemu:commandline&gt; blocks that hide the device assignment from libvirt and make lots of things more difficult.&#160; I recommend instead using a wrapper script around qemu to insert the option (I provided a link to some redhat documentation that could be adapted for this a while ago).&#160; The even better option is to use OVMF, which seems like it should be possible for you since you&#039;re running Win8.1 and have a new video card.&#160; There are no libvirt hacks required for GPU assignment with OVMF (but you do need very new libvirt).</p><p>libvirt needs to manage the VM, so it&#039;s a bit more than simply installing it, you&#039;ll need to create/import the VM to work from libvirt.&#160; virt-manager is a reasonable tool to get started for that, but for advanced tuning you&#039;ll likely need to edit the xml and refer to the excellent documentation on the libvirt website.&#160; My blog below hopefully also has some useful examples.</p></div></blockquote></div><br /><p>Hi, thanks a lot for your help. I want to do GPU assignment with OVMF. However I have a few questions left. You will see my questions are pretty elementary, so please bear with me please:</p><p>1. For OVMF: will I still need <strong>linux-mainline-3.17.2.tar.gz</strong> provided by nbhs? I do have an Intel Mainboard. And to nbhs: thank you very much for this thread and for your work!<br />2. Do I need to enable something in kernel configuration or is it enough to simply hit exit in the wizard and let it compile?<br />3. In your blog you wrote: </p><div class="quotebox"><blockquote><div><p>Ok, you&#039;re still reading, let&#039;s get started.&#160; First you need an OVMF binary.&#160; You can build this from source using the TianoCore EDK2 tree, but it is a massive pain.&#160; Therefore, I recommend using a pre-built binary, like the one Gerd Hoffmann provides.&#160; With Gerd&#039;s repo setup (or one appropriate to your distribution), you can install the edk2.git-ovmf-x64 package, which gives us the OVMF-pure-efi.fd OVMF image.</p></div></blockquote></div><p>As I use arch <strong>where do I get the pure OVMF Image? </strong> <br />There is a ovmf-svn package in AUR but I couldn&#039;t install it. It breaks.</p><p>thanks a lot for helping me!</p></div></blockquote></div><p><a href="https://drive.google.com/folderview?id=0Bxp_MsrVrNnEQ3hSTkZkbFJtXzg&amp;usp=sharing" rel="nofollow">OVMF-26830e8.tar.gz</a> built from git</p> <p class="postedit"><em>Last edited by nbhs (2014-11-01 19:31:26)</em></p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1471687">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1471691" class="blockpost rowodd"> <h2><span><span class="conr">#3132</span> <a href="viewtopic.php?pid=1471691#p1471691">2014-11-01 19:37:28</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=75590">aw</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2013-10-04</span></dd> <dd><span>Posts: 921</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=75590">Email</a></span> <span class="website"><a href="http://vfio.blogspot.com/" rel="nofollow">Website</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>4kGamer wrote:</cite><blockquote><div><p>1. For OVMF: will I still need <strong>linux-mainline-3.17.2.tar.gz</strong> provided by nbhs? I do have an Intel Mainboard. And to nbhs: thank you very much for this thread and for your work!</p></div></blockquote></div><p>Only if you need the pcie_acs_override= option</p><div class="quotebox"><blockquote><div><p>2. Do I need to enable something in kernel configuration or is it enough to simply hit exit in the wizard and let it compile?</p></div></blockquote></div><p>I would guess the default config for your distro is ok so long as the VFIO options are enabled (VFIO VGA is no longer a requirement)</p><div class="quotebox"><blockquote><div><p>3. In your blog you wrote: </p><div class="quotebox"><blockquote><div><p>Ok, you&#039;re still reading, let&#039;s get started.&#160; First you need an OVMF binary.&#160; You can build this from source using the TianoCore EDK2 tree, but it is a massive pain.&#160; Therefore, I recommend using a pre-built binary, like the one Gerd Hoffmann provides.&#160; With Gerd&#039;s repo setup (or one appropriate to your distribution), you can install the edk2.git-ovmf-x64 package, which gives us the OVMF-pure-efi.fd OVMF image.</p></div></blockquote></div><p>As I use arch <strong>where do I get the pure OVMF Image? </strong> <br />There is a ovmf-svn package in AUR but I couldn&#039;t install it. It breaks.</p></div></blockquote></div><p>Looks like nbhs already linked you up here</p> </div> <div class="postsignature postmsg"><hr /><p><a href="http://vfio.blogspot.com" rel="nofollow">http://vfio.blogspot.com</a><br />Looking for a more open forum to discuss vfio related uses?&#160; Try <a href="https://www.redhat.com/mailman/listinfo/vfio-users" rel="nofollow">https://www.redhat.com/mailman/listinfo/vfio-users</a></p></div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1471691">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1471733" class="blockpost roweven"> <h2><span><span class="conr">#3133</span> <a href="viewtopic.php?pid=1471733#p1471733">2014-11-01 21:14:45</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=86302">4kGamer</a></strong></dt> <dd class="usertitle"><strong>Banned</strong></dd> <dd><span>Registered: 2014-10-29</span></dd> <dd><span>Posts: 82</span></dd> <dd class="usercontacts"><span class="email"><a href="mailto:oktayaslantas@gmx.de">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <p>thank you guys! I extracted <em>OVMF-26830e8.tar.gz</em> and I got three files: OVMF_CODE.fd&#160; OVMF.fd&#160; OVMF_VARS.fd</p><p>can I use thse for libvirt too? And do I have to rename them? Is the <strong>OVMF.fd</strong> file the &quot;pure-efi&quot; one?</p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1471733">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1471737" class="blockpost rowodd"> <h2><span><span class="conr">#3134</span> <a href="viewtopic.php?pid=1471737#p1471737">2014-11-01 21:22:26</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=70922">nbhs</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd class="postavatar"><img src="https://bbs.archlinux.org/img/avatars/70922.jpg?m=1367773811" width="80" height="80" alt="" /></dd> <dd><span>From: Montevideo, Uruguay</span></dd> <dd><span>Registered: 2013-05-02</span></dd> <dd><span>Posts: 402</span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>4kGamer wrote:</cite><blockquote><div><p>thank you guys! I extracted <em>OVMF-26830e8.tar.gz</em> and I got three files: OVMF_CODE.fd&#160; OVMF.fd&#160; OVMF_VARS.fd</p><p>can I use thse for libvirt too? And do I have to rename them? Is the <strong>OVMF.fd</strong> file the &quot;pure-efi&quot; one?</p></div></blockquote></div><p>----&gt; <a href="http://vfio.blogspot.com/" rel="nofollow">http://vfio.blogspot.com/</a></p><p>If by pure efi you mean without CSM, then yes</p> <p class="postedit"><em>Last edited by nbhs (2014-11-01 21:27:40)</em></p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1471737">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1471808" class="blockpost roweven"> <h2><span><span class="conr">#3135</span> <a href="viewtopic.php?pid=1471808#p1471808">2014-11-02 03:37:07</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=86398">zopilote</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2014-11-02</span></dd> <dd><span>Posts: 2</span></dd> <dd class="usercontacts"><span class="email"><a href="mailto:zopilote@ec-red.com">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>aw wrote:</cite><blockquote><div><p>When using q35, only one GPU got MSI/MSI-X interrupt enabled. When using pc - both GPUs have their msi enabled. And that fact results in MANY variants of stuff.</p></div></blockquote></div><p>Hi, I&#039;m sorry but this seems very important to point, so, if I have two virtual machines (wn8 each one with its own gpu passed through), with q35, only one of them will have its gpu with msi enabled?</p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1471808">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1471809" class="blockpost rowodd"> <h2><span><span class="conr">#3136</span> <a href="viewtopic.php?pid=1471809#p1471809">2014-11-02 03:42:43</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=75590">aw</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2013-10-04</span></dd> <dd><span>Posts: 921</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=75590">Email</a></span> <span class="website"><a href="http://vfio.blogspot.com/" rel="nofollow">Website</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>zopilote wrote:</cite><blockquote><div><div class="quotebox"><cite>aw wrote:</cite><blockquote><div><p>When using q35, only one GPU got MSI/MSI-X interrupt enabled. When using pc - both GPUs have their msi enabled. And that fact results in MANY variants of stuff.</p></div></blockquote></div><p>Hi, I&#039;m sorry but this seems very important to point, so, if I have two virtual machines (wn8 each one with its own gpu passed through), with q35, only one of them will have its gpu with msi enabled?</p></div></blockquote></div><p>I never said this, misquote.&#160; Guests are independent of each other, more than one can use MSI at the same time.</p> </div> <div class="postsignature postmsg"><hr /><p><a href="http://vfio.blogspot.com" rel="nofollow">http://vfio.blogspot.com</a><br />Looking for a more open forum to discuss vfio related uses?&#160; Try <a href="https://www.redhat.com/mailman/listinfo/vfio-users" rel="nofollow">https://www.redhat.com/mailman/listinfo/vfio-users</a></p></div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1471809">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1471810" class="blockpost roweven"> <h2><span><span class="conr">#3137</span> <a href="viewtopic.php?pid=1471810#p1471810">2014-11-02 03:42:59</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=52029">risho</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2011-09-06</span></dd> <dd><span>Posts: 44</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=52029">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <p>do you need to be booting via efi or can you be booting via the old bios method on the host? does it matter?</p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1471810">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1471812" class="blockpost rowodd"> <h2><span><span class="conr">#3138</span> <a href="viewtopic.php?pid=1471812#p1471812">2014-11-02 03:50:56</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=75590">aw</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2013-10-04</span></dd> <dd><span>Posts: 921</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=75590">Email</a></span> <span class="website"><a href="http://vfio.blogspot.com/" rel="nofollow">Website</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>risho wrote:</cite><blockquote><div><p>do you need to be booting via efi or can you be booting via the old bios method on the host? does it matter?</p></div></blockquote></div><p>The host using EFI/BIOS is independent of the guest.</p> </div> <div class="postsignature postmsg"><hr /><p><a href="http://vfio.blogspot.com" rel="nofollow">http://vfio.blogspot.com</a><br />Looking for a more open forum to discuss vfio related uses?&#160; Try <a href="https://www.redhat.com/mailman/listinfo/vfio-users" rel="nofollow">https://www.redhat.com/mailman/listinfo/vfio-users</a></p></div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1471812">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1472009" class="blockpost roweven"> <h2><span><span class="conr">#3139</span> <a href="viewtopic.php?pid=1472009#p1472009">2014-11-02 22:35:36</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=85314">Duelist</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2014-09-22</span></dd> <dd><span>Posts: 358</span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <p>Unbelievable!<br />I refuse to believe that, but seems like...<br />...after a full guest reinstall...<br />...and a boot started with BSOD f4...<br /><strong>I&#039;VE GOT CROSSFIREX WORKING!</strong></p><p>The setup:<br />Hardware(yet again..):<br />MB:ASUS F2A55<br />CPU:Athlon X4 750K<br />RAM:Some generic AMD(HYNIX) 8GB.<br />GPUs:ASUS HD7750+HD7750(DCSL, passively cooled), GT610 silent(host, connected using pci-e x1-x16 riser into first x1 slot)<br />Cables connected:<br />GPU1-&gt;DVI<br />GPU2-&gt;X<br />(I could&#039;ve connect GPU2-&gt;VGA on the same physical screen, and it would go nuts)</p><p>Versions:<br />BIOS(somewhat important):6501(first to support IOMMU)<br />Fedora 21(rawhide or what was it called?)<br />Kernel:3.17.1-304.fc21.x86_64<br />QEMU:2.1.2<br />Seabios:1.7.5<br />Host drivers:Nvidia 343.22 x64<br />Guest drivers:Catalyst 14.9 x64<br />Guest OS: Windows 7 x64.</p><p>Kernel parameters:<br />nofb pci-stub.ids=1002:683f,1002:aab0,1002:683f,1002:683f enable_mtrr_cleanup</p><p>/etc/modprobe.d/kvm-amd.conf:<br />options kvm-amd npt=1 nested=1<br />options kvm ignore_msrs=0<br />options vfio_iommu_type1=allow_unsafe_interrupts=1<br />#(maybe i should drop that last line as it shouldn&#039;t be needed)</p><p>Startup script:</p><div class="codebox"><pre class="vscroll"><code>#!/bin/bash QEMU_PA_SAMPLES=128 QEMU_AUDIO_DRV=pa SDL_VIDEO_X11_DGAMOUSE=0 sudo qemu-system-x86_64 \ -boot menu=on \ -realtime mlock=on \ -mem-prealloc \ -enable-kvm \ -monitor stdio \ -M pc \ -m 4096 \ -cpu host \ -net none \ -rtc base=localtime \ -smp 4,sockets=1,cores=4,threads=1 \ -netdev tap,ifname=tap0,id=tap0 \ -drive file=&#039;/mnt/hdd/qemu/qemu-vfio-win.img&#039;,id=disk,format=raw,cache=none,if=none \ -drive file=&#039;/mnt/hdd/qemu/virtio.iso&#039;,id=cdrom,format=raw,readonly=on,if=none \ -drive file=&#039;/mnt/hdd/qemu/windows7.iso&#039;,id=cdrom2,format=raw,readonly=on,if=none \ -device ioh3420,addr=02.0,multifunction=on,port=1,chassis=1,id=root.0 \ -device ioh3420,addr=04.0,multifunction=on,port=1,chassis=2,id=root.1 \ -device qxl,bus=root.1,addr=02.0 \ -device vfio-pci,host=01:00.0,bus=root.0,addr=00.0,multifunction=on,x-vga=on \ -device vfio-pci,host=01:00.1,bus=root.0,addr=00.1 \ -device vfio-pci,host=02:00.0,bus=root.0,addr=01.0,multifunction=on,x-vga=off \ -device vfio-pci,host=02:00.1,bus=root.0,addr=01.1 \ -device virtio-blk-pci,bus=root.1,addr=03.0,drive=disk \ -device virtio-scsi-pci,bus=root.1,addr=04.0 \ -device ide-cd,bus=ide.1,drive=cdrom \ -device scsi-cd,drive=cdrom2 \ -device ich9-intel-hda,bus=root.1,addr=00.0,id=sound0 \ -device hda-duplex,id=sound0-codec0,bus=sound0.0,cad=0 \ -device virtio-net-pci,netdev=tap0,bus=root.1,addr=01.0 \ -vga none</code></pre></div><p>(Note ONE root port per two GPUs).</p><p>dmesg:</p><div class="codebox"><pre class="vscroll"><code>[12457.367755] vfio-pci 0000:01:00.1: Refused to change power state, currently in D3 [12457.367933] vfio_pci_disable: Failed to reset device 0000:01:00.1 (-22) [12457.378727] vfio-pci 0000:01:00.1: Refused to change power state, currently in D3 [12458.418190] vfio-pci 0000:02:00.1: Refused to change power state, currently in D3 [12458.418367] vfio_pci_disable: Failed to reset device 0000:02:00.1 (-22) [12458.429126] vfio-pci 0000:02:00.1: Refused to change power state, currently in D3 #A guest reboot happened here ^^ [12489.677504] device tap0 entered promiscuous mode [12489.682172] virbr0: port 2(tap0) entered listening state [12489.682182] virbr0: port 2(tap0) entered listening state [12491.681907] virbr0: port 2(tap0) entered learning state [12491.800412] vfio-pci 0000:01:00.0: enabling device (0400 -&gt; 0403) [12491.822020] vfio_ecap_init: 0000:01:00.0 hiding ecap 0x19@0x270 [12491.826594] vfio-pci 0000:01:00.1: enabling device (0400 -&gt; 0402) [12491.851818] vfio-pci 0000:02:00.0: enabling device (0400 -&gt; 0403) [12491.874107] vfio_ecap_init: 0000:02:00.0 hiding ecap 0x19@0x270 [12491.878852] vfio-pci 0000:02:00.1: enabling device (0400 -&gt; 0402) [12493.684777] virbr0: topology change detected, propagating [12493.684799] virbr0: port 2(tap0) entered forwarding state [12507.936987] kvm: zapping shadow pages for mmio generation wraparound [12517.733221] vfio-pci 0000:01:00.0: irq 40 for MSI/MSI-X [12517.936020] vfio-pci 0000:02:00.0: irq 41 for MSI/MSI-X #^^First boot messages without crossfire [12586.636623] vfio-pci 0000:01:00.0: irq 40 for MSI/MSI-X [12586.842463] vfio-pci 0000:02:00.0: irq 41 for MSI/MSI-X [12853.980234] vfio-pci 0000:02:00.0: irq 41 for MSI/MSI-X [12854.211315] vfio-pci 0000:01:00.0: irq 40 for MSI/MSI-X #^^Turning crossfire on, having screen blinking as usual.</code></pre></div><p>/proc/:</p><p>mtrr:</p><div class="codebox"><pre><code>reg00: base=0x000000000 ( 0MB), size= 2048MB, count=1: write-back reg01: base=0x080000000 ( 2048MB), size= 512MB, count=1: write-back reg02: base=0x0a0000000 ( 2560MB), size= 256MB, count=1: write-back reg03: base=0x0af000000 ( 2800MB), size= 16MB, count=1: uncachable</code></pre></div><p>iomem:</p><div class="codebox"><pre class="vscroll"><code>00000000-00000fff : reserved 00001000-0009e7ff : System RAM 0009e800-0009ffff : reserved 000a0000-000bffff : PCI Bus 0000:00 000c0000-000dffff : PCI Bus 0000:00 000c0000-000cffff : Video ROM 000e0000-000fffff : reserved 000f0000-000fffff : System ROM 00100000-ad518fff : System RAM 01000000-0174a014 : Kernel code 0174a015-01d33c7f : Kernel data 01eac000-0202cfff : Kernel bss ad519000-ad6a4fff : reserved ad6a5000-ad6b4fff : ACPI Tables ad6b5000-ada13fff : ACPI Non-volatile Storage ada14000-ae626fff : reserved ae627000-ae627fff : System RAM ae628000-ae82dfff : ACPI Non-volatile Storage ae82e000-aec5efff : System RAM aec5f000-aeff3fff : reserved aeff4000-aeffffff : System RAM af000000-afffffff : RAM buffer b0000000-ffffffff : PCI Bus 0000:00 b0000000-bfffffff : PCI Bus 0000:02 b0000000-bfffffff : 0000:02:00.0 b0000000-bfffffff : vfio-pci c0000000-cfffffff : PCI Bus 0000:01 c0000000-cfffffff : 0000:01:00.0 c0000000-cfffffff : vfio-pci d0000000-d9ffffff : PCI Bus 0000:04 d0000000-d7ffffff : 0000:04:00.0 d8000000-d9ffffff : 0000:04:00.0 da100000-da1fffff : PCI Bus 0000:06 da100000-da103fff : 0000:06:00.0 da100000-da103fff : r8169 da104000-da104fff : 0000:06:00.0 da104000-da104fff : r8169 e0000000-efffffff : PCI MMCONFIG 0000 [bus 00-ff] e0000000-efffffff : pnp 00:00 fd000000-fe0fffff : PCI Bus 0000:04 fd000000-fdffffff : 0000:04:00.0 fd000000-fdffffff : nvidia fe000000-fe07ffff : 0000:04:00.0 fe080000-fe083fff : 0000:04:00.1 fe080000-fe083fff : ICH HD audio fe100000-fe1fffff : PCI Bus 0000:05 fe100000-fe107fff : 0000:05:00.0 fe100000-fe107fff : xhci_hcd fe200000-fe2fffff : PCI Bus 0000:02 fe200000-fe23ffff : 0000:02:00.0 fe200000-fe23ffff : vfio-pci fe240000-fe25ffff : 0000:02:00.0 fe260000-fe263fff : 0000:02:00.1 fe260000-fe263fff : vfio-pci fe300000-fe3fffff : PCI Bus 0000:01 fe300000-fe33ffff : 0000:01:00.0 fe300000-fe33ffff : vfio-pci fe340000-fe35ffff : 0000:01:00.0 fe360000-fe363fff : 0000:01:00.1 fe360000-fe363fff : vfio-pci fe400000-fe403fff : 0000:00:14.2 fe400000-fe403fff : ICH HD audio fe404000-fe4040ff : 0000:00:16.2 fe404000-fe4040ff : ehci_hcd fe405000-fe405fff : 0000:00:16.0 fe405000-fe405fff : ohci_hcd fe406000-fe4060ff : 0000:00:13.2 fe406000-fe4060ff : ehci_hcd fe407000-fe407fff : 0000:00:13.0 fe407000-fe407fff : ohci_hcd fe408000-fe4080ff : 0000:00:12.2 fe408000-fe4080ff : ehci_hcd fe409000-fe409fff : 0000:00:12.0 fe409000-fe409fff : ohci_hcd fe40a000-fe40a7ff : 0000:00:11.0 fe40a000-fe40a7ff : ahci feb80000-febfffff : amd_iommu fec00000-fec00fff : reserved fec00000-fec003ff : IOAPIC 0 fec10000-fec10fff : reserved fec10000-fec10fff : pnp 00:03 fed00000-fed00fff : reserved fed00000-fed003ff : HPET 0 fed00000-fed003ff : PNP0103:00 fed61000-fed70fff : pnp 00:03 fed80000-fed8ffff : reserved fed80000-fed8ffff : pnp 00:03 fee00000-fee00fff : Local APIC fee00000-fee00fff : pnp 00:03 ff000000-ffffffff : reserved ff000000-ffffffff : pnp 00:03 100001000-24effffff : System RAM 24f000000-24fffffff : RAM buffer</code></pre></div><p>interrupts</p><div class="codebox"><pre class="vscroll"><code> CPU0 CPU1 CPU2 CPU3 0: 133 0 0 0 IR-IO-APIC-edge timer 1: 14205 14099 14448 15568 IR-IO-APIC-edge i8042 8: 0 1 0 0 IR-IO-APIC-edge rtc0 9: 0 0 0 0 IR-IO-APIC-fasteoi acpi 16: 249 301 896 452 IR-IO-APIC 16-fasteoi snd_hda_intel 17: 316 912 1305 452 IR-IO-APIC 17-fasteoi ehci_hcd:usb1, ehci_hcd:usb2, ehci_hcd:usb3, snd_hda_intel, vfio-intx(0000:02:00.1) 18: 26813 79583 64074 22305 IR-IO-APIC 18-fasteoi ohci_hcd:usb4, ohci_hcd:usb5, ohci_hcd:usb6 19: 991 912 975 1184 IR-IO-APIC 19-fasteoi vfio-intx(0000:01:00.1) 24: 0 0 0 0 IR-PCI-MSI-edge AMD-Vi 25: 10442 160150 123 492188 IR-PCI-MSI-edge ahci0 26: 16636 16686 16897 17841 IR-PCI-MSI-edge ahci1 27: 0 0 0 0 IR-PCI-MSI-edge ahci2 28: 0 0 0 0 IR-PCI-MSI-edge ahci3 29: 0 0 0 0 IR-PCI-MSI-edge ahci4 30: 3358 3482 3569 3637 IR-PCI-MSI-edge ahci5 33: 0 0 0 0 IR-PCI-MSI-edge xhci_hcd 34: 0 0 0 0 IR-PCI-MSI-edge xhci_hcd 35: 0 0 0 0 IR-PCI-MSI-edge xhci_hcd 36: 0 0 0 0 IR-PCI-MSI-edge xhci_hcd 37: 0 0 0 0 IR-PCI-MSI-edge xhci_hcd 38: 1043180 4 606979 6 IR-PCI-MSI-edge p34p1 39: 65 44297 63 154262 IR-PCI-MSI-edge nvidia 40: 72821 72798 73767 76769 IR-PCI-MSI-edge vfio-msi[0](0000:01:00.0) 41: 41094 41276 42254 43526 IR-PCI-MSI-edge vfio-msi[0](0000:02:00.0) NMI: 247 244 255 253 Non-maskable interrupts LOC: 3808655 3249700 4271226 3515979 Local timer interrupts SPU: 0 0 0 0 Spurious interrupts PMI: 247 244 255 253 Performance monitoring interrupts IWI: 5 0 0 2 IRQ work interrupts RTR: 0 0 0 0 APIC ICR read retries RES: 7385839 7154521 7540346 6975371 Rescheduling interrupts CAL: 2243 2057 2171 2292 Function call interrupts TLB: 36726 35621 33872 33973 TLB shootdowns TRM: 0 0 0 0 Thermal event interrupts THR: 0 0 0 0 Threshold APIC interrupts MCE: 0 0 0 0 Machine check exceptions MCP: 48 48 48 48 Machine check polls THR: 0 0 0 0 Hypervisor callback interrupts</code></pre></div><p>ioports:</p><div class="codebox"><pre class="vscroll"><code>0000-03af : PCI Bus 0000:00 0000-001f : dma1 0020-0021 : pic1 0040-0043 : timer0 0050-0053 : timer1 0060-0060 : keyboard 0061-0061 : PNP0800:00 0064-0064 : keyboard 0070-0071 : rtc0 0080-008f : dma page reg 00a0-00a1 : pic2 00c0-00df : dma2 00f0-00ff : PNP0C04:00 00f0-00ff : fpu 0290-029f : pnp 00:04 0300-031f : pnp 00:04 03b0-03df : PCI Bus 0000:00 03c0-03df : vga+ 03e0-0cf7 : PCI Bus 0000:00 03f8-03ff : serial 040b-040b : pnp 00:03 04d0-04d1 : pnp 00:03 04d0-04d1 : pnp 00:06 04d6-04d6 : pnp 00:03 0800-0803 : ACPI PM1a_EVT_BLK 0804-0805 : ACPI PM1a_CNT_BLK 0808-080b : ACPI PM_TMR 0810-0815 : ACPI CPU throttle 0820-0827 : ACPI GPE0_BLK 0900-090f : pnp 00:03 0910-091f : pnp 00:03 0b00-0b07 : piix4_smbus 0b20-0b3f : pnp 00:03 0b20-0b27 : piix4_smbus 0c00-0c01 : pnp 00:03 0c14-0c14 : pnp 00:03 0c50-0c51 : pnp 00:03 0c52-0c52 : pnp 00:03 0c6c-0c6c : pnp 00:03 0c6f-0c6f : pnp 00:03 0cd0-0cd1 : pnp 00:03 0cd2-0cd3 : pnp 00:03 0cd4-0cd5 : pnp 00:03 0cd6-0cd7 : pnp 00:03 0cd8-0cdf : pnp 00:03 0cf8-0cff : PCI conf1 0d00-ffff : PCI Bus 0000:00 b000-bfff : PCI Bus 0000:06 b000-b0ff : 0000:06:00.0 b000-b0ff : r8169 c000-cfff : PCI Bus 0000:04 c000-c07f : 0000:04:00.0 d000-dfff : PCI Bus 0000:02 d000-d0ff : 0000:02:00.0 e000-efff : PCI Bus 0000:01 e000-e0ff : 0000:01:00.0 e000-e0ff : vfio f000-f00f : 0000:00:11.0 f000-f00f : ahci f010-f013 : 0000:00:11.0 f010-f013 : ahci f020-f027 : 0000:00:11.0 f020-f027 : ahci f030-f033 : 0000:00:11.0 f030-f033 : ahci f040-f047 : 0000:00:11.0 f040-f047 : ahci fe00-fefe : pnp 00:03</code></pre></div><p>sudo lspci -v</p><div class="codebox"><pre class="vscroll"><code>01:00.0 VGA compatible controller: Advanced Micro Devices, Inc. [AMD/ATI] Cape Verde PRO [Radeon HD 7750 / R7 250E] (prog-if 00 [VGA controller]) Subsystem: ASUSTeK Computer Inc. Device 0459 Flags: bus master, fast devsel, latency 0, IRQ 40 Memory at c0000000 (64-bit, prefetchable) [size=256M] Memory at fe300000 (64-bit, non-prefetchable) [size=256K] I/O ports at e000 [size=256] Expansion ROM at fe340000 [disabled] [size=128K] Capabilities: [48] Vendor Specific Information: Len=08 &lt;?&gt; Capabilities: [50] Power Management version 3 Capabilities: [58] Express Legacy Endpoint, MSI 00 Capabilities: [a0] MSI: Enable+ Count=1/1 Maskable- 64bit+ Capabilities: [100] Vendor Specific Information: ID=0001 Rev=1 Len=010 &lt;?&gt; Capabilities: [150] Advanced Error Reporting Capabilities: [270] #19 Kernel driver in use: vfio-pci Kernel modules: radeon 01:00.1 Audio device: Advanced Micro Devices, Inc. [AMD/ATI] Cape Verde/Pitcairn HDMI Audio [Radeon HD 7700/7800 Series] Subsystem: ASUSTeK Computer Inc. Device aab0 Flags: bus master, fast devsel, latency 0, IRQ 19 Memory at fe360000 (64-bit, non-prefetchable) [size=16K] Capabilities: [48] Vendor Specific Information: Len=08 &lt;?&gt; Capabilities: [50] Power Management version 3 Capabilities: [58] Express Legacy Endpoint, MSI 00 Capabilities: [a0] MSI: Enable- Count=1/1 Maskable- 64bit+ Capabilities: [100] Vendor Specific Information: ID=0001 Rev=1 Len=010 &lt;?&gt; Capabilities: [150] Advanced Error Reporting Kernel driver in use: vfio-pci Kernel modules: snd_hda_intel 02:00.0 VGA compatible controller: Advanced Micro Devices, Inc. [AMD/ATI] Cape Verde PRO [Radeon HD 7750 / R7 250E] (prog-if 00 [VGA controller]) Subsystem: ASUSTeK Computer Inc. Device 0459 Flags: bus master, fast devsel, latency 0, IRQ 41 Memory at b0000000 (64-bit, prefetchable) [size=256M] Memory at fe200000 (64-bit, non-prefetchable) [size=256K] I/O ports at d000 [size=256] Expansion ROM at fe240000 [disabled] [size=128K] Capabilities: [48] Vendor Specific Information: Len=08 &lt;?&gt; Capabilities: [50] Power Management version 3 Capabilities: [58] Express Legacy Endpoint, MSI 00 Capabilities: [a0] MSI: Enable+ Count=1/1 Maskable- 64bit+ Capabilities: [100] Vendor Specific Information: ID=0001 Rev=1 Len=010 &lt;?&gt; Capabilities: [150] Advanced Error Reporting Capabilities: [270] #19 Kernel driver in use: vfio-pci Kernel modules: radeon 02:00.1 Audio device: Advanced Micro Devices, Inc. [AMD/ATI] Cape Verde/Pitcairn HDMI Audio [Radeon HD 7700/7800 Series] Subsystem: ASUSTeK Computer Inc. Device aab0 Flags: fast devsel, IRQ 17 Memory at fe260000 (64-bit, non-prefetchable) [disabled] [size=16K] Capabilities: [48] Vendor Specific Information: Len=08 &lt;?&gt; Capabilities: [50] Power Management version 3 Capabilities: [58] Express Legacy Endpoint, MSI 00 Capabilities: [a0] MSI: Enable- Count=1/1 Maskable- 64bit+ Capabilities: [100] Vendor Specific Information: ID=0001 Rev=1 Len=010 &lt;?&gt; Capabilities: [150] Advanced Error Reporting Kernel driver in use: vfio-pci Kernel modules: snd_hda_intel 04:00.0 VGA compatible controller: NVIDIA Corporation GF119 [GeForce GT 610] (rev a1) (prog-if 00 [VGA controller]) Subsystem: Gigabyte Technology Co., Ltd Device 3546 Flags: bus master, fast devsel, latency 0, IRQ 39 Memory at fd000000 (32-bit, non-prefetchable) [size=16M] Memory at d0000000 (64-bit, prefetchable) [size=128M] Memory at d8000000 (64-bit, prefetchable) [size=32M] I/O ports at c000 [size=128] [virtual] Expansion ROM at fe000000 [disabled] [size=512K] Capabilities: [60] Power Management version 3 Capabilities: [68] MSI: Enable+ Count=1/1 Maskable- 64bit+ Capabilities: [78] Express Endpoint, MSI 00 Capabilities: [b4] Vendor Specific Information: Len=14 &lt;?&gt; Capabilities: [100] Virtual Channel Capabilities: [128] Power Budgeting &lt;?&gt; Capabilities: [600] Vendor Specific Information: ID=0001 Rev=1 Len=024 &lt;?&gt; Kernel driver in use: nvidia Kernel modules: nouveau, nvidia 04:00.1 Audio device: NVIDIA Corporation GF119 HDMI Audio Controller (rev a1) Subsystem: Gigabyte Technology Co., Ltd Device 3546 Flags: bus master, fast devsel, latency 0, IRQ 17 Memory at fe080000 (32-bit, non-prefetchable) [size=16K] Capabilities: [60] Power Management version 3 Capabilities: [68] MSI: Enable- Count=1/1 Maskable- 64bit+ Capabilities: [78] Express Endpoint, MSI 00 Kernel driver in use: snd_hda_intel Kernel modules: snd_hda_intel</code></pre></div><p>P.S.<br />If only this forum had [spoiler]spoiler[/spoiler] tag.</p> <p class="postedit"><em>Last edited by Duelist (2014-11-02 23:51:37)</em></p> </div> <div class="postsignature postmsg"><hr /><p><span class="bbs">The forum rules prohibit requesting support for distributions other than arch.</span><br /><a href="https://bbs.archlinux.org/viewtopic.php?pid=1551460#p1551460" rel="nofollow">I gave up.</a><a href="https://bbs.archlinux.org/viewtopic.php?id=162768" rel="nofollow"> It was too late.</a><br /><a href="http://pastebin.com/B3fL84bq" rel="nofollow">What I was trying to do</a>.<br /><a href="http://vfio.blogspot.com/" rel="nofollow">The reference about VFIO and KVM VGA passthrough.</a></p></div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1472009">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1472034" class="blockpost rowodd"> <h2><span><span class="conr">#3140</span> <a href="viewtopic.php?pid=1472034#p1472034">2014-11-03 01:22:02</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=75590">aw</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2013-10-04</span></dd> <dd><span>Posts: 921</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=75590">Email</a></span> <span class="website"><a href="http://vfio.blogspot.com/" rel="nofollow">Website</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>Duelist wrote:</cite><blockquote><div><div class="codebox"><pre class="vscroll"><code>#!/bin/bash QEMU_PA_SAMPLES=128 QEMU_AUDIO_DRV=pa SDL_VIDEO_X11_DGAMOUSE=0 sudo qemu-system-x86_64 \ -boot menu=on \ -realtime mlock=on \ -mem-prealloc \ -enable-kvm \ -monitor stdio \ -M pc \ -m 4096 \ -cpu host \ -net none \ -rtc base=localtime \ -smp 4,sockets=1,cores=4,threads=1 \ -netdev tap,ifname=tap0,id=tap0 \ -drive file=&#039;/mnt/hdd/qemu/qemu-vfio-win.img&#039;,id=disk,format=raw,cache=none,if=none \ -drive file=&#039;/mnt/hdd/qemu/virtio.iso&#039;,id=cdrom,format=raw,readonly=on,if=none \ -drive file=&#039;/mnt/hdd/qemu/windows7.iso&#039;,id=cdrom2,format=raw,readonly=on,if=none \ -device ioh3420,addr=02.0,multifunction=on,port=1,chassis=1,id=root.0 \ -device ioh3420,addr=04.0,multifunction=on,port=1,chassis=2,id=root.1 \ -device qxl,bus=root.1,addr=02.0 \ -device vfio-pci,host=01:00.0,bus=root.0,addr=00.0,multifunction=on,x-vga=on \ -device vfio-pci,host=01:00.1,bus=root.0,addr=00.1 \ -device vfio-pci,host=02:00.0,bus=root.0,addr=01.0,multifunction=on,x-vga=off \ -device vfio-pci,host=02:00.1,bus=root.0,addr=01.1 \ -device virtio-blk-pci,bus=root.1,addr=03.0,drive=disk \ -device virtio-scsi-pci,bus=root.1,addr=04.0 \ -device ide-cd,bus=ide.1,drive=cdrom \ -device scsi-cd,drive=cdrom2 \ -device ich9-intel-hda,bus=root.1,addr=00.0,id=sound0 \ -device hda-duplex,id=sound0-codec0,bus=sound0.0,cad=0 \ -device virtio-net-pci,netdev=tap0,bus=root.1,addr=01.0 \ -vga none</code></pre></div><p>(Note ONE root port per two GPUs).</p></div></blockquote></div><p>What a crazy config.&#160; You&#039;re running 440FX with PCIe root ports and behind one root port you have two endpoints and while you specify <em>-vga none</em> you add a qxl device, so I think you&#039;ve replaced the default emulated VGA device with one behind a root port.&#160; On real hardware this is equivalent to this:</p><p><span class="postimg"><img src="http://www.geek.com/wp-content/uploads/2010/08/500x_chain-usb1.jpg" alt="usb adapter" /></span></p><p>(EDIT: except you&#039;ve managed to plug 2 USB sticks into the resulting single port)</p><p>I&#039;m surprised that Windows scans for and finds your 2nd GPU since an OS will typically only scan device/slot 0.&#160; Attaching a PCIe root port to a 440FX chipset is just an impossible thing on real hardware.&#160; A pci-bridge might be a better option than the ioh3420 devices.&#160; If it works on <em>-M pc</em> but not on Q35, there might be some part of the PCIe extended config space that we need to hide or handle differently.</p> <p class="postedit"><em>Last edited by aw (2014-11-03 01:25:54)</em></p> </div> <div class="postsignature postmsg"><hr /><p><a href="http://vfio.blogspot.com" rel="nofollow">http://vfio.blogspot.com</a><br />Looking for a more open forum to discuss vfio related uses?&#160; Try <a href="https://www.redhat.com/mailman/listinfo/vfio-users" rel="nofollow">https://www.redhat.com/mailman/listinfo/vfio-users</a></p></div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1472034">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1472158" class="blockpost roweven"> <h2><span><span class="conr">#3141</span> <a href="viewtopic.php?pid=1472158#p1472158">2014-11-03 14:43:12</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=85314">Duelist</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2014-09-22</span></dd> <dd><span>Posts: 358</span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>aw wrote:</cite><blockquote><div><p>What a crazy config.&#160; You&#039;re running 440FX with PCIe root ports and behind one root port you have two endpoints and while you specify <em>-vga none</em> you add a qxl device, so I think you&#039;ve replaced the default emulated VGA device with one behind a root port.&#160; On real hardware this is equivalent to this:</p><p>I&#039;m surprised that Windows scans for and finds your 2nd GPU since an OS will typically only scan device/slot 0.&#160; Attaching a PCIe root port to a 440FX chipset is just an impossible thing on real hardware.&#160; A pci-bridge might be a better option than the ioh3420 devices.&#160; If it works on <em>-M pc</em> but not on Q35, there might be some part of the PCIe extended config space that we need to hide or handle differently.</p></div></blockquote></div><p>The qxl(not qxl-vga!) device is needed for... INPUT! QEMU creates a surface in it&#039;s GUI where it can grab mouse and keyboard. If i could force QEMU the other way without using crutches like that - it would be nice.<br />If the qxl device doesn&#039;t work - i don&#039;t care, i&#039;ve got the surface. Actually it&#039;s disabled in windows due to drivers(code 28). It doesn&#039;t take any ioports or memory, so it&#039;s fine while there is no drivers for it.<br />The -vga none is needed to get rid of any devices which i do not specify, especially VGA ones. For example, -vga qxl seem to be an alias for -device qxl-vga as it looks the same from the guest side.</p><p>The second root port is needed for various devices like network. I haven&#039;t poked around 440FX yet, but i may move them to some other PCI bus.</p><p>It is impossible to force windows to enable MSI under Q35 via registry - it doesn&#039;t help and the following registry hack is applied by the driver install.</p><p>I still have a strong feeling that my motherboard has a TON of quirks everywhere. Last time i&#039;ve had a true evidence of this is when i&#039;ve tried to look my cpu&#039;s temperature, and it was negative in amd overdrive(sort of official) software. It took them half a year to release a fix to fully support my CPU.</p><p>UPD:<br />Doing stuff like</p><div class="codebox"><pre><code>-device vfio-pci,host=01:00.0,addr=09.0,multifunction=on,x-vga=on \ -device vfio-pci,host=01:00.1,addr=09.1 \ -device vfio-pci,host=02:00.0,addr=0a.0,multifunction=on,x-vga=off \ -device vfio-pci,host=02:00.1,addr=0a.1 \</code></pre></div><p>results in interrupt storm and host system shutdown.</p><p>P.S.<br /><a href="http://www.geek.com/chips/a-parallel-port-to-usb-conversion-you-wont-believe-1276689/" rel="nofollow">http://www.geek.com/chips/a-parallel-po … e-1276689/</a><br />Heh, what a precise analogy. Yes, it does work and looks alike. But it works.</p> <p class="postedit"><em>Last edited by Duelist (2014-11-03 16:29:24)</em></p> </div> <div class="postsignature postmsg"><hr /><p><span class="bbs">The forum rules prohibit requesting support for distributions other than arch.</span><br /><a href="https://bbs.archlinux.org/viewtopic.php?pid=1551460#p1551460" rel="nofollow">I gave up.</a><a href="https://bbs.archlinux.org/viewtopic.php?id=162768" rel="nofollow"> It was too late.</a><br /><a href="http://pastebin.com/B3fL84bq" rel="nofollow">What I was trying to do</a>.<br /><a href="http://vfio.blogspot.com/" rel="nofollow">The reference about VFIO and KVM VGA passthrough.</a></p></div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1472158">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1472408" class="blockpost rowodd"> <h2><span><span class="conr">#3142</span> <a href="viewtopic.php?pid=1472408#p1472408">2014-11-04 10:40:35</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=82442">slis</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2014-06-02</span></dd> <dd><span>Posts: 125</span></dd> <dd class="usercontacts"><span class="email"><a href="mailto:xslisx@gmail.com">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <p>Do you think SLI would work with such config ? <img src="https://bbs.archlinux.org/img/smilies/smile.png" width="15" height="15" alt="smile" /></p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1472408">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1472416" class="blockpost roweven"> <h2><span><span class="conr">#3143</span> <a href="viewtopic.php?pid=1472416#p1472416">2014-11-04 11:56:39</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=80387">dwe11er</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2014-03-18</span></dd> <dd><span>Posts: 73</span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <p>I&#039;m wondering, how big impact on performance is running stuff like this in VM?</p><div class="quotebox"><cite>slis wrote:</cite><blockquote><div><p>Do you think SLI would work with such config ? <img src="https://bbs.archlinux.org/img/smilies/smile.png" width="15" height="15" alt="smile" /></p></div></blockquote></div><p>Even if it works, it&#039;s only for period of one driver release <img src="https://bbs.archlinux.org/img/smilies/smile.png" width="15" height="15" alt="smile" /></p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1472416">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1472420" class="blockpost rowodd"> <h2><span><span class="conr">#3144</span> <a href="viewtopic.php?pid=1472420#p1472420">2014-11-04 12:15:06</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=82442">slis</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2014-06-02</span></dd> <dd><span>Posts: 125</span></dd> <dd class="usercontacts"><span class="email"><a href="mailto:xslisx@gmail.com">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>dwe11er wrote:</cite><blockquote><div><p>I&#039;m wondering, how big impact on performance is running stuff like this in VM?</p><div class="quotebox"><cite>slis wrote:</cite><blockquote><div><p>Do you think SLI would work with such config ? <img src="https://bbs.archlinux.org/img/smilies/smile.png" width="15" height="15" alt="smile" /></p></div></blockquote></div><p>Even if it works, it&#039;s only for period of one driver release <img src="https://bbs.archlinux.org/img/smilies/smile.png" width="15" height="15" alt="smile" /></p></div></blockquote></div><br /><p>What do u think by that? I really don&#039;t care about &quot;newest drivers&quot;, cause I have gtx680... (running 340.82 for 2-3 months with 0 problems)</p><p>I tried running SLI couple months ago, and it failed with error code 10,12 or 43... on second card... so I am thinking givin it another go....</p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1472420">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1472447" class="blockpost roweven"> <h2><span><span class="conr">#3145</span> <a href="viewtopic.php?pid=1472447#p1472447">2014-11-04 14:08:42</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=79471">Bronek</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>From: London</span></dd> <dd><span>Registered: 2014-02-14</span></dd> <dd><span>Posts: 90</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=79471">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>slis wrote:</cite><blockquote><div><div class="quotebox"><cite>dwe11er wrote:</cite><blockquote><div><p>I&#039;m wondering, how big impact on performance is running stuff like this in VM?</p><div class="quotebox"><cite>slis wrote:</cite><blockquote><div><p>Do you think SLI would work with such config ? <img src="https://bbs.archlinux.org/img/smilies/smile.png" width="15" height="15" alt="smile" /></p></div></blockquote></div><p>Even if it works, it&#039;s only for period of one driver release <img src="https://bbs.archlinux.org/img/smilies/smile.png" width="15" height="15" alt="smile" /></p></div></blockquote></div><br /><p>What do u think by that? I really don&#039;t care about &quot;newest drivers&quot;, cause I have gtx680... (running 340.82 for 2-3 months with 0 problems)</p><p>I tried running SLI couple months ago, and it failed with error code 10,12 or 43... on second card... so I am thinking givin it another go....</p></div></blockquote></div><p>nVidia seem to purposefully make changes to newest drivers to prevent GPU passthrough on all but most expensive (GRID, some Quadro) cards.</p> </div> <div class="postsignature postmsg"><hr /><p>Sorry about&#160; &quot;KVM VGA-Passthrough ...&quot; thread <img src="https://bbs.archlinux.org/img/smilies/sad.png" width="15" height="15" alt="sad" /> Anyone interested in continuing this discussion elsewhere, please contact me privately. I might be able to find it a new home.</p></div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1472447">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1472463" class="blockpost rowodd"> <h2><span><span class="conr">#3146</span> <a href="viewtopic.php?pid=1472463#p1472463">2014-11-04 15:01:55</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=85314">Duelist</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2014-09-22</span></dd> <dd><span>Posts: 358</span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>dwe11er wrote:</cite><blockquote><div><p>I&#039;m wondering, how big impact on performance is running stuff like this in VM?</p></div></blockquote></div><p>Well, as far as i remember - i&#039;ve had 15FPS in opengl with 1 gpu in unigine heaven on linux. Same i have now in VM. I was trying to get this working so long, that i&#039;ve lost my benchmark results and don&#039;t even remember them properly.</p> </div> <div class="postsignature postmsg"><hr /><p><span class="bbs">The forum rules prohibit requesting support for distributions other than arch.</span><br /><a href="https://bbs.archlinux.org/viewtopic.php?pid=1551460#p1551460" rel="nofollow">I gave up.</a><a href="https://bbs.archlinux.org/viewtopic.php?id=162768" rel="nofollow"> It was too late.</a><br /><a href="http://pastebin.com/B3fL84bq" rel="nofollow">What I was trying to do</a>.<br /><a href="http://vfio.blogspot.com/" rel="nofollow">The reference about VFIO and KVM VGA passthrough.</a></p></div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1472463">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1472509" class="blockpost roweven"> <h2><span><span class="conr">#3147</span> <a href="viewtopic.php?pid=1472509#p1472509">2014-11-04 17:44:47</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=86040">mouton_sanglant</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2014-10-20</span></dd> <dd><span>Posts: 7</span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <p>Hello again !</p><p>I achieved to do VGA-Passthrough on another machine.<br />It is a desktop and more modern configuration but the GPU is quite old.</p><p>CPU: i5-4670T (Haswell family)<br />GPU: Nvidia 9500 GS</p><p>It&#039;s working fine, now going to do some tuning but there I have some questions first.</p><p><span style="color: red"><strong>Question 1:</strong></span> While I could do VGA-PT with my laptop without applying any patches, I can&#039;t with this new config (black screen). Especially the vga-arbiter patch. From what I understood from this article from Alex Williamson (<a href="http://vfio.blogspot.fr/2014/08/whats-deal-with-vga-arbitration.html" rel="nofollow">What&#039;s the deal with VGA arbitration ?</a>), this is because my brand new CPU&#039;s IGP is too recent ?</p><div class="quotebox"><cite>Alex Williamson wrote:</cite><blockquote><div><p>The native IGD driver would really like to continue running when VGA routing is directed elsewhere, so the PCI method of disabling access is sub-optimal.&#160; At some point Intel knew this and included mechanisms in the device that allowed VGA MMIO and I/O port space to be disabled separately from PCI MMIO and I/O port space.&#160; These mechanisms are what the i915 driver uses today when it opts-out of VGA arbitration.</p><p>The problem is that modern IGD devices don&#039;t implement the same mechanisms for disabling legacy VGA.&#160; The i915 driver continues to twiddle the old bits and opt-out of arbitration, but the IGD VGA is still claiming VGA transactions.&#160; This is why many users who claim they don&#039;t need the i915 patch finish their proclamation of success with a note about the VGA color palate being corrupted or noting some strange drm interrupt messages on the host dmesg. [...]</p><p>So why can&#039;t we simply fix the i915 driver to correctly disable legacy VGA support?&#160; Well, in their infinite wisdom, hardware designers have removed (or broken) that feature of IGD.</p></div></blockquote></div><p>My laptop&#039;s CPU is intel 2nd-gen, I have some color problems whenever I shutdown the VM, but this doesn&#039;t bother me much. So, I guess the feature is still there and not broken, but is on my intel 4th-gen CPU, right ?</p><p><span style="color: red"><strong>Question 2:</strong></span> My laptop&#039;s configuration <strong>needs</strong> a vbios rom in order to work, but this is not the case of my desktop&#039;s GPU. In fact, whenever I specify an extracted vbios it won&#039;t work: black screen (I extracted it myself from a live-cd, I strictly followed the same procedure than for my laptop vbios). My first thought was the GPU is a bit too old but I think it&#039;s a stupid idea. I used rom-parser to check the vbios and it says it&#039;s fine, reporting correct vendors ids. Where could it comes from ? Any suggestions ? It tickles me a lot !</p><br /><p><span style="color: red"><strong>Question 3:</strong></span> Now that I begin to understand PCI-PT in qemu, should I try to write a tutorial for french people ? Isn&#039;t it a bit risky since I don&#039;t have a wide knowledge of the internal mechanics and couldn&#039;t properly troubleshoot specific case issues ?</p><p>Well, thanks a lot again for the useful informations in this thread.</p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1472509">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1472515" class="blockpost rowodd"> <h2><span><span class="conr">#3148</span> <a href="viewtopic.php?pid=1472515#p1472515">2014-11-04 18:01:33</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=82604">Uramekus</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2014-06-08</span></dd> <dd><span>Posts: 7</span></dd> <dd class="usercontacts"><span class="email"><a href="mailto:decuke@hotmail.com">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <p>when i run</p><div class="quotebox"><blockquote><div><p>qemu-system-x86_64 \<br />&#160; &#160; &#160; &#160; -enable-kvm \<br />&#160; &#160; &#160; &#160; -M q35 \<br />&#160; &#160; &#160; &#160; -m 1024 \<br />&#160; &#160; &#160; &#160; -cpu host \<br />&#160; &#160; &#160; &#160; -smp 4,sockets=1,cores=4,threads=1 \<br />&#160; &#160; &#160; &#160; -bios /usr/share/qemu/bios.bin \<br />&#160; &#160; &#160; &#160; -vga none \<br />&#160; &#160; &#160; &#160; -device ioh3420,bus=pcie.0,addr=1c.0,multifunction=on,port=1,chassis=1,id=root.1 \<br />&#160; &#160; &#160; &#160; -device vfio-pci,host=01:00.0,bus=root.1,addr=00.0,multifunction=on,x-vga=on \<br />&#160; &#160; &#160; &#160; -device vfio-pci,host=01:00.1,bus=root.1,addr=00.1</p></div></blockquote></div><p>i get</p><div class="quotebox"><blockquote><div><p>qemu-system-x86_64: -device vfio-pci,host=01:00.0,bus=root.1,addr=00.0,multifunction=on,x-vga=on: vfio: error no iommu_group for device<br />qemu-system-x86_64: -device vfio-pci,host=01:00.0,bus=root.1,addr=00.0,multifunction=on,x-vga=on: Device initialization failed.<br />qemu-system-x86_64: -device vfio-pci,host=01:00.0,bus=root.1,addr=00.0,multifunction=on,x-vga=on: Device &#039;vfio-pci&#039; could not be initialized</p></div></blockquote></div><br /><p>my grub cfg settings are </p><div class="quotebox"><blockquote><div><p>GRUB_CMDLINE_LINUX=&quot;i915.enable_hd_vgaarb=1 pci-stub.ids=10de:1184,10de:0e0a&#160; pcie_acs_override=downstream&quot;</p></div></blockquote></div><p>when i set intel_iommu=on i got a disgraceful bug (less than 5s start the screen got stalled code-like)<br />and i don&#039;t have idea what i can do to get this working<br />*edit*&#160; how it looks<br /><span class="postimg"><img src="http://i.imgur.com/jXBjtD1.jpg" alt="how it looks" /></span><br />please someone help me <img src="https://bbs.archlinux.org/img/smilies/hmm.png" width="15" height="15" alt="hmm" /></p> <p class="postedit"><em>Last edited by Uramekus (2014-11-04 18:26:34)</em></p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1472515">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1472525" class="blockpost roweven"> <h2><span><span class="conr">#3149</span> <a href="viewtopic.php?pid=1472525#p1472525">2014-11-04 18:33:50</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=82442">slis</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2014-06-02</span></dd> <dd><span>Posts: 125</span></dd> <dd class="usercontacts"><span class="email"><a href="mailto:xslisx@gmail.com">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <p>You are missing intel_iommu=on</p><p>edit: forgot intel_ <img src="https://bbs.archlinux.org/img/smilies/smile.png" width="15" height="15" alt="smile" /></p> <p class="postedit"><em>Last edited by slis (2014-11-04 18:57:48)</em></p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1472525">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1472526" class="blockpost rowodd"> <h2><span><span class="conr">#3150</span> <a href="viewtopic.php?pid=1472526#p1472526">2014-11-04 18:38:11</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=82604">Uramekus</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2014-06-08</span></dd> <dd><span>Posts: 7</span></dd> <dd class="usercontacts"><span class="email"><a href="mailto:decuke@hotmail.com">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <p>i should enable iommu=on and intel_iommu=on?<br />or just iommu=on?</p> <p class="postedit"><em>Last edited by Uramekus (2014-11-04 18:41:54)</em></p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1472526">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div class="postlinksb"> <div class="inbox crumbsplus"> <div class="pagepost"> <p class="pagelink conl"><span class="pages-label">Pages: </span><a rel="prev" class="item1" href="viewtopic.php?id=162768&amp;p=125">Previous</a> <a href="viewtopic.php?id=162768">1</a> <span class="spacer">…</span> <a href="viewtopic.php?id=162768&amp;p=124">124</a> <a href="viewtopic.php?id=162768&amp;p=125">125</a> <strong>126</strong> <a href="viewtopic.php?id=162768&amp;p=127">127</a> <a href="viewtopic.php?id=162768&amp;p=128">128</a> <span class="spacer">…</span> <a href="viewtopic.php?id=162768&amp;p=234">234</a> <a rel="next" href="viewtopic.php?id=162768&amp;p=127">Next</a></p> <p class="postlink conr">Topic closed</p> </div> <ul class="crumbs"> <li><a href="index.php">Index</a></li> <li><span>»&#160;</span><a href="viewforum.php?id=48">Topics Going Nowhere</a></li> <li><span>»&#160;</span><strong><a href="viewtopic.php?id=162768">KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</a></strong></li> </ul> <p class="subscribelink clearb"><a href="misc.php?action=subscribe&amp;tid=162768">Subscribe to this topic</a></p> <div class="clearer"></div> </div> </div> </div> <div id="brdfooter" class="block"> <h2><span>Board footer</span></h2> <div class="box"> <div id="brdfooternav" class="inbox"> <div class="conl"> <form id="qjump" method="get" action="viewforum.php"> <div><label><span>Jump to<br /></span> <select name="id" onchange="window.location=('viewforum.php?id='+this.options[this.selectedIndex].value)"> <optgroup label="Technical Issues and Assistance"> <option value="23">Newbie Corner</option> <option value="17">Installation</option> <option value="22">Kernel &amp; Hardware</option> <option value="18">Applications &amp; Desktop Environments</option> <option value="31">Laptop Issues</option> <option value="8">Networking, Server, and Protection</option> <option value="32">Multimedia and Games</option> <option value="50">System Administration</option> <option value="35">Other Architectures</option> </optgroup> <optgroup label="Arch-centric"> <option value="24">Announcements, Package &amp; Security Advisories</option> <option value="1">Arch Discussion</option> <option value="13">Forum &amp; Wiki discussion</option> </optgroup> <optgroup label="Pacman Upgrades, Packaging &amp; AUR"> <option value="44">Pacman &amp; Package Upgrade Issues</option> <option value="49">[testing] Repo Forum</option> <option value="4">Creating &amp; Modifying Packages</option> <option value="38">AUR Issues, Discussion &amp; PKGBUILD Requests</option> </optgroup> <optgroup label="Contributions &amp; Discussion"> <option value="20">GNU/Linux Discussion</option> <option value="27">Community Contributions</option> <option value="33">Programming &amp; Scripting</option> <option value="30">Other Languages</option> <option value="47">Artwork and Screenshots</option> <option value="42">Try This</option> </optgroup> <optgroup label="/dev/null"> <option value="29">Off-Topic</option> <option value="48" selected="selected">Topics Going Nowhere</option> <option value="36">Dustbin</option> </optgroup> </select></label> <input type="submit" value=" Go " accesskey="g" /> </div> </form> </div> <div class="conr"> <p id="feedlinks"><span class="atom"><a href="extern.php?action=feed&amp;tid=162768&amp;type=atom">Atom topic feed</a></span></p> <p id="poweredby">Powered by <a href="http://fluxbb.org/">FluxBB</a></p> </div> <div class="clearer"></div> </div> </div> </div> </div> <div class="end-box"></div> </div> </body> </html>
