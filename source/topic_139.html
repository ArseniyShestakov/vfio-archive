<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"> <html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en" dir="ltr"> <head> <meta http-equiv="Content-Type" content="text/html; charset=utf-8" /> <title>KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9 (Page 139) / Topics Going Nowhere / Arch Linux Forums</title> <link rel="stylesheet" type="text/css" href="style/ArchLinux.css" /> <link rel="canonical" href="viewtopic.php?id=162768&amp;p=139" title="Page 139" /> <link rel="prev" href="viewtopic.php?id=162768&amp;p=138" title="Page 138" /> <link rel="next" href="viewtopic.php?id=162768&amp;p=140" title="Page 140" /> <link rel="alternate" type="application/atom+xml" href="extern.php?action=feed&amp;tid=162768&amp;type=atom" title="Atom topic feed" /> <link rel="stylesheet" media="screen" href="style/ArchLinux/arch.css?v=3" /> <link rel="stylesheet" media="screen" href="style/ArchLinux/archnavbar.css?v=2" /> <link rel="shortcut icon" href="style/ArchLinux/favicon.ico" /> </head> <body> <div id="archnavbar" class="anb-forum"> <div id="archnavbarlogo"><h1><a href="http://www.archlinux.org/">Arch Linux</a></h1></div> <div id="archnavbarmenu"> <ul id="archnavbarlist"> <li id="anb-home"><a href="http://www.archlinux.org/">Home</a></li><li id="anb-packages"><a href="http://www.archlinux.org/packages/">Packages</a></li><li id="anb-forums" class="anb-selected"><a href="https://bbs.archlinux.org/">Forums</a></li><li id="anb-wiki"><a href="https://wiki.archlinux.org/">Wiki</a></li><li id="anb-bugs"><a href="https://bugs.archlinux.org/">Bugs</a></li><li id="anb-aur"><a href="https://aur.archlinux.org/">AUR</a></li><li id="anb-download"><a href="http://www.archlinux.org/download/">Download</a></li> </ul> </div> </div> <div id="punviewtopic" class="pun"> <div class="top-box"></div> <div class="punwrap"> <div id="brdheader" class="block"> <div class="box"> <div id="brdmenu" class="inbox"> <ul> <li id="navindex" class="isactive"><a href="index.php">Index</a></li> <li id="navuserlist"><a href="userlist.php">User list</a></li> <li id="navsearch"><a href="search.php">Search</a></li> <li id="navprofile"><a href="profile.php?id=80749">Profile</a></li> <li id="navlogout"><a href="login.php?action=out&amp;id=80749&amp;csrf_token=5c20501ec397bb45ef8ee8c84db232c8d8e421c6">Logout</a></li> </ul> </div> <div id="brdwelcome" class="inbox"> <ul class="conl"> <li><span>Logged in as <strong>SXX</strong></span></li> <li><span>Last visit: 2015-08-16 12:20:09</span></li> </ul> <ul class="conr"> <li><span>Topics: <a href="search.php?action=show_replies" title="Find topics you have posted to.">Posted</a> | <a href="search.php?action=show_new" title="Find topics with new posts since your last visit.">New</a> | <a href="search.php?action=show_recent" title="Find topics with recent posts.">Active</a> | <a href="search.php?action=show_unanswered" title="Find topics with no replies.">Unanswered</a></span></li> </ul> <div class="clearer"></div> </div> </div> </div> <div id="brdmain"> <div class="linkst"> <div class="inbox crumbsplus"> <ul class="crumbs"> <li><a href="index.php">Index</a></li> <li><span>»&#160;</span><a href="viewforum.php?id=48">Topics Going Nowhere</a></li> <li><span>»&#160;</span><strong><a href="viewtopic.php?id=162768">KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</a></strong></li> </ul> <div class="pagepost"> <p class="pagelink conl"><span class="pages-label">Pages: </span><a rel="prev" class="item1" href="viewtopic.php?id=162768&amp;p=138">Previous</a> <a href="viewtopic.php?id=162768">1</a> <span class="spacer">…</span> <a href="viewtopic.php?id=162768&amp;p=137">137</a> <a href="viewtopic.php?id=162768&amp;p=138">138</a> <strong>139</strong> <a href="viewtopic.php?id=162768&amp;p=140">140</a> <a href="viewtopic.php?id=162768&amp;p=141">141</a> <span class="spacer">…</span> <a href="viewtopic.php?id=162768&amp;p=234">234</a> <a rel="next" href="viewtopic.php?id=162768&amp;p=140">Next</a></p> <p class="postlink conr">Topic closed</p> </div> <div class="clearer"></div> </div> </div> <div id="p1479539" class="blockpost rowodd blockpost1"> <h2><span><span class="conr">#3451</span> <a href="viewtopic.php?pid=1479539#p1479539">2014-11-26 20:01:34</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=71471">dRaiser</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>From: Poland</span></dd> <dd><span>Registered: 2013-05-20</span></dd> <dd><span>Posts: 49</span></dd> <dd class="usercontacts"><span class="email"><a href="mailto:pw@draiser.net">Email</a></span> <span class="website"><a href="http://draiser.net/en" rel="nofollow">Website</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>aw wrote:</cite><blockquote><div><p>vCPUs are threads and by default are handled the same as any other thread on the host, scheduling on available physical CPUs.&#160; You can pin them to help out the scheduler and improve cache locality.&#160; You also need to realize that there are additional threads that run in the host for I/O, so if you have a 1:1 mapping of vCPU to pCPUs and don&#039;t have extra resources for the additional threads, then that time will get stolen from the vCPUs.&#160; It&#039;s therefore often advisable to not fully consume the available host CPUs.&#160; cgroups can be used to attempt to further isolate where processes can run and what can run on the same pCPUs as your guest.&#160; There&#039;s also always some overhead to virtualization, so you&#039;re never going to get 100% of native performance.</p></div></blockquote></div><p>Thank you. I&#039;m thinking now what would be best way for eg. Windows guest games which can effectively use more then 2 cores - to give them 2-3 cores dedicated for VM or give 4 not doing anything other on host. I know there&#039;s always some overhead, but in this combination I&#039;d like that Windows and games&#160; would work at their best since that games could perhaps work better when have many cores.</p> <p class="postedit"><em>Last edited by dRaiser (2014-11-26 20:34:10)</em></p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1479539">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1479553" class="blockpost roweven"> <h2><span><span class="conr">#3452</span> <a href="viewtopic.php?pid=1479553#p1479553">2014-11-26 20:20:18</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=86302">4kGamer</a></strong></dt> <dd class="usertitle"><strong>Banned</strong></dd> <dd><span>Registered: 2014-10-29</span></dd> <dd><span>Posts: 82</span></dd> <dd class="usercontacts"><span class="email"><a href="mailto:oktayaslantas@gmx.de">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <p>I just tried the command: <strong>/sbin/lsmod | grep virtio</strong> to check whether the virtio_net driver is being used, but it&#039;s empty? Network is working though ...</p><p>then I had a look into <strong>/var/log/libvirt/qemu/vm1.log</strong> and I found this:</p><br /><div class="quotebox"><blockquote><div><p>2014-11-26 20:53:04.784+0000: starting up<br />LC_ALL=C PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin QEMU_AUDIO_DRV=none /usr/sbin/qemu-system-x86_64 -name vm1 -S -machine pc-i440fx-2.2,accel=k$<br />Domain id=2 is tainted: host-cpu</p></div></blockquote></div><p>I have to say I haven&#039;t been happy with CPU performance. Whenever I do anything - like just opening the file Explorer it CPU usage jumps to 40 %.</p><p>So basically there are two issues here:</p><p>1. It looks like I am NOT using the the virtio_net driver <br />2. Something weird is going on with my CPU</p><br /><br /><p>@aw or anyone who can help me, do you know why I get that log output?</p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1479553">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1479559" class="blockpost rowodd"> <h2><span><span class="conr">#3453</span> <a href="viewtopic.php?pid=1479559#p1479559">2014-11-26 20:26:34</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=75590">aw</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2013-10-04</span></dd> <dd><span>Posts: 921</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=75590">Email</a></span> <span class="website"><a href="http://vfio.blogspot.com/" rel="nofollow">Website</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>4kGamer wrote:</cite><blockquote><div><p>I just tried the command: <strong>/sbin/lsmod | grep virtio</strong> to check whether the virtio_net driver is being used, but it&#039;s empty? Network is working though ...</p></div></blockquote></div><p>You ran this in the host?&#160; The guest is the one that needs this driver, the host doesn&#039;t load it.</p><div class="quotebox"><blockquote><div><p>then I had a look into <strong>/var/log/libvirt/qemu/vm1.log</strong> and I found this:</p><br /><div class="codebox"><pre><code>2014-11-26 20:53:04.784+0000: starting up LC_ALL=C PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin QEMU_AUDIO_DRV=none /usr/sbin/qemu-system-x86_64 -name vm1 -S -machine pc-i440fx-2.2,accel=k$ Domain id=2 is tainted: host-cpu</code></pre></div></div></blockquote></div><p>I don&#039;t see what problem you&#039;re pointing out here.&#160; libvirt taints configurations using <em>-cpu host</em> because it can&#039;t migrate them.&#160; Do you care?</p><div class="quotebox"><blockquote><div><p>I have to say I haven&#039;t been happy with CPU performance. Whenever I do anything - like just opening the file Explorer it CPU usage jumps to 40 %.</p><p>So basically there are two issues here:</p><p>1. It looks like I am NOT using the the virtio_net driver <br />2. Something weird is going on with my CPU</p><p>@aw or anyone who can help me, do you know why I get that log output?</p></div></blockquote></div><p>I don&#039;t see that you&#039;re actually reporting any problems.&#160; What should the CPU usage go to when you open the file explorer?&#160; Are you using virtio for both the network and the disk?</p> </div> <div class="postsignature postmsg"><hr /><p><a href="http://vfio.blogspot.com" rel="nofollow">http://vfio.blogspot.com</a><br />Looking for a more open forum to discuss vfio related uses?&#160; Try <a href="https://www.redhat.com/mailman/listinfo/vfio-users" rel="nofollow">https://www.redhat.com/mailman/listinfo/vfio-users</a></p></div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1479559">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1479567" class="blockpost roweven"> <h2><span><span class="conr">#3454</span> <a href="viewtopic.php?pid=1479567#p1479567">2014-11-26 20:45:55</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=86302">4kGamer</a></strong></dt> <dd class="usertitle"><strong>Banned</strong></dd> <dd><span>Registered: 2014-10-29</span></dd> <dd><span>Posts: 82</span></dd> <dd class="usercontacts"><span class="email"><a href="mailto:oktayaslantas@gmx.de">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <p>ah, I see. So that output is expected behaviour. </p><p>Yes I am using virtio for disk and as of today also for network. According to <a href="http://wiki.libvirt.org/page/Virtio" rel="nofollow">http://wiki.libvirt.org/page/Virtio</a> it should produce an output once the guest has loaded. That&#039;s why I was confused. ...</p><p>About the high CPU usage: whenever I load a game (even something just like Fifa 15, I have 100 % CPU usage once the game starts. That seems a tad too high?</p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1479567">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1479569" class="blockpost rowodd"> <h2><span><span class="conr">#3455</span> <a href="viewtopic.php?pid=1479569#p1479569">2014-11-26 20:52:52</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=75590">aw</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2013-10-04</span></dd> <dd><span>Posts: 921</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=75590">Email</a></span> <span class="website"><a href="http://vfio.blogspot.com/" rel="nofollow">Website</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>4kGamer wrote:</cite><blockquote><div><p>ah, I see. So that output is expected behaviour. </p><p>Yes I am using virtio for disk and as of today also for network. According to <a href="http://wiki.libvirt.org/page/Virtio" rel="nofollow">http://wiki.libvirt.org/page/Virtio</a> it should produce an output once the guest has loaded. That&#039;s why I was confused. ...</p></div></blockquote></div><p>From that source...</p><div class="quotebox"><blockquote><div><p>When you boot the guest (virsh start guestname), if it worked you should still have a working network, and you should see (<strong>from inside the guest</strong>) that you are using the virtio_net driver:</p><div class="codebox"><pre><code># /sbin/lsmod | grep virtio [shows virtio_pci, virtio_net and others loaded] # cat /sys/devices/virtio-pci/0/net/eth0/statistics/rx_bytes ...</code></pre></div></div></blockquote></div><div class="quotebox"><blockquote><div><p>About the high CPU usage: whenever I load a game (even something just like Fifa 15, I have 100 % CPU usage once the game starts. That seems a tad too high?</p></div></blockquote></div><p>Why?&#160; Moving data costs CPU.&#160; Games typically move a lot of data on startup.&#160; What are you using to back the disk image?&#160; If you want performance you want either a non-sparse raw file, LVM volume, or physical block device behind it.&#160; If you&#039;re using something like qcow2, you have to realize that there&#039;s a speed vs space trade-off in doing that.</p> <p class="postedit"><em>Last edited by aw (2014-11-26 20:55:08)</em></p> </div> <div class="postsignature postmsg"><hr /><p><a href="http://vfio.blogspot.com" rel="nofollow">http://vfio.blogspot.com</a><br />Looking for a more open forum to discuss vfio related uses?&#160; Try <a href="https://www.redhat.com/mailman/listinfo/vfio-users" rel="nofollow">https://www.redhat.com/mailman/listinfo/vfio-users</a></p></div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1479569">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1479570" class="blockpost roweven"> <h2><span><span class="conr">#3456</span> <a href="viewtopic.php?pid=1479570#p1479570">2014-11-26 20:59:14</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=86302">4kGamer</a></strong></dt> <dd class="usertitle"><strong>Banned</strong></dd> <dd><span>Registered: 2014-10-29</span></dd> <dd><span>Posts: 82</span></dd> <dd class="usercontacts"><span class="email"><a href="mailto:oktayaslantas@gmx.de">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <p>yes, that&#039;s why I am using LVM. I have created a 180 GB partition from my 240 GB SSD for Windows 8.1. The other 40 GB are for arch.</p><p>I definitely prefer performance. Isn&#039;t LVM the best option? It used to with Xen.</p> <p class="postedit"><em>Last edited by 4kGamer (2014-11-26 21:01:49)</em></p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1479570">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1479576" class="blockpost rowodd"> <h2><span><span class="conr">#3457</span> <a href="viewtopic.php?pid=1479576#p1479576">2014-11-26 21:16:35</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=75590">aw</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2013-10-04</span></dd> <dd><span>Posts: 921</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=75590">Email</a></span> <span class="website"><a href="http://vfio.blogspot.com/" rel="nofollow">Website</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>4kGamer wrote:</cite><blockquote><div><p>yes, that&#039;s why I am using LVM. I have created a 180 GB partition from my 240 GB SSD for Windows 8.1. The other 40 GB are for arch.</p><p>I definitely prefer performance. Isn&#039;t LVM the best option? It used to with Xen.</p></div></blockquote></div><p>A direct block device, like a partition is probably best, but LVM is nearly as good.</p><p>You can try some of the block tuning techniques from the <a href="https://access.redhat.com/documentation/en-US/Red_Hat_Enterprise_Linux/7/html-single/Virtualization_Tuning_and_Optimization_Guide/index.html#chap-Virtualization_Tuning_Optimization_Guide-BlockIO" rel="nofollow">Red Hat Virtualization Tuning and Optimization Guide</a></p> </div> <div class="postsignature postmsg"><hr /><p><a href="http://vfio.blogspot.com" rel="nofollow">http://vfio.blogspot.com</a><br />Looking for a more open forum to discuss vfio related uses?&#160; Try <a href="https://www.redhat.com/mailman/listinfo/vfio-users" rel="nofollow">https://www.redhat.com/mailman/listinfo/vfio-users</a></p></div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1479576">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1479578" class="blockpost roweven"> <h2><span><span class="conr">#3458</span> <a href="viewtopic.php?pid=1479578#p1479578">2014-11-26 21:25:28</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=86302">4kGamer</a></strong></dt> <dd class="usertitle"><strong>Banned</strong></dd> <dd><span>Registered: 2014-10-29</span></dd> <dd><span>Posts: 82</span></dd> <dd class="usercontacts"><span class="email"><a href="mailto:oktayaslantas@gmx.de">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <p>ok, thank you very much. I will try those suggestions. I will report once I get some significant improvements.</p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1479578">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1479596" class="blockpost rowodd"> <h2><span><span class="conr">#3459</span> <a href="viewtopic.php?pid=1479596#p1479596">2014-11-26 23:27:02</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=85963">Rommy</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2014-10-17</span></dd> <dd><span>Posts: 22</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=85963">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <p>Reboot is now working. I extracted the vga bios with GPU-Z and passed it to qemu with romfile=</p><p>I tried to get audio working, but I failed. -soundhw hda seams the only one which is recognized from Windows8 64bit, but i get scraching/stutter.<br />Somebody said, he got -soundhw ac97 working, he used the Win7 driver for ac97 and installed it in under Win8 under Win7 compatibility mode, did not work for me eiter, maybe somebody else gets lucky with it.</p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1479596">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1479597" class="blockpost roweven"> <h2><span><span class="conr">#3460</span> <a href="viewtopic.php?pid=1479597#p1479597">2014-11-26 23:27:43</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=81112">Krobar</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2014-04-12</span></dd> <dd><span>Posts: 17</span></dd> <dd class="usercontacts"><span class="email"><a href="mailto:rob@ledeng.demon.co.uk">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>aw wrote:</cite><blockquote><div><div class="quotebox"><cite>Denso wrote:</cite><blockquote><div><div class="quotebox"><cite>aw wrote:</cite><blockquote><div><p>Most of these seem completely unnecessary to me, especially the vfio options.&#160; APICv is already enabled by default when available, so that&#039;s a no-op.&#160; nested=1, why?&#160; You&#039;re not doing nesting.&#160; ignore_msrs=1 is the only thing I have set on my box.</p></div></blockquote></div><p>I know . There was a time when I completely commented out every line of those options and the VMs booted just fine . But they weren&#039;t stable after hours of operation . Plus , with them on , both of my VMs can boot fine at the same time (2 seperate GPUs , one to each VM) .</p></div></blockquote></div><p>I do this too, one AMD + one Nvidia.&#160; AFAIK, I only need ignore_msrs so that passmark performance test works</p><div class="quotebox"><blockquote><div><p>THe masking option is needed in my case , otherwise the whole VM goes into SloMo mode . <img src="https://bbs.archlinux.org/img/smilies/smile.png" width="15" height="15" alt="smile" /></p></div></blockquote></div><p>That&#039;s specific to a device you&#039;re assigning, not likely related to the chipset.&#160; The option overrides our detection of whether the device supports INTxDisable masking and instead masks the interrupt at the APIC instead of the device.&#160; The huge downside of that is that it requires the device has an exclusive interrupt because of the difference in where we mask the interrupt.&#160; Also note:</p><p>$ modinfo vfio-pci<br />...<br />parm:&#160; &#160; &#160; &#160; &#160; &#160;nointxmask:Disable support for PCI 2.3 style INTx masking.&#160; <strong>If this resolves problems for specific devices, report lspci -vvvxxx to linux-pci@vger.kernel.org so the device can be fixed automatically via the broken_intx_masking flag</strong>. (bool)</p><p>Have you done that?&#160; This option would apply automatically to just that device if you did...</p><div class="quotebox"><blockquote><div><p>I&#039;ll comment out the APICv + nested + shadow_vmcs + ept from now on though . I already commented out the disable_hugepages one for a month or so , no problem .</p><p>I didn&#039;t need any of these options when I was using Z77 .. X99 is more troublesome to setup . ALOT . And there is no way I can reboot any VM with GPU assigned to it without crashing the host <img src="https://bbs.archlinux.org/img/smilies/sad.png" width="15" height="15" alt="sad" /> It is the ONLY remaining issue I have now .</p><p>They reboot fine , until I install Nvidia&#039;s drivers and then they crash the host whenever I reboot them .</p></div></blockquote></div><p>Aside from the two Radeon reset issues (R7790 and similar can only be used once per boot and HD8570 and similar mistakenly report NoSoftRst-) I don&#039;t know of any other GPU reset issues, nor do I see why X99 would be more or less problematic than Z77 in that respect.</p><p>EDIT: Nvidia cards have pretty terrible DisableINTx support on the audio device (esp. Quadro and even fake Quadro), but the better option there is typically to make the guest driver use MSI, not to run with nointxmask</p></div></blockquote></div><p>I have a Linux VM (XBMCBuntu) with passed through GT620 which works well except for reboots cause it to fail completely. I believe it is something to do with the Nvidia card as I have other VMs passing through raid controller and Sat card with VFIO that can reboot fine.</p><p>Interrupts within the VM looks a bit odd (The passed through Intel VF uses MSI but the Geforce does not) and config is shown below. Can anyone help with what might be wrong or how I can collect needed debug information (Qemu log for the VM shows nothing other than on intial startup of the VM).</p><p>&lt;domain type=&#039;kvm&#039; xmlns:qemu=&#039;http://libvirt.org/schemas/domain/qemu/1.0&#039;&gt;<br />&#160; &lt;name&gt;XBMC&lt;/name&gt;<br />&#160; &lt;uuid&gt;f702c5eb-83d4-4b50-b909-8da878e08d36&lt;/uuid&gt;<br />&#160; &lt;memory unit=&#039;KiB&#039;&gt;1036288&lt;/memory&gt;<br />&#160; &lt;currentMemory unit=&#039;KiB&#039;&gt;1036288&lt;/currentMemory&gt;<br />&#160; &lt;vcpu placement=&#039;static&#039;&gt;2&lt;/vcpu&gt;<br />&#160; &lt;os&gt;<br />&#160; &#160; &lt;type arch=&#039;x86_64&#039; machine=&#039;q35&#039;&gt;hvm&lt;/type&gt;<br />&#160; &#160; &lt;loader&gt;/usr/share/qemu/bios.bin&lt;/loader&gt;<br />&#160; &#160; &lt;boot dev=&#039;hd&#039;/&gt;<br />&#160; &#160; &lt;bootmenu enable=&#039;yes&#039;/&gt;<br />&#160; &lt;/os&gt;<br />&#160; &lt;features&gt;<br />&#160; &#160; &lt;acpi/&gt;<br />&#160; &lt;/features&gt;<br />&#160; &lt;clock offset=&#039;localtime&#039;/&gt;<br />&#160; &lt;on_poweroff&gt;destroy&lt;/on_poweroff&gt;<br />&#160; &lt;on_reboot&gt;restart&lt;/on_reboot&gt;<br />&#160; &lt;on_crash&gt;destroy&lt;/on_crash&gt;<br />&#160; &lt;devices&gt;<br />&#160; &#160; &lt;emulator&gt;/usr/bin/qemu-system-x86_64&lt;/emulator&gt;<br />&#160; &#160; &lt;disk type=&#039;file&#039; device=&#039;disk&#039;&gt;<br />&#160; &#160; &#160; &lt;driver name=&#039;qemu&#039; type=&#039;raw&#039;/&gt;<br />&#160; &#160; &#160; &lt;source file=&#039;/home/VM/XBMC.img&#039;/&gt;<br />&#160; &#160; &#160; &lt;target dev=&#039;sda&#039; bus=&#039;sata&#039;/&gt;<br />&#160; &#160; &lt;/disk&gt;<br />&#160; &#160; &lt;disk type=&#039;file&#039; device=&#039;cdrom&#039;&gt;<br />&#160; &#160; &#160; &lt;driver name=&#039;qemu&#039; type=&#039;raw&#039;/&gt;<br />&#160; &#160; &#160; &lt;source file=&#039;/home/ISO/XBMC13.iso&#039;/&gt;<br />&#160; &#160; &#160; &lt;target dev=&#039;sdb&#039; bus=&#039;sata&#039;/&gt;<br />&#160; &#160; &#160; &lt;readonly/&gt;<br />&#160; &#160; &lt;/disk&gt;<br />&#160; &#160; &lt;controller type=&#039;sata&#039; index=&#039;0&#039;&gt;<br />&#160; &#160; &#160; &lt;address type=&#039;pci&#039; domain=&#039;0x0000&#039; bus=&#039;0x00&#039; slot=&#039;0x1f&#039; function=&#039;0x2&#039;/&gt;<br />&#160; &#160; &lt;/controller&gt;<br />&#160; &#160; &lt;controller type=&#039;pci&#039; index=&#039;0&#039; model=&#039;pcie-root&#039;/&gt;<br />&#160; &#160; &lt;controller type=&#039;pci&#039; index=&#039;1&#039; model=&#039;dmi-to-pci-bridge&#039;&gt;<br />&#160; &#160; &#160; &lt;address type=&#039;pci&#039; domain=&#039;0x0000&#039; bus=&#039;0x00&#039; slot=&#039;0x1e&#039; function=&#039;0x0&#039;/&gt;<br />&#160; &#160; &lt;/controller&gt;<br />&#160; &#160; &lt;controller type=&#039;pci&#039; index=&#039;2&#039; model=&#039;pci-bridge&#039;&gt;<br />&#160; &#160; &#160; &lt;address type=&#039;pci&#039; domain=&#039;0x0000&#039; bus=&#039;0x01&#039; slot=&#039;0x01&#039; function=&#039;0x0&#039;/&gt;<br />&#160; &#160; &lt;/controller&gt;<br />&lt;controller type=&#039;usb&#039; index=&#039;0&#039; /&gt;<br />&lt;hostdev mode=&#039;subsystem&#039; type=&#039;usb&#039;&gt;<br />&#160; &#160; &#160; &lt;source&gt;<br />&#160; &#160; &#160; &#160; &lt;vendor id=&#039;0x413c&#039;/&gt;<br />&#160; &#160; &#160; &#160; &lt;product id=&#039;0x2106&#039;/&gt;<br />&#160; &#160; &#160; &lt;/source&gt;<br />&#160; &#160; &lt;/hostdev&gt;<br />&#160; &lt;/devices&gt;<br />&#160; &lt;qemu:commandline&gt;<br />&#160; &#160; &lt;qemu:arg value=&#039;-device&#039;/&gt;<br />&#160; &#160; &lt;qemu:arg value=&#039;ioh3420,bus=pcie.0,addr=1c.0,multifunction=on,port=1,chassis=1,id=root.1&#039;/&gt;<br />&#160; &#160; &lt;qemu:arg value=&#039;-device&#039;/&gt;<br />&#160; &#160; &lt;qemu:arg value=&#039;vfio-pci,host=09:10.2,bus=pcie.0&#039;/&gt;<br />&#160; &#160; &lt;qemu:arg value=&#039;-device&#039;/&gt;<br />&#160; &#160; &lt;qemu:arg value=&#039;vfio-pci,host=0a:00.0,bus=root.1,addr=00.0,multifunction=on,x-vga=on&#039;/&gt;<br />&#160; &#160; &lt;qemu:arg value=&#039;-device&#039;/&gt;<br />&#160; &#160; &lt;qemu:arg value=&#039;vfio-pci,host=0a:00.1,bus=root.1,addr=00.1&#039;/&gt;<br />&#160; &lt;/qemu:commandline&gt;<br />&lt;/domain&gt;</p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1479597">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1479672" class="blockpost rowodd"> <h2><span><span class="conr">#3461</span> <a href="viewtopic.php?pid=1479672#p1479672">2014-11-27 08:28:19</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=85266">kevinxucs</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2014-09-21</span></dd> <dd><span>Posts: 2</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=85266">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <p>Just got an NVIDIA Geforce GTX 970 working using vfio-pci.</p><p>Initially, when I was using SeaBios (1.7.5 from Debian), it doesn&#039;t seem to have any output. After I switched to using EFI boot (following tutorial <a href="http://vfio.blogspot.com/2014/09/ovmf-split-image-support.html" rel="nofollow">here</a>), my 970 works perfectly fine.</p><p>Also, kvm=off still works with 970 and the latest driver 344.75 (for resolving code 43 issue with NVIDIA&#039;s driver).</p> <p class="postedit"><em>Last edited by kevinxucs (2014-11-27 08:33:23)</em></p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1479672">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1479676" class="blockpost roweven"> <h2><span><span class="conr">#3462</span> <a href="viewtopic.php?pid=1479676#p1479676">2014-11-27 09:33:36</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=48315">TripleSpeeder</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2011-05-02</span></dd> <dd><span>Posts: 43</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=48315">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <p>Regarding OVMF/UEFI: I heard rumors that this also works with Windows7. Can anybody here confirm that a Windows 7 VM is working with OVMF?</p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1479676">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1479681" class="blockpost rowodd"> <h2><span><span class="conr">#3463</span> <a href="viewtopic.php?pid=1479681#p1479681">2014-11-27 09:47:46</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=71471">dRaiser</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>From: Poland</span></dd> <dd><span>Registered: 2013-05-20</span></dd> <dd><span>Posts: 49</span></dd> <dd class="usercontacts"><span class="email"><a href="mailto:pw@draiser.net">Email</a></span> <span class="website"><a href="http://draiser.net/en" rel="nofollow">Website</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <p>Hi again. Anyone has solution for suspend/hibernation problem (both fail - suspend sometimes, hibernation always) with kernel from OP and Nvidia-340xx-dkms drivers?</p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1479681">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1479694" class="blockpost roweven"> <h2><span><span class="conr">#3464</span> <a href="viewtopic.php?pid=1479694#p1479694">2014-11-27 11:27:36</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=80387">dwe11er</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2014-03-18</span></dd> <dd><span>Posts: 73</span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>dRaiser wrote:</cite><blockquote><div><p>Hi again. Anyone has solution for suspend/hibernation problem (both fail - suspend sometimes, hibernation always) with kernel from OP and Nvidia-340xx-dkms drivers?</p></div></blockquote></div><p>I think this is overall problem of NVIDIA cards, not kernel in particular. At least I had such problems.</p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1479694">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1479698" class="blockpost rowodd"> <h2><span><span class="conr">#3465</span> <a href="viewtopic.php?pid=1479698#p1479698">2014-11-27 11:59:38</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=71471">dRaiser</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>From: Poland</span></dd> <dd><span>Registered: 2013-05-20</span></dd> <dd><span>Posts: 49</span></dd> <dd class="usercontacts"><span class="email"><a href="mailto:pw@draiser.net">Email</a></span> <span class="website"><a href="http://draiser.net/en" rel="nofollow">Website</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <p>Well I haven&#039;t had this problem for a long time when using standard Arch kernel. <img src="https://bbs.archlinux.org/img/smilies/smile.png" width="15" height="15" alt="smile" /></p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1479698">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1479725" class="blockpost roweven"> <h2><span><span class="conr">#3466</span> <a href="viewtopic.php?pid=1479725#p1479725">2014-11-27 14:00:17</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=85314">Duelist</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2014-09-22</span></dd> <dd><span>Posts: 358</span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>TripleSpeeder wrote:</cite><blockquote><div><p>Regarding OVMF/UEFI: I heard rumors that this also works with Windows7. Can anybody here confirm that a Windows 7 VM is working with OVMF?</p></div></blockquote></div><p>Well, i can confirm that. Windows 7 supports UEFI, but you need a somewhat special way to install it(obviously, the cd should have something like .EFI loader file). Mine installation ISO supported that. But i won&#039;t provide it to you because i&#039;m a filthy pirate and should be punished for using windows.<br />I&#039;ve got to install and boot it, but i couldn&#039;t get vfio/pci passthrough working because, well, my asus GPUs needed to be physically flashed - i couldn&#039;t boot myself with romfile= pointing to my card&#039;s UEFI-compatible VBIOS update. So YMMV. Also, there is GPT support if you&#039;re curious.</p> </div> <div class="postsignature postmsg"><hr /><p><span class="bbs">The forum rules prohibit requesting support for distributions other than arch.</span><br /><a href="https://bbs.archlinux.org/viewtopic.php?pid=1551460#p1551460" rel="nofollow">I gave up.</a><a href="https://bbs.archlinux.org/viewtopic.php?id=162768" rel="nofollow"> It was too late.</a><br /><a href="http://pastebin.com/B3fL84bq" rel="nofollow">What I was trying to do</a>.<br /><a href="http://vfio.blogspot.com/" rel="nofollow">The reference about VFIO and KVM VGA passthrough.</a></p></div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1479725">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1479726" class="blockpost rowodd"> <h2><span><span class="conr">#3467</span> <a href="viewtopic.php?pid=1479726#p1479726">2014-11-27 14:01:47</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=85314">Duelist</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2014-09-22</span></dd> <dd><span>Posts: 358</span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>aw wrote:</cite><blockquote><div><p><a href="https://access.redhat.com/documentation/en-US/Red_Hat_Enterprise_Linux/7/html-single/Virtualization_Tuning_and_Optimization_Guide/index.html#chap-Virtualization_Tuning_Optimization_Guide-BlockIO" rel="nofollow">Red Hat Virtualization Tuning and Optimization Guide</a></p></div></blockquote></div><p>Gotta love redhat for that document. Pure awesome.</p> <p class="postedit"><em>Last edited by Duelist (2014-11-27 14:02:17)</em></p> </div> <div class="postsignature postmsg"><hr /><p><span class="bbs">The forum rules prohibit requesting support for distributions other than arch.</span><br /><a href="https://bbs.archlinux.org/viewtopic.php?pid=1551460#p1551460" rel="nofollow">I gave up.</a><a href="https://bbs.archlinux.org/viewtopic.php?id=162768" rel="nofollow"> It was too late.</a><br /><a href="http://pastebin.com/B3fL84bq" rel="nofollow">What I was trying to do</a>.<br /><a href="http://vfio.blogspot.com/" rel="nofollow">The reference about VFIO and KVM VGA passthrough.</a></p></div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1479726">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1479773" class="blockpost roweven"> <h2><span><span class="conr">#3468</span> <a href="viewtopic.php?pid=1479773#p1479773">2014-11-27 16:42:09</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=67633">wikavalier</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2013-01-22</span></dd> <dd><span>Posts: 13</span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <p>Hi all,</p><p>First of all, thank you a lot for the post. It is awesome and really well documented. 10/10.</p><p>Even me, with my rudimentary linux skills, I was able to make the passthrough to the KVM, after facing all kind of issues. Yes, I had all of them!.</p><p>- My box is a:<br />intel i7 <br />gigabyte mobo<br />nvidia gtx780<br />and the damn: <br />06:00.0 SATA controller: Marvell Technology Group Ltd. 88SE9230 PCIe SATA 6Gb/s Controller (rev 10)</p><p>- I am running:<br />Linux nexus2 3.17.2-1-mainline #1 SMP PREEMPT Mon Nov 24 17:50:40 CET 2014 x86_64 GNU/Linux</p><p>And when I activate intel_iommu=on, the raid6 which is partly held by the pcie-SATA marvell controller, stops working. So I have to decide whether I want vfio or my raid storage</p><p>I dive a little bit, and I found that the hardware-monster (compliment here!) known as Alex Williamson (AKA aw) has also a patch for my problem here:<br /><a href="https://github.com/awilliam/linux-vfio/tree/dma-alias-v4" rel="nofollow">https://github.com/awilliam/linux-vfio/ … a-alias-v4</a></p><p>I cloned the git but I downloaded again a new kernel. But with my poor debugging skills, I cant tell if that fork will include the patches from nbhs and the fear of starting over again is killing me. Step by step checking everything.</p><p>Yeah, I have read about the help-vampire. But, after my duly apologizes, can anyone be so kind to tell me how to apply the dma-alias to the modified kernel of nbhs? For dummies, if i can abuse.</p><p>Thanks in advance,</p><br /><p>EDIT, if this can be interesting to anyone, below you may see the steps that I took to make it work. It is been a pain!</p><div class="codebox"><pre class="vscroll"><code>https://bbs.archlinux.org/viewtopic.php?id=162768 http://www.firewing1.com/howtos/fedora-20/create-gaming-virtual-machine-using-vfio-pci-passthrough-kvm asume a fresh arch install copy linux-mainline tar xzf linux-mainline-3.17.2.tar.gz cd linux-mainline* makepkg -s --asroot (option 15 haswell) (esc esc to exit) (2hours) pacman -U linux-mainline-* lspci: 00:1b.0 Audio device: Intel Corporation 9 Series Chipset Family HD Audio Controller 01:00.0 VGA compatible controller: NVIDIA Corporation GK110B [GeForce GTX 780 Ti] (rev a1) 01:00.1 Audio device: NVIDIA Corporation GK110 HDMI Audio (rev a1) lspci -n 00:1b.0 0403: 8086:8ca0 &lt;--- AUDIO mobo to be pci_stub 01:00.0 0300: 10de:100a (rev a1) &lt;-- NVIDIA graphics to be pci_stub 01:00.1 0403: 10de:0e1a (rev a1) &lt;--- NVIDIA audio to be pci_stub nano /etc/default/grub GRUB_CMDLINE_LINUX=&quot;pci-stub.ids=8086:8ca0,10de:100a,10de:0e1a i915.enable_hd_vgaarb=1 intel_iommu=on pcie_acs_override=downstream&quot; grub-mkconfig -o /boot/grub/grub.cfg nano /etc/mkinitcpio.conf MODULES=&quot;i915 pci-stub vfio-pci&quot; mkinitcpio -p linux-mainline lsusb Bus 001 Device 005: ID 0738:1713 Mad Catz, Inc. Bus 001 Device 002: ID 03f0:0324 Hewlett-Packard SK-2885 keyboard Bus 001 Device 007: ID 0781:5571 SanDisk Corp. Cruzer Fit pacman -S mesa-libgl qemu seabios echo &quot;options vfio_iommu_type1 allow_unsafe_interrupts=1&quot; &gt; /etc/modprobe.d/vfio_iommu_type1.conf echo &quot;options kvm ignore_msrs=1&quot; &gt;&gt; /etc/modprobe.d/kvm.conf nano /usr/bin/vfio-bind #!/bin/bash modprobe vfio-pci for dev in &quot;$@&quot;; do vendor=$(cat /sys/bus/pci/devices/$dev/vendor) device=$(cat /sys/bus/pci/devices/$dev/device) if [ -e /sys/bus/pci/devices/$dev/driver ]; then echo $dev &gt; /sys/bus/pci/devices/$dev/driver/unbind fi echo $vendor $device &gt; /sys/bus/pci/drivers/vfio-pci/new_id done chmod +x /usr/bin/vfio-bind nano /etc/systemd/system/vfio-bind.service [Unit] Description=Binds devices to vfio-pci After=syslog.target [Service] EnvironmentFile=-/etc/vfio-pci.cfg Type=oneshot RemainAfterExit=yes ExecStart=-/usr/bin/vfio-bind $DEVICES [Install] WantedBy=multi-user.target nano /etc/vfio-pci.cfg DEVICES=&quot;0000:00:1b.0 0000:01:00.0 0000:01:00.1&quot; debug vfio-bind 0000:00:1b.0 0000:01:00.0 0000:01:00.1 ls -l /sys/bus/pci/drivers/vfio-pci/ find /sys/kernel/iommu_groups/ -type l dmesg | grep -e DMAR -e IOMMU launch VM vifo #detach usb echo 0 &gt; /sys/bus/usb/devices/1-2/authorized echo 0 &gt; /sys/bus/usb/devices/1-5/authorized echo 0 &gt; /sys/bus/usb/devices/1-7/authorized # bind the graphics, sound and mobo sound to vfio vfio-bind 0000:00:1b.0 0000:01:00.0 0000:01:00.1 #allow unsafe remapping modprobe vfio_iommu_type1 modprobe kvm #-M q35 is the emulated chipset # smp how many cpus will be shown #load emulated bios and set no emulated cirrus card #create a pcie root port to attach the gpu called root.1 #attach the nvidia card to root.1 #attach the mobo soundcard to pcie.0 #use a phisical partition attach to q35 (ide.0) #passthrough usbs qemu-system-x86_64 -enable-kvm -M q35 -m 8024 -cpu host \ -smp 6,sockets=1,cores=3,threads=2 \ -bios /usr/share/qemu/bios.bin -vga none \ -device ioh3420,bus=pcie.0,addr=1c.0,multifunction=on,port=1,chassis=1,id=root.1 \ -device vfio-pci,host=01:00.0,bus=root.1,addr=00.0,multifunction=on,x-vga=on \ -device vfio-pci,host=01:00.1,bus=root.1,addr=00.1 \ -device vfio-pci,host=00:1b.0,bus=pcie.0,addr=1b.0 \ -drive file=/dev/sda4,id=disk,format=raw -device ide-hd,bus=ide.0,drive=disk \ -drive file=/home/test/windowsos.iso,id=isocd -device ide-cd,bus=ide.1,drive=isocd \ -usb -usbdevice host:03f0:0324 -usbdevice host:0738:1713 \ -nographic</code></pre></div><br /><p>EDIT 2,</p><p>I found that appending a .patch at the end of the url i can download the branch as a patch. Then i edited the PKGBUILD and update the signature with updpkgsums. Sadly it doesnt work... it doesnt compile</p><p>I also tried the v4.1 which seems to be the new way to do so, using devfn. It also explicitly uses the vendor ID of my sata controller (9230) But i cant find it in github. And when i try to copy/paste from the mail list, it doesnt work:</p><div class="codebox"><pre><code>patching file drivers/pci/quirks.c patch: 1.sh topic_100.html topic_101.html topic_102.html topic_103.html topic_104.html topic_105.html topic_106.html topic_107.html topic_108.html topic_109.html topic_10.html topic_110.html topic_111.html topic_112.html topic_113.html topic_114.html topic_115.html topic_116.html topic_117.html topic_118.html topic_119.html topic_11.html topic_120.html topic_121.html topic_122.html topic_123.html topic_124.html topic_125.html topic_126.html topic_127.html topic_128.html topic_129.html topic_12.html topic_130.html topic_131.html topic_132.html topic_133.html topic_134.html topic_135.html topic_136.html topic_137.html topic_138.html topic_13.html topic_14.html topic_15.html topic_16.html topic_17.html topic_18.html topic_19.html topic_1.html topic_20.html topic_21.html topic_22.html topic_23.html topic_24.html topic_25.html topic_26.html topic_27.html topic_28.html topic_29.html topic_2.html topic_30.html topic_31.html topic_32.html topic_33.html topic_34.html topic_35.html topic_36.html topic_37.html topic_38.html topic_39.html topic_3.html topic_40.html topic_41.html topic_42.html topic_43.html topic_44.html topic_45.html topic_46.html topic_47.html topic_48.html topic_49.html topic_4.html topic_50.html topic_51.html topic_52.html topic_53.html topic_54.html topic_55.html topic_56.html topic_57.html topic_58.html topic_59.html topic_5.html topic_60.html topic_61.html topic_62.html topic_63.html topic_64.html topic_65.html topic_66.html topic_67.html topic_68.html topic_69.html topic_6.html topic_70.html topic_71.html topic_72.html topic_73.html topic_74.html topic_75.html topic_76.html topic_77.html topic_78.html topic_79.html topic_7.html topic_80.html topic_81.html topic_82.html topic_83.html topic_84.html topic_85.html topic_86.html topic_87.html topic_88.html topic_89.html topic_8.html topic_90.html topic_91.html topic_92.html topic_93.html topic_94.html topic_95.html topic_96.html topic_97.html topic_98.html topic_99.html topic_9.html malformed patch at line 16: DECLARE_PCI_FIXUP_HEADER(PCI_VENDOR_ID_RICOH, 0xe832, quirk_dma_func0_alias); ==&gt; ERROR: A failure occurred in prepare(). Aborting...</code></pre></div><p>EDIT 3,<br />I used this as a patch<br /><a href="http://www.jarzebski.pl/files/patch/dma-alias-v4/v4-05-16-PCI-quirk-dma_alias_devfn-for-Marvell-devices.patch" rel="nofollow">http://www.jarzebski.pl/files/patch/dma … ices.patch</a></p><p>and after many trials and errors i ended up putting it as the last patch like this in the PKGBUILD</p><div class="codebox"><pre><code> # Extra GCC optimizations patch -p1 -i &quot;${srcdir}/enable_additional_cpu_optimizations_for_gcc_v4.9+_kernel_v3.15+.patch&quot; # patches Marvell sata patch -p1 -i &quot;${srcdir}/dma-alias-devfn.patch&quot;</code></pre></div><p>but after a good looking begining it end up like always</p><div class="codebox"><pre><code> CC drivers/pci/quirks.o drivers/pci/quirks.c:3535:13: error: redefinition of &#039;quirk_dma_func1_alias&#039; static void quirk_dma_func1_alias(struct pci_dev *dev) ^ drivers/pci/quirks.c:3470:13: note: previous definition of &#039;quirk_dma_func1_alias&#039; was here static void quirk_dma_func1_alias(struct pci_dev *dev) ^ scripts/Makefile.build:257: recipe for target &#039;drivers/pci/quirks.o&#039; failed make[2]: 1.sh topic_100.html topic_101.html topic_102.html topic_103.html topic_104.html topic_105.html topic_106.html topic_107.html topic_108.html topic_109.html topic_10.html topic_110.html topic_111.html topic_112.html topic_113.html topic_114.html topic_115.html topic_116.html topic_117.html topic_118.html topic_119.html topic_11.html topic_120.html topic_121.html topic_122.html topic_123.html topic_124.html topic_125.html topic_126.html topic_127.html topic_128.html topic_129.html topic_12.html topic_130.html topic_131.html topic_132.html topic_133.html topic_134.html topic_135.html topic_136.html topic_137.html topic_138.html topic_13.html topic_14.html topic_15.html topic_16.html topic_17.html topic_18.html topic_19.html topic_1.html topic_20.html topic_21.html topic_22.html topic_23.html topic_24.html topic_25.html topic_26.html topic_27.html topic_28.html topic_29.html topic_2.html topic_30.html topic_31.html topic_32.html topic_33.html topic_34.html topic_35.html topic_36.html topic_37.html topic_38.html topic_39.html topic_3.html topic_40.html topic_41.html topic_42.html topic_43.html topic_44.html topic_45.html topic_46.html topic_47.html topic_48.html topic_49.html topic_4.html topic_50.html topic_51.html topic_52.html topic_53.html topic_54.html topic_55.html topic_56.html topic_57.html topic_58.html topic_59.html topic_5.html topic_60.html topic_61.html topic_62.html topic_63.html topic_64.html topic_65.html topic_66.html topic_67.html topic_68.html topic_69.html topic_6.html topic_70.html topic_71.html topic_72.html topic_73.html topic_74.html topic_75.html topic_76.html topic_77.html topic_78.html topic_79.html topic_7.html topic_80.html topic_81.html topic_82.html topic_83.html topic_84.html topic_85.html topic_86.html topic_87.html topic_88.html topic_89.html topic_8.html topic_90.html topic_91.html topic_92.html topic_93.html topic_94.html topic_95.html topic_96.html topic_97.html topic_98.html topic_99.html topic_9.html [drivers/pci/quirks.o] Error 1 scripts/Makefile.build:404: recipe for target &#039;drivers/pci&#039; failed make[1]: 1.sh topic_100.html topic_101.html topic_102.html topic_103.html topic_104.html topic_105.html topic_106.html topic_107.html topic_108.html topic_109.html topic_10.html topic_110.html topic_111.html topic_112.html topic_113.html topic_114.html topic_115.html topic_116.html topic_117.html topic_118.html topic_119.html topic_11.html topic_120.html topic_121.html topic_122.html topic_123.html topic_124.html topic_125.html topic_126.html topic_127.html topic_128.html topic_129.html topic_12.html topic_130.html topic_131.html topic_132.html topic_133.html topic_134.html topic_135.html topic_136.html topic_137.html topic_138.html topic_13.html topic_14.html topic_15.html topic_16.html topic_17.html topic_18.html topic_19.html topic_1.html topic_20.html topic_21.html topic_22.html topic_23.html topic_24.html topic_25.html topic_26.html topic_27.html topic_28.html topic_29.html topic_2.html topic_30.html topic_31.html topic_32.html topic_33.html topic_34.html topic_35.html topic_36.html topic_37.html topic_38.html topic_39.html topic_3.html topic_40.html topic_41.html topic_42.html topic_43.html topic_44.html topic_45.html topic_46.html topic_47.html topic_48.html topic_49.html topic_4.html topic_50.html topic_51.html topic_52.html topic_53.html topic_54.html topic_55.html topic_56.html topic_57.html topic_58.html topic_59.html topic_5.html topic_60.html topic_61.html topic_62.html topic_63.html topic_64.html topic_65.html topic_66.html topic_67.html topic_68.html topic_69.html topic_6.html topic_70.html topic_71.html topic_72.html topic_73.html topic_74.html topic_75.html topic_76.html topic_77.html topic_78.html topic_79.html topic_7.html topic_80.html topic_81.html topic_82.html topic_83.html topic_84.html topic_85.html topic_86.html topic_87.html topic_88.html topic_89.html topic_8.html topic_90.html topic_91.html topic_92.html topic_93.html topic_94.html topic_95.html topic_96.html topic_97.html topic_98.html topic_99.html topic_9.html [drivers/pci] Error 2 Makefile:929: recipe for target &#039;drivers&#039; failed make: 1.sh topic_100.html topic_101.html topic_102.html topic_103.html topic_104.html topic_105.html topic_106.html topic_107.html topic_108.html topic_109.html topic_10.html topic_110.html topic_111.html topic_112.html topic_113.html topic_114.html topic_115.html topic_116.html topic_117.html topic_118.html topic_119.html topic_11.html topic_120.html topic_121.html topic_122.html topic_123.html topic_124.html topic_125.html topic_126.html topic_127.html topic_128.html topic_129.html topic_12.html topic_130.html topic_131.html topic_132.html topic_133.html topic_134.html topic_135.html topic_136.html topic_137.html topic_138.html topic_13.html topic_14.html topic_15.html topic_16.html topic_17.html topic_18.html topic_19.html topic_1.html topic_20.html topic_21.html topic_22.html topic_23.html topic_24.html topic_25.html topic_26.html topic_27.html topic_28.html topic_29.html topic_2.html topic_30.html topic_31.html topic_32.html topic_33.html topic_34.html topic_35.html topic_36.html topic_37.html topic_38.html topic_39.html topic_3.html topic_40.html topic_41.html topic_42.html topic_43.html topic_44.html topic_45.html topic_46.html topic_47.html topic_48.html topic_49.html topic_4.html topic_50.html topic_51.html topic_52.html topic_53.html topic_54.html topic_55.html topic_56.html topic_57.html topic_58.html topic_59.html topic_5.html topic_60.html topic_61.html topic_62.html topic_63.html topic_64.html topic_65.html topic_66.html topic_67.html topic_68.html topic_69.html topic_6.html topic_70.html topic_71.html topic_72.html topic_73.html topic_74.html topic_75.html topic_76.html topic_77.html topic_78.html topic_79.html topic_7.html topic_80.html topic_81.html topic_82.html topic_83.html topic_84.html topic_85.html topic_86.html topic_87.html topic_88.html topic_89.html topic_8.html topic_90.html topic_91.html topic_92.html topic_93.html topic_94.html topic_95.html topic_96.html topic_97.html topic_98.html topic_99.html topic_9.html [drivers] Error 2 ==&gt; ERROR: A failure occurred in build(). Aborting...</code></pre></div><p>So, my hacking skills doesnt work to create a proper patch.</p><p>EDIT 4,<br />Ok, after lots of trial and error, I found out that I tried to patch something that was already included.... </p><p>And my raid card is not compatible.... great!. Googling for a new one...</p><p>Any suggestion for a SAT 4xports cheap and linux friendly? For a storage raid</p><br /><br /><p>Any good Samaritan?</p> <p class="postedit"><em>Last edited by wikavalier (2014-11-28 20:33:45)</em></p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1479773">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1479798" class="blockpost rowodd"> <h2><span><span class="conr">#3469</span> <a href="viewtopic.php?pid=1479798#p1479798">2014-11-27 17:42:04</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=82238">sinny</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2014-05-24</span></dd> <dd><span>Posts: 75</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=82238">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <p><a href="http://rolandtapken.de/blog/2011-04/how-auto-hotplug-usb-devices-libvirt-vms-update-1" rel="nofollow">this</a> was extremely valuable find for me</p><p>so i&#039;m leaving it here, in case someone relied purely on &quot;static&quot; usb passthrough but was not very happy with it</p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1479798">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1479947" class="blockpost roweven"> <h2><span><span class="conr">#3470</span> <a href="viewtopic.php?pid=1479947#p1479947">2014-11-28 12:34:27</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=58583">Nesousx</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2012-03-27</span></dd> <dd><span>Posts: 46</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=58583">Email</a></span> <span class="website"><a href="https://www.kodi-xbmc.com/" rel="nofollow">Website</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <p>Hi all.</p><p>About my audio issue (stuttering audio using an USB Xonar U7 sound card). It is more or less fixed. I bought a new USB sound card : Hercules LT3, and it now works as expected. I passthrough the whole USB controller (including sound card, and input devices), and it works fine!</p><p>So&#160; far it seems it was only an hardware related issue. I have had this issue for months using Xen (iirc), and KVM under Ubuntu and Arch. If I can give people a piece of advice : dont buy this Xonar U7 for this usage.</p> <p class="postedit"><em>Last edited by Nesousx (2014-11-28 15:37:43)</em></p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1479947">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1480006" class="blockpost rowodd"> <h2><span><span class="conr">#3471</span> <a href="viewtopic.php?pid=1480006#p1480006">2014-11-28 17:24:10</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=48315">TripleSpeeder</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2011-05-02</span></dd> <dd><span>Posts: 43</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=48315">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>Duelist wrote:</cite><blockquote><div><div class="quotebox"><cite>TripleSpeeder wrote:</cite><blockquote><div><p>Regarding OVMF/UEFI: I heard rumors that this also works with Windows7. Can anybody here confirm that a Windows 7 VM is working with OVMF?</p></div></blockquote></div><p>Well, i can confirm that. Windows 7 supports UEFI, but you need a somewhat special way to install it(obviously, the cd should have something like .EFI loader file). Mine installation ISO supported that. But i won&#039;t provide it to you because i&#039;m a filthy pirate and should be punished for using windows.<br />I&#039;ve got to install and boot it, but i couldn&#039;t get vfio/pci passthrough working because, well, my asus GPUs needed to be physically flashed - i couldn&#039;t boot myself with romfile= pointing to my card&#039;s UEFI-compatible VBIOS update. So YMMV. Also, there is GPT support if you&#039;re curious.</p></div></blockquote></div><p>Hmm, I do have the installation iso containing UEFI loader etc. But even with a minimum setup (no pass-through devices, just the iso loaded as the only CDROM, no additional HDs) i don&#039;t have much success. I can launch the windows bootloader from the UEFI shell, it starts with the black/white screen &quot;loading Files&quot;, followed by the graphical &quot;Starting Windows&quot; screen. 1-2 seconds later i get a black screen again with some kind of black/white progress bar (?) on top, which is not moving. THere it stops, with one CPU core running at 100%. I left it for +10 minutes, with nothing happening.</p><p>Just for testing I removed the emulated graphics and passed through my GTX970, which was working flawlessly, except for the installation progress stopping at the exact same place :-(</p><p>Could you share your qmeu commandline / libvirt xml config?</p><p>Thanks!</p><p>Edit: I used ovmf-svn from AUR, compiled yesterday.</p> <p class="postedit"><em>Last edited by TripleSpeeder (2014-11-28 17:24:49)</em></p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1480006">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1480029" class="blockpost roweven"> <h2><span><span class="conr">#3472</span> <a href="viewtopic.php?pid=1480029#p1480029">2014-11-28 19:36:29</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=85314">Duelist</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2014-09-22</span></dd> <dd><span>Posts: 358</span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>TripleSpeeder wrote:</cite><blockquote><div><p>Hmm, I do have the installation iso containing UEFI loader etc. But even with a minimum setup (no pass-through devices, just the iso loaded as the only CDROM, no additional HDs) i don&#039;t have much success. I can launch the windows bootloader from the UEFI shell, it starts with the black/white screen &quot;loading Files&quot;, followed by the graphical &quot;Starting Windows&quot; screen. 1-2 seconds later i get a black screen again with some kind of black/white progress bar (?) on top, which is not moving. THere it stops, with one CPU core running at 100%. I left it for +10 minutes, with nothing happening.</p><p>Just for testing I removed the emulated graphics and passed through my GTX970, which was working flawlessly, except for the installation progress stopping at the exact same place :-(</p><p>Could you share your qmeu commandline / libvirt xml config?</p><p>Thanks!</p><p>Edit: I used ovmf-svn from AUR, compiled yesterday.</p></div></blockquote></div><p>OVMF git repo build(i use fedora) 20141128.b817.gb04a63a</p><p>Seems like windows installation iso loses it&#039;s boot drive, but i got you a pair of screenshots getting past your point of breakage.</p><p>Here, have an <a href="http://imgur.com/c4Hcu4O,ojra76A,D3XwqKI,oqJZAHF" rel="nofollow">imgur slideshow</a>.</p><div class="codebox"><pre><code>qemu-system-x86_64 \ -boot menu=on \ -enable-kvm \ -monitor stdio \ -M q35 \ -m 1024 \ -cpu host \ -net none \ -rtc base=localtime \ -smp 1,sockets=1,cores=1,threads=1 \ -drive if=pflash,format=raw,readonly,file=/usr/share/edk2.git/ovmf-x64/OVMF_CODE-pure-efi.fd \ -drive if=pflash,format=raw,file=/mnt/hdd/qemu/OVMF_VARS.fd \ -drive file=&#039;/mnt/hdd/qemu/qemu-uefi-win7.img&#039;,id=disk,format=raw,aio=native,cache=none,if=none \ -drive file=&#039;/mnt/hdd/qemu/virtio.iso&#039;,id=cdrom,format=raw,readonly=on,if=none \ -drive file=&#039;/mnt/hdd/qemu/windows7.iso&#039;,id=cdrom2,format=raw,readonly=on,if=none \ -device ioh3420,addr=04.0,multifunction=on,port=1,chassis=2,id=root.1 \ -device virtio-blk-pci,bus=root.1,addr=03.0,drive=disk \ -device virtio-scsi-pci,bus=root.1,addr=05.0 \ -device ide-cd,bus=ide.1,drive=cdrom \ -device scsi-cd,drive=cdrom2 \ -vga std</code></pre></div><p>And here&#039;s a loading script. Just a config based on my vfio setup, so it shouldn&#039;t work because i&#039;m lazy to fix it, but it boots and tries to install.<br />Notice the pure-efi image of OVMF used.</p><p>EDIT:<br />seems like i&#039;ve figured out why it fails to find it&#039;s boot drive. There is no virtio-scsi-pci drivers in the windows installation system, and the cdrom2 drive, which is windows7.iso, is connected to it. Changing that virtio-scsi-pci to something more generic should help the issue here.</p> <p class="postedit"><em>Last edited by Duelist (2014-11-28 20:42:54)</em></p> </div> <div class="postsignature postmsg"><hr /><p><span class="bbs">The forum rules prohibit requesting support for distributions other than arch.</span><br /><a href="https://bbs.archlinux.org/viewtopic.php?pid=1551460#p1551460" rel="nofollow">I gave up.</a><a href="https://bbs.archlinux.org/viewtopic.php?id=162768" rel="nofollow"> It was too late.</a><br /><a href="http://pastebin.com/B3fL84bq" rel="nofollow">What I was trying to do</a>.<br /><a href="http://vfio.blogspot.com/" rel="nofollow">The reference about VFIO and KVM VGA passthrough.</a></p></div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1480029">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1480206" class="blockpost rowodd"> <h2><span><span class="conr">#3473</span> <a href="viewtopic.php?pid=1480206#p1480206">2014-11-29 15:10:52</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=48315">TripleSpeeder</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2011-05-02</span></dd> <dd><span>Posts: 43</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=48315">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <p>Thanks a lot Duelist! I found the root cause that stopped windows setup from continuing: It is the -cpu parameter. <br />This is the qemu command-line as provided by libvirt:</p><div class="codebox"><pre><code>-cpu qemu64,hv_time</code></pre></div><p>The moment I remove parameter hv_time, windows setup continues. And this problem only happens with smp=2 or higher. With only one core assigned to the VM it boots also with hv_time.</p><p>Any ideas out there what might be the root cause?</p><p>Edit: Note that this is still without any device pass-through, just using the default emulated vga. Trying to get setup running completely with passed-through NVidia card is the next step <img src="https://bbs.archlinux.org/img/smilies/smile.png" width="15" height="15" alt="smile" /></p> <p class="postedit"><em>Last edited by TripleSpeeder (2014-11-29 15:15:19)</em></p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1480206">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1480212" class="blockpost roweven"> <h2><span><span class="conr">#3474</span> <a href="viewtopic.php?pid=1480212#p1480212">2014-11-29 15:30:54</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=84760">Denso</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd class="postavatar"><img src="https://bbs.archlinux.org/img/avatars/84760.png?m=1412533733" width="71" height="80" alt="" /></dd> <dd><span>Registered: 2014-08-30</span></dd> <dd><span>Posts: 179</span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <p>Now this is REALLY odd ...</p><p>Using &quot;pci-assign&quot; instead of &quot;vfio-pci&quot; to assign my devices to the VM seems to solves the reboot issue with GT610 GPU . This is using OVMF + 440FX by the way .</p><p>The VFIO still claims those devices at boot from the PCI-STUB . I don&#039;t know how much will this success last , but I rebooted the VM twice and it reboots fine . I thought the VFIO was supposed to fix the devices reset issues ?</p><p>dmesg :</p><div class="codebox"><pre><code>[Sat Nov 29 18:17:31 2014] vfio-pci 0000:05:00.0: kvm assign device [Sat Nov 29 18:17:31 2014] vfio-pci 0000:05:00.1: kvm assign device [Sat Nov 29 18:17:32 2014] vfio-pci 0000:0f:00.0: kvm assign device [Sat Nov 29 18:17:32 2014] vfio-pci 0000:00:1b.0: kvm assign device</code></pre></div><p>CMDLine :</p><div class="codebox"><pre><code>qemu-system-x86_64 -name main -nographic -mem-path /dev/hugepages \ -enable-kvm -m 8192 -cpu host,kvm=off -smp 2,sockets=1,cores=1,threads=2 \ -vga none \ -drive if=pflash,format=raw,readonly,file=/usr/share/ovmf/x64/ovmf_code_x64.bin \ -drive if=pflash,format=raw,file=/VMs/ovmf_main.bin \ -device pci-assign,host=05:00.0,multifunction=on \ -device pci-assign,host=05:00.1 \ -device pci-assign,host=0f:00.0 \ -device pci-assign,host=00:1b.0 \ -drive file=/VMs/Win_Main.qcow2,cache=writeback,if=none,id=drive0,aio=native \ -device virtio-blk-pci,drive=drive0,ioeventfd=on,bootindex=1 \ -device virtio-scsi-pci,id=scsi \ -drive file=/VMs/Win8.iso,id=iso_install,if=none \ -device scsi-cd,drive=iso_install \ -cdrom /VMs/virtio.iso \ -net nic,model=virtio,macaddr=64:C5:63:3C:1B:22 -net bridge,br=br0 \ -usb -usbdevice host:045e:0745 \ -localtime \ -monitor unix:/tmp/vm_main,server,nowait &amp;</code></pre></div><p>Let&#039;s see if this is going to be the solution for my ongoing issues with GT610 .</p><p>EDIT : </p><p>Installed Nvidia&#039;s drivers 344.75 (the latest I think) , reboot 2 times and it works perfectly . I&#039;m happy , yet confused . <img src="https://bbs.archlinux.org/img/smilies/smile.png" width="15" height="15" alt="smile" /></p> <p class="postedit"><em>Last edited by Denso (2014-11-29 15:43:19)</em></p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1480212">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1480215" class="blockpost rowodd"> <h2><span><span class="conr">#3475</span> <a href="viewtopic.php?pid=1480215#p1480215">2014-11-29 15:40:53</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=77842">Flyser</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2013-12-19</span></dd> <dd><span>Posts: 29</span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>TripleSpeeder wrote:</cite><blockquote><div><p>Thanks a lot Duelist! I found the root cause that stopped windows setup from continuing: It is the -cpu parameter. <br />This is the qemu command-line as provided by libvirt:</p><div class="codebox"><pre><code>-cpu qemu64,hv_time</code></pre></div><p>The moment I remove parameter hv_time, windows setup continues. And this problem only happens with smp=2 or higher. With only one core assigned to the VM it boots also with hv_time.</p><p>Any ideas out there what might be the root cause?</p><p>Edit: Note that this is still without any device pass-through, just using the default emulated vga. Trying to get setup running completely with passed-through NVidia card is the next step <img src="https://bbs.archlinux.org/img/smilies/smile.png" width="15" height="15" alt="smile" /></p></div></blockquote></div><p>I experienced crashes during the windows installation in a non-vfio setup as well. The root cause were missing kernel config options for libvirt, but I guess you are using the archlinux kernel, right?</p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1480215">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div class="postlinksb"> <div class="inbox crumbsplus"> <div class="pagepost"> <p class="pagelink conl"><span class="pages-label">Pages: </span><a rel="prev" class="item1" href="viewtopic.php?id=162768&amp;p=138">Previous</a> <a href="viewtopic.php?id=162768">1</a> <span class="spacer">…</span> <a href="viewtopic.php?id=162768&amp;p=137">137</a> <a href="viewtopic.php?id=162768&amp;p=138">138</a> <strong>139</strong> <a href="viewtopic.php?id=162768&amp;p=140">140</a> <a href="viewtopic.php?id=162768&amp;p=141">141</a> <span class="spacer">…</span> <a href="viewtopic.php?id=162768&amp;p=234">234</a> <a rel="next" href="viewtopic.php?id=162768&amp;p=140">Next</a></p> <p class="postlink conr">Topic closed</p> </div> <ul class="crumbs"> <li><a href="index.php">Index</a></li> <li><span>»&#160;</span><a href="viewforum.php?id=48">Topics Going Nowhere</a></li> <li><span>»&#160;</span><strong><a href="viewtopic.php?id=162768">KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</a></strong></li> </ul> <p class="subscribelink clearb"><a href="misc.php?action=subscribe&amp;tid=162768">Subscribe to this topic</a></p> <div class="clearer"></div> </div> </div> </div> <div id="brdfooter" class="block"> <h2><span>Board footer</span></h2> <div class="box"> <div id="brdfooternav" class="inbox"> <div class="conl"> <form id="qjump" method="get" action="viewforum.php"> <div><label><span>Jump to<br /></span> <select name="id" onchange="window.location=('viewforum.php?id='+this.options[this.selectedIndex].value)"> <optgroup label="Technical Issues and Assistance"> <option value="23">Newbie Corner</option> <option value="17">Installation</option> <option value="22">Kernel &amp; Hardware</option> <option value="18">Applications &amp; Desktop Environments</option> <option value="31">Laptop Issues</option> <option value="8">Networking, Server, and Protection</option> <option value="32">Multimedia and Games</option> <option value="50">System Administration</option> <option value="35">Other Architectures</option> </optgroup> <optgroup label="Arch-centric"> <option value="24">Announcements, Package &amp; Security Advisories</option> <option value="1">Arch Discussion</option> <option value="13">Forum &amp; Wiki discussion</option> </optgroup> <optgroup label="Pacman Upgrades, Packaging &amp; AUR"> <option value="44">Pacman &amp; Package Upgrade Issues</option> <option value="49">[testing] Repo Forum</option> <option value="4">Creating &amp; Modifying Packages</option> <option value="38">AUR Issues, Discussion &amp; PKGBUILD Requests</option> </optgroup> <optgroup label="Contributions &amp; Discussion"> <option value="20">GNU/Linux Discussion</option> <option value="27">Community Contributions</option> <option value="33">Programming &amp; Scripting</option> <option value="30">Other Languages</option> <option value="47">Artwork and Screenshots</option> <option value="42">Try This</option> </optgroup> <optgroup label="/dev/null"> <option value="29">Off-Topic</option> <option value="48" selected="selected">Topics Going Nowhere</option> <option value="36">Dustbin</option> </optgroup> </select></label> <input type="submit" value=" Go " accesskey="g" /> </div> </form> </div> <div class="conr"> <p id="feedlinks"><span class="atom"><a href="extern.php?action=feed&amp;tid=162768&amp;type=atom">Atom topic feed</a></span></p> <p id="poweredby">Powered by <a href="http://fluxbb.org/">FluxBB</a></p> </div> <div class="clearer"></div> </div> </div> </div> </div> <div class="end-box"></div> </div> </body> </html>
