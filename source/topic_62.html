<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"> <html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en" dir="ltr"> <head> <meta http-equiv="Content-Type" content="text/html; charset=utf-8" /> <title>KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9 (Page 62) / Topics Going Nowhere / Arch Linux Forums</title> <link rel="stylesheet" type="text/css" href="style/ArchLinux.css" /> <link rel="canonical" href="viewtopic.php?id=162768&amp;p=62" title="Page 62" /> <link rel="prev" href="viewtopic.php?id=162768&amp;p=61" title="Page 61" /> <link rel="next" href="viewtopic.php?id=162768&amp;p=63" title="Page 63" /> <link rel="alternate" type="application/atom+xml" href="extern.php?action=feed&amp;tid=162768&amp;type=atom" title="Atom topic feed" /> <link rel="stylesheet" media="screen" href="style/ArchLinux/arch.css?v=3" /> <link rel="stylesheet" media="screen" href="style/ArchLinux/archnavbar.css?v=2" /> <link rel="shortcut icon" href="style/ArchLinux/favicon.ico" /> </head> <body> <div id="archnavbar" class="anb-forum"> <div id="archnavbarlogo"><h1><a href="http://www.archlinux.org/">Arch Linux</a></h1></div> <div id="archnavbarmenu"> <ul id="archnavbarlist"> <li id="anb-home"><a href="http://www.archlinux.org/">Home</a></li><li id="anb-packages"><a href="http://www.archlinux.org/packages/">Packages</a></li><li id="anb-forums" class="anb-selected"><a href="https://bbs.archlinux.org/">Forums</a></li><li id="anb-wiki"><a href="https://wiki.archlinux.org/">Wiki</a></li><li id="anb-bugs"><a href="https://bugs.archlinux.org/">Bugs</a></li><li id="anb-aur"><a href="https://aur.archlinux.org/">AUR</a></li><li id="anb-download"><a href="http://www.archlinux.org/download/">Download</a></li> </ul> </div> </div> <div id="punviewtopic" class="pun"> <div class="top-box"></div> <div class="punwrap"> <div id="brdheader" class="block"> <div class="box"> <div id="brdmenu" class="inbox"> <ul> <li id="navindex" class="isactive"><a href="index.php">Index</a></li> <li id="navuserlist"><a href="userlist.php">User list</a></li> <li id="navsearch"><a href="search.php">Search</a></li> <li id="navprofile"><a href="profile.php?id=80749">Profile</a></li> <li id="navlogout"><a href="login.php?action=out&amp;id=80749&amp;csrf_token=5c20501ec397bb45ef8ee8c84db232c8d8e421c6">Logout</a></li> </ul> </div> <div id="brdwelcome" class="inbox"> <ul class="conl"> <li><span>Logged in as <strong>SXX</strong></span></li> <li><span>Last visit: 2015-08-16 12:20:09</span></li> </ul> <ul class="conr"> <li><span>Topics: <a href="search.php?action=show_replies" title="Find topics you have posted to.">Posted</a> | <a href="search.php?action=show_new" title="Find topics with new posts since your last visit.">New</a> | <a href="search.php?action=show_recent" title="Find topics with recent posts.">Active</a> | <a href="search.php?action=show_unanswered" title="Find topics with no replies.">Unanswered</a></span></li> </ul> <div class="clearer"></div> </div> </div> </div> <div id="brdmain"> <div class="linkst"> <div class="inbox crumbsplus"> <ul class="crumbs"> <li><a href="index.php">Index</a></li> <li><span>»&#160;</span><a href="viewforum.php?id=48">Topics Going Nowhere</a></li> <li><span>»&#160;</span><strong><a href="viewtopic.php?id=162768">KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</a></strong></li> </ul> <div class="pagepost"> <p class="pagelink conl"><span class="pages-label">Pages: </span><a rel="prev" class="item1" href="viewtopic.php?id=162768&amp;p=61">Previous</a> <a href="viewtopic.php?id=162768">1</a> <span class="spacer">…</span> <a href="viewtopic.php?id=162768&amp;p=60">60</a> <a href="viewtopic.php?id=162768&amp;p=61">61</a> <strong>62</strong> <a href="viewtopic.php?id=162768&amp;p=63">63</a> <a href="viewtopic.php?id=162768&amp;p=64">64</a> <span class="spacer">…</span> <a href="viewtopic.php?id=162768&amp;p=234">234</a> <a rel="next" href="viewtopic.php?id=162768&amp;p=63">Next</a></p> <p class="postlink conr">Topic closed</p> </div> <div class="clearer"></div> </div> </div> <div id="p1402869" class="blockpost rowodd blockpost1"> <h2><span><span class="conr">#1526</span> <a href="viewtopic.php?pid=1402869#p1402869">2014-04-10 21:56:15</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=80933">Cubex</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2014-04-06</span></dd> <dd><span>Posts: 24</span></dd> <dd class="usercontacts"><span class="email"><a href="mailto:cubexed@gmail.com">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <p>Weee got Crysis 3 working ^^, now im trying to hunt the audio issue, nbhs, there is any equivalent of disabling nested page table thing under Intel?</p><p>PD: also found this, those who want to optimize might found interesting <a href="http://pic.dhe.ibm.com/infocenter/lnxinfo/v3r0m0/topic/liaat/liaattuning_pdf.pdf" rel="nofollow">http://pic.dhe.ibm.com/infocenter/lnxin … ng_pdf.pdf</a></p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1402869">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1402876" class="blockpost roweven"> <h2><span><span class="conr">#1527</span> <a href="viewtopic.php?pid=1402876#p1402876">2014-04-10 22:19:29</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=81045">tswindell</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2014-04-10</span></dd> <dd><span>Posts: 3</span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <p>Managed to get this working out-of-the-box with Ubuntu 14.04 RC</p><p>Steps:<br />&#160; - Added intel_iommu=on to /etc/default/grub<br />&#160; - Added i915, nouveau, nvidia to /etc/modprobe.d/blacklist.conf<br />&#160; - sudo update-initramfs -u<br />&#160; - sudo update-grub<br />&#160; - rebooted and installed qemu-kvm<br />&#160; - Used vfio-bind script from OP<br />&#160; - Executed qemu as OP</p><p>Hardware:<br />&#160; - Intel i7 4771<br />&#160; - ASUS Z87 Plus<br />&#160; - 16GB DDR3 RAM<br />&#160; - 2x nVidia GeForce 680 GTX</p><p>I have only one issue now, and that is that both nVidia cards are in the same iommu group, I&#039;m guessing this is an issue with my motherboard, and it means I can&#039;t run two guests and dedicate a card to each, which is my end goal. <img src="https://bbs.archlinux.org/img/smilies/hmm.png" width="15" height="15" alt="hmm" /></p><p>I guess this is what the ACS override patch is for, so I&#039;m going to apply V2 of that and see if that works.</p> <p class="postedit"><em>Last edited by tswindell (2014-04-10 22:38:16)</em></p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1402876">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1402918" class="blockpost rowodd"> <h2><span><span class="conr">#1528</span> <a href="viewtopic.php?pid=1402918#p1402918">2014-04-11 00:46:12</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=80806">lildigiman</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2014-04-02</span></dd> <dd><span>Posts: 3</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=80806">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>tswindell wrote:</cite><blockquote><div><p>Managed to get this working out-of-the-box with Ubuntu 14.04 RC</p><p>Steps:<br />&#160; - Added intel_iommu=on to /etc/default/grub<br />&#160; - Added i915, nouveau, nvidia to /etc/modprobe.d/blacklist.conf<br />&#160; - sudo update-initramfs -u<br />&#160; - sudo update-grub<br />&#160; - rebooted and installed qemu-kvm<br />&#160; - Used vfio-bind script from OP<br />&#160; - Executed qemu as OP</p><p>Hardware:<br />&#160; - Intel i7 4771<br />&#160; - ASUS Z87 Plus<br />&#160; - 16GB DDR3 RAM<br />&#160; - 2x nVidia GeForce 680 GTX</p><p>I have only one issue now, and that is that both nVidia cards are in the same iommu group, I&#039;m guessing this is an issue with my motherboard, and it means I can&#039;t run two guests and dedicate a card to each, which is my end goal. <img src="https://bbs.archlinux.org/img/smilies/hmm.png" width="15" height="15" alt="hmm" /></p><p>I guess this is what the ACS override patch is for, so I&#039;m going to apply V2 of that and see if that works.</p></div></blockquote></div><p>Are you using the Intel GPU for the host?</p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1402918">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1402974" class="blockpost roweven"> <h2><span><span class="conr">#1529</span> <a href="viewtopic.php?pid=1402974#p1402974">2014-04-11 06:13:36</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=80335">beckend</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2014-03-16</span></dd> <dd><span>Posts: 5</span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <p>Eb, I have no idea what your missing, however, here is my PKGBUILD and acsv2 patch in pastebin.<br />PKGBUILD: <a href="http://pastebin.com/G7huLq6p" rel="nofollow">http://pastebin.com/G7huLq6p</a><br />acs.patch: <a href="http://pastebin.com/gpTZiuXv" rel="nofollow">http://pastebin.com/gpTZiuXv</a></p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1402974">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1402983" class="blockpost rowodd"> <h2><span><span class="conr">#1530</span> <a href="viewtopic.php?pid=1402983#p1402983">2014-04-11 07:40:15</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=81045">tswindell</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2014-04-10</span></dd> <dd><span>Posts: 3</span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>lildigiman wrote:</cite><blockquote><div><p>Are you using the Intel GPU for the host?</p></div></blockquote></div><p>Yes, indeed I am, though blacklisting i915 is the only way I can get the VM to boot, presumably because of the VGA arbitration issues. Not a problem though as I&#039;m running the host practically headless. Only issue for me like I said is separating the two 680 GTX cards from the iommu group they&#039;re in to be able to use each in a separate VM container.</p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1402983">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1403121" class="blockpost roweven"> <h2><span><span class="conr">#1531</span> <a href="viewtopic.php?pid=1403121#p1403121">2014-04-11 14:47:20</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=80933">Cubex</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2014-04-06</span></dd> <dd><span>Posts: 24</span></dd> <dd class="usercontacts"><span class="email"><a href="mailto:cubexed@gmail.com">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <p>Sadly the V2 patch doesn&#039;t work for me, it groups the first and second PCI-E slots on same group &gt;.&lt;</p><div class="codebox"><pre><code>/sys/bus/pci/devices/0000:01:00.0/iommu_group/devices: 0000:00:01.0@ 0000:00:01.1@ 0000:01:00.0@ 0000:01:00.1@ 0000:02:00.0@ 0000:02:00.1@ /sys/bus/pci/devices/0000:01:00.1/iommu_group/devices: 0000:00:01.0@ 0000:00:01.1@ 0000:01:00.0@ 0000:01:00.1@ 0000:02:00.0@ 0000:02:00.1@ /sys/bus/pci/devices/0000:02:00.0/iommu_group/devices: 0000:00:01.0@ 0000:00:01.1@ 0000:01:00.0@ 0000:01:00.1@ 0000:02:00.0@ 0000:02:00.1@ /sys/bus/pci/devices/0000:02:00.1/iommu_group/devices: 0000:00:01.0@ 0000:00:01.1@ 0000:01:00.0@ 0000:01:00.1@ 0000:02:00.0@ 0000:02:00.1@</code></pre></div><p>I will unapply the v2 patch and put again the old acs override, that in my case works great...</p><p>EDIT: </p><p>I also post the dmesg showing that the patch was active...</p><div class="codebox"><pre><code>dmesg | grep ACS [ 0.181833] pci 0000:00:1c.0: Intel PCH root port ACS workaround enabled [ 0.181949] pci 0000:00:1c.1: Intel PCH root port ACS workaround enabled [ 0.182066] pci 0000:00:1c.3: Intel PCH root port ACS workaround enabled</code></pre></div> <p class="postedit"><em>Last edited by Cubex (2014-04-11 14:49:39)</em></p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1403121">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1403135" class="blockpost rowodd"> <h2><span><span class="conr">#1532</span> <a href="viewtopic.php?pid=1403135#p1403135">2014-04-11 15:11:45</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=75590">aw</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2013-10-04</span></dd> <dd><span>Posts: 921</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=75590">Email</a></span> <span class="website"><a href="http://vfio.blogspot.com/" rel="nofollow">Website</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>Cubex wrote:</cite><blockquote><div><p>Sadly the V2 patch doesn&#039;t work for me, it groups the first and second PCI-E slots on same group &gt;.&lt;</p><div class="codebox"><pre><code>/sys/bus/pci/devices/0000:01:00.0/iommu_group/devices: 0000:00:01.0@ 0000:00:01.1@ 0000:01:00.0@ 0000:01:00.1@ 0000:02:00.0@ 0000:02:00.1@ /sys/bus/pci/devices/0000:01:00.1/iommu_group/devices: 0000:00:01.0@ 0000:00:01.1@ 0000:01:00.0@ 0000:01:00.1@ 0000:02:00.0@ 0000:02:00.1@ /sys/bus/pci/devices/0000:02:00.0/iommu_group/devices: 0000:00:01.0@ 0000:00:01.1@ 0000:01:00.0@ 0000:01:00.1@ 0000:02:00.0@ 0000:02:00.1@ /sys/bus/pci/devices/0000:02:00.1/iommu_group/devices: 0000:00:01.0@ 0000:00:01.1@ 0000:01:00.0@ 0000:01:00.1@ 0000:02:00.0@ 0000:02:00.1@</code></pre></div><p>I will unapply the v2 patch and put again the old acs override, that in my case works great...</p><p>EDIT: </p><p>I also post the dmesg showing that the patch was active...</p><div class="codebox"><pre><code>dmesg | grep ACS [ 0.181833] pci 0000:00:1c.0: Intel PCH root port ACS workaround enabled [ 0.181949] pci 0000:00:1c.1: Intel PCH root port ACS workaround enabled [ 0.182066] pci 0000:00:1c.3: Intel PCH root port ACS workaround enabled</code></pre></div></div></blockquote></div><p>The upstream patch is for PCH root ports only, 00:1c.*.&#160; Complain to Intel about processor based root ports.</p> </div> <div class="postsignature postmsg"><hr /><p><a href="http://vfio.blogspot.com" rel="nofollow">http://vfio.blogspot.com</a><br />Looking for a more open forum to discuss vfio related uses?&#160; Try <a href="https://www.redhat.com/mailman/listinfo/vfio-users" rel="nofollow">https://www.redhat.com/mailman/listinfo/vfio-users</a></p></div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1403135">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1403187" class="blockpost roweven"> <h2><span><span class="conr">#1533</span> <a href="viewtopic.php?pid=1403187#p1403187">2014-04-11 17:04:14</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=80990">Eb</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2014-04-08</span></dd> <dd><span>Posts: 11</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=80990">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>beckend wrote:</cite><blockquote><div><p>Eb, I have no idea what your missing, however, here is my PKGBUILD and acsv2 patch in pastebin.<br />PKGBUILD: <a href="http://pastebin.com/G7huLq6p" rel="nofollow">http://pastebin.com/G7huLq6p</a><br />acs.patch: <a href="http://pastebin.com/gpTZiuXv" rel="nofollow">http://pastebin.com/gpTZiuXv</a></p></div></blockquote></div><p>Thanks, rebuilt with what you provided with no issues.</p><p>Unfortunately, with v2 of the patch I&#039;m getting the same problem where I have an overly large IOMMU group containing all my video devices and then some (See: <a href="https://bbs.archlinux.org/viewtopic.php?pid=1402357#p1402357)" rel="nofollow">https://bbs.archlinux.org/viewtopic.php … #p1402357)</a>.</p><p>I have the downstream option enabled for pcie_acs_override in my boot options, as well as intel_iommu.</p><p>I had this working before, but that was before installing another video card to try to fix some terrible graphical artifacts on the host when starting the KVM. I believe I was using linux-mainline 3.13 at that point as well.</p><p>Is there anything else I can try?</p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1403187">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1403195" class="blockpost rowodd"> <h2><span><span class="conr">#1534</span> <a href="viewtopic.php?pid=1403195#p1403195">2014-04-11 17:17:25</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=80279">novist</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2014-03-14</span></dd> <dd><span>Posts: 34</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=80279">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <p>Just wanted to share my solution to those horrible directx9 performance issues i had. I think it was just me overlooking some things as first post did not put them entirely in detail. Basically what i did was:<br />1. Added kvm-amd.npt=0 to grub command line. i had config in /etc/modprobe.d/.. but it did not work because kvm stuff is compiled in kernel and not as module that.<br />2. Did not use any patches i most likely dont need (like intel fixes since i have amd cpu/chipset):</p><div class="codebox"><pre><code>patch -p1 -i &quot;${srcdir}/0001-Bluetooth-allocate-static-minor-for-vhci.patch&quot; patch -p1 -i &quot;${srcdir}/0002-module-allow-multiple-calls-to-MODULE_DEVICE_TABLE-p.patch&quot; patch -p1 -i &quot;${srcdir}/0003-module-remove-MODULE_GENERIC_TABLE.patch&quot; patch -p1 -i &quot;${srcdir}/radeon_load_vbios_from_file.patch&quot; patch -p1 -i &quot;${srcdir}/override_for_missing_acs_capabilities.patch&quot;</code></pre></div><p>3. Copied timer subsystem configs from config suplied in first post:</p><div class="codebox"><pre><code>CONFIG_TICK_ONESHOT=y CONFIG_NO_HZ_COMMON=y # CONFIG_HZ_PERIODIC is not set CONFIG_NO_HZ_IDLE=y # CONFIG_NO_HZ_FULL is not set # CONFIG_NO_HZ is not set CONFIG_HIGH_RES_TIMERS=y</code></pre></div><p>after recompiling kernel performance is great. passmark still scores about 90% of bare metal speed on directx9 complex benchmark but hell i am ready to sacrifice that much since gpu is good enough to leave some room for penalties. directx10/11 benchmarks score in ~98% of bare metal performance though.</p><p>I suppose i missed all this stuff because of being rather new to linux and working on linux mint instead of arch. So newbies - make sure you put configs in right spot (modprobe.d or grub) and be aware of additional kernel build options!</p><p>@nbhs: it would be great if you could update first post with details of any other important kernel build options because not everyone might wish to use those configs supplied. Also all this information you shared made me and i bet lots of other people very happy pandas. Thanks bro.</p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1403195">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1403238" class="blockpost roweven"> <h2><span><span class="conr">#1535</span> <a href="viewtopic.php?pid=1403238#p1403238">2014-04-11 19:08:54</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=80990">Eb</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2014-04-08</span></dd> <dd><span>Posts: 11</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=80990">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>Eb wrote:</cite><blockquote><div><div class="quotebox"><cite>beckend wrote:</cite><blockquote><div><p>Eb, I have no idea what your missing, however, here is my PKGBUILD and acsv2 patch in pastebin.<br />PKGBUILD: <a href="http://pastebin.com/G7huLq6p" rel="nofollow">http://pastebin.com/G7huLq6p</a><br />acs.patch: <a href="http://pastebin.com/gpTZiuXv" rel="nofollow">http://pastebin.com/gpTZiuXv</a></p></div></blockquote></div><p>Thanks, rebuilt with what you provided with no issues.</p><p>Unfortunately, with v2 of the patch I&#039;m getting the same problem where I have an overly large IOMMU group containing all my video devices and then some (See: <a href="https://bbs.archlinux.org/viewtopic.php?pid=1402357#p1402357)" rel="nofollow">https://bbs.archlinux.org/viewtopic.php … #p1402357)</a>.</p><p>I have the downstream option enabled for pcie_acs_override in my boot options, as well as intel_iommu.</p><p>I had this working before, but that was before installing another video card to try to fix some terrible graphical artifacts on the host when starting the KVM. I believe I was using linux-mainline 3.13 at that point as well.</p><p>Is there anything else I can try?</p></div></blockquote></div><p>I&#039;ve removed my secondary video card, and got this:</p><div class="codebox"><pre><code>ls -l /sys/kernel/iommu_groups/1/devices total 0 lrwxrwxrwx 1 root root 0 Apr 9 11:33 0000:00:01.0 -&gt; ../../../../devices/pci0000:00/0000:00:01.0 lrwxrwxrwx 1 root root 0 Apr 9 11:33 0000:01:00.0 -&gt; ../../../../devices/pci0000:00/0000:00:01.0/0000:01:00.0 lrwxrwxrwx 1 root root 0 Apr 9 11:33 0000:02:08.0 -&gt; ../../../../devices/pci0000:00/0000:00:01.0/0000:01:00.0/0000:02:08.0 lrwxrwxrwx 1 root root 0 Apr 9 11:33 0000:02:10.0 -&gt; ../../../../devices/pci0000:00/0000:00:01.0/0000:01:00.0/0000:02:10.0 lrwxrwxrwx 1 root root 0 Apr 9 11:33 0000:02:11.0 -&gt; ../../../../devices/pci0000:00/0000:00:01.0/0000:01:00.0/0000:02:11.0 lrwxrwxrwx 1 root root 0 Apr 9 11:33 0000:03:00.0 -&gt; ../../../../devices/pci0000:00/0000:00:01.0/0000:01:00.0/0000:02:08.0/0000:03:00.0 lrwxrwxrwx 1 root root 0 Apr 9 11:33 0000:03:00.1 -&gt; ../../../../devices/pci0000:00/0000:00:01.0/0000:01:00.0/0000:02:08.0/0000:03:00.1</code></pre></div><p>The IOMMU group is still quite large, but when I try to run the KVM, it runs.</p><p>After putting my secondary video card back in, I&#039;m running into the same old errors. I&#039;ve tried messing with my boot line a bit, running pcie_acs_override=downstream seems to not make any changes. Perhaps I patched it in wrong? Maybe I&#039;m not installing the new kernel correctly? I&#039;m patching (via PKGBUILD), then building via makepkg, then using pacman -U &lt;local_package_name&gt; to install it. Am I missing something here? I&#039;m using the PKGBUILD and ACS patch as provided in the quote at the top of this post.</p><p>When I check dmesg for anything mentioning acs, I only get the following:</p><div class="codebox"><pre><code>dmesg | grep acs [ 0.000000] Command line: BOOT_IMAGE=../vmlinuz-linux root=UUID=30b74524-9b44-46bc-bcca-6f7ebafdbf0a rw intel_iommu=on pci-stub.ids=1002:6810,1002:aab0 pcie_acs_override=downstream initrd=../initramfs-linux.img [ 0.000000] Kernel command line: BOOT_IMAGE=../vmlinuz-linux root=UUID=30b74524-9b44-46bc-bcca-6f7ebafdbf0a rw intel_iommu=on pci-stub.ids=1002:6810,1002:aab0 pcie_acs_override=downstream initrd=../initramfs-linux.img</code></pre></div><p>Checking for ACS instead of acs gives:</p><div class="codebox"><pre><code>dmesg | grep ACS [ 0.000000] ACPI: FACS 000000007c172080 000040</code></pre></div><p>Looking for mentions of IOMMU gives:</p><div class="codebox"><pre><code>dmesg | grep IOMMU [ 0.000000] Intel-IOMMU: enabled [ 0.015176] dmar: IOMMU 0: reg_base_addr fed90000 ver 1:0 cap c0000020660462 ecap f0101a [ 0.015180] dmar: IOMMU 1: reg_base_addr fed91000 ver 1:0 cap d2008020660462 ecap f010da [ 0.015245] IOAPIC id 2 under DRHD base 0xfed91000 IOMMU 1 [ 0.498206] IOMMU 0 0xfed90000: using Queued invalidation [ 0.498207] IOMMU 1 0xfed91000: using Queued invalidation [ 0.498208] IOMMU: Setting RMRR: [ 0.498217] IOMMU: Setting identity map for device 0000:00:02.0 [0x7f800000 - 0x8f9fffff] [ 0.499450] IOMMU: Setting identity map for device 0000:00:1d.0 [0x7c00d000 - 0x7c01afff] [ 0.499470] IOMMU: Setting identity map for device 0000:00:1a.0 [0x7c00d000 - 0x7c01afff] [ 0.499488] IOMMU: Setting identity map for device 0000:00:14.0 [0x7c00d000 - 0x7c01afff] [ 0.499500] IOMMU: Prepare 0-16MiB unity mapping for LPC [ 0.499505] IOMMU: Setting identity map for device 0000:00:1f.0 [0x0 - 0xffffff] [ 1.889788] AMD IOMMUv2 driver by Joerg Roedel &lt;joerg.roedel@amd.com&gt; [ 1.889790] AMD IOMMUv2 functionality not available on this system</code></pre></div><p>I&#039;m running an Intel core, not AMD, so I don&#039;t think that the AMD IOMMUv2 messages at the end matter.</p><p>Edit</p><p>D&#039;oh, was never actually booting into the new kernel. However, still getting the same issue of IOMMU group containing the video cards being too large. The patch seems to be working however, as I have many, many more groups.</p> <p class="postedit"><em>Last edited by Eb (2014-04-11 20:04:23)</em></p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1403238">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1403248" class="blockpost rowodd"> <h2><span><span class="conr">#1536</span> <a href="viewtopic.php?pid=1403248#p1403248">2014-04-11 19:28:49</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=80830">gneville</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2014-04-02</span></dd> <dd><span>Posts: 27</span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <p>I&#039;ve just found something interesting with my setup.</p><p>I can get around the BSOD on Windows boot after installing the drivers, providing I do a fresh reload of the Host. I also had to remove the HDMI Audio from the ioh3420 device.</p><p>Edit: Confirmed this is the same for Win7 &amp; Win8 as a Guest</p><p>But provided I reboot the Host everytime I boot the Windows Guest with the below qemu commands it will start up and use the AMD drivers correctly, if I then reboot the Guest or Shutdown and restart the Qemu again from Command line then Windows will BSOD on boot with the &quot;PAGE_FAULT_IN_NONPAGED_AREA&quot; error.</p><p>Any ideas what can be causing this please?</p><p>/usr/local/qemu-xen-4-4-git-patched/bin/qemu-system-x86_64 -name win8 -enable-kvm -M q35 -m 6144&#160; \<br />-cpu Haswell,hv-time,hv_relaxed,hv_vapic,hv_spinlocks=0x1000 \<br />-boot order=dc \<br />-smp 2,sockets=1,cores=2,threads=1 \<br />-bios /home/xen/vfio/bios.bin -vga none \<br />-usb -usbdevice tablet \<br />-spice port=5902,disable-ticketing \<br />-vnc 0.0.0.0:0 \<br />-net nic \<br />-net tap,ifname=tap0,script=no,downscript=no \<br />-device ioh3420,bus=pcie.0,addr=1c.0,multifunction=on,port=1,chassis=1,id=root.1 \<br />-device vfio-pci,host=01:00.0,bus=root.1,addr=00.0,multifunction=on,x-vga=on \<br />-device vfio-pci,host=01:00.1,bus=pcie.0 \<br />-device vfio-pci,host=00:14.0,bus=pcie.0 \<br />-device ahci,bus=pcie.0,id=ahci \<br />-drive file=/dev/mapper/vg1-winv1,media=disk,index=1,id=disk,cache=none,if=virtio \<br />-drive file=/dev/mapper/vg1-winv1data,media=disk,index=2,id=diskb,cache=none,if=virtio \<br />-drive file=/home/xen/iso/windows/en-gb_windows_8_1_enterprise_x64_dvd_2971910.iso,boot=on,media=cdrom,index=3,id=isocd&#160; \<br />-device ide-cd,bus=ahci.1,drive=isocd \<br />-drive file=/root/virtio-win-0.1-74.iso,media=cdrom,index=4,id=virtio&#160; \<br />-device ide-cd,bus=ahci.2,drive=virtio</p><br /><br /><div class="quotebox"><cite>gneville wrote:</cite><blockquote><div><p>Still not having much luck with vfio vga passthrough on my AMD R9 290 <img src="https://bbs.archlinux.org/img/smilies/sad.png" width="15" height="15" alt="sad" /></p><p>I&#039;ve tried pretty much all the suggestions I&#039;ve seen on here but no matter what I try the guest always crashes after installing video drivers.</p><p>I did swap from Win8 to Win7 and noticed that after installing the video drivers and rebooting when windows boots up it crashes with a BSOD saying</p><p>&quot;PAGE_FAULT_IN_NONPAGED_AREA&quot;</p><p>I&#039;ve tried the following:<br />multiple linux kernels all with the patches rolled in.<br />multiple Qemu versions (1.7.0, 1.7.1, 2.0.0RC0,1 &amp;2) and have applied the vga reset patches<br />Tried both machine types of q35 and i440fx, of which both successfully passthrough the vga card but crash after installing the drivers and rebooting windows<br />Tried just passing through the Video card leaving out the HDMI Audio.<br />Tried installing drivers without installing the Catalyst Control Centre as suggested by some other forums.<br />Tried both AMD drivers and Windows Provided drivers via Windows Updates.<br />Tried using RomFiles </p><p>I&#039;m guessing the problem lies within Qemu somewhere.</p><br /><div class="quotebox"><cite>gneville wrote:</cite><blockquote><div><p>On top of this I have just installed the OP linux-mainline (3.13.6-1-mainline),seabios (1.7.4.r1788.g8abc6a8-1) &amp; qemu (2.0.r31714.g03d5142-1) versions (Just added reset patch and manually compiled (<a href="https://lists.gnu.org/archive/html/qemu-devel/2014-02/msg00767.html)" rel="nofollow">https://lists.gnu.org/archive/html/qemu … 0767.html)</a>)</p><p>and still no change <img src="https://bbs.archlinux.org/img/smilies/sad.png" width="15" height="15" alt="sad" /></p><br /><br /><div class="quotebox"><cite>gneville wrote:</cite><blockquote><div><p>Hi All,</p><p>I&#039;m hoping someone will be able to help me out please. I&#039;ve been trying to get vga passthrough working with qemu and vfio for a few months on and off but having no luck. I&#039;m getting similar problems to users redger &amp; DanaGoyette.</p><p>My hardware: CPU: i7 4770s, MB: Jetway NF9J-Q87 GFX: AMD R9 290</p><p>I used to use Xen 4.3 and had vga passthrough working just passing through the intel hd4600 controller to hosts, but since I got the AMD R9 290 card Xen doesn&#039;t seem to passthrough the card whatsoever, so thought I would try qemu and vfio.</p><p>I&#039;ve tried using different linux versions and qemu versions but not having much luck. I am able to successfully vfio-bind my gfx card and I can start QEMU and get video via the GFX Card HDMI cable, I&#039;m also able to successfully install Windows 8.1. However after installation I&#039;m getting problems with either windows installing the amd drivers or using the catalyst driver installer, the host just reboots.</p><p>My latest setup:</p><p>linux 3.13.7-1 + i915 patch<br />Seabios git 1.7.4-66 (31Mar14)<br />Qemu 2.0.0 RC0 + patched pcibus_reset &amp; assertion (<a href="https://lists.nongnu.org/archive/html/qemu-devel/2014-03/msg05901.html" rel="nofollow">https://lists.nongnu.org/archive/html/q … 05901.html</a> &amp; <a href="https://lists.gnu.org/archive/html/qemu-devel/2014-02/msg00767.html" rel="nofollow">https://lists.gnu.org/archive/html/qemu … 00767.html</a>)</p><p>Before the pcibus_reset patch I kept getting the following messages when the host rebooted while trying to install the drivers:</p><br /><br /><br /><br /><p>After applying the pcibust_reset patch the host no longer reboots after installing the drivers however the screen just goes blank so I have to manually kill the host. I do see the following messages:</p><br /><br /><br /><p>This is my QEMU config:</p><br /><br /><p>If I enable &quot;-vga cirrus&quot; and VNC to the host I can install the AMD drivers successfully and after a reboot it shows in device manager the AMD card but with a yellow exclamation and code 43. If I then go back to &quot;-vga none&quot; windows no longer wants to boot and I need up in a boot loop (seabios&gt;windows booting&gt;seabios&gt;windows booting).</p><p>Any ideas please?</p></div></blockquote></div></div></blockquote></div></div></blockquote></div> <p class="postedit"><em>Last edited by gneville (2014-04-11 19:55:10)</em></p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1403248">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1403332" class="blockpost roweven"> <h2><span><span class="conr">#1537</span> <a href="viewtopic.php?pid=1403332#p1403332">2014-04-11 23:43:57</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=80920">Nex7</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2014-04-06</span></dd> <dd><span>Posts: 5</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=80920">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <p>So I&#039;ve discovered what I believe to be my problem, but I&#039;m confused why nobody else seems to be hitting it.</p><p><a href="https://lists.gnu.org/archive/html/qemu-devel/2014-04/msg01858.html" rel="nofollow">https://lists.gnu.org/archive/html/qemu … 01858.html</a></p><p>That&#039;s what&#039;s hitting me - I&#039;m getting c0000221 stop&#039;s on boot on my VM, at this point, and seemingly this is due to virtio-scsi. I wonder why nobody else is hitting this?</p><p>EDIT: Of course, starting over with a fresh Win7 x64 install using ide instead of virtio, it works fine up until I try to install Windows updates, even only a few of them, at which point after reboot it dies with a different BSOD, code c000021a. -sigh-</p> <p class="postedit"><em>Last edited by Nex7 (2014-04-12 02:55:53)</em></p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1403332">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1403380" class="blockpost rowodd"> <h2><span><span class="conr">#1538</span> <a href="viewtopic.php?pid=1403380#p1403380">2014-04-12 03:29:55</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=80279">novist</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2014-03-14</span></dd> <dd><span>Posts: 34</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=80279">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>Nex7 wrote:</cite><blockquote><div><p>So I&#039;ve discovered what I believe to be my problem, but I&#039;m confused why nobody else seems to be hitting it.</p><p><a href="https://lists.gnu.org/archive/html/qemu-devel/2014-04/msg01858.html" rel="nofollow">https://lists.gnu.org/archive/html/qemu … 01858.html</a></p><p>That&#039;s what&#039;s hitting me - I&#039;m getting c0000221 stop&#039;s on boot on my VM, at this point, and seemingly this is due to virtio-scsi. I wonder why nobody else is hitting this?</p><p>EDIT: Of course, starting over with a fresh Win7 x64 install using ide instead of virtio, it works fine up until I try to install Windows updates, even only a few of them, at which point after reboot it dies with a different BSOD, code c000021a. -sigh-</p></div></blockquote></div><p>you are not alone here. i made attempt to use virtio-scsi too. however i had OS installed on IDE drive and later on switched to virtio-scsi. what i experienced was various files being seemingly corrupted (software throwing errors due to crc32 missmatch, applications failing to read files etc). switching back to virtio made it all work fine again. seems like virtio-scsi does cause some reading problems and what not. so just stick to virtio i guess. its really fast anyway.</p> <p class="postedit"><em>Last edited by novist (2014-04-12 03:30:48)</em></p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1403380">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1403390" class="blockpost roweven"> <h2><span><span class="conr">#1539</span> <a href="viewtopic.php?pid=1403390#p1403390">2014-04-12 04:36:29</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=80990">Eb</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2014-04-08</span></dd> <dd><span>Posts: 11</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=80990">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <p>Success! ..kind of. I&#039;ve compiled with the old patch and everything seems to be working proper. After installing Windows 8.1 I decided to install the drivers for the video card. Windows seems to be running smoothly, but now I have no video output. Looking into exactly what may be happening here now..</p><p>Edit:</p><p>After trying both beta and non beta drivers, I&#039;m consistantly getting a black screen as soon as I finish installing the drivers and the VM switches from basic output to using the card. Wiping the VM fixed this until installing the drivers once more.&#160; Any ideas how I can get video back?</p> <p class="postedit"><em>Last edited by Eb (2014-04-12 07:16:00)</em></p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1403390">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1403518" class="blockpost rowodd"> <h2><span><span class="conr">#1540</span> <a href="viewtopic.php?pid=1403518#p1403518">2014-04-12 14:31:25</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=81112">Krobar</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2014-04-12</span></dd> <dd><span>Posts: 17</span></dd> <dd class="usercontacts"><span class="email"><a href="mailto:rob@ledeng.demon.co.uk">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <p>Adding -curses to the qemu-system options fixed this for me.</p><div class="quotebox"><cite>rabcor wrote:</cite><blockquote><div><div class="quotebox"><cite>nbhs wrote:</cite><blockquote><div><p>Try:</p><div class="codebox"><pre><code>-cpu qemu64</code></pre></div><p>and remove the -smp line</p><p>If that worked you might have built qemu without kvm support</p></div></blockquote></div><div class="codebox"><pre><code>#qemu-system-x86_64 -enable-kvm -M q35 -cpu qemu64 \ -bios /usr/share/qemu/bios.bin -vga none \ -device ioh3420,bus=pcie.0,addr=1c.0,multifunction=on,port=1,chassis=1,id=root.1 \ -device vfio-pci,host=01:00.0,bus=root.1,addr=00.0,multifunction=on,x-vga=on \ -device vfio-pci,host=01:00.1,bus=root.1,addr=00.1 qemu-system-x86_64: -cpu qemu64: could not open disk image -bios: No such file or directory</code></pre></div><p>I&#039;m looking into reinstalling qemu but like i said, you removed the link from your original post and i don&#039;t have any different source to build from than my current one except the git one, which is v 1.6 and has seabios intergrated, and i don&#039;t know how to patch the intergrated seabios, i couldn&#039;t find out how (but otherwise that is what i would do).</p><p>i tried removing the backslashes and the VM will start if i run it from X.</p><div class="codebox"><pre><code>qemu-system-x86_64 -enable-kvm -M q35 -cpu host -smp 6,sockets=1,cores=6,threads=1 -bios /usr/share/qemu/bios.bin -vga none -device ioh3420,bus=pcie.0,addr=1c.0,multifunction=on,port=1,chassis=1,id=root.1 -device vfio-pci,host=01:00.0,bus=root.1,addr=00.0,multifunction=on,x-vga=on -device vfio-pci,host=01:00.1,bus=root.1,addr=00.1 qemu-system-x86_64: -device vfio-pci,host=01:00.0,bus=root.1,addr=00.0,multifunction=on,x-vga=on: Warning, device 0000:01:00.0 does not support reset qemu-system-x86_64: -device vfio-pci,host=01:00.1,bus=root.1,addr=00.1: Warning, device 0000:01:00.1 does not support reset qemu-system-x86_64: Attempt to reset PCI bus for VGA support failed (Inappropriate ioctl for device). VGA may not work.</code></pre></div><p>if not running from x (terminal) then i get</p><div class="codebox"><pre><code>Could not initialize SDL(No available video device) - exiting</code></pre></div><p>instead of</p><div class="codebox"><pre><code>qemu-system-x86_64: Attempt to reset PCI bus for VGA support failed (Inappropriate ioctl for device). VGA may not work.</code></pre></div></div></blockquote></div> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1403518">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1403729" class="blockpost roweven"> <h2><span><span class="conr">#1541</span> <a href="viewtopic.php?pid=1403729#p1403729">2014-04-13 02:53:58</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=80920">Nex7</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2014-04-06</span></dd> <dd><span>Posts: 5</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=80920">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>novist wrote:</cite><blockquote><div><p>you are not alone here. i made attempt to use virtio-scsi too. however i had OS installed on IDE drive and later on switched to virtio-scsi. what i experienced was various files being seemingly corrupted (software throwing errors due to crc32 missmatch, applications failing to read files etc). switching back to virtio made it all work fine again. seems like virtio-scsi does cause some reading problems and what not. so just stick to virtio i guess. its really fast anyway.</p></div></blockquote></div><p>Maybe I&#039;m confused - can you show me your commandline, that is using &#039;virtio&#039; but not &#039;virtio-scsi&#039;?</p><p>In other news, I did get this working on IDE, but have not yet retried virtio-scsi. The symptom was every time I installed the Windows 7 64-bit OS it was fine UNTIL I did ANY Windows Updates. I tried a few times, with different packages, always the same. This got me thinking it isn&#039;t the updates themselves, but something they have in common - going down that list, I hit upon &#039;Restore Points&#039;, as those happen any time you do any Windows Updates. So I turned off Restore Points on the OS disk entirely, and after that, did Windows Update, and it came back up after reboot w/o BSOD. It is now completely stable. I have no idea why Restore Points screw the pooch, but they seem to, at least on IDE (haven&#039;t retried with virtio).</p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1403729">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1403748" class="blockpost rowodd"> <h2><span><span class="conr">#1542</span> <a href="viewtopic.php?pid=1403748#p1403748">2014-04-13 04:29:12</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=80990">Eb</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2014-04-08</span></dd> <dd><span>Posts: 11</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=80990">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>Eb wrote:</cite><blockquote><div><p>Success! ..kind of. I&#039;ve compiled with the old patch and everything seems to be working proper. After installing Windows 8.1 I decided to install the drivers for the video card. Windows seems to be running smoothly, but now I have no video output. Looking into exactly what may be happening here now..</p><p>Edit:</p><p>After trying both beta and non beta drivers, I&#039;m consistantly getting a black screen as soon as I finish installing the drivers and the VM switches from basic output to using the card. Wiping the VM fixed this until installing the drivers once more.&#160; Any ideas how I can get video back?</p></div></blockquote></div><p>I&#039;ve booted directly into the Windows system (8.1) and the card works perfectly.&#160; Back to KVM and it doesn&#039;t work. I&#039;ve even tried to install manufacturer drivers, no dice there either. I&#039;m not sure completely if this is an issue with drivers or my hardware, but since it&#039;s only having trouble with QEMU I&#039;m hoping that there&#039;s some options I can change when booting the KVM. Are there any QEMU boot options I can experiment with? Should just return the card and try my luck with a different model?</p><p>Eagerly waiting for a reply, I don&#039;t have much of a window left to return the card.</p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1403748">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1403763" class="blockpost roweven"> <h2><span><span class="conr">#1543</span> <a href="viewtopic.php?pid=1403763#p1403763">2014-04-13 06:26:25</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=70922">nbhs</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd class="postavatar"><img src="https://bbs.archlinux.org/img/avatars/70922.jpg?m=1367773811" width="80" height="80" alt="" /></dd> <dd><span>From: Montevideo, Uruguay</span></dd> <dd><span>Registered: 2013-05-02</span></dd> <dd><span>Posts: 402</span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>Eb wrote:</cite><blockquote><div><div class="quotebox"><cite>Eb wrote:</cite><blockquote><div><p>Success! ..kind of. I&#039;ve compiled with the old patch and everything seems to be working proper. After installing Windows 8.1 I decided to install the drivers for the video card. Windows seems to be running smoothly, but now I have no video output. Looking into exactly what may be happening here now..</p><p>Edit:</p><p>After trying both beta and non beta drivers, I&#039;m consistantly getting a black screen as soon as I finish installing the drivers and the VM switches from basic output to using the card. Wiping the VM fixed this until installing the drivers once more.&#160; Any ideas how I can get video back?</p></div></blockquote></div><p>I&#039;ve booted directly into the Windows system (8.1) and the card works perfectly.&#160; Back to KVM and it doesn&#039;t work. I&#039;ve even tried to install manufacturer drivers, no dice there either. I&#039;m not sure completely if this is an issue with drivers or my hardware, but since it&#039;s only having trouble with QEMU I&#039;m hoping that there&#039;s some options I can change when booting the KVM. Are there any QEMU boot options I can experiment with? Should just return the card and try my luck with a different model?</p><p>Eagerly waiting for a reply, I don&#039;t have much of a window left to return the card.</p></div></blockquote></div><p>Have you tried swapping card to check if you get the same result? Have you tried to passthrough only the gpu without the audio device?</p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1403763">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1403780" class="blockpost rowodd"> <h2><span><span class="conr">#1544</span> <a href="viewtopic.php?pid=1403780#p1403780">2014-04-13 08:48:48</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=80701">apex8</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2014-03-29</span></dd> <dd><span>Posts: 47</span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <p>Hi, <br />I have a question regarding disk performance. Originally I was using a file on a XFS partition as hard disk image:</p><div class="codebox"><pre><code>-drive if=none,file=/home/vms/drives/winimg.img,id=vdisk1,cache=none,format=raw,aio=native \ -device virtio-blk,scsi=off,config-wce=off,drive=vdisk1,id=disk1 \</code></pre></div><p>The physical hard disk is not an SSD</p><p>With this I can&#039;t use the virtio option <em>x-data-plane=on</em>.<br />However in the Windows Performance Indicator the Harddisk had a score of 6.5</p><p>Then I switched to using an physical hard disk partition with the following configuration:</p><div class="codebox"><pre><code>-drive if=none,file=/dev/sdb7,id=vdisk1,cache=none,format=raw,aio=native \ -device virtio-blk,scsi=off,config-wce=off,drive=vdisk1,id=disk1,x-data-plane=on \</code></pre></div><p>I thought performance would increase a bit, but the performance indicator dropped to 5.9.</p><p>I there some configuarion on the host, I missed?</p><p>BR</p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1403780">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1403983" class="blockpost roweven"> <h2><span><span class="conr">#1545</span> <a href="viewtopic.php?pid=1403983#p1403983">2014-04-13 19:48:22</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=72341">spam</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2013-06-15</span></dd> <dd><span>Posts: 3</span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <p>Hello,</p><p>I have been trying vga-passthroug but I have managed to get it properly yet.</p><p>My hardware config is:<br />ASRock Z87 Extreme 4<br />i7 4771<br />GTX 660 (ASUS DC2O)</p><p>I have used the OP packages and with and without this patch&#160; <a href="http://lists.nongnu.org/archive/html/qemu-devel/2013-10/msg00597.html" rel="nofollow">http://lists.nongnu.org/archive/html/qe … 00597.html</a>&#160; </p><p>I have not read all thread yet and it is a bit confusing with patches here and there. I can only get a code 43 in windows. I believe I have to enable acs&#160; but atm do I need a patch or only a kernel parameter for linux-mainline ?</p><p>I boot in my MB in UEFI mode (at least I believe so), does it matter ?</p><div class="codebox"><pre class="vscroll"><code>./lsgroup added ### Group 0 ### 00:00.0 Host bridge: Intel Corporation 4th Gen Core Processor DRAM Controller (rev 06) ### Group 1 ### 00:01.0 PCI bridge: Intel Corporation Xeon E3-1200 v3/4th Gen Core Processor PCI Express x16 Controller (rev 06) 01:00.0 VGA compatible controller: NVIDIA Corporation GK106 [GeForce GTX 660] (rev a1) 01:00.1 Audio device: NVIDIA Corporation GK106 HDMI Audio Controller (rev a1) ### Group 2 ### 00:02.0 VGA compatible controller: Intel Corporation Xeon E3-1200 v3/4th Gen Core Processor Integrated Graphics Controller (rev 06) ### Group 3 ### 00:03.0 Audio device: Intel Corporation Xeon E3-1200 v3/4th Gen Core Processor HD Audio Controller (rev 06) ### Group 4 ### 00:14.0 USB controller: Intel Corporation 8 Series/C220 Series Chipset Family USB xHCI (rev 05) ### Group 5 ### 00:16.0 Communication controller: Intel Corporation 8 Series/C220 Series Chipset Family MEI Controller #1 (rev 04) ### Group 6 ### 00:19.0 Ethernet controller: Intel Corporation Ethernet Connection I217-V (rev 05) ### Group 7 ### 00:1a.0 USB controller: Intel Corporation 8 Series/C220 Series Chipset Family USB EHCI #2 (rev 05) ### Group 8 ### 00:1b.0 Audio device: Intel Corporation 8 Series/C220 Series Chipset High Definition Audio Controller (rev 05) ### Group 9 ### 00:1c.0 PCI bridge: Intel Corporation 8 Series/C220 Series Chipset Family PCI Express Root Port #1 (rev d5) 00:1c.2 PCI bridge: Intel Corporation 8 Series/C220 Series Chipset Family PCI Express Root Port #3 (rev d5) 00:1c.5 PCI bridge: Intel Corporation 8 Series/C220 Series Chipset Family PCI Express Root Port #6 (rev d5) 03:00.0 SATA controller: ASMedia Technology Inc. ASM1062 Serial ATA Controller (rev 01) 04:00.0 Network controller: Qualcomm Atheros AR9287 Wireless Network Adapter (PCI-Express) (rev 01) ### Group 10 ### 00:1d.0 USB controller: Intel Corporation 8 Series/C220 Series Chipset Family USB EHCI #1 (rev 05) ### Group 11 ### 00:1f.0 ISA bridge: Intel Corporation Z87 Express LPC Controller (rev 05) 00:1f.2 SATA controller: Intel Corporation 8 Series/C220 Series Chipset Family 6-port SATA Controller 1 [AHCI mode] (rev 05) 00:1f.3 SMBus: Intel Corporation 8 Series/C220 Series Chipset Family SMBus Controller (rev 05)</code></pre></div><p>I add a bit of information on my software configuration:</p><div class="codebox"><pre><code>$ cat /proc/cmdline BOOT_IMAGE=/vmlinuz-linux-mainline root=UUID=bc42943b-cfbd-47df-931f-40a88e0a4ef9 rw quiet intel_iommu=on pci-stub.ids=10de:11c0,10de:0e0b</code></pre></div><div class="codebox"><pre><code>$ cat /etc/modprobe.d/alsa-base.conf /etc/modprobe.d/blacklist-ath_pci.conf /etc/modprobe.d/blacklist.conf /etc/modprobe.d/blacklist-firewire.conf /etc/modprobe.d/blacklist-framebuffer.conf /etc/modprobe.d/blacklist-gpu.conf /etc/modprobe.d/blacklist-modem.conf /etc/modprobe.d/blacklist-oss.conf /etc/modprobe.d/blacklist-rare-network.conf /etc/modprobe.d/blacklist-watchdog.conf /etc/modprobe.d/dkms.conf /etc/modprobe.d/fbdev-blacklist.conf /etc/modprobe.d/iwlwifi.conf /etc/modprobe.d/mlx4.conf /etc/modprobe.d/modprobe.conf /etc/modprobe.d/pci-stub.conf /etc/modprobe.d/qemu-system-x86.conf /etc/modprobe.d/vfio_iommu_type1.conf /etc/modprobe.d/vmwgfx-fbdev.conf blacklist nouveau blacklist nvidia options kvm ignore_msrs=1 options pci-stub ids=10de:11c0,10de:0e0b options vfio_iommu_type1 allow_unsafe_interrupts=1</code></pre></div><div class="codebox"><pre><code>$ cat /etc/modules-load.d/cups-filters.conf pci-stub</code></pre></div><p>And to finish the qemu command I have been trying:</p><div class="codebox"><pre><code>qemu-system-x86_64 -enable-kvm -M q35 -m 4096 -cpu host -smp 4,sockets=1,cores=4,threads=1 -bios /usr/share/qemu/bios.bin -vga none \ -device ioh3420,bus=pcie.0,addr=1c.0,multifunction=on,port=1,chassis=1,id=root.1 \ -device vfio-pci,host=01:00.0,bus=root.1,addr=00.0,multifunction=on,x-vga=on \ -device vfio-pci,host=01:00.1,bus=root.1,addr=00.1 \ -drive file=/home/spam/windows.img,id=disk,format=raw \ -device ide-hd,bus=ide.0,drive=disk \ -drive file=/home/spam/windows.iso,id=isocd \ -device ide-cd,bus=ide.1,drive=isocd \ -usb -usbdevice host:003.006</code></pre></div><p>And to finish, the last dmesg</p><div class="codebox"><pre><code>[ 5663.995723] VFIO - User Level meta-driver version: 0.3 [ 6337.160714] vfio-pci 0000:01:00.0: enabling device (0000 -&gt; 0003) [ 6337.160846] vfio_ecap_init: 0000:01:00.0 hiding ecap 0x19@0x900 [ 6376.195200] kvm: zapping shadow pages for mmio generation wraparound</code></pre></div> <p class="postedit"><em>Last edited by spam (2014-04-13 19:51:17)</em></p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1403983">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1404110" class="blockpost rowodd"> <h2><span><span class="conr">#1546</span> <a href="viewtopic.php?pid=1404110#p1404110">2014-04-14 04:45:57</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=80773">Torello</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2014-04-01</span></dd> <dd><span>Posts: 6</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=80773">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <p>Hello,<br />Finally, vga-passthrough work. ( Using kernel with debug registers patch, qemu and seabios from first post ).<br />But I have a strange issue, which makes keyboard and mouse in guest os - unusable.</p><p>My specs: <br />Core i7 4771, GA-Z87X-OC , Radeon 6950@6970 for guest and integrated intel video for host.<br />Keyboard Microsoft Natural 4000 ( usb ), mouse Logitech Mx510 ( usb ).</p><p>My startup script is:<br />qemu-system-x86_64 -enable-kvm -M q35 -m 16384 -cpu host \<br />-smp 4,sockets=1,cores=4,threads=1 \<br />-vga none \<br />-device ioh3420,bus=pcie.0,addr=1c.0,multifunction=on,port=1,chassis=1,id=root.1 \<br />-device vfio-pci,host=01:00.0,bus=root.1,addr=00.0,multifunction=on,x-vga=on \<br />-device vfio-pci,host=01:00.1,bus=root.1,addr=00.1 \<br />-drive file=/home/torello/virt_images/windows7.img,id=disk,format=raw -device ide-hd,bus=ide.0,drive=disk \<br />-drive file=/home/torello/distr/win7_msdn.iso,id=isocd -device ide-cd,bus=ide.1,drive=isocd \<br />-boot menu=on</p><p>If I boot vm without &quot;-vga none&quot;.<br />I can switch to qemu window, and it grabs my keyboard and mouse input.</p><p>If I boot with &quot;-vga none&quot;, I can&#039;t use keyboard in guest at all, and with my mouse I can do some operations like scrolling the window using the thumb, or change window place ( using mouse ), but If I want to click a button I must click 20-30 times, trying different corners, before I was able to press any onscreen button.</p><p>Do you have any suggestions, how I can debug/solve that issue?</p> <p class="postedit"><em>Last edited by Torello (2014-04-14 05:23:42)</em></p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1404110">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1404146" class="blockpost roweven"> <h2><span><span class="conr">#1547</span> <a href="viewtopic.php?pid=1404146#p1404146">2014-04-14 08:16:41</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=80279">novist</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2014-03-14</span></dd> <dd><span>Posts: 34</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=80279">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <p>@Torello: pass-through usb ports too.</p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1404146">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1404175" class="blockpost rowodd"> <h2><span><span class="conr">#1548</span> <a href="viewtopic.php?pid=1404175#p1404175">2014-04-14 10:54:09</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=17456">FruitieX</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2008-07-03</span></dd> <dd><span>Posts: 18</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=17456">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <p>Hi,</p><p>After updating to 3.14 kernel with all patches as posted in the OP, I&#039;m getting a *massive* amount of spam in dmesg while my VM is running. (so much that the systemd journal can&#039;t keep up and uses 100% CPU)<br />As a result I get terrible performance in the VM, whereas with the 3.13 kernel I get very good performance and can play Windows games at near native speeds.<br />Here&#039;s the dmesg output that gets repeated:</p><div class="codebox"><pre class="vscroll"><code>[ 99.118043] WARNING: CPU: 2 PID: 1519 at arch/x86/kvm/x86.c:1114 kvm_get_msr_common+0x793/0x960 [kvm]() [ 99.118047] Modules linked in: vfio_pci vfio_iommu_type1 vfio ipt_MASQUERADE iptable_nat nf_nat_ipv4 nf_nat nf_conntrack_ipv4 nf_defrag_ipv4 xt_conntrack nf_conntrack ipt_REJECT xt_ CHECKSUM iptable_mangle xt_tcpudp bridge stp llc ip6table_filter ip6_tables iptable_filter ip_tables x_tables nls_iso8859_1 nls_cp437 vfat fat ext4 mbcache jbd2 snd_hda_codec_hdmi iTCO _wdt iTCO_vendor_support ppdev hid_logitech_dj coretemp hwmon x86_pkg_temp_thermal intel_powerclamp kvm_intel kvm crct10dif_pclmul crc32_pclmul ghash_clmulni_intel aesni_intel aes_x86_ 64 lrw gf128mul glue_helper ablk_helper cryptd btusb microcode bluetooth pcspkr 6lowpan_iphc psmouse serio_raw i2c_i801 e1000e ptp pps_core lpc_ich rfkill crc16 mei_me mei snd_usb_audi o parport_pc tpm_tis snd_usbmidi_lib mousedev evdev joydev snd_rawmidi snd_hda_codec_realtek [ 99.118064] snd_seq_device tpm mac_hid snd_hda_codec_generic i915 nuvoton_cir parport battery rc_core snd_hda_intel snd_hda_codec drm_kms_helper snd_hwdep video drm snd_pcm button intel_gtt i2c_algo_bit snd_timer i2c_core snd soundcore shpchp processor btrfs xor raid6_pq hid_generic usbhid hid bcache sd_mod crc_t10dif crct10dif_common atkbd libps2 crc32c_intel a hci libahci libata scsi_mod ehci_pci xhci_hcd ehci_hcd usbcore usb_common i8042 serio pci_stub [ 99.118078] CPU: 2 PID: 1519 Comm: qemu-system-x86 Tainted: G W 3.14.0-ARCH #1 [ 99.118079] Hardware name: To Be Filled By O.E.M. To Be Filled By O.E.M./Z87M Pro4, BIOS P2.00 11/07/2013 [ 99.118080] 0000000000000009 ffff8800b9505c08 ffffffff814cea8a 0000000000000000 [ 99.118081] ffff8800b9505c40 ffffffff81064b1d 0000000040000020 ffff8800b9505cd0 [ 99.118083] ffff8804132e3ec0 ffff8803fbaf0000 ffff8803fbaf0040 ffff8800b9505c50 [ 99.118084] Call Trace: [ 99.118085] [&lt;ffffffff814cea8a&gt;] dump_stack+0x4d/0x6f [ 99.118086] [&lt;ffffffff81064b1d&gt;] warn_slowpath_common+0x7d/0xa0 [ 99.118087] [&lt;ffffffff81064bfa&gt;] warn_slowpath_null+0x1a/0x20 [ 99.118091] [&lt;ffffffffa0952233&gt;] kvm_get_msr_common+0x793/0x960 [kvm] [ 99.118093] [&lt;ffffffffa0ad1310&gt;] ? vmx_get_msr+0x370/0x370 [kvm_intel] [ 99.118095] [&lt;ffffffffa0ad10a2&gt;] vmx_get_msr+0x102/0x370 [kvm_intel] [ 99.118097] [&lt;ffffffffa0ad133a&gt;] handle_rdmsr+0x2a/0x140 [kvm_intel] [ 99.118099] [&lt;ffffffffa0ad1b8f&gt;] ? handle_exception+0x16f/0x3e0 [kvm_intel] [ 99.118101] [&lt;ffffffffa0ad6975&gt;] vmx_handle_exit+0xb5/0xa20 [kvm_intel] [ 99.118103] [&lt;ffffffffa0ace360&gt;] ? vmx_invpcid_supported+0x20/0x20 [kvm_intel] [ 99.118107] [&lt;ffffffffa09577a0&gt;] kvm_arch_vcpu_ioctl_run+0xc70/0x11c0 [kvm] [ 99.118110] [&lt;ffffffffa095363e&gt;] ? kvm_arch_vcpu_load+0x4e/0x1e0 [kvm] [ 99.118113] [&lt;ffffffffa09405c2&gt;] kvm_vcpu_ioctl+0x2b2/0x5b0 [kvm] [ 99.118115] [&lt;ffffffff814d11fd&gt;] ? __schedule+0x86d/0x900 [ 99.118116] [&lt;ffffffff8101e966&gt;] ? ___preempt_schedule+0x56/0xb0 [ 99.118118] [&lt;ffffffff811b3de0&gt;] do_vfs_ioctl+0x2e0/0x4c0 [ 99.118119] [&lt;ffffffff811bdace&gt;] ? __fget+0x6e/0xb0 [ 99.118121] [&lt;ffffffff811b4041&gt;] SyS_ioctl+0x81/0xa0 [ 99.118122] [&lt;ffffffff814dc469&gt;] system_call_fastpath+0x16/0x1b [ 99.118126] ---[ end trace 8d24f63038d6e9d0 ]---</code></pre></div><p>I&#039;m noticing that if I remove the hv-time flag from my qemu launch options I don&#039;t get this dmesg spam anymore, but VM performance is still really bad up to a point where even moving the mouse cursor is laggy.<br />Is anyone else experiencing this issue, and any ideas how to fix this? Again, the 3.13 kernel was fine.</p><p>System specs:<br />CPU: Intel i5-4670<br />GPU: AMD Radeon 280X<br />Mobo: ASRock Z87M Pro4</p><p>FruitieX</p> <p class="postedit"><em>Last edited by FruitieX (2014-04-14 10:55:31)</em></p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1404175">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1404188" class="blockpost roweven"> <h2><span><span class="conr">#1549</span> <a href="viewtopic.php?pid=1404188#p1404188">2014-04-14 11:46:28</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=78355">anickname</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2014-01-07</span></dd> <dd><span>Posts: 23</span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>FruitieX wrote:</cite><blockquote><div><p>Hi,</p><p>After updating to 3.14 kernel with all patches as posted in the OP, I&#039;m getting a *massive* amount of spam in dmesg while my VM is running. (so much that the systemd journal can&#039;t keep up and uses 100% CPU)<br />As a result I get terrible performance in the VM, whereas with the 3.13 kernel I get very good performance and can play Windows games at near native speeds.<br />Here&#039;s the dmesg output that gets repeated:</p><br /><p>I&#039;m noticing that if I remove the hv-time flag from my qemu launch options I don&#039;t get this dmesg spam anymore, but VM performance is still really bad up to a point where even moving the mouse cursor is laggy.<br />Is anyone else experiencing this issue, and any ideas how to fix this? Again, the 3.13 kernel was fine.</p><p>System specs:<br />CPU: Intel i5-4670<br />GPU: AMD Radeon 280X<br />Mobo: ASRock Z87M Pro4</p><p>FruitieX</p></div></blockquote></div><p><a href="https://bugzilla.kernel.org/show_bug.cgi?id=73721" rel="nofollow">https://bugzilla.kernel.org/show_bug.cgi?id=73721</a><br />Still waiting for an answer.</p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1404188">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div id="p1404211" class="blockpost rowodd"> <h2><span><span class="conr">#1550</span> <a href="viewtopic.php?pid=1404211#p1404211">2014-04-14 12:57:43</a></span></h2> <div class="box"> <div class="inbox"> <div class="postbody"> <div class="postleft"> <dl> <dt><strong><a href="profile.php?id=76834">Val532</a></strong></dt> <dd class="usertitle"><strong>Member</strong></dd> <dd><span>Registered: 2013-11-13</span></dd> <dd><span>Posts: 35</span></dd> <dd class="usercontacts"><span class="email"><a href="misc.php?email=76834">Email</a></span></dd> </dl> </div> <div class="postright"> <h3>Re: KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</h3> <div class="postmsg"> <div class="quotebox"><cite>anickname wrote:</cite><blockquote><div><div class="quotebox"><cite>FruitieX wrote:</cite><blockquote><div><p>Hi,</p><p>After updating to 3.14 kernel with all patches as posted in the OP, I&#039;m getting a *massive* amount of spam in dmesg while my VM is running. (so much that the systemd journal can&#039;t keep up and uses 100% CPU)<br />As a result I get terrible performance in the VM, whereas with the 3.13 kernel I get very good performance and can play Windows games at near native speeds.<br />Here&#039;s the dmesg output that gets repeated:</p><br /><p>I&#039;m noticing that if I remove the hv-time flag from my qemu launch options I don&#039;t get this dmesg spam anymore, but VM performance is still really bad up to a point where even moving the mouse cursor is laggy.<br />Is anyone else experiencing this issue, and any ideas how to fix this? Again, the 3.13 kernel was fine.</p><p>System specs:<br />CPU: Intel i5-4670<br />GPU: AMD Radeon 280X<br />Mobo: ASRock Z87M Pro4</p><p>FruitieX</p></div></blockquote></div><p><a href="https://bugzilla.kernel.org/show_bug.cgi?id=73721" rel="nofollow">https://bugzilla.kernel.org/show_bug.cgi?id=73721</a><br />Still waiting for an answer.</p></div></blockquote></div><p>Hi,</p><p>I do not understand your problem because i do not have it !!</p><p>i use </p><div class="codebox"><pre><code>qemu-system-x86_64 \ -M q35 -m 8G -enable-kvm -cpu host,hv-time,hv_relaxed,hv_vapic,hv_spinlocks=0x1000 \ -no-user-config -nodefaults -vga none -boot d -nographic \ -smp 4,sockets=1,cores=4,threads=1 \ ...</code></pre></div><p>And i have not any problem.</p><p>Qemu 2.0.0-RC2 + original kernel 3.14 from kernel.org + i915, acs (and other litle patch on KVM side but without it, it works the same).</p><p>On a Intel Core i5-4670S + Asrock Z87 Extrem 6 and two HD 6870.</p> </div> </div> </div> </div> <div class="inbox"> <div class="postfoot clearb"> <div class="postfootleft"><p><span>Offline</span></p></div> <div class="postfootright"> <ul> <li class="postreport"><span><a href="misc.php?report=1404211">Report</a></span></li> </ul> </div> </div> </div> </div> </div> <div class="postlinksb"> <div class="inbox crumbsplus"> <div class="pagepost"> <p class="pagelink conl"><span class="pages-label">Pages: </span><a rel="prev" class="item1" href="viewtopic.php?id=162768&amp;p=61">Previous</a> <a href="viewtopic.php?id=162768">1</a> <span class="spacer">…</span> <a href="viewtopic.php?id=162768&amp;p=60">60</a> <a href="viewtopic.php?id=162768&amp;p=61">61</a> <strong>62</strong> <a href="viewtopic.php?id=162768&amp;p=63">63</a> <a href="viewtopic.php?id=162768&amp;p=64">64</a> <span class="spacer">…</span> <a href="viewtopic.php?id=162768&amp;p=234">234</a> <a rel="next" href="viewtopic.php?id=162768&amp;p=63">Next</a></p> <p class="postlink conr">Topic closed</p> </div> <ul class="crumbs"> <li><a href="index.php">Index</a></li> <li><span>»&#160;</span><a href="viewforum.php?id=48">Topics Going Nowhere</a></li> <li><span>»&#160;</span><strong><a href="viewtopic.php?id=162768">KVM VGA-Passthrough using the new vfio-vga support in kernel =&gt;3.9</a></strong></li> </ul> <p class="subscribelink clearb"><a href="misc.php?action=subscribe&amp;tid=162768">Subscribe to this topic</a></p> <div class="clearer"></div> </div> </div> </div> <div id="brdfooter" class="block"> <h2><span>Board footer</span></h2> <div class="box"> <div id="brdfooternav" class="inbox"> <div class="conl"> <form id="qjump" method="get" action="viewforum.php"> <div><label><span>Jump to<br /></span> <select name="id" onchange="window.location=('viewforum.php?id='+this.options[this.selectedIndex].value)"> <optgroup label="Technical Issues and Assistance"> <option value="23">Newbie Corner</option> <option value="17">Installation</option> <option value="22">Kernel &amp; Hardware</option> <option value="18">Applications &amp; Desktop Environments</option> <option value="31">Laptop Issues</option> <option value="8">Networking, Server, and Protection</option> <option value="32">Multimedia and Games</option> <option value="50">System Administration</option> <option value="35">Other Architectures</option> </optgroup> <optgroup label="Arch-centric"> <option value="24">Announcements, Package &amp; Security Advisories</option> <option value="1">Arch Discussion</option> <option value="13">Forum &amp; Wiki discussion</option> </optgroup> <optgroup label="Pacman Upgrades, Packaging &amp; AUR"> <option value="44">Pacman &amp; Package Upgrade Issues</option> <option value="49">[testing] Repo Forum</option> <option value="4">Creating &amp; Modifying Packages</option> <option value="38">AUR Issues, Discussion &amp; PKGBUILD Requests</option> </optgroup> <optgroup label="Contributions &amp; Discussion"> <option value="20">GNU/Linux Discussion</option> <option value="27">Community Contributions</option> <option value="33">Programming &amp; Scripting</option> <option value="30">Other Languages</option> <option value="47">Artwork and Screenshots</option> <option value="42">Try This</option> </optgroup> <optgroup label="/dev/null"> <option value="29">Off-Topic</option> <option value="48" selected="selected">Topics Going Nowhere</option> <option value="36">Dustbin</option> </optgroup> </select></label> <input type="submit" value=" Go " accesskey="g" /> </div> </form> </div> <div class="conr"> <p id="feedlinks"><span class="atom"><a href="extern.php?action=feed&amp;tid=162768&amp;type=atom">Atom topic feed</a></span></p> <p id="poweredby">Powered by <a href="http://fluxbb.org/">FluxBB</a></p> </div> <div class="clearer"></div> </div> </div> </div> </div> <div class="end-box"></div> </div> </body> </html>
